   SUBROUTINE EST.RECAP.RPT (CONO, CO.NAME, EST.KEY, PAGE.NO,PRT.QTY,HD1,HD2)
*********************************************************************
*
* REVISION - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
*
* PROGRAM  - EST.RECAP.RPT
*
* AUTHOR   - NICK AMENDOLA, COMPUTER BUSINESS ASSOCIATES
*
* DATE     - 09/30/92
*
* DESCRIPTION
*
* This subroutine prints the estimate summary by type (labor,
* material etc)
*
* MOD TASK 18148 DMT 7/5/94 PRINT SELECTED QUANTITIES
* MOD TASK 17918 DMT 8/16/94 ADD BACKMARGIN CALCULATION
*T26138 cm 11/02/2001 * Expand qty field from 8 to 9 digits.
*T26090 cmykleb 04/04/2002 * Change rpt to use rpt heading from call pgm.
*T27716 cmykleb 10/22/2003 * Add Pre-Press inclusive functionality to
*                            report.
*********************************************************************
*
*---- COPY STATEMENTS
*
*COPY>JES.CPYLIB>SCOMMON.ESTIMATE
*COPY>JES.CPYLIB>ESTIMATE
*COPY>JES.CPYLIB>EST.COST.TYPE.SUM
*COPY>JES.CPYLIB>JES.FILE.VARS
*COPY>PMC.CPYLIB>CUSTOMER
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>CHAR
*
*---- DEFINE DIMENSIONED VARIABLES
*
   DIM PHEAD(10)
   MAT PHEAD = ""
   PHEAD(1) = "TOTAL STOCK"
   PHEAD(2) = "TOTAL MATERIAL - INK"
   PHEAD(3) = "TOTAL MATERIAL - CASE"
   PHEAD(4) = "TOTAL MATERIAL - REGULAR"
   PHEAD(5) = "TOTAL OUTSIDE PURCHASES"
   PHEAD(6) = "TOTAL SHIPPING"
   PHEAD(7) = "TOTAL MISCELLANEOUS"
   PHEAD(8) = "TOTAL LABOR"
*
   DIM PTABLE(20)
   MAT PTABLE = ""
   EQU PAPER.SALE TO PTABLE(1)
   EQU INK.SALE   TO PTABLE(2)
   EQU CASE.SALE  TO PTABLE(3)
   EQU OTHER.SALE TO PTABLE(4)
   EQU OS.SALE    TO PTABLE(5)
   EQU SP.SALE    TO PTABLE(6)
   EQU MS.SALE    TO PTABLE(7)
   EQU LB.SALE    TO PTABLE(8)
   EQU TOTAL.SALE TO PTABLE(10)
   EQU PAPER.SALE.PCT TO PTABLE(11)
   EQU INK.SALE.PCT   TO PTABLE(12)
   EQU CASE.SALE.PCT  TO PTABLE(13)
   EQU OTHER.SALE.PCT TO PTABLE(14)
   EQU OS.SALE.PCT    TO PTABLE(15)
   EQU SP.SALE.PCT    TO PTABLE(16)
   EQU MS.SALE.PCT    TO PTABLE(17)
   EQU LB.SALE.PCT    TO PTABLE(18)
   EQU TOTAL.SALE.PCT TO PTABLE(19)
*
   DIM TOT.REC(10)
   MAT TOT.REC = ""
   EQU TOTAL.FCOST           TO TOT.REC(1)
   EQU TOTAL.VCOST           TO TOT.REC(2)
   EQU TOTAL.TCOST           TO TOT.REC(3)
   EQU TOTAL.FSALE           TO TOT.REC(6)
   EQU TOTAL.VSALE           TO TOT.REC(7)
   EQU TOTAL.TSALE           TO TOT.REC(8)
*
*---- INITIALIZATION
*
*T26090 v
*  HD1A = OCONV(DATE(),"D2/")
*  HD1B = SPACE((40-LEN(CO.NAME))/2):CO.NAME
*  HD1 = HD1A"L#46":HD1B"L#40":SPACE(34):"PAGE: "
*  HD2 = SPACE(45):"E S T I M A T E   R E C A P   R E P O R T"
*T26090 ^
   MAT CUST.REC = ""
   IF EST.CUST = "P" THEN
      CUST.NAME = EST.CUST.NAME
   END ELSE
      MATREAD CUST.REC FROM CUSTOMER, CONO:EST.CUST ELSE
         MAT CUST.REC = ""
         CUST.NAME = EST.CUST.NAME
      END
   END
   HD4A = "ESTIMATE : ":EST.KEY
   HD4B = CUST.NAME
   HD4C = EST.COMMENTS<1,1>
   HD4 = HD4A"L#27":HD4B"L#44":HD4C
*
*---- MAIN PROCESSING
*
   PRINTER ON
   GOSUB 10000
   MAT CSUM.REC = ""
   EC = DCOUNT(PRT.QTY,SVM)
   QPTR = ''
   FOR Q = 1 TO EC
      LOCATE PRT.QTY<1,1,Q> IN EST.QTY<1>,1 SETTING Q1 THEN
         QPTR<1,Q> = Q1
      END
   NEXT Q
   IF EC > 3 THEN EM = 3 ELSE EM = EC
   FOR EP = 1 TO EC
      QSEL = EST.QTY<1,QPTR<1,EP>>
      IF QSEL = "" THEN
         MAT CSUM.REC = ""
         MAT PTABLE = ""
      END ELSE
         CALL EST.COST.TYPE.SUB (CONO, EST.KEY, "ALL", "ALL", QSEL, MAT CSUM.REC)
         IF NOT(CSUM.TOT.SALE = 0 OR CSUM.TOT.SALE = '') THEN
            PAPER.SALE<EP>   = CSUM.MT.SALE.DET<1,1>
            PAPER.SALE.PCT<EP>  = PAPER.SALE<EP> / CSUM.TOT.SALE
            INK.SALE<EP>     = CSUM.MT.SALE.DET<1,2>
            INK.SALE.PCT<EP>    =  INK.SALE<EP> / CSUM.TOT.SALE
            CASE.SALE<EP>    = CSUM.MT.SALE.DET<1,5>
            CASE.SALE.PCT<EP>   = CASE.SALE<EP> / CSUM.TOT.SALE
            OTHER.SALE<EP>   = CSUM.MT.SALE - PAPER.SALE<EP> - INK.SALE<EP> - CASE.SALE<EP>
            OTHER.SALE.PCT<EP>  = OTHER.SALE<EP> / CSUM.TOT.SALE
            OS.SALE<EP>      = CSUM.OS.SALE
            OS.SALE.PCT<EP>     = OS.SALE<EP> / CSUM.TOT.SALE
            SP.SALE<EP>      = CSUM.SP.SALE
            SP.SALE.PCT<EP>     = SP.SALE<EP> / CSUM.TOT.SALE
            MS.SALE<EP>      = CSUM.MS.SALE
            MS.SALE.PCT<EP>     = MS.SALE<EP> / CSUM.TOT.SALE
            LB.SALE<EP>      = CSUM.LB.SALE
            LB.SALE.PCT<EP>     = LB.SALE<EP> / CSUM.TOT.SALE
            TOTAL.SALE<EP>   = CSUM.TOT.SALE
            TOTAL.SALE.PCT<EP>  = PAPER.SALE.PCT<EP> + INK.SALE.PCT<EP> 
            TOTAL.SALE.PCT<EP>  = TOTAL.SALE.PCT<EP> + CASE.SALE.PCT<EP> + OTHER.SALE.PCT<EP> + OS.SALE.PCT<EP> + SP.SALE.PCT<EP> + MS.SALE.PCT<EP> + LB.SALE.PCT<EP>
         END
      END
      IF TOTAL.SALE.PCT<EP> > 1.0 THEN TOTAL.SALE.PCT<EP> = 10000
   NEXT EP
   PLINE=SPACE(27)
   FOR EP = 1 TO EM
      QQ = OCONV(EST.QTY<1,QPTR<1,EP>>,"MD0,")
*T26138 v
*     QQ = QQ:SPACE((10-LEN(QQ))/2)
*     PLINE=PLINE:SPACE(1):"<---------- ":QQ"R#10":" --------->"
      QQ = QQ:SPACE((12-LEN(QQ))/2)
      PLINE=PLINE:SPACE(1):"<--------- ":QQ"R#12":" --------->"
*T26138 ^
   NEXT EP
   PRINT PLINE
   PLINE=SPACE(27)
   FOR EP = 1 TO EM
*T26138 v
*     PLINE=PLINE:SPACE(1):" RECOMMENDED":SPACE(1):"PERCENT ":"  CUSTOMER  "
      PLINE=PLINE:SPACE(2):" RECOMMENDED":SPACE(2):"PERCENT ":" CUSTOMER  "
*T26138 ^
   NEXT EP
   PRINT PLINE
*T26138 v
*  PLINE="         DESCRIPTION          ""L#30"
   PLINE="        DESCRIPTION          ""L#27"
*T26138 ^
   FOR EP = 1 TO EM
*T26138 v
*     PLINE=PLINE:SPACE(1):"    SELL    ":SPACE(1):"OF SALE ":"   QUOTE    "
      PLINE=PLINE:SPACE(1):"     SELL     ":SPACE(1):"OF SALE ":"   QUOTE   "
*T26138 ^
   NEXT EP
   PRINT PLINE
*T26138 v
*  PLINE="------------------------------""L#30"
   PLINE="------------------------------""L#27"
*T26138 ^
   FOR EP = 1 TO EM
*T26138 v
*     PLINE=PLINE:SPACE(1):"------------":SPACE(1):"------- ":"------------"
      PLINE=PLINE:SPACE(1):"-------------- ------- -----------"
*T26138 ^
   NEXT EP
   PRINT PLINE
   FOR PP = 1 TO 10
      IF PHEAD(PP) # "" AND PTABLE(PP) # STR(AM,LEN(PTABLE(PP))) THEN
         PRINT
*T26138 v
*        PLINE=PHEAD(PP)"L#30"
         PLINE=PHEAD(PP)"L#27"
*T26138 ^
IF @LOGNAME = 'cmykleb' THEN DEBUG
         FOR EP = 1 TO EM
            PTABLE(PP+10)<EP> = ICONV(PTABLE(PP+10)<EP>,"MD4")
*T26138 v
*           PLINE=PLINE:SPACE(1):OCONV(PTABLE(PP)<EP>,"MD2Z,")"R#12":SPACE(1):OCONV(PTABLE(PP+10)<EP>,"MD2")"R#6":"%"
*           PLINE=PLINE:SPACE(1):"____________"
            PLINE=PLINE:SPACE(1):OCONV(PTABLE(PP)<EP>,"MD2Z,")"R#14":SPACE(1):OCONV(PTABLE(PP+10)<EP>,"MD2")"R#6":"%"
            PLINE=PLINE:SPACE(1):"___________"
*T26138 ^
         NEXT EP
         PRINT PLINE
      END
   NEXT PP
   PRINT
   PRINT
   PRINT
*T26138 v
*  PLINE="**** ESTIMATE TOTAL ****""L#30"
   PLINE="**** ESTIMATE TOTAL ****""L#27"
*T26138 ^
   FOR EP = 1 TO EM
      TOTAL.SALE.PCT<EP> = ICONV(TOTAL.SALE.PCT<EP>,"MD4")
      IF TOTAL.SALE.PCT<EP> > 10000 THEN TOTAL.SALE.PCT<EP> = 10000
*T26138 v
*     PLINE=PLINE:SPACE(1):OCONV(TOTAL.SALE<EP>,"MD2Z,")"R#12":SPACE(1):OCONV(TOTAL.SALE.PCT<EP>,"MD2")"R#6":"%"
*     PLINE=PLINE:SPACE(1):"____________"
      PLINE=PLINE:SPACE(1):OCONV(TOTAL.SALE<EP>,"MD2Z,")"R#14":SPACE(1):OCONV(TOTAL.SALE.PCT<EP>,"MD2")"R#6":"%"
      PLINE=PLINE:SPACE(1):"___________"
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINT
   PRINT
   QC = DCOUNT(EST.QTY,VM)
   DC = DCOUNT(EST.DEPT.COMP,VM)
   FOR DP = 1 TO DC
      EQTY = FIELD(EST.DEPT.COMP<1,DP>,"!",3)
      LOCATE EQTY IN PRT.QTY<1,1>,1 SETTING EP THEN
         TOTAL.TCOST<1,EP>=TOTAL.TCOST<1,EP>+EST.DEPT.COMP.COST<1,DP>
         TOTAL.VCOST<1,EP>=TOTAL.VCOST<1,EP>+EST.DEPT.COMP.VCOST<1,DP>
         TOTAL.FCOST<1,EP>=TOTAL.TCOST<1,EP>-TOTAL.VCOST<1,EP>
         TOTAL.TSALE<1,EP>=TOTAL.TSALE<1,EP>+EST.DEPT.COMP.TSALE<1,DP>
         TOTAL.VSALE<1,EP>=TOTAL.VSALE<1,EP>+EST.DEPT.COMP.VSALE<1,DP>
         TOTAL.FSALE<1,EP>=TOTAL.TSALE<1,EP>-TOTAL.VSALE<1,EP>
      END
   NEXT DP
*T26138 v
*  PLINE="FIXED AMOUNT""L#30"
   PLINE="FIXED AMOUNT""L#27"
*T26138 ^
   FOR EP = 1 TO EM
*T26138 v
*     PLINE=PLINE:SPACE(1):OCONV(TOTAL.FSALE<1,EP>,"MD2Z,")"R#12":SPACE(9):"____________"
      PLINE=PLINE:SPACE(1):OCONV(TOTAL.FSALE<1,EP>,"MD2Z,")"R#14":SPACE(9):"___________"
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINT
*T26138 v
*  PLINE="VARIABLE AMOUNT""L#30"
   PLINE="VARIABLE AMOUNT""L#27"
*T26138 ^
   FOR EP = 1 TO EM
*T26138 v
*     PLINE=PLINE:SPACE(1):OCONV(TOTAL.VSALE<1,EP>,"MD2Z,")"R#12":SPACE(9):"____________"
      PLINE=PLINE:SPACE(1):OCONV(TOTAL.VSALE<1,EP>,"MD2Z,")"R#14":SPACE(9):"___________"
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINT
*T26138 v
*  PLINE = "MARK-UP PERCENTAGE:" "L#30"
   PLINE = "MARK-UP PERCENTAGE:" "L#27"
*T26138 ^
   FOR EP = 1 TO EM
      MARKUP = OCONV(EST.OM.PCT<1,QPTR<1,EP>>,"MD4")
*T26138 v
*     PLINE = PLINE:SPACE(1):MARKUP "R#12":"%":SPACE(8):"____________"
      PLINE = PLINE:SPACE(1):MARKUP "R#14":"%":SPACE(8):"___________"
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINT
*T26138 v
*  PLINE = "FINAL PRICE:" "L#30"
   PLINE = "FINAL PRICE:" "L#27"
*T26138 ^
   FOR EP = 1 TO EM
      FP = EST.FINAL.PRICE<1,QPTR<1,EP>>
*T26138 v
*     PLINE = PLINE:SPACE(1):OCONV(FP,"MD2,Z")"R#12":SPACE(9):"____________"
      PLINE = PLINE:SPACE(1):OCONV(FP,"MD2,Z")"R#14":SPACE(9):"___________"
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINT
   PLINE = "PRICE PER ":EST.PRT.PRICE.UOM 
*T26138 v
*  PLINE = PLINE "L#30"
   PLINE = PLINE "L#27"
*T26138 ^
   FOR EP = 1 TO EM
      IF EST.PRT.PRICE.UOM = 'EA' THEN
         PRICE.PER.UOM = OCONV(EST.PRICE.UOM<1,QPTR<1,EP>>,"MD4,Z")
      END ELSE
         PRICE.PER.UOM = OCONV(EST.PRICE.UOM<1,QPTR<1,EP>>,"MD2,Z")
      END
*T26138 v
*     PLINE = PLINE:SPACE(1):PRICE.PER.UOM "R#12":SPACE(9):"____________"
      PLINE = PLINE:SPACE(1):PRICE.PER.UOM "R#14":SPACE(9):"___________"
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINT
   IF EST.PRT.PRICE.THOU = 'Y' THEN
*T26138 v
*     PLINE="PRICE PER ADD'L 1,000""L#30"
      PLINE="PRICE PER ADD'L 1,000""L#27"
*T26138 ^
      FOR EP = 1 TO EM
*T26138 v
*        PLINE=PLINE:SPACE(1):OCONV(EST.PRICE.THOU<1,QPTR<1,EP>>,"MD2Z,")"R#12":SPACE(9):"____________"
         PLINE=PLINE:SPACE(1):OCONV(EST.PRICE.THOU<1,QPTR<1,EP>>,"MD2Z,")"R#14":SPACE(9):"___________"
*T26138 ^
      NEXT EP
      PRINT PLINE
      PRINT
*T27716 v
*
* - Print Quoted Price in ESTIMATE.QUOTES File
*
      PLINE = "Pre-Press Details                    Qty        Cost      Target      Quoted   "
      IF EST.PP.INCLUDE='Y' THEN
         PLINE := '** Pre-Press Incl In Recommended Sell Per 1000 **'
      END ELSE
         PLINE := '** Pre-Press Not Incl In Recommended Sell Per 1000 **'
      END
      PRINT PLINE
      CALL EST.RES.PP.COST.PSUB(CONO,EST.KEY,"ALL","ALL",EST.QTY<1,QPTR<1,1>>)
*T27716 ^
   END
   PRINTER OFF
   RETURN
*
*---- PRINT HEADINGS
*
10000*
   PRINT CHAR(12)
   PAGE.NO = PAGE.NO + 1
   PRINT HD1 : PAGE.NO
   PRINT HD2
   PRINT
   PRINT HD4
   PRINT
   RETURN
END
