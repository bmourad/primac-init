   SUBROUTINE EST.DETAIL.RPT.1 (CONO, CO.NAME, EST.KEY, PAGE.NO,PRT.QTY,HD1,HD2)
*********************************************************************
* REVISION - [08.0]
* Copyright 1982 Computer Business Associates (Vercom Software,Inc.)
*
* PROGRAM  - EST.DETAIL.RPT.1
*
* AUTHOR   - NICK AMENDOLA, COMPUTER BUSINESS ASSOCIATES
*
* DATE     - 04/18/86
*
* DESCRIPTION
*
* This program will print the detail estimate report.
*
* MOD BY   - TOM P.
* MOD TASK - CAF1 16026
* MOD DATE - 6.20.91
* MOD REAS - SUBTOTAL BY DEPARTMENT AND GRAND TOTAL.
* MOD TASK 18148 DMT 7/6/94 PRINT SELECTED QUANTITIES
*T26138 cm 10/05/2001 * Expand qty fields.
*T26090 cmykleb 04/04/2002 * Change rpt to use rpt heading from call pgm.
*T27402 thompson 04/28/2003 * Correct error of bypass of quantity with
*                             no cost.
*T27716 cmykleb 10/08/2003 * Add Pre-press inclusive functionality.
*********************************************************************
*
*---- COPY STATEMENTS
*
*COPY>JES.CPYLIB>SCOMMON.ESTIMATE
*COPY>JES.CPYLIB>ESTIMATE
*COPY>JES.CPYLIB>ESTIMATE.DEPT
*COPY>JES.CPYLIB>JES.FILE.VARS
*COPY>PMC.CPYLIB>COST.CNTR
*COPY>PMC.CPYLIB>CUSTOMER
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>CHAR
*
*---- INITIALIZATION
*
*T27716 v
   READ EST.PP FROM CONTROL,CONO:'EST.RES.PRE.PRESS' ELSE EST.PP=''
*T27716 ^
   MAT CUST.REC = ""
   IF EST.CUST = "P" THEN
      CUST.NAME = EST.CUST.NAME
   END ELSE
      MATREAD CUST.REC FROM CUSTOMER, CONO:EST.CUST ELSE
         MAT CUST.REC = ""
         CUST.NAME = EST.CUST.NAME
      END
   END
*T26090 v
*  HD1A = OCONV(DATE(),"D2/")
*  HD1B = SPACE((40-LEN(CO.NAME))/2):CO.NAME
*  HD1C = "PAGE: "
*  HD1 = HD1A"L#46":HD1B"L#40":SPACE(34):HD1C
*  HD2A = SPACE(45):"E S T I M A T E   D E T A I L   R E P O R T"
*  HD2B = SPACE(10):"QUANTITY: "
*  HD2 = HD2A:HD2B
   HD3 = SPACE(65):"ESTIMATE DETAIL REPORT"
*T26090 ^
   HD4A = "ESTIMATE : ":EST.KEY
   HD4B = CUST.NAME
   HD4C = EST.COMMENTS<1,1>
   HD4 = HD4A"L#27":HD4B"L#44":HD4C
   SH1A = "           DESCRIPTION              TP"
   SH2A = "----------------------------------  --"
*T26138 v
*  SH1B = "         QTY    FACTOR      STANDARD        HOURS     TOTAL COST     TOTAL SELL "
*  SH2B = "  ------------  ------  ----------------  --------  -------------  -------------"
   SH1B = "    QUANTITY    FACTOR      STANDARD        HOURS       TOTAL COST     TOTAL SELL "
   SH2B = "  ------------  ------  ----------------  ----------  -------------- ---------------"
*T26138 ^
   SH1 = SH1A:SH1B
   SH2 = SH2A:SH2B
   PREV.CCTR = ""
   PREV.CPTR = ""
   LINE.CNT = 99
   DEPT.COST = 0
   DEPT.SALE = 0
   GRAND.COST = 0
   GRAND.SALE = 0
*T26138 v
*  DLINE = SPACE(90):STR('-',13):"  ":STR('-',13)
   DLINE = SPACE(92):STR('-',14):"  ":STR('-',14)
*T26138 ^
   PRINTER ON
*
*---- MAIN PROCESSING
*
   ECNT = DCOUNT(PRT.QTY,SVM)
   QPTR = ''
   FOR Q = 1 TO ECNT
      LOCATE PRT.QTY<1,1,Q> IN EST.QTY<1>,1 SETTING Q1 THEN
         QPTR<1,Q> = Q1
      END
   NEXT Q
   IF ECNT > 3 THEN ECNT = 3
   CCNT = EST.COMPONENT.CNT
   DCNT = COUNT(EST.DEPT,VM) + (EST.DEPT # "")
   FOR EPTR = 1 TO ECNT
      EQTY = EST.QTY<1,QPTR<1,EPTR>>
      LINE.CNT = 99
      PREV.CPTR = ""
      FOR CPTR = 1 TO CCNT
         FOR DPTR = 1 TO DCNT
            GOSUB 1000
         NEXT DPTR
      NEXT CPTR
      PRINT
      PRINT DLINE
*T26138 v
*     PLINE = SPACE(78):'GRAND TOTAL ':OCONV(GRAND.COST,"MD2,")"R#13  ":OCONV(GRAND.SALE,"MD2,")"R#13"
      PLINE = SPACE(80):'GRAND TOTAL ':OCONV(GRAND.COST,"MD2,")"R#14  ":OCONV(GRAND.SALE,"MD2,")"R#14"
*T26138 ^
      PRINT PLINE
      GRAND.COST = 0
      GRAND.SALE = 0
   NEXT EPTR
   GOTO 99999
*
*---- PRINT DEPARTMENT DETAIL FOR SPECIFIED COMPONENT AND QUANTITY
*
1000 *
   ESTD.ID = DPTR:"!":CPTR:"!":EQTY
   LOCATE ESTD.ID IN EST.DEPT.COMP<1>,1 SETTING DCP ELSE RETURN
   MATREAD ESTD.REC FROM ESTIMATE.DEPT, CONO:EST.KEY:"!":ESTD.ID ELSE RETURN
   IF CPTR # PREV.CPTR THEN
      PREV.CPTR = CPTR
      IF LINE.CNT + 6 > 55 THEN GOSUB 10000
      PRINT
      PRINT STR("<",55):"  ":EST.PROD.DESC<1,CPTR,1>:"  ":STR(">",54)
      LINE.CNT = LINE.CNT + 2
   END
   IF LINE.CNT + 4 > 55 THEN GOSUB 10000
   PRINT
   PLINE = ""
   PLINE = PLINE:EST.DEPT.DESC<1,DPTR>"L#34"
   PRINT PLINE
   LINE.CNT = LINE.CNT + 2
   TC = COUNT(ESTD.TYPE,VM) + (ESTD.TYPE # "")
   FOR TP = 1 TO TC
      IF ESTD.TYPE<1,TP> = "G" THEN
         IF LINE.CNT+2 > 55 THEN GOSUB 10000
         PLINE = SPACE(1):ESTD.DESC<1,TP> "L#33"
         PRINT PLINE
         LINE.CNT = LINE.CNT + 1
         PREV.CCTR = ""
         GOTO 1090
      END
      CCTR = ESTD.CCTR<1,TP>
      IF LINE.CNT > 55 THEN GOSUB 10000
      TEMP.TYPE = ESTD.TYPE<1,TP>
      TEMP.QTY = ESTD.QTY<1,TP>
      TEMP.STD = ESTD.STD<1,TP>
      PLINE = ""
      PLINE = PLINE:SPACE(4):ESTD.DESC<1,TP>"L#30"
      PLINE = PLINE:SPACE(2):TEMP.TYPE"L#2"
      IF INT(TEMP.QTY/100) = (TEMP.QTY/100) THEN
         PLINE = PLINE:SPACE(1):OCONV((TEMP.QTY/100),"MD0,")"R#13"
      END ELSE
         PLINE = PLINE:SPACE(1):OCONV(TEMP.QTY,"MD2,")"R#13"
      END
      PLINE = PLINE:SPACE(2):OCONV(ESTD.FCTR<1,TP>,"MD3")"R#6"
      IF INT(TEMP.STD/100) = (TEMP.STD/100) THEN
         PLINE = PLINE:SPACE(2):OCONV((TEMP.STD/100),"MD0,")"R#10"
      END ELSE
         PLINE = PLINE:SPACE(2):OCONV(TEMP.STD,"MD2,")"R#10"
      END
      PLINE = PLINE:SPACE(1):ESTD.STD.TYPE<1,TP>"L#5"
*T27716 v
      IF EST.PP.INCLUDE # 'Y' THEN
         LOCATE ESTD.DEPT IN EST.PP<1>,1 SETTING DPOS THEN
            SALE = 0
         END ELSE
            SALE = ESTD.TSALE<1,TP>
         END
      END ELSE
         SALE = ESTD.TSALE<1,TP>
      END
*T27716 ^
*T26138 v
*     PLINE = PLINE:SPACE(2):OCONV(ESTD.HRS<1,TP>,"MD2,")"R#8"
*     PLINE = PLINE:SPACE(2):OCONV(ESTD.COST<1,TP>,"MD2,")"R#13"
*     PLINE = PLINE:SPACE(2):OCONV(ESTD.TSALE<1,TP>,"MD2,")"R#13"
      PLINE = PLINE:SPACE(2):OCONV(ESTD.HRS<1,TP>,"MD2,")"R#10"
      PLINE = PLINE:SPACE(2):OCONV(ESTD.COST<1,TP>,"MD2,")"R#14"
*T27716 v
*     PLINE = PLINE:SPACE(2):OCONV(ESTD.TSALE<1,TP>,"MD2,")"R#14"
      PLINE = PLINE:SPACE(2):OCONV(SALE,"MD2,")"R#14"
*T27716 ^
*T26138 ^
      CHECK.PRINT=1
      BEGIN CASE
         CASE ESTD.COST<1,TP> # 0 AND ESTD.COST<1,TP> # ""
*T27716 v
*        CASE ESTD.TSALE<1,TP> # 0 AND ESTD.TSALE<1,TP> # ""
*        CASE ESTD.HRS<1,TP> # 0 AND ESTD.TSALE<1,TP> # ""
         CASE SALE # 0 AND SALE # ""
         CASE ESTD.HRS<1,TP> # 0 AND SALE # ""
*T27716 ^
         CASE 1
            CHECK.PRINT=''
      END CASE
      IF CHECK.PRINT THEN
         IF CCTR # PREV.CCTR THEN
            IF LINE.CNT+1 > 55 THEN GOSUB 10000
            PREV.CCTR = CCTR
            MATREAD CCTR.REC FROM COST.CNTR, CONO:CCTR ELSE
               MAT CCTR.REC = ""
            END
            PLINE1 = ""
            PLINE1 = PLINE1:SPACE(2):CCTR.DESC"L#32"
            PRINT PLINE1
            LINE.CNT = LINE.CNT + 1
            IF LINE.CNT > 55 THEN GOSUB 10000
         END
         PRINT PLINE
         LINE.CNT = LINE.CNT + 1
      END ELSE
         IF CCTR # PREV.CCTR THEN
            PREV.CCTR = CCTR
            MATREAD CCTR.REC FROM COST.CNTR, CONO:CCTR ELSE
               MAT CCTR.REC = ""
            END
         END
      END
      DEPT.COST = DEPT.COST + ESTD.COST<1,TP>
*T27716 v
*     DEPT.SALE = DEPT.SALE + ESTD.TSALE<1,TP>
      DEPT.SALE = DEPT.SALE + SALE
*T27716 ^
1090 NEXT TP
   PRINT
   PRINT DLINE
*T26138 v
*  PLINE = SPACE(53):EST.DEPT.DESC<1,DPTR> "R#30 ":'TOTAL ':OCONV(DEPT.COST,"MD2,")"R#13  ":OCONV(DEPT.SALE,"MD2,")"R#13"
   PLINE = SPACE(55):EST.DEPT.DESC<1,DPTR> "R#30 ":'TOTAL ':OCONV(DEPT.COST,"MD2,")"R#14  ":OCONV(DEPT.SALE,"MD2,")"R#14"
*T26138 ^
   PRINT PLINE
   LINE.CNT = LINE.CNT + 3
   GRAND.COST = GRAND.COST + DEPT.COST
   GRAND.SALE = GRAND.SALE + DEPT.SALE
   DEPT.COST = 0
   DEPT.SALE = 0
   RETURN
*
*---- PRINT HEADINGS
*
10000 *
   PRINT CHAR(12)
   PAGE.NO = PAGE.NO + 1
   PRINT HD1:PAGE.NO
*T26090 v
*  PRINT HD2:OCONV(EQTY,"MD0,")
*  PRINT HD3
   PRINT HD2
   PRINT SPACE(107):"QUANTITY: ":OCONV(EQTY,"MD0,")
*T26090 ^
   PRINT
   PRINT HD4
   PRINT
   PRINT
   PRINT SH1
   PRINT SH2
   LINE.CNT = 10
   RETURN
*
*---- END OF PROGRAM
*
99999 *
   PRINTER OFF
   RETURN
END
