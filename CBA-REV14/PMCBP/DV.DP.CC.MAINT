*REVISION    - [08.0]
*T27624 lross 08/11/2003 * Use DEPT.NON.JCS for Dept lookup.
*T26626 lross 05/30/2002 * Div display disappeared when ESC from DEPT
*                          lookup.
*T21876 diane 05/05/1997 * Modify to use GEN.XREF for GUI compatability
*T23278 markt 09/28/1998 * Check for division security
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
10200*
  IF COA.LEVEL = 0 THEN
      DV.NO = GEN.DIV
      DP.NO = GEN.DEPT
      CC.NO = GEN.CCTR
      P_X  = DV.X ; P_Y = SLN ; P_VALUE = DV.NO "L#2" ; P_OPT = ""
      P_X  := AM:DP.X ; P_Y := AM:SLN ; P_VALUE := AM:DP.NO "L#2"
      P_X  := AM:CC.X ; P_Y := AM:SLN ; P_VALUE := AM:CC.NO "L#3"
      CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
      GOTO 10500
  END
  X = DV.X
  Y = SLN
  TYP = 3
  MINL = 2
  MAXL = MINL
  O.R = 'O'
  DEFAULT = DV.NO
  CALL EDIT.SUB
  IF VALUE = "END" THEN GOTO 10100
  IF VALUE = "" THEN
*T21876 v
*        READ REC FROM CONTROL, CONO:"DIVISIONS" ELSE REC = ''
*        IF REC<1> = '' THEN GOTO 10200
*        S.LINES = COUNT(REC<1>,VM) + 1
*        S.NO = ''
*        S.DESC = ''
*        FOR I = 1 TO S.LINES
*           S.NO<I> = REC<1,I>
*           MATREAD DIV.REC FROM DIVISION, CONO:S.NO<I> ELSE DIV.DESC = UNKNOWN
*           S.DESC<I> = DIV.DESC
*        NEXT I
*        S.LN = 1
*        S.OLD.START = 0
*        X1 = DV.X
*        GOSUB 55000
*        GOSUB 50000
*
      GXR.NAME='DIVISION15' ;*T27624
      GXR.XREF=CONTROL
      GXR.FILE=DIVISION
*     GXR.LOC=1
*     GXR.TOP.LINE='DIVISION XREF SEARCH'
*     GXR.HEADING<1,1>='DIV'
*     GXR.HEADING<1,2>='DESCRIPTION'
*     GXR.LEN<1,1> = 5
*     GXR.ATT<1,1>=0
*     GXR.ATT<1,2>=1
*     GXR.LEN<1,2> = 30
*     GXR.ID=''
      GXR.SRCH.ID="DIVISIONS"
*     CALL GEN.XREF(MAT GEN.XREF.REC,PREFIX)
      CALL GEN.XREF.SUB(MAT GEN.XREF.REC, PREFIX, XREF.DATA) ;*T27624
      S.NO = GXR.ID
      ECD.ACTION = 2 ; CALL SCRN.EDIT
      ECD.ACTION = 3 ; CALL SCRN.EDIT
      OLD.START = ""
      GOSUB 80000
*T21876 ^
      IF S.NO = '' THEN GOTO 10200
      VALUE = S.NO
      P_X  = DV.X ; P_Y = SLN ; P_VALUE = VALUE "L#2" ; P_OPT = ""
      CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
  END
  IF VALUE = GEN.DIV THEN
*T23278 v
      DIV.CODE = VALUE; USER.ID = UPCASE(@LOGNAME); ERRMSG = ''
      CALL CK.DIV.SEC.SUB(CONO,DIV.CODE,USER.ID,ERRMSG)
      IF ERRMSG # '' THEN
          GOSUB 91000; GOTO 10200
      END
*T23278 ^
      DV.NO = GEN.DIV
      DP.NO = GEN.DEPT
      CC.NO = GEN.CCTR
      P_X  = DP.X ; P_Y = SLN ; P_VALUE = DP.NO "L#2" ; P_OPT = ""
      P_X  := AM:CC.X ; P_Y := AM:SLN ; P_VALUE := AM:CC.NO "L#3"
      CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
      GOTO 10500
  END
  MATREAD DIV.REC FROM DIVISION, CONO:VALUE ELSE
      ERRMSG = 'CANNOT LOCATE DIVISION : ' : VALUE
      GOSUB 91000
      GOTO 10200
  END
*T23278 v
  DIV.CODE = VALUE; USER.ID = UPCASE(@LOGNAME); ERRMSG = ''
  CALL CK.DIV.SEC.SUB(CONO,DIV.CODE,USER.ID,ERRMSG)
  IF ERRMSG # '' THEN
      GOSUB 91000; GOTO 10200
  END
*T23278 ^
  DV.NO = VALUE
10300*   
  IF COA.LEVEL = 1 THEN
      DP.NO = GEN.DEPT
      CC.NO = GEN.CCTR
      P_X  = DP.X ; P_Y = SLN ; P_VALUE = DP.NO "L#2" ; P_OPT = ""
      P_X  := AM:CC.X ; P_Y := AM:SLN ; P_VALUE := AM:CC.NO "L#3"
      CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
      GOTO 10500
  END
  X = DP.X
  Y = SLN
  TYP = 3
  MINL = 2
  MAXL = MINL
  O.R = 'O'
  DEFAULT = DP.NO
  CALL EDIT.SUB
  IF VALUE = "END" THEN GOTO 10100
  IF VALUE = "" THEN
      IF DIV.DEPT = '' THEN GOTO 10300
*T27624 v
*T21876 v
   S.LINES = COUNT(DIV.DEPT,VM) + 1
   S.NO = ''
   S.DESC = ''
   II = 0
   FOR I = 1 TO S.LINES
     IF LEN(DIV.DEPT<1,I>) = 2 THEN
       II = II + 1
*T27624  S.NO<II> = DIV.DEPT<1,I>
       S.NO<1,II> = DIV.DEPT<1,I>
       MATREAD DEPT.REC FROM DEPARTMENT, CONO:S.NO<II> ELSE DEPT.DESC = UNKNOWN
       S.DESC<II> = DEPT.DESC
     END
   NEXT I
   IF II < 1 THEN GOTO 10300
*  S.LINES = II
*  S.LN = 1
*  S.OLD.START = 0
*  X1 = DP.X
*  GOSUB 55000
*  GOSUB 50000
      GXR.XREF = DIVISION
      GXR.FILE = DEPARTMENT
*     GXR.LOC = 2
*     GXR.TOP.LINE = 'DEPARTMENT XREF SEARCH'
*     GXR.HEADING = 'DEPARTMENT'
*     GXR.HEADING<1,2>="DESCRIPTION"
*     GXR.ATT=0
*     GXR.ATT<1,2> = 2
*     GXR.LEN=5
*     GXR.LEN<1,2>=30
*     GXR.ID = ''
      GXR.SRCH.ID = DV.NO
*     CALL GEN.XREF(MAT GEN.XREF.REC,PREFIX)
      GXR.NAME='DEPT.NON.JCS'
      GXR.IDLIST = S.NO
      CALL GEN.XREF.SUB(MAT GEN.XREF.REC, PREFIX, XREF.DATA)
      GXR.IDLIST=''
*T27624 ^
      S.NO = GXR.ID
      ECD.ACTION = 2 ; CALL SCRN.EDIT
      ECD.ACTION = 3 ; CALL SCRN.EDIT
      OLD.START = ""
      GOSUB 80000
*T21876^
*T26626 v Move below  IF S.NO = '' THEN GOTO 10300
      P_X  = DV.X ; P_Y = SLN ; P_VALUE = DV.NO "L#2" ; P_OPT = ""
      CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
      IF S.NO = '' THEN GOTO 10300 ;*To here
      VALUE = S.NO
      P_X  = DP.X ; P_Y = SLN ; P_VALUE = VALUE "L#2" ; P_OPT = ""
      CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
  END
  IF VALUE = GEN.DEPT THEN
      DP.NO = GEN.DEPT
      CC.NO = GEN.CCTR
      P_X  = CC.X ; P_Y = SLN ; P_VALUE = CC.NO "L#3" ; P_OPT = ""
      CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
      GOTO 10500
  END
  LOCATE VALUE IN DIV.DEPT<1>,1 SETTING FND ELSE
      ERRMSG = 'CANNOT LOCATE DEPARTMENT : ':VALUE:', UNDER DIVISION : ':DV.NO
      GOSUB 91000
      GOTO 10300
  END
  MATREAD DEPT.REC FROM DEPARTMENT, CONO:VALUE ELSE
      ERRMSG = 'CANNOT LOCATE DEPARTMENT : ' : VALUE
      GOSUB 91000
      GOTO 10300
  END
  DP.NO = VALUE
10400*   
  IF COA.LEVEL = 2 THEN
      CC.NO = GEN.CCTR
      P_X  = CC.X ; P_Y = SLN ; P_VALUE = CC.NO "L#3" ; P_OPT = ""
      CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
      GOTO 10500
  END
  X = CC.X
  Y = SLN
  TYP = 3
  MINL = 3
  MAXL = MINL
  O.R = 'O'
  DEFAULT = CC.NO
  CALL EDIT.SUB
  IF VALUE = "END" THEN GOTO 10100
  IF VALUE = "" THEN
      IF DEPT.CCTRS = '' THEN GOTO 10400
*T21876 v
*  S.LINES = COUNT(DEPT.CCTRS,VM) + 1
*  S.NO = ''
*  S.DESC = ''
*  FOR I = 1 TO S.LINES
*    S.NO<I> = DEPT.CCTRS<1,I>
*    MATREAD CCTR.REC FROM COST.CNTR, CONO:S.NO<I> ELSE CCTR.DESC = UNKNOWN
*    S.DESC<I> = CCTR.DESC
*  NEXT I
*  S.LN = 1
*  S.OLD.START = 0
*  X1 = CC.X
*  GOSUB 55000
*  GOSUB 50000
      GXR.NAME='CCTR.DEPT'
      GXR.XREF=DEPARTMENT
      GXR.FILE=COST.CNTR
*     GXR.LOC=5
*     GXR.TOP.LINE="COST CENTER XREF SEARCH"
*     GXR.HEADING="CCTR"
*     GXR.HEADING<1,2>="DESCRIPTION"
*     GXR.ATT=0
*     GXR.ATT<1,2>=1
*     GXR.LEN=3
*     GXR.LEN<1,2>=30
*     GXR.ID=""
      GXR.SRCH.ID=DP.NO
*     CALL GEN.XREF(MAT GEN.XREF.REC,PREFIX)
      CALL GEN.XREF.SUB(MAT GEN.XREF.REC, PREFIX, XREF.DATA) ;*T27624
      ECD.ACTION=2;CALL SCRN.EDIT
      ECD.ACTION=3;CALL SCRN.EDIT
      OLD.START = ""
      GOSUB 80000
      S.NO = GXR.ID
*T21876 ^
      P_X  = DV.X ; P_Y = SLN ; P_VALUE = DV.NO "L#2" ; P_OPT = ""
      P_X  := AM:DP.X ; P_Y := AM:SLN ; P_VALUE := AM:DP.NO "L#2"
      CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
      IF S.NO = '' THEN GOTO 10400
      VALUE = S.NO
      P_X  = CC.X ; P_Y = SLN ; P_VALUE = VALUE "L#3" ; P_OPT = ""
      CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
  END
  IF VALUE = GEN.CCTR THEN
      CC.NO = GEN.CCTR
      GOTO 10500
  END
  LOCATE VALUE IN DEPT.CCTRS<1>,1 SETTING FND ELSE
      ERRMSG = 'CANNOT LOCATE COST CENTER : ':VALUE:', UNDER DEPARTMENT : ':DP.NO
      GOSUB 91000
      GOTO 10400
  END
  MATREAD CCTR.REC FROM COST.CNTR, CONO:VALUE ELSE
      ERRMSG = 'CANNOT LOCATE COST CENTER : ':VALUE
      GOSUB 91000
      GOTO 10400
  END
  CC.NO = VALUE
