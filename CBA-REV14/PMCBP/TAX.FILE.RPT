*COPY>CPYLIB>COM1
****************************************************************
* REVISION      - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* PROGRAM       - TAX.FILE.RPT
* SYSTEM        - PMCBP
* BY            - RHONDA PERRIN, C.B.A.
* DATE          - 05/06/86
* DESCRIPTION   - This program produces a Tax File Print report.
*               - 03/30/89 GFG TASK # 13976
* TASK
*  18573 LLH 5/95 ACCOUNTING PERIODS 1-52 ADD QUARTER TO SALESDATES
*
* T22154 stefanie 08/19/1997 * Fix Rev10B to Rev11 match problem.
*T22583 lanny 02/09/98 * Other fixes to T22154 (QTD totals wrong).
*T26493 cmykleb 03/22/2002 * Change report to use rpt # from proc.
*T28552 lross 05/17/2005 * 52 period acctng mods never made to this pgm.
****************************************************************
*
*---- FILE EQUATES
*
*COPY>CPYLIB>SYSCOM
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>FILE.VARS
*COPY>PMC.CPYLIB>SALESDATES
*COPY>PMC.CPYLIB>COMPANY
*COPY>PMC.CPYLIB>DIVISION
*COPY>PMC.CPYLIB>FISCAL
*COPY>PMC.CPYLIB>TAX
*COPY>PMC.CPYLIB>TAX.BAL
*
*---- DIMENSION VARIABLES
*
*
*---- SETUP FOR SYSTEM ERROR MESSAGES
*
   SYS.TYPE=1
   CALL SYSCOM(MAT SYSCOM.REC)
*
*---- PROCREAD
*
   PROCREAD ID ELSE ERRMSG = "MUST BE RUN FROM A PROC";GOSUB 91000;GOTO 99999
   CONO = ID<1>
   CONAME = ID<2>
   YYYY = ID<3>
   RPT.MONTH = ID<4>
*      BRK.FLG = ID<5>
   DIV.NO = ID<6>
*T28552 v Move to below read of CONTROL SALESDATES record.
*  BEGIN CASE
*     CASE RPT.MONTH = "JAN"
*        MON = 1
*        MONTH.NAME = "JANUARY"
*        SPC = SPACE(68)
*        QTR.MON = '1':VM:'2':VM:'3'      ;*T22154 <
*     CASE RPT.MONTH = "FEB"
*        MON = 2
*        MONTH.NAME = "FEBRUARY"
*        SPC = SPACE(67)
*        QTR.MON = '1':VM:'2':VM:'3'      ;*T22154 <
*     CASE RPT.MONTH = "MAR"
*        MON = 3
*        MONTH.NAME = "MARCH"
*        SPC = SPACE(69)
*        QTR.MON = '1':VM:'2':VM:'3'      ;*T22154 <
*     CASE RPT.MONTH = "APR"
*        MON = 4
*        MONTH.NAME = "APRIL"
*        SPC = SPACE(69)
*        QTR.MON = '4':VM:'5':VM:'6'      ;*T22154 <
*     CASE RPT.MONTH = "MAY"
*        MON = 5
*        MONTH.NAME = "MAY"
*        SPC = SPACE(70)
*        QTR.MON = '4':VM:'5':VM:'6'      ;*T22154 <
*     CASE RPT.MONTH = "JUN"
*        MON = 6
*        MONTH.NAME = "JUNE"
*        SPC = SPACE(69)
*        QTR.MON = '4':VM:'5':VM:'6'      ;*T22154 <
*     CASE RPT.MONTH = "JUL"
*        MON = 7
*        MONTH.NAME = "JULY"
*        SPC = SPACE(69)
*        QTR.MON = '7':VM:'8':VM:'9'      ;*T22154 <
*     CASE RPT.MONTH = "AUG"
*        MON = 8
*        MONTH.NAME = "AUGUST"
*        SPC = SPACE(68)
*        QTR.MON = '7':VM:'8':VM:'9'      ;*T22154 <
*     CASE RPT.MONTH = "SEP"
*        MON = 9
*        MONTH.NAME = "SEPTEMBER"
*        SPC = SPACE(67)
*        QTR.MON = '7':VM:'8':VM:'9'      ;*T22154 <
*     CASE RPT.MONTH = "OCT"
*        MON = 10
*        MONTH.NAME = "OCTOBER"
*        SPC = SPACE(68)
*        QTR.MON = '10':VM:'11':VM:'12'   ;*T22154 <
*     CASE RPT.MONTH = "NOV"
*        MON = 11
*        MONTH.NAME = "NOVEMBER"
*        SPC = SPACE(67)
*        QTR.MON = '10':VM:'11':VM:'12'   ;*T22154 <
*     CASE RPT.MONTH = "DEC"
*        MON = 12
*        MONTH.NAME = "DECEMBER"
*        SPC = SPACE(67)
*        QTR.MON = '10':VM:'11':VM:'12'   ;*T22154 <
*     CASE 1
*        ERRMSG = "INVALID INFORMATION PASSED FROM PROC"
*        GOSUB 91000
*        GOTO 99999
*  END CASE
*T28552 ^
*
*---- OPEN FILES
*
   OPEN 'COMPANY' TO COMPANY ELSE ERRMSG='COMPANY FILE MISSING';GOTO 93000
   OPEN 'CONTROL' TO CONTROL ELSE ERRMSG='CONTROL FILE MISSING';GOTO 93000
   OPEN 'TAX' TO TAX ELSE ERRMSG='TAX FILE MISSING';GOTO 93000
   OPEN 'TAX.BAL' TO TAX.BAL ELSE ERRMSG='TAX.BAL FILE MISSING';GOTO 93000
   OPEN 'DIVISION' TO DIVISION ELSE ERRMSG='DIVISION FILE MISSING';GOTO 93000
*
*---- GET COMPANY NUMBER
*
   MATREAD COMP.REC FROM COMPANY, CONO ELSE GOTO 99999
*
*---- INITIALIZATION
*
*T28552 v
MATREAD SALESDATES.REC FROM CONTROL, CONO:"SALESDATES" ELSE
  ERRMSG='Cannot read SALESDATES Control record!'; GOTO 93000
END
READ NUM.PERIODS FROM CONTROL,CONO:"ACCT.PERIODS" ELSE
  NUM.PERIODS=12
END
SDR.PTR=RPT.MONTH+1
QTR=SALESDATES.REC(SDR.PTR)<1,3>
BEGIN CASE
  CASE SALESDATES.REC(SDR.PTR)<1,1> # ''
  CASE 1
    ERRMSG = "PERIOD ":RPT.MONTH:" Not found in SALESDATES CONTROL record"
    GOSUB 91000
    GOTO 99999
END CASE
*T28552 ^
   FIRST.TIME = 1
   PG.NO=0
   LINE.CNT=99
   ERRMSG=""
   SP1 = " "     ;*T22154 <
   SP2 = "  "
   SP3 = "   "
   NODATA=1
   OCODE = ""
   ODIV = ""
   TOTAL.CODE = ""
   TOTAL.DESC = ""
   TOTAL.RATE = ""
   TOTAL.MTD = ""
   MTD.GROSS = 0
   MTD.TAX = 0
* T22154 v
   QTD.GROSS = 0
   QTD.TAX   = 0
   YTD.GROSS = 0
   YTD.TAX   = 0
* T22154 ^
   DIV.M.GROSS = 0
   DIV.M.TAX   = 0
* T22154 v
   DIV.Q.GROSS = 0
   DIV.Q.TAX   = 0
   DIV.Y.GROSS = 0
   DIV.Y.TAX   = 0
* T22154 ^
   GRAND.M.GROSS = 0
   GRAND.M.TAX = 0
* T22154 v
   GRAND.Q.GROSS = 0
   GRAND.Q.TAX   = 0
   GRAND.Y.GROSS = 0
   GRAND.Y.TAX   = 0
* T22154 ^
*
*
*----- HEADINGS
*
*T26493 v
*  REPORT.NAME = "TAX FILE LISTING"
*  REPORT.NUMBER = "XXXX"
   REPORT.NAME = ""
   REPORT.NUMBER = ID<2>
   CONAME = ""
*T26493 ^
   REPORT.DATE = DATE()
   HD1 = "" ; HD2 = ""
*** GET HEADING
   CALL GET.PROG.HEAD(CONO,CONAME,REPORT.NAME,REPORT.NUMBER,REPORT.DATE,HD1,HD2)
   HEAD1 = HD1
   HEAD2 = HD2
*T28552 HEAD3 = SPACE(65):"FOR MONTH ":MONTH.NAME
   HEAD3 = SPACE(65):"FOR PERIOD ":RPT.MONTH
   HEAD4 = SPACE(65):"FOR DIVISION ":DIV.NO
* T22154 v
*T28552 HEAD4.5 = SPACE(49):"MONTH""L#23":SPACE(3):"QUARTER""L#23":SPACE(3):"YEAR"
   HEAD4.5 = SPACE(50):"PERIOD""L#22":SPACE(3):"QUARTER""L#23":SPACE(3):"YEAR"
*      HEAD5 = "CODE             DESCRIPTION           TAX RATE  TAXABLE SL   TAX AMOUNT"
   HEAD5 = "CODE             DESCRIPTION           TAX RATE  TAXABLE SL   TAX AMOUNT   TAXABLE SL   TAX AMOUNT   TAXABLE SL   TAX AMOUNT"
   HEAD6 = "-----  ------------------------------  --------  ----------   ----------   ----------   ----------   ----------   ----------"
   ULINE = SPACE(49):"----------   ----------   ----------   ----------   ----------   ----------"
*      HEAD6 = "-----  ------------------------------  --------  ----------   ----------"
*      ULINE = SPACE(49):"----------   ----------"
*
*
*---- MAIN PROCESSING
*
   PRINTER ON
100*
   EOL = 0
   LOOP 
      READNEXT TAX.ID ELSE EOL = 1
   UNTIL EOL = 1 DO 
      IF DIV.NO # "ALL" AND DIV.NO # TAX.ID[4,2] THEN GOTO 100
      MATREAD TAX.BAL.REC FROM TAX.BAL, TAX.ID ELSE GOTO 100
      DIV = TAX.ID[4,2]
      CODE = TAX.ID[11,99]
      IF FIRST.TIME = 1 THEN
         ODIV = DIV
         OCODE = CODE
         FIRST.TIME = 0
      END
      IF OCODE # CODE THEN
         GOSUB 1000
         OCODE = CODE
         IF ODIV # DIV THEN
            GOSUB 2000
            ODIV = DIV
         END
      END ELSE
         IF ODIV # DIV THEN
            GOSUB 1000
            GOSUB 2000
            ODIV = DIV
         END
      END
*         BEGIN CASE
*         CASE ODIV # DIV
*            GOSUB 1000
*            GOSUB 2000
*            ODIV = DIV
*            OCODE = CODE
*            IF DIV = "00" THEN
*               MAT DIV.REC = ""
*               DIV.DESC = "GENERAL DIVISION"
*            END ELSE
*               MATREAD DIV.REC FROM DIVISION, CONO : DIV ELSE
*                  MAT DIV.REC = ""
*                  DIV.DESC = "NOT ON FILE"
*               END
*            END
*         CASE OCODE # CODE
*            GOSUB 1000
*            OCODE = CODE
*         END CASE
* T22154 v
*
*---- MONTH
*
* T22154 ^
      MON = RPT.MONTH ;*T28552
      TAX.POST.MON = YYYY:MON"R%2"
      LOCATE TAX.POST.MON IN TBR.PERIOD<1>,1 SETTING INDX THEN
*T22154 v           MTD.TAX = MTD.TAX + TBR.TAXABLE<1,INDX>
*                   MTD.GROSS = MTD.GROSS + TBR.CHARGED<1,INDX>
         MTD.TAX = MTD.TAX + TBR.CHARGED<1,INDX>
         MTD.GROSS = MTD.GROSS + TBR.TAXABLE<1,INDX>
*T22154 ^
      END
* T22154 v
*
*---- QUARTER
*
*T28552
*     FOR M = 1 TO 3
      FOR M = 2 TO NUM.PERIODS+1
        IF SALESDATES.REC(M)<1,3> = QTR THEN
    *     TAX.POST.MON = YYYY:QTR.MON<1,M>"R%2"
          TAX.POST.MON = YYYY:M-1"R%2"
          LOCATE TAX.POST.MON IN TBR.PERIOD<1>,1 SETTING INDX THEN
            QTD.TAX = QTD.TAX + TBR.CHARGED<1,INDX>
            QTD.GROSS = QTD.GROSS + TBR.TAXABLE<1,INDX>
          END
        END
*T28552 ^
      NEXT M
*
*---- YEAR
*
*T28552 FOR M = 1 TO 12
      FOR M = 1 TO NUM.PERIODS
         TAX.POST.MON = YYYY:M"R%2"
         LOCATE TAX.POST.MON IN TBR.PERIOD<1>,1 SETTING INDX THEN
            YTD.TAX = YTD.TAX + TBR.CHARGED<1,INDX>
            YTD.GROSS = YTD.GROSS + TBR.TAXABLE<1,INDX>
         END
      NEXT M
* T22154 ^
   REPEAT
*
   GOSUB 1000
   GOSUB 2000
   GOSUB 5000
   PRINTER OFF
   GOTO 99999
*-----------------------*
*---   SUBROUTINES   ---*
*-----------------------*
*
*---- PRINT THE MONTH VALUES
*
1000*
   IF LINE.CNT > 54 THEN GOSUB 8000
   MATREAD TAX.REC FROM TAX, CONO:OCODE ELSE
      MAT TAX.REC = ""
      TAX.JURS = "NOT ON FILE"
   END
   V.LINE = OCODE "L#5" : SP2
   V.LINE = V.LINE : TAX.JUR "L#30" : SP2
   V.LINE = V.LINE : OCONV(TAX.RATE, "MD3") "R#8" : SP2
   V.LINE = V.LINE : OCONV(MTD.GROSS,"MD2")"R#10" : SP3
   V.LINE = V.LINE : OCONV(MTD.TAX,"MD2")"R#10" : SP3
* T22154 v
   V.LINE = V.LINE : OCONV(QTD.GROSS,"MD2")"R#10" : SP3
   V.LINE = V.LINE : OCONV(QTD.TAX,"MD2")"R#10" : SP3
   V.LINE = V.LINE : OCONV(YTD.GROSS,"MD2")"R#10" : SP3
   V.LINE = V.LINE : OCONV(YTD.TAX,"MD2")"R#10" : SP3
* T22154 ^
   PRINT V.LINE
   LINE.CNT = LINE.CNT + 1
   DIV.M.GROSS = DIV.M.GROSS + MTD.GROSS
   DIV.M.TAX   = DIV.M.TAX   + MTD.TAX
* T22154 v
   DIV.Q.GROSS = DIV.Q.GROSS + QTD.GROSS
   DIV.Q.TAX   = DIV.Q.TAX   + QTD.TAX
   DIV.Y.GROSS = DIV.Y.GROSS + YTD.GROSS
   DIV.Y.TAX   = DIV.Y.TAX   + YTD.TAX
* T22154 ^
   GRAND.M.GROSS = GRAND.M.GROSS + MTD.GROSS
   GRAND.M.TAX = GRAND.M.TAX + MTD.TAX
* T22154 v
   GRAND.Q.GROSS = GRAND.Q.GROSS + QTD.GROSS
   GRAND.Q.TAX   = GRAND.Q.TAX   + QTD.TAX
   GRAND.Y.GROSS = GRAND.Y.GROSS + YTD.GROSS
   GRAND.Y.TAX   = GRAND.Y.TAX   + YTD.TAX
* T22154 ^
   MTD.GROSS = 0; MTD.TAX = 0
* T22154 v
   QTD.GROSS = 0; QTD.TAX = 0
   YTD.GROSS = 0; YTD.TAX = 0
* T22154 ^
   RETURN
*
*---- PRINT DIVISION TOTAL VALUES
*
2000*
   PRINT ULINE
   DIV.PRINT = ("DIVISION TOTALS FOR ":ODIV)"L#49"
   V.LINE = ("DIVISION TOTALS FOR ":ODIV)"L#49"
   V.LINE = V.LINE : OCONV(DIV.M.GROSS,"MD2")"R#10": SP3
   V.LINE = V.LINE : OCONV(DIV.M.TAX,"MD2")"R#10": SP3
* T22154 v
   V.LINE = V.LINE : OCONV(DIV.Q.GROSS, "MD2")"R#10":SP3
   V.LINE = V.LINE : OCONV(DIV.Q.TAX, "MD2")"R#10":SP3
   V.LINE = V.LINE : OCONV(DIV.Y.GROSS, "MD2")"R#10":SP3
   V.LINE = V.LINE : OCONV(DIV.Y.TAX, "MD2")"R#10":SP3
* T22154 ^
   PRINT V.LINE
   DIV.M.GROSS = 0; DIV.M.TAX = 0
   MTD.GROSS = 0; MTD.TAX = 0
* T22154 v
   DIV.Q.GROSS = 0; DIV.Q.TAX = 0
   DIV.Y.GROSS = 0; DIV.Y.TAX = 0
   QTD.GROSS   = 0; QTD.TAX   = 0
   YTD.GROSS   = 0; YTD.TAX   = 0
* T22154 ^
   LINE.CNT = 999
   RETURN
*
*---- PRINT GRAND TOTALS
*
5000*
   PRINT ULINE
   V.LINE = "GRAND TOTALS ""L#49"
   V.LINE = V.LINE : OCONV(GRAND.M.GROSS,"MD2")"R#10" : SP3
   V.LINE = V.LINE : OCONV(GRAND.M.TAX,"MD2")"R#10" : SP3
* T22154 v
   V.LINE = V.LINE : OCONV(GRAND.Q.GROSS, "MD2")"R#10" : SP3
   V.LINE = V.LINE : OCONV(GRAND.Q.TAX, "MD2")"R#10" : SP3
   V.LINE = V.LINE : OCONV(GRAND.Y.GROSS, "MD2")"R#10" : SP3
   V.LINE = V.LINE : OCONV(GRAND.Y.TAX, "MD2")"R#10" : SP3
* T22154 ^
   PRINT V.LINE
   LINE.CNT = 99
   GRAND.M.GROSS = 0
   GRAND.M.TAX = 0
* T22154 v
   GRAND.Q.GROSS = 0
   GRAND.Q.TAX   = 0
   GRAND.Y.GROSS = 0
   GRAND.Y.TAX   = 0
* T22154 ^
   RETURN
*
*---- PRINT THE HEADINGS
*
8000*
   PRINT CHAR(12)
   PRINT
   PG.NO=PG.NO + 1
   PRINT HEAD1:PG.NO
   PRINT HEAD2
   PRINT HEAD3:" ":YYYY
*      IF BRK.FLG = "Y" THEN PRINT "DIVISION - " : ODIV "L#3" : "   " : DIV.DESC "L#30"
   PRINT HEAD4
   PRINT
   PRINT HEAD4.5     ;*T22154 <
   PRINT HEAD5
   PRINT HEAD6
* T22154 v
*        LINE.CNT = 8
   LINE.CNT = 9
* T22154 ^
*      IF BRK.FLG = "Y" THEN LINE.CNT = 9 ELSE LINE.CNT = 8
   RETURN
*
*---- CALLS FOR SYSCOM
*
91000*
   ERR.TYPE=1
   CALL SYSCOM(MAT SYSCOM.REC)
   RETURN
93000*
   ERR.TYPE=3
   CALL SYSCOM(MAT SYSCOM.REC)
99999*
END
