      SUBROUTINE JRS.MS.SUM
*COPY>JCS.CPYLIB>COM.JRS
*******************************************************************
* REVISION    - [08.0]
* COPYRIGHT   - 1982 by C.B.A.  (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - JCSBP
* PROGRAM     - JRS.MS.SUM
* BY          - BILAL MOGHRABI, C.B.A.
* DATE        - 06/10/88
* DESCRIPTION - Program produces a Job Miscellaneois Posted report.
*T26556 ajibaly 05/08/2002 * USE REPORT NUMS AND GET.PROG.HEAD
*T28964 wvaughan 08/07/2006 * Extend JOB.QTY field to display 8 numbers.
*ENDDOC
*******************************************************************
*
*-- FILE EQUATES
*
*COPY>PMC.CPYLIB>DEPARTMENT
*COPY>JCS.CPYLIB>JOB
*COPY>JCS.CPYLIB>OPERATION
*COPY>JCS.CPYLIB>JOB.RPT.SET
*COPY>JCS.CPYLIB>JOB.RPT.SUM
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>CHAR
*
*-- INITIALIZATION
*
    PG.NO=0
    LINE.CNT=75
*T26556 v
*   RPT.NO="XXXX"
    HD1 = ""; HD2 = ""
    RPT.NAME = ""
    RPT.DATE = DATE()
    CALL GET.PROG.HEAD(CONO,C.CO.NAME,RPT.NAME,RPT.NO,RPT.DATE,HD1,HD2)
    PRINTER ON
*T26556 ^
    UNKNOWN=STR("?",30)
    SPC = SPACE(1)
    SPC2 = SPACE(2)
    VAR.VARR = ""
    TOT.VARR = "";TOT.VARC = "";TOT.VARS = ""
    LINE.DATE = "";EST.ESTR = "";ACT.ACTR = "";ACT.ACTS = ""
    GRD.ESTR = "";GRD.ACTR = "";GRD.ACTS = "";GRD.VARR = ""
    PRINT.FLG = 1
    HLINE1=SPACE(51):'LAST    EST      ACT      SPOIL'
    HLINE2="DEPT  CCTR  OPER            DESCRIPTION            ENTRY   COST     COST     COST    VAR($)"
    HLINE3="----  ----  ----  -------------------------------  -----  -------  -------  -------  -------"
    IF JRSD.CONS = "Y" THEN
        CONSOL = "CONSOLIDATED"
    END ELSE
        CONSOL = "            "
    END
    HLINE4="#":JOBNO "L#8":SPC:CONSOL"  REPORT NO: ":RPT.NO "L#4":SPACE(3)
    N=SPACE((50 - LEN(C.CO.NAME)) / 2)
    HLINE5=N:C.CO.NAME:N
*
*-- MAIN PROCESSING
*
    JOB.CNT = DCOUNT(JRS.IDS,AM)
    PTR = 0
    FOR I = 1 TO JOB.CNT WHILE PTR = 0
       IF FIELD(JRS.IDS<I>,'&',5) # "O" THEN GOTO 100
       DPNO = FIELD(JRS.IDS<I>,"&",2)
       IF DP.SEL # "ALL" AND DP.SEL # DPNO THEN GOTO 100
       MATREAD JRS.REC FROM JOB.RPT.SET,CONO:JOBNO:"&":JRS.IDS<I> ELSE GOTO 100
       PTR = I
100 NEXT I
    IF PTR = 0 THEN GOTO 99999
    CCNO = FIELD(JRS.IDS<PTR>,"&",3)
    OPNO = FIELD(JRS.IDS<PTR>,"&",4)
    P.DP = DPNO
    P.CC = CCNO
    P.OP = OPNO
    MATREAD DEPT.REC FROM DEPARTMENT,CONO:P.DP ELSE DEPT.DESC=UNKNOWN
    MATREAD OPER.REC FROM OPERATION,CONO:P.OP ELSE OPER.DESC=UNKNOWN
    GOSUB 1000
    PTR = PTR + 1
    FOR I = PTR TO JOB.CNT
       IF FIELD(JRS.IDS<I>,'&',5) # "O" THEN GOTO 200
       DPNO = FIELD(JRS.IDS<I>,"&",2)
       IF DP.SEL # "ALL" AND DP.SEL # DPNO THEN GOTO 200
       MATREAD JRS.REC FROM JOB.RPT.SET,CONO:JOBNO:"&":JRS.IDS<I> ELSE GOTO 200
       CCNO = FIELD(JRS.IDS<I>,"&",3)
       OPNO = FIELD(JRS.IDS<I>,"&",4)
       BEGIN CASE
       CASE P.DP # DPNO
          GOSUB 2000
          P.DP = DPNO
          P.CC = CCNO
          P.OP = OPNO
          PRINT.FLG = 1
          MATREAD DEPT.REC FROM DEPARTMENT,CONO:P.DP ELSE DEPT.DESC=UNKNOWN
          MATREAD OPER.REC FROM OPERATION,CONO:P.OP ELSE OPER.DESC=UNKNOWN
       CASE P.CC # CCNO OR P.OP # OPNO
          P.CC = CCNO
          P.OP = OPNO
          MATREAD OPER.REC FROM OPERATION,CONO:P.OP ELSE OPER.DESC=UNKNOWN
       END CASE
       GOSUB 1000
200*
    NEXT I
    GOSUB 2000
    IF LINE.CNT + 2 >= 55 THEN GOSUB 9000
    PRINT SPACE(58):"-------  -------  -------  -------"
    PLINE =  "*** GRAND TOTALS ***":SPACE(36)
    GRD.ESTR=INT((GRD.ESTR / 100) + .5)
    PLINE=PLINE:SPC2:OCONV(GRD.ESTR,"MD0")"R#7"
    GRD.ACTR=INT((GRD.ACTR / 100) + .5)
    PLINE=PLINE:SPC2:OCONV(GRD.ACTR,"MD0")"R#7"
    GRD.ACTS=INT((GRD.ACTS / 100) + .5)
    PLINE=PLINE:SPC2:OCONV(GRD.ACTS,"MD0")"R#7"
    GRD.VARR=INT((GRD.VARR / 100) + .5)
    PLINE=PLINE:SPC2:OCONV(GRD.VARR,"MD0")"R#7"
    PRINT PLINE
    GOTO 99999
*
*-- PRINT THE VALUES
*
1000*
    IF LINE.CNT + 3 >= 55 THEN GOSUB 9000
    EST.ESTR = EST.ESTR + JRS.E.R.COST
    EST.ESTR = EST.ESTR + JRS.E.C.COST
    EST.ESTR = EST.ESTR + JRS.E.S.COST
    ACT.ACTR = ACT.ACTR + JRS.R.COST
    ACT.ACTR = ACT.ACTR + JRS.C.COST
    ACT.ACTS = ACT.ACTS + JRS.S.COST
    TOT.VARR = JRS.R.COST - JRS.E.R.COST
    TOT.VARC = JRS.C.COST - JRS.E.C.COST
    TOT.VARS = JRS.S.COST - JRS.E.S.COST
    VAR.VARR = VAR.VARR + TOT.VARR
    VAR.VARR = VAR.VARR + TOT.VARC
    VAR.VARR = VAR.VARR + TOT.VARS
    IF PRINT.FLG = 1 THEN
       PRINT.FLG = 0
       PLINE =DEPT.DESC:"  ":P.DP
       PRINT PLINE
       DEPT.LEN=LEN(DEPT.DESC) + LEN(P.DP) + 2
       UNDERLINE.DEPT=STR("-",DEPT.LEN)
       PLINE=UNDERLINE.DEPT
       PRINT PLINE
       LINE.CNT=LINE.CNT + 2
    END
    PLINE=SPACE(6):P.CC"L#4":SPC2:P.OP"L#4":SPC2:OPER.DESC"L#31":SPC2
    BEGIN CASE
    CASE JRS.E.R.COST#"" OR JRS.R.COST#"" OR TOT.VARR#0
       JRS.E.R.COST=INT((JRS.E.R.COST / 100) + .5)
       JRS.R.COST=INT((JRS.R.COST / 100) + .5)
       TOT.VARR=INT((TOT.VARR / 100) + .5)
       IF LINE.DATE = "" THEN
          LINE.DATE = JRS.DATE
       END ELSE
          IF JRS.DATE > LINE.DATE THEN
             LINE.DATE = JRS.DATE
          END
       END
       PLINE = PLINE :OCONV(JRS.DATE, "D2-") "L#5"
       PLINE=PLINE:SPC2:OCONV(JRS.E.R.COST,"MD0Z")"R#7"
       PLINE=PLINE:SPC2:OCONV(JRS.R.COST,"MD0")"R#7"
       PLINE=PLINE:SPACE(9)
       PLINE=PLINE:SPC2:OCONV(TOT.VARR,"MD0")"R#7"
    CASE JRS.E.C.COST#"" OR JRS.C.COST#"" OR TOT.VARC#0
       JRS.E.C.COST=INT((JRS.E.C.COST / 100) + .5)
       JRS.C.COST=INT((JRS.C.COST / 100) + .5)
       TOT.VARC=INT((TOT.VARC / 100) + .5)
       IF LINE.DATE = "" THEN
          LINE.DATE = JRS.C.DATE
       END ELSE
          IF JRS.C.DATE > LINE.DATE THEN
             LINE.DATE = JRS.C.DATE
          END
       END
       PLINE = PLINE :OCONV(JRS.C.DATE, "D2-") "L#5"
       PLINE=PLINE:SPC2:OCONV(JRS.E.C.COST,"MD0Z")"R#7"
       PLINE=PLINE:SPC2:OCONV(JRS.C.COST,"MD0")"R#7"
       PLINE=PLINE:SPACE(9)
       PLINE=PLINE:SPC2:OCONV(TOT.VARC,"MD0")"R#7"
    CASE JRS.E.S.COST#"" OR JRS.S.COST#"" OR TOT.VARS#0
       JRS.E.S.COST=INT((JRS.E.S.COST / 100) + .5)
       JRS.S.COST=INT((JRS.S.COST / 100) + .5)
       TOT.VARS=INT((TOT.VARS / 100) + .5)
       IF LINE.DATE = "" THEN
          LINE.DATE = JRS.DATE
       END ELSE
          IF JRS.DATE > LINE.DATE THEN
             LINE.DATE = JRS.DATE
          END
       END
       PLINE = PLINE :OCONV(JRS.DATE, "D2-") "L#5"
       PLINE=PLINE:SPC2:OCONV(JRS.E.S.COST,"MD0")"R#7"
       PLINE=PLINE:SPACE(9)
       PLINE=PLINE:SPC2:OCONV(JRS.S.COST,"MD0")"R#7"
       PLINE=PLINE:SPC2:OCONV(TOT.VARS,"MD0")"R#7"
    END CASE
    PRINT PLINE
    LINE.CNT=LINE.CNT + 1
    RETURN
*
*-- PRINT ESTIMATED TOTALS
*
2000*
    IF LINE.CNT >= 55 THEN GOSUB 9000
    GRD.ESTR = GRD.ESTR + EST.ESTR
    GRD.ACTR = GRD.ACTR + ACT.ACTR
    GRD.ACTS = GRD.ACTS + ACT.ACTS
    GRD.VARR = GRD.VARR + VAR.VARR
    PRINT SPACE(51):"-----  -------  -------  -------  -------"
    PLINE="** ":DEPT.DESC:" DEPARTMENT TOTAL";PLINE=PLINE"L#49"
    PLINE=PLINE:SPC2:OCONV(LINE.DATE,"D2-")"L#5"
    EST.ESTR=INT((EST.ESTR / 100) + .5)
    PLINE=PLINE:SPC2:OCONV(EST.ESTR,"MD0")"R#7"
    ACT.ACTR=INT((ACT.ACTR / 100) + .5)
    PLINE=PLINE:SPC2:OCONV(ACT.ACTR,"MD0")"R#7"
    ACT.ACTS=INT((ACT.ACTS / 100) + .5)
    PLINE=PLINE:SPC2:OCONV(ACT.ACTS,"MD0")"R#7"
    VAR.VARR=INT((VAR.VARR / 100) + .5)
    PLINE=PLINE:SPC2:OCONV(VAR.VARR,"MD0")"R#7"
    PRINT PLINE
    PRINT;PRINT
    LINE.CNT=LINE.CNT + 4
    IF LINE.CNT >= 55 THEN GOSUB 9000
    VAR.VARR = ""
    EST.ESTR = ""
    ACT.ACTR = ""
    LINE.DATE = ""
    RETURN
*
*-- PRINT THE HEADINGS
*
9000*
    PRINT CHAR(12)
    LINE.CNT=0
    PG.NO=PG.NO + 1
    HLINE6=SPACE(13):OCONV(DATE(),"D2/")"R#8":SPACE(12):"PAGE: ":PG.NO
*T26556 v
*   PRINT HLINE4:HLINE5:HLINE6
*   PRINT JOB.CUST "L#8":SPACE(38):"M I S C E L L A N E O U S   P O S T E D"
    PRINT HD1:PG.NO
    PRINT HD2
    PRINT "Job Number: ":JOBNO "L#8":SPACE(1):CONSOL
    PRINT JOB.CUST "L#8"
*T26556 ^
    PRINT C.CUST.NAME
    *T28964  PRINT JOB.QTY<1,1> "L#7":SPACE(45):"FOR ITEMS THROUGH: ":OCONV(JRSD.DATE,"D2-")
    PRINT JOB.QTY<1,1> "L#8":SPACE(45):"FOR ITEMS THROUGH: ":OCONV(JRSD.DATE,"D2-");*T28964
    PRINT JOB.DESC<1,1> "L#30":SPACE(22):"DATE LAST ENTRY  : ":OCONV(JRSD.MS.DATE,"D2-")
    PRINT "SM: ":C.SALS.NAME "L#27":"SALES CODE: ":JOB.SALES.CODE
    PRINT
    PRINT HLINE1
    PRINT HLINE2
    PRINT HLINE3
*T26556 v
*   LINE.CNT=LINE.CNT + 10
    LINE.CNT=LINE.CNT + 12
*T26556 ^
    RETURN
99999*
    PRINTER OFF
    RETURN
 END
