*COPY>ICS.CPYLIB>FNGD.ORDER.STATS
*COPY>ICS.CPYLIB>INV_RECP_WHSE
*COPY>ICS.CPYLIB>INV.WHSE.REV11
*COPY>ICS.CPYLIB>INV.WHSE
*COPY>ICS.CPYLIB>INV_SERIAL
*COPY>OPS.CPYLIB>PICK.TICKET
*COPY>OPS.CPYLIB>PALLET
*COPY>CPYLIB>CHAR
*
OPEN '','INV.WHSE' TO INV.WHSE ELSE STOP 201
OPEN '','INV.WHSE.OLD' TO INV.WHSE.OLD ELSE STOP 201
OPEN '','INV_RECP_WHSE' TO INV_RECP_WHSE ELSE STOP 201
OPEN '','FNGD.ORDER.STATS.OLD' TO FNGD.ORDER.STATS.OLD ELSE STOP 201
OPEN '','PICK.TICKET.OLD' TO PICK.TICKET.OLD ELSE STOP 201
OPEN '','INV_SERIAL' TO INV_SERIAL ELSE STOP 201
OPEN '','FNGD.RECEIPT.HIST' TO FNGD.RECEIPT.HIST ELSE STOP 201
OPEN '','CONVERSION.ERRORS' TO CONVERSION.ERRORS ELSE STOP 201 
;*
;* update reserves in IRW file
;*
PRINT @(-1)
PRINT @(1,5):'SELECTING FNGD.ORDER.STATS.OLD':@(-4)  
SELECT FNGD.ORDER.STATS.OLD
PRINT @(1,5):'CONVERTING FNGD.ORDER.STATS RECORD':@(-4)
*
DONE = 0 ; CNT=0
ERR.CNT=0 ; ERR=''
LOOP
  ERRMSG=''
  READNEXT FOS.ID ELSE DONE=1
  CONO=FOS.ID[1,3]
UNTIL (DONE) DO 
  CNT+=1
  IF REM(CNT,100)=0 THEN     
    PRINT @(45,5):CNT:@(-4)  
  END                        
  MATREAD FOS.REC FROM FNGD.ORDER.STATS.OLD,FOS.ID THEN
    IWH.ID=OCONV(FOS.ID,"G!2")
    ORD=OCONV(FOS.ID,"G2!1")
    WHSE=OCONV(FOS.ID,"G1!1")
    MATREAD R11.IWH.REC FROM INV.WHSE.OLD,IWH.ID THEN
      READ CHECK.REC FROM INV.WHSE,IWH.ID THEN
        FCNT=DCOUNT(FOS.FI.NO<1>,VM)
        FOR FI=1 TO FCNT
          FNO=FOS.FI.NO<1,FI>
          LOCATE FNO IN R11.IWH.REF.FI<1> SETTING RPOS THEN
            RECP=R11.IWH.PO.LN.FI<1,RPOS>
            PLRS.ID=CONO:RECP
            MATREAD PLRS.REC FROM FNGD.RECEIPT.HIST,PLRS.ID THEN
              LOCATE FNO IN PLRS.FI.NO<1> SETTING JUNK THEN
                IRW.ID=CONO:RECP:"!":WHSE 
                MATREAD IRW.REC FROM INV_RECP_WHSE,IRW.ID THEN
                  IRW.ORDER<1,-1>=ORD
                  IRW.ORSVD.QTY<1,-1>=FOS.FI.QTY<1,FI>
                  MATWRITE IRW.REC ON INV_RECP_WHSE,IRW.ID
                END
              END ELSE
                ERRMSG<1,-1>='MISMATCH BETWEEN FIFO # ON FNGD.RECEIPT.HIST AND FNGD.ORDER.STATS'
              END
            END
          END
        NEXT FI
      END
    END
  END
  IF ERRMSG THEN                      
    ERR.CNT+=1                        
    ERR<ERR.CNT>=ERRMSG               
    ERR=INSERT(ERR,ERR.CNT,1,0,IWH.ID)
  END                                 
REPEAT
;*
;* update reserves in ISTK file
;*
PRINT @(1,5):'SELECTING PICK.TICKET.OLD':@(-4)
SELECT PICK.TICKET.OLD
PRINT @(1,5):'CONVERTING PICK.TICKET RECORD':@(-4)
DONE=0 ; CNT=0
LOOP
  ERRMSG=''
  READNEXT PT.ID ELSE DONE=1
UNTIL DONE DO
  CNT+=1
  IF REM(CNT,100)=0 THEN   
    PRINT @(45,5):CNT:@(-4)
  END                      
  MATREAD PKT.REC FROM PICK.TICKET.OLD,PT.ID THEN
    CONO=PT.ID[1,1]
    PCNT=DCOUNT(PKT.PROD,VM)
    FOR P=1 TO PCNT
      PROD=PKT.PROD<1,P>
      WHSE=PKT.WHSE<1,P>
      IWH.ID=CONO:PROD:"!":WHSE
      MATREAD R11.IWH.REC FROM INV.WHSE.OLD,IWH.ID THEN
        READ CHECK.REC FROM INV.WHSE,IWH.ID THEN
          LCNT=DCOUNT(PKT.RS.LOC,VM)
          FOR L=1 TO LCNT
            LOCATE PKT.FI.NO<1,P,L> IN R11.IWH.REF.FI<1> SETTING RPOS THEN
              RECP=R11.IWH.PO.LN.FI<1,RPOS>
              PLRS.ID=CONO:RECP
              MATREAD PLRS.REC FROM FNGD.RECEIPT.HIST,PLRS.ID THEN
                LOCATE PKT.FI.NO<1,P,L> IN PLRS.FI.NO<1> SETTING JUNK THEN
                  LOC=PKT.RS.LOC<1,P,L>
                  ISTK.ID=CONO:"R":RECP:"!":WHSE:"!":LOC
                  MATREAD ISTK.REC FROM INV_SERIAL,ISTK.ID THEN
                    D=DCOUNT(PT.ID,"-")
                    IF D=1 THEN
                      ISTK.ORDER<1,-1>=OCONV(PT.ID,"G-1")[4,99]
                      ISTK.ORSVD.QTY<1,-1>=PKT.R.QTY<1,P,L>
                    END ELSE
                      ISTK.RELNO<1,-1>=OCONV(PT.ID,"G-2")[4,99]
                      ISTK.RRSVD.QY<1,-1>=PKT.R.QTY<1,P,L>
                    END
                    MATWRITE ISTK.REC ON INV_SERIAL,ISTK.ID
                  END
                END
              END ELSE
                ERRMSG<1,-1>='MISMATCH BETWEEN FIFO # ON FNGD.RECEIPT.HIST AND PICK.TICKET'
              END
            END
          NEXT L
        END
      END
      IF ERRMSG THEN                      
        ERR.CNT+=1                        
        ERR<ERR.CNT>=ERRMSG               
        ERR=INSERT(ERR,ERR.CNT,1,0,IWH.ID)
      END                                 
    NEXT P
  END
REPEAT
GOTO 99999
*
WRITE ERR ON CONVERSION.ERRORS,"FNGD.RSV.CNV"
99999 
END
