*COPY>ICS.CPYLIB>INV.WHSE.LOC.REV11
*COPY>ICS.CPYLIB>INV.WHSE.LOC
*COPY>ICS.CPYLIB>INV_SERIAL
*COPY>ICS.CPYLIB>INV_RECEIPTS
*COPY>ICS.CPYLIB>INV_RECP_WHSE
*COPY>ICS.CPYLIB>INV.WHSE
*COPY>ICS.CPYLIB>INV.WHSE.REV11
*COPY>ICS.CPYLIB>CATEGORY.REV11
*COPY>ICS.CPYLIB>INVENTORY
*COPY>ICS.CPYLIB>INV.CNV
*
DEFFUN CALC.STK.QTY(COST.QTY,MAT INV.CNV.REC,ROND,LN)
*
OPEN '','INV.WHSE.LOC' TO INV.WHSE.LOC ELSE STOP 201
OPEN '','INV.WHSE.LOC.OLD' TO INV.WHSE.LOC.OLD ELSE STOP 201
OPEN '','CONVERSION.ERRORS' TO CONVERSION.ERRORS ELSE STOP 201
OPEN '','INV_SERIAL' TO INV_SERIAL ELSE STOP 201
OPEN '','INV.WHSE' TO INV.WHSE ELSE STOP 201
OPEN '','INV.WHSE.OLD' TO INV.WHSE.OLD ELSE STOP 201
OPEN '','INV_RECEIPTS' TO INV_RECEIPTS ELSE STOP 201
OPEN '','INV_RECP_WHSE' TO INV_RECP_WHSE ELSE STOP 201
OPEN '','INVENTORY' TO INVENTORY ELSE STOP 201
OPEN '','CATEGORY.OLD' TO CATEGORY.OLD ELSE STOP 201
*
PRINT @(-1)
PRINT @(1,5):'SELECTING INV.WHSE.LOC.OLD':@(-4)
*
CMD='SELECT INV.WHSE.LOC.OLD WITH M.LINE="FNGD"'
UDTEXECUTE CMD CAPTURING MSG
*
PRINT @(1,5):'CONVERTING INV.WHSE.LOC RECORD':@(-4)
FIRST.TIME=1
DONE=0; ERR.CNT=0;ERR=''
CNT=0
LOOP
  READNEXT IWLO.ID ELSE DONE=1
  IWH.ID=OCONV(IWLO.ID,"G!2")
  INV.ID=OCONV(IWLO.ID,"G!1")
  PROD=OCONV(IWLO.ID,"G!1")[4,99]
  WHSE=OCONV(IWLO.ID,"G1!1")
  LOC=OCONV(IWLO.ID,"G2!1")
UNTIL (DONE) DO 
  CNT+=1
  IF REM(CNT,100)=0 THEN 
    PRINT @(45,5):CNT:@(-4)  
  END
  ERRMSG=''
  CONO=IWLO.ID[1,3]
  MATREAD INV.REC FROM INVENTORY,INV.ID THEN
    CATG.ID=CONO:INV.LINE
    MATREAD R11.CATG.REC FROM CATEGORY.OLD,CATG.ID THEN
;* do not convert records that belong to palletized item.
      IF R11.CATG.R.S.ID='Y' THEN
*COPY>ICSBP>INV.UM.CNV
        MATREAD R11.IWLO.REC FROM INV.WHSE.LOC.OLD,IWLO.ID THEN
          MATREAD R11.IWH.REC FROM INV.WHSE.OLD,IWH.ID THEN
            MATREAD IWH.REC FROM INV.WHSE,IWH.ID THEN
              SCNT=DCOUNT(R11.IWLO.FI.NO,@VM)
              MAT IWLO.REC=""             
              FOR S=1 TO SCNT
                LOCATE R11.IWLO.FI.NO<1,S> IN R11.IWH.REF.FI<1> SETTING RPOS THEN
                  RECP=R11.IWH.PO.LN.FI<1,RPOS>
                  INVR.ID=CONO:RECP
                  IRW.ID=INVR.ID:"!":WHSE
                  SERIAL="R":RECP:"!":WHSE:"!":LOC
                  ISTK.ID=CONO:SERIAL
                  LOCATE RECP IN IWH.RECP.NO<1> SETTING PPOS THEN
                    INVR.ID=CONO:RECP
                    MATREAD INVR.REC FROM INV_RECEIPTS,INVR.ID THEN
                      INVR.SERIAL.NO<1,-1>=SERIAL
                      MATREAD IRW.REC FROM INV_RECP_WHSE,IRW.ID THEN
                        IRW.SERIAL.NO<1,-1>=SERIAL
                        IRW.ON.HAND+=R11.IWLO.CURR.WT<1,S>
                        GOSUB UPDATE.SERIAL
                        IWLO.SERIAL<1,-1>=SERIAL
                      END
                    END
                  END
                END
                MATWRITE INVR.REC ON INV_RECEIPTS,INVR.ID
                MATWRITE IRW.REC ON INV_RECP_WHSE,IRW.ID
                MATWRITE ISTK.REC ON INV_SERIAL,ISTK.ID
              NEXT S
              IWLO.LOC.ON.HAND=R11.IWLO.LOC.ON.HAND
              IWLO.LOC.INPRCS=R11.IWLO.LOC.INPRCS
              MATWRITE IWLO.REC ON INV.WHSE.LOC,IWLO.ID
            END
          END
        END
      END
    END
  END
  IF ERRMSG THEN
    IWH.ID=OCONV(IWLO.ID,"G!2")
    FIND IWH.ID IN ERR SETTING FLD THEN
      CONVERT @AM TO @VM IN ERRMSG
      ERR<FLD>=ERR<FLD>:@VM:ERRMSG
    END ELSE
      ERR.CNT+=1                             
      ERR<ERR.CNT>=ERRMSG                    
      ERR=INSERT(ERR,ERR.CNT,1,0,IWH.ID) 
    END
  END
REPEAT
WRITE ERR ON CONVERSION.ERRORS,"FNGD.SER.IWLO.CNV"
CALL CONV.RPT("SER.IWLO.CNV")
;*
GOTO 99999
*
**************************************************************************
**** S U B R O U T I N E S ***********************************************
**************************************************************************
*
*
****************
UPDATE.SERIAL: 
****************
*
MAT ISTK.REC=""
ISTK.PROD=PROD
ISTK.PLACE='C'
ISTK.WHSE=WHSE
ISTK.LOC=LOC
ISTK.RECP=RECP
ISTK.RECP.PERIOD=INVR.PERIOD
ISTK.UOM=INV.UNIT<1,3>
ISTK.ENTRY.DATE=INVR.ENT.DATE
ISTK.EDIT.DATE=INVR.POST.DATE
ISTK.POST.DATE=INVR.POST.DATE
ISTK.UNIT.COST=INVR.UNIT.COST
ISTK.LA.USED=R11.IWLO.LA.USED<1,S>
ISTK.ORG.QTY=R11.IWLO.ORIG.WT<1,S>
ISTK.CUR.QTY=R11.IWLO.CURR.WT<1,S>
ISTK.ORG.DIAM=R11.IWLO.ORIG.DIAM<1,S>
ISTK.CUR.DIAM=R11.IWLO.CURR.DIAM<1,S>
ISTK.ORG.STK.QTY=CALC.STK.QTY(ISTK.ORG.QTY,MAT INV.CNV.REC,'','')
ISTK.CUR.STK.QTY=CALC.STK.QTY(ISTK.CUR.QTY,MAT INV.CNV.REC,'','')
ISTK.RSVB.QTY=R11.IWLO.RSV.QTY<1,S>
RETURN
*
99999 
END
