**************************************************************
* REVISION    - [08.1]
* SYSTEM      - PRIMAC
* SOURCE      - GLSBP
* PROGRAM     - GLH.ACTIVITY.RPT
* BY          - ZIAD YAMOUT, COMPUTER BUSINESS ASSOCIATES
* DATE        - 02/16/87
* DESCRIPTION -
* This program produces a General Ledger Activity Report.
* T26493 cmykleb 04/04/2002 * Change pgm to get the rpt # from the proc
*                             and use GET.PROG.HEAD for the heading.
*T28874 lross 04/03/2006 * Get proper CO.COA.BAL data depending upon
*                          year reporting.
*ENDDOC
**************************************************************
*
*---- FILE EQUATES
*
*COPY>CPYLIB>SYSCOM
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>FILE.VARS
*COPY>PMC.CPYLIB>COMPANY
*COPY>PMC.CPYLIB>COA
*COPY>GLS.CPYLIB>COA.BAL
*COPY>GLS.CPYLIB>GLM
*
*---- SETUP FOR SYSTEM ERROR MESSAGES
*
   SYS.TYPE = 1
   CALL SYSCOM(MAT SYSCOM.REC)
*
*---- PROCREAD
*
   PROCREAD ID ELSE ERRMSG = "MUST BE RUN FROM PROC";GOSUB 91000;GOTO 99999
   CONO = ID<1>
   CO.NAME = ID<2>
   BEG.YR = ID<3>
   BEG.PER = ID<4>
   END.PER = ID<5>
   LEVEL = ID<6>
*
*---- DIMENSION RECORDS
*
*
*---- OPEN FILES
*
   OPEN "","COMPANY" TO COMPANY ELSE ERRMSG = "COMPANY FILE MISSING";GOTO 93000
   OPEN "","CONTROL" TO CONTROL ELSE ERRMSG = "CONTROL FILE MISSING";GOTO 93000
   OPEN "","GLH" TO GLH ELSE ERRMSG = "GLH FILE MISSING";GOTO 93000
   OPEN "","COA" TO COA ELSE ERRMSG = "COA FILE MISSING";GOTO 93000
*T28874 v
   IF BEG.PER[1,4] < BEG.YR[1,4] THEN FVAR = BEG.PER ELSE FVAR = ''
   IF FVAR = '' THEN
     OPEN "","CO.COA.BAL" TO CO.COA.BAL ELSE ERRMSG = "CO.COA.BAL FILE MISSING";GOTO 93000
   END ELSE
     OPEN "","CO.COA":FVAR TO CO.COA.BAL ELSE ERRMSG = "CO.COA":FVAR:" FILE MISSING";GOTO 93000
   END
*T28874 ^
*
*---- READ COMPANY FILE
*
   MATREAD COMP.REC FROM COMPANY, CONO ELSE
      ERRMSG = "CANNOT LOCATE COMPANY ":CONO; GOTO 93000
   END
*
*---- MAIN PROCESSING
*
   READNEXT GLH.ID ELSE GOTO 99999
   MATREAD GLM.REC FROM GLH, GLH.ID ELSE MAT GLM.REC = ""
   ERRMSG = ""
   SP = SPACE(1)
   D.LINE = SPACE(117) : STR("-",14)
   A.LINE = SPACE(117) : STR("*",14)
   T.LINE = SPACE(117) : STR("=",14)
   H.O.B = " OPEN BALANCE"
   H.E.B = " ENDING BALANCE"
   DIV.TOTAL = 0
   DEPT.TOTAL = 0
   CCTR.TOTAL = 0
   ACCT.TOTAL = 0
   STRUC = CO.ACCT.MASK:STR("#",15 - LEN(CO.ACCT.MASK))
   ACCT.LEN = LEN(CO.ACCT.PIC)
   DATA = 1
   PRINTER ON
*T26493 v
*    HEAD = "DATE & TIME - 'T'":SPACE(6)
*    K = SPACE((50 - LEN(CO.NAME)) / 2)
*    HEAD = HEAD:K:CO.NAME:K
*    HEAD = HEAD:SPACE(30):"PAGE - 'PL'"
*    HEAD = HEAD:SPACE(40):"GLS HISTORY ACTIVITY FOR PERIODS ":BEG.PER:" THRU ":END.PER:"'LL'"
   CONO.NAME = ""
   REPORT.NAME = ""
   REPORT.NUMBER = ID<2>
   HD1 = "" ; HD2 = ""
   CALL GET.PROG.HEAD(CONO,CONO.NAME,REPORT.NAME,REPORT.NUMBER,"",HD1,HD2)
   HD1 = HD1 : " 'PL'"
   HD3 = SPACE(60):"FOR PERIODS ":BEG.PER:" THRU ":END.PER:"'LL'"
   HEAD = HD1 : HD2 : HD3
*T26493 ^
   P.LINE = "ACCOUNT NUMBER         DESCRIPTION":SPACE(8):"DV DP CTR PERIOD":SPACE(10):"ENTRY DESCRIPTION":SPACE(11):"TR-DATE SRC  REFER#      AMOUNT"
   HEAD = HEAD : P.LINE : " 'L'"
   P.LINE = STR("-",15) : SP
   P.LINE = P.LINE : STR("-",25) : SP
   P.LINE = P.LINE : "-- -- --- ------ "
   P.LINE = P.LINE : STR("-",35) : SP
   P.LINE = P.LINE : STR("-",8) : SP
   P.LINE = P.LINE : STR("-",3) : SP
   P.LINE = P.LINE : STR("-",8) : SP
   P.LINE = P.LINE : STR("-",14)
   HEAD = HEAD:P.LINE
   HEADING HEAD
   HEAD = ""
   BEGIN CASE
      CASE LEVEL = 0
         ACCT = GLH.ID[11,ACCT.LEN]
         DIV = ""
         DEPT = ""
         CCTR = ""
      CASE LEVEL = 1
         ACCT = GLH.ID[11,ACCT.LEN]
         DIV = GLH.ID[4,2]
         DEPT = ""
         CCTR = ""
      CASE LEVEL = 2
         ACCT = GLH.ID[11,ACCT.LEN]
         DIV = GLH.ID[4,2]
         DEPT = GLH.ID[6,2]
         CCTR = ""
      CASE LEVEL = 3
         ACCT = GLH.ID[11,ACCT.LEN]
         DIV = GLH.ID[4,2]
         DEPT = GLH.ID[6,2]
         CCTR = GLH.ID[8,3]
   END CASE
   PREV.ACCT = ACCT
   PREV.DIV = DIV
   PREV.DEPT = DEPT
   PREV.CCTR = CCTR
   PREV.MON = GLM.MON
   MATREAD COA.REC FROM COA, CONO:ACCT ELSE COA.DESC = ""
   MATREAD CB.REC FROM CO.COA.BAL, CONO:ACCT ELSE MAT CB.REC = ""
*T28874 v
*  IF GLM.MON < BEG.YR THEN
*     MON.TOTAL = CB.REC(GLM.MON[5,2]+CB.LYR)
*  END ELSE
      MON.TOTAL = CB.REC(GLM.MON[5,2]+CB.OPN)
*  END
   P.LINE = PREV.ACCT STRUC:SP:COA.DESC "L#25":SPACE(11):GLM.MON "L#6"
   PRINT P.LINE:H.O.B:SPACE(46):OCONV(MON.TOTAL,"MD2,-") "R#14"
   LOOP
      BEGIN CASE
         CASE ACCT <> PREV.ACCT
            BEGIN CASE
               CASE LEVEL > 2
                  IF CCTR.TOTAL <> DEPT.TOTAL THEN
                     PRINT D.LINE
                     P.LINE = SPACE(48):PREV.CCTR "L#3":SPACE(66)
                     PRINT P.LINE:OCONV(CCTR.TOTAL,"MD2,-") "R#14"
                     PREV.CCTR = ""
                  END
                  IF DEPT.TOTAL <> DIV.TOTAL THEN
                     IF PREV.CCTR # "" THEN PRINT D.LINE
                     P.LINE = SPACE(45):PREV.DEPT "L#2":SP:PREV.CCTR "L#3":SPACE(66)
                     PRINT P.LINE:OCONV(DEPT.TOTAL,"MD2,-") "R#14"
                     PREV.DEPT = ""; PREV.CCTR = ""
                  END
                  IF DIV.TOTAL <> ACCT.TOTAL THEN
                     IF PREV.CCTR # "" THEN PRINT D.LINE
                     P.LINE = SPACE(42):PREV.DIV "L#2":SP:PREV.DEPT "L#2":SP:PREV.CCTR "L#3"
                     PRINT P.LINE:SPACE(66):OCONV(DIV.TOTAL,"MD2,-") "R#14"
                     PREV.DIV = ""; PREV.DEPT = ""; PREV.CCTR = ""
                  END
                  PRINT T.LINE
                  P.LINE = PREV.ACCT STRUC:SP:COA.DESC "L#25":SP:PREV.DIV "L#2":SP
                  P.LINE = P.LINE:PREV.DEPT "L#2":SP:PREV.CCTR "L#3"
                  PRINT P.LINE:SPACE(66):OCONV(ACCT.TOTAL,"MD2,-") "R#14"
               CASE LEVEL > 1
                  IF DEPT.TOTAL <> DIV.TOTAL THEN
                     PRINT D.LINE
                     P.LINE = SPACE(45):PREV.DEPT "L#2":SPACE(70)
                     PRINT P.LINE:OCONV(DEPT.TOTAL,"MD2,-") "R#14"
                     PREV.DEPT = ""
                  END
                  IF DIV.TOTAL <> ACCT.TOTAL THEN
                     IF PREV.DEPT # "" THEN PRINT D.LINE
                     P.LINE = SPACE(42):PREV.DIV "L#2":SP:PREV.DEPT "L#2"
                     PRINT P.LINE:SPACE(70):OCONV(DIV.TOTAL,"MD2,-") "R#14"
                     PREV.DIV = ""; PREV.DEPT = ""
                  END
                  PRINT T.LINE
                  P.LINE = PREV.ACCT STRUC:SP:COA.DESC "L#25":SP:PREV.DIV "L#2":SP
                  PRINT P.LINE:PREV.DEPT "L#2":SPACE(70):OCONV(ACCT.TOTAL,"MD2,-") "R#14"
               CASE LEVEL > 0
                  IF DIV.TOTAL <> ACCT.TOTAL THEN
                     PRINT D.LINE
                     P.LINE = SPACE(42):PREV.DIV "L#2":SPACE(73)
                     PRINT P.LINE:OCONV(DIV.TOTAL,"MD2,-") "R#14"
                     PREV.DIV = ""
                  END
                  PRINT T.LINE
                  P.LINE = PREV.ACCT STRUC:SP:COA.DESC "L#25":SP:PREV.DIV "L#2"
                  PRINT P.LINE:SPACE(73):OCONV(ACCT.TOTAL,"MD2,-") "R#14"
               CASE 1
                  PRINT T.LINE
                  P.LINE = PREV.ACCT STRUC:SP:COA.DESC "L#25"
                  PRINT P.LINE:SPACE(76):OCONV(ACCT.TOTAL,"MD2,-") "R#14"
            END CASE
            P.LINE = PREV.ACCT STRUC:SP:COA.DESC "L#25":SPACE(11):PREV.MON "L#6"
            PRINT P.LINE:H.E.B:SPACE(44):OCONV(MON.TOTAL,"MD2,-") "R#14"
            IF NUM(ACCT) THEN
               ACCT.TOTAL = 0; DIV.TOTAL = 0; DEPT.TOTAL = 0; CCTR.TOTAL = 0
               PREV.ACCT = ACCT; PREV.DIV = DIV; PREV.DEPT = DEPT
               PREV.CCTR = CCTR; PREV.MON = GLM.MON
               MATREAD COA.REC FROM COA,CONO:ACCT ELSE COA.DESC = ""
               MATREAD CB.REC FROM CO.COA.BAL, CONO:ACCT ELSE MAT CB.REC = ""
*T28874 v
*              IF GLM.MON < BEG.YR THEN
*                 MON.TOTAL = CB.REC(GLM.MON[5,2]+CB.LYR)
*              END ELSE
                  MON.TOTAL = CB.REC(GLM.MON[5,2]+CB.OPN)
*              END
               PRINT
               P.LINE = PREV.ACCT STRUC:SP:COA.DESC "L#25":SPACE(11):GLM.MON "L#6"
               PRINT P.LINE:H.O.B:SPACE(46):OCONV(MON.TOTAL,"MD2,-") "R#14"
            END
         CASE PREV.MON <> GLM.MON
            BEGIN CASE
               CASE LEVEL > 2
                  IF CCTR.TOTAL <> DEPT.TOTAL THEN
                     PRINT D.LINE
                     P.LINE = SPACE(48):PREV.CCTR "L#3":SPACE(66)
                     PRINT P.LINE:OCONV(CCTR.TOTAL,"MD2,-") "R#14"
                     PREV.CCTR = ""
                  END
                  IF DEPT.TOTAL <> DIV.TOTAL THEN
                     IF PREV.CCTR # "" THEN PRINT D.LINE
                     P.LINE = SPACE(45):PREV.DEPT "L#2":SP:PREV.CCTR "L#3":SPACE(66)
                     PRINT P.LINE:OCONV(DEPT.TOTAL,"MD2,-") "R#14"
                     PREV.DEPT = ""; PREV.CCTR = ""
                  END
                  IF DIV.TOTAL <> MON.TOTAL THEN
                     IF PREV.CCTR # "" THEN PRINT D.LINE
                     P.LINE = SPACE(42):PREV.DIV "L#2":SP:PREV.DEPT "L#2":SP:PREV.CCTR "L#3"
                     PRINT P.LINE:SPACE(66):OCONV(DIV.TOTAL,"MD2,-") "R#14"
                     PREV.DIV = ""; PREV.DEPT = ""; PREV.CCTR = ""
                  END
                  PRINT A.LINE
                  P.LINE = SPACE(42):PREV.DIV "L#2":SP:PREV.DEPT "L#2":SP:PREV.CCTR "L#3"
                  P.LINE = P.LINE:SP:PREV.MON "L#6":H.E.B:SPACE(44)
                  PRINT P.LINE:OCONV(MON.TOTAL,"MD2,-") "R#14"
               CASE LEVEL > 1
                  IF DEPT.TOTAL <> DIV.TOTAL THEN
                     PRINT D.LINE
                     P.LINE = SPACE(45):PREV.DEPT "L#2":SPACE(70)
                     PRINT P.LINE:OCONV(DEPT.TOTAL,"MD2,-") "R#14"
                     PREV.DEPT = ""
                  END
                  IF DIV.TOTAL <> MON.TOTAL THEN
                     IF PREV.DEPT # "" THEN PRINT D.LINE
                     P.LINE = SPACE(42):PREV.DIV "L#2":SP:PREV.DEPT "L#2"
                     PRINT P.LINE:SPACE(70):OCONV(DIV.TOTAL,"MD2,-") "R#14"
                     PREV.DIV = ""; PREV.DEPT = ""
                  END
                  PRINT A.LINE
                  P.LINE = SPACE(42):PREV.DIV "L#2":SP:PREV.DEPT "L#2":SPACE(5)
                  P.LINE = P.LINE:PREV.MON "L#6":H.E.B:SPACE(44)
                  PRINT P.LINE:OCONV(MON.TOTAL,"MD2,-") "R#14"
               CASE LEVEL > 0
                  IF DIV.TOTAL <> MON.TOTAL THEN
                     PRINT D.LINE
                     P.LINE = SPACE(42):PREV.DIV "L#2":SPACE(73)
                     PRINT P.LINE:OCONV(DIV.TOTAL,"MD2,-") "R#14"
                     PREV.DIV = ""
                  END
                  PRINT A.LINE
                  P.LINE = SPACE(42):PREV.DIV "L#2":SPACE(8)
                  P.LINE = P.LINE:PREV.MON "L#6":H.E.B:SPACE(44)
                  PRINT P.LINE:OCONV(MON.TOTAL,"MD2,-") "R#14"
               CASE 1
                  PRINT A.LINE
                  P.LINE = SPACE(52):PREV.MON "L#6":H.E.B:SPACE(44)
                  PRINT P.LINE:OCONV(MON.TOTAL,"MD2,-") "R#14"
            END CASE
            DIV.TOTAL = 0; DEPT.TOTAL = 0; CCTR.TOTAL = 0
            PREV.MON = GLM.MON; PREV.DIV = DIV; PREV.DEPT = DEPT; PREV.CCTR = CCTR
*T28874 v
*           IF GLM.MON < BEG.YR THEN
*              MON.TOTAL = CB.REC(GLM.MON[5,2]+CB.LYR)
*           END ELSE
               MON.TOTAL = CB.REC(GLM.MON[5,2]+CB.OPN)
*           END
            PRINT
         CASE DIV <> PREV.DIV
            PRINT D.LINE
            BEGIN CASE
               CASE LEVEL > 2
                  IF CCTR.TOTAL <> DEPT.TOTAL THEN
                     P.LINE = SPACE(48):PREV.CCTR "L#3":SPACE(66)
                     PRINT P.LINE:OCONV(CCTR.TOTAL,"MD2,-") "R#14"
                     PREV.CCTR = ""
                  END
                  IF DEPT.TOTAL <> DIV.TOTAL THEN
                     P.LINE = SPACE(45):PREV.DEPT "L#2":SP:PREV.CCTR "L#3":SPACE(66)
                     PRINT P.LINE:OCONV(DEPT.TOTAL,"MD2,-") "R#14"
                     PREV.DEPT = ""; PREV.CCTR = ""
                  END
                  P.LINE = SPACE(42):PREV.DIV "L#2":SP:PREV.DEPT "L#2":SP:PREV.CCTR "L#3"
                  PRINT P.LINE:SPACE(66):OCONV(DIV.TOTAL,"MD2,-") "R#14"
               CASE LEVEL > 1
                  IF DEPT.TOTAL <> DIV.TOTAL THEN
                     P.LINE = SPACE(45):PREV.DEPT "L#2":SPACE(70)
                     PRINT P.LINE:OCONV(DEPT.TOTAL,"MD2,-") "R#14"
                     PREV.DEPT = ""
                  END
                  P.LINE = SPACE(42):PREV.DIV "L#2":SP:PREV.DEPT "L#2"
                  PRINT P.LINE:SPACE(70):OCONV(DIV.TOTAL,"MD2,-") "R#14"
               CASE 1
                  P.LINE = SPACE(42):PREV.DIV "L#2"
                  PRINT P.LINE:SPACE(73):OCONV(DIV.TOTAL,"MD2,-") "R#14"
            END CASE
            DIV.TOTAL = 0; DEPT.TOTAL = 0; CCTR.TOTAL = 0
            PREV.DIV = DIV; PREV.DEPT = DEPT; PREV.CCTR = CCTR
            PRINT
         CASE DEPT <> PREV.DEPT
            PRINT D.LINE
            BEGIN CASE
               CASE LEVEL > 2
                  IF CCTR.TOTAL <> DEPT.TOTAL THEN
                     P.LINE = SPACE(48):PREV.CCTR "L#3":SPACE(66)
                     PRINT P.LINE:OCONV(CCTR.TOTAL,"MD2,-") "R#14"
                     PREV.CCTR = ""
                  END
                  P.LINE = SPACE(45):PREV.DEPT "L#2":SP:PREV.CCTR "L#3":SPACE(66)
                  PRINT P.LINE:OCONV(DEPT.TOTAL,"MD2,-") "R#14"
               CASE 1
                  PRINT D.LINE
                  P.LINE = SPACE(45):PREV.DEPT "L#2":SPACE(70)
                  PRINT P.LINE:OCONV(DEPT.TOTAL,"MD2,-") "R#14"
            END CASE
            DEPT.TOTAL = 0; CCTR.TOTAL = 0
            PREV.DEPT = DEPT
            PREV.CCTR = CCTR; PREV.MON = GLM.MON
            PRINT
         CASE CCTR <> PREV.CCTR
            PRINT D.LINE
            P.LINE = SPACE(48):PREV.CCTR "L#3":SPACE(66)
            PRINT P.LINE:OCONV(CCTR.TOTAL,"MD2,-") "R#14"
            CCTR.TOTAL = 0; PREV.CCTR = CCTR; PREV.MON = GLM.MON
            PRINT
      END CASE
   WHILE DATA DO
      ACT = GLH.ID[11,ACCT.LEN]
      DV = GLH.ID[4,2]
      DP = GLH.ID[6,2]
      CTR = GLH.ID[8,3]
      ACCT.TOTAL = ACCT.TOTAL + GLM.AMT
      MON.TOTAL = MON.TOTAL + GLM.AMT
      CCTR.TOTAL = CCTR.TOTAL + GLM.AMT
      DEPT.TOTAL = DEPT.TOTAL + GLM.AMT
      DIV.TOTAL = DIV.TOTAL + GLM.AMT
      P.LINE = ACT STRUC:SP:COA.DESC "L#25":SP:DV "L#2":SP:DP "L#2":SP
      P.LINE = P.LINE:CTR "L#3":SP:GLM.MON "L#6":SP:GLM.DESC "L#35":SP
      P.LINE = P.LINE:OCONV(GLM.DATE,"D2/") "L#8":SP:GLM.SRC "L#3":SP
      PRINT P.LINE :GLM.REF "L#8":SP:OCONV(GLM.AMT,"MD2,-") "R#14"
      READNEXT GLH.ID ELSE
         GLH.ID = STR("X",25)
         DATA = 0
      END
      BEGIN CASE
         CASE LEVEL = 0
            ACCT = GLH.ID[11,ACCT.LEN]
            DIV = ""
            DEPT = ""
            CCTR = ""
         CASE LEVEL = 1
            ACCT = GLH.ID[11,ACCT.LEN]
            DIV = GLH.ID[4,2]
            DEPT = ""
            CCTR = ""
         CASE LEVEL = 2
            ACCT = GLH.ID[11,ACCT.LEN]
            DIV = GLH.ID[4,2]
            DEPT = GLH.ID[6,2]
            CCTR = ""
         CASE LEVEL = 3
            ACCT = GLH.ID[11,ACCT.LEN]
            DIV = GLH.ID[4,2]
            DEPT = GLH.ID[6,2]
            CCTR = GLH.ID[8,3]
      END CASE
      MATREAD GLM.REC FROM GLH,GLH.ID ELSE MAT GLM.REC = ""
   REPEAT
   PRINTER OFF
   GOTO 99999
*
*---- CALLS FOR SYSCOM
*
91000*
   PRINTER OFF
   ERR.TYPE = 1
   CALL SYSCOM(MAT SYSCOM.REC)
   PRINTER ON
   RETURN
93000*
   PRINTER OFF
   ERR.TYPE = 3
   CALL SYSCOM(MAT SYSCOM.REC)
99999*
END
