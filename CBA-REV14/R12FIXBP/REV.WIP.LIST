*COPY>CPYLIB>COM1
*COPY>JCS.CPYLIB>COM.JCS.LINK
*COPY>ICS.CPYLIB>COM.INV.MAIN  
*COPY>ICS.CPYLIB>COM.INV.SERIAL
*COPY>JCS.CPYLIB>COM.INV.STATS 
*COPY>PMC.CPYLIB>COM.CUST
*COPY>OPS.CPYLIB>COM.ORDER
*********************************************************************
* REVISION    - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - JCSBP
* PROGRAM     - POST.INVOICE
* AUTHOR      - NICK AMENDOLA, COMPUTER BUSINESS ASSOCIATES
* DATE        - 10/22/85
* DESCRIPTION
* This program will process editted invoices, credit memos and debit memos.
* The following files are updated:
* JOB             - invoice data appended and WIP reversed.
* CUSTOMER        - A/R data for bill-to customer.
* CUSTOMER        - job balance data for job customer.
* OPEN.RECV       - A/R data if accounts receivable system is present.
* JOB.SALES.STATS - sales statistics if sales analysis system is present.
* COMMISSION      - accrued commissions by salesman
* C45770 lross 06/06/2006 - Reverse Job WIP from a SAVED LIST.
*ENDDOC
*********************************************************************
*
*---- COPY STATEMENTS
*
*COPY>JCS.CPYLIB>JOB
*COPY>OPS.CPYLIB>JOB.FNGD.STATS
*COPY>CPYLIB>FILE.VARS
*COPY>PMC.CPYLIB>TAX
*COPY>PMC.CPYLIB>TAX.BAL
*COPY>CPYLIB>EDIT.COM.DRIVER
*COPY>PMC.CPYLIB>INVOICE.CODE
*COPY>JCS.CPYLIB>DAILY.INVOICE
*COPY>JCS.CPYLIB>INVOICE
*COPY>PMC.CPYLIB>COMPANY
*COPY>PMC.CPYLIB>CUSTOMER
*COPY>PMC.CPYLIB>JOB.SALES.STATS
*COPY>PMC.CPYLIB>INVOICE.SALES.STATS
*COPY>ICS.CPYLIB>INV.JOB.STATS
*COPY>ARS.CPYLIB>OPEN.RECV
*COPY>PMC.CPYLIB>COST.CNTR
*COPY>PMC.CPYLIB>SHIP.VIA
*COPY>CPYLIB>SYSCOM
*COPY>CPYLIB>CHAR
*COPY>JCS.CPYLIB>COMMISSION
DIM SAVE.REC(60)
*T27770 v
DIM HOLD.IVC.REC(IVC.REC.SIZE)
DIM HOLD.DI.REC(DI.REC.SIZE)
MAT HOLD.IVC.REC = ''
MAT HOLD.DI.REC = ''
MAT IVC.REC = ''
*T27770 ^
*
*--- SETUP SYSTEM ERROR MESSAGES
*
SYS.TYPE = 1
CALL SYSCOM(MAT SYSCOM.REC)
*
***** T23278 v
*
***** GET DIV CODE FROM PROC
*
PROCREAD KEY ELSE
   ERRMSG = "MUST BE RUN FROM A PROC"
   GOTO 93000
END
PROMPT''
DIV.CODE = KEY<3>
*
***** T23278 ^
*--- OPEN ALL FILES
*
OPEN '','PMC.SCREENS' TO M.SCREENS ELSE ERRMSG="PMC.SCREENS FILE IS MISSING"; GOTO 93000
OPEN '','CONTROL' TO CONTROL ELSE ERRMSG="CONTROL FILE IS MISSING"; GOTO 93000
OPEN '','JOB' TO JOB ELSE ERRMSG="JOB FILE IS MISSING"; GOTO 93000
OPEN '','INVOICE' TO INVOICE ELSE ERRMSG="INVOICE FILE IS MISSING"; GOTO 93000
OPEN '','INVOICE.CODE' TO INVOICE.CODE ELSE ERRMSG="INVOICE.CODE FILE IS MISSING"; GOTO 93000
OPEN '','DAILY.INVOICE' TO DAILY.INVOICE ELSE ERRMSG="DAILY.INVOICE FILE IS MISSING"; GOTO 93000
OPEN '','COMPANY' TO COMPANY ELSE ERRMSG="COMPANY FILE IS MISSING"; GOTO 93000
OPEN '','CUSTOMER' TO CUSTOMER ELSE ERRMSG="CUSTOMER FILE IS MISSING"; GOTO 93000
OPEN '','COST.CNTR' TO COST.CNTR ELSE ERRMSG="COST.CNTR FILE IS MISSING"; GOTO 93000
OPEN '','INVENTORY' TO INVENTORY ELSE ERRMSG="INVENTORY FILE IS MISSING"; GOTO 93000
OPEN '','CATEGORY' TO CATEGORY ELSE ERRMSG="CATEGORY FILE IS MISSING"; GOTO 93000
OPEN '','INV.WHSE' TO INV.WHSE ELSE ERRMSG="INV.WHSE FILE IS MISSING"; GOTO 93000
OPEN '','INV.WHSE.LOC' TO INV.WHSE.LOC ELSE ERRMSG="INV.WHSE.LOC FILE IS MISSING"; GOTO 93000
OPEN '','INV.STATS' TO INV.STATS ELSE ERRMSG="INV.STATS FILE IS MISSING"; GOTO 93000
OPEN '','INV.JOB.STATS' TO INV.JOB.STATS ELSE ERRMSG="INV.JOB.STATS FILE IS MISSING"; GOTO 93000
OPEN '','JOB.TIME' TO JOB.TIME ELSE ERRMSG="JOB.TIME FILE IS MISSING"; GOTO 93000
OPEN '','JOB.MATL' TO JOB.MATL ELSE ERRMSG="JOB.MATL FILE IS MISSING"; GOTO 93000
OPEN '','JOB.OSP' TO JOB.OSP ELSE ERRMSG="JOB.OSP FILE IS MISSING"; GOTO 93000
OPEN '','JOB.SHIP' TO JOB.SHIP ELSE ERRMSG="JOB.SHIP FILE IS MISSING"; GOTO 93000
OPEN '','JOB.MISC' TO JOB.MISC ELSE ERRMSG="JOB.MISC FILE IS MISSING"; GOTO 93000
OPEN '','COST.CNTR.WIP' TO COST.CNTR.WIP ELSE ERRMSG="COST.CNTR.WIP FILE IS MISSING"; GOTO 93000
OPEN '','TAX' TO TAX ELSE ERRMSG="TAX FILE IS MISSING"; GOTO 93000
OPEN '','TAX.BAL' TO TAX.BAL ELSE ERRMSG="TAX.BAL FILE IS MISSING"; GOTO 93000
OPEN '','SHIP.VIA' TO SHIP.VIA ELSE ERRMSG="SHIP.VIA FILE IS MISSING"; GOTO 93000
*
*---INITIALIZATION
*
MAT EDIT.COM.DRIVER = ""
POSTING.MON = ""
GEN.DIV = "00"
GEN.DEPT = "00"
GEN.CCTR = "000"
ISS.KEY = ""
TODAY = DATE()
ALL.TYPE = "LB"
ALL.TYPE<1,2> = "MT"
ALL.TYPE<1,3> = "OS"
ALL.TYPE<1,4> = "SP"
ALL.TYPE<1,5> = "MS"
CUST.STATE=""
*
*--- SETUP VALUES FROM PMC.SCREENS
*
CRT @(-1)
CRT @(0,5):CL:'Enter Posting Period YYYYMM ':; INPUT POSTING.MON:
IF POSTING.MON = 'END' THEN GOTO 999999
*
CURR.MON = POSTING.MON
*
*--- MAIN PROCESSING
*
READNEXT ID ELSE GOTO 999999
*DEBUG
CONO = ID[1,3]
INVOICE.SFX = ''
*T27770 v
FINAL.INVOICE = 0
IF INVOICE.SFX = '' THEN FINAL.INVOICE = 1
*T27770 ^
MATREAD COMP.REC FROM COMPANY, CONO ELSE GOTO 999999
IF CO.OPS = "Y" THEN
   OPEN "","JOB.FNGD.STATS" TO JOB.FNGD.STATS ELSE
      ERRMSG = "Cannot locate the JOB.FNGD.STATS file"
      GOTO 93000
   END
   OPS.ONFILE = 1
END ELSE
   OPS.ONFILE = 0
END
*
IF CO.ARS = "Y" THEN OPEN "","OPEN.RECV" TO OPEN.RECV ELSE ERRMSG="OPEN.RECV FILE IS MISSING"; GOTO 93000
IF CO.SAS = "Y" THEN
   OPEN '','JOB.SALES.STATS' TO JOB.SALES.STATS ELSE
      ERRMSG="JOB.SALES.STATS FILE IS MISSING"
      GOTO 93000
   END
   OPEN '','INVOICE.SALES.STATS' TO INVOICE.SALES.STATS ELSE
      ERRMSG="INVOICE.SALES.STATS FILE IS MISSING"
      GOTO 93000
   END
END
IF CO.COMMISSION = "Y" THEN OPEN '','COMMISSION' TO COMMISSION ELSE ERRMSG="COMMISSION FILE IS MISSING"; GOTO 93000
GOSUB 1000
*
*---- CONTINUE
*
DATA = 1
LOOP
   READNEXT ID ELSE DATA = 0
WHILE DATA DO
   GOSUB 1000
REPEAT
GOTO 999999
*
*--- UPDATE ROUTINE
*
1000 *
MULTI.JOB.NOS = ''
MULTI.JOB.DIV = ''
MAT SAVE.REC = ""
MATREAD JOB.REC FROM JOB, ID ELSE
   ERRMSG='Cannot read JOB ':ID; GOSUB 91000; GOTO 1900
END
IF JOB.SUBS # "" THEN MULTI.JOB = 1 ELSE MULTI.JOB = 0
IF OPS.ONFILE THEN
   MATREAD JFS.REC FROM JOB.FNGD.STATS, ID THEN
      IF JFS.PROD # "" THEN
         ERRMSG = "Cannot Invoice a Finished Goods JOB"
         GOSUB 91000; GOTO 1900
      END
   END
END
WIP.TYPE = "ALL"
WIP.PERCENT = 10000
WIP.DATE = "ALL"
MULTI.JOB.NOS = ID[4,99]
IF MULTI.JOB THEN
   MULTI.JOB.NOS := VM:JOB.SUBS
END
*
FOR J = 1 TO DCOUNT(MULTI.JOB.NOS,VM)
   CHARGE.JOB = MULTI.JOB.NOS<1,J>
   MATREADU JOB.REC FROM JOB,CONO:CHARGE.JOB THEN
      JOB.WIP<1,1> = JOB.WIP<1,1> + 1
      IF JOB.WIP<1,4> = "" OR JOB.WIP<1,4> > POSTING.MON THEN
         JOB.WIP<1,4> = POSTING.MON
      END
      IF JOB.WIP<1,5> < POSTING.MON THEN
         JOB.WIP<1,5> = POSTING.MON
      END
      CALL REVERSE.JOB.WIP(CONO,CHARGE.JOB,WIP.TYPE,WIP.PERCENT,WIP.DATE,POSTING.MON,CURR.MON)
*DEBUG
      IF SUM(JOB.ALOC.QTY) # 0 AND CO.POS = 'Y' THEN
         CALL CLEAR.JOB.ALLOC(CONO,CHARGE.JOB) ;*T25900
      END
      RESV.ACTION = "D"; DPTR = 0
      CALL JOB.RESV.SUB(CONO,RESV.ACTION,DPTR,CHARGE.JOB)
*DEBUG
      IF RESV.ACTION # "D" AND RESV.ACTION # "" THEN
         ERRMSG=RESV.ACTION; GOSUB 91000; GOTO 1900
      END
      MCNT = COUNT(JOB.RESV.MATL,VM) + (JOB.RESV.MATL # "")
      FOR M = MCNT TO 1 STEP -1
         IF JOB.RESV.QTY<1,M> + JOB.ALOC.QTY<1,M> + JOB.USED.QTY<1,M> = 0 THEN
            JSTAT.ID = JOB.RESV.MATL<1,M>:"!":JOB.RESV.WHSE<1,M>:"!":CHARGE.JOB
            MATREAD INV.JS.REC FROM INV.JOB.STATS, CONO : JSTAT.ID ELSE
               JOB.RESV.MATL = DELETE(JOB.RESV.MATL,1,M,0)
               JOB.RESV.WHSE = DELETE(JOB.RESV.WHSE,1,M,0)
               JOB.RESV.DATE = DELETE(JOB.RESV.DATE,1,M,0)
               JOB.ALOC.QTY = DELETE(JOB.ALOC.QTY,1,M,0)
               JOB.RESV.QTY = DELETE(JOB.RESV.QTY,1,M,0)
               JOB.USED.QTY = DELETE(JOB.USED.QTY,1,M,0)
               JOB.ALOC.AMT = DELETE(JOB.ALOC.AMT,1,M,0)
               JOB.RESV.AMT = DELETE(JOB.RESV.AMT,1,M,0)
               JOB.USED.AMT = DELETE(JOB.USED.AMT,1,M,0)
            END
         END
      NEXT M
   END
   MATWRITE JOB.REC ON JOB, CONO:CHARGE.JOB
NEXT J
*
1900 *
1999 *
RELEASE
RETURN
*
*
*--- CALLS FOR SYSCOM
*
91000 *
ERR.TYPE = 1;CALL SYSCOM(MAT SYSCOM.REC); RETURN
92000 *
ERR.TYPE = 2;CALL SYSCOM(MAT SYSCOM.REC); RETURN
93000 *
ERR.TYPE = 3;CALL SYSCOM(MAT SYSCOM.REC)
999999 *
RELEASE
END
