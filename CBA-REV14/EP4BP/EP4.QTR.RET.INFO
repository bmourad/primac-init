*********************************************************************
* REVISION    - [08.1]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - PRSBP
* PROGRAM     - QTR.RET.INFO
* BY          - WALID YAMOUT, CBA
* DATE        - 06/11/85
* MODIFIED    - 12/08/87
* DESCRIPTION - Prints Quarterly Payroll Return Information Report
* MOD         - INSTALL 8.1
*             - CSF11279 RWW 1.15.90
*             - CSF11585 RWW 012990 - FUTA COL TO NOT USE NON TAX
*             - DEDUCTIONS IN CALC
* MOD         - TASK 15719 RWW 1.4.91 FICA/MEDICARE MOD
* TASK 20700 JR DO NOT USE COMPANY MAX SUI
*T21656 lanny 02/28/1997 * SUTA taxable incorrect.
*********************************************************************
*ENDDOC
*COPY>PMC.CPYLIB>EMPLOYEE
*COPY>PRS.CPYLIB>MISCDED
*COPY>PRS.CPYLIB>TAX2
*COPY>PRS.CPYLIB>QTD-YTD
*COPY>PMC.CPYLIB>COMPANY
*COPY>PMC.CPYLIB>FICA.TABLE
*COPY>CPYLIB>CHAR
      PROCREAD X ELSE PRINT "CANNOT READ INPUT BUFFER";INPUT X;STOP
      CONO=X<1>;CO.NAME=X<2>;QTR=X<3>;BACKUP=X<5>
      IF QTR < 1 OR QTR > 4 THEN PRINT "INVALID QUARTER INPUT":;INPUT R;STOP
      IF BACKUP='Y' THEN
         OPEN "S.QTD-YTD" TO QTD.YTD ELSE PRINT "CAN'T OPEN S.QTD-YTD":;INPUT R;STOP
         OPEN "S.EMPLOYEE" TO EMPLOYEE ELSE PRINT "CAN'T OPEN S.EMPLOYEE":;INPUT R;STOP
         OPEN "S.COMPANY" TO COMPANY ELSE PRINT "CAN'T OPEN S.COMPANY":;INPUT R;STOP
         OPEN "S.FICA.TABLE" TO FICA.TABLE ELSE PRINT "CAN'T OPEN S.FICA.TABLE":;INPUT R;STOP
      END ELSE
         OPEN "QTD-YTD" TO QTD.YTD ELSE PRINT "CAN'T OPEN QTD-YTD":;INPUT R;STOP
         OPEN "EMPLOYEE" TO EMPLOYEE ELSE PRINT "CAN'T OPEN EMPLOYEE":;INPUT R;STOP
         OPEN "COMPANY" TO COMPANY ELSE PRINT "CAN'T OPEN COMPANY":;INPUT R;STOP
         OPEN "FICA.TABLE" TO FICA.TABLE ELSE PRINT "CAN'T OPEN FICA.TABLE":;INPUT R;STOP
      END
      OPEN "TAX2" TO TAX2 ELSE PRINT "CAN'T OPEN TAX2 FILE":;INPUT R;STOP
      OPEN "MISCDED" TO MISCDED ELSE PRINT "CAN'T OPEN MISCDED FILE":;INPUT WAIT;STOP
      MATREAD COMP.REC FROM COMPANY,CONO ELSE PRINT "CAN'T READ COMPANY":;INPUT R;STOP
      MATREAD FIC.REC FROM FICA.TABLE,CONO ELSE PRINT "CAN'T READ FICA-TABLE":;INPUT R;STOP
      HOLD=""
      DIM T(15),C(15)
      MAT T = ""
      MAT C = ""
*
*---- HEADING ROUTINE
*
      POS1=51 - INT(LEN(CO.NAME)/2)
      POS2=26 + INT(LEN(CO.NAME)/2)
      HEAD1="DATE - ":OCONV(DATE(),"D2/") "L#8":SPACE(POS1):CO.NAME "L#30":SPACE(POS2):"PAGE - 'PL'"
      HEAD2=SPACE(31):"Q U A R T E R L Y   P A Y R O L L   R E T U R N   I N F O R M A T I O N'L'"
      BEGIN CASE
      CASE QTR=1
         HEAD3="F I R S T"
      CASE QTR=2
         HEAD3="S E C O N D"
      CASE QTR=3
         HEAD3="T H I R D"
      CASE QTR=4
         HEAD3="F O U R T H"
      CASE 1
         HEAD3=QTR
      END CASE
      HEAD3="F O R   T H E   ":HEAD3:"   Q U A R T E R"
      HEAD3=SPACE(66-INT(LEN(HEAD3)/2)):HEAD3:"'LL'"
      HEAD4=SPACE(27):"Y-T-D    Q-T-D   Q-T-D    Q-T-D     Q-T-D     Q-T-D   Q-T-D     Q-T-D":SPACE(8):"Q-T-D":SPACE(6):"Q-T-D    Q-T-D'L'"
      HEAD4=HEAD4:SPACE(6):"Y-T-D      Q-T-D      ADJ      ADJ  FICA TXBL  FUTA      SUTA       FWHT  FICA TAX   STATE        CITY       SUTA      EIC'L'"
      HEAD4=HEAD4:SPACE(6):"GROSS      GROSS     GROSS    GROSS MEDI TXBL TAXABLE   TAXABLE      TAX"
      HEAD4=HEAD4:"  MEDI TAX":SPACE(3):"TAX /CODE    TAX /CODE   TAX'L'"
      PRINTER ON
      HEADING HEAD1:HEAD2:HEAD3:HEAD4
      FIRST=1;EOJ=0;MAT C=""
300 *
      READNEXT ID ELSE EOJ=1;GOTO 2000
      IF ID[1,3] # CONO THEN GOTO 300
      MAT QTD.REC=0;MAT EMP.REC=""
      MATREAD EMP.REC FROM EMPLOYEE,ID ELSE GOTO 300
      ALT.GROSS=0;ALT.NTSICK=0;QTD.NTD.FICA=0;QTD.NTD=0
      QTD.NTD.FUTA=0;QTD.NTD.SUTA=0;YTD.NTD.FICA = 0
      YTD.NTD = 0; YTD.NTD.FUTA = 0; YTD.NTD.SUTA = 0
      IF EMP.ALT.NO # "" THEN
         MATREAD QTD.REC FROM QTD.YTD,ID[1,3]:EMP.ALT.NO ELSE MAT QTD.REC = ""
         FOR X=1 TO QTR
            ALT.GROSS=ALT.GROSS+QTD.GROSS<1,X>
            ALT.NTSICK=ALT.NTSICK+QTD.SK.NO.FI<1,X>
         NEXT X
         GOSUB 5000
      END
      MATREAD QTD.REC FROM QTD.YTD,ID ELSE GOTO 300
      EMP.NO=ID[4,4]
      IF FIRST THEN GOTO 2100
      IF HOLD#EMP.ST.CODE THEN GOTO 2000
*
*---- CALCULATE PREVIOUS ADJUSTED YTD
500 *
      GROSS.YTD=0;SICK.YTD=0;NTSICK.YTD=0
      FOR Y=1 TO QTR
         GROSS.YTD=GROSS.YTD+QTD.GROSS<1,Y>
         SICK.YTD=SICK.YTD+QTD.SCK.PAY<1,Y>
         NTSICK.YTD=NTSICK.YTD+QTD.SK.NO.FI<1,Y>
      NEXT Y
      GOSUB 5000;ADJ.GROSS.YTD=GROSS.YTD-YTD.NTD
      ADJ.GROSS.QTD=QTD.GROSS<1,QTR>-QTD.NTD
*
* T20700
      IF TTR.DIAB.SUI.PCT='' OR TTR.DIAB.SUI.PCT=0 THEN
         MAXSUIGR=0
      END ELSE
        MAXSUIGR=TTR.MAX.SUI.TAX/(TTR.DIAB.SUI.PCT/100)
         MAXSUIGR=ICONV(MAXSUIGR,"MD2")
      END
*      IF MAXSUIGR + 0 = 0 THEN MAXSUIGR = CO.MAX.SUI.TAX
* T20700
*     MAXSUIGR=ICONV(MAXSUIGR,"MD2")
      NTSICK=QTD.SK.NO.FI<1,QTR>
*
*---- QTD FICA TAXABLE OASDI (LVL1 ONLY)
*
      FICA=QTD.GROSS<1,QTR>-NTSICK-QTD.NTD.FICA
*CSF 19948
*     THIS.FICA=GROSS.YTD-NTSICK.YTD;THAT.FICA=ALT.GROSS-ALT.NTSICK
      THIS.FICA = GROSS.YTD - NTSICK.YTD - YTD.NTD.FICA
      THAT.FICA = ALT.GROSS - ALT.NTSICK
      PRE.FICA=THIS.FICA-FICA
*CSF11279
*     FICA.ADD = YTD.NTD
*     ADD.AMT=(THIS.FICA+THAT.FICA)-FIC.LVL1.MAX.FICA.TAX
*     IF ADD.AMT LT FICA.ADD THEN FICA.ADD = ADD.AMT
*
      BEGIN CASE
      CASE (THIS.FICA+THAT.FICA) > FIC.LVL1.MAX.FICA.TAX
*CSF11279
*        THIS.FICA=(FIC.LVL1.MAX.FICA.TAX-THAT.FICA)-PRE.FICA+FICA.ADD
         THIS.FICA=(FIC.LVL1.MAX.FICA.TAX-THAT.FICA)-PRE.FICA
*
      CASE THIS.FICA > FIC.LVL1.MAX.FICA.TAX
*CSF11279
*        THIS.FICA=FIC.LVL1.MAX.FICA.TAX-PRE.FICA+FICA.ADD
         THIS.FICA=FIC.LVL1.MAX.FICA.TAX-PRE.FICA
*
      CASE THAT.FICA > FIC.LVL1.MAX.FICA.TAX
         THIS.FICA=0
      CASE 1
         THIS.FICA=FICA
      END CASE
      IF THIS.FICA<0 THEN THIS.FICA=0
      FICA.LVL1=THIS.FICA
*
*---- QTD FICA TAXABLE MEDICARE HI (LVL2 ONLY)
*
      FICA=QTD.GROSS<1,QTR>-NTSICK-QTD.NTD.FICA
*     THIS.FICA=GROSS.YTD-NTSICK.YTD;THAT.FICA=ALT.GROSS-ALT.NTSICK
      THIS.FICA = GROSS.YTD - NTSICK.YTD - YTD.NTD.FICA
      THAT.FICA = ALT.GROSS - ALT.NTSICK
      PRE.FICA=THIS.FICA-FICA
*CSF11279
*     FICA.ADD = YTD.NTD
*     ADD.AMT=(THIS.FICA+THAT.FICA)-FIC.LVL2.MAX.FICA.TAX
*     IF ADD.AMT LT FICA.ADD THEN FICA.ADD = ADD.AMT
*
      BEGIN CASE
      CASE (THIS.FICA+THAT.FICA) > FIC.LVL2.MAX.FICA.TAX
*CSF11279
*        THIS.FICA=(FIC.LVL2.MAX.FICA.TAX-THAT.FICA)-PRE.FICA+FICA.ADD
         THIS.FICA=(FIC.LVL2.MAX.FICA.TAX-THAT.FICA)-PRE.FICA
*
      CASE THIS.FICA > FIC.LVL2.MAX.FICA.TAX
*CSF11279
*        THIS.FICA=FIC.LVL2.MAX.FICA.TAX-PRE.FICA+FICA.ADD
         THIS.FICA=FIC.LVL2.MAX.FICA.TAX-PRE.FICA
*
      CASE THAT.FICA > FIC.LVL2.MAX.FICA.TAX
         THIS.FICA=0
      CASE 1
         THIS.FICA=FICA
      END CASE
      IF THIS.FICA<0 THEN THIS.FICA=0
      FICA.LVL2=THIS.FICA
*
*---- QTD FEDERAL UNEMPLOYMENT INSURANCE (FUI)
*
*CSF11585
*     FUI=QTD.GROSS<1,QTR>-NTSICK-QTD.NTD.FICA
* (LMR 11/19/93 - MAKE AGREE WITH STD PAYROLL)
      FUI=QTD.GROSS<1,QTR>-NTSICK-QTD.NTD.FUTA
*
*     THIS.FUI=GROSS.YTD-NTSICK.YTD-YTD.NTD+QTD.NTD;THAT.FUI=ALT.GROSS-ALT.NTSICK
      THIS.FUI=GROSS.YTD-NTSICK.YTD-YTD.NTD.FUTA;THAT.FUI=ALT.GROSS-ALT.NTSICK
* (LMR 11/19/93)
      PRE.FUI=THIS.FUI-FUI
      BEGIN CASE
      CASE (THIS.FUI+THAT.FUI) > CO.MAX.FUI.TAX
         THIS.FUI=(CO.MAX.FUI.TAX-THAT.FUI)-PRE.FUI 
      CASE THIS.FUI > CO.MAX.FUI.TAX
         THIS.FUI=CO.MAX.FUI.TAX-PRE.FUI 
      CASE THAT.FUI > CO.MAX.FUI.TAX
         THIS.FUI=0
      CASE 1
* (LMR 11/19/93)
*        THIS.FUI=FUI-YTD.NTD
         THIS.FUI=FUI
      END CASE
      IF THIS.FUI<0 THEN THIS.FUI=0
      FUI=THIS.FUI
*
*---- QTD STATE UNEMPLOYMENT INSURANCE (SUI)
*
*T21656 v LOGIC FROM EP4.SUI.RPT
      BEGIN CASE
      CASE TTR.EMPR.MAX.SUI # "" AND TTR.EMPR.MAX.SUI # " "
         SUI.MAXIMUM = TTR.EMPR.MAX.SUI * 100
      CASE CO.MAX.SUI.TAX # ""
         SUI.MAXIMUM = CO.MAX.SUI.TAX
      CASE 1
         SUI.MAXIMUM = 0
      END CASE
      PAID=QTD.GROSS<1,QTR>-QTD.SK.NO.FI<1,QTR>-QTD.NTD.SUTA
      THIS.SUI=GROSS.YTD-NTSICK.YTD-YTD.NTD.SUTA;THAT.SUI=ALT.GROSS-ALT.NTSICK
      PRE.SUI=THIS.SUI-PAID
      BEGIN CASE
      CASE (THIS.SUI+THAT.SUI) > SUI.MAXIMUM 
         THIS.SUI=(SUI.MAXIMUM-THAT.SUI)-PRE.SUI
      CASE THIS.SUI > SUI.MAXIMUM
         THIS.SUI=SUI.MAXIMUM-PRE.SUI
      CASE THAT.SUI > SUI.MAXIMUM
         THIS.SUI=0
      CASE 1
         THIS.SUI=PAID
      END CASE
*     SUI=QTD.GROSS<1,QTR>-NTSICK -QTD.NTD.SUTA
*     THIS.SUI=GROSS.YTD-NTSICK.YTD-YTD.NTD.SUTA
*     PRE.SUI=THIS.SUI-SUI
*     BEGIN CASE
*     CASE THIS.SUI > MAXSUIGR
*        THIS.SUI=MAXSUIGR-PRE.SUI
*     CASE 1
*        THIS.SUI=SUI
*     END CASE
      IF THIS.SUI<0 THEN THIS.SUI=0
      SUI=THIS.SUI
*
*---- START OF PRINT
*
      PRINT EMP.NO"R#4 ":EMP.FRST.NAME:" ":EMP.LAST.NAME
      PRINT OCONV(FICA.LVL1,"MD2")"R#50":
      PRINT OCONV(QTD.LVL1.FICA<1,QTR>,"MD2")"R#36"
      PRINT OCONV(GROSS.YTD,"MD2,")"R#11":
      PRINT OCONV(QTD.GROSS<1,QTR>,"MD2,")"R#11":
      PRINT OCONV(ADJ.GROSS.YTD,"MD2,")"R#10":
      PRINT OCONV(ADJ.GROSS.QTD,"MD2")"R#9":
      PRINT OCONV(FICA.LVL2,"MD2")"R#9":
      PRINT OCONV(FUI,"MD2")"R#9":
      PRINT OCONV(SUI,"MD2")"R#9":
      PRINT OCONV(QTD.FWHT<1,QTR>,"MD2")"R#10":
      PRINT OCONV(QTD.LVL2.FICA<1,QTR>,"MD2")"R#8":
      PRINT OCONV(QTD.SWHT<1,QTR>,"MD2")"R#9 ":EMP.ST.CODE"L#4":
      PRINT OCONV(QTD.CWHT<1,QTR>,"MD2")"R#8 ":EMP.CITY.CODE"L#4":
      PRINT OCONV(QTD.SUI<1,QTR>,"MD2")"R#7":
      PRINT OCONV(QTD.EIC<1,QTR>,"MD2")"R#9"
      PRINT
      T(1)=T(1)+GROSS.YTD
      T(2)=T(2)+QTD.GROSS<1,QTR>
      T(3)=T(3)+FICA.LVL2
      T(4)=T(4)+SUI
      T(5)=T(5)+QTD.FWHT<1,QTR>
      T(6)=T(6)+QTD.LVL2.FICA<1,QTR>
      T(7)=T(7)+QTD.SWHT<1,QTR>
      T(8)=T(8)+QTD.CWHT<1,QTR>
      T(9)=T(9)+QTD.SUI<1,QTR>
      T(10)=T(10)+QTD.EIC<1,QTR>
      T(11)=T(11)+ADJ.GROSS.YTD
      T(12)=T(12)+FUI
      T(13)=T(13)+ADJ.GROSS.QTD
      T(14)=T(14)+FICA.LVL1
      T(15)=T(15)+QTD.LVL1.FICA<1,QTR>
      GOTO 300
*
*---- STATE TAX BREAK
2000 *
      PRINT
      PRINT SPACE(3):"TOTALS: ":OCONV(T(2),"MD2,")"R#11":
      PRINT SPACE(8):OCONV(T(13),"MD2,")"R#13":
      PRINT SPACE(5):OCONV(T(12),"MD2,")"R#13":
      PRINT SPACE(6):OCONV(T(5),"MD2,")"R#13":
      PRINT SPACE(4):OCONV(T(7),"MD2,")"R#13":
      PRINT SPACE(12):OCONV(T(9),"MD2,")"R#13"
      PRINT OCONV(T(14),"MD2,")"R#53":
      PRINT OCONV(T(15),"MD2,")"R#36"
      PRINT OCONV(T(1),"MD2,")"R#13":
      PRINT SPACE(7):OCONV(T(11),"MD2,")"R#13":
      PRINT SPACE(7):OCONV(T(3),"MD2,")"R#13":
      PRINT SPACE(5):OCONV(T(4),"MD2,")"R#13":
      PRINT SPACE(5):OCONV(T(6),"MD2,")"R#13":
      PRINT SPACE(9):OCONV(T(8),"MD2,")"R#13":
      PRINT SPACE(8):OCONV(T(10),"MD2,")"R#13"
      FOR X=1 TO 15
         C(X)=C(X)+T(X)
      NEXT X
      IF EOJ THEN GOTO 4000
      PAGE
2100 *
      MAT T=0;HOLD=EMP.ST.CODE;FIRST=0
      MATREAD TAX.TAB.REC FROM TAX2,CONO:EMP.ST.CODE ELSE MAT TAX.TAB.REC=""
      GOTO 500
*
*---- COMPANY BREAK
4000 *
      PRINT;PRINT;PRINT
      PRINT "CO TOTALS ":OCONV(C(2),"MD2,")"R#12":
      PRINT SPACE(8):OCONV(C(13),"MD2,")"R#13":
      PRINT SPACE(5):OCONV(C(12),"MD2,")"R#13":
      PRINT SPACE(6):OCONV(C(5),"MD2,")"R#13":
      PRINT SPACE(4):OCONV(C(7),"MD2,")"R#13":
      PRINT SPACE(12):OCONV(C(9),"MD2,")"R#13"
      PRINT OCONV(C(14),"MD2,")"R#53":
      PRINT OCONV(C(15),"MD2,")"R#36"
      PRINT OCONV(C(1),"MD2,")"R#13":
      PRINT SPACE(7):OCONV(C(11),"MD2,")"R#13":
      PRINT SPACE(7):OCONV(C(3),"MD2,")"R#13":
      PRINT SPACE(5):OCONV(C(4),"MD2,")"R#13":
      PRINT SPACE(5):OCONV(C(6),"MD2,")"R#13":
      PRINT SPACE(9):OCONV(C(8),"MD2,")"R#13":
      PRINT SPACE(8):OCONV(C(10),"MD2,")"R#13"
      PRINTER OFF
      STOP
*
*---- NON TAXABLE DEDUCTIONS
5000 *
      YTD.NTD = 0; QTD.NTD = 0
      NTD.CNT=DCOUNT(QTD.DED,VM)
      FOR REF=1 TO NTD.CNT
         MATREAD MDED.REC FROM MISCDED,CONO:QTD.DED<1,REF> ELSE MAT MDED.REC=""
         IF MDED.TAXABLE="B" THEN
            FOR X = 1 TO QTR
               YTD.NTD = YTD.NTD + QTD.AMNT<1,REF,X>
               IF MDED.NTXFICA = "Y" THEN
                  YTD.NTD.FICA = YTD.NTD.FICA + QTD.AMNT<1,REF,X>
               END
               IF MDED.NTXFUTA = "Y" THEN
                  YTD.NTD.FUTA = YTD.NTD.FUTA + QTD.AMNT<1,REF,X>
               END
               IF MDED.NTXSUTA = "Y" THEN
                  YTD.NTD.SUTA = YTD.NTD.SUTA + QTD.AMNT<1,REF,X>
               END
*              IF X = QTR THEN QTD.NTD = QTD.NTD + QTD.AMNT<1,REF,X>
*CSF11279
*              IF MDED.NTXFICA = "Y" AND X = QTR THEN QTD.NTD.FICA=QTD.NTD.FICA+QTD.AMNT<1,REF,QTR>
               IF X = QTR THEN
                  QTD.NTD = QTD.NTD + QTD.AMNT<1,REF,X>
                  IF MDED.NTXFICA = "Y" THEN
                     QTD.NTD.FICA=QTD.NTD.FICA+QTD.AMNT<1,REF,X>
                  END
                  IF MDED.NTXFUTA = "Y" THEN
                     QTD.NTD.FUTA = QTD.NTD.FUTA + QTD.AMNT<1,REF,X>
                  END
                  IF MDED.NTXSUTA = "Y" THEN
                     QTD.NTD.SUTA = QTD.NTD.SUTA + QTD.AMNT<1,REF,X>
                  END
               END
*
            NEXT X
         END
      NEXT REF
      RETURN
      END
