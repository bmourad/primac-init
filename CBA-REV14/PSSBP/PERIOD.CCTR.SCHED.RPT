*********************************************************************
* REVISION - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM   - PRIMAC
* SOURCE   - PSSBP
* PROGRAM  - PERIOD.CCTR.SCHED.RPT
* AUTHOR   - WALID YAMOUT, C.B.A.
* DATE     - 09/01/87
* DESCRIPTION
* This program will print CCTR.SCHED for a period.
*T26493 cmykleb 03/22/2002 * Change report to use rpt # from proc.
*********************************************************************
*
*--- FILE COPY STATEMENTS
*
*COPY>PSS.CPYLIB>CCTR.SCHED
*COPY>PMC.CPYLIB>DEPARTMENT
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>SYSCOM
*
*---- SET UP SYSCOM
*
      SYS.TYPE = 1
      CALL SI_SYSCOM(MAT SYSCOM.REC)
      DIM ALL.REC(5)
      EQU ALL.CCTR     TO ALL.REC(1)
      EQU ALL.CCTR.AVL TO ALL.REC(2)
      EQU ALL.CCTR.SCH TO ALL.REC(3)
      EQU ALL.JOB      TO ALL.REC(4)
      EQU ALL.JOB.SCH  TO ALL.REC(5)
*
*--- INTIALIZATION
*
      LINE.CNT = 99
      PG.NO = 0
      ERRMSG = ""
      MAT ALL.REC = ""
      AVLHD = " AVAIL"
      SCHHD = " SCHED"
      D6 = "------"
*
*--- OPEN FILES
*
      OPEN "","CONTROL" TO CONTROL ELSE ERRMSG = "CONTROL FILE IS MISSING"; GOSUB 90000; GOTO 999999
      OPEN "","CCTR.SCHED" TO CCTR.SCHED ELSE ERRMSG = "CCTR.SCHED FILE IS MISSING"; GOSUB 90000; GOTO 999999
      OPEN "","PEND.CCTR.SCHED" TO PEND.CCTR.SCHED ELSE ERRMSG = "PEND.CCTR.SCHED FILE IS MISSING"; GOSUB 90000; GOTO 999999
      OPEN "","DEPARTMENT" TO DEPARTMENT ELSE ERRMSG = "DEPARTMENT FILE IS MISSING"; GOSUB 90000; GOTO 999999
      OPEN "","PSS.JOURNAL" TO PSS.JOURNAL ELSE
         ERRMSG = "CANNOT OPEN PSS.JOURNAL FILE"
         GOSUB 90000
         GOTO 999999
      END
      OPEN "","PSS.LOCK" TO PSS.LOCK ELSE
         ERRMSG = "CANNOT OPEN PSS.LOCK FILE"
         GOSUB 90000
         GOTO 999999
      END
*
*--- PERFORM PROCREAD
*
      PROCREAD BUFFER ELSE ERRMSG = "MUST RUN FROM PROC"; GOSUB 90000; GOTO 999999
      CONO = BUFFER<1>
      CO.NAME = BUFFER<2>
      ST.DATE = ICONV(BUFFER<3>, "D2/")
      PER.DAYS = BUFFER<4>
      READ DEMODATE FROM CONTROL,"DEMODATE" THEN TODAY=ICONV(DEMODATE,"D") ELSE TODAY=DATE()
      ST.DATE<2> = ST.DATE<1> + PER.DAYS
      ST.DATE<3> = ST.DATE<2> + PER.DAYS
      ST.DATE<4> = ST.DATE<3> + PER.DAYS
      ST.DATE<5> = ST.DATE<4> + PER.DAYS
      ST.DATE<6> = ST.DATE<5> + PER.DAYS
      ST.DATE<7> = ST.DATE<6> + PER.DAYS
      ST.DATE<8> = ST.DATE<7> + PER.DAYS
      ST.DATE<9> = ST.DATE<8> + PER.DAYS - 1
*
*--- GET PROGRAM HEADINGS
*
*T26493 v
*     REPORT.NAME = "PERIODIC COST CENTER REPORT"
*     REPORT.NUMBER = "XXXX"
      CO.NAME = ""
      REPORT.NAME = ""
      REPORT.NUMBER = BUFFER<2>
*T26943 ^
      REPORT.DATE = TODAY
      HD1 = "";HD2 = ""
      CALL GET.PROG.HEAD(CONO,CO.NAME,REPORT.NAME,REPORT.NUMBER,REPORT.DATE,HD1,HD2)
      HD3 = ""
      HD3[65,13] = "STARTING DATE"
      HD3[79,8] = OCONV(ST.DATE<1>, "D2/")
      HD4 = SPACE(132)
      HD5 = SPACE(132)
      HD6 = SPACE(132)
      HD4[1,6] = "CCTR /"
      HD5[4,7] = "JOB NUM"
      HD6[1,11] = "-----------"
      HD4[17,8] = OCONV(ST.DATE<1>, "D2/")
      HD5[14,6] = AVLHD
      HD6[14,6] = D6
      HD5[21,6] = SCHHD
      HD6[21,6] = D6
      HD4[32,8] = OCONV(ST.DATE<2>, "D2/")
      HD5[29,6] = AVLHD
      HD6[29,6] = D6
      HD5[36,6] = SCHHD
      HD6[36,6] = D6
      HD4[47,8] = OCONV(ST.DATE<3>, "D2/")
      HD5[44,6] = AVLHD
      HD6[44,6] = D6
      HD5[51,6] = SCHHD
      HD6[51,6] = D6
      HD4[62,8] = OCONV(ST.DATE<4>, "D2/")
      HD5[59,6] = AVLHD
      HD6[59,6] = D6
      HD5[66,6] = SCHHD
      HD6[66,6] = D6
      HD4[77,8] = OCONV(ST.DATE<5>, "D2/")
      HD5[74,6] = AVLHD
      HD6[74,6] = D6
      HD5[81,6] = SCHHD
      HD6[81,6] = D6
      HD4[92,8] = OCONV(ST.DATE<6>, "D2/")
      HD5[89,6] = AVLHD
      HD6[89,6] = D6
      HD5[96,6] = SCHHD
      HD6[96,6] = D6
      HD4[107,8] = OCONV(ST.DATE<7>, "D2/")
      HD5[104,6] = AVLHD
      HD6[104,6] = D6
      HD5[111,6] = SCHHD
      HD6[111,6] = D6
      HD4[122,8] = OCONV(ST.DATE<8>, "D2/")
      HD5[119,6] = AVLHD
      HD6[119,6] = D6
      HD5[126,6] = SCHHD
      HD6[126,6] = D6
      PRINTER ON
*
*--- MAIN PROCESSING
*
100*
      READNEXT ID ELSE GOTO 999999
      RDATE = FIELD(ID,"*",2)
      IF RDATE < ST.DATE<1> OR RDATE > ST.DATE<9> THEN GOTO 100
      MATREAD CCTR.SCHED.REC FROM CCTR.SCHED, ID ELSE GOTO 100
      CCTR.NO = FIELD(ID,"*",1)[4,3]
      DEPT = CCS.DEPT
      MATREAD DEPT.REC FROM DEPARTMENT, CONO : DEPT ELSE
         MAT DEPT.REC = ""
         DEPT.DESC = "NOT ON FILE"
      END
      HD7 = "DEPARTMENT : " : DEPT "L#5" : "   " : DEPT.DESC
      CCTR = CCTR.NO
      GOSUB 1000
      DATA = 1
      LOOP
         READNEXT ID ELSE DATA = 0
      WHILE DATA DO
         RDATE = FIELD(ID,"*",2)
         IF RDATE < ST.DATE<1> OR RDATE > ST.DATE<9> THEN GOTO 199
         MATREAD CCTR.SCHED.REC FROM CCTR.SCHED, ID ELSE GOTO 199
         CCTR.NO = FIELD(ID,"*",1)[4,3]
         BEGIN CASE
            CASE CCS.DEPT # DEPT
               GOSUB 2000
               DEPT = CCS.DEPT
               CCTR = CCTR.NO
               MATREAD DEPT.REC FROM DEPARTMENT, CONO : DEPT ELSE
                  MAT DEPT.REC = ""
                  DEPT.DESC = "NOT ON FILE"
               END
               HD7 = "DEPARTMENT : " : DEPT "L#5" : "   " : DEPT.DESC
               LINE.CNT = 99
            CASE CCTR.NO # CCTR
               GOSUB 2000
               CCTR = CCTR.NO
         END CASE
         GOSUB 1000
199*
      REPEAT
      GOSUB 2000
      GOTO 999999
*-------------------*
*--- SUBROUTINES ---*
*-------------------*
*
*--- LOAD PERIOD HOURS
*
1000*
      IF CCS.AVL.HRS + 0 # 0 OR CCS.JOB # "" THEN ALL.CCTR = CCTR.NO
      BEGIN CASE
         CASE RDATE < ST.DATE<2>
            WK = 1
         CASE RDATE < ST.DATE<3>
            WK = 2
         CASE RDATE < ST.DATE<4>
            WK = 3
         CASE RDATE < ST.DATE<5>
            WK = 4
         CASE RDATE < ST.DATE<6>
            WK = 5
         CASE RDATE < ST.DATE<7>
            WK = 6
         CASE RDATE < ST.DATE<8>
            WK = 7
         CASE 1
            WK = 8
      END CASE
      ALL.CCTR.AVL<WK> = ALL.CCTR.AVL<WK> + CCS.AVL.HRS
      ALL.CCTR.SCH<WK> = ALL.CCTR.SCH<WK> + CCS.SCH.HRS
      JCNT = DCOUNT(CCS.JOB,VM)
      FOR JJ = 1 TO JCNT
         JOB.NO = CCS.JOB<1,JJ>
         LOCATE JOB.NO IN ALL.JOB SETTING JFND ELSE
            ALL.JOB<JFND> = JOB.NO
         END
         ALL.JOB.SCH<JFND,WK> = ALL.JOB.SCH<JFND,WK> + CCS.JOB.HRS<1,JJ>
      NEXT JJ
      RETURN
*
*--- PRINT CCTR LINES
*
2000*
      IF ALL.CCTR = "" THEN RETURN
      IF LINE.CNT > 53 THEN GOSUB 8000
      HLINE = SPACE(132)
      HLINE[1,3] = ALL.CCTR "L#3"
      HLINE[14,6] = OCONV(ALL.CCTR.AVL<1>, "MD2Z") "R#6"
      HLINE[21,6] = OCONV(ALL.CCTR.SCH<1>, "MD2Z") "R#6"
      IF ALL.CCTR.SCH<1> > ALL.CCTR.AVL<1> THEN
         HLINE[27,1] = "*"
      END
      HLINE[29,6] = OCONV(ALL.CCTR.AVL<2>, "MD2Z") "R#6"
      HLINE[36,6] = OCONV(ALL.CCTR.SCH<2>, "MD2Z") "R#6"
      IF ALL.CCTR.SCH<2> > ALL.CCTR.AVL<2> THEN
         HLINE[42,1] = "*"
      END
      HLINE[44,6] = OCONV(ALL.CCTR.AVL<3>, "MD2Z") "R#6"
      HLINE[51,6] = OCONV(ALL.CCTR.SCH<3>, "MD2Z") "R#6"
      IF ALL.CCTR.SCH<3> > ALL.CCTR.AVL<3> THEN
         HLINE[57,1] = "*"
      END
      HLINE[59,6] = OCONV(ALL.CCTR.AVL<4>, "MD2Z") "R#6"
      HLINE[66,6] = OCONV(ALL.CCTR.SCH<4>, "MD2Z") "R#6"
      IF ALL.CCTR.SCH<4> > ALL.CCTR.AVL<4> THEN
         HLINE[72,1] = "*"
      END
      HLINE[74,6] = OCONV(ALL.CCTR.AVL<5>, "MD2Z") "R#6"
      HLINE[81,6] = OCONV(ALL.CCTR.SCH<5>, "MD2Z") "R#6"
      IF ALL.CCTR.SCH<5> > ALL.CCTR.AVL<5> THEN
         HLINE[87,1] = "*"
      END
      HLINE[89,6] = OCONV(ALL.CCTR.AVL<6>, "MD2Z") "R#6"
      HLINE[96,6] = OCONV(ALL.CCTR.SCH<6>, "MD2Z") "R#6"
      IF ALL.CCTR.SCH<6> > ALL.CCTR.AVL<6> THEN
         HLINE[102,1] = "*"
      END
      HLINE[104,6] = OCONV(ALL.CCTR.AVL<7>, "MD2Z") "R#6"
      HLINE[111,6] = OCONV(ALL.CCTR.SCH<7>, "MD2Z") "R#6"
      IF ALL.CCTR.SCH<7> > ALL.CCTR.AVL<7> THEN
         HLINE[117,1] = "*"
      END
      HLINE[119,6] = OCONV(ALL.CCTR.AVL<8>, "MD2Z") "R#6"
      HLINE[126,6] = OCONV(ALL.CCTR.SCH<8>, "MD2Z") "R#6"
      IF ALL.CCTR.SCH<8> > ALL.CCTR.AVL<8> THEN
         HLINE[132,1] = "*"
      END
      PRINT HLINE
      LINE.CNT = LINE.CNT + 1
      JCNT = DCOUNT(ALL.JOB,AM)
      FOR JJ = 1 TO JCNT
         IF LINE.CNT > 53 THEN GOSUB 8000
         HLINE = SPACE(132)
         HLINE[4,8] = ALL.JOB<JJ> "L#8"
         HLINE[21,6] = OCONV(ALL.JOB.SCH<JJ,1>, "MD2Z") "R#6"
         HLINE[36,6] = OCONV(ALL.JOB.SCH<JJ,2>, "MD2Z") "R#6"
         HLINE[51,6] = OCONV(ALL.JOB.SCH<JJ,3>, "MD2Z") "R#6"
         HLINE[66,6] = OCONV(ALL.JOB.SCH<JJ,4>, "MD2Z") "R#6"
         HLINE[81,6] = OCONV(ALL.JOB.SCH<JJ,5>, "MD2Z") "R#6"
         HLINE[96,6] = OCONV(ALL.JOB.SCH<JJ,6>, "MD2Z") "R#6"
         HLINE[111,6] = OCONV(ALL.JOB.SCH<JJ,7>, "MD2Z") "R#6"
         HLINE[126,6] = OCONV(ALL.JOB.SCH<JJ,8>, "MD2Z") "R#6"
         PRINT HLINE
         LINE.CNT = LINE.CNT + 1
      NEXT JJ
      IF LINE.CNT < 54 THEN
         PRINT
         LINE.CNT = LINE.CNT + 1
      END
      MAT ALL.REC = ""
      RETURN
*
*--- PRINT HEADINGS
*
8000*
      PG.NO = PG.NO + 1
      PRINT CHAR(12)
      PRINT HD1 : PG.NO "R#4"
      PRINT HD2
      PRINT HD3
      PRINT
      PRINT HD7
      PRINT
      PRINT HD4
      PRINT HD5
      PRINT HD6
      LINE.CNT = 9
      RETURN
*
*--- ERROR ROUTINE
*
90000*
*      PRINT @(0,23):CL:ERRMSG:
*      INPUT REPLY:
*      PRINT @(0,23):CL:
*      RETURN
91000*
      ERR.TYPE = 1
      CALL SI_SYSCOM(MAT SYSCOM.REC)
      RETURN
*
*--- END OF PROGRAM
*
999999*
      PRINTER OFF
*      PRINT @(-1):
      END
