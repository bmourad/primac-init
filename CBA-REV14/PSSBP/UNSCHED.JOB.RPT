*********************************************************************
* REVISION - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM   - PRIMAC
* SOURCE   - PSSBP
* PROGRAM  - UNSCHED.JOB.RPT
* AUTHOR   - ANN POWLEY, C.B.A.
* DATE     - 09/01/87
* MODIFIED - 02/07/96, NA, TASK 19937, JOB DESC BASED ON COMPANY FLAG.
* DESCRIPTION
* This program will Unscheduled Jobs Report.
*T26493 cmykleb 03/22/2002 * Change report to use rpt # from proc.
*********************************************************************
*
***** FILE COPY STATEMENTS
*
*COPY>PSS.CPYLIB>JOB.SCHED
*COPY>PMC.CPYLIB>COMPANY
*COPY>JCS.CPYLIB>JOB
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>SYSCOM
*
*---- SET UP SYSCOM
*
      SYS.TYPE = 1
      CALL SI_SYSCOM(MAT SYSCOM.REC)
*
**** OPEN FILES
*
      OPEN "","CONTROL" TO CONTROL ELSE ERRMSG = "CONTROL FILE IS MISSING"; GOSUB 90000; GOTO 99999
      OPEN "","COMPANY" TO COMPANY ELSE ERRMSG = "COMPANY FILE IS MISSING"; GOSUB 90000; GOTO 99999
      OPEN "","JOB" TO JOB ELSE ERRMSG = "JOB FILE IS MISSING"; GOSUB 90000; GOTO 99999
      OPEN "","JOB.SCHED" TO JOB.SCHED ELSE ERRMSG = "JOB.SCHED FILE IS MISSING"; GOSUB 90000; GOTO 99999
      OPEN "","PEND.JOB.SCHED" TO PEND.JOB.SCHED ELSE ERRMSG = "PEND.JOB.SCHED FILE IS MISSING"; GOSUB 90000; GOTO 99999
OPEN "","PSS.JOURNAL" TO PSS.JOURNAL ELSE
   ERRMSG = "CANNOT OPEN PSS.JOURNAL FILE"
   GOSUB 90000
   GOTO 99999
END
OPEN "","PSS.LOCK" TO PSS.LOCK ELSE
   ERRMSG = "CANNOT OPEN PSS.LOCK FILE"
   GOSUB 90000
   GOTO 99999
END
*
**** PERFORM PROCREAD
*
      PROCREAD BUFFER ELSE ERRMSG = "MUST RUN FROM A PROC"; GOSUB 90000; GOTO 99999
       CONO = BUFFER<1>
*T26493 v
*      CO.NAME = BUFFER<2>
*      REPORT.NAME = "UNSCHEDULED JOBS REPORT"
*      REPORT.NUMBER = "XXXX"
       CO.NAME = ""
       REPORT.NAME = ""
       REPORT.NUMBER = BUFFER<2>
*T26493 ^
       READ DEMODATE FROM CONTROL,"DEMODATE" THEN TODAY=ICONV(DEMODATE,"D") ELSE TODAY=DATE()
       REPORT.DATE = TODAY
       HD1 = "";HD2 = "";PG.NO = 0
       CALL GET.PROG.HEAD(CONO,CO.NAME,REPORT.NAME,REPORT.NUMBER,REPORT.DATE,HD1,HD2)
*
**** INTIALIZATION
*
*---- TASK # 19937 ----
      MATREAD COMP.REC FROM COMPANY, CONO ELSE MAT COMP.REC = ""
*----------------------
     LINE.CNT = 99
     SP = SPACE(1)
     HD3 = "                                    REQ   SCHED   REM              LAST"
     HD4 = "JOB NUM        CUSTOMER NAME       HOURS  HOURS  HOURS  DUE DATE SCH DATE"
     HD5 = "-------- ------------------------- ------ ------ ------ -------- --------"
*
**** MAIN PROCESSING
*
    DATA = 1
    PRINTER ON
    LOOP
      READNEXT ID ELSE DATA = 0
    WHILE DATA DO
      MATREAD JBS.REC FROM JOB.SCHED, ID ELSE MAT JBS.REC = ''
      JOB.NO = ID[4,8]
*---- TASK # 19937 ----
      JDESC = JBS.CUST.NAME
      IF CO.PSS.JDESC.FLAG = "J" OR CO.PSS.JDESC.FLAG = "X" THEN
         MATREAD JOB.REC FROM JOB, ID THEN
            IF TRIM(JOB.DESC<1,1>) # "" THEN
               IF CO.PSS.JDESC.FLAG = "J" THEN
                  JDESC = JOB.DESC<1,1>
               END ELSE
                  JDESC = JDESC[1,10]:":":JOB.DESC<1,1>
               END
            END
         END
      END
*----------------------
      GOSUB 200
    REPEAT
    GOTO 99999
*
***** PROCESS THE JOB
*
200 *
     HRS.CNT = COUNT(JBS.DEPT,VM) + (JBS.DEPT # '')
     SCH.HRS = 0; REQ.HRS = 0
     SCHED.DATE = JBS.SCH.DATE<1,1>
     FOR I = 1 TO HRS.CNT
       IF JBS.DEPT.STATUS<1,I> # 'C' THEN
         IF JBS.SCH.HRS<1,I> > JBS.ACT.HRS<1,I> THEN
            RHRS = JBS.SCH.HRS<1,I> - JBS.ACT.HRS<1,I>
            SHRS = JBS.USD.HRS<1,I> - JBS.ACT.HRS<1,I>
            IF SHRS < 0 THEN SHRS = 0
            REQ.HRS = REQ.HRS + RHRS
            SCH.HRS = SCH.HRS + SHRS
         END
       END
       IF JBS.SCH.DATE<1,I> > SCHED.DATE THEN
          SCHED.DATE = JBS.SCH.DATE<1,I>
       END
     NEXT I
     IF REQ.HRS > SCH.HRS THEN
        REMAIN.HRS = REQ.HRS - SCH.HRS
        IF LINE.CNT > 55 THEN GOSUB 300
*---- TASK # 19937 ----
*       H.LINE = JOB.NO "L#8" : SP : JBS.CUST.NAME "L#25" : SP
        H.LINE = JOB.NO "L#8" : SP : JDESC "L#25" : SP
*----------------------
        H.LINE = H.LINE : OCONV(REQ.HRS, "MD2") "R#6" : SP
        H.LINE = H.LINE : OCONV(SCH.HRS, "MD2") "R#6" : SP
        H.LINE = H.LINE : OCONV(REMAIN.HRS, "MD2") "R#6" : SP
        H.LINE = H.LINE : OCONV(JBS.DUE.DATE, "D2/") "R#8" : SP
        H.LINE = H.LINE : OCONV(SCHED.DATE, "D2/") "R#8"
        PRINT H.LINE
        LINE.CNT = LINE.CNT + 1
     END
     RETURN
*
**** PRINT HEADINGS
*
300 *
     PG.NO = PG.NO + 1
     PRINT CHAR(12)
     PRINT HD1 : PG.NO "R#4"
     PRINT HD2
     PRINT
     PRINT HD3
     PRINT HD4
     PRINT HD5
     LINE.CNT = 6
     RETURN
*
***** ERROR ROUTINE
90000*
*       PRINT @(0,23):CL:ERRMSG:
*       INPUT REPLY:
*       PRINT @(0,23):CL:
*       RETURN
91000*
      ERR.TYPE = 1
      CALL SI_SYSCOM(MAT SYSCOM.REC)
      RETURN
*
***** END OF PROGRAM
99999*
      PRINTER OFF
*      PRINT @(-1):
   END
