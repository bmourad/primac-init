*COPY>CPYLIB>COM1
*********************************************************************
* REVISION    - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - ICSBP
* PROGRAM     - INV.STD.VAR.RPT
* DATE        - 01/29/83
* BY          - WALID YAMOUT , C.B.A
* DESCRIPTION - This report list inventory standard cost variance
*              report.
*T21638 doug 02/26/1997 * Add quantity conversion for FNGD
*T26190 ajibaly 03/08/2002 * CONVERT TO REV12 USING BUILD.IWH.FI SUB
*T26493 cmykleb 03/22/2002 * Change report to use rpt # from proc.
*********************************************************************
*
***INSERT EQUATE FROM CPYLIB
*
*COPY>ICS.CPYLIB>INV.WHSE
*COPY>ICS.CPYLIB>INVENTORY
*COPY>ICS.CPYLIB>CATEGORY
*COPY>ICS.CPYLIB>INV.CNV
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>SYSCOM
***INITIALIZATION
LINE.COUNT  = 99
PAGE.NO     = 0
SP1 = SPACE(1)
SP2 = SPACE(2)
*** SET UP FOR SYSCOM
SYS.TYPE = 1; CALL SYSCOM(MAT SYSCOM.REC)
***OPEN THE FILE
OPEN '','INV.WHSE' TO INV.WHSE ELSE ERRMSG = "INV.WHSE FILE IS MISSING";GOTO 93000
OPEN '', 'INVENTORY' TO INVENTORY ELSE ERRMSG = "INVENTORY FILE IS MISSING";GOTO 93000
OPEN '','CATEGORY' TO CATEGORY ELSE ERRMSG = "CATEGORY FILE IS MISSING";GOTO 93000
***READ COMPANY NAME 
PROCREAD ID ELSE
  ERRMSG = ' CANNOT PERFORM PROCREAD'
  GOTO 93000
END
CONO = ID<1>
*T26493 v
* CONO.NAME = ID<2>
* REPORT.NAME = "INVENTORY.STANDARD.COST.VARIANCE.REPORT"
* REPORT.NUMBER = "XXXX"
REPORT.NUMBER = ID<2>
REPORT.NAME = ""
CONO.NAME = ""
*T26493 ^
REPORT.DATE = DATE()
HD1 = "" ; HD2 = ""
CALL GET.PROG.HEAD(CONO,CONO.NAME,REPORT.NAME,REPORT.NUMBER,REPORT.DATE,HD1,HD2)
*T26190 v
OPEN.FLAG=1
ERR.FLAG = ''
PERIOD = ID<8>
SEL.PERIOD=ID<8>
IF PERIOD = 'ALL' THEN PERIOD = ''
*T26190 ^
***PUT PRINTER ON
PRINTER ON
***READ AND PROCESS FIRST RECORD
100*
READNEXT KEY ELSE GOTO 999999
GOSUB 200
***READ THE THREE FILES
MATREAD IWH.REC FROM INV.WHSE,KEY ELSE
  MAT IWH.REC = ''
  GOTO 100
END
MATREAD INV.REC FROM INVENTORY,PROD.KEY ELSE
  MAT INV.REC = ''
END
MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE ELSE
  MAT CATG.REC = "";GOTO 100
END
CALL BUILD.IWH.FI(KEY,MAT IWH.REC,PERIOD,ERR.FLAG,ERRMSG,OPEN.FLAG) ;*T26190
***SET THE WHSE, PRODUCT
PREV.WHSE = WHSE
PREV.M.P.LINE = INV.M.LINE:" / ":INV.LINE
*** SET THEN HEADINGS AND DASH LINES
HH.LINE = "PRODUCT NUMBER                FULL DESCRIPTION                U/M COSTWT   ON-HAND  STD-COST  LAST-COST  AVG-COST   LIST-COST"
DH.LINE = "--------------- --------------------------------------------- --- ------ ---------- --------- ---------  ---------  ---------"
***PROCESS THE FILE
GOSUB 2000
*** READ AND PROCESS ALL THE FILES
DATA = 0
LOOP
  READNEXT KEY ELSE DATA = 1
WHILE DATA = 0 DO
  GOSUB 200
***READ THE THREE FILES
  MATREAD IWH.REC FROM INV.WHSE,KEY ELSE
    MAT IWH.REC = ''
    GOTO 111
  END
  MATREAD INV.REC FROM INVENTORY,PROD.KEY ELSE
    MAT INV.REC = ''
  END
  MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE ELSE
    MAT CATG.REC="";GOTO 111
  END
  CALL BUILD.IWH.FI(KEY,MAT IWH.REC,PERIOD,ERR.FLAG,ERRMSG,OPEN.FLAG) ;*T26190
***PROCESS THE FILE
  GOSUB 2000
111*
REPEAT
*** END OF JOB
PRINTER OFF
GOTO 999999
***SEPERATE THE KEY TO PRODUCT, WHSE 
200*
PROD.KEY = FIELD(KEY,"!",1)
PROD = PROD.KEY[4,99]
WHSE    = FIELD(KEY,"!",2)
RETURN
***PROCESS THE RECORD
2000*
IF PREV.WHSE # WHSE OR PREV.M.P.LINE # INV.M.LINE:" / ":INV.LINE THEN
  LINE.COUNT = 99
  PREV.WHSE = WHSE ; PREV.M.P.LINE = INV.M.LINE:" / ":INV.LINE
END
*COPY>ICSBP>INV.UM.CNV
*  MAT INV.CNV.REC = ""
*  BEGIN CASE
*  CASE INV.UNIT<1,2> = "SHT" AND INV.UNIT<1,3> = "LBS"
*     ICR.CNV = "MD0"; ICR.DV2 = 1
*     ICR.MT1 = 1; ICR.DV1 = INV.M.WT
*  CASE INV.UNIT<1,2> = "PC" AND INV.UNIT<1,3> = "MSI"
*     ICR.CNV = "MD0"; ICR.DV2 = 1
*     ICR.MT1 = 10; ICR.DV1 = INV.PAP.WIDTH/100
*  CASE INV.UNIT<1,2> = "FT" AND INV.UNIT<1,3> = "MSI"
*     ICR.CNV = "MD0"; ICR.DV2 = 12
*     ICR.MT1 = 100; ICR.DV1 = INV.PAP.WIDTH/100
*  CASE 1
*     ICR.CNV = "MD2"; ICR.DV2 = 1
*     ICR.MT1 = 1; ICR.DV1 = 10
*  END CASE
BURDEN.FACTOR = CATG.BURDEN.PRCNT / 100
CNT = COUNT(IWH.COST.FI,VM) + (IWH.COST.FI # "")
FIFO.COST=IWH.COST.FI<1,CNT> + (IWH.COST.FI<1,CNT> * BURDEN.FACTOR) / 100
AVG.COST =IWH.AVG.COST + (IWH.AVG.COST * BURDEN.FACTOR) / 100
LIST.COST=IWH.LIST.COST + (IWH.LIST.COST * BURDEN.FACTOR) / 100
IF IWH.STD.COST > FIFO.COST  AND IWH.STD.COST > AVG.COST AND IWH.STD.COST > LIST.COST THEN GOTO 2999
IF LINE.COUNT > 53 THEN GOSUB 8000
LINE.COUNT = LINE.COUNT + 1
H.LINE = PROD "L#15":SP1:INV.FULL.DESC "L#45":SP1
H.LINE = H.LINE : INV.UNIT<1,2>"L#3":SP1
H.LINE = H.LINE : OCONV(INV.COST.WT, "MD2") "R#6":SP1
IWH.ON.HAND = INT(((IWH.ON.HAND/ICR.DV1)*ICR.MT1)/ICR.DV2 + 0.5)
H.LINE = H.LINE:OCONV(IWH.ON.HAND, ICR.CNV) "R#10":SP1
H.LINE = H.LINE : OCONV(IWH.STD.COST, 'MD4') "R#9" :SP1
IF FIFO.COST >= IWH.STD.COST THEN
  H.LINE = H.LINE : OCONV(IWH.COST.FI<1,CNT>, 'MD4') "R#9" :"*":SP1
END ELSE
  H.LINE = H.LINE : OCONV(IWH.COST.FI<1,CNT>, 'MD4') "R#9" :SP2
END
IF AVG.COST >= IWH.STD.COST THEN
  H.LINE = H.LINE : OCONV(IWH.AVG.COST, 'MD4') "R#9" :"*":SP1
END ELSE
  H.LINE = H.LINE : OCONV(IWH.AVG.COST, 'MD4') "R#9" :SP2
END
IF LIST.COST >= IWH.STD.COST THEN
  H.LINE = H.LINE : OCONV(IWH.LIST.COST, 'MD4') "R#9" :"*"
END ELSE
  H.LINE = H.LINE : OCONV(IWH.LIST.COST, 'MD4') "R#9"
END
PRINT H.LINE
2999*
RETURN
***PRINT HEADINGS
8000*
PRINT CHAR(12)
PAGE.NO = PAGE.NO + 1
PRINT HD1:PAGE.NO
PRINT HD2
PRINT
PRINT "WAREHOUSE : ":PREV.WHSE
PRINT "MLINE / PLINE : ":PREV.M.P.LINE
PRINT
PRINT HH.LINE
PRINT DH.LINE
LINE.COUNT = 8
RETURN
***CALLS FOR SYSCOM
91000 ERR.TYPE = 1; CALL SYSCOM(MAT SYSCOM.REC);RETURN
92000 ERR.TYPE = 2; CALL SYSCOM(MAT SYSCOM.REC);RETURN
93000*
PRINTER OFF
ERR.TYPE = 3; CALL SYSCOM(MAT SYSCOM.REC)
999999*
END
