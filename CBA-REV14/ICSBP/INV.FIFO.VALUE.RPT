*COPY>CPYLIB>COM1
*********************************************************************
* REVISION    - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - ICSBP
* PROGRAM     - INV.FIFO.VALUE.RPT
* DATE        - 01/11/84
* BY          - WALID YAMOUT , CBA
* DESCRIPTION - This program list current inventory value by fifo
*              cost.
*T21638 doug 02/26/1997 * Add quantity conversion for FNGD
*T26190 ajibaly 03/08/2002 * CONVERT TO REV12 USING BUILD.IWH.FI SUB
*T26493 cmykleb 03/22/2002 * Change report to use rpt # from proc.
*T26676 epitka 06/17/2002 * fix report to get correct IWH.ON.HAND qty.
*                           for a given period.
*T25740 epitka 09/06/2002 * IF 'ALL' SELECTED FOR PERIOD THEN 99999 IS
*                           PRINTED IN THE HEADING OF THE REPORT
*T27202 epitka 01/07/2003 * FIX CSF 41298
*********************************************************************
*ENDDOC
*COPY>ICS.CPYLIB>INV.WHSE
*COPY>CPYLIB>SYSCOM
*COPY>ICS.CPYLIB>INVENTORY
*COPY>ICS.CPYLIB>INV.CNV
*COPY>CPYLIB>CHAR
*COPY>ICS.CPYLIB>INV.STATS
*
LINE.COUNT     =99
PAGE.NO        =0
TOT.COST=0 ; M.P.COST=0 ; B.COST=0 ; W.COST=0
GRD.TOT=0 ; FIFO.VALUE=0
TOT.ON.HAND=0 ; M.P.ON.HAND=0 ; B.ON.HAND=0
FLG="" ; PREV.W=''
SP1=" "
SP2=SPACE(2)
***   SET UP THE ERRMSG ROUTINE FOR SYSCOM
SYS.TYPE=1
CALL SYSCOM(MAT SYSCOM.REC)
***   OPEN THE FILE
OPEN '','INV.WHSE' TO INV.WHSE ELSE
  ERRMSG='INV.WHSE FILE IS MISSING'
  GOTO 93000
END
OPEN '','INVENTORY' TO INVENTORY ELSE
  ERRMSG='INVENTORY FILE IS MISSING'
  GOTO 93000
END
OPEN '','INV.STATS' TO INV.STATS ELSE
  ERRMSG='INV.STATS FILE IS MISSING'
  GOTO 93000
END
***   READ COMPANY NAME
PROCREAD BUFFER ELSE
  ERRMSG=' CANNOT PERFORM PROCREAD'
  GOTO 93000
END
CONO=BUFFER<1>
REPORT.NUMBER=BUFFER<2>
REPORT.NAME=""
CONO.NAME=""
REPORT.DATE=DATE()
HD1="" ; HD2=""
CALL GET.PROG.HEAD(CONO,CONO.NAME,REPORT.NAME,REPORT.NUMBER,REPORT.DATE,HD1,HD2)
OPEN.FLAG=1
ERR.FLAG=''
PERIOD=BUFFER<9>
SEL.PERIOD=BUFFER<9>
ONHAND.FLG=BUFFER<8> 
IF PERIOD='ALL' THEN
  PERIOD=''
END ELSE
  PERIOD<1,2>='EXCLUDE'
END
PRINTER ON
***   READ AND PROCESS FIRST RECORD
100*
READNEXT IWH.ID ELSE GOTO 999999
GOSUB 200
MATREAD IWH.REC FROM INV.WHSE,IWH.ID ELSE
  MAT IWH.REC=''
  GOTO 100
END
MATREAD INV.STAT.REC FROM INV.STATS,IWH.ID ELSE
  MAT INV.STAT.REC=''
END
MATREAD INV.REC FROM INVENTORY,PROD.KEY ELSE
  MAT INV.REC=''
END
CALL BUILD.IWH.FI(IWH.ID,MAT IWH.REC,PERIOD,ERR.FLAG,ERRMSG,OPEN.FLAG)
IF PERIOD#'' THEN
  IWH.ON.HAND=SUM(IWH.QTY.FI<1>)
END
IF ONHAND.FLG='N' AND IWH.ON.HAND=0 THEN GOTO 100
***   SET THE PRODUCT NUMBER
PREV.PRO=PROD
PREV.M.P.LINE=INV.M.LINE:" / ":INV.LINE
PREV.B=INV.BAS.WT
PREV.DESC=INV.FULL.DESC
PREV.W=WHSE
***   SET THE HEADING LINES
HH.LINE="              FULL DESCRIPTION                U/M  COSTWT  PO-NUM   VENDOR    DATE    ORG-QTY    CURR-QTY  UNIT-COST FIFO $VALUE "
DH.LINE="--------------------------------------------- --- ------- -------- -------- -------- ---------- ---------- --------- ------------"
DT.LINE="                                                                                                ----------           ------------"
DT1.LINE="                                                                                                ==========           ============"
***   PROCESS THE FILE
GOSUB 1000
***    READ AND PROCESS ALL THE FILES
150 
DATA=0
LOOP
  READNEXT IWH.ID ELSE DATA=1
WHILE DATA=0 DO
  GOSUB 200
***   READ THE THREE FILES
  MATREAD IWH.REC FROM INV.WHSE,IWH.ID ELSE
    MAT IWH.REC=''
    GOTO 111
  END
  MATREAD INV.STAT.REC FROM INV.STATS,IWH.ID ELSE
    MAT INV.STAT.REC=''
  END
  MATREAD INV.REC FROM INVENTORY,PROD.KEY ELSE
    MAT INV.REC=''
  END
  CALL BUILD.IWH.FI(IWH.ID,MAT IWH.REC,PERIOD,ERR.FLAG,ERRMSG,OPEN.FLAG)
  IF PERIOD#'' THEN
    IWH.ON.HAND=SUM(IWH.QTY.FI<1>)
  END
  IF ONHAND.FLG='N' AND IWH.ON.HAND=0 THEN CONTINUE
***   PROCESS THE RECORD
  GOSUB 1000
111*
REPEAT
***   PRINT THE TOTAL FOR LAST PRODUCT
GOSUB 25000
GOSUB 35000
GOSUB 45000
GOSUB 55000
***   PRINT THE GRAND TOTAL
IF LINE.COUNT + 2 > 56 THEN GOSUB 80000
PRINT
PRINT SPACE(47) : 'GRAND TOTAL' : SPACE(59) : OCONV(GRD.TOT, 'MD2,') "R#12"
***    END OF JOB
GOTO 999999
***   SEPERATE THE IWH.ID TO PRODUCT, WHSE
200*
PROD.KEY=FIELD(IWH.ID,"!",1)
PROD=PROD.KEY[4,99]
WHSE=FIELD(IWH.ID,"!",2)
RETURN
***   PROCESS THE RECORD
1000*
FLG="Y"
BEGIN CASE
  CASE WHSE # PREV.W
    GOSUB 25000
    GOSUB 35000
    GOSUB 45000
    GOSUB 55000
    GOSUB 80000
  CASE INV.M.LINE:" / ":INV.LINE # PREV.M.P.LINE
    GOSUB 25000
    GOSUB 35000
    GOSUB 45000
    GOSUB 80000
  CASE INV.BAS.WT # PREV.B
    GOSUB 25000
    GOSUB 35000
    PRINT
    LINE.COUNT=LINE.COUNT + 1
  CASE PROD # PREV.PRO
    GOSUB 25000
    PRINT
    LINE.COUNT=LINE.COUNT + 1
END CASE
*COPY>ICSBP>INV.UM.CNV
I=COUNT(IWH.PO.NO.FI,VM) + (IWH.PO.NO.FI # '')
IF INV.COST.WT*1=0 THEN INV.COST.WT=100
TOT.ON.HAND=TOT.ON.HAND + IWH.ON.HAND
IF IWH.ON.HAND < 0 OR I=0 THEN
  II=1
  CQTY=""
  IF IWH.QTY.FI<1,II> < 0 THEN
    CQTY=INT(((IWH.QTY.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 - 0.5)
  END ELSE
    CQTY=INT(((IWH.QTY.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 + 0.5)
  END
  IF CQTY=0 THEN GOTO 1999
  COST=0
  GOSUB 20000
  FIFO.VALUE=0
  GOTO 1999
END
FOR II=1 TO I
*      IF IWH.QTY.FI<1,II>=0 THEN GOTO 1001
  CQTY=""
  IF IWH.QTY.FI<1,II> < 0 THEN
    CQTY=INT(((IWH.QTY.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 - 0.5)
  END ELSE
    CQTY=INT(((IWH.QTY.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 + 0.5)
  END
  IF CQTY=0 THEN GOTO 1001
  IF IWH.QTY.FI<1,II> < 0 THEN
    COST=INT((IWH.COST.FI<1,II>/10000) * ((IWH.QTY.FI<1,II>/10) / (INV.COST.WT/100)))
  END ELSE
    COST=INT((IWH.COST.FI<1,II>/10000) * ((IWH.QTY.FI<1,II>/10) / (INV.COST.WT/100)) + 0.5)
  END
  TOT.COST=TOT.COST + COST
  B.COST=B.COST + COST
  M.P.COST=M.P.COST + COST
  W.COST=W.COST + COST
  IF FLG="Y" THEN GOSUB 20000 ELSE GOSUB 21000
  FIFO.VALUE=FIFO.VALUE + COST
  GRD.TOT=GRD.TOT + COST
1001*
NEXT II
1999*
RETURN
***  ROUTINE TO PRINT THE RECORD
20000*
IF LINE.COUNT > 56 THEN GOSUB 80000
LINE.COUNT=LINE.COUNT + 1
H.LINE=INV.FULL.DESC "L#45":SP1
H.LINE=H.LINE:INV.UNIT<1,2> "L#3":SP1
H.LINE=H.LINE:OCONV(INV.COST.WT, "MD2") "R#7":SP1
H.LINE=H.LINE:IWH.PO.NO.FI<1,II> "L#8":SP1
H.LINE=H.LINE:IWH.VDR.FI<1,II> "L#8":SP1
H.LINE=H.LINE:OCONV(IWH.RECV.FI<1,II>, "D2/") "L#8":SP1
IF IWH.ORG.FI<1,II> < 0 THEN
  IWH.ORG.FI<1,II>=INT(((IWH.ORG.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 - 0.5)
END ELSE
  IWH.ORG.FI<1,II>=INT(((IWH.ORG.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 + 0.5)
END
H.LINE=H.LINE :OCONV(IWH.ORG.FI<1,II>,ICR.CNV) "R#10" :SP1
IF IWH.QTY.FI<1,II> < 0 THEN
  IWH.QTY.FI<1,II>=INT(((IWH.QTY.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 - 0.5)
END ELSE
  IWH.QTY.FI<1,II>=INT(((IWH.QTY.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 + 0.5)
END
H.LINE=H.LINE :OCONV(IWH.QTY.FI<1,II>,ICR.CNV) "R#10" :SP1
H.LINE=H.LINE :OCONV(IWH.COST.FI<1,II>, "MD4,") "R#9":SP1
H.LINE=H.LINE :OCONV(COST, "MD2,") "R#12"
PRINT H.LINE
FLG="N"
RETURN
***   ROUTINE TO PRINT THE LINE FOR SAME ON HAND
21000*
IF LINE.COUNT > 56 THEN GOSUB 80000
LINE.COUNT=LINE.COUNT + 1
V.LINE=''
V.LINE=V.LINE :SPACE(58) : IWH.PO.NO.FI<1,II> "L#8":SP1
V.LINE=V.LINE : IWH.VDR.FI<1,II> "L#8" :SP1
V.LINE=V.LINE : OCONV(IWH.RECV.FI<1,II>, 'D2/') "L#8" :SP1
IF IWH.ORG.FI<1,II> < 0 THEN
  IWH.ORG.FI<1,II>=INT(((IWH.ORG.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 - 0.5)
END ELSE
  IWH.ORG.FI<1,II>=INT(((IWH.ORG.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 + 0.5)
END
V.LINE=V.LINE : OCONV(IWH.ORG.FI<1,II>, ICR.CNV) "R#10" :SP1
IF IWH.QTY.FI<1,II> < 0 THEN
  IWH.QTY.FI<1,II>=INT(((IWH.QTY.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 - 0.5)
END ELSE
  IWH.QTY.FI<1,II>=INT(((IWH.QTY.FI<1,II>/ICR.DV1)*ICR.MT1)/ICR.DV2 + 0.5)
END
V.LINE=V.LINE : OCONV(IWH.QTY.FI<1,II>, ICR.CNV) "R#10" :SP1
V.LINE=V.LINE : OCONV(IWH.COST.FI<1,II>, 'MD4,') "R#9":SP1
V.LINE=V.LINE : OCONV(COST, 'MD2,') "R#12"
PRINT V.LINE
RETURN
***   ROUTINE TO PRINT THE TOTAL VALUES
25000*
IF LINE.COUNT + 2 > 56 THEN GOSUB 80000
LINE.COUNT=LINE.COUNT + 2
T.LINE=''
T.LINE=T.LINE :SPACE(47):"TOTAL FOR PRODUCT  ":PREV.PRO "L#15":SPACE(15)
TOT.ON.HAND=INT(((TOT.ON.HAND/ICR.DV1)*ICR.MT1)/ICR.DV2 + .5)
B.ON.HAND=B.ON.HAND + TOT.ON.HAND
T.LINE=T.LINE : OCONV(TOT.ON.HAND, ICR.CNV) "R#10" : SPACE(11)
T.LINE=T.LINE : OCONV(TOT.COST, 'MD2,') "R#12"
PRINT DT.LINE
PRINT T.LINE
***   CLEARING THE TOTAL VALUES
PREV.PRO=PROD
PREV.DESC=INV.FULL.DESC
TOT.COST=0
TOT.ON.HAND=0
RETURN
35000*
IF LINE.COUNT + 2 > 56 THEN GOSUB 80000
LINE.COUNT=LINE.COUNT + 2
T.LINE=''
T.LINE=T.LINE :SPACE(47):"TOTAL FOR BASIS WEIGHT  ":OCONV(PREV.B, "MD2") "R#8":SPACE(17)
M.P.ON.HAND=M.P.ON.HAND + B.ON.HAND
T.LINE=T.LINE : OCONV(B.ON.HAND, ICR.CNV) "R#10" : SPACE(11)
T.LINE=T.LINE : OCONV(B.COST, 'MD2,') "R#12"
PRINT DT.LINE
PRINT T.LINE
***   CLEARING THE TOTAL VALUES
PREV.B=INV.BAS.WT
B.COST=0
B.ON.HAND=0
RETURN
45000*
IF LINE.COUNT + 2 > 56 THEN GOSUB 80000
LINE.COUNT=LINE.COUNT + 2
T.LINE=''
T.LINE=T.LINE:SPACE(47):"TOTAL FOR MLINE / PLINE  ":PREV.M.P.LINE"L#17":SPACE(7)
T.LINE=T.LINE : OCONV(M.P.ON.HAND, ICR.CNV) "R#10" : SPACE(11)
T.LINE=T.LINE : OCONV(M.P.COST, 'MD2,') "R#12"
PRINT DT1.LINE
PRINT T.LINE
***   CLEARING THE TOTAL VALUES
PREV.M.P.LINE= INV.M.LINE:" / ":INV.LINE
M.P.COST=0
M.P.ON.HAND=0
RETURN
55000*
IF LINE.COUNT + 2 > 56 THEN GOSUB 80000
LINE.COUNT=LINE.COUNT + 2
T.LINE=''
T.LINE=T.LINE :SPACE(47):"TOTAL FOR WAREHOUSE  ":PREV.W "L#4":SPACE(45)
T.LINE=T.LINE : OCONV(W.COST, 'MD2,') "R#12"
PRINT
PRINT T.LINE
***   CLEARING THE TOTAL VALUES
PREV.W=WHSE
W.COST=0
RETURN
***  ROUTINE TO PRINT HEADINGS
80000*
PRINT CHAR(12)
PAGE.NO=PAGE.NO + 1
PRINT HD1:PAGE.NO
PRINT HD2
*C40094 v
IF PERIOD<1,1> # '' THEN
  PRINT SPACE(65):"FOR PERIOD : ":SEL.PERIOD
END ELSE
  PRINT
END
*C40094 ^
PRINT "WAREHOUSE : ":PREV.W
PRINT "MLINE / PLINE : ":PREV.M.P.LINE
PRINT
PRINT HH.LINE
PRINT DH.LINE
LINE.COUNT=8
RETURN
*
***   CALLS FOR SYSCOM
91000*
ERR.TYPE=1
CALL SYSCOM(MAT SYSCOM.REC)
RETURN
92000*
ERR.TYPE=2
CALL SYSCOM(MAT SYSCOM.REC)
RETURN
93000*
ERR.TYPE=3
CALL SYSCOM(MAT SYSCOM.REC)
999999*
PRINTER OFF
END
