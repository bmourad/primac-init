*COPY>CPYLIB>COM1
****************************************************************
*
* REVISION - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
*
* PROGRAM       - EST.LS.COMPETITOR.RPT
*
* SYSTEM        - JESBP
*
* BY            - RHONDA PERRIN, COMPUTER BUSINESS ASSOCIATES
*
* DATE          - 04/27/86
*
* DESCRIPTION   -
* This program produces a Lost Sales report by Salesman.
*
* CSF 21214 GAT 062494 CHANGE TO SHOW MIN AND MAX MARGIN
*
*T26138 cm 10/05/2001 * Expand Min/Max field and add commas.
*T26493 cmykleb 04/26/2002 * Change rpt to get the rpt # from the proc
*                            and use GET.PROG.HEAD for the heading.
*ENDDOC
****************************************************************
*
*---- FILE EQUATES
*
*COPY>CPYLIB>SYSCOM
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>FILE.VARS
*COPY>PMC.CPYLIB>COMPANY
*COPY>PMC.CPYLIB>VEND
*COPY>PMC.CPYLIB>SALESMAN
*COPY>JES.CPYLIB>ESTIMATE.LOST.SALES
*COPY>JES.CPYLIB>COMPETITOR
*
*---- SETUP FOR SYSTEM ERROR MESSAGES
*
     SYS.TYPE=1
     CALL SI_SYSCOM(MAT SYSCOM.REC)
*
*---- PROCREAD
*
     PROCREAD ID ELSE ERRMSG = "MUST BE RUN FROM A PROC";GOSUB 91000;GOTO 99999
     DATE1 = ID<4>
     DATE2 = ID<5>
*
*---- OPEN FILES
*
     OPEN '','COMPANY' TO COMPANY ELSE ERRMSG='COMPANY FILE MISSING';GOTO 93000
     OPEN '','CONTROL' TO CONTROL ELSE ERRMSG='CONTROL FILE MISSING';GOTO 93000
     OPEN '','COMPETITOR' TO COMPETITOR ELSE ERRMSG='COMPETITOR FILE MISSING';GOTO 93000
     OPEN '','ESTIMATE.LOST.SALES' TO ESTIMATE.LOST.SALES ELSE ERRMSG='ESTIMATE.LOST.SALES FILE MISSING';GOTO 93000
     OPEN '','SALESMAN' TO SALESMAN ELSE ERRMSG='SALESMAN FILE MISSING';GOTO 93000
*
*---- GET COMPANY NUMBER
*
     CONO=""
     CALL GET.CONO(CONO,MAT COMP.REC)
     IF CONO='END' THEN GOTO 99999
*
*---- INITIALIZATION
*
     FRST.TIME = 1
     PG.NO=0
     LINE.CNT=0
     ERRMSG=""
     PREV.SLSM = ""
     PREV.VEND = ""
     VEND.DESC = ""
     UNKNOWN=STR("?",30)
     SP = " "
     NODATA=1
*T26493 v
*    K = SPACE(INT((50 - LEN(CO.NAME)) / 2))
*    CONAME = K:CO.NAME:K
*    CONAME = CONAME "L#50"
*    HEAD1 = OCONV(DATE(),"D2/"):SPACE(33):CONAME:SPACE(32):"PAGE  "
*    HEAD2 = SPACE(50):"L O S T   S A L E S   R E P O R T"
*    HEAD3 = SPACE(60):"BY COMPETITOR"
*    HEAD4 = SPACE(51):"PERIOD ":DATE1:" THROUGH ":DATE2
     CONAME = ""
     RPT.NAME = ""
     RPT.NO = ID<2>
     HEAD1 = ""
     HEAD2 = ""
     CALL GET.PROG.HEAD(CONO,CONAME,RPT.NAME,RPT.NO,"",HEAD1,HEAD2)
     HEAD4 = SPACE(59):"PERIOD ":DATE1:" THROUGH ":DATE2
*T26493 ^
     HEAD5 = "COMPETITOR : "
*T26138 v
*    HEAD6 = SPACE(122):"MIN/MAX"
*    HEAD7 = "  DATE    ESTIMATE        CUSTOMER / PROSPECT       REASON            COMMENTS                       SALESREP             MARGIN $"
*    HEAD8 = "-------- ----------- ------------------------------ ------ ------------------------------ ------------------------------ ---------"
     HEAD6 = SPACE(122):"MIN/MAX"
     HEAD7 = "  DATE   ESTIMATE      CUSTOMER / PROSPECT       REASON            COMMENTS                       SALESREP               MARGIN $"
     HEAD8 = "-------- -------- ------------------------------ ------ ------------------------------ ------------------------------ -----------"
*T26138 ^
     PRINTER ON
*
*---- MAIN PROCESSING
*
10*
     READNEXT ESTLS.KEY ELSE 
        IF NODATA THEN GOTO 99999
        GOTO 15
     END
     MATREAD ESTLS.REC FROM ESTIMATE.LOST.SALES,ESTLS.KEY ELSE GOTO 10
     NODATA=0
     VEND.NO = ESTLS.COMPETITOR
     IF PREV.VEND # VEND.NO OR FRST.TIME THEN
        MATREAD COMPETITOR.REC FROM COMPETITOR,CONO:ESTLS.COMPETITOR ELSE COMPTR.NAME = ""
        VEND.DESC=COMPTR.NAME
        GOSUB 20
        PREV.VEND=VEND.NO
     END
     C.CNT = COUNT(ESTLS.COMMENTS,VM) + (ESTLS.COMMENTS # "")
     DATE = OCONV(ESTLS.DATE.ENTERED,"D2-") "L#8"
*T26138 v
*    EST.NO = ESTLS.KEY[4,99] "L#11"
     EST.NO = ESTLS.KEY[4,99] "L#8"
*T26138 ^
     CUST = ESTLS.CUST.NAME "L#30"
     REASON = ESTLS.CODE "L#6"
     COMMENT = ESTLS.COMMENTS<1,1> "L#30"
     SLSM = ESTLS.SALESMAN
     IF PREV.SLSM # SLSM THEN
        MATREAD SALESMAN.REC FROM SALESMAN,CONO:SLSM ELSE SALS.NAME = "SALESREP UNKNOWN"
        PREV.SLSM = ESTLS.COMPETITOR
     END
     SLSM.NAME = SALS.NAME "L#30"
*T26138 v
*    ESTLS.MIN.MARGIN = INT(ESTLS.MIN.MARGIN) "R#9"
*    ESTLS.MAX.MARGIN = INT(ESTLS.MAX.MARGIN) "R#9"
     ESTLS.MIN.MARGIN = OCONV(INT(ESTLS.MIN.MARGIN),"MD0,") "R#11"
     ESTLS.MAX.MARGIN = OCONV(INT(ESTLS.MAX.MARGIN),"MD0,") "R#11"
*T26138 ^
     GOSUB 30
     GOTO 10
15*
     PRINTER OFF
     GOTO 99999
*
*---- PRINT THE HEADINGS
*
20*
     FRST.TIME = 0
     PRINT CHAR(12)
     PG.NO=PG.NO + 1
     PRINT HEAD1:PG.NO
     PRINT HEAD2
*T26493     PRINT HEAD3
     PRINT HEAD4
     PRINT
     PRINT HEAD5:VEND.NO:"  ":VEND.DESC
     PRINT
     PRINT
     PRINT HEAD6
     PRINT HEAD7
     PRINT HEAD8
     PRINT
     LINE.CNT = 12
     RETURN
*
*---- PRINT THE VALUES
*
30*
     IF LINE.CNT >= 55 THEN GOSUB 20
     PRINT DATE:SP:EST.NO:SP:CUST:SP:REASON:SP:COMMENT:SP:SLSM.NAME:SP:ESTLS.MIN.MARGIN
     LINE.CNT = LINE.CNT + 1
*T26138 v
*    PRINT SPACE(59):ESTLS.COMMENTS<1,2> "L#30":SPACE(32):ESTLS.MAX.MARGIN
     PRINT SPACE(57):ESTLS.COMMENTS<1,2> "L#30":SPACE(31):ESTLS.MAX.MARGIN
*T26138 ^
     LINE.CNT = LINE.CNT + 1
     IF ESTLS.COMMENTS<1,3> # "" THEN
*T26138 v
*       PRINT SPACE(59):ESTLS.COMMENTS<1,3> "L#30"
        PRINT SPACE(57):ESTLS.COMMENTS<1,3> "L#30"
*T26138 ^
        LINE.CNT = LINE.CNT + 1
     END
     RETURN
*
*---- CALLS FOR SYSCOM
*
91000*
     ERR.TYPE=1
     CALL SI_SYSCOM(MAT SYSCOM.REC)
     RETURN
93000*
     PRINTER OFF
     ERR.TYPE=3
     CALL SI_SYSCOM(MAT SYSCOM.REC)
99999*
     END
