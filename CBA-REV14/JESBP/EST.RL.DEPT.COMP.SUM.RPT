   SUBROUTINE EST.RL.DEPT.COMP.SUM.RPT (CONO, CO.NAME, EST.KEY,JOB.DESC, PAGE.NO,PRT.QTY)
*********************************************************************
* REVISION - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* PROGRAM  - EST.DEPT.COMP.SUM.RPT
* AUTHOR   - RHONDA PERRIN, COMPUTER BUSINESS ASSOCIATES
* DATE     - 03/21/86
* DESCRIPTION
* This subroutine will print estimate data summarized by department and
* component. Data may be summarized for one or all components for the
* specified order quantity.
* TASK 18171 6/10/94 LMR
**
* MOD TASK 17918 DMT 10/10/94 ADD BACK MARGIN CALC
*T26138 cm 09/14/2001 * Expand estimate qty from 8 to 9 digits.
*********************************************************************
*
*---- COPY STATEMENTS
*
*COPY>JES.CPYLIB>SCOMMON.ESTIMATE
*COPY>JES.CPYLIB>ESTIMATE
*COPY>JES.CPYLIB>EST.DEPT.COMP.SUM
*COPY>JES.CPYLIB>JES.FILE.VARS
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>SYSCOM
   MAT SYSCOM.REC =  ""; SYS.TYPE = 2
*
*---- DIMENSIONED VARIABLES
*
   DIM TOT.REC(20)
   DIM DEPT.TTL(20)
*
*---- INITIALIZATION
*
   SP = " "
   SP2 = "  "
   SP3 = "   "
   SP4 = "    "
   SP5 = "     "
*18484 v
   QCNT = DCOUNT(PRT.QTY,SVM)
   QPTR = ''
   FOR Q = 1 TO QCNT
      LOCATE PRT.QTY<1,1,Q> IN EST.QTY<1>,1 SETTING Q1 THEN
         QPTR<1,Q> = Q1
      END
   NEXT Q
   IF QCNT > 3 THEN QCNT = 3
*T26138 v
*  QTY1 = OCONV(EST.QTY<1,QPTR<1,1>>,"MD0,") "R#10"
*  QTY2 = OCONV(EST.QTY<1,QPTR<1,2>>,"MD0,") "R#10"
*  QTY3 = OCONV(EST.QTY<1,QPTR<1,3>>,"MD0,") "R#10"
   QTY1 = OCONV(EST.QTY<1,QPTR<1,1>>,"MD0,") "R#11"
   QTY2 = OCONV(EST.QTY<1,QPTR<1,2>>,"MD0,") "R#11"
   QTY3 = OCONV(EST.QTY<1,QPTR<1,3>>,"MD0,") "R#11"
*T26138 ^
*18484 ^      
   LINE = STR("_",11)
   SLINE = STR("_",7)
   LLINE = STR("_",14)
   N = ((50 - LEN(CO.NAME)) / 2)
   COMPY.NAME = SPACE(N):CO.NAME:SPACE(N)
   HD1 = OCONV(DATE(),"D2/"):SPACE(33):COMPY.NAME:SPACE(30):"PAGE: "
   HD2 = SPACE(43):"E S T I M A T E   S U M M A R Y   R E P O R T"
   HD2A = SPACE(59):"BY DEPARTMENT"
   HD3 = "ESTIMATE : ":EST.KEY "L#12":"    ":EST.CUST.NAME "L#40":"    ":JOB.DESC "L#60"
   HD4 = SPACE(47):"<---------------------------- QUANTITY # "
   HD4A = " --------------------------->"
   HD5 = SPACE(47):                                     "RECOMMENDED    MARKUP     CUSTOMER      RECOMMENDED SELL   MARKUP    CUSTOMER QUOTE"
   HD6 = "     DEPARTMENT                                    SELL          %         QUOTE           ADDTL/M           %         ADDTL/M"
   HD8 = "-------------------------------------------    ------------   -------   -----------    ----------------   -------   --------------"
   MAT TOT.REC = ""
   MAT DEPT.TTL = ""
   DSEL = "ALL"
   CSEL = "ALL"
*
*---- MAIN PROCESSING
*
100*
   FOR R = 1 TO QCNT
      QTY.CNT = R
      QSEL = EST.QTY<1,QPTR<1,R>> ;* 18484
      MAT DSUM.REC2 = ""
      CALL EST.DEPT.COMP.SUB(CONO,EST.KEY,DSEL,CSEL,QSEL,MAT DSUM.REC2)
      GOSUB 300
   NEXT R
   PRINTER ON
   FOR QTY.CNT = 1 TO QCNT
      GOSUB 200
      GOSUB 400
   NEXT QTY.CNT
   PRINTER OFF
   GOTO 99999
*
*---- PRINT HEADING
*
200*
   PRINT CHAR(12)
   PAGE.NO = PAGE.NO + 1
   PRINT HD1:PAGE.NO
   PRINT HD2
   PRINT HD2A
   PRINT
   PRINT HD3
   PRINT
*T26138 v
*  BEGIN CASE
*     CASE QTY.CNT = 1
*        PRINT HD4:"1: ":QTY1"R#10":HD4A
*     CASE QTY.CNT = 2
*        PRINT HD4:"2: ":QTY2"R#10":HD4A
*     CASE QTY.CNT = 3
*        PRINT HD4:"3: ":QTY3"R#10":HD4A
*  END CASE
   BEGIN CASE
      CASE QTY.CNT = 1
         PRINT HD4:"1: ":QTY1"R#11":HD4A
      CASE QTY.CNT = 2
         PRINT HD4:"2: ":QTY2"R#11":HD4A
      CASE QTY.CNT = 3
         PRINT HD4:"3: ":QTY3"R#11":HD4A
   END CASE
*T26138 ^
   PRINT HD5
   PRINT HD6
   PRINT HD8
   PRINT
   LINE.CNT = 11
   RETURN
*
*---- CREATE TABLE
*
300*
   DCNT = COUNT(DSUM.DEPT,VM) + (DSUM.DEPT # "")
   FOR DD = 1 TO DCNT
      LOCATE DSUM.DEPT<1,DD> IN TOT.REC(1)<1>,1 SETTING YY ELSE
         YY = COUNT(TOT.REC(1),VM) + (TOT.REC(1) # "") + 1
         IF QTY.CNT = 1 THEN
            TOT.REC(1)<1,YY> = DSUM.DEPT<1,DD>
            TOT.REC(2)<1,YY> = DSUM.DEPT.DESC<1,DD>
         END
      END
      B = 2 + QTY.CNT
      TOT.REC(B)<1,YY> = TOT.REC(B)<1,YY> + DSUM.COMP.LABOR.SALE<1,DD> + DSUM.COMP.MATL.SALE<1,DD> + DSUM.COMP.OSP.SALE<1,DD> + DSUM.COMP.SHIP.SALE<1,DD> + DSUM.COMP.MISC.SALE<1,DD>
      DEPT.TTL(QTY.CNT)<1,YY> = DEPT.TTL(QTY.CNT)<1,YY> + TOT.REC(B)<1,YY>
      BD = 5 + QTY.CNT
      TOT.VAR = TOT.REC(B)<1,YY> - DSUM.COMP.SETUP.SALE<1,DD>
      NEW.QTY = INT(((TOT.VAR/EST.QTY<1,QTY.CNT>)*1000)+.5)
      TOT.REC(BD)<1,YY> = TOT.REC(BD)<1,YY> + NEW.QTY
      DEPT.TTL(QTY.CNT+3)<1,YY> = DEPT.TTL(QTY.CNT+3)<1,YY> + NEW.QTY
   NEXT DD
   RETURN
*
*---- PRINT DETAIL LINES
*
400*
   TCNT = COUNT(TOT.REC(1),VM) + (TOT.REC(1) # "")
   FOR ZZ = 1 TO TCNT
      PLINE = TOT.REC(1)<1,ZZ> "L#5":SP:TOT.REC(2)<1,ZZ> "L#16":SP
      PLINE = PLINE:SPACE(20):SP4:OCONV(TOT.REC(QTY.CNT+2)<1,ZZ>,"MD2")"R#12":SP3:SLINE:SP3:LINE:SP4
      PLINE = PLINE:SP2:OCONV(TOT.REC(QTY.CNT+5)<1,ZZ>,"MD2")"R#12":SP5:SLINE:SP3:LLINE
      PRINT PLINE
      PRINT
      LINE.CNT = LINE.CNT + 2
      IF LINE.CNT >= 53 THEN GOSUB 200
      PLINE = ""
   NEXT ZZ
   PRINT
   GLINE = SPACE(31):"GRAND TOTALS    ":OCONV(SUM(DEPT.TTL(QTY.CNT)),"MD2")"R#12":SP3:SLINE:SP3:LINE:SP4
   GLINE = GLINE:SP2:OCONV(SUM(DEPT.TTL(QTY.CNT+3)),"MD2")"R#12":SP5:SLINE:SP3:LLINE
   PRINT GLINE
   RETURN
*
*---- ERROR ROUTINE
*
90000 ERR.TYPE=1;CALL SI_SYSCOM(MAT SYSCOM.REC);RETURN
*
*---- END OF PROGRAM
*
99999*
   RETURN
END
