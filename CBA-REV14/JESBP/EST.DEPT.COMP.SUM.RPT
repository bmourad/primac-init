   SUBROUTINE EST.DEPT.COMP.SUM.RPT (CONO, CO.NAME, EST.KEY,JOB.DESC, PAGE.NO,PRT.QTY,HD1,HD2)
*********************************************************************
* REVISION - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* PROGRAM  - EST.DEPT.COMP.SUM.RPT
* AUTHOR   - RHONDA PERRIN, COMPUTER BUSINESS ASSOCIATES
* DATE     - 03/21/86
* DESCRIPTION
* This subroutine will print estimate data summarized by department and
* component. Data may be summarized for one or all components for the
* specified order quantity.
* MOD TASK 18148 DMT 7/6/94 PRINT SELECTED QUANTITIES
*T26138 cm 09/13/2001 * Expand estimate qty from 8 to 9 digits.
*T26090 cmykleb 04/04/2002 * Change rpt to use rpt heading from call pgm.
*T27924 cmykleb 03/22/2004 * Allow to print up to 6 qtys or all.
*********************************************************************
*
*---- COPY STATEMENTS
*
*COPY>JES.CPYLIB>SCOMMON.ESTIMATE
*COPY>JES.CPYLIB>ESTIMATE
*COPY>JES.CPYLIB>EST.DEPT.COMP.SUM
*COPY>JES.CPYLIB>JES.FILE.VARS
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>SYSCOM
   MAT SYSCOM.REC =  ""; SYS.TYPE = 2
*
*---- DIMENSIONED VARIABLES
*
   DIM TOT.REC(20)
   DIM DEPT.TTL(20)
   DIM COMP.TTL(20)
   DIM GRND.TTL(20)
*
*---- INITIALIZATION
*
   SP = " "
   SP2 = "  "
   SP3 = "   "
   SP4 = "    "
   SP5 = "     "
   QCNT = DCOUNT(PRT.QTY,SVM)
   QPTR = ''
*T27924 v
   IF PRT.QTY = 'ALL' THEN
      QCNT = DCOUNT(EST.QTY<1>,VM)
      FOR Q = 1 TO QCNT
         QPTR<1,Q> = Q
      NEXT Q
   END ELSE
*T27924 ^
      FOR Q = 1 TO QCNT
         LOCATE PRT.QTY<1,1,Q> IN EST.QTY<1>,1 SETTING Q1 THEN
            QPTR<1,Q> = Q1
         END
      NEXT Q
*T27924 v
   END
   HPTR = QPTR
   XCNT = 0
   HCNT = INT(QCNT / 3)
   IF REM(QCNT,3) GT 0 THEN HCNT +=1
   FOR H = 1 TO HCNT
      QPTR = ''
      QCNT = ''
      IF HPTR<1,XCNT+1> # '' THEN QPTR<1,1> = HPTR<1,XCNT+1>; QCNT += 1
      IF HPTR<1,XCNT+2> # '' THEN QPTR<1,2> = HPTR<1,XCNT+2>; QCNT += 1
      IF HPTR<1,XCNT+3> # '' THEN QPTR<1,3> = HPTR<1,XCNT+3>; QCNT += 1
      XCNT += 3
*T27924 ^
*T26138 v
*     QTY1 = OCONV(EST.QTY<1,QPTR<1,1>>,"MD0,") "R#10"
*     QTY2 = OCONV(EST.QTY<1,QPTR<1,2>>,"MD0,") "R#10"
*     QTY3 = OCONV(EST.QTY<1,QPTR<1,3>>,"MD0,") "R#10"
      QTY1 = OCONV(EST.QTY<1,QPTR<1,1>>,"MD0,") "R#11"
      QTY2 = OCONV(EST.QTY<1,QPTR<1,2>>,"MD0,") "R#11"
      QTY3 = OCONV(EST.QTY<1,QPTR<1,3>>,"MD0,") "R#11"
*T26138 ^
      LINE = STR("_",11)
      SLINE = STR("_",7)
      LLINE = STR("_",14)
*T26090 v
*  N = ((50 - LEN(CO.NAME)) / 2)
*  COMPY.NAME = SPACE(N):CO.NAME:SPACE(N)
*  HD1 = OCONV(DATE(),"D2/"):SPACE(33):COMPY.NAME:SPACE(30):"PAGE: "
*  HD2 = SPACE(43):"E S T I M A T E   S U M M A R Y   R E P O R T"
*  HD2A = SPACE(59):"BY DEPARTMENT"
      HD2A = SPACE(57):"ESTIMATE SUMMARY REPORT - BY DEPARMENT"
*T26090 ^
      HD3 = "ESTIMATE : ":EST.KEY "L#12":"    ":EST.CUST.NAME "L#40":"    ":JOB.DESC "L#60"
      HD4 = SPACE(47):"<---------------------------- QUANTITY # "
      HD4A = " -------------------------->"
      HD5 = SPACE(47):                                     "RECOMMENDED    MARKUP     CUSTOMER      RECOMMENDED SELL   MARKUP    CUSTOMER QUOTE"
      HD6 = "     DEPARTMENT             COMPONENT              SELL          %         QUOTE           ADDTL/M           %         ADDTL/M"
      HD8 = "---------------------- --------------------   --------------  -------   -----------    ----------------   -------   --------------"
      MAT TOT.REC = ""
      MAT DEPT.TTL = ""
      MAT COMP.TTL = ""
      MAT GRND.TTL = ""
      DSEL = "ALL"
      CSEL = "ALL"
*
*---- MAIN PROCESSING
*
100*
      FOR R = 1 TO QCNT
         QTY.CNT = R
         QSEL = EST.QTY<1,QPTR<1,R>>
         MAT DSUM.REC2 = ""
         CALL EST.DEPT.COMP.SUB(CONO,EST.KEY,DSEL,CSEL,QSEL,MAT DSUM.REC2)
         GOSUB 300
      NEXT R
      PRINTER ON
      FOR QTY.CNT = 1 TO QCNT
         GOSUB 200
         GOSUB 400
      NEXT QTY.CNT
   NEXT H ; * T27924
   PRINTER OFF
   GOTO 99999
*
*---- PRINT HEADING
*
200*
   PRINT CHAR(12)
   PAGE.NO = PAGE.NO + 1
   PRINT HD1:PAGE.NO
   PRINT HD2
   PRINT
   PRINT HD3
   PRINT
*T26138 v
*  BEGIN CASE
*  CASE QTY.CNT = 1
*     PRINT HD4:"1: ":QTY1"R#10":HD4A
*  CASE QTY.CNT = 2
*     PRINT HD4:"2: ":QTY2"R#10":HD4A
*  CASE QTY.CNT = 3
*     PRINT HD4:"3: ":QTY3"R#10":HD4A
*  END CASE
*T27924 v
*  BEGIN CASE
*     CASE QTY.CNT = 1
*        PRINT HD4:"1: ":QTY1"R#11":HD4A
*     CASE QTY.CNT = 2
*        PRINT HD4:"2: ":QTY2"R#11":HD4A
*     CASE QTY.CNT = 3
*        PRINT HD4:"3: ":QTY3"R#11":HD4A
*  END CASE
   BEGIN CASE
      CASE QTY.CNT = 1
         PRINT HD4:(XCNT-2)"R#2":QTY1"R#11":HD4A
      CASE QTY.CNT = 2
         PRINT HD4:(XCNT-1)"R#2":QTY2"R#11":HD4A
      CASE QTY.CNT = 3
         PRINT HD4:(XCNT)"R#2":QTY3"R#11":HD4A
   END CASE
*T27924 ^
*T26138 ^
   PRINT HD5
   PRINT HD6
   PRINT HD8
   PRINT
   LINE.CNT = 10
   RETURN
*
*---- CREATE TABLE
*
300*
   DCNT = COUNT(DSUM.DEPT,VM) + (DSUM.DEPT # "")
   FOR DD = 1 TO DCNT
      LOCATE DSUM.DEPT<1,DD> IN TOT.REC(1)<1>,1 SETTING YY ELSE
         YY = COUNT(TOT.REC(1),VM) + (TOT.REC(1) # "") + 1
         IF QTY.CNT = 1 THEN
            TOT.REC(1)<1,YY> = DSUM.DEPT<1,DD>
            TOT.REC(2)<1,YY> = DSUM.DEPT.DESC<1,DD>
         END
      END
      CCNT = COUNT(DSUM.COMP<1,DD>,SVM) + (DSUM.COMP<1,DD> # "")
      FOR CC = 1 TO CCNT
         IF QTY.CNT = 1 THEN
            TOT.REC(3)<1,YY,CC> = DSUM.COMP<1,DD,CC>
            TOT.REC(4)<1,YY,CC> = DSUM.COMP.DESC<1,DD,CC>
         END
         B = QTY.CNT + 4
         TOT.REC(B)<1,YY,CC> = TOT.REC(B)<1,YY,CC> + DSUM.COMP.LABOR.SALE<1,DD,CC> + DSUM.COMP.MATL.SALE<1,DD,CC> + DSUM.COMP.OSP.SALE<1,DD,CC> + DSUM.COMP.SHIP.SALE<1,DD,CC> + DSUM.COMP.MISC.SALE<1,DD,CC>
         BD = QTY.CNT + 7
         TOT.REC(BD)<1,YY,CC> = TOT.REC(BD)<1,YY,CC> + DSUM.COMP.LABOR.SALE<1,DD,CC> + DSUM.COMP.MATL.SALE<1,DD,CC> + DSUM.COMP.OSP.SALE<1,DD,CC> + DSUM.COMP.SHIP.SALE<1,DD,CC> + DSUM.COMP.MISC.SALE<1,DD,CC> - DSUM.COMP.SETUP.SALE<1,DD,CC>
         IF QTY.CNT = 1 THEN
            COMP.TTL(1)<1,CC> = DSUM.COMP.DESC<1,DD,CC>
         END
         G = QTY.CNT + 1
         COMP.TTL(G)<1,CC> = COMP.TTL(G)<1,CC> + TOT.REC(B)<1,YY,CC>
         GD = QTY.CNT + 4
         COMP.TTL(GD)<1,CC> = COMP.TTL(GD)<1,CC> + TOT.REC(BD)<1,YY,CC>
      NEXT CC
      DEPT.TTL(QTY.CNT)<1,YY> = DEPT.TTL(QTY.CNT)<1,YY> + DSUM.DEPT.LABOR.SALE<1,DD> + DSUM.DEPT.MATL.SALE<1,DD> + DSUM.DEPT.OSP.SALE<1,DD> + DSUM.DEPT.SHIP.SALE<1,DD> + DSUM.DEPT.MISC.SALE<1,DD>
      DEPT.TTL(QTY.CNT+3)<1,YY> = DEPT.TTL(QTY.CNT+3)<1,YY> + DSUM.DEPT.LABOR.SALE<1,DD> + DSUM.DEPT.MATL.SALE<1,DD> + DSUM.DEPT.OSP.SALE<1,DD> + DSUM.DEPT.SHIP.SALE<1,DD> + DSUM.DEPT.MISC.SALE<1,DD> - DSUM.DEPT.SETUP.SALE<1,DD>
   NEXT DD
   RETURN
*
*---- PRINT DETAIL LINES
*
400*
   TCNT = COUNT(TOT.REC(1),VM) + (TOT.REC(1) # "")
   FOR ZZ = 1 TO TCNT
      PLINE = TOT.REC(1)<1,ZZ> "L#5":SP:TOT.REC(2)<1,ZZ> "L#16":SP
      CP.CNT = COUNT(TOT.REC(3)<1,ZZ>,SVM) + (TOT.REC(3)<1,ZZ> # "")
      FOR CP = 1 TO CP.CNT
         IF TOT.REC(4)<1,ZZ,CP> # "" THEN
*T26138 v
*              PLINE = PLINE:TOT.REC(4)<1,ZZ,CP> "L#20":SP4:OCONV(TOT.REC(QTY.CNT+4)<1,ZZ,CP>,"MD2")"R#12":SP3:SLINE:SP3:LINE:SP4
            PLINE = PLINE:TOT.REC(4)<1,ZZ,CP> "L#20":SP3:OCONV(TOT.REC(QTY.CNT+4)<1,ZZ,CP>,"MD2,")"R#14":SP2:SLINE:SP3:LINE:SP4
*T26138 ^
            NEW.QTY = INT(((TOT.REC(QTY.CNT+7)<1,ZZ,CP>/EST.QTY<1,QTY.CNT>)*1000)+.5)
            PLINE = PLINE:SP2:OCONV(NEW.QTY,"MD2")"R#12":SP5:SLINE:SP3:LLINE
            PRINT PLINE
            PLINE = SPACE(23)
            LINE.CNT = LINE.CNT + 1
            IF LINE.CNT >= 53 THEN GOSUB 200
         END
      NEXT CP
*T26138 v
*        DLINE = SPACE(26):"DEPARTMENT TOTALS    ":OCONV(DEPT.TTL(QTY.CNT)<1,ZZ>,"MD2")"R#12":SP3:SLINE:SP3:LINE:SP4
      DLINE = SPACE(26):"DEPARTMENT TOTALS   ":OCONV(DEPT.TTL(QTY.CNT)<1,ZZ>,"MD2,")"R#14":SP2:SLINE:SP3:LINE:SP4
*T26138 ^
      NEW.QTY = INT(((DEPT.TTL(QTY.CNT+3)<1,ZZ>/EST.QTY<1,QTY.CNT>)*1000)+.5)
      DLINE = DLINE:SP2:OCONV(NEW.QTY,"MD2")"R#12":SP5:SLINE:SP3:LLINE
      PRINT DLINE
      PRINT
      LINE.CNT = LINE.CNT + 2
      IF LINE.CNT >= 53 THEN GOSUB 200
      PLINE = ""
      DLINE = ""
   NEXT ZZ
   CLINE = SPACE(4):"COMPONENT TOTALS   "
   COM.CNT = COUNT(COMP.TTL(1),VM) + (COMP.TTL(1) # "")
   FOR RR = 1 TO COM.CNT
*T26138 v
*        CLINE = CLINE:COMP.TTL(1)<1,RR> "L#20":SP4:OCONV(COMP.TTL(QTY.CNT+1)<1,RR>,"MD2")"R#12":SP3:SLINE:SP3:LINE:SP4
      CLINE = CLINE:COMP.TTL(1)<1,RR> "L#20":SP3:OCONV(COMP.TTL(QTY.CNT+1)<1,RR>,"MD2")"R#14":SP2:SLINE:SP3:LINE:SP4
*T26138 ^
      NEW.QTY = INT(((COMP.TTL(QTY.CNT+4)<1,RR>/EST.QTY<1,QTY.CNT>)*1000)+.5)
      CLINE = CLINE:SP2:OCONV(NEW.QTY,"MD2")"R#12":SP5:SLINE:SP3:LLINE
      PRINT CLINE
      CLINE = SPACE(23)
      LINE.CNT = LINE.CNT + 1
      IF LINE.CNT >= 53 THEN GOSUB 200
      GRND.TTL(QTY.CNT) = GRND.TTL(QTY.CNT) + COMP.TTL(QTY.CNT+1)<1,RR>
      GRND.TTL(QTY.CNT+3) = GRND.TTL(QTY.CNT+3) + COMP.TTL(QTY.CNT+4)<1,RR>
   NEXT RR
   PRINT
*T26138 v
*     GLINE = SPACE(31):"GRAND TOTALS    ":OCONV(GRND.TTL(QTY.CNT),"MD2")"R#12":SP3:SLINE:SP3:LINE:SP4
   GLINE = SPACE(31):"GRAND TOTALS   ":OCONV(GRND.TTL(QTY.CNT),"MD2")"R#14":SP2:SLINE:SP3:LINE:SP4
*T26138 ^
   NEW.QTY = INT(((GRND.TTL(QTY.CNT+3)/EST.QTY<1,QTY.CNT>)*1000)+.5)
   GLINE = GLINE:SP2:OCONV(NEW.QTY,"MD2")"R#12":SP5:SLINE:SP3:LLINE
   PRINT GLINE
   RETURN
*
*---- ERROR ROUTINE
*
90000 ERR.TYPE=1;CALL SI_SYSCOM(MAT SYSCOM.REC);RETURN
*
*---- END OF PROGRAM
*
99999*
   RETURN
END
