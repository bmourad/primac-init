   SUBROUTINE EST.RL.RECAP.RPT(CONO, CO.NAME, EST.KEY, PAGE.NO,PRT.QTY,HD1,HD2)
*********************************************************************
*
* REVISION - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
*
* PROGRAM  - EST.RECAP.RPT
*
* AUTHOR   - NICK AMENDOLA, COMPUTER BUSINESS ASSOCIATES
*
* DATE     - 05/12/86
*
* DESCRIPTION
*
* This subroutine prints the estimate summary by type 
*
*T26138 cm 09/13/2001 * Expand estimate qty from 8 to 9 digits.
*T26090 cmykleb 04/04/2002 * Change rpt to use rpt heading from call pgm.
*T27819 cmykleb 12/10/2003 * Add a % of sale column on report.
*********************************************************************
*
*---- COPY STATEMENTS
*
*COPY>JES.CPYLIB>SCOMMON.ESTIMATE
*COPY>JES.CPYLIB>ESTIMATE
*COPY>JES.CPYLIB>ESTIMATE.RL
*COPY>JES.CPYLIB>EST.RL.COST.TYPE.SUM
*COPY>JES.CPYLIB>JES.FILE.VARS
*COPY>PMC.CPYLIB>CUSTOMER
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>CHAR
*
*---- DEFINE DIMENSIONED VARIABLES
*
   DIM PHEAD(10)
   MAT PHEAD = ""
   PHEAD(1) = "Total Stock"
   PHEAD(2) = "Total Material - Ink"
   PHEAD(3) = "Total Material - Case"
   PHEAD(4) = "Total Material - Regular"
   PHEAD(5) = "Total Outside Purchases"
   PHEAD(6) = "Total Shipping"
   PHEAD(7) = "Total Miscellaneous"
   PHEAD(8) = "Total Labor"
*
   DIM PTABLE(20)
   MAT PTABLE = ""
   EQU PAPER.SALE TO PTABLE(1)
   EQU INK.SALE   TO PTABLE(2)
   EQU CASE.SALE  TO PTABLE(3)
   EQU OTHER.SALE TO PTABLE(4)
   EQU OS.SALE    TO PTABLE(5)
   EQU SP.SALE    TO PTABLE(6)
   EQU MS.SALE    TO PTABLE(7)
   EQU LB.SALE    TO PTABLE(8)
   EQU TOTAL.SALE TO PTABLE(10)
*T27819 v
   EQU PAPER.SALE.PCT TO PTABLE(11)
   EQU INK.SALE.PCT   TO PTABLE(12)
   EQU CASE.SALE.PCT  TO PTABLE(13)
   EQU OTHER.SALE.PCT TO PTABLE(14)
   EQU OS.SALE.PCT    TO PTABLE(15)
   EQU SP.SALE.PCT    TO PTABLE(16)
   EQU MS.SALE.PCT    TO PTABLE(17)
   EQU LB.SALE.PCT    TO PTABLE(18)
   EQU TOTAL.SALE.PCT TO PTABLE(19)
*T27819 ^
*
   LB.COPY = ""; LB.COLOR = ""; LB.VERSION = ""
   MT.COPY = ""; MT.COLOR = ""; MT.VERSION = ""
*
*---- INITIALIZATION
*
*T26090 v
*  HD1A = OCONV(DATE(),"D2/")
*  HD1B = SPACE((40-LEN(CO.NAME))/2):CO.NAME
*  HD1 = HD1A"L#46":HD1B"L#40":SPACE(34):"PAGE: "
*  HD2 = SPACE(45):"E S T I M A T E   R E C A P   R E P O R T"
   HD3 = SPACE(65):"ESTIMATE RECAP REPORT"
*T26090 ^
   MAT CUST.REC = ""
   IF EST.CUST = "P" THEN
      CUST.NAME = EST.CUST.NAME
   END ELSE
      MATREAD CUST.REC FROM CUSTOMER, CONO:EST.CUST ELSE
         MAT CUST.REC = ""
         CUST.NAME = EST.CUST.NAME
      END
   END
   HD4A = "Estimate : ":EST.KEY
   HD4B = CUST.NAME
   HD4C = EST.COMMENTS<1,1>
   HD4 = HD4A"L#27":HD4B"L#44":HD4C
*
*---- MAIN PROCESSING
*
   PRINTER ON
   GOSUB 10000
   MAT CSUM.REC = ""
* 18484 v
   EC = DCOUNT(PRT.QTY,SVM)
   QPTR = ''
   FOR Q = 1 TO EC
      LOCATE PRT.QTY<1,1,Q> IN EST.QTY<1>,1 SETTING Q1 THEN
         QPTR<1,Q> = Q1
      END
   NEXT Q
*18484 ^
   IF EC > 3 THEN EM = 3 ELSE EM = EC
   FOR EP = 1 TO EC
      QSEL = EST.QTY<1,QPTR<1,EP>>  ;* 18484
      CALL EST.RES.COST.TYPE.SUB (CONO, EST.KEY, "ALL", "ALL", QSEL, MAT CSUM.REC)
      IF CSUM.TOT.SALE + 0 GT 0 THEN ; * T27819
         PAPER.SALE<EP>=CSUM.MT.SALE.DET<1,1>
         INK.SALE<EP>=CSUM.MT.SALE.DET<1,2>
         CASE.SALE<EP>=CSUM.MT.SALE.DET<1,5>
         OTHER.SALE<EP>=CSUM.MT.SALE-PAPER.SALE<EP>-INK.SALE<EP>-CASE.SALE<EP>
         OS.SALE<EP>=CSUM.OS.SALE
         SP.SALE<EP>=CSUM.SP.SALE
         MS.SALE<EP>=CSUM.MS.SALE
         LB.SALE<EP>=CSUM.LB.SALE
         TOTAL.SALE<EP>=CSUM.TOT.SALE
*T27819 v
         PAPER.SALE.PCT<EP>=PAPER.SALE<EP> / CSUM.TOT.SALE
         INK.SALE.PCT<EP>=INK.SALE<EP> / CSUM.TOT.SALE
         CASE.SALE.PCT<EP>=CASE.SALE<EP> / CSUM.TOT.SALE
         OTHER.SALE.PCT<EP>=OTHER.SALE<EP> / CSUM.TOT.SALE
         OS.SALE.PCT<EP>=OS.SALE<EP> / CSUM.TOT.SALE
         SP.SALE.PCT<EP>=SP.SALE<EP> / CSUM.TOT.SALE
         MS.SALE.PCT<EP>=MS.SALE<EP> / CSUM.TOT.SALE
         LB.SALE.PCT<EP>=LB.SALE<EP> / CSUM.TOT.SALE
         TOTAL.SALE.PCT<EP>=PAPER.SALE.PCT<EP>+INK.SALE.PCT<EP>
         TOTAL.SALE.PCT<EP>+=CASE.SALE.PCT<EP>+OTHER.SALE.PCT<EP>
         TOTAL.SALE.PCT<EP>+=OS.SALE.PCT<EP>+SP.SALE.PCT<EP>
         TOTAL.SALE.PCT<EP>+=MS.SALE.PCT<EP>+LB.SALE.PCT<EP>
         IF TOTAL.SALE.PCT<EP> > 1.0 THEN TOTAL.SALE.PCT<EP> = 10000
*T27819 ^
         LB.COPY<EP> = CSUM.LB.COPY
         LB.COLOR<EP> = CSUM.LB.COLOR
         LB.VERSION<EP> = CSUM.LB.VERSION
         MT.COPY<EP> = CSUM.MT.COPY
         MT.COLOR<EP> = CSUM.MT.COLOR
         MT.VERSION<EP> = CSUM.MT.VERSION
      END ; * T27819
   NEXT EP
   PLINE="""L#27"
   FOR EP = 1 TO EM
      QQ = OCONV(EST.QTY<1,QPTR<1,EP>>,"MD0,")
*T26138 v
*     QQ = QQ:SPACE((9-LEN(QQ))/2)
*     PLINE=PLINE:SPACE(4):"<------ ":QQ"R#9":" ------->"
      QQ = QQ:SPACE((11-LEN(QQ))/2)
*T27819 v
*     PLINE=PLINE:SPACE(4):"<------ ":QQ"R#11":" ------->"
      PLINE=PLINE:SPACE(1):"<--------- ":QQ"R#11":" ---------->"
*T26138 ^
   NEXT EP
   PRINT PLINE
   PLINE="""L#27"
   FOR EP = 1 TO EM
*T26138 v
*     PLINE=PLINE:SPACE(4):" Recommended":SPACE(2):"  Customer  "
*T27819 v
*     PLINE=PLINE:SPACE(5):"Recommended":SPACE(6):"Customer  "
      PLINE=PLINE:"   Recommended  Percent  Customer  "
*T27819 ^
*T26138 ^
   NEXT EP
   PRINT PLINE
   PLINE="         Description          ""L#27"
   FOR EP = 1 TO EM
*T26138 v
*     PLINE=PLINE:SPACE(4):"    Sell    ":SPACE(2):"    Quote   "
*T27819 v
*     PLINE=PLINE:SPACE(4):"    Sell    ":SPACE(4):"    Quote   "
      PLINE=PLINE:"       Sell     of Sell    Quote   "
*T27819 ^
*T26138 ^
   NEXT EP
   PRINT PLINE
   PLINE="------------------------------""L#27"
   FOR EP = 1 TO EM
*T26138 v
*     PLINE=PLINE:SPACE(4):"------------":SPACE(2):"------------"
*T27819 v
*     PLINE=PLINE:SPACE(4):"--------------":SPACE(2):"------------"
      PLINE=PLINE:" -------------- ------- -----------"
*T27819 ^
*T26138 ^
   NEXT EP
   PRINT PLINE
   FOR PP = 1 TO 10
      IF PHEAD(PP) # "" AND SUM(PTABLE(PP)) + 0 GT 0 THEN
         PRINT
         PLINE=PHEAD(PP)"L#27"
         FOR EP = 1 TO EM
*T26138 v
*           PLINE=PLINE:SPACE(4):OCONV(PTABLE(PP)<EP>,"MD2Z,")"R#12":SPACE(2):"____________"
*T27819 v
*           PLINE=PLINE:SPACE(4):OCONV(PTABLE(PP)<EP>,"MD2Z,")"R#14":SPACE(2):"____________"
            PLINE=PLINE:SPACE(1):OCONV(PTABLE(PP)<EP>,"MD2Z,")"R#14"
            PTABLE(PP+10)<EP> = ICONV(PTABLE(PP+10)<EP>,"MD4")
            PLINE=PLINE:SPACE(1):OCONV(PTABLE(PP+10)<EP>,"MD2")"R#6":"%"
            PLINE=PLINE:SPACE(1):"___________"
*T27819 ^
*T26138 ^
         NEXT EP
         PRINT PLINE
      END
   NEXT PP
   PRINT
   PRINT
   PRINT
   PLINE="**** Estimate Total ****""L#27"
   FOR EP = 1 TO EM
*T26138 v
*     PLINE=PLINE:SPACE(4):OCONV(TOTAL.SALE<EP>,"MD2Z,")"R#12":SPACE(2):"____________"
*T27819 v
*     PLINE=PLINE:SPACE(4):OCONV(TOTAL.SALE<EP>,"MD2Z,")"R#14":SPACE(2):"____________"
      PLINE=PLINE:SPACE(1):OCONV(TOTAL.SALE<EP>,"MD2Z,")"R#14"
      TOTAL.SALE.PCT<EP> = ICONV(TOTAL.SALE.PCT<EP>,"MD4")
      IF TOTAL.SALE.PCT<EP> > 10000 THEN TOTAL.SALE.PCT<EP> = 10000
      PLINE=PLINE:SPACE(1):OCONV(TOTAL.SALE.PCT<EP>,"MD2")"R#6":"%"
      PLINE=PLINE:SPACE(1):"___________"
*T27819 ^
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINT
   PRINT
   PLINE="APPLIED : "
   BEGIN CASE
      CASE EST.RL.APPLY = "H"
         PLINE=PLINE:"Hand"
      CASE EST.RL.APPLY = "M"
         PLINE=PLINE:"Machine"
      CASE EST.RL.APPLY = "P"
         PLINE=PLINE:"Pharmaceutical"
   END CASE
   PRINT PLINE
   PRINT;PRINT
   PPT = ""
   FOR EP = 1 TO EM
      PPT<EP> = INT(TOTAL.SALE<EP>/(EST.QTY<1,EP>/1000)+0.5)
   NEXT EP
   PLINE="Recommended Sell Per 1,000""L#27"
   FOR EP = 1 TO EM
*T26138 v
*     PLINE=PLINE:SPACE(4):OCONV(PPT<EP>,"MD2Z,")"R#12":SPACE(2):"____________"
*T27819 v
*     PLINE=PLINE:SPACE(4):OCONV(PPT<EP>,"MD2Z,")"R#14":SPACE(2):"____________"
      PLINE=PLINE:SPACE(1):OCONV(PPT<EP>,"MD2Z,")"R#14"
      PLINE=PLINE:SPACE(9):"___________"
*T27819 ^
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINT
   IF EST.PRT.PRICE.THOU = "Y" THEN
      PLINE="Cost Per Additional 1,000""L#27"
      FOR EP = 1 TO EM
*T26138 v
*        PLINE=PLINE:SPACE(4):OCONV(EST.PRICE.THOU<1,EP>,"MD2Z,")"R#12":SPACE(2):"____________"
*T27819 v
*        PLINE=PLINE:SPACE(4):OCONV(EST.PRICE.THOU<1,EP>,"MD2Z,")"R#14":SPACE(2):"____________"
         PLINE=PLINE:SPACE(1):OCONV(EST.PRICE.THOU<1,EP>,"MD2Z,")"R#14"
         PLINE=PLINE:SPACE(9):"___________"
*T27819 ^
*T26138 ^
      NEXT EP
      PRINT PLINE
   END
   PRINT;PRINT
   PLINE = "Price Per Copy Change" "L#27"
   CHG.PC = EST.PROD.SUBS.MR.IMP<1,1,1> * EST.RL.COPY.CHANGES
   FOR EP = 1 TO EM
      LB.COST = 0; MT.COST = 0
      CCNT = DCOUNT(MT.COPY<EP>,VM)
      FOR I = 1 TO CCNT
         FND = 1
         LOCATE MT.COPY<EP,I> IN EST.PROD.OS.PROD<1,1>,1 SETTING POS ELSE FND = 0
         IF FND THEN
            CHG.MSI = INT(EST.PROD.OS.WIDTH<1,1,POS>/10000*CHG.PC*10/1000+.9)
            PRICE = FIELD(EST.RL.PAP.PRICE<1,1,POS>,"!",EP)
            MT.COST = MT.COST + INT(CHG.MSI * PRICE + 0.5)
         END
      NEXT I
      LB.COST = INT(EST.RL.MR.COPIES / 100 * LB.COPY<EP> + .5)
*T26138 v
*     PLINE=PLINE:SPACE(4):OCONV(MT.COST+LB.COST,"MD2Z,")"R#12":SPACE(2):"____________"
*T27819 v
*     PLINE=PLINE:SPACE(4):OCONV(MT.COST+LB.COST,"MD2Z,")"R#14":SPACE(2):"____________"
      PLINE=PLINE:SPACE(1):OCONV(MT.COST+LB.COST,"MD2Z,")"R#14"
      PLINE=PLINE:SPACE(9):"___________"
*T27819 ^
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINT
   PLINE = "Price Per Color Change" "L#27"
   CHG.PC = EST.PROD.SUBS.MR.IMP<1,1,1> * EST.RL.COLOR.CHANGES
   FOR EP = 1 TO EM
      LB.COST = 0; MT.COST = 0
      CCNT = DCOUNT(MT.COLOR<EP>,VM)
      FOR I = 1 TO CCNT
         FND = 1
         LOCATE MT.COLOR<EP,I> IN EST.PROD.OS.PROD<1,1>,1 SETTING POS ELSE FND = 0
         IF FND THEN
            CHG.MSI = INT(EST.PROD.OS.WIDTH<1,1,POS>/10000*CHG.PC*10/1000+.9)
            PRICE = FIELD(EST.RL.PAP.PRICE<1,1,POS>,"!",EP)
            MT.COST = MT.COST + INT(CHG.MSI * PRICE + 0.5)
         END
      NEXT I
      LB.COST = INT(EST.RL.MR.COLORS / 100 * LB.COLOR<EP> + .5)
*T26138 v
*     PLINE=PLINE:SPACE(4):OCONV(MT.COST+LB.COST,"MD2Z,")"R#12":SPACE(2):"____________"
*T27819 v
*     PLINE=PLINE:SPACE(4):OCONV(MT.COST+LB.COST,"MD2Z,")"R#14":SPACE(2):"____________"
      PLINE=PLINE:SPACE(1):OCONV(MT.COST+LB.COST,"MD2Z,")"R#14"
      PLINE=PLINE:SPACE(9):"___________"
*T27819 ^
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINT
   PLINE = "Price Per Version Change" "L#27"
   CHG.PC = EST.PROD.INIT.MR.IMP<1,1,1> * EST.RL.VERSION.CHANGES
   FOR EP = 1 TO EM
      LB.COST = 0; MT.COST = 0
      CCNT = DCOUNT(MT.VERSION<EP>,VM)
      FOR I = 1 TO CCNT
         FND = 1
         LOCATE MT.VERSION<EP,I> IN EST.PROD.OS.PROD<1,1>,1 SETTING POS ELSE FND = 0
         IF FND THEN
            CHG.MSI = INT(EST.PROD.OS.WIDTH<1,1,POS>/10000*CHG.PC*10/1000+.9)
            PRICE = FIELD(EST.RL.PAP.PRICE<1,1,POS>,"!",EP)
            MT.COST = MT.COST + INT(CHG.MSI * PRICE + 0.5)
         END
      NEXT I
      LB.COST = INT(EST.RL.MR.VERSIONS / 100 * LB.VERSION<EP> + .5)
*T26138 v
*     PLINE=PLINE:SPACE(4):OCONV(MT.COST+LB.COST,"MD2Z,")"R#12":SPACE(2):"____________"
*T27819 v
*     PLINE=PLINE:SPACE(4):OCONV(MT.COST+LB.COST,"MD2Z,")"R#14":SPACE(2):"____________"
      PLINE=PLINE:SPACE(1):OCONV(MT.COST+LB.COST,"MD2Z,")"R#14"
      PLINE=PLINE:SPACE(9):"___________"
*T27819 ^
*T26138 ^
   NEXT EP
   PRINT PLINE
   PRINTER OFF
   RETURN
*
*---- PRINT HEADINGS
*
10000 *
   PRINT CHAR(12)
   PAGE.NO = PAGE.NO + 1
   PRINT HD1 : PAGE.NO
   PRINT HD2
   PRINT
   PRINT HD4
   PRINT
   RETURN
END
