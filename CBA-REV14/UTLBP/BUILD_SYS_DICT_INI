*COPY>PMC.CPYLIB>MENUS.CONTROL
*COPY>JIS.CPYLIB>PFX_FILES
*COPY>JIS.CPYLIB>SYS_FILES
*COPY>JIS.CPYLIB>SYS_FIELDS
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>SYSCOM
*
      DIM CPYLIB_FILE(20)
*
*---- SET UP SYSCOM
*
   SYS.TYPE = 1
   CALL SYSCOM(MAT SYSCOM.REC)
*
*---- Open required Files
*
   OPEN "","SYS_FILES" TO SYS_FILES ELSE
      ERRMSG = "Cannot locate the SYS_FILES file"
      GOTO 93000
   END
   OPEN "","PFX_FILES" TO PFX_FILES ELSE
      ERRMSG = "Cannot locate the PFX_FILES file"
      GOTO 93000
   END
   OPEN "","SYS_FIELDS" TO SYS_FIELDS ELSE
      ERRMSG = "Cannot locate the SYS_FIELDS file"
      GOTO 93000
   END
   OPEN "","CONTROL" TO CONTROL ELSE
      ERRMSG = "Cannot locate the CONTROL file"
      GOTO 93000
   END
*
*---- Get setup variables
*
   MATREAD MENU.REC FROM CONTROL, "MENUS.CONTROL" ELSE
      ERRMSG = "Cannot locate the CONTROL, MENUS.CONTROL record"
      GOTO 93000
   END
   IF INDEX(CBA.PATH,"/",1) THEN
      SCHAR = "/"; BSCHAR = "\"
   END ELSE
      SCHAR = "\"; BSCHAR = "/"
   END
   CNT = COUNT(PRIMAC.PATH,SCHAR) + 1
   IF M.ACCOUNT # FIELD(PRIMAC.PATH,SCHAR,CNT) THEN
      ERRMSG = "PRIMAC Control setup error ?"
      GOSUB 91000; GOTO 99999
   END
   CNT = COUNT(CBA.PATH,SCHAR) + 1
   CBA.ACCT = FIELD(CBA.PATH,SCHAR,CNT)
   PORT_NO = "TTY"; CALL SYSVARS.SUB(PORT_NO)
   DIR_NAME = "ACCT"; CALL SYSVARS.SUB(DIR_NAME)
*
   PMC.ACCTS = "CBA"
   PMC.ACCTS<2> = "PMC"
   SYSLINES = DCOUNT(VALID.SYS,VM)
   FOR I = 1 TO SYSLINES
      PMC.ACCTS<2+I> = VALID.SYS<1,I>
   NEXT I
   LOCATE "RES" IN PMC.ACCTS,1 SETTING RESLOC THEN
      LOCATE "JES" IN PMC.ACCTS,1 SETTING FND THEN
         PMC.ACCTS = DELETE(PMC.ACCTS,RESLOC,0,0)
         SYSLINES = SYSLINES - 1
      END
   END
   SYSLINES = SYSLINES + 2
*
*
   CPYLIB_NAME = ""; MAT CPYLIB_FILE = ""
*
SELECT SYS_FILES
*
      TABLE_IDS = ""
      MORE = 1
      LOOP
         READNEXT TABLE_ID ELSE MORE = 0
      WHILE MORE DO
         TABLE_IDS<-1> = TABLE_ID
      REPEAT
      TABLE_CNT = DCOUNT(TABLE_IDS,AM)
      FOR TABLE_PTR = 1 TO TABLE_CNT
         TABLE_ID = TABLE_IDS<TABLE_PTR>
         MATREAD SFR.REC FROM SYS_FILES, TABLE_ID ELSE GOTO 199
         BEGIN CASE
         CASE SFR.CPYLIB = ""
            GOTO 199
         CASE SFR.TYPE # "D" AND SFR.TYPE # "O"
            GOTO 199
         END CASE
         LOCATE SFR.CPYLIB IN CPYLIB_NAME,1 SETTING CPLB_LOC ELSE
            OPEN "", SFR.CPYLIB TO CPYLIB_FILE(CPLB_LOC) ELSE
               ERRMSG = "Cannot locate the (":SFR.CPYLIB:") Data structue"
               GOSUB 91000; GOTO 199
            END
            CPYLIB_NAME<CPLB_LOC> = SFR.CPYLIB
         END
         READ CPYLIB_REC FROM CPYLIB_FILE(CPLB_LOC), SFR.CPLB.NAME ELSE
            ERRMSG = "Cannot locate the Data Structure for TABLE # ":SFR.CPLB.NAME
            GOSUB 91000; GOTO 199
         END
*
         OPEN "",TABLE_ID TO DATA_FILE_PTR ELSE
            ERRMSG = "Cannot locate the (":TABLE_ID:") data file"
            GOSUB 91000; GOTO 199
         END
         OPEN "DICT", TABLE_ID TO DICT_FILE_PTR ELSE
            ERRMSG = "Cannot locate the (":TABLE_ID:") dict file"
            GOSUB 91000; GOTO 199
         END
         PFX = ""; FLD_REC = CPYLIB_REC
         CALL CPYLIB_SUB(FLD_REC,PFX,ARRAY_NAME,ARRAY_SIZE,ERRMSG)
         IF ERRMSG # "" THEN
            ERRMSG = "(":TABLE_ID:") ":ERRMSG
            GOSUB 91000; GOTO 199
         END
         FLD_CNT = DCOUNT(FLD_REC,AM)
         FOR FLD_PTR = 1 TO FLD_CNT
            IF FLD_REC<FLD_PTR> = "" THEN GOTO 179
            FLD_ID = PFX:"_":FLD_REC<FLD_PTR>
            READ DREC FROM DICT_FILE_PTR, FLD_ID THEN
               GOTO 179
            END
            SDREC = "D"
            SDREC<2> = FLD_PTR
            MATREAD DFD.REC FROM SYS_FIELDS, FLD_ID THEN
               BEGIN CASE
               CASE DFD_TYPE = "C"
                  SCNV = "MD":DFD_DEC
                  SCNV<2> = "MD":DFD_DEC:","
               CASE DFD_TYPE = "D"
                  SCNV = "D2/"
                  SCNV<2> = "D2-"
               CASE DFD_TYPE = "N"
                  SCNV = ""
                  SCNV<2> = "MD0"
               CASE 1
                  SCNV = ""
               END CASE
               SLEN = DFD_LEN:DFD_JUSTIFY
               IF DFD_JUSTIFY = "L" THEN
                  SLEN<2> = DFD_LEN:"R"
               END ELSE
                  SLEN<2> = DFD_LEN:"L"
               END
               BEGIN CASE
               CASE DFD_LVL = "M"
                  SLVL = "MV"
                  SLVL<2> = "M"
               CASE DFD_LVL = "V"
                  SLVL = "MS"
               CASE 1
                  SLVL = "S"
                  SLVL<2> = ""
               END CASE
               SDREC<3> = SCNV<1>
               SDREC<4> = FLD_ID
               SDREC<5> = SLEN<1>
               SDREC<6> = SLVL<1>
CRT TABLE_ID "L#40": FLD_PTR "L#5" : FLD_ID
FOR II = 1 TO 5
CRT II "L#5" : SDREC<II>
NEXT II
CRT "6" "L#5" : SDREC<6>:
INPUT UPD_OK
IF UPD_OK = "" THEN
   WRITE SDREC ON DICT_FILE_PTR, FLD_ID
END
            END ELSE
               ERRMSG = "Cannot locate (":TABLE_ID:", ":FLD_ID:") definition"
*              GOSUB 91000
            END
179*
         NEXT FLD_PTR
199*
      NEXT TABLE_PTR
      GOTO 99999
*
*---- Error routines
91000*
   ERR.TYPE = 1
   CALL SYSCOM(MAT SYSCOM.REC)
   RETURN
93000*
   ERR.TYPE = 3
   CALL SYSCOM(MAT SYSCOM.REC)
*
99999*
END
