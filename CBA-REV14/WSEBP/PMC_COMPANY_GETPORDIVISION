SUBROUTINE PMC_COMPANY_GETPORDIVISION(CONO,STRXML,ERRMSG,SCHEMA.ONLY)
SCHEMA.ONLY = 1
$INCLUDE PMC.CPYLIB DIVISION
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE POS.CPYLIB APP.REQ
* OPEN FILES
*
OPEN "","COMPANY" TO COMPANY ELSE
           ERRMSG = "CANNOT OPEN COMPANY FILE"
           GOTO 99999
END
OPEN "","DIVISION" TO DIVISION ELSE
           ERRMSG = "CANNOT OPEN DIVISION FILE"
           GOTO 99999
END
OPEN "","CONTROL" TO CONTROL ELSE
           ERRMSG = "CANNOT OPEN CONTROL FILE"
           GOTO 99999
END
OPEN '','APP.REQ' TO APP.REQ ELSE 
  ERRMSG = 'APP.REQ FILE IS MISSING'
  GOTO 99999
END
*
* INITIALIZE  VARIABLES
*
ERRMSG=""
CONO_ID = ""
DIV_ID = ""
DIV_DESC = ""
DIVID_DESC = ""
*********
APP_NAME = ""
USER.ID = UPCASE(@LOGNAME)
MENU.FLAG = "R"
*
* MAIN PROCESSING
*
FLAG = 0
*IF INDEX(CONO,"XML",1) THEN
*  IF CONO[1,1] = "*" THEN CONO = CONO[1,1] ELSE CONO = CONO[1,3]
*  FLAG = 1
*END
****DIVISION
IF CONO = "*" THEN
CMD= "SSELECT DIVISION"
END ELSE
MATREAD COMP.REC FROM COMPANY,CONO ELSE
ERRMSG="COMPANY NUMBER ":CONO : " DOES NOT EXIST"
GOTO 99999
END
CNT = 1
CMD= "SSELECT DIVISION WITH @ID LIKE '" : CONO : "...'"
END
UDTEXECUTE CMD
DATA=1
LOOP
50*
  READNEXT ID ELSE DATA=0
  WHILE DATA DO
    SCHEMA.ONLY = 0
    ERMSG = ""
    *GOSUB 100
    IF ERMSG # "" THEN CONTINUE
    MATREAD DIV.REC FROM DIVISION, ID THEN
 *     IF FLAG THEN
       CONO_ID<1,CNT> = ID[1,3]
       DIV_ID<1,CNT> = ID[4,99]
       DIV_DESC<1,CNT> = DIV.DESC
       DIVID_DESC<1,CNT> = ID[4,99] :"-": DIV.DESC
      CNT = CNT + 1
*      END ELSE
*STRXML:='<Division><Cono>' : ID[1,3] : '</Cono><DivisionId>'  : ID[4,99] : '</DivisionId><DivisionDesc>' : DIV.DESC: '</DivisionDesc>'
*STRXML:='<DivisionIdDesc>' : ID[4,99] :"-": DIV.DESC : '</DivisionIdDesc></Division>'
 *     END
    END
REPEAT
*IF FLAG THEN
 STRXML='<Division><Cono>' : CONO_ID : '</Cono><DivisionId>'  : DIV_ID : '</DivisionId><DivisionDesc>' : DIV_DESC: '</DivisionDesc>'
STRXML:='<DivisionIdDesc>' : DIVID_DESC : '</DivisionIdDesc></Division>'
*END
RETURN
100*
*** ENTER OWNING DIVISION NUMBER; * TASK 19404
*
      PO.DIV.OWNER = ID[4,99]
      DIV = ID[4,99] 
      INVALID = 0
      IF PO.DIV.OWNER # "00" THEN
         READ DIV.R FROM DIVISION,CONO:PO.DIV.OWNER ELSE
            INVALID = 1
         END
      END ELSE
         DIV = "ALL"
      END
      IF NOT(INVALID) THEN
         IF MENU.FLAG = "R" THEN
            VALID = 1
            MATREAD APP.REQ.REC FROM APP.REQ,CONO:USER.ID:"!ALL" THEN
               IF APP.STATUS = "Y" THEN
                  APP_NAME<1,CNT> = APP.NAME<1>
                END ELSE
                  IF DIV # "ALL" THEN
                     MATREAD APP.REQ.REC FROM APP.REQ,CONO:USER.ID:"!":DIV THEN
                        IF APP.STATUS = "Y" THEN
                           APP_NAME<1,CNT> = APP.NAME<1>
                        END ELSE
                           ERMSG = "User profile is inactive for division ":DIV
                           *GOSUB 91000
                           GOTO 50
                        END
                     END ELSE
                        ERMSG = "You are not allowed to enter requisitions for division ":PO.DIV.OWNER
                        *GOSUB 91000
                        GOTO 50
                     END
                  END ELSE
                     ERMSG = "User profile is inactive for division ":DIV
                     *GOSUB 91000
                     GOTO 50
                  END
               END
            END ELSE
               IF DIV # "ALL" THEN
                  MATREAD APP.REQ.REC FROM APP.REQ,CONO:USER.ID:"!":DIV THEN
                     IF APP.STATUS = "Y" THEN
                        APP_NAME<1,CNT> = APP.NAME<1>
                     END ELSE
                        ERMSG = "User profile is inactive for division ":DIV
                        *GOSUB 91000
                        GOTO 50
                     END
                  END ELSE
                     ERMSG = "You are not allowed to enter requisitions for division ":PO.DIV.OWNER
                     *GOSUB 91000
                     GOTO 50
                  END
               END ELSE
                  ERMSG = "You are not allowed to enter requisitions for division ":PO.DIV.OWNER
                  *GOSUB 91000
                  GOTO 50
               END
            END
*            IF (NEW) THEN 
*               PO.WRIT.BY = APP.NAME<1>
*            END
         END
      END ELSE
         ERMSG = "Invalid division number used for PO owning division"
         *GOSUB 91000; PO.DIV.OWNER = ""; GOTO 50
	 GOTO 50
      END
      DIV.CODE = PO.DIV.OWNER; USER.ID = UPCASE(@LOGNAME); ERRMSG = ''
 *     CALL CK.DIV.SEC.SUB(CONO,DIV.CODE,USER.ID,ERRMSG)
*      IF ERRMSG # '' THEN
*         GOSUB 91000; SCV.REC(41)<1,1> = ''; GOTO 50
*      END
   *END
RETURN
*
* WRITE ERROR MESSAGE
*
99999*
IF ERRMSG <> "" THEN
      ERRMSG = "GetPORDivision ----> PMC_COMPANY_GETPORDIVISION --->": ERRMSG
      CALL WRITELOG(ERRMSG)
END
RETURN
