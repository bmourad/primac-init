SUBROUTINE PMC_COMPANY_VALIDATEDIVISION(DIVISIONID,STRXML,ERRMSG,SCHEMA.ONLY)
SCHEMA.ONLY = 1
$INCLUDE PMC.CPYLIB DIVISION
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE POS.CPYLIB APP.REQ
* OPEN FILES
*
OPEN "","COMPANY" TO COMPANY ELSE
           ERRMSG = "CANNOT OPEN COMPANY FILE"
           GOTO 99999
END
OPEN "","DIVISION" TO DIVISION ELSE
           ERRMSG = "CANNOT OPEN DIVISION FILE"
           GOTO 99999
END
OPEN "","CONTROL" TO CONTROL ELSE
           ERRMSG = "CANNOT OPEN CONTROL FILE"
           GOTO 99999
END
OPEN '','APP.REQ' TO APP.REQ ELSE 
  ERRMSG = 'APP.REQ FILE IS MISSING'
  GOTO 99999
END
*
* INITIALIZE  VARIABLES
*
ERRMSG=""
ERMSG = ""
*
* MAIN PROCESSING
*
APP_NAME = ""
USER.ID = UPCASE(@LOGNAME)
CONO = DIVISIONID[1,3]
MENU.FLAG = "R"
MATREAD COMP.REC FROM COMPANY,CONO ELSE
  ERRMSG="COMPANY NUMBER ":CONO : " DOES NOT EXIST"
  GOTO 99999
END
*********
*** ENTER OWNING DIVISION NUMBER; * TASK 19404
*
      PO.DIV.OWNER = DIVISIONID[4,99]
      DIV = DIVISIONID[4,99] 
      INVALID = 0
      IF PO.DIV.OWNER # "00" THEN
         MATREAD DIV.REC FROM DIVISION,CONO:PO.DIV.OWNER ELSE
            INVALID = 1
         END
      END ELSE
         DIV = "ALL"
      END
      IF NOT(INVALID) THEN
         IF MENU.FLAG = "R" THEN
            VALID = 1
            MATREAD APP.REQ.REC FROM APP.REQ,CONO:USER.ID:"!ALL" THEN
               IF APP.STATUS = "Y" THEN
                  APP_NAME = APP.NAME<1>
                END ELSE
                  IF DIV # "ALL" THEN
                     MATREAD APP.REQ.REC FROM APP.REQ,CONO:USER.ID:"!":DIV THEN
                        IF APP.STATUS = "Y" THEN
                           APP_NAME = APP.NAME<1>
                        END ELSE
                           ERMSG = "User profile is inactive for division ":DIV
                           *GOSUB 91000
                           GOTO 50
                        END
                     END ELSE
                        ERMSG = "You are not allowed to enter requisitions for division ":PO.DIV.OWNER
                        *GOSUB 91000
                        GOTO 50
                     END
                  END ELSE
                     ERMSG = "User profile is inactive for division ":DIV
                     *GOSUB 91000
                     GOTO 50
                  END
               END
            END ELSE
               IF DIV # "ALL" THEN
                  MATREAD APP.REQ.REC FROM APP.REQ,CONO:USER.ID:"!":DIV THEN
                     IF APP.STATUS = "Y" THEN
                        APP_NAME = APP.NAME<1>
                     END ELSE
                        ERMSG = "User profile is inactive for division ":DIV
                        *GOSUB 91000
                        GOTO 50
                     END
                  END ELSE
                     ERMSG = "You are not allowed to enter requisitions for division ":PO.DIV.OWNER
                     *GOSUB 91000
                     GOTO 50
                  END
               END ELSE
                  ERMSG = "You are not allowed to enter requisitions for division ":PO.DIV.OWNER
                  *GOSUB 91000
                  GOTO 50
               END
            END
*            IF (NEW) THEN 
*               PO.WRIT.BY = APP.NAME<1>
*            END
         END
      END ELSE
         ERMSG = "Invalid division number used for PO owning division"
         *GOSUB 91000; PO.DIV.OWNER = ""; GOTO 50
	 GOTO 50
      END
50*
      DIV.CODE = PO.DIV.OWNER; USER.ID = UPCASE(@LOGNAME); ERRMSG = ''
 *     CALL CK.DIV.SEC.SUB(CONO,DIV.CODE,USER.ID,ERRMSG)
*      IF ERRMSG # '' THEN
*         GOSUB 91000; SCV.REC(41)<1,1> = ''; GOTO 50
*      END
   *END
*******
STRXML='<Division><ErrorStack>' : ERMSG : '</ErrorStack><WrittenBy>'  : APP_NAME : '</WrittenBy></Division>'
RETURN
*
* WRITE ERROR MESSAGE
*
99999*
IF ERRMSG <> "" THEN
      ERRMSG = "ValidateDivision ----> PMC_COMPANY_VALIDATEDIVISION --->": ERRMSG
      CALL WRITELOG(ERRMSG)
END
RETURN
