   SUBROUTINE RFT_WRITE.RCV.RF.RECEIVE(CONO,EMPID,PONO,MANIFESTNO,MANIFESTWGT,VENDERNO,POLINE,PRODUCTNAME,WARE_HOUSE,UNITMEASURE,PRICE,SELPROD,FLAG,LOGNAME,STRXML,ERRMSG )
*********************************************************************
*
* PROGRAM  - RCV.RF.RECEIVE
*
* AUTHOR   - PRASHANT KUMAR
*
* DATE     - 10/23/07
*
* DESCRIPTION
*
* This program is used to process the Roll Receiving transaction
* from the hand-held R-F units used on the receiving dock.
*
*T25697 edvard 03/20/2001 * Make a RCVMAN.TOT.WGT total weight for the
*                           whole po for the manifest.
*T26132 cm 09/06/2001 * Change screen size from 21x16 to 20x15.
*T26496 lhelms 03/21/2002 * UPGRADE REV12 FIX TO NOT WRITE OUT
*                           RCV.MANIFEST IF END AT SERAIL NUMBER PROMPT
*                           REMOVE RCV.MANIFEST REPLACE WITH DAILY_STOCK
*T26556 adelgado 06/17/2002 * Update PO.MAN.XREF with manifest total.
*T26951 adelgado 10/25/2002 * Remove prompt for Whse.
*T27071 epitka 12/17/2002 * Move location to second screen.
*T27928 lross 02/04/2005 * Allow posting from entry function.
*T28267 cmykleb 11/02/2004 * Allow entry of user defined serial #'s to
*                            receive stock.
*T28441 lross 02/14/2005 * Add Whse to XREF.
*********************************************************************
*
*---- INCLUDE COPYLIBS
*
$INCLUDE RCV.CPYLIB RCV.FILE.VARS
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE ICS.CPYLIB CATEGORY
$INCLUDE ICS.CPYLIB DAILY_STOCK
$INCLUDE ICS.CPYLIB INV_SERIAL
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB WAREHOUSE
$INCLUDE PMC.CPYLIB PO
$INCLUDE PMC.CPYLIB VEND
$INCLUDE ICS.CPYLIB PO.MAN.XREF
$INCLUDE ICS.CPYLIB PO.RSKI.XREF
$INCLUDE PMC.CPYLIB EMPLOYEE
$INCLUDE CPYLIB FILE.VARS
$INCLUDE CPYLIB CHAR
*
*---- OPEN
*
   OPEN "","CONTROL" TO CONTROL ELSE
      ERRMSG = "CONTROL FILE MISSING";  RETURN
   END
   OPEN "","EMPLOYEE" TO EMPLOYEE ELSE
      ERRMSG = "EMPLOYEE FILE MISSING";  RETURN
   END
   OPEN "","PO.MAN.XREF" TO PO.MAN.XREF ELSE
      ERRMSG = "PO.MAN.XREF FILE MISSING";  RETURN
   END
   OPEN "","PO.RSKI.XREF" TO PO.RSKI.XREF ELSE
      ERRMSG = "PO.RSKI.XREF FILE MISSING"; RETURN
   END
   OPEN "","PO" TO PO ELSE
      ERRMSG = "PO FILE MISSING"; RETURN
   END
   OPEN "","DAILY_STOCK" TO DAILY_STOCK ELSE
      ERRMSG = "DAILY_STOCK FILE MISSING";  RETURN
   END
   OPEN "","CATEGORY" TO CATEGORY ELSE
      ERRMSG = "CATEGORY FILE MISSING"; RETURN
   END
   OPEN "","INV_SERIAL" TO INV_SERIAL ELSE
      ERRMSG = "INV_SERIAL FILE MISSING";  RETURN
   END
   OPEN "","INV_SERIAL_DELETED" TO INV_SERIAL_DELETED ELSE
      ERRMSG = "INV_SERIAL_DELETED FILE MISSING";  RETURN
   END
   OPEN "","INVENTORY" TO INVENTORY ELSE
      ERRMSG = "INVENTORY FILE MISSING";  RETURN
   END
   OPEN "","COMPANY" TO COMPANY ELSE
      ERRMSG = "COMPANY FILE MISSING"; RETURN
   END
   OPEN "","VEND" TO VEND ELSE
      ERRMSG = "VEND FILE MISSING"; RETURN
   END
   OPEN "","WAREHOUSE" TO WAREHOUSE ELSE
         ERRMSG = "WAREHOUSE FILE MISSING";RETURN
   END
   MATREAD COMP.REC FROM COMPANY,CONO ELSE
      ERRMSG='COMPANY # MISSING'; RETURN
   END
GFRTST = ""
GFRTST<1>="IN MAIN FILE "; WRITE GFRTST ON CONTROL,"W2910"
*
*---- INITIALIZATION
*
   SPX = ""
   EMPNAME = "???????????????"
   MATREAD EMP.REC FROM EMPLOYEE, CONO:EMPID THEN
      EMPNAME = (EMP.FRST.NAME:" ":EMP.LAST.NAME)[1,20]
   END
   IF LEN(EMPNAME) < 20 THEN SPX = SPACE(INT((21-LEN(EMPNAME))/2))
   EMPNAME = SPX:EMPNAME
100 *
      PO.NO   = ""
      MAN.NO  = ""
      PROD.ID = ""
      TOT.WGT = ""
      RCV.WGT = ""
      WHSE    = ""
      ;*T27071   WLOC    = ""
*
*---- MAIN PROCESSING
*
*
GFRTST<-1>="START PO BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
*---- GET P/O NUMBER
*
            PONO = UPCASE(TRIM(PONO))
            IF PONO = "" THEN
               ERRMSG = "** REQUIRED **"
               RETURN
            END
    STRXML:="<PoNo>":PONO:"</PoNo>"
            MANUAL.ENTRY = 0
* Replace PO with PO.RSKI.XREF v
            MATREADU RSXRF.REC FROM PO.RSKI.XREF, CONO:PONO LOCKED
               ERRMSG = "P/O LOCKED"; RETURN
            END ELSE
               MAT RSXRF.REC = ''
               MANUAL.ENTRY = 1
            END
            PO.NO = PONO
            PO.PRESENT = 1
            MATREADU PO.REC FROM PO, CONO:PO.NO LOCKED
               ERRMSG = "P/O LOCKED"; RETURN
            END ELSE
               IF DCOUNT(RSXRF.RS.NO,VM) > 0 THEN MANUAL.ENTRY = 1 ;*T27306
               IF NOT(MANUAL.ENTRY) THEN
                  ERRMSG='PO Missing'; RETURN
               END ELSE
GFRTST<-1>="ENTER ELSE PART"; WRITE GFRTST ON CONTROL,"W2910"
                  IF FLAG = 'Y' THEN
                     MAT PO.REC = ''
                     PO.DIV.OWNER='00'
               END
               PO.PRESENT=0
            END
            IF PO.PRESENT THEN MANUAL.ENTRY = 0 ;*27306
            DIV.CODE = PO.DIV.OWNER; USER.ID = UPCASE(@LOGNAME); ERRMSG = ''
            CALL RFT_SI.CK.DIV.SEC.SUB(CONO,DIV.CODE,USER.ID,ERRMSG)
            IF ERRMSG # '' THEN
               RETURN
            END
            IF NOT(MANUAL.ENTRY) THEN
               PO.LINE.CNT = DCOUNT(PO.PROD.NUM,VM)
               BCFLAG=0
               FOR PO.LINE.PTR=1 TO PO.LINE.CNT WHILE BCFLAG=0
                  MATREAD INV.REC FROM INVENTORY, CONO:PO.PROD.NUM<1,PO.LINE.PTR> ELSE MAT INV.REC = ""
                  MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE ELSE MAT CATG.REC=''
                  IF CATG.TRK.LVL='S' THEN
                     BCFLAG=1
                  END
               NEXT PO.LINE.PTR
               IF BCFLAG=0 THEN
                  ERRMSG='Not Serial PO'; RETURN
               END
            END
            NEW.MANIFEST = ''
GFRTST<-1>="END PO BLOCK"; WRITE GFRTST ON CONTROL,"W2610"
******** ^*
*
*---- GET MANIFEST NUMBER
*
GFRTST<-1>="START GET MANIFEST NUMBER BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
            IF MANIFESTNO = "" THEN
               ERRMSG = "** REQUIRED **"; RETURN
            END
	    MANIFESTNO = UPCASE(TRIM(MANIFESTNO))
	    STRXML:="<ManifestNo>":MANIFESTNO:"</ManifestNo>"
            MATREADU DSR.REC FROM DAILY_STOCK, CONO:PO.NO:"!":MANIFESTNO LOCKED
               ERRMSG = "MANIFEST LOCKED"; RETURN
            END ELSE
               MAT DSR.REC = ""
            END
            MATREADU RSMAN.REC FROM PO.MAN.XREF, CONO:PO.NO:"!":MANIFESTNO LOCKED
               ERRMSG = "MANIFEST LOCKED *"; RETURN
            END ELSE
               MAT RSMAN.REC = ""
            END
            MAN.NO = MANIFESTNO
            DSR.SHPMNT.NO = MAN.NO
*T27306 v
            RSMAN.MAN.NO = MAN.NO
*T27306 v Load Manual PO values.
            IF MANUAL.ENTRY AND NOT(PO.PRESENT) THEN
               FOR P = 1 TO DCOUNT(RSMAN.RS.NO,VM)
                  MATREAD ISTK.REC FROM INV_SERIAL,CONO:RSMAN.RS.NO<1,P> THEN
                     PTR=1
                     LOOP
                        LOCATE ISTK.PROD IN PO.PROD.NUM<1>,PTR SETTING FND THEN
                           IF ISTK.WHSE = PO.WHSE<1,FND> THEN
                              PTR = 0
                           END ELSE
                              PTR = FND+1
                           END
                        END ELSE
                           INS ISTK.PROD BEFORE PO.PROD.NUM<1,RSMAN.LINE.NO<1,P>>
                           INS ISTK.WHSE BEFORE PO.WHSE<1,RSMAN.LINE.NO<1,P>>
                           INS ISTK.UOM BEFORE PO.UNIT.FLG<1,RSMAN.LINE.NO<1,P>>
                           INS ISTK.UNIT.COST BEFORE PO.GROS.PRICE<1,RSMAN.LINE.NO<1,P>>
                           PTR = 0
                        END
                     WHILE PTR DO
                     REPEAT
                  END
               NEXT P
            END
*T27306 ^
GFRTST<-1>="PO.PROD.NUM ":PO.PROD.NUM; WRITE GFRTST ON CONTROL,"W2910"
            PCNT = DCOUNT(PO.PROD.NUM,VM)
            FOR PO.LINE = 1 TO PCNT
               PROD.NO = PO.PROD.NUM<1,PO.LINE>
               MATREAD INV.REC FROM INVENTORY,CONO:PROD.NO ELSE
                  MAT INV.REC = ""
               END
               MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE ELSE
                  MAT CATG.REC = ""
               END
GFRTST<-1>="CATG.TRK.LVL ":CATG.TRK.LVL; WRITE GFRTST ON CONTROL,"W2910"
               IF CATG.TRK.LVL = "S" THEN
*T27928 v Change below to insert by 'AR' vs <-1>
GFRTST<-1>="PO.LINE ":PO.LINE :" DSR.PO.LINE ":DSR.PO.LINE; WRITE GFRTST ON CONTROL,"W2910"
                  LOCATE PO.LINE IN DSR.PO.LINE<1>,1 BY 'AR' SETTING P ELSE
GFRTST<-1>="PO.LINE ":PO.LINE :" DSR.PO.LINE ":DSR.PO.LINE :" P ":P; WRITE GFRTST ON CONTROL,"W2910"
                     INS PO.LINE BEFORE DSR.PO.LINE<1,P>
                     INS PROD.NO BEFORE DSR.PROD<1,P>
                     INS PO.WHSE<1,PO.LINE> BEFORE DSR.WHSE<1,P>
                     INS PO.GROS.PRICE<1,PO.LINE> BEFORE DSR.UN.PRICE<1,P>
                     INS PO.UNIT.FLG<1,PO.LINE> BEFORE DSR.UOM<1,P>
GFRTST<-1>="B4 DSR.SERIAL ":DSR.SERIAL :" P ":P; WRITE GFRTST ON CONTROL,"W2910"
                     INS '' BEFORE DSR.SERIAL<1,P>
GFRTST<-1>="AFTER DSR.SERIAL ":DSR.SERIAL :" P ":P; WRITE GFRTST ON CONTROL,"W2910"
                     FOR R = 1 TO DCOUNT(RSMAN.RS.NO,VM)
                        IF RSMAN.LINE.NO<1,R> = PO.LINE THEN
                           DSR.SERIAL<1,P,-1> = RSMAN.RS.NO<1,R>
                        END
                     NEXT R
                  END
               END
            NEXT PO.LINE
GFRTST<-1>="END GET MANIFEST NUMBER BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
*
*---- GET MANIFEST WEIGHT
*
GFRTST<-1>="START GET MANIFEST WEIGHT BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
*T27928 v Move from below so user can see what is already entered, if any.
         ENTERED = ""
GFRTST<-1>="*T27928 DSR.SERIAL ":DSR.SERIAL; WRITE GFRTST ON CONTROL,"W2910"
         IF DSR.SERIAL # "" THEN
            NUM.PROD = DCOUNT(DSR.PROD,VM)
            FOR P = 1 TO NUM.PROD
               NUM.SERIAL = DCOUNT(DSR.SERIAL<1,P>,SVM)
               FOR S = 1 TO NUM.SERIAL
                  MATREAD ISTK.REC FROM INV_SERIAL, CONO:DSR.SERIAL<1,P,S> ELSE
                     MAT ISTK.REC = ""
                  END
                  IF DSR.POST.DATE<1,P,S> = "" THEN
                     IF DSR.UOM<1,P> = "LBS" OR DSR.UOM<1,P> = "MSI" THEN
                        ENTERED+=ISTK.QTY.ENTERED
                     END ELSE
                        ENTERED+=ISTK.QTY.ENTERED*100
                     END
                  END
               NEXT S
            NEXT P
         END
         RCV.WGT = ENTERED
	 STRXML:="<ReceivedWeight>": OCONV(RCV.WGT,"MD2"):"</ReceivedWeight>"
*T27928 ^
            IF DSR.SHPMNT.TOT # "" THEN
                DEFAULT=DSR.SHPMNT.TOT 
            END
            TOT.WGT = MANIFESTWGT
            DSR.SHPMNT.TOT = TOT.WGT ;*38017
      STRXML:="<TotalWeight>": OCONV(TOT.WGT,"MD2"):"</TotalWeight>"
*T28267 v
            IF MANUAL.ENTRY THEN
               IF VENDERNO = "" THEN
                  ERRMSG = "** REQUIRED **"; RETURN
               END
               PO.VEND.NO = VENDERNO
               MATREAD VEND.REC FROM VEND,CONO:PO.VEND.NO ELSE
                  ERRMSG='VEND Missing'; RETURN
               END
*
ENT.PO.LINE:   
               IF POLINE = "" THEN
                  ERRMSG = "** REQUIRED **"; RETURN
               END
               PO.LINE = POLINE
               LOCATE PO.LINE IN DSR.PO.LINE<1> SETTING SREF ELSE
                  DSR.PO.LINE<1,SREF> = PO.LINE
               END
ENT.PRODUCT:   
               IF PRODUCTNAME = "" THEN
                  ERRMSG = "** REQUIRED **"; RETURN
               END
               MATREAD INV.REC FROM INVENTORY,CONO:PRODUCTNAME ELSE
                  ERRMSG='Invalid Product ID';RETURN
               END
               MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE ELSE MAT CATG.REC = ""
               IF CATG.TRK.LVL # "S" THEN
                  ERRMSG='Not Serial Product'; RETURN
               END
               IF CATG.INV="" OR CATG.ACCRU.LIAB="" OR CATG.AP.ACCT="" THEN
                  ERRMSG='No Accts Setup';RETURN
               END
               IF INV.M.LINE="FNGD" THEN
                  ERRMSG='No FNGD Products';RETURN
               END
               CHG.PROD=0
               IF PO.PROD.NUM<1,PO.LINE> # "" AND PO.PROD.NUM<1,PO.LINE> # PRODUCTNAME THEN
                  ERRMSG='PO Prod Mismatch';RETURN
               END
               DSR.PROD<1,SREF>=PRODUCTNAME
               DSR.UOM<1,SREF>=INV.UNIT<1,1>
               PO.PROD.NUM<1,PO.LINE> = PRODUCTNAME
               PO.UNIT.FLG<1,PO.LINE> = INV.UNIT<1,1>
*********
GFRTST<-1>="END GET MANIFEST WEIGHT BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
*---- GET WAREHOUSE
*
ENT.WHSE:      
GFRTST<-1>="START WHSE BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
               BEGIN CASE
                  CASE PO.WHSE<1,PO.LINE> = ""
                     IF WARE_HOUSE = "" THEN
                        ERRMSG = "** REQUIRED **"; RETURN
                     END
		     WARE_HOUSE = UPCASE(TRIM(WARE_HOUSE))
                     MATREAD WHSE.REC FROM WAREHOUSE, CONO:WARE_HOUSE ELSE
                        ERRMSG = "INVALID WHSE"; RETURN
                     END
                     IF PO.LINE = 1 AND NOT(PO.PRESENT) THEN
                        DIV.CODE = WHS.DIV; USER.ID = UPCASE(@LOGNAME); ERRMSG = ''
                        CALL RFT_SI.CK.DIV.SEC.SUB(CONO,DIV.CODE,USER.ID,ERRMSG)
                        IF ERRMSG # '' THEN
                           RETURN
                        END
                        PO.DIV.OWNER = WHS.DIV
                     END
                     IF WHS.DIV # PO.DIV.OWNER AND PO.DIV.OWNER # "00" THEN
                        ERRMSG = "DIVISION MISMATCH"; RETURN
                     END
                     WHSE = WARE_HOUSE 
                  CASE PO.WHSE<1,PO.LINE> # ""
                     WHSE = PO.WHSE<1,PO.LINE>
                     WARE_HOUSE =WHSE
               END CASE
               LOCATE WARE_HOUSE  IN INV.WHSE.CODE<1> SETTING WFND ELSE
                  ERRMSG='WHSE not in PROD';RETURN
               END
	       STRXML:="<WareHouse>":WARE_HOUSE:"</WareHouse>"
               PO.WHSE<1,PO.LINE> = WARE_HOUSE
               DSR.WHSE<1,SREF> = WARE_HOUSE
GFRTST<-1>="END WHSE BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
********
ENT.UOM:       
********
GFRTST<-1>="START UOM BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
               IF UNITMEASURE = "" THEN
                  ERRMSG = "** REQUIRED **"; RETURN
               END
	       UNITMEASURE = UPCASE(TRIM(UNITMEASURE))
               LOCATE UNITMEASURE IN INV.UNIT<1>,1 SETTING UFND ELSE
                  ERRMSG='INVALID UOM'; RETURN
               END
               DSR.UOM<1,SREF>=UNITMEASURE
               PO.UNIT.FLG<1,PO.LINE>=UNITMEASURE
GFRTST<-1>="END UOM BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
*******
ENT.PRICE:     
*******
GFRTST<-1>="START PRICE BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
               LOCATE PO.VEND.NO IN INV.VENDOR<1>,1 SETTING VV ELSE VV=0 
               IF VV THEN PO.GROS.PRICE<1,PO.LINE>=INV.PRICE<1,VV>
               IF PRICE = "" THEN
                  ERRMSG = "** REQUIRED **"; RETURN
               END
               PO.GROS.PRICE<1,PO.LINE> = PRICE
               DSR.UN.PRICE<1,SREF> = PRICE
*
               MAT PO.REC = ''
               MAT DSR.REC = ''
               PO.DIV.OWNER='00'
            END 
GFRTST<-1>="END PRICE BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
*T28267 ^
*T28267 v
*
*---- CALL PO PROD XREF
*
***************
CALL.PROD.XREF: 
***************
GFRTST<-1>="IN CALL.PROD.XREF "; WRITE GFRTST ON CONTROL,"W2910"
GFRTST<-1>=" START CALL.PROD.XREF:  BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
         IF NOT(MANUAL.ENTRY) THEN
            MPTR = ''
            IF DCOUNT(DSR.PROD,VM) > 1 THEN
*               CALL RFT_RCV.RF.PROD.XREF(ACTION,CONO,PO.NO,DSR.PROD,DSR.WHSE,MPTR, MAT RCV.FILE.VARS)
                MPTR = SELPROD
            END ELSE MPTR = 1
         END ELSE MPTR = PO.LINE
GFRTST<-1>=" END CALL.PROD.XREF:  BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
*T28267 ^
*
*---- PROCESS RECEIVED ROLLS
*
GFRTST<-1>=" START PROCESS RECEIVED ROLLS BLOCK"; WRITE GFRTST ON CONTROL,"W2910"
         TODAY = DATE()
         IF DSR.DATE = "" THEN DSR.DATE = TODAY
         ;*T26556 v
         DEF.PERIOD = "";ERR.FLG = "";ERRMSG1 = ""                              
GFRTST<-1>="CALLIG RFT_CHECK.PERIOD.DATE "; WRITE GFRTST ON CONTROL,"W2910"
         CALL RFT_CHECK.PERIOD.DATE(CONO,DSR.DATE,DEF.PERIOD,PO.DIV.OWNER,ERR.FLG,ERRMSG1,COMPANY,CONTROL)
         BEGIN CASE                           
            CASE ERRMSG1 = ""                   
               DSR.PERIOD = DEF.PERIOD
            CASE ERR.FLG = 0                   
               DSR.PERIOD = DEF.PERIOD
            CASE 1
         END CASE                             
GFRTST<-1>="AFTER CALLIG RFT_CHECK.PERIOD.DATE "; WRITE GFRTST ON CONTROL,"W2910"
         DSR.VEND = PO.VEND.NO
         DSR.PO   = PO.NO
GFRTST<-1>="ID ":CONO:PO.NO:"!":MAN.NO; WRITE GFRTST ON CONTROL,"W2910"
MATWRITEU DSR.REC ON DAILY_STOCK, CONO:PO.NO:"!":MAN.NO
GFRTST<-1>=" AFTER MATWRITE DAILY_STOCK "; WRITE GFRTST ON CONTROL,"W2910"
         RSMAN.MAN.NO = MAN.NO
         RSMAN.MAN.TOT.WGT = DSR.SHPMNT.TOT
         RSMAN.ENTRY.DATE = DSR.DATE
         RSMAN.PERIOD = DSR.PERIOD
GFRTST<-1>="MATWRITE PO.MAN.XREF "; WRITE GFRTST ON CONTROL,"GFR24"
         MATWRITEU RSMAN.REC ON PO.MAN.XREF, CONO:PO.NO:"!":MAN.NO
GFRTST<-1>=" AFTER MATWRITE PO.MAN.XREF "; WRITE GFRTST ON CONTROL,"W2910"
         ;*T26556 ^
200*
GFRTST<-1>=" START REST PROCESS  "; WRITE GFRTST ON CONTROL,"W2910"
         RCV.WGT = ""
         ENTERED = ""
         NEW.SERIAL=0
         PROD.SER.CNT=0 ;*T27928
         IF DSR.SERIAL # "" THEN
            NUM.PROD = DCOUNT(DSR.PROD,VM)
            FOR P = NUM.PROD TO 1 STEP -1
               NUM.SERIAL = DCOUNT(DSR.SERIAL<1,P>,SVM)
               IF NUM.SERIAL > 0 THEN PROD.SER.CNT += 1 ;*T27928
               FOR S = 1 TO NUM.SERIAL
                  MATREAD ISTK.REC FROM INV_SERIAL, CONO:DSR.SERIAL<1,P,S> ELSE
                     MAT ISTK.REC = ""
                  END
                  IF DSR.POST.DATE<1,P,S> = "" THEN
*                 IF DSR.UOM<1,P> = "LBS" OR DSR.UOM<1,P> = "MSI" THEN
                     IF DSR.UOM<1,P>#'SHT' AND DSR.UOM<1,P>#'FT' AND DSR.UOM<1,P>#'PC' THEN
                        ENTERED+=ISTK.QTY.ENTERED
                     END ELSE
                        ENTERED+=ISTK.QTY.ENTERED*100
                     END
                  END
*T27928 v
                  IF NUM(DSR.SERIAL<1,P,S>) THEN
                     LOCATE DSR.SERIAL<1,P,S> IN RSXRF.RS.NO<1>,1 BY 'AR' SETTING SPTR ELSE
                        INS DSR.SERIAL<1,P,S> BEFORE RSXRF.RS.NO<1,SPTR>
                        INS DSR.PO.LINE<1,P> BEFORE RSXRF.LN.NO<1,SPTR>
                     END
                  END ELSE
                     LOCATE DSR.SERIAL<1,P,S> IN RSXRF.RS.NO<1>,1 BY 'AL' SETTING SPTR ELSE
                        INS DSR.SERIAL<1,P,S> BEFORE RSXRF.RS.NO<1,SPTR>
                        INS DSR.PO.LINE<1,P> BEFORE RSXRF.LN.NO<1,SPTR>
                     END
                  END
GFRTST<-1>="BEFORE MATWRITE PO.RSKI.XREF WITH ID=":CONO:PO.NO; WRITE GFRTST ON CONTROL,"W2910"
                  MATWRITEU RSXRF.REC ON PO.RSKI.XREF,CONO:PO.NO
GFRTST<-1>="AFTER MATWRITE PO.RSKI.XREF"; WRITE GFRTST ON CONTROL,"W2910"
*T27928 ^
               NEXT S
GFRTST<-1>="NUM.SERIAL ":NUM.SERIAL; WRITE GFRTST ON CONTROL,"W2910"
               IF NUM.SERIAL = 0 THEN
GFRTST<-1>="DEL DSR.SERIAL<1,P>"; WRITE GFRTST ON CONTROL,"W2910"
                  DEL DSR.SERIAL<1,P>
               END
            NEXT P
         END
1080*
         RCV.WGT = ENTERED
GFRTST<-1>="DSR.SERIAL ":DSR.SERIAL; WRITE GFRTST ON CONTROL,"W2910"
         IF TRIM(DSR.SERIAL) = "" THEN
GFRTST<-1>="DELETE DAILY_STOCK,": CONO:PO.NO:"!":MAN.NO; WRITE GFRTST ON CONTROL,"W2910"
            DELETE DAILY_STOCK, CONO:PO.NO:"!":MAN.NO
            DELETE PO.MAN.XREF, CONO:PO.NO:"!":MAN.NO
         END ELSE
GFRTST<-1>="PO.PRESENT ":PO.PRESENT; WRITE GFRTST ON CONTROL,"W2910"
            IF PO.PRESENT THEN ;*T28267
               LOCATE MAN.NO IN PO.MAN<1>,1 SETTING PINDX ELSE
                  PO.MAN = INSERT(PO.MAN,1,PINDX,0,MAN.NO)
GFRTST<-1>="MATWRITEU PO.REC ON PO,":CONO:PO.NO; WRITE GFRTST ON CONTROL,"W2910"
                  MATWRITEU PO.REC ON PO,CONO:PO.NO
               END
            END ELSE RELEASE PO,CONO:PO.NO
         END
 RETURN
END
