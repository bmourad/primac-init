SUBROUTINE JCS_GETJOB(CONO, JOBID, SCHEMA.ONLY,ERRMSG, OUT_PARAM_JOB)
OUT_PARAM_JOB := '<Job><BookedDate></BookedDate><Bookings></Bookings><JobCategoryCode></JobCategoryCode><JobCategory></JobCategory><Colors></Colors><CompanyNo></CompanyNo><CompletedDate></CompletedDate><CostedDate></CostedDate><CostTotalLabor></CostTotalLabor><CostTotalMaterial></CostTotalMaterial><CostTotalMisc></CostTotalMisc>'
OUT_PARAM_JOB := '<CostTotalOutside></CostTotalOutside><CreditApprovedTracking></CreditApprovedTracking><CsrCode></CsrCode><CsrName></CsrName><CurrentStatusCode></CurrentStatusCode><CurrentStatus></CurrentStatus><CurrentStatusDate></CurrentStatusDate><CustomerId></CustomerId><CustomerName></CustomerName><CustomerPoNo></CustomerPoNo>'
OUT_PARAM_JOB := '<Department></Department><Division></Division><DivisionDescription></DivisionDescription><DueDate></DueDate><EnteredDate></EnteredDate><EstimateCost></EstimateCost><EstimatedDate></EstimatedDate><EstimateNo></EstimateNo><EstimatedSale></EstimatedSale><EstimateType></EstimateType><FinalDeliveryDate></FinalDeliveryDate>'
OUT_PARAM_JOB := '<FinalShipDate></FinalShipDate><FinishedGoodsFlag></FinishedGoodsFlag><JobDescription></JobDescription><JobComments></JobComments><JobNo></JobNo><JobTypeCode></JobTypeCode><JobType></JobType><LastInvoiceDate></LastInvoiceDate><MarkupPercent></MarkupPercent><MasterCheck></MasterCheck><MasterJobNo></MasterJobNo><OrderQuantity></OrderQuantity><PassedtoBillDate></PassedtoBillDate>'
OUT_PARAM_JOB :='<PricePerAddlThousand></PricePerAddlThousand><PriorJobNo></PriorJobNo><ProductionStartDate></ProductionStartDate><ProofDate></ProofDate><QuotedAmount></QuotedAmount><QuotedDate></QuotedDate><ReservedPo></ReservedPo><SalesCode></SalesCode><SalesRepCode></SalesRepCode><SalesRepName></SalesRepName><ShipViaCode></ShipViaCode><ShipVia></ShipVia><SisActive></SisActive><SisComments></SisComments><Spoilage></Spoilage><TotalBalance></TotalBalance><TotalCost></TotalCost><TotalDirectCost></TotalDirectCost><TotalInvoiced></TotalInvoiced><TotalSale></TotalSale></Job>'
SCHEMA.ONLY="1"
$INCLUDE JCS.CPYLIB JOB
$INCLUDE OPS.CPYLIB JOB.FNGD.STATS
$INCLUDE PMC.CPYLIB CSR.CODE
$INCLUDE PMC.CPYLIB CUSTOMER
$INCLUDE JES.CPYLIB ESTIMATE
 $INCLUDE JES.CPYLIB ESTIMATOR
$INCLUDE PMC.CPYLIB SALESMAN
$INCLUDE PMC.CPYLIB DIVISION
$INCLUDE PMC.CPYLIB SHIP.VIA
OPEN '','JOB' TO JOB ELSE
  ERRMSG = 'CANNOT OPEN JOB FILE'   
  GOTO 99999
END
OPEN '','JOB.FNGD.STATS' TO JOB.FNGD.STATS ELSE
  ERRMSG = 'CANNOT OPEN JOB.FNGD.STATS FILE'   
  GOTO 99999
  RETURN
END
OPEN '','CSR.CODE' TO CSR.CODE ELSE
  ERRMSG = 'CANNOT OPEN CSR.CODE FILE'   
  GOTO 99999
  RETURN
END
OPEN '','CUSTOMER' TO CUSTOMER ELSE
  ERRMSG = 'CANNOT OPEN CUSTOMER FILE'   
  GOTO 99999
  RETURN
END
OPEN '','ESTIMATE' TO ESTIMATE ELSE
  ERRMSG = 'CANNOT OPEN ESTIMATE FILE'   
  GOTO 99999
  RETURN
END
OPEN '','ESTIMATOR' TO ESTIMATOR ELSE
ERRMSG = 'CANNOT OPEN ESTIMATOR FILE'
GOTO 99999
RETURN
END
OPEN '','SALESMAN' TO SALESMAN ELSE
  ERRMSG = 'CANNOT OPEN SALESMAN FILE'   
  GOTO 99999
  RETURN
END
OPEN '','DIVISION' TO DIVISION ELSE
  ERRMSG = 'CANNOT OPEN DIVISION FILE'   
  GOTO 99999
  RETURN
END
OPEN '','SHIP.VIA' TO SHIP.VIA ELSE
  ERRMSG = 'CANNOT OPEN SHIP VIA FILE'   
  GOTO 99999
  RETURN
END
OPEN '','CONTROL' TO CONTROL ELSE STOP
MATREAD JOB.REC FROM JOB, CONO:JOBID THEN
  SCHEMA.ONLY="0"
  OUT_PARAM_JOB = '<Job>'
  OUT_PARAM_JOB := '<BookedDate>' : OCONV(JOB.TRACK.DATE<1,1>, "D2/") : '</BookedDate>'
  JOB_FNGD_FLAG = ""
  JOB_CUR_STATUS = ""
  MATREAD JFS.REC FROM JOB.FNGD.STATS, CONO:JOBID THEN
    IF JFS.PROD # "" THEN
      JOB_FNGD_FLAG = 1
    END ELSE
      JOB_FNGD_FLAG = 0
    END
  END ELSE
    JOB_FNGD_FLAG = 0
  END
  JOB_CUR_STATUS = FIELD(JOB.STATUS,@VM,1)
  IF JOB_FNGD_FLAG = 1 THEN JOB_BOOKINGS = 0 ELSE IF JOB_CUR_STATUS = 4 THEN JOB_BOOKINGS = 0 ELSE IF JOB_CUR_STATUS > 5 THEN JOB_BOOKINGS = 0 ELSE JOB_BOOKINGS = JOB.EST.SALE - JOB.TOT.INV
   OUT_PARAM_JOB := '<Bookings>' : OCONV(JOB_BOOKINGS,'MD2') : '</Bookings>'
 OUT_PARAM_JOB := '<Colors>' : JOB.COLORS<1,1> : '</Colors>'
 OUT_PARAM_JOB := '<CompanyNo>' : CONO : '</CompanyNo>'
OUT_PARAM_JOB := '<CompletedDate>' : OCONV(JOB.TRACK.DATE<1,10>, "D2/") : '</CompletedDate>'
OUT_PARAM_JOB := '<CostedDate>' : OCONV(JOB.TRACK.DATE<1,8>, "D2/")'</CostedDate>'
 OUT_PARAM_JOB := '<CostTotalLabor>' : OCONV(SUM(JOB.LB.COST), "MD2") : '</CostTotalLabor>'
OUT_PARAM_JOB := '<CostTotalMaterial>' : OCONV(SUM(JOB.MT.COST), "MD2") :'</CostTotalMaterial>'
 OUT_PARAM_JOB := '<CostTotalMisc>' : OCONV(SUM(JOB.MS.COST), "MD2") : '</CostTotalMisc>'
 OUT_PARAM_JOB := '<CostTotalOutside>' : OCONV(SUM(JOB.OS.COST), "MD2") :'</CostTotalOutside>'
  OUT_PARAM_JOB := '<CreditApprovedTracking>' : JOB.CREDIT : '</CreditApprovedTracking>'
  OUT_PARAM_JOB := '<CsrCode>' : JOB.CSR : '</CsrCode>'
  MATREAD CSR.REC FROM CSR.CODE, CONO:JOB.CSR ELSE MAT CSR.REC = ""
  OUT_PARAM_JOB := '<CsrName>' : CSR.DESC : '</CsrName>'
*  OUT_PARAM_JOB := '<CurrentStatusCode>' : JOB_CUR_STATUS : '</CurrentStatusCode>'
  STATUS = ''
  BEGIN CASE
    CASE JOB.STATUS<1,1>=""
      STATUS="BOOKED"
    CASE JOB.STATUS<1,1>="7"
      STATUS="READY TO PURGE"
    CASE JOB.STATUS<1.1>="8"
      STATUS="WAS PURGED"
    CASE JOB.STATUS<1,1>="9"
      STATUS="CANCELLED"
    CASE JOB.TRACK.DATE<1,10># ""
      BEGIN CASE
        CASE JOB.STATUS<1,1> = "1"
          STATUS="IN PROCESS"
        CASE JOB.STATUS<1,1> = "5"
          STATUS="REOPENED"
        CASE JOB.STATUS<1,1> = "3"
          STATUS="INVOICED"
        CASE 1
          STATUS="COMPLETED"
      END CASE
    CASE JOB.TRACK.DATE<1,9> #""
      BEGIN CASE
        CASE JOB.STATUS<1,1> = "1"
          STATUS="IN PROCESS"
        CASE JOB.STATUS<1,1> = "5"
          STATUS="REOPENED"
        CASE 1
          STATUS="INVOICED"
      END CASE
    CASE JOB.TRACK.DATE<1,8> # ""
      STATUS = "COSTED"
    CASE JOB.TRACK.DATE<1,7> # ""
      STATUS = "READY TO BILL"
    CASE JOB.TRACK.DATE<1,6> # ""
      STATUS = "DELIVERED"
    CASE JOB.TRACK.DATE<1,5> # ""
      STATUS = "IN PROCESS"
    CASE JOB.TRACK.DATE<1,3> # ""
      STATUS = "IN PROCESS"
    CASE JOB.TRACK.DATE<1,1>="1"
      STATUS = "IN PROCESS"
    CASE 1
      STATUS = JOB.STATUS<1,1>
  END CASE
  OUT_PARAM_JOB := '<CurrentStatus>' : STATUS : '</CurrentStatus>'
  OUT_PARAM_JOB := '<CurrentStatusDate>' : OCONV(JOB.STAT.DATE<1,1>, "D2/"):'</CurrentStatusDate>'
OUT_PARAM_JOB := '<CurrentStatusCode>' : JOB_CUR_STATUS : '</CurrentStatusCode>'
  OUT_PARAM_JOB := '<CustomerId>' : JOB.CUST : '</CustomerId>'
  OUT_PARAM_JOB := '<CustomerName>' : OCONV(CONO:JOB.CUST,"TCUSTOMER;X;1;1") : '</CustomerName>'
  OUT_PARAM_JOB := '<CustomerPoNo>' : JOB.CUST.PO : '</CustomerPoNo>'
  OUT_PARAM_JOB := '<Department>' : JOB.DEPT : '</Department>'
  OUT_PARAM_JOB := '<Division>' : JOB.DIV : '</Division>'
  OUT_PARAM_JOB := '<DivisionDescription>' : OCONV(CONO:JOB.DIV,"TDIVISION;X;1;1") : '</DivisionDescription>'
  OUT_PARAM_JOB := '<DueDate>' : OCONV(JOB.TRACK.DATE<1,4>, "D2/") : '</DueDate>'
  OUT_PARAM_JOB := '<EnteredDate>' : OCONV(JOB.TRACK.DATE<1,2>, "D2/") : '</EnteredDate>'
  OUT_PARAM_JOB := '<EstimateCost>' : OCONV(JOB.EST.COST, "MD2") : '</EstimateCost>'
  OUT_PARAM_JOB := '<EstimatedDate>' : OCONV(JOB.TRACK.DATE<1,1>, "D2/"):'</EstimatedDate>'
 OUT_PARAM_JOB := '<EstimatedSale>' : OCONV(JOB.EST.SALE, "MD2") : '</EstimatedSale>'
  OUT_PARAM_JOB := '<EstimateNo>' : JOB.EST : '</EstimateNo>'
  OUT_PARAM_JOB := '<EstimateType>' : JOB.EST.TYPE : '</EstimateType>'
  OUT_PARAM_JOB := '<FinalDeliveryDate>' : OCONV(JOB.TRACK.DATE<1,6>, "D2/") :'</FinalDeliveryDate>'
  OUT_PARAM_JOB := '<FinalShipDate>' : OCONV(JOB.TRACK.DATE<1,6>, "D2/") : '</FinalShipDate>'
  OUT_PARAM_JOB := '<FinishedGoodsFlag>' : JOB_FNGD_FLAG : '</FinishedGoodsFlag>'
OUT_PARAM_JOB := '<JobCategory>' : OCONV(CONO:JOB.CATG,"TJOB.CATEGORY;X;1;1")  : '</JobCategory>'
OUT_PARAM_JOB := '<JobCategoryCode>' : JOB.CATG  : '</JobCategoryCode>'
  OUT_PARAM_JOB := '<JobCommentsLine1>' : CHANGE (JOB.COMMENTS,@VM,"\r\n") : '</JobCommentsLine1>'
OUT_PARAM_JOB := '<JobCommentsLine2>' : CHANGE (JOB.COMMENTS,@VM,"\r\n") : '</JobCommentsLine2>'
OUT_PARAM_JOB := '<JobDescription>' : CHANGE(JOB.DESC,@VM,"\r\n") : '</JobDescription>'
  OUT_PARAM_JOB := '<JobNo>' : JOBID : '</JobNo>'
*  OUT_PARAM_JOB := '<JobTypeCode>' : JOB.TYPE<1,1> : '</JobTypeCode>'
  TYPE = ''
  BEGIN CASE
    CASE JOB.TYPE<1,1> = "C"
      TYPE = "Customer Change Order"
    CASE JOB.TYPE<1,1> = "S"
      TYPE = "Spoilage"
    CASE JOB.TYPE<1,1> = "R"
      TYPE = "Regular"
    CASE JOB.TYPE<1,1> = "N"
      TYPE = "Non Chargable"
  END CASE
  OUT_PARAM_JOB : = '<JobType>' : TYPE : '</JobType>'
OUT_PARAM_JOB := '<JobTypeCode>' : JOB.TYPE<1,1> : '</JobTypeCode>'
  OUT_PARAM_JOB := '<LastInvoiceDate>' : OCONV(JOB.TRACK.DATE<1,9>, "D2/"):'</LastInvoiceDate>'
  OUT_PARAM_JOB := '<MarkupPercent>' : OCONV(JOB.MARKUP, "MD2") : '</MarkupPercent>'
  CHK.MASTER = ""
  GOSUB GET.JOB.MASTER
  OUT_PARAM_JOB := '<MasterCheck>' : CHK.MASTER : '</MasterCheck>'
  OUT_PARAM_JOB := '<MasterJobNo>' : JOB.MASTER<1,1> : '</MasterJobNo>'
OUT_PARAM_JOB := '<OrderNo>' : JOB.ORD : '</OrderNo>'
  OUT_PARAM_JOB := '<OrderQuantity>' : OCONV(JOB.QTY<1,1>, "MD0") : '</OrderQuantity>'
  OUT_PARAM_JOB := '<PassedtoBillDate>' :OCONV(JOB.TRACK.DATE<1,7>, "D2/"):'</PassedtoBillDate>'
  OUT_PARAM_JOB :='<PricePerAddlThousand>' : OCONV(JOB.PRICE.PER.THOU, "MD2") : '</PricePerAddlThousand>'
  OUT_PARAM_JOB := '<PriorJobNo>' : JOB.PRIOR.JOB<1,1> : '</PriorJobNo>'
  OUT_PARAM_JOB := '<ProductionStartDate>' :OCONV(JOB.TRACK.DATE<1,5>, "D2/"):'</ProductionStartDate>'
  OUT_PARAM_JOB := '<ProofDate>' :OCONV(JOB.TRACK.DATE<1,3>, "D2/")'</ProofDate>'
  OUT_PARAM_JOB := '<QuotedAmount>' : OCONV(JOB.CONF.AMT<1,1>, "MD2") : '</QuotedAmount>'
  OUT_PARAM_JOB := '<QuotedDate>' :OCONV(JOB.TRACK.DATE<1,2>, "D2/"):'</QuotedDate>'
  OUT_PARAM_JOB := '<ReservedPo>' : JOB.JCS.FLAG<1,1> : '</ReservedPo>'
  OUT_PARAM_JOB := '<SalesCode>' : JOB.SALES.CODE : '</SalesCode>'
  OUT_PARAM_JOB := '<SalesRepCode>' : JOB.SLSMN : '</SalesRepCode>'
  OUT_PARAM_JOB := '<SalesRepName>' : OCONV(CONO:JOB.SLSMN,"TSALESMAN;X;1;1") : '</SalesRepName>'
  OUT_PARAM_JOB := '<ShipVia>' : OCONV(CONO:JOB.SHIP.VIA,"TSHIP.VIA;X;1;1"):'</ShipVia>'
OUT_PARAM_JOB := '<ShipViaCode>' : JOB.SHIP.VIA : '</ShipViaCode>'
  ACTIVE = 0
  GOSUB SIS_ACTIVE
  OUT_PARAM_JOB := '<SisActive>' : ACTIVE : '</SisActive>'
  OUT_PARAM_JOB := '<SisComments>' : JOB.COMMENTS<1,1>[1,50] : '</SisComments>'
  OUT_PARAM_JOB := '<Spoilage>' : OCONV(JOB.SPOILAGE<1,1>, "MD2") : '</Spoilage>'
*  OUT_PARAM_JOB := '<TotalBalance>' : OCONV(JOB.TOT.BAL<1,1>, "MD2") : '</TotalBalance>'
MATREAD CUST.REC FROM CUSTOMER, CONO:JOB.CUST ELSE
      ERRMSG = "CANNOT LOCATE CUSTOMER - ":JOB.CUST
     GOTO 99999
   END
1250 CUR.JOB.BAL = SUM(CUST.JOB.BAL)
   LOCATE JOBNO IN CUST.JOB<1>,1 SETTING JFND THEN
      CUR.JOB.BAL = CUR.JOB.BAL - CUST.JOB.BAL<1,JFND>
   END
   CUR.ORD.BAL = SUM(CUST.ORD.BAL)
*
3100 QUOTED.AMT = 0
   LOCATE "4" IN JOB.STATUS<1>,1 SETTING DUMMY ELSE
      IF JOB.TOT.INV > 0 THEN
         QUOTED.AMT = JOB.CONF.AMT - JOB.TOT.INV
      END ELSE
         QUOTED.AMT = JOB.CONF.AMT
      END
      IF QUOTED.AMT < 0 THEN QUOTED.AMT = 0
   END
*
TOT.SALE = 0; AVAIL = 0
TOT.SALE = CUST.AR.BAL + CUR.JOB.BAL + CUR.ORD.BAL + QUOTED.AMT
AVAIL = CUST.CR.LIMIT * 100 - CUST.AR.BAL - CUR.JOB.BAL - CUR.ORD.BAL - QUOTED.AMT
  OUT_PARAM_JOB := '<CreditCode>' : CUST.CREDIT : '</CreditCode>'
  OUT_PARAM_JOB := '<CreditLimit>' : CUST.CR.LIMIT : '</CreditLimit>'
  OUT_PARAM_JOB := '<TotalBalance>' : OCONV(TOT.SALE<1,1>, "MD2") : '</TotalBalance>'
OUT_PARAM_JOB := '<TotalAvail>' : OCONV(AVAIL,"MD2") : '</TotalAvail>'
OUT_PARAM_JOB := '<OpenReceivables>' : OCONV(CUST.AR.BAL,"MD2") : '</OpenReceivables>'
OUT_PARAM_JOB := '<OpenJobs>' : OCONV(CUR.JOB.BAL,"MD2") : '</OpenJobs>'
OUT_PARAM_JOB := '<OpenOrders>' : OCONV(CUR.ORD.BAL,"MD2") : '</OpenOrders>'
OUT_PARAM_JOB := '<QuotedAmount>' : OCONV(QUOTED.AMT,"MD2") : '</QuotedAmount>'
  OUT_PARAM_JOB := '<TotalCost>' : OCONV(JOB.TOT.COST<1,1>, "MD2") : '</TotalCost>'
  OUT_PARAM_JOB := '<TotalDirectCost>' : OCONV(JOB.TOT.DCOST<1,1>, "MD2") : '</TotalDirectCost>'
  OUT_PARAM_JOB := '<TotalInvoiced>' : OCONV(JOB.TOT.INV<1,1>, "MD2") : '</TotalInvoiced>'
  OUT_PARAM_JOB := '<TotalSale>' : OCONV(JOB.TOT.SALE<1,1>, "MD2") : '</TotalSale>'
  OUT_PARAM_JOB := '</Job>'
END
RETURN
* 
GET.JOB.MASTER: 
  IF JOBID = JOB.MASTER<1,1> AND JOB.SUBS = "" THEN
    CHK.MASTER = 0
  END ELSE
    CHK.MASTER = 1
  END
  RETURN 
*
99999*
IF ERRMSG <> "" THEN
      ERRMSG = "ERROR FROM JCS_GETJOB --> " : ERRMSG
     CALL WRITELOG(ERRMSG)
END
RETURN
SIS_ACTIVE: 
  STATUS = ""
  BEGIN CASE
    CASE JOB.STATUS<1,1> = ""
      STATUS = "BOOKED"
    CASE JOB.TRACK.DATE<1,10> # ""
      BEGIN CASE
        CASE JOB.STATUS<1,1> = "1"
          STATUS = "IN PROCESS"
        CASE JOB.STATUS<1,1> = "5"
          STATUS="REOPENED"
        CASE JOB.STATUS<1,1> = "3"
          STATUS="INVOICED"
        CASE 1
          STATUS = "COMPLETED"
      END CASE
    CASE JOB.TRACK.DATE<1,9> # ""
      BEGIN CASE
        CASE JOB.STATUS<1,1> = "1"
          STATUS = "IN PROCESS"
        CASE JOB.STATUS<1,1> = "5"
          STATUS="REOPENED"
        CASE 1
          STATUS = "INVOICED"
      END CASE
    CASE JOB.TRACK.DATE<1,8> # ""
      STATUS = "COSTED"
    CASE JOB.TRACK.DATE<1,7> # ""
      STATUS = "RDY-TO-BILL"
    CASE JOB.TRACK.DATE<1,6> # ""
      STATUS = "DELIVERED"
    CASE JOB.TRACK.DATE<1,5> # ""
      STATUS = "IN PROCESS"
    CASE JOB.TRACK.DATE<1,3> # ""
      STATUS = "IN PROCESS"
    CASE JOB.STATUS<1,1> = "1"
      STATUS = "IN PROCESS"
    CASE 1
      STATUS = JOB.STATUS<1,1>
  END CASE
  BEGIN CASE
    CASE STATUS = "BOOKED"
      ACTIVE = 1
    CASE STATUS = "IN PROCESS"
      ACTIVE = 1
    CASE STATUS = "REOPENED"
      ACTIVE = 1
  END CASE
  RETURN
