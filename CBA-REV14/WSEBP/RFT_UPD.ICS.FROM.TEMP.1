SUBROUTINE RFT_UPD.ICS.FROM.TEMP.1 (CONO,MAT FILE.VARS,MAT IID.REC,ACTION.FLAG)
*********************************************************************
* REVISION    - [12.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - ICSBP
* PROGRAM     - TRAN.UPDATE
* BY          - EDVARD PITKA
* DATE
* DESCRIPTION - THIS PROGRAM EITHER UPDATES INVENTORY FILES FROM
*               ...TEMP FILES OR DELETES RECORDS FROM ...TEMP FILES.
* TASK
*
*T25740 edvard 08/09/2001  REV12
**************************************************************************
*
$INCLUDE ICS.CPYLIB INV.WHSE.LOC
$INCLUDE ICS.CPYLIB INV_SERIAL
$INCLUDE ICS.CPYLIB INV_RECP_WHSE
$INCLUDE ICS.CPYLIB INV_RECEIPTS
$INCLUDE ICS.CPYLIB INV_AUDIT_HIST
$INCLUDE ICS.CPYLIB ICS.ID
$INCLUDE CPYLIB FILE.VARS
$INCLUDE CPYLIB CHAR
*
*---- OPEN ALL FILES
*
  OPEN "","COMPANY" TO COMPANY ELSE
    ERRMSG = 'COMPANY FILE MISSING'
    RETURN
  END
  OPEN "","CONTROL" TO CONTROL ELSE
    ERRMSG = 'CONTROL FILE MISSING'
    RETURN
  END
  OPEN "","DAILY_TRANSFER" TO DAILY_TRANSFER ELSE
    ERRMSG = 'DAILY_TRANSFER FILE MISSING'
    RETURN
  END
  OPEN "","EMPLOYEE" TO EMPLOYEE ELSE
    ERRMSG = 'EMPLOYEE FILE MISSING'
    RETURN
  END
  OPEN "","PO" TO PO ELSE
    ERRMSG = 'PO FILE MISSING'
    RETURN
  END
  OPEN "","INV_SERIAL" TO INV_SERIAL ELSE
    ERRMSG = 'INV_SERIAL FILE MISSING'
    RETURN
  END
  OPEN "","CATEGORY" TO CATEGORY ELSE
    ERRMSG = 'CATEGORY FILE MISSING'
    RETURN
  END
  OPEN "","INVENTORY" TO INVENTORY ELSE
    ERRMSG = 'INVENTORY FILE MISSING'
    RETURN
  END
  OPEN "","INV.WHSE" TO INV.WHSE ELSE
    ERRMSG = 'INV.WHSE FILE MISSING'
    RETURN
  END
  OPEN "","INV.WHSE.LOC" TO INV.WHSE.LOC ELSE
    ERRMSG = 'INV.WHSE.LOC FILE MISSING'
    RETURN
  END
  OPEN "","INV.HIST" TO INV.HIST ELSE
    ERRMSG = 'INV.HIST FILE MISSING'
    RETURN
  END
  OPEN "","INV.TRAN.HIST" TO INV.TRAN.HIST ELSE
    ERRMSG = 'INV.TRAN.HIST FILE MISSING'
    RETURN
  END
  OPEN "","RS.XFER" TO RS.XFER ELSE
    ERRMSG = 'RS.XFER FILE MISSING'
    RETURN
  END
  OPEN "","TRANSFER" TO TRANSFER ELSE
    ERRMSG = 'TRANSFER FILE MISSING'
    RETURN
  END
  OPEN "","JOB" TO JOB ELSE
    ERRMSG = 'JOB FILE MISSING'
    RETURN
  END
  OPEN "","JOB.STATS" TO JOB.STATS ELSE
    ERRMSG = 'JOB.STATS FILE MISSING'
    RETURN
  END
  OPEN '','INV.WHSE.LOC.TEMP' TO INV.WHSE.LOC.TEMP ELSE
    ERRMSG = 'INV.WHSE.LOC.TEMP FILE MISSING'
    RETURN
  END
  OPEN '','INV_SERIAL_TEMP' TO INV_SERIAL_TEMP ELSE
    ERRMSG = 'INV_SERIAL_TEMP FILE MISSING'
    RETURN
  END
  OPEN '','INV_AUDIT_HIST' TO INV_AUDIT_HIST ELSE
    ERRMSG = 'INV_AUDIT_HIST FILE MISSING'
    RETURN
  END
  OPEN '','INV_AUDIT_HIST_TEMP' TO INV_AUDIT_HIST_TEMP ELSE
    ERRMSG = 'INV_AUDIT_HIST_TEMP FILE MISSING'
    RETURN
  END
  OPEN '','INV_AUDIT_TAG' TO INV_AUDIT_TAG ELSE
    ERRMSG = 'INV_AUDIT_TAG FILE MISSING'
    RETURN
  END
  OPEN '','INV_RECEIPTS' TO INV_RECEIPTS ELSE
    ERRMSG = 'INV_RECEIPTS FILE MISSING'
    RETURN
  END
  OPEN '','INV_RECEIPTS_TEMP' TO INV_RECEIPTS_TEMP ELSE
    ERRMSG = 'INV_RECEIPTS_TEMP FILE MISSING'
    RETURN
  END
  OPEN '','INV_RECP_WHSE' TO INV_RECP_WHSE ELSE
    ERRMSG = 'INV_RECP_WHSE FILE MISSING'
    RETURN
  END
  OPEN '','INV_RECP_WHSE_TEMP' TO INV_RECP_WHSE_TEMP ELSE
    ERRMSG = 'INV_RECP_WHSE_TEMP FILE MISSING'
    RETURN
  END
  OPEN '','WAREHOUSE' TO WAREHOUSE ELSE
   ERRMSG = 'WAREHOUSE FILE MISSING'
   RETURN
  END
*
MATREAD IID.REC FROM CONTROL,"TEMP.IID.REC.ID" ELSE MAT IID.REC = ''
PRTMP = ''
PRTMP<1> = "MAIN PROCESSING ACTION.FLAG ~~":ACTION.FLAG;WRITE PRTMP ON CONTROL,"TEMP1106"
BEGIN CASE
  CASE ACTION.FLAG=1
    GOSUB DELETE.TMP.REC
  CASE ACTION.FLAG=2
    GOSUB UPDATE.REC
END CASE
GOTO 99999
**************************************************************************
*
*****************
UPDATE.REC: 
*****************
;*
;* update INV.RECEIPTS file
;* update INV_RECP_WHSE file
;* update INV_SERIAL file
;* update INV_AUDIT_HIST file
;* update INV.WHSE.LOC file
;* update INV_AUDIT_TAG
;*
PRTMP<-1> = "IN UPDATE.REC BLOCK";WRITE PRTMP ON CONTROL,"TEMP1106"
RECP.CNT = DCOUNT(IID.INVR<1>,VM)
FOR R = 1 TO RECP.CNT
  INVR.ID = IID.INVR<1,R>
  MATREADU INVR.REC FROM INV_RECEIPTS_TEMP,INVR.ID THEN
    IF INVR.POST.DATE ="" THEN
      INVR.POST.DATE=DATE()
    END
PRTMP<-1> = "BEFORE MATWRITE INV_RECEIPTS";WRITE PRTMP ON CONTROL,"TEMP1106"
    MATWRITE INVR.REC ON INV_RECEIPTS,INVR.ID
PRTMP<-1> = "AFTER MATWRITE INV_RECEIPTS";WRITE PRTMP ON CONTROL,"TEMP1106"
    DELETE INV_RECEIPTS_TEMP,INVR.ID
  END
NEXT R
;*
RCPWHSE.CNT = DCOUNT(IID.IRW<1>,VM)
FOR R = 1 TO RCPWHSE.CNT
  IRW.ID = IID.IRW<1,R>
  MATREADU IRW.REC FROM INV_RECP_WHSE_TEMP,IRW.ID THEN
PRTMP<-1> = "BEFORE MATWRITE INV_RECP_WHSE";WRITE PRTMP ON CONTROL,"TEMP1106"
    MATWRITE IRW.REC ON INV_RECP_WHSE,IRW.ID
PRTMP<-1> = "AFTER MATWRITE INV_RECP_WHSE";WRITE PRTMP ON CONTROL,"TEMP1106"
    DELETE INV_RECP_WHSE_TEMP,IRW.ID
  END
NEXT R
;*
SER.CNT = DCOUNT(IID.ISTK,VM)
FOR S = 1 TO SER.CNT
  S.ID = IID.ISTK<1,S>
  MATREADU ISTK.REC FROM INV_SERIAL_TEMP,S.ID THEN
PRTMP<-1> = "BEFORE MATWRITE INV_SERIAL";WRITE PRTMP ON CONTROL,"TEMP1106"
    MATWRITE ISTK.REC ON INV_SERIAL,S.ID
PRTMP<-1> = "AFTER MATWRITE INV_SERIAL";WRITE PRTMP ON CONTROL,"TEMP1106"
    DELETE INV_SERIAL_TEMP,S.ID
  END
NEXT S
;*
NULL.REC=''
INAH.CNT = DCOUNT(IID.INAH,VM)
FOR IH = 1 TO INAH.CNT
  INAH.ID = IID.INAH<1,IH>
  MATREADU INAH.REC FROM INV_AUDIT_HIST_TEMP,INAH.ID THEN
PRTMP<-1> = "BEFORE MATWRITE INV_AUDIT_HIST";WRITE PRTMP ON CONTROL,"TEMP1106"
    MATWRITE INAH.REC ON INV_AUDIT_HIST,INAH.ID
PRTMP<-1> = "AFTER MATWRITE INV_AUDIT_HIST";WRITE PRTMP ON CONTROL,"TEMP1106"
;* transfers within division do not
;* create any accounting activity
IF INAH.SRC#'IT' THEN
    WRITE NULL.REC ON INV_AUDIT_TAG,INAH.ID
END
    DELETE INV_AUDIT_HIST_TEMP,INAH.ID
  END
NEXT IH
;*
LOC.CNT = DCOUNT(IID.IWLO,VM)
FOR LOC=1 TO LOC.CNT
  IWLO.ID=IID.IWLO<1,LOC>
  MATREADU IWLO.REC FROM INV.WHSE.LOC.TEMP,IWLO.ID  THEN
PRTMP<-1> = "BEFORE MATWRITE INV.WHSE.LOC";WRITE PRTMP ON CONTROL,"TEMP1106"
  MATWRITE IWLO.REC ON INV.WHSE.LOC,IWLO.ID
PRTMP<-1> = "AFTER MATWRITE INV.WHSE.LOC";WRITE PRTMP ON CONTROL,"TEMP1106"
 DELETE INV.WHSE.LOC.TEMP,IWLO.ID
  END
NEXT LOC
;*
;* clear all arrays
;*
MAT IID.REC = ""
MAT INAH.REC=""
MAT IWLO.REC=""
MAT ISTK.REC=""
MAT INVR.REC=""
MAT IRW.REC=""
PRTMP<1> = "END SUBROUTINE";WRITE PRTMP ON CONTROL,"TEMP1106"
RETURN
*
****************
DELETE.TMP.REC: 
****************
*
;* delete INV.RECEIPTS_TEMP record
;* delete INV_RECP_WHSE_TEMP record
;* delete INV_SERIAL_TEMP record
;* delete INV_AUDIT_HIST_TEMP record
;* delete INV.WHSE_TEMP record
;* delete INV.WHSE.LOC_TEMP record
;*
RECP.CNT = DCOUNT(IID.INVR<1>,VM)
FOR R = 1 TO RECP.CNT
  INVR.ID = IID.INVR<1,R>
  DELETE INV_RECEIPTS_TEMP,INVR.ID
NEXT R
;*
RCPWHSE.CNT = DCOUNT(IID.IRW<1>,VM)
FOR R = 1 TO RCPWHSE.CNT
  IRW.ID = IID.IRW<1,R>
  DELETE INV_RECP_WHSE_TEMP,IRW.ID
NEXT R
;*
SER.CNT = DCOUNT(IID.ISTK,VM)
FOR S = 1 TO SER.CNT
  S.ID = IID.ISTK<1,S>
  DELETE INV_SERIAL_TEMP,S.ID
NEXT S
;*
INAH.CNT = DCOUNT(IID.INAH,VM)
FOR IH = 1 TO INAH.CNT
  INAH.ID = IID.INAH<1,IH>
  DELETE INV_AUDIT_HIST_TEMP,INAH.ID
NEXT IH
;*
LOC.CNT = DCOUNT(IID.IWLO,VM)
FOR LOC=1 TO LOC.CNT
  IWLO.ID=IID.IWLO<1,LOC>
  DELETE INV.WHSE.LOC.TEMP,IWLO.ID
NEXT LOC
;*
;*remove FIFO from INV.WHSE
;*
;*
;* clear all arrays
;*
MAT IID.REC = ""
MAT INAH.REC=""
MAT IWLO.REC=""
MAT ISTK.REC=""
MAT INVR.REC=""
MAT IRW.REC=""
RETURN
99999 END
