SUBROUTINE WBP_WFSERVICE(VAL.STR)
*********************************************************************
* REVISION - [12.00]
* PROGRAM  - ICS_SerialReceiptPostting_PoRecptCancelInfo
* AUTHOR   - MAGAFOOR
* DATE     - 02/16/09
* DESCRIPTION
*********************************************************************
$INCLUDE PMC.CPYLIB PO
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE CPYLIB FILE.VARS
$INCLUDE CPYLIB CHAR
$INCLUDE ICS.CPYLIB DAILY_STOCK
DEFFUN ISREGISTERED(CONO,PROCESS.NAME)
ERRMSG=''
ERR.LOG = ""
SCHEMAFLAG = 1
*---------------------- OPEN ALL FILES --------------------------
OPEN "","COMPANY" TO COMPANY ELSE
   ERRMSG = "CANNOT OPEN COMPANY FILE";GOTO 93000
END
OPEN "","CONTROL" TO CONTROL ELSE
   ERRMSG = "CANNOT OPEN CONTROL FILE";GOTO 93000
END
OPEN "","PO" TO PO ELSE
   ERRMSG = "CANNOT OPEN PO FILE"; GOTO 93000
END
OPEN '','DAILY_STOCK' TO DAILY_STOCK ELSE
   ERRMSG='DAILY_STOCK FILE IS MISSING';GOTO 93000
END
PATH = "/usr/ud/primac/rev14/base/CBA-REV14/WBPBP"
CONO = "001"
PROCESSID = "ICSRSRE"
SEND.WF.ACTIVITY = 0
WFINSTANCEID = ISREGISTERED(CONO,PROCESSID)
IF WFINSTANCEID = "" THEN 
   ERR.LOG = "ERROR = INSTANCE ID IS MISSING FOR THIS PROCESS ":PROCESSID
   GOTO 100
END ELSE
   SEND.WF.ACTIVITY = 1
END
IF SEND.WF.ACTIVITY THEN
WEB.HANDLE="";RESP.HEADERS="";RESP.DATA="";HTTP.STATUS=""
URL="http://192.168.1.14/PrimacSystems.Webservices.Rev14.Dev/ICS/WF_ReceiptPostInfo.asmx/WBP_POReceiptInfo?"
REQUEST.STATUS=createRequest(URL,"GET",WEB.HANDLE)
DEFAULT.STR = ""
IF REQUEST.STATUS THEN
   ERR.LOG = "ERROR = createRequest Failed, code is ":REQUEST.STATUS
   GOTO 100
END
KEY.STR = "CONO":@VM:"PoCode":@VM:"ProcessId":@VM:"DSRIDS"
VAL.STR = "001":@VM:"2000":@VM:"ICSRSRE":@VM:"0012000!1"
FOR I = 1 TO DCOUNT(KEY.STR,@VM)
  PARAM.STATUS = addRequestParameter(WEB.HANDLE,KEY.STR<1,I>,VAL.STR<1,I>,"")
  IF PARAM.STATUS THEN
   ERR.LOG = "ERROR = ADD PARAMETER FAILED ":PARAM.STATUS
   GOTO 100
  END
NEXT I
SUBMIT.STATUS=submitRequest(WEB.HANDLE,"","",RESP.HEADERS,RESP.DATA,HTTP.STATUS)
IF SUBMIT.STATUS THEN
   ERR.LOG = "ERROR = SUBMIT REQUEST FAILED ":HTTP.STATUS :"-":SUBMIT.STATUS
   GOTO 100
END
VAR.LIST = 'PoData':@AM:'WFINSTANCEID':@AM:'MANIFEST':@AM:'PO.LINE':@AM:'PRODUCT':@AM:'WAREHOUSE':@AM:'LOCATION':@AM:'SERIAL':@AM:'DSR_QUANTITY':@AM:'ORDERED_PO_QTY':@AM:'RECEVD_PO_QTY':@AM:'OPEN_PO_QTY':@AM:'CANCEL_PO_QTY'
      FOR XX = 1 TO DCOUNT(VAR.LIST,@AM)
         VAR.NAME = VAR.LIST<XX>
         GOSUB PARSEXML
         PRINT VAR.NAME:" = ":PARSE.STRNG
      NEXT XX
END
100*
   IF ERR.LOG # "" THEN OSWRITE ERR.LOG ON PATH:"/LogFile.txt"
RETURN
*
*--> LOCATE XML VALUES
*
PARSEXML:
      XML.STRNG = RESP.DATA
      ST.VAR.NAME = "<":VAR.NAME
      END.VAR.NAME = "</":VAR.NAME:">"
      TAG.POS = INDEX(XML.STRNG,ST.VAR.NAME,1)
      NEW.STR = XML.STRNG[TAG.POS,LEN(XML.STRNG)]
      ST.POS = INDEX(NEW.STR,'>',1)+ TAG.POS
** THIS IS WILL GET THE LENGTH OF THE TAG
      END.POS = INDEX(XML.STRNG,END.VAR.NAME,1)
      IF ST.POS > 0 AND END.POS > ST.POS THEN
         STRT = ST.POS
         LNG = END.POS - STRT            ; * TOTAL LENGTH OF STRING
         PARSE.STRNG = XML.STRNG[STRT,LNG]
         PARSE.STRNG = TRIM(PARSE.STRNG)
      END ELSE
         ERR.MSG = 'XML document is missing ':VAR.NAME:' Data'
         PARSE.STRNG = ''
         PRINT ERR.MSG
      END
RETURN
93000
RETURN
