SUBROUTINE POR_REQUISITIONSERVICE_GENERATEBARCODEDATA(CONO,PO.DATA,ERRMSG,STRXML)
*********************************************************
* PROGRAM     - POR_REQUISITIONSERVICE_GENERATEBARCODEDATA
* BY          - YAKUB ALI KHAN
* DATE        - 06/15/2009
*********************************************************
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB CATEGORY
$INCLUDE ICS.CPYLIB PO.RSKI.XREF
$INCLUDE ICS.CPYLIB INV_SERIAL
$INCLUDE CPYLIB CHAR
DEFFUN PRIDGET_GET_SERIAL_SEQ(CONO,CONTROL.FILE,INV_SERIAL.FILE)
OPEN '','CONTROL' TO CONTROL ELSE ERRMSG = 'CONTROL FILE IS MISSING'; GOTO 93000
OPEN '','COMPANY' TO COMPANY ELSE ERRMSG = 'COMPANY FILE IS MISSING'; GOTO 93000
OPEN '','INVENTORY' TO INVENTORY ELSE ERRMSG = 'INVENTORY FILE IS MISSING'; GOTO 93000
OPEN '','CATEGORY' TO CATEGORY ELSE ERRMSG = 'CATEGORY FILE IS MISSING'; GOTO 93000
OPEN '','INV_SERIAL' TO INV_SERIAL ELSE ERRMSG = 'INV_SERIAL FILE IS MISSING'; GOTO 93000
OPEN '','INV_SERIAL_DELETED' TO INV_SERIAL_DELETED ELSE ERRMSG = 'INV_SERIAL_DELETED FILE IS MISSING'; GOTO 93000
OPEN '','PO.RSKI.XREF' TO PO.RSKI.XREF ELSE ERRMSG = 'PO.RSKI.XREF FILE IS MISSING'; GOTO 93000
ITEM.LIST = ""
ITEM.LIST2 = ""
XYZ = ""
*
*---- GENERATE BARCODE LABEL DATA
*
PO.CODE = PO.DATA<1>
PO.PROD.NUM = PO.DATA<2>
PO.WHSE =PO.DATA<3>
PO.GROS.PRICE =PO.DATA<4>
PO.UNIT.FLG =PO.DATA<5>
PO.NO.OF.ROLLS = PO.DATA<6>
*
20000*
   VALUE = "N"
   PO.LINE.CNT = DCOUNT(PO.PROD.NUM,VM)
   BCFLAG=0
   FOR PO.LINE.PTR=1 TO PO.LINE.CNT WHILE BCFLAG=0
      MATREAD INV.REC FROM INVENTORY, CONO:PO.PROD.NUM<1,PO.LINE.PTR> ELSE MAT INV.REC = ""
      MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE ELSE MAT CATG.REC=''
      IF CATG.TRK.LVL='S' AND CATG.BARCODE='Y' THEN
         BCFLAG=1
      END
   NEXT PO.LINE.PTR
   IF BCFLAG THEN
     VALUE = 'Y'
   END
   IF VALUE = 'Y' THEN
* 25740 
*     MATREADU RSXRF.REC FROM PO.RSKI.XREF, CONO:PO.CODE ELSE
      MAT RSXRF.REC = ""
*     END
      PO.LINE.CNT = DCOUNT(PO.PROD.NUM,VM)
      CNT = 0 ;* 25740
*     CNT = DCOUNT(RSXRF.RS.NO,VM)
      FOR PO.LINE.PTR = 1 TO PO.LINE.CNT
         LINE.CNT = 0
         MATREAD INV.REC FROM INVENTORY, CONO:PO.PROD.NUM<1,PO.LINE.PTR> ELSE
            ERRMSG = "NO INVENTORY RECORD FOR PRODUCT " PO.PROD.NUM<1,PO.LINE.PTR>
            GOSUB 93000
            RETURN
         END
         MATREAD CATG.REC FROM CATEGORY, CONO:INV.LINE ELSE MAT CATG.REC = ""
         IF CATG.TRK.LVL='S' AND CATG.BARCODE='Y' THEN
*T25940 v
*           CMD='SSELECT INV_SERIAL WITH CONO="':CONO:'" AND WITH ISTK_PO_NO="':PO.CODE:'" AND WITH ISTK_PO_LINE="':PO.LINE.PTR:'"'
*           PERFORM CMD RTNLIST ITEM.LIST CAPTURING ITEMS.MSG
            *** CHECK INV_SERIAL_DELETED FIRST ***
            SELKEY = CONO:PO.CODE:"!":PO.LINE.PTR
            IDX = "PO_POLN_IDX"
            SELECTINDEX IDX, SELKEY FROM INV_SERIAL_DELETED TO ITEM.LIST
            DONE = 0
            LOOP
               READNEXT KEY FROM ITEM.LIST ELSE DONE = 1
            UNTIL DONE DO
	       MATREADU ISTK.REC FROM INV_SERIAL_DELETED,KEY ELSE
                  ERRMSG = 'CANNOT FIND INV_SERIAL_DELETED INFORMATION RECORD'
                  GOTO 93000
               END
               CNT = CNT + 1
               LINE.CNT = LINE.CNT + 1
               RSXRF.RS.NO<1,CNT> = KEY[4,99]
               RSXRF.LN.NO<1,CNT> = PO.LINE.PTR
            REPEAT
            *** CHECK INV_SERIAL NEXT ***
            SELECTINDEX IDX, SELKEY FROM INV_SERIAL TO ITEM.LIST2
*T25940 ^
            DONE = 0
            LOOP
               READNEXT KEY FROM ITEM.LIST2 ELSE DONE = 1
            UNTIL DONE DO
               MATREADU ISTK.REC FROM INV_SERIAL,KEY ELSE
                  ERRMSG = 'CANNOT FIND SERIAL INFORMATION RECORD'
                  GOTO 93000
               END
               GOSUB 20050
               MATWRITE ISTK.REC ON INV_SERIAL,KEY
               RSXRF.RS.NO<1,CNT> = KEY[4,99]
               RSXRF.LN.NO<1,CNT>=PO.LINE.PTR
            REPEAT
            MAT ISTK.REC=''
            LOOP WHILE LINE.CNT < PO.NO.OF.ROLLS<1,PO.LINE.PTR> DO
               ISTK.SEQ=PRIDGET_GET_SERIAL_SEQ(CONO,CONTROL,INV_SERIAL)
               ISTK.ID=CONO:ISTK.SEQ  
               GOSUB 20050
               ISTK.PRINT.DATE=''
               MATWRITE ISTK.REC ON INV_SERIAL,ISTK.ID
               RSXRF.RS.NO<1,CNT>= ISTK.SEQ
               RSXRF.LN.NO<1,CNT>=PO.LINE.PTR
            REPEAT
         END
      NEXT PO.LINE.PTR
      IF RSXRF.RS.NO # "" THEN
         MATWRITE RSXRF.REC ON PO.RSKI.XREF, CONO:PO.CODE
      END
   END
   RETURN
*
*------------------ WRITE ROLL SKID INFO RECORD ---------------------
*
20050*
   IF ISTK.LOC = "" THEN  
      ISTK.PO.NO=PO.CODE
      ISTK.PO.LINE=PO.LINE.PTR
      ISTK.PROD=PO.PROD.NUM<1,PO.LINE.PTR>
      ISTK.WHSE = PO.WHSE<1,PO.LINE.PTR>
      ISTK.UOM = PO.UNIT.FLG<1,PO.LINE.PTR>
      ISTK.UNIT.PRICE=PO.GROS.PRICE<1,PO.LINE.PTR>
   END
   CNT= CNT + 1
   LINE.CNT = LINE.CNT + 1
   RETURN
*
93000*
  STRXML = "<Payload><Requisition><ErrMsg>": ERRMSG:"</ErrMsg></Requisition></Payload>"
END
