SUBROUTINE JCS_CUSTOMERSERVICE_CREATECUSTOMER(INPUTSTR,ERRSTR,XMLSTR)
*
*T022111 BY YAKUB ON 02/21/2011 - MODIFY FOR UPDATE CUSTOMER
$INCLUDE PMC.CPYLIB CUSTOMER
$INCLUDE PMC.CPYLIB COMP.OPS
$INCLUDE PMC.CPYLIB TAX
$INCLUDE PMC.CPYLIB SHIP.VIA
$INCLUDE PMC.CPYLIB SALESMAN
$INCLUDE PMC.CPYLIB TERMS
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE PMC.CPYLIB CSR.CODE
$INCLUDE PMC.CPYLIB FOB
$INCLUDE ICS.CPYLIB PRICE.TABLE
$INCLUDE PMC.CPYLIB COUNTRY.CODE         
$INCLUDE CPYLIB SYSCOM
$INCLUDE CPYLIB FILE.VARS
$INCLUDE PMC.CPYLIB SECURITY
$INCLUDE CPYLIB CHAR
*
MAT SYSCOM.REC =  ""; SYS.TYPE = 2
**********************************
* OPEN FILES
*
OPEN '','CUSTOMER' TO CUSTOMER ELSE ERRMSG="CANNOT OPEN THE CUSTOMER FILE"
OPEN '','COMPANY' TO COMPANY ELSE ERRMSG="CANNOT OPEN THE COMPANY FILE" 
OPEN '','SHIP.VIA' TO SHIP.VIA ELSE ERRMSG="CANNOT OPEN THE SHIP.VIA FILE" 
OPEN '','JOB' TO JOB ELSE ERRMSG="CANNOT OPEN THE JOB FILE" 
OPEN '','ORDER' TO ORDER ELSE ERRMSG="CANNOT OPEN THE ORDER FILE" 
OPEN '','FOB' TO FOB ELSE ERRMSG="CANNOT OPEN THE FOB FILE" 
OPEN '','CSR.CODE' TO CSR.CODE ELSE ERRMSG="CANNOT OPEN THE CSR.CODE FILE" 
OPEN '','TAX' TO TAX ELSE ERRMSG="CANNOT OPEN THE TAX FILE" 
OPEN '','TERMS' TO TERMS ELSE ERRMSG="CANNOT OPEN THE TERMS FILE" 
OPEN '','SALESMAN' TO SALESMAN ELSE ERRMSG="CANNOT OPEN THE SALESMAN FILE" 
OPEN '','SHIP.TO' TO SHIP.TO ELSE ERRMSG="CANNOT OPEN THE SHIP.TO FILE" 
OPEN '','CONTACT.CODE' TO CONTACT.CODE ELSE ERRMSG='CANNOT OPEN THE CONTACT.CODE FILE' 
OPEN '','CONTROL' TO CONTROL ELSE ERRMSG="CANNOT OPEN THE CONTROL FILE"
*****************************************
*
ERRMSG = ""
ERRMSG1 = ""
FIELDNAME = ""
ERRFLAG = 1
KEY = ""
WEBSERVICE = ""
XMLSTR = ""
MAT CUST.REC = ""
TODAY = DATE()
ERRSTR = "<Rejects>"
*
* INPUT VALUES
*
NAK = ""
*INPUTSTR = "001":AM:"N":AM:"WEBSERVICE CUSTOMER":AM:"hyderabad":AM:"hyde":AM:"ap":AM:"123456":AM:"":AM:"008":AM:"001":AM:"UP":AM:"":AM:"CASH":AM:"1500":AM:"":AM:"":AM:"1":AM:"":AM:"":AM:"B"
*
CONO = INPUTSTR<1>
CUSTNO = INPUTSTR<2>
*T022111 v
MODE =  INPUTSTR<21>
*T022111 ^
************
*
* company code
*
   IF CONO = "" THEN
      FIELDNAME = "COMPANYCODE"
      GOSUB 6000
   END ELSE
        MATREAD COMP.REC FROM COMPANY,CONO ELSE MAT COMP.REC = ""
   END
*
* create new customer
*
 *T022111 v
   IF LEN(CUSTNO) GT 6 THEN
	 ERRFLAG = 0
	 ERRSTR := '<Reject>'
	 ERRSTR := '<RejectCode>CSCRC002</RejectCode>' 
	 ERRSTR := '<RejectDescription>CUSTOMER# SHOULD NOT EXCEED 6 CHARACTERS</RejectDescription>'
	 ERRSTR := '</Reject>'
   END 
    BEGIN CASE
      CASE MODE = "U" AND CUSTNO # "N"
          MATREAD CUST.REC FROM CUSTOMER, CONO:CUSTNO ELSE
		 ERRFLAG = 0
		 ERRSTR := '<Reject>'
		 ERRSTR := '<RejectCode>CSCRC001</RejectCode>' 
		 ERRSTR := '<RejectDescription>CUSTOMER # ':CUSTNO:' DOES NOT EXIST,YOU CANNOT UPDATE</RejectDescription>'
		 ERRSTR := '</Reject>'
	  END
     CASE MODE = "C"
        IF CUSTNO = "" THEN CUSTNO = "N"
         MATREAD CUST.REC FROM CUSTOMER, CONO:CUSTNO THEN
		 ERRFLAG = 0
		 ERRSTR := '<Reject>'
		 ERRSTR := '<RejectCode>CSCRC001</RejectCode>' 
		 ERRSTR := '<RejectDescription>CUSTOMER # ':CUSTNO:' ALREADY EXIST,YOU CANNOT CREATE</RejectDescription>'
		 ERRSTR := '</Reject>'
	  END
    END CASE
*CONO = INPUTSTR<1>
*CUSTNO = INPUTSTR<2>
CUST.NAME = INPUTSTR<3>
CUST.ADDR1 = INPUTSTR<4>
CITY = INPUTSTR<5>
STATE = INPUTSTR<6>
CUST.ZIP = INPUTSTR<7>
CUST.SORT.NAME =INPUTSTR<8>
CUST.SALESMAN = INPUTSTR<9>
CUST.CSR.CODE = INPUTSTR<10>
CUST.SHIP.VIA = INPUTSTR<11>
CUST.START.DATE = INPUTSTR<12>
CUST.CREDIT = INPUTSTR<13>
CUST.CR.LIMIT = INPUTSTR<14>
CUST.TERMS = INPUTSTR<15>
CUST.TYPE = INPUTSTR<16>
CUST.STMT.CODE =INPUTSTR<17>
CUST.IVC.CODE = INPUTSTR<18>
CUST.ADDL.OPS = INPUTSTR<19>
CUST.XML.FLAG =  INPUTSTR<20>
*IF CUST.START.DATE # "" THEN
*   CUST.START.DATE = ICONV(CUST.START.DATE,"D2/")
*END
IF CUST.START.DATE # "" THEN
    IVALUE = ICONV(CUST.START.DATE,"D")
    OVALUE = OCONV(IVALUE,"D2/")
    IF CUST.START.DATE # OVALUE THEN
		 ERRFLAG = 0
		 ERRSTR := '<Reject>'
		 ERRSTR := '<RejectCode>CSCRC001</RejectCode>' 
		 ERRSTR := '<RejectDescription>CUSTOMER START DATE ':CUST.START.DATE:' IS NOT A VALID DATE</RejectDescription>'
		 ERRSTR := '</Reject>' 
    END
END
 *******
*  IF CUSTNO = 'N' THEN
*     NEW.CUST = 1
*  END ELSE
*      IF LEN(CUSTNO) GT 6 THEN
*	 ERRFLAG = 0
*	 ERRSTR := '<Reject>'
*	 ERRSTR := '<RejectCode>CSCRC002</RejectCode>' 
*	 ERRSTR := '<RejectDescription>CUSTOMER# SHOULD NOT EXCEED 6 CHARACTERS</RejectDescription>'
*	 ERRSTR := '</Reject>'
*      END 
*      MATREAD CUST.REC FROM CUSTOMER, CONO:CUSTNO THEN
*	 ERRFLAG = 0
*	 ERRSTR := '<Reject>'
*	 ERRSTR := '<RejectCode>CSCRC001</RejectCode>' 
*	 ERRSTR := '<RejectDescription>CUSTOMER # ':CUSTNO:' ALREADY EXISTS!</RejectDescription>'
*	 ERRSTR := '</Reject>'
*     END
*  END
 *T022111 ^
*
* CUSTOMER NAME
*
  IF CUST.NAME # "" THEN
     IF LEN(CUST.NAME) GT 30 THEN
	 ERRFLAG = 0
	 ERRSTR := '<Reject>'
	 ERRSTR := '<RejectCode>CSCRC003</RejectCode>' 
	 ERRSTR := '<RejectDescription>CUSTOMER NAME SHOULD NOT EXCEED 30 CHARACTERS</RejectDescription>'
	 ERRSTR := '</Reject>'
     END  
  END ELSE 
      FIELDNAME = "CUSTOMER NAME"
      GOSUB 6000
  END
*
* address 
*
  IF CUST.ADDR1 # "" THEN
     IF LEN(CUST.ADDR1) GT 30 THEN
	 ERRFLAG = 0
	 ERRSTR := '<Reject>'
	 ERRSTR := '<RejectCode>CSCRC004</RejectCode>' 
	 ERRSTR := '<RejectDescription>CUSTOMER ADDRESS SHOULD NOT EXCEED 30 CHARACTERS</RejectDescription>'
	 ERRSTR := '</Reject>'
     END    
  END ELSE
     FIELDNAME = "ADDRESS"
     GOSUB 6000
  END
*
* City and State
*
  IF CITY # "" THEN
     IF LEN(CITY) GT 20 THEN
	 ERRFLAG = 0
	 ERRSTR := '<Reject>'
	 ERRSTR := '<RejectCode>CSCRC005</RejectCode>' 
	 ERRSTR := '<RejectDescription>CITY SHOULD NOT EXCEED 20 CHARACTERS</RejectDescription>'
	 ERRSTR := '</Reject>'
     END       
  END ELSE
     FIELDNAME = "COMPANYCODE"
     GOSUB 6000
  END
  IF STATE # "" THEN
     IF LEN(STATE) GT 2 THEN
	 ERRFLAG = 0
	 ERRSTR := '<Reject>'
	 ERRSTR := '<RejectCode>CSCRC006</RejectCode>' 
	 ERRSTR := '<RejectDescription>STATE SHOULD NOT EXCEED 2 CHARACTERS</RejectDescription>'
	 ERRSTR := '</Reject>'
     END 
  END ELSE
     FIELDNAME = "STATE"
     GOSUB 6000
  END
  CUST.ADDR4 = CITY:",":STATE
*
* zip code
*
  IF CUST.ZIP # "" THEN
     IF LEN(CUST.ZIP) GT 10 THEN
	 ERRFLAG = 0
	 ERRSTR := '<Reject>'
	 ERRSTR := '<RejectCode>CSCRC007</RejectCode>' 
	 ERRSTR := '<RejectDescription>ZIP CODE SHOULD NOT EXCEED 10 CHARACTERS</RejectDescription>'
	 ERRSTR := '</Reject>'
     END 
     CUST.ZIP = CUST.ZIP
  END ELSE
     FIELDNAME = "ZIP CODE"
     GOSUB 6000
  END
*
* SORT NAME
*
  IF CUST.SORT.NAME # "" THEN
       IF LEN(CUST.SORT.NAME) GT 30 THEN
	 ERRFLAG = 0
	 ERRSTR := '<Reject>'
	 ERRSTR := '<RejectCode>CSCRC008</RejectCode>' 
	 ERRSTR := '<RejectDescription>CUSTOMER SORT NAME SHOULD NOT EXCEED 30 CHARACTERS</RejectDescription>'
	 ERRSTR := '</Reject>'
     END  
  END ELSE
    CUST.SORT.NAME = CUST.NAME
  END
*
* Enter Salesman
*
    IF CUST.SALESMAN # "" THEN
       MATREAD SALESMAN.REC FROM SALESMAN,CONO:CUST.SALESMAN ELSE
	   ERRFLAG = 0
	   ERRSTR := '<Reject>'
	   ERRSTR := '<RejectCode>CSCRC009</RejectCode>'
	   ERRSTR := '<RejectDescription>CANNOT LOCATE SALESMAN # ':CUST.SALESMAN:'</RejectDescription>'
	   ERRSTR := '</Reject>'
           ERRMSG="SALESREP RECORD ":CUST.SALESMAN:" IS INVALID"
       END
       CUST.SALESMAN=CUST.SALESMAN
    END ELSE
      FIELDNAME = "SALESREP"
      GOSUB 6000
    END
*
* Enter Customer service rep
*
   IF CUST.CSR.CODE # "" THEN
      MATREAD CSR.REC FROM CSR.CODE,CONO:CUST.CSR.CODE ELSE
	ERRFLAG = 0
	ERRSTR := '<Reject>'
	ERRSTR := '<RejectCode>CSCRC010</RejectCode>' 
	ERRSTR := '<RejectDescription>CANNOT LOCATE SERVICE REP #  ':CUST.CSR.CODE:'</RejectDescription>'
	ERRSTR := '</Reject>'
     END
     CUST.CSR.CODE = CUST.CSR.CODE
   END ELSE
      FIELDNAME = "SERVICE REP"
      GOSUB 6000
   END
*
* Enter Ship Via
*
  IF CUST.SHIP.VIA # "" THEN
        MATREAD SHIP.VIA.REC FROM SHIP.VIA, CONO:CUST.SHIP.VIA ELSE
	ERRFLAG = 0
	ERRSTR := '<Reject>'
	ERRSTR := '<RejectCode>CSCRC011</RejectCode>' 
	ERRSTR := '<RejectDescription>CANNOT LOCATE SHIP VIA # ':CUST.SHIP.VIA:'</RejectDescription>'
	ERRSTR := '</Reject>'
      END
      CUST.SHIP.VIA = CUST.SHIP.VIA
  END
*
* Enter start date
*
  IF CUST.START.DATE # "" THEN
 *T022111 v
     *CUST.START.DATE = CUST.START.DATE
     CUST.START.DATE = ICONV(CUST.START.DATE,"D2/")
*T022111 ^
  END ELSE
     CUST.START.DATE = TODAY
  END
*
* Credit Code
*
  IF CUST.CREDIT # "" THEN
     IF CUST.CREDIT = 'N' OR CUST.CREDIT = 'E' OR CUST.CREDIT = 'AE' OR CUST.CREDIT = 'CASH' THEN
        CUST.CREDIT = CUST.CREDIT
     END ELSE
	ERRFLAG = 0
	ERRSTR := '<Reject>'
	ERRSTR := '<RejectCode>CSCRC012</RejectCode>' 
	ERRSTR := '<RejectDescription>INVALID CREDIT CODE </RejectDescription>'
	ERRSTR := '</Reject>'
     END
  END ELSE
     FIELDNAME = "CREDIT CODE"
     GOSUB 6000
  END
*
* credit limit
*
  IF CUST.CR.LIMIT # "" THEN
    IF INDEX(CUST.CR.LIMIT,".",1) = 0 THEN
      IF NUM(CUST.CR.LIMIT) THEN
        IF CUST.CR.LIMIT > 9999999 THEN
	  ERRFLAG = 0
	  ERRSTR := '<Reject>'
	  ERRSTR := '<RejectCode>CSCRC013</RejectCode>' 
	  ERRSTR := '<RejectDescription>THE CREDIT LIMIT IS NOT EXCEED THAN 9999999 </RejectDescription>'
	  ERRSTR := '</Reject>'
        END
      END ELSE
	  ERRFLAG = 0
	  ERRSTR := '<Reject>'
	  ERRSTR := '<RejectCode>CSCRC014</RejectCode>' 
	  ERRSTR := '<RejectDescription>NUMERIC INPUT REQUIRED FOR CREDIT LIMIT ! </RejectDescription>'
	  ERRSTR := '</Reject>'      
      END   
    END ELSE
	  ERRFLAG = 0
	  ERRSTR := '<Reject>'
	  ERRSTR := '<RejectCode>CSCRC014</RejectCode>' 
	  ERRSTR := '<RejectDescription>NUMERIC INPUT REQUIRED FOR CREDIT LIMIT ! </RejectDescription>'
	  ERRSTR := '</Reject>'  
    END
     CUST.CR.LIMIT = CUST.CR.LIMIT
  END ELSE
     CUST.CR.LIMIT = 9999999
  END
*
* ENTER PAYMENT TERMS
*
   IF CUST.TERMS # "" THEN
      MATREAD TERMS.REC FROM TERMS,CONO:CUST.TERMS ELSE
        ERRFLAG = 0
	ERRSTR := '<Reject>'
	ERRSTR := '<RejectCode>CSCRC015</RejectCode>' 
	ERRSTR := '<RejectDescription>TERMS RECORD #':CUST.TERMS:' IS INVALID</RejectDescription>'
	ERRSTR := '</Reject>'
      END
      CUST.TERMS = CUST.TERMS
   END ELSE
      CUST.TERMS = 01
   END
*
* Customer type
*
  IF CUST.TYPE # "" THEN
     IF CUST.TYPE = 'A' OR CUST.TYPE= 'D' OR CUST.TYPE= 'N' OR CUST.TYPE = 'F' THEN
        CUST.TYPE = CUST.TYPE
     END ELSE
        ERRFLAG = 0
        ERRSTR := '<Reject>'
        ERRSTR := '<RejectCode>CSCRC016</RejectCode>' 
        ERRSTR := '<RejectDescription>INVALID CUSTOMER TYPE</RejectDescription>'
        ERRSTR := '</Reject>'
     END
  END ELSE
     CUST.TYPE = 'D'
  END
*
* ENTER STATEMENT FLAG
*
  IF CUST.STMT.CODE # "" THEN
     IF CUST.STMT.CODE = '0' OR CUST.STMT.CODE = '1' OR CUST.STMT.CODE = '2' OR CUST.STMT.CODE = '3' OR CUST.STMT.CODE = '4' THEN
        CUST.STMT.CODE = CUST.STMT.CODE
     END ELSE
        ERRFLAG = 0
        ERRSTR := '<Reject>'
        ERRSTR := '<RejectCode>CSCRC017</RejectCode>' 
        ERRSTR := '<RejectDescription>INVALID STATEMENT FLAG</RejectDescription>'
        ERRSTR := '</Reject>'
     END
  END ELSE
     CUST.STMT.CODE = '3'
  END
*
* Invoice Code
*
  IF CUST.IVC.CODE # "" THEN
     IF CUST.IVC.CODE = 'S' OR CUST.IVC.CODE = 'D' THEN
        CUST.IVC.CODE = CUST.IVC.CODE
     END ELSE
        ERRFLAG = 0
        ERRSTR := '<Reject>'
        ERRSTR := '<RejectCode>CSCRC018</RejectCode>' 
        ERRSTR := '<RejectDescription>INVALID INVOICE CODE</RejectDescription>'
        ERRSTR := '</Reject>'
     END
  END ELSE
     CUST.IVC.CODE = 'S'
  END
*
* Normal Over
*
  IF CUST.ADDL.OPS # "" THEN
     QTY.VALUE = CUST.ADDL.OPS
     TOT.VAL = 6; MAX.INT = 3; MAX.DEC = 2
     FIELDNAME = "NORMAL OVER"
     GOSUB 5000   
     IF ERRMSG = "" THEN
        JOB.MRKUP = QTY.VALUE
        JOB.MARKUP = JOB.MRKUP
     END   
     CUST.ADDL.OPS<1,1> = QTY.VALUE
  END ELSE
     CUST.ADDL.OPS<1,1> = 0.00
  END
*
* XNL flag
*
  IF CUST.XML.FLAG # "" THEN
     IF CUST.XML.FLAG = 'Y' OR CUST.XML.FLAG = 'N' OR CUST.XML.FLAG = 'B' THEN
        CUST.XML.FLAG = CUST.XML.FLAG
     END ELSE
        ERRFLAG = 0
        ERRSTR := '<Reject>'
        ERRSTR := '<RejectCode>CSCRC020</RejectCode>' 
        ERRSTR := '<RejectDescription>INVALID XML FLAG</RejectDescription>'
        ERRSTR := '</Reject>' 
     END
  END ELSE
     CUST.XML.FLAG = 'B' 
  END
*
* WRITE CUSTOMER
*
  IF ERRFLAG = 1 THEN
  *T022111 v
    BEGIN CASE
      CASE MODE = "U" AND CUSTNO # "N"
	     MATWRITE CUST.REC ON CUSTOMER,CONO:CUSTNO
	     XMLSTR = "CUSTOMER # ":CUSTNO:" UPDATED SUCCESSFULLY "
      CASE MODE = "C" 
  *T022111 ^
	    IF CUSTNO = "" OR CUSTNO = 'N' THEN
	       GOSUB GET.CUST.NO
	    END
	     MATWRITE CUST.REC ON CUSTOMER,CONO:CUSTNO
	     XMLSTR = "CUSTOMER # ":CUSTNO:" CREATED SUCCESSFULLY "
*T022111 v
      CASE 1
        ERRFLAG = 0
        ERRSTR := '<Reject>'
        ERRSTR := '<RejectCode>CSCRC021</RejectCode>' 
        ERRSTR := '<RejectDescription>ERROR LOADING...</RejectDescription>'
        ERRSTR := '</Reject>'            
    END CASE 
*T022111 ^
  END ELSE
     ERRSTR := "</Rejects>"   
  END
RETURN
*
* Get customer no
*
***********
GET.CUST.NO:
************
  *FND = 0
  CUSTNO="N"
  READU KEY FROM CONTROL, CONO:"CUSTOMER" ELSE
    KEY = 000001
  END
  LOOP
    FND = 1
    KEY = KEY + 1
    MATREAD CUST.REC FROM CUSTOMER, CONO:KEY ELSE FND = 0
  WHILE FND DO REPEAT
  WRITE KEY ON CONTROL, CONO:"CUSTOMER"
  CUSTNO=KEY
RETURN
* REQUIRED FIELD VALIDATION
*
6000*
      ERRFLAG = 0
      ERRSTR := '<Reject>'
      ERRSTR := '<RejectCode>CSCRC021</RejectCode>' 
      ERRSTR := '<RejectDescription>':FIELDNAME:' IS REQUIRED!</RejectDescription>'
      ERRSTR := '</Reject>'
RETURN
*
*QTY VALIDATION
*
5000*
ERRMSG = ""
*T022111 v
CALL CHECK.DECIMAL(QTY.VALUE,"",TOT.VAL,MAX.DEC,FIELDNAME,ERRMSG)
  IF ERRMSG # "" THEN
      ERRFLAG = 0
      ERRSTR := '<Reject>'
      ERRSTR := '<RejectCode>CSCRC019</RejectCode>' 
      ERRSTR := '<RejectDescription>':ERRMSG:'</RejectDescription>'
      ERRSTR := '</Reject>'
  END
SWAP "." WITH "" IN QTY.VALUE
*IF INDEX(QTY.VALUE,".",1) = 0 THEN
*   IF LEN(QTY.VALUE) GT MAX.INT THEN
*      ERRMSG = "DECIMAL INPUT REQUIRED!"
*      ERRFLAG = 0
*      ERRSTR := '<Reject>'
*      ERRSTR := '<RejectCode>CSCRC019</RejectCode>' 
*      ERRSTR := '<RejectDescription>DECIMAL INPUT REQUIRED FOR ':FIELDNAME:'!</RejectDescription>'
*      ERRSTR := '</Reject>'
*   END
*END ELSE
*   IF LEN(FIELD(QTY.VALUE,".",1)) GT MAX.INT OR LEN(FIELD(QTY.VALUE,".",2)) GT MAX.DEC THEN 
*      ERRMSG = "DECIMAL INPUT REQUIRED!"
*      ERRFLAG = 0
*      ERRSTR := '<Reject>'
*      ERRSTR := '<RejectCode>CSCRC019</RejectCode>' 
*      ERRSTR := '<RejectDescription>DECIMAL INPUT REQUIRED FOR ':FIELDNAME:'!</RejectDescription>'
*      ERRSTR := '</Reject>'
*   END 
*END
*IF INDEX(QTY.VALUE,".",1) = 0 THEN QTY.VALUE = QTY.VALUE * 100
*SWAP "." WITH "" IN QTY.VALUE
*IF QTY.VALUE + 0 = 0 THEN QTY.VALUE = 0
*T022111 ^
5001*
RETURN
*
* WRITING ERROR TO WSE_LOG FILE
*
99999*
IF ERRSTR <> "" THEN
  ERRMSG = WEBSERVICE:"---> JCS_CREATECUSTOMER---> " : ERRMSG
  CALL WRITELOG(ERRMSG)
END
RETURN
END
