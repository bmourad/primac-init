*COPY>CPYLIB>COM1
***************************************************************
* REVISION    - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - POSBP
* PROGRAM     - OVERDUE.PO.RPT
* AUTHOR      - RHONDA PERRIN, COMPUTER BUSINESS ASSOCIATES
* DATE        - 04/09/87
* DESCRIPTION -
* This program produces the Overdue Purchase Order
* Report sorted by Purchase Order Number for COM.
*T19444 rick 07/28/1995 * DUE DATE FIELD PRINTING PO.DUE.DATE RATHER
*                         THAN PRINTING PO.DEL.DATE. PO.DEL.DATE IS A
*                         MULTI-VALUED FIELD AND SHOULD PRINT RATHTER
*                         THAN THE PO.DATE
* TASK 20080 JR ADD DIVISION TO LISTING
*CSF 23459 LMR 10/03/95 - In addition to above, the selection of PO's to
*                         print is based on the PO due-date and not on
*                         the PO Line due-date...this is to correct that.
*T25776 lanny 04/26/2001 * Adds line-cnt of PO without regard to whether
*                          PO will print. Also, prints total line
*                          regardless of same condition.
*T25901 cmykleb 03/08/2002 * Change heading to use GET.PROG.HEAD pgm.
*T26493 cmykleb 03/22/2002 * Change report to use rpt # from proc.
*T26871 thompson 10/07/2002 * FIX REPORT PROBLEMS
*T112309 UnitPrice Changes by Naresh
*ENDDOC
***************************************************************
*
*---- FILE EQUATES
*
*COPY>CPYLIB>SYSCOM
*COPY>PMC.CPYLIB>PO
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>FILE.VARS
*COPY>PMC.CPYLIB>COMPANY
*COPY>ICS.CPYLIB>INVENTORY
*COPY>ICS.CPYLIB>INV.CNV
*
*---- SETUP FOR SYSTEM ERROR MESSAGES
*
   SYS.TYPE = 1
   CALL SYSCOM(MAT SYSCOM.REC)
*
* TASK 20080
**** READ COMPANY NAME FROM PROC
   PROCREAD ID ELSE
      ERRMSG = "MUST RUN FROM A PROC"
      GOTO 93000
   END
*T26493 v
*  CONO = ID<1> ; CONO.NAME = ID<2>
   CONO = ID<1> ; REPORT.NUMBER = ID<2>
   CONO.NAME = ""
*T26871   START.DATE = ID<4>
*T26871   END.DATE = ID<5>
*T26943 ^
   TODAY = DATE()
   DIV.OWNER = ID<3>
*T25901 v
   REPORT.NAME = ""
   HEAD1 = "" ; HEAD2 = ""
   CALL GET.PROG.HEAD(CONO,CONO.NAME,REPORT.NAME,REPORT.NUMBER,"",HEAD1,HEAD2)
*T25901 ^
* TASK 20080
*---- OPEN FILES
*
   OPEN "","PO" TO PO ELSE ERRMSG = "PO FILE MISSING";GOTO 93000
   OPEN "","COMPANY" TO COMPANY ELSE ERRMSG = "COMPANY FILE MISSING";GOTO 93000
   OPEN "","CONTROL" TO CONTROL ELSE ERRMSG = "CONTROL FILE MISSING";GOTO 93000
   OPEN "","INVENTORY" TO INVENTORY ELSE ERRMSG = "INVENTORY FILE MISSING";GOTO 93000
*
*---- INITIALIZATION
*
   PG.NO = 0
   FIRST.FLAG = 1
   LINE.CNT = 0
   ERRMSG = ""
   BY.SORT = "PO NUMBER"
   PREVIOUS.PO.NUM = ""
   DISC.PRICE = ""
   DAYS.OVD = 0
   TOT.VALUE.OPEN = 0
   GRAND.TOT.VALUE.OPEN = 0
   ORDERED = 0
   RECVD = 0
   CANCEL = 0
   OPEN = 0
   VALUE.OPEN = 0
   PRINTER ON
*
*---- GET COMPANY NUMBER
*
*T20080 CONO = ""
*T20080 CALL GET.CONO(CONO,MAT COMP.REC)
*T20080 IF CONO = "END" THEN GOTO 99999
*
*---- MAIN PROCESSING
*
10*
*T25776 IF FIRST.FLAG = 1 THEN FIRST.FLAG = 0; GOSUB 20
   READNEXT PO.KEY ELSE GOTO 15
   MATREAD PO.REC FROM PO,PO.KEY ELSE GOTO 10
   OPEN.FLG = 0
   OPEN.CNT = COUNT(PO.PROD.NUM,VM) + (PO.PROD.NUM # "")
*CSF 23459 v
   FOR V = 1 TO OPEN.CNT UNTIL OPEN.FLG
      IF TODAY - PO.DEL.DATE<1,V> > 0 THEN OPEN.FLG = 1
   NEXT V
   IF NOT(OPEN.FLG) THEN GOTO 10
   OPEN.FLG = 0
*CSF 23459 ^
*T25776 NEW.LINE.CNT = LINE.CNT + OPEN.CNT
*T25776 IF NEW.LINE.CNT = 50 OR NEW.LINE.CNT > 50 THEN GOSUB 20
   V = 0
   FOR V = 1 TO OPEN.CNT
      IF PO.QTY.OPEN<1,V> > 0 AND TODAY - PO.DEL.DATE<1,V> > 0 THEN
         PROD.NUM = PO.PROD.NUM<1,V>
         GROS.PRICE = PO.GROS.PRICE<1,V>
         DISCOUNT = PO.DISCOUNT<1,V>
         TOT.ONORD = PO.TOT.ONORD<1,V>
         QTY.OPEN = PO.QTY.OPEN<1,V>
         TOT.RECEVED = PO.TOT.RECEVED<1,V>
         PROD.TYPE = PO.PROD.TYPE<1,V>
         TOT.CANCEL = PO.TOT.CANCEL<1,V>
         UNIT = PO.UNIT.FLG<1,V>
*T19444 v
         DUEDATE = PO.DEL.DATE<1,V>
*T19444 ^
         GOSUB 30
         OPEN.FLG = 1
      END
   NEXT V
   IF OPEN.FLG = 1 THEN OPEN.FLG = 0; GOSUB 50
   GOTO 10
15*
   GOSUB 60
   GOTO 99999
*
*---- PRINT THE HEADING
*
20*
   PRINT CHAR(12):
   NEW.LINE.CNT = 0
   PG.NO = PG.NO + 1
*T25901 v
*  H.LINE = "";HLINE1 = "";HLINE2 = "";HLINE3 = ""
*  HLINE1 = "REPORT NO: ":RPT.NO"L#4":SPACE(26)
*  REMAIN = 50 - LEN(CONO.NAME)
*  HALF = INT(REMAIN / 2)
*  K = SPACE(HALF)
*  HLINE2 = K:CONO.NAME:K
*  HLINE3 = SPACE(30):"PAGE: ":PG.NO
*  H.LINE = HLINE1:HLINE2:HLINE3
*  PRINT H.LINE
*  PRINT "DATE   : ":OCONV(DATE(),"D2/"):SPACE(34):"OVERDUE PURCHASE ORDER REPORT"
*  PRINT "DIVISION : ":DIV.OWNER"L#3":SPACE(45):"BY ":BY.SORT
   HEAD3 = "DIVISION : ":DIV.OWNER"L#3"
*T26871   HEAD3 = HEAD3 : SPACE(49) : START.DATE :" THRU ": END.DATE
   PRINT HEAD1:PG.NO"R#3"
   PRINT HEAD2
   PRINT HEAD3
*T25901 ^
   PRINT
*T112309 v
*   PRINT "   PO    VENDOR       PRODUCT        PO       DUE   U/M   ORDERED      RECVD       CANCEL       OPEN    DAYS   VALUE"
*   PRINT " NUMBER  NUMBER       NUMBER        DATE     DATE":SPACE(55):"OVD    OPEN"
*   PRINT "-------- -------- --------------- -------- -------- --- ----------- ----------- ----------- ----------- ---- ----------"
   PRINT "   PO    VENDOR       PRODUCT        PO       DUE   U/M   ORDERED      RECVD       CANCEL       OPEN    DAYS      VALUE"
   PRINT " NUMBER  NUMBER       NUMBER        DATE     DATE":SPACE(55):"OVD       OPEN"
   PRINT "-------- -------- --------------- -------- -------- --- ----------- ----------- ----------- ----------- ---- ---------------"
*T112309 ^
   PRINT
   LINE.CNT = 8
   RETURN
*
*---- PRINT THE VALUES
*
30*
   IF FIRST.FLAG = 1 THEN FIRST.FLAG = 0; GOSUB 20 ;*T25776
   IF LINE.CNT >= 55 THEN GOSUB 20
   GOSUB 40
   IF PO.NUM # PREVIOUS.PO.NUM THEN
      PRINT PO.NUM "L#8":" ":PO.VEND.NO "L#8":" ":PROD.NUM "L#15":" ":OCONV(PO.DATE,"D2/"):" ":
*T19444 on line below change first field PO.DUE.DATE to DUEDATE
*T112309 v
*      PRINT OCONV(DUEDATE,"D2/")"L#8":" ":UNIT "L#3":" ":OCONV(ORDERED,ICR.CNV)"R#11":" ":OCONV(RECVD,ICR.CNV)"R#11":" ":OCONV(CANCEL,ICR.CNV)"R#11":" ":OCONV(OPEN,ICR.CNV)"R#11":" ":DAYS.OVD "L#4":" ":OCONV(VALUE.OPEN,"MD2,")"R#10"
PRINT OCONV(DUEDATE,"D2/")"L#8":" ":UNIT "L#3":" ":OCONV(ORDERED,ICR.CNV)"R#11":" ":OCONV(RECVD,ICR.CNV)"R#11":" ":OCONV(CANCEL,ICR.CNV)"R#11":" ":OCONV(OPEN,ICR.CNV)"R#11":" ":DAYS.OVD "L#4":" ":OCONV(VALUE.OPEN,"MD2,")"R#15"
*T112309 ^
      PRINT SPACE(18):PROD.DESC
      PREVIOUS.PO.NUM = PO.NUM
   END ELSE
*T19444 on line below change PO.DUE.DATE to DUEDATE
      PRINT SPACE(18):PROD.NUM "L#15":" ":OCONV(PO.DATE,"D2/"):" ":OCONV(DUEDATE,"D2/")"L#8":" ":UNIT "L#3":" ":
*T112309 v
*      PRINT OCONV(ORDERED,ICR.CNV)"R#11":" ":OCONV(RECVD,ICR.CNV)"R#11":" ":OCONV(CANCEL,ICR.CNV)"R#11":" ":OCONV(OPEN,ICR.CNV)"R#11":" ":DAYS.OVD "L#4":" ":OCONV(VALUE.OPEN,"MD2,")"R#10"
      PRINT OCONV(ORDERED,ICR.CNV)"R#11":" ":OCONV(RECVD,ICR.CNV)"R#11":" ":OCONV(CANCEL,ICR.CNV)"R#11":" ":OCONV(OPEN,ICR.CNV)"R#11":" ":DAYS.OVD "L#4":" ":OCONV(VALUE.OPEN,"MD2,")"R#15"
*T112309 ^
      PRINT SPACE(18):PROD.DESC
   END
   LINE.CNT = LINE.CNT + 2
   DAYS.OVD = 0;ORDERED = 0;RECVD = 0;CANCEL = 0;OPEN = 0;VALUE.OPEN = 0
   DISC.PRICE = ""
   RETURN
*
*---- GET FIELD VALUES, CALCULATE AND ACCUMULATE
*
40*
   PO.NUM = PO.KEY[4,8]
   MATREAD INV.REC FROM INVENTORY,CONO:PROD.NUM ELSE
      MAT INV.REC = "" ; INV.DESC = "INVENTORY PRODUCT UNKNOWN"
   END
   IF INV.SBR + 0 = 0 THEN INV.SBR = 1
   MAT INV.CNV.REC = ""
   BEGIN CASE
      CASE UNIT = "SHT" AND INV.UNIT<1,3> = "LBS"
         ICR.CNV = "MD0"
         ICR.DV1 = INV.M.WT; ICR.MT1 = 1; ICR.DV2 = 1
      CASE UNIT = "PC" AND INV.UNIT<1,3> = "MSI"
         ICR.CNV = "MD0"
         ICR.DV1 = INV.PAP.WIDTH/100; ICR.MT1 = 10; ICR.DV2 = 1
      CASE UNIT = "FT" AND INV.UNIT<1,3> = "MSI"
         ICR.CNV = "MD0"
         ICR.DV1 = INV.PAP.WIDTH/100; ICR.MT1 = 100; ICR.DV2 = 12
      CASE 1
         ICR.CNV = "MD2"
         ICR.DV1 = INV.SBR; ICR.MT1 = 1; ICR.DV2 = 1
   END CASE
   IF UNIT # INV.UNIT<1,2> THEN DIFF.UM = "Y" ELSE DIFF.UM = "N"
   PROD.DESC = INV.DESC
   COST.WT = INV.COST.WT
*t19444 on line below change reference from PO.DUE.DATE to DUEDATE
   DAYS.OVD = TODAY - DUEDATE
   DISC.PRICE = INT((GROS.PRICE * (1- (DISCOUNT/10000))) / INV.SBR +.5)
   IF DIFF.UM = "Y" THEN
      IF ICR.CNV = "MD0" THEN
         ORDERED = INT(((TOT.ONORD / ICR.DV1) * ICR.MT1) / ICR.DV2 + .5)
         OPEN = INT(((QTY.OPEN / ICR.DV1) * ICR.MT1) / ICR.DV2 + .5)
         RECVD = INT(((TOT.RECEVED / ICR.DV1) * ICR.MT1) / ICR.DV2 + .5)
         CANCEL = INT(((TOT.CANCEL / ICR.DV1) * ICR.MT1) / ICR.DV2 + .5)
      END ELSE
         ORDERED = INT((TOT.ONORD / 10) / ICR.DV1)
         OPEN = INT((QTY.OPEN / 10) / ICR.DV1)
         RECVD = INT((TOT.RECEVED / 10) / ICR.DV1)
         CANCEL = INT((TOT.CANCEL / 10) / ICR.DV1)
      END
   END ELSE
      IF ICR.CNV = "MD0" THEN
         ORDERED = INT(((TOT.ONORD / ICR.DV1) * ICR.MT1)/ICR.DV2 +.5)
         OPEN = INT(((QTY.OPEN / ICR.DV1) * ICR.MT1)/ICR.DV2 +.5)
         RECVD = INT(((TOT.RECEVED / ICR.DV1) * ICR.MT1)/ICR.DV2 +.5)
         CANCEL = INT(((TOT.CANCEL / ICR.DV1) * ICR.MT1)/ICR.DV2 +.5)
      END ELSE
         ORDERED = INT(TOT.ONORD/10)
         OPEN = INT(QTY.OPEN/10)
         RECVD = INT(TOT.RECEVED/10)
         CANCEL = INT(TOT.CANCEL/10)
      END
   END
   IF COST.WT + 0 = 0 THEN COST.WT = 100
   VALUE.OPEN = INT((DISC.PRICE / 10000) * ((QTY.OPEN/10) / (COST.WT/100)))
   TOT.VALUE.OPEN = TOT.VALUE.OPEN + VALUE.OPEN
   GRAND.TOT.VALUE.OPEN = GRAND.TOT.VALUE.OPEN + VALUE.OPEN
   RETURN
*
*---- PRINT TOTALS
*
50*
*T112309 v
*   PRINT SPACE(109):"----------"
*   PRINT "P/O TOTAL""R#108":" ":OCONV(TOT.VALUE.OPEN,"MD2,")"R#10"
   PRINT SPACE(109):"---------------"
   PRINT "P/O TOTAL""R#108":" ":OCONV(TOT.VALUE.OPEN,"MD2,")"R#15"
*T112309 ^
   TOT.VALUE.OPEN = 0
   PRINT
   LINE.CNT = LINE.CNT + 3
   RETURN
*
*---- PRINT GRAND TOTAL
*
60*
   PRINT
*T112309 v
*   PRINT SPACE(109):"----------"
*   PRINT "GRAND TOTAL""R#108":" ":OCONV(GRAND.TOT.VALUE.OPEN,"MD2,")"R#10"
   PRINT SPACE(109):"---------------"
   PRINT "GRAND TOTAL""R#108":" ":OCONV(GRAND.TOT.VALUE.OPEN,"MD2,")"R#15"
*T112309 ^
   PRINTER OFF
   RETURN
*
*---- CALLS FOR SYSCOM
*
91000*
   ERR.TYPE = 1
   CALL SYSCOM(MAT SYSCOM.REC)
   RETURN
92000*
   ERR.TYPE = 2
   CALL SYSCOM(MAT SYSCOM.REC)
   RETURN
93000*
   ERR.TYPE = 3
   CALL SYSCOM(MAT SYSCOM.REC)
99999*
   PRINT @(-1):
END
