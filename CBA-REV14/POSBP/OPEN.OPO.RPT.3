********************************************************************
* REVISION    - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - POSBP
* PROGRAM     - OPEN.OPO.RPT.3
* BY          - JIHAD YAMOUT ,C.B.A
* DATE        - 04/09/87
* T21511 01gat 01/27/1997 * fix uom calculation of product.
* TASK 20080 JR ADD DIVISION TO LISTING
*T23319 alex 04/11/2000 * Fix calculation for UOM Type "C"; it is
*                         defaulting as a "EA" Type. 
*T25850 edwin * Add warehouse to report heading.
*T25901 cmykleb 03/13/2002 * Change heading to use GET.PROG.HEAD pgm.
*T26493 cmykleb 03/22/2002 * Change report to use rpt # from proc.
********************************************************************
*
*COPY>POS.CPYLIB>OUTSIDE.PO
*COPY>PMC.CPYLIB>VEND
*COPY>CPYLIB>SYSCOM
*COPY>CPYLIB>CHAR
*
   LINE.COUNT = 99
   PAGE.NO = 0
   PREV.PROD = ''
   TOT.AMT = 0
   HD1 = "                                                                                                   ORDERED       OPEN"
   HD2 = "PO NUM   VEND NO  VEND NAME      JOB NUMBER       OUTSIDE PURCHASE CATEGORY         DUE DATE U/M   QUANTITY    QUANTITY  OPEN AMOUNT" 
   HD3 = "-------- -------- -------------- --------------- ---------------------------------- -------- --- ----------- ----------- -----------"
**** SET UP FOR SYSCOM
   SYS.TYPE = 1; CALL SYSCOM(MAT SYSCOM.REC)
**** READ COMPANY NAME FROM PROC
   PROCREAD ID ELSE
      ERRMSG = "CANNOT PERFORM PROCREAD"
      GOTO 93000
   END
*T26493 v
*  CONO = ID<1> ; CONO.NAME = ID<2>
   CONO = ID<1> ; REPORT.NUMBER = ID<2>
   CONO.NAME = ""
*T26493 ^
   DIV.OWNER = ID<3>
*T25850 v
   START.DELIVER.DATE.RANGE = ICONV(ID<4>,'D2')
   END.DELIVER.DATE.RANGE = ICONV(ID<5>,'D2')
*T25850 ^
   REPORT.NAME = ""
   HLINE1 = "" ; HLINE2 = ""
   CALL GET.PROG.HEAD(CONO,CONO.NAME,REPORT.NAME,REPORT.NUMBER,"",HLINE1,HLINE2)
**** OPEN FILES
   OPEN '','OUTSIDE.PO' TO OUTSIDE.PO ELSE
      ERRMSG = 'OUTSIDE.PO FILE IS MISSING'
      GOSUB 93000
   END
   OPEN '','VEND' TO VEND ELSE
      ERRMSG = 'VEND FILE IS MISSING'
      GOSUB 93000
   END
*
***** MAIN PROCESS
*
   PRINTER ON
**** READ FIRST RECORD
10*
   READNEXT OPO.CODE,MV.NUM,MV.NUM1 ELSE
      ERRMSG = "NO ITEMS SELECTED"
*CSF 24369 v
      PRINTER OFF
      GOSUB 91000
      GOTO 99999
*CSF 24369 ^
   END
   MV.NUM = MV.NUM<1,1,1>
   MATREAD OPO.REC FROM OUTSIDE.PO, OPO.CODE ELSE
      MAT OPO.REC = ''
      GOTO 10
   END
   MATREAD VEND.REC FROM VEND, CONO:OPO.VEND.NO ELSE
      VEND.DESC = "??????????"
   END
   IF OPO.TOT.OPEN<1,MV.NUM> + 0 > 0 THEN
      IF START.DELIVER.DATE.RANGE THEN            ; * T25850 v
         IF OPO.EXP.DATE<1,MV.NUM> < START.DELIVER.DATE.RANGE OR OPO.EXP.DATE<1,MV.NUM> > END.DELIVER.DATE.RANGE THEN CONTINUE
      END                                         ; * T25850 ^
      GOSUB 300
   END ELSE
      GOTO 10
   END
   PREV.DEL.DATE = OPO.EXP.DATE<1,MV.NUM>
   GOSUB 200
   DATA = 0
   LOOP
      READNEXT OPO.CODE,MV.NUM,MV.NUM1 ELSE DATA = 1
   WHILE DATA = 0 DO
      MV.NUM = MV.NUM<1,1,1>
      MATREAD OPO.REC FROM OUTSIDE.PO , OPO.CODE ELSE
         MAT OPO.REC = ''
         GOTO 111
      END
      IF OPO.TOT.OPEN<1,MV.NUM> + 0 > 0 THEN
         GOSUB 300
      END ELSE
         GOTO 111
      END
      MATREAD VEND.REC FROM VEND , CONO: OPO.VEND.NO ELSE
         VEND.DESC = "??????????"
      END
      BEGIN CASE
         CASE OPO.EXP.DATE<1,MV.NUM> # PREV.DEL.DATE
            GOSUB 400
            GOSUB 9000
      END CASE
      GOSUB 1000
      PREV.DEL.DATE = OPO.EXP.DATE<1,MV.NUM>
111 REPEAT
   GOSUB 400
   GOTO 99999
***** PRINT OPO LINES
200*
   IF OPO.TOT.OPEN<1,MV.NUM> + 0 > 0 THEN
      GOSUB 300
      GOSUB 1000
   END
   RETURN
***** CONVERT QUANTITY
300*
   RETURN
**** PRINT TOTALS
400*
   PRINT
   LINE.COUNT = LINE.COUNT + 1
   IF TOT.AMT # 0 THEN
      T.LINE = ''
      T.LINE = SPACE(99):"EXPECTED DATE TOTAL  ":OCONV(TOT.AMT, "MD2") "R#12"
      PRINT T.LINE
      PRINT
      LINE.COUNT  = LINE.COUNT + 2
      TOT.AMT = 0
   END
   RETURN
***** PRINT LINE
1000*
   IF LINE.COUNT > 45 THEN
      GOSUB 9000
   END
   D.LINE = ''
   D.LINE = D.LINE :OPO.CODE[4,LEN(OPO.CODE)] "L#8":' ':OPO.VEND.NO "L#8":' ':VEND.DESC "L#14":' '
   D.LINE = D.LINE :OPO.JOB.NO<1,MV.NUM> "L#15":' ':OPO.PROD.LINE<1,MV.NUM> "L#34":' '
   D.LINE = D.LINE :OCONV(OPO.EXP.DATE<1,MV.NUM>, "D2/") "L#8":' '
   D.LINE = D.LINE :OPO.UOM<1,MV.NUM> "L#3":' '
   TEMP = INT(OPO.QTY<1,MV.NUM> / 100)
   TEMP1 = INT(OPO.TOT.OPEN<1,MV.NUM> / 100)
   D.LINE = D.LINE:OCONV(TEMP, 'MD0') "R#11":' '
   D.LINE = D.LINE:OCONV(TEMP1, 'MD0') "R#11":' '
* T21511
*      DESC.PRICE = OPO.EST.COST<1,MV.NUM>
  *T23319 v                               
   BEGIN CASE                              
      CASE OPO.UOM<1,MV.NUM> = 'M'          
         U.PRICE = OPO.U.PRICE<1,MV.NUM>/1000
      CASE OPO.UOM<1,MV.NUM> = 'C'          
         U.PRICE = OPO.U.PRICE<1,MV.NUM>/100 
      CASE 1                                
         U.PRICE = OPO.U.PRICE<1,MV.NUM>     
   END CASE                                
  * IF OPO.UOM<1,MV.NUM> = "M" THEN
  *   U.PRICE = OPO.U.PRICE<1,MV.NUM>/1000
  * END ELSE
  *   U.PRICE = OPO.U.PRICE<1,MV.NUM>
  * END
  *T23319 ^
   OPEN.PRICE = INT((U.PRICE / 10000) * ((OPO.TOT.OPEN<1,MV.NUM> ) ))
* T21511
   D.LINE = D.LINE : OCONV(OPEN.PRICE , "MD2") "R#11"
   TOT.AMT = TOT.AMT + OPEN.PRICE
   PRINT D.LINE
   LINE.COUNT = LINE.COUNT + 1
   RETURN
**** PRINT HEADING
9000*
   PRINT CHAR(12):
   PAGE.NO = PAGE.NO + 1
*T25901 v
*  H.LINE = ''
*  H.LINE = H.LINE : "DATE : " :OCONV(DATE(),"D2/") "L#8"
*  H.LINE = H.LINE : SPACE(POS) : CONO.NAME "L#30"
*  H.LINE = H.LINE : SPACE(POS2) : 'PAGE ' : PAGE.NO "R#3"
*  PRINT H.LINE
*  H.LINE = ''
*  H.LINE = H.LINE : SPACE(46) : 'OPEN OUTSIDE PURCHASE ORDER REPORT'
*  PRINT H.LINE
*  H.LINE = H.LINE:"DIVISION : ":DIV.OWNER"L#3"
*  H.LINE = H.LINE : SPACE(48) : '     BY EXPECTED DATE   '
*  PRINT H.LINE
   HLINE3 = "DIVISION : ":DIV.OWNER"L#3"
   HLINE3 = HLINE3 : SPACE(50): OCONV(START.DELIVER.DATE.RANGE,'D2/')
   HLINE3 = HLINE3 : " THRU ":OCONV(END.DELIVER.DATE.RANGE,'D2/')
   PRINT HLINE1:PAGE.NO"R#3"
   PRINT HLINE2
   PRINT HLINE3
*T25901 ^
*T25850 v
   H.LINE = ''
   H.LINE = "WAREHOUSE : ":OPO.WHSE
   PRINT H.LINE
*T25850 ^
   PRINT
   PRINT
   PRINT HD1
   PRINT HD2
   PRINT HD3
   LINE.COUNT = 11
   RETURN
***** CALLS FOR SYSCOM
91000 ERR.TYPE = 1 ; CALL SYSCOM(MAT SYSCOM.REC)
   RETURN
92000 ERR.TYPE = 2 ; CALL SYSCOM(MAT SYSCOM.REC)
   RETURN
93000 ERR.TYPE = 3 ; CALL SYSCOM(MAT SYSCOM.REC)
99999 PRINTER OFF
END
