*COPY>CPYLIB>COM1
*COPY>PMC.CPYLIB>COM.CUST
*COPY>OPS.CPYLIB>COM.ORDER
*********************************************************************
* REVISION    - [08.0]
* COPYRIGHT   - 2001 by C.B.A  (Vercom Software,Inc.)
* SYSTEM      - PRIMAC-OPS
* SOURCE      - R12OPSBP
* PROGRAM     - OPS.INVOICE.SUMMARY
* AUTHOR      - RENEE YANEZ, CBA
* DATE        - 06/13/2001
* DESCRIPTION
* (See T25860)
* (This program copied from JOB.INVOICE.SUMMARY.F4)
*  This program will display all invoices, credit memos etc. for a
*  specified order. Summary level data is also displayed. Detail data
*  regarding specific invoice, credit memo etc. may be displayed for
*  items which still reside on system.
* COMMENT      - REVISED TO REFLECT JOB.STATUS '5' - "REOPENED"
*              - TASK #12907 (RRG)
*              - TASK #17928 (SFC) NEW TYPE OF XREF PROCESSING
*T22417 lanny 12/10/1997 * For Master/Sub Job always prompt for
*                          inclusion of subs.
*T24570 edvard 11/12/1999 * FIX DISPLAY PROBLEM IN INVOICE AREA. SEE CSF
*                           34759
*                           FIX IS ACTUALY IN SCRN.EDIT PROGRAM.
*T25016 edvard 04/04/2000 * SIMILAR PROBLEM AS THE ON ABOVE. IF USER TRYS 
*                           TO "RI" THEN ERROR MSG "OUT OF RANGE"
*                           POPS UP
*T25764 cmykleb 02/21/2002 * Add "Terms Code" field that defaults from
*                            customer record but allows edit.  Add the
*                            number of days stored in the terms record
*                            to the invoice date to come up with the
*                            terms on invoice
*********************************************************************
*COPY>CPYLIB>EDIT.COM
*COPY>CPYLIB>EDIT.COM.DRIVER
*COPY>PMC.CPYLIB>COMPANY
*COPY>PMC.CPYLIB>CUSTOMER
*COPY>JCS.CPYLIB>JOB
*COPY>OPS.CPYLIB>DAILY.ORDER.INVOICE    ; * T25860
*COPY>OPS.CPYLIB>ORDER.INVOICE          ; * T25860
*COPY>OPS.CPYLIB>ORDER                  ; * T25860
*COPY>PMC.CPYLIB>TAX
*COPY>CPYLIB>GEN.XREF.SUB
*COPY>CPYLIB>XREF.DATA
*COPY>CPYLIB>SYSCOM
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>CHAR
*COPY>PMC.CPYLIB>SALES.CODE
*COPY>PMC.CPYLIB>GLTABLE
*COPY>PMC.CPYLIB>COA
*
   SYS.TYPE = 1
   CALL SYSCOM(MAT SYSCOM.REC)
   MAT FILE.VARS = ""
   OPEN "","JOB" TO JOB ELSE ERRMSG = "JOB FILE IS MISSING"; GOTO 93000
   OPEN "","CUSTOMER" TO CUSTOMER ELSE ERRMSG = "CUSTOMER FILE IS MISSING"; GOTO 93000
   OPEN "","DIVISION" TO DIVISION ELSE ERRMSG="DIVISION FILE IS MISSING"; GOTO 93000
   OPEN "","DEPARTMENT" TO DEPARTMENT ELSE ERRMSG="DEPARTMENT FILE IS MISSING"; GOTO 93000
   OPEN "","COST.CNTR" TO COST.CNTR ELSE ERRMSG="COST.CNTR FILE IS MISSING"; GOTO 93000
   OPEN "","CUSTOMER.XREF" TO CUSTOMER.XREF ELSE ERRMSG = "CUSTOMER.XREF FILE IS MISSING"; GOTO 93000
   OPEN "","OPS.SCREENS" TO M.SCREENS ELSE ERRMSG="JCS.SCREENS FILE IS MISSING"; GOTO 93000
* T25860 v Open related OPS files 
   OPEN "","ORDER" TO ORDER ELSE ERRMSG = "ORDER FILE IS MISSING"; GOTO 93000
   OPEN "","DAILY.ORDER.INVOICE" TO DAILY.ORDER.INVOICE ELSE ERRMSG = "DAILY.ORDER.INVOICE FILE IS MISSING"; GOTO 93000
   OPEN "","ORDER.INVOICE" TO ORDER.INVOICE ELSE ERRMSG = "ORDER.INVOICE FILE IS MISSING"; GOTO 93000
* T25860 ^
   OPEN "","COMPANY" TO COMPANY ELSE ERRMSG = "COMPANY FILE IS MISSING"; GOTO 93000
   OPEN "","PREFIX" TO PREFIX ELSE ERRMSG = "PREFIX FILE IS MISSING"; GOTO 93000
   OPEN "","XREF.DATA" TO XREF.DATA ELSE ERRMSG = "XREF.DATA FILE IS MISSING"; GOTO 93000
   OPEN "","CONTROL" TO CONTROL ELSE ERRMSG = "CONTROL FILE IS MISSING"; GOTO 93000
   OPEN "","JOB.SHIP" TO JOB.SHIP ELSE ERRMSG = "JOB.SHIP FILE IS MISSING"; GOTO 93000
   OPEN "","INVOICE" TO INVOICE ELSE ERRMSG = "INVOICE FILE IS MISSING"; GOTO 93000
   OPEN "","DAILY.INVOICE" TO DAILY.INVOICE ELSE ERRMSG = "DAILY.INVOICE FILE IS MISSING"; GOTO 93000
   OPEN "","TAX" TO TAX ELSE ERRMSG = "TAX FILE IS MISSING"; GOTO 93000
   OPEN "","SHIP.VIA" TO SHIP.VIA ELSE ERRMSG = "SHIP.VIA FILE IS MISSING"; GOTO 93000
   OPEN "","INVOICE.CODE" TO INVOICE.CODE ELSE ERRMSG = "INVOICE.CODE FILE IS MISSING"; GOTO 93000
   OPEN "","INV.JOB.STATS" TO INV.JOB.STATS ELSE ERRMSG = "INV.JOB.STATS FILE IS MISSING"; GOTO 93000
   OPEN "","SALES.CODE" TO SALES.CODE ELSE ERRMSG = "SALES.CODE FILE IS MISSING"; GOTO 93000
   OPEN "","COA" TO COA ELSE ERRMSG = "COA FILE IS MISSING"; GOTO 93000
   OPEN "","COA" TO COA ELSE ERRMSG = "COA FILE IS MISSING"; GOTO 93000
*T25764 v
   OPEN '',"TERMS" TO TERMS ELSE
      ERRMSG = "Cannot locate the TERMS file" ; GOTO 93000
   END
*T25764 ^
*
   MAT COMP.REC = ""
   CONO = ""
   CALL GET.CONO(CONO,MAT COMP.REC)
   IF CONO = "END" THEN GOTO 99999
   MAT EDIT.COM = ""
   MAT EDIT.COM.DRIVER = ""
   MAT GEN.XREF.REC = ""
   DASHES = STR("-",80)
   ERRMSG = ""
   UNKNOWN = "????????????????????"
   DESC.START = 1
   IVC.START = 1
   IVC.NO = ""
   GXR.CO = CONO
   ECD.SCRN.CNT = 4
*      ECD.SCRN.NAME<1> = "OPS.INVOICE.MAINT"
   ECD.SCRN.NAME<1> = "OPS.INVOICE.INQ"
   ECD.SCRN.NAME<2> = "OPS.INVOICE.LINE.SUB"
   ECD.SCRN.NAME<3> = "OPS.INVOICE.SUMMARY"
   ECD.ACTION=1;CALL SCRN.EDIT
   ECD.SCRN.NO = 3
   ESN = 3
*      TYP = 0 ;CALL EDIT.SUB ; FILL = "#"
100 MAT ORD.REC = ""
   MAT SCV.REC = ""
   SAVE.INV.ORD.REC = ""
   ADD.SUBS = 0
   ECD.ACTION=6;CALL SCRN.EDIT
   ECD.NUM = 1
   ECD.VALDAT.CODE = "2"; ECD.VALDAT.FILE = ORDER; ECD.PREFIX.ID = CONO
   ECD.ACTION=4;CALL SCRN.EDIT
   BEGIN CASE
      CASE ECD.RET.VALUE = "END"
         GOTO 99999
      CASE ECD.RET.VALUE # "" AND ECD.VALDAT.ITEM = ""
         ERRMSG = "Order ":ECD.RET.VALUE:" is not on file" ; GOSUB 91000 ; GOTO 100
      CASE ECD.VALDAT.ITEM # ""
         FOR I = 1 TO ORD.REC.SIZE; ORD.REC(I) = ECD.VALDAT.ITEM<I>; NEXT I
         ORD.NUM = ECD.RET.VALUE
         ECD.NUM = 5; GOSUB 20000; GOSUB 30000
      CASE ECD.RET.VALUE = ""
         ORD.NUM = ""; ORD.CUST = "" ;GOSUB 1100
         IF ORD.CUST # "" THEN GOSUB 10000
         IF ORD.NUM = "" THEN
            ERRMSG = "No orders present for customer ":ORD.CUST
            GOSUB 91000; GOTO 100
         END ELSE
            ECD.NUM = 8; GOSUB 20000; GOSUB 30000
         END
      CASE 1
         ERRMSG = "* * INVALID SEQUENCE # * *"
         GOSUB 91000; GOSUB 100
   END CASE
500 ECD.NUM = 24
   SCV.REC(ECD.NUM)<ESN> = ""
   ECD.ACTION=4;CALL SCRN.EDIT
   REQUEST = ECD.RET.VALUE
   BEGIN CASE
      CASE REQUEST = "END" OR REQUEST = "E"
         IVC.START = 1 ; *T25016
         GOTO 100
*     CASE REQUEST = "SD" AND DESC.CNT
*        IF DESC.CNT > 4 THEN
*           DESC.START = DESC.START + 4
*           IF DESC.START > DESC.CNT THEN DESC.START = 1
*           ECD.NUM = 14 ; ECD.SUB.NUM = DESC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
*        END
      CASE REQUEST = "RI"
         GOSUB 3000
      CASE REQUEST = "SI" AND IVC.CNT
         IF IVC.CNT > 2 THEN
            IVC.START = IVC.START + 2
            IF IVC.START > IVC.CNT THEN IVC.START = 1
            ECD.NUM = 15 ; ECD.SUB.NUM = IVC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
            ECD.NUM = 16 ; ECD.SUB.NUM = IVC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
            ECD.NUM = 17 ; ECD.SUB.NUM = IVC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
            ECD.NUM = 18 ; ECD.SUB.NUM = IVC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
            ECD.NUM = 19 ; ECD.SUB.NUM = IVC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
            ECD.NUM = 20 ; ECD.SUB.NUM = IVC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
            ECD.NUM = 21 ; ECD.SUB.NUM = IVC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
            ECD.NUM = 22 ; ECD.SUB.NUM = IVC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
            ECD.NUM = 23 ; ECD.SUB.NUM = IVC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
            ECD.NUM = 30 ; ECD.SUB.NUM = IVC.START ; ECD.ACTION = 7 ; CALL SCRN.EDIT
         END
   END CASE
   GOTO 500
1100 ECD.NUM = 6
   ECD.VALDAT.CODE = 2; ECD.VALDAT.FILE = CUSTOMER; ECD.PREFIX.ID = CONO
   ECD.ACTION=4;CALL SCRN.EDIT
   IF ECD.RET.VALUE = "" THEN
      ECD.NUM = 7; ECD.ACTION=4;CALL SCRN.EDIT
      IF ECD.RET.VALUE = "" OR ECD.RET.VALUE = "END" THEN GOTO 1100
      GXR.NAME = "CUSTOMER"
      GXR.XREF = CUSTOMER.XREF
      GXR.FILE = CUSTOMER
      GXR.SRCH.ID = ECD.RET.VALUE
      CALL GEN.XREF.SUB(MAT GEN.XREF.REC, PREFIX, XREF.DATA)
      ECD.ACTION=2;CALL SCRN.EDIT
      IF GXR.ID = "" THEN
         SCV.REC(7)<ESN> = ""
         ECD.ACTION = 3 ; CALL SCRN.EDIT
         GOTO 1100
      END ELSE
         MATREAD CUST.REC FROM CUSTOMER, CONO:GXR.ID ELSE
            ERRMSG = "Cannot locate customer ":GXR.ID
            GOSUB 91000
            SCV.REC(7)<ESN> = ""
            ECD.ACTION = 3 ; CALL SCRN.EDIT
            GOTO 1100
         END
         ORD.CUST = GXR.ID
         SCV.REC(6)<ESN> = ORD.CUST
         SCV.REC(7)<ESN> = CUST.NAME
         ECD.ACTION = 3 ; CALL SCRN.EDIT
      END
   END ELSE
      IF ECD.RET.VALUE # "END" THEN
         ORD.CUST = ECD.RET.VALUE
         FOR I = 1 TO CUST.REC.SIZE; CUST.REC(I) = ECD.VALDAT.ITEM<I>; NEXT I
         ECD.NUM = 7
         SCV.REC(ECD.NUM)<ESN> = CUST.NAME
         ECD.ACTION=5;CALL SCRN.EDIT
      END
   END
   RETURN
3000*
   ECD.NUM = 31; ECD.MINV = IVC.START
   IF IVC.START + 4 > IVC.CNT THEN ECD.MAXV = IVC.CNT ELSE ECD.MAXV = IVC.START + 4
   CALL SCRN.EDIT
   IF ECD.RET.VALUE = "" OR ECD.RET.VALUE = "END" THEN GOTO 3999
   IF ORD.INV.CAT<1,ECD.RET.VALUE,1> = "PP" THEN
      ERRMSG = "This is a prepayment"; GOSUB 91000; GOTO 3999
   END
   MAT IVC.REC = ""
   IF ORD.INV.DATE<1,ECD.RET.VALUE> = "" THEN
      MATREAD IVC.REC FROM DAILY.ORDER.INVOICE, CONO:ORD.INV.NO<1,ECD.RET.VALUE> ELSE
         ERRMSG = "Cannot locate invoice on DAILY.ORDER.INVOICE file"
         GOSUB 91000
         GOTO 3999
      END
   END ELSE
      MATREAD IVC.REC FROM ORDER.INVOICE, CONO:ORD.INV.NO<1,ECD.RET.VALUE> ELSE
         ERRMSG = "Cannot locate invoice on ORDER.INVOICE file";GOSUB 91000;GOTO 3999
      END
   END
   IVC.NO = ORD.INV.NO<1,ECD.RET.VALUE>
   BEGIN CASE
      CASE IVC.NO[7,2] = "CM"
         MENU = "CREDIT"
         ECD.SCRN.NAME<1> = "OPS.CREDIT.INQ"
         ECD.SCRN.NAME<2> = "OPS.INVOICE.LINE.SUB"
         ECD.SCRN.FLAG<2> = 1
      CASE IVC.NO[7,2] = "DM"
         MENU = "DEBIT"
         ECD.SCRN.NAME<1> = "OPS.DEBIT.INQ"
         ECD.SCRN.NAME<2> = "OPS.INVOICE.LINE.SUB"
         ECD.SCRN.FLAG<2> = 1
      CASE 1
         MENU = "INVOICE"
         ECD.SCRN.NAME<1> = "OPS.INVOICE.INQ"
         ECD.SCRN.NAME<2> = "OPS.INVOICE.LINE.SUB"
         ECD.SCRN.FLAG<2> = 1
   END CASE
   IF IVC.NO[7,2] = "PB" THEN
      CALL OPS.INVOICE.INQ(CONO,IVC.NO,"INVOICE","I")
   END ELSE
      CALL OPS.INVOICE.INQ(CONO,IVC.NO,MENU)
   END
   ECD.SCRN.NO = 3
   ECD.ACTION=2;CALL SCRN.EDIT
   IF IVC.NO = "" THEN GOSUB 30001 ELSE ECD.ACTION = 3 ; CALL SCRN.EDIT
   IVC.START = 1
3999 RETURN
* 10000 GXR.XREF = CUSTOMER
*       GXR.FILE = ORD
*       GXR.LOC = 34
*       GXR.ATT<1,2> = 16
*       GXR.LEN<1,2> = 60
*       GXR.TOP.LINE<1,1> = "ORD XREF SEARCH"
*       GXR.TOP.LINE<1,2> = "FOR CUSTOMER : ":CUST.NAME
*       GXR.HEADING<1,1> = "ORD"
*       GXR.ID = ""
*       GXR.SRCH.ID = ORD.CUST
10000*
   GXR.NAME = "ORDER"
   GXR.XREF = CUSTOMER
   GXR.FILE = ORDER
   GXR.SRCH.ID = ORD.CUST
   CALL JOB.XREF.SUB(MAT GEN.XREF.REC, PREFIX, XREF.DATA)
   ECD.ACTION = 2; CALL SCRN.EDIT
   IF GXR.ID # "" THEN
      MATREAD ORD.REC FROM ORDER, CONO:GXR.ID ELSE
         ERRMSG = "Cannot locate order ":GXR.ID
         GOSUB 91000
      END
      ORD.NUM = GXR.ID
   END
   RETURN
20000 SCV.REC(ECD.NUM)<ESN> = ORD.STATUS<1,1>
30000*
   MATREAD CUST.REC FROM CUSTOMER, CONO:ORD.CUST ELSE
      MAT CUST.REC = ""
      CUST.NAME = UNKNOWN
   END
   SCV.REC(1)<ESN> = ORD.NUM
   SCV.REC(6)<ESN> = ORD.CUST
   SCV.REC(7)<ESN> = CUST.NAME
   SCV.REC(3)<ESN> = ORD.DATE
   SCV.REC(4)<ESN> = ORD.DUE
   SCV.REC(10)<ESN> = ORD.TOT.INV
   SCV.REC(13)<ESN> = SUM(ORD.INV.BAL)
30001*
   IVC.CNT = COUNT(ORD.INV.NO,VM) + (ORD.INV.NO # "")
   SCV.REC(15)<ESN> = ""
   SCV.REC(16)<ESN> = ""
   SCV.REC(17)<ESN> = ""
   SCV.REC(18)<ESN> = ""
   SCV.REC(19)<ESN> = ""
   SCV.REC(20)<ESN> = ""
   SCV.REC(21)<ESN> = ""
   SCV.REC(22)<ESN> = ""
   SCV.REC(23)<ESN> = ""
   SCV.REC(30)<ESN> = ""
   PRE.PAID = 0
   FOR I = 1 TO IVC.CNT
      MAT IVC.REC = ""
      IF ORD.INV.CAT<1,I,1> = "PP" THEN
         BILL.AMT = ""
         TAX.AMT = ""
         INV.AMT = ""
         PAID.AMT = INV.AMT - ORD.INV.BAL<1,I>
         PRE.PAID = PRE.PAID + ORD.INV.BAL<1,I>
         GOTO 30005
      END
      IF ORD.INV.DATE<1,I> = "" THEN
         MATREAD IVC.REC FROM DAILY.ORDER.INVOICE, CONO:ORD.INV.NO<1,I> ELSE NULL
         GOSUB 40000
      END ELSE
         MATREAD IVC.REC FROM ORDER.INVOICE,CONO:ORD.INV.NO<1,I> ELSE
            IVC.PRT.DATE = "PURGED"
         END
         GOSUB 50000
      END
30005*
      SCV.REC(15)<ESN,I> = I
      SCV.REC(16)<ESN,I> = ORD.INV.NO<1,I>
      SCV.REC(17)<ESN,I> = ORD.INV.DATE<1,I>
      SCV.REC(18)<ESN,I> = IVC.PRT.DATE
      SCV.REC(19)<ESN,I> = BILL.AMT
      SCV.REC(20)<ESN,I> = TAX.AMT
      SCV.REC(21)<ESN,I> = INV.AMT
      SCV.REC(22)<ESN,I> = PAID.AMT
      SCV.REC(23)<ESN,I> = ORD.INV.BAL<1,I>
      SCV.REC(30)<ESN,I> = IVC.PROC.MON
   NEXT I
   SCV.REC(11)<ESN> = PRE.PAID * (-1)
   SCV.REC(12)<ESN> = ORD.TOT.INV - SUM(ORD.INV.BAL) + PRE.PAID
   ECD.ACTION = 3 ; CALL SCRN.EDIT
   RETURN
*
*--- GET BALANCE AND TAX FROM DAILY.INVOICE
*
40000*
   BILL.AMT = ""
   TAX.AMT = ""
   INV.AMT = ""
   PAID.AMT = ""
   CODE.CNT = COUNT(IVC.CHG.CODE,VM) + (IVC.CHG.CODE # "")
   FOR PTR = 1 TO CODE.CNT
      IF IVC.CHG.CODE<1,PTR> = "TOT" OR IVC.CHG.CODE<1,PTR> = "SUB" OR IVC.CHG.CODE<1,PTR> = "SUBT" OR IVC.CHG.CAT<1,PTR> = "CMT" THEN GOTO 49999
      IF ADD.SUBS = 0 AND ORD.NUM # IVC.CHG.JOB<1,PTR> THEN GOTO 49999
      IF ORD.INV.DATE<1,I> = "" AND ORD.INV.NO<1,I>[7,2] = "CM" THEN
         IVC.AMOUNT<1,PTR> = IVC.AMOUNT<1,PTR> * (-1)
      END
      IF IVC.CHG.CAT<1,PTR> = "TAX" THEN
         TAX.AMT = TAX.AMT + IVC.AMOUNT<1,PTR>
      END ELSE
         BILL.AMT = BILL.AMT + IVC.AMOUNT<1,PTR>
      END
49999*
   NEXT PTR
   INV.AMT = TAX.AMT + BILL.AMT
   RETURN
*
*--- CALCULATE INVOICE BALANCE, DUE AND TAX FROM ORDER (FOR PURGED AND REG INVOICES)
*
50000*
   BILL.AMT = ""
   TAX.AMT = ""
   INV.AMT = ""
   PAID.AMT = ""
   CODE.CNT = COUNT(ORD.INV.CAT<1,I>,SVM) + (ORD.INV.CAT<1,I> # "")
   FOR PTR = 1 TO CODE.CNT
      IF ORD.INV.CAT<1,I,PTR> = "TOT" OR ORD.INV.CAT<1,I,PTR> = "SUB" OR ORD.INV.CAT<1,I,PTR> = "CMT" THEN GOTO 59999
      IF ORD.INV.CAT<1,I,PTR> = "TAX" THEN
         TAX.AMT = TAX.AMT + ORD.INV.AMT<1,I,PTR>
      END ELSE
         BILL.AMT = BILL.AMT + ORD.INV.AMT<1,I,PTR>
      END
59999*
   NEXT PTR
   INV.AMT = TAX.AMT + BILL.AMT
   PAID.AMT = INV.AMT - ORD.INV.BAL<1,I>
   RETURN
91000 ERR.TYPE = 1; CALL SYSCOM(MAT SYSCOM.REC); RETURN
92000 ERR.TYPE = 2; CALL SYSCOM(MAT SYSCOM.REC); RETURN
93000 ERR.TYPE = 3; CALL SYSCOM(MAT SYSCOM.REC)
99999 * PRINT * @(-1)
END
