*********************************************************************
* REVISION    - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - ICSBP
* PROGRAM     - FNGD.JOB.RPT
* BY          - JULIANNE RIVERA, VERCOM SOFTWARE, INC
* DATE        - 03/23/92
* DESCRIPTION -
*T26039 lanny 07/19/2001 * Available Qty disregarding reservable Qty.
*T26493 cmykleb 03/27/2002 * Change report to read rpt # from the proc.
*T27668 cmykleb 08/26/2003 * Rev12.
*ENDDOC
*********************************************************************
*
*COPY>ICS.CPYLIB>INVENTORY
*COPY>ICS.CPYLIB>INV.WHSE ;*T26039
*COPY>ICS.CPYLIB>FNGD.JOB.STATS
*COPY>ICS.CPYLIB>INV.CNV
*COPY>PMC.CPYLIB>CUSTOMER
*COPY>PMC.CPYLIB>FISCAL ; * T27668
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>CHAR
*
*
*---- OPEN FILES
*
   OPEN '','FNGD.JOB.STATS' TO FNGD.JOB.STATS ELSE ERRMSG = "FNGD.JOB.STATS IS MISSING"; GOTO 93000
   OPEN '','CUSTOMER' TO CUSTOMER ELSE ERRMSG = "CUSTOMER IS MISSING"; GOTO 93000
   OPEN '','CONTROL' TO CONTROL ELSE ERRMSG = "CONTROL IS MISSING"; GOTO 93000
   OPEN '','COMPANY' TO COMPANY ELSE ERRMSG = "COMPANY IS MISSING"; GOTO 93000
   OPEN '','INVENTORY' TO INVENTORY ELSE ERRMSG = "INVENTORY IS MISSING"; GOTO 93000
   OPEN '','INV.WHSE' TO INV.WHSE ELSE ERRMSG = "INV.WHSE IS MISSING"; GOTO 93000 ;*T26039
*
*---- DEFINE HEADINGS
*
   PROCREAD BUFFER ELSE
      ERRMSG = 'CANNOT PERFORM PROCREAD'
      GOTO 93000
   END
   CONO = BUFFER<1>
*T27668 v
   SYS.FISCAL = 'ICFISCAL'
   MATREAD FISCAL.REC FROM CONTROL, CONO:SYS.FISCAL ELSE 
      MAT FISCAL.REC = ''
   END
   PERIOD = FR.CURR.PER<1,1>
*T27668 ^
   RPT.TYPE = BUFFER<8>
*T26493 v
*  CONO.NAME = BUFFER<2>
*  IF RPT.TYPE = "D" THEN
*     REPORT.NAME = "FINISHED GOODS JOB DETAIL REPORT"
*  END ELSE
*     REPORT.NAME = "FINISHED GOODS JOB SUMMARY REPORT"
*  END
*  REPORT.NUMBER = "XXXX"
   CONO.NAME = ""
   REPORT.NAME = ""
   REPORT.NUMBER = BUFFER<2>
   IF RPT.TYPE = "S" THEN
      HD3 = SPACE(69):"S U M M A R Y"
   END ELSE
      HD3 = SPACE(69):"D E T A I L"
   END
*T26493 ^
   REPORT.DATE = DATE()
   HD1 = "" ; HD2 = ""
   CALL GET.PROG.HEAD(CONO,CONO.NAME,REPORT.NAME,REPORT.NUMBER,REPORT.DATE,HD1,HD2)
   IF RPT.TYPE = "S" THEN
      S.HD1 = "            PRODUCT / DESCRIPTION              MANUFACT   ALLOCATED  AVAILABLE"
      S.UN1 = "--------------------------------------------- ---------- ---------- ----------"
   END ELSE
      S.HD1 = "            PRODUCT / DESCRIPTION               CUSTOMER / NAME    JOB NUMBER  JOB DATE ORDER #  MANUFACT   ALLOCATED  AVAILABLE"
      S.UN1 = "--------------------------------------------- -------------------- ----------- -------- ------- ---------- ---------- ----------"
      S.UN2 = SPACE(96):"---------- ---------- ----------"
      S.FT2 = SPACE(62):"TOTAL FOR PRODUCT "
   END
*
*---- INITIALIZATION
*
   FIRST.REC = 1
   LINE.CNT = 99
   UNKNOWN = STR('?',30)
   SP1 = SPACE(1)
   PAGE.NO = 0
   PREV.WHSE = ""
   PREV.PRODNUM = ""
   PREV.PLINE = ""
   PREV.DESC = ""
   TOT.MANU = 0
   TOT.ALOC = 0
   TOT.AVAL = 0
   PRT.PROD = 0
   PRINTER ON
*
*---- MAIN PROCESSING 
*
1  READNEXT ID ELSE GOTO 99999
   JOBNUM = FIELD(ID,"!",3)
   PRODNUM = FIELD(ID,"!",1)[4,99]
   WHSE = FIELD(ID,"!",2)
   WHSE = FIELD(WHSE,"!",1)
*T26039 v
   IWH.ID = OCONV(ID,'G!2')
   GOSUB 5000
   IF AVAL.QTY = 0 THEN GOTO 1
*T26039 ^
   PREV.PRODNUM = PRODNUM
   PREV.WHSE = WHSE
   MATREAD INV.REC FROM INVENTORY, CONO:PRODNUM ELSE
      MAT INV.REC = ""
   END
   PREV.PLINE = INV.LINE
   GOSUB 1000
   DONE = 0
   LOOP
      JOBNUM = FIELD(ID,"!",3)
      PRODNUM = FIELD(ID,"!",1)[4,99]
      WHSE = FIELD(ID,"!",2)
      WHSE = FIELD(WHSE,"!",1)
      MATREAD FJS.REC FROM FNGD.JOB.STATS, ID ELSE
         MAT FJS.REC = ""
      END
      MATREAD CUST.REC FROM CUSTOMER, CONO:FJS.CUST ELSE CUST.NAME = UNKNOWN
      MATREAD INV.REC FROM INVENTORY, CONO:PRODNUM ELSE
         MAT INV.REC = ""
         INV.FULL.DESC = UNKNOWN
      END
      BEGIN CASE
         CASE WHSE # PREV.WHSE OR INV.LINE # PREV.PLINE 
            IF RPT.TYPE = "D" THEN
               GOSUB 4000
            END ELSE
               GOSUB 600
            END
            GOSUB 1000
         CASE PREV.PRODNUM # PRODNUM 
            IF RPT.TYPE = "D" THEN
               GOSUB 4000
            END ELSE
               GOSUB 600
            END
            IF LINE.CNT > 55 THEN GOSUB 1000
         CASE LINE.CNT > 55
            GOSUB 1000
      END CASE
      GOSUB 2000
      GOSUB 500
   UNTIL DONE DO
99    READNEXT ID ELSE   
         IF RPT.TYPE = "D" THEN      
            GOSUB 4000
         END ELSE
            GOSUB 600
         END
         GOTO 99999
      END
*T26039 v
      IWH.ID = OCONV(ID,'G!2')
      JOBNUM = FIELD(ID,"!",3)
      GOSUB 5000
      IF AVAL.QTY = 0 THEN GOTO 99
*T26039 ^
   REPEAT
   GOTO 99999
*
*---- PRINT DETAIL LINES
500 *
   BEGIN CASE
      CASE PRODNUM = PREV.PRODNUM AND RPT.TYPE = "D" AND NOT(FIRST.REC) AND NOT(PRT.PROD)
         LINE = SPACE(46)
         LINE2 = SPACE(46)
      CASE 1
         LINE = PRODNUM "L#15":SPACE(31)
         LINE2 = INV.FULL.DESC "L#45":SP1
         PRT.PROD = 0
         IF RPT.TYPE = "S" THEN GOTO 599
   END CASE
   FIRST.REC = 0
   LINE = LINE : FJS.CUST "L#8" :SPACE(13)
   LINE2 = LINE2 : CUST.NAME "L#30" : SPACE(12)
   LINE = LINE : JOBNUM "L#11" :SP1
   LINE = LINE : OCONV(FJS.DATE,"D2/") "L#8" :SP1
   LINE = LINE : FJS.ORD<1,1> "L#7" :SP1
   LINE2 = LINE2 : FJS.ORD<1,2> "L#7" :SP1
   PQTY = INT(((FJS.M.QTY+0/ICR.DV1) * ICR.MT1) / ICR.DV2 + .5)
   LINE = LINE : OCONV(PQTY,ICR.CNV1) "R#10" : SP1
   PQTY = INT(((FJS.A.QTY+0/ICR.DV1) * ICR.MT1) / ICR.DV2 + .5)
   LINE = LINE : OCONV(PQTY,ICR.CNV1) "R#10" : SP1
*T26039 AVAL.QTY = (FJS.M.QTY+0) - (FJS.A.QTY+0)
*T26039 IF AVAL.QTY < 0 THEN AVAL.QTY = 0
   LINE = LINE : OCONV(INT(((AVAL.QTY/ICR.DV1) * ICR.MT1) / ICR.DV2 +.5),ICR.CNV1) "R#10" 
   PRINT LINE
   PRINT LINE2
   LINE.CNT = LINE.CNT + 2
   ORDCNT = DCOUNT(FJS.ORD,VM)
   FOR X = 3 TO ORDCNT
      PRINT SPACE(86):FJS.ORD<1,X>
      LINE.CNT = LINE.CNT + 1
   NEXT X
599 *
   PREV.PRODNUM = PRODNUM
   PREV.WHSE = WHSE
   PREV.PLINE = INV.LINE
   TOT.MANU = TOT.MANU + (FJS.M.QTY+0)
   TOT.ALOC = TOT.ALOC + (FJS.A.QTY+0)
*T26039 AVAL.QTY = (FJS.M.QTY+0) - (FJS.A.QTY+0)
*T26039 IF AVAL.QTY < 0 THEN AVAL.QTY = 0
   TOT.AVAL = TOT.AVAL + AVAL.QTY
   RETURN
*
*---- PRINT SUMMARY LINE
600 *
   LINE = LINE : OCONV(INT(((TOT.MANU/ICR.DV1) * ICR.MT1) / ICR.DV2 +.5),ICR.CNV1) "R#10" :SP1
   LINE = LINE : OCONV(INT(((TOT.ALOC/ICR.DV1) * ICR.MT1) / ICR.DV2  + .5),ICR.CNV1) "R#10" :SP1
   LINE = LINE : OCONV(INT(((TOT.AVAL/ICR.DV1) * ICR.MT1) / ICR.DV2 +.5),ICR.CNV1) "R#10" 
   PRINT LINE
   PRINT LINE2
   LINE.CNT = LINE.CNT + 2
   TOT.MANU = 0
   TOT.ALOC = 0
   TOT.AVAL = 0
   RETURN
*** PRINT HEADINGS
1000 *
   PRINT CHAR(12)
   PAGE.NO = PAGE.NO + 1
   PRINT HD1:PAGE.NO
   PRINT HD2
   PRINT HD3 ; * T26493
   PRINT "WAREHOUSE : ":WHSE "L#8"
   PRINT "MLINE / PLINE : FNGD / ":INV.LINE
   PRINT
   PRINT S.HD1
   PRINT S.UN1
   PRT.PROD = 1
   LINE.CNT = 8
   RETURN
*
*---- CONVERSION
2000 *
*COPY>ICSBP>INV.UM.CNV
   RETURN
*
*---- PRINT TOTALS
*
4000 *
   LINE = OCONV(INT(((TOT.MANU/ICR.DV1) * ICR.MT1) / ICR.DV2 +.5),ICR.CNV1) "R#10" :SP1
   LINE = LINE : OCONV(INT(((TOT.ALOC/ICR.DV1) * ICR.MT1) / ICR.DV2  + .5),ICR.CNV1) "R#10" :SP1
   LINE = LINE : OCONV(INT(((TOT.AVAL/ICR.DV1) * ICR.MT1) / ICR.DV2 +.5),ICR.CNV1) "R#10" 
   PRINT S.UN2
   PRINT S.FT2:PREV.PRODNUM"L#15":SP1:LINE
   PRINT
   LINE.CNT = LINE.CNT + 3
   TOT.MANU = 0
   TOT.ALOC = 0
   TOT.AVAL = 0
   RETURN
*
* Determine Reservable Qty T26039
*
5000 *
   AVAL.QTY=0
   MATREAD IWH.REC FROM INV.WHSE, IWH.ID THEN
*T27668 v
      IF IWH.RECP.NO # '' THEN
         ERR.FLG = '' ; ERRMSG = '' ; OPEN.FLAG = 1
         CALL BUILD.IWH.FI(IWH.ID,MAT IWH.REC,PERIOD,ERR.FLG,ERRMGS,OPEN.FLAG)
      END
*T27668 ^
      JLIMIT=DCOUNT(IWH.RECV.FI,VM)
      PTR=1
      LOOP
         LOCATE JOBNUM IN IWH.PO.NO.FI<1>,PTR SETTING JFND ELSE NULL
         IF JFND <= JLIMIT THEN AVAL.QTY += IWH.RSV.FI<1,JFND>
         PTR = JFND+1
      WHILE PTR <= JLIMIT DO REPEAT
   END
   IF AVAL.QTY < 0 THEN AVAL.QTY = 0
   RETURN
*
91000 PRINT @(0,23) : ERRMSG : CL :
   INPUT X :
   PRINT @(0,23) : CL :
   RETURN
93000 PRINT @(0,23) : ERRMSG : CL :
   INPUT X :
   PRINT @(0,23) : CL :
99999 *
   PRINTER CLOSE
   PRINTER OFF
END
