SUBROUTINE JCS_TIMEANDMATERIAL_GETTAMDETAILS(CONO, INPUTPARAM, ERRMSG, OUT_PARAM_SALES,SCHEMA.ONLY)
SCHEMA.ONLY = 0
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE PMC.CPYLIB EMPLOYEE
OPEN "","COMPANY" TO COMPANY ELSE
           ERRMSG = "CANNOT OPEN COMPANY FILE"
           GOTO 99999
END
OPEN "","CONTROL" TO CONTROL ELSE
           ERRMSG = "CANNOT OPEN CONTROL FILE"
           GOTO 99999
END
MATREAD COMP.REC FROM COMPANY,CONO ELSE
ERRMSG="Company number ":CONO : " does not exist"
GOTO 99999
END
STAR.DATE = INPUTPARAM<1,1>
END.DATE = INPUTPARAM<1,2>
DTM_DIV = INPUTPARAM<1,3>
SHIFTS = INPUTPARAM<1,4>
OPTIONS = INPUTPARAM<1,5>
PROCESS.TYPE = INPUTPARAM<1,6>;*VIEW,FILE OR PURGE(V,F,P)
WRITE "INPUTPARAM ":INPUTPARAM ON CONTROL,'01WEB'
BEGIN CASE
   CASE INPUTPARAM = "DIVISION"
        OUT_PARAM_SALES ='<Division>'
	OPEN "","EMPLOYEE" TO EMPLOYEE ELSE
			   ERRMSG = "CANNOT OPEN EMPLOYEE FILE"
			   GOTO 99999
	END
        GOSUB 100
   CASE OPTIONS = "R"
         OUT_PARAM_SALES ='<TamResult>'
	CMD = "SSELECT DAILY.TIME.MATL BY DATE BY S BY EMPLOYEE WITH CONO = '":CONO:"' AND WITH DATE >= '":STAR.DATE:"' AND WITH DATE <= '":END.DATE:"' AND WITH STATUS # ''"
	IF DTM_DIV # "ALL" THEN
	  CMD :=" AND WITH DTM.DIV ='":DTM_DIV:"'"
	END
	IF SHIFTS # "ALL" THEN
	CMD :=" AND WITH SHIFT ='":SHIFTS:"'"
	END
	UDTEXECUTE CMD CAPTURING JUNK RETURNING  RETMSG
	 IF RETMSG<1,2> # "" AND RETMSG<1,2> > 0 THEN
              CALL DAILY_TIME_MATL_PRT_WS(CONO, INPUTPARAM, ERRMSG, OUT_PARAM_SALES,SCHEMA.ONLY)
	      IF ERRMSG # "" THEN GOTO 99999
	 END ELSE
	   ERRMSG = "There is no data to display!"
	   GOTO 99999 
	 END
	 OUT_PARAM_SALES :='</TamResult>'
   CASE 1
   TAMIDS = ""
    OUT_PARAM_SALES ='<TamResult>'
CNT = 1
LOOP
WHILE CNT < 3 DO
	CMD = "SSELECT DAILY.TIME.MATL BY DATE BY SHIFT BY EMPLOYEE WITH CONO = '":CONO:"' AND WITH DATE >= '":STAR.DATE:"' AND WITH DATE <= '":END.DATE:"'"
	IF DTM_DIV # "ALL" THEN
	  CMD :=" AND WITH DTM.DIV ='":DTM_DIV:"'"
	END
	IF OPTIONS # "ALL" THEN
	  CMD :=" AND WITH NO PRINT.DATE"
	END
	IF SHIFTS # "ALL" THEN
	CMD :=" AND WITH SHIFT ='":SHIFTS:"'"
	END
	UDTEXECUTE CMD CAPTURING JUNK RETURNING  RETMSG
	 IF RETMSG<1,2> # "" AND RETMSG<1,2> > 0 THEN
	   IF CNT = 1 THEN
              CALL EDIT_TIME_MATL_WS(CONO, INPUTPARAM, ERRMSG, OUT_PARAM_SALES,SCHEMA.ONLY)
	      IF ERRMSG # "" THEN GOTO 99999
	   END ELSE
              CALL DAILY_TIME_MATL_PRT_WS(CONO, INPUTPARAM, ERRMSG, OUT_PARAM_SALES,SCHEMA.ONLY)
	      IF ERRMSG # "" THEN GOTO 99999
	   END
	*       DATA = 0
	*   LOOP
	*      READNEXT KEY ELSE DATA = 1
	*   WHILE DATA = 0 DO
	*      TAMIDS<1,-1> = KEY
	*   REPEAT
	 END ELSE
	   ERRMSG = "There is no data to display!"
	   GOTO 99999 
	 END
	 	CNT = CNT + 1
REPEAT
 OUT_PARAM_SALES :='</TamResult>'
END CASE
RETURN
100*
XMLLIST = ""
CNT = 0
  CMD= "SSELECT ":INPUTPARAM:" WITH CONO = '":CONO:"'"
UDTEXECUTE CMD CAPTURING JUNG
DATA=1
LOOP
  READNEXT ID ELSE DATA=0
   WHILE DATA DO
    XMLLIST<1,-1> = ID[4,99]
111
REPEAT
OUT_PARAM_SALES :='<DivisionId>':XMLLIST:'</DivisionId>'
OUT_PARAM_SALES :='</Division>'
RETURN
99999*
 IF ERRMSG <> "" THEN
* ERRMSG = "GetSalesCodeDetails----> JCS_GETSALESCODEDETAILS ---> " : ERRMSG
*      CALL WRITELOG(ERRMSG)
        OUT_PARAM_SALES ='<ErrorStack>'  : ERRMSG : '</ErrorStack>'
     * ERRMSG = "GetOPORList ----> OPOR_GETLIST --->": ERRMSG
      CALL WRITELOG(ERRMSG)
 END
 RETURN
 END
