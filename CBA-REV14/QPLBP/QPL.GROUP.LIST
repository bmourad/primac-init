*COPY>CPYLIB>COM1
****************************************************************
*
* REVISION - [08.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
*
* PROGRAM       - QPL.GROUP.LIST
*
* SYSTEM        - JESBP
*
* BY            - RHONDA PERRIN, COMPUTER BUSINESS ASSOCIATES
*
* DATE          - 04/08/86
*
* DESCRIPTION   -
* This program produces an Estimate Group report.
*
*T21068 lanny 10/05/1996 * Data under FCT TYPE/PID columns coming from
*T21177 diane 11/06/1996 * REV11 UPG
*T25901 cmykleb 03/08/2002 * Change heading to use GET.PROG.HEAD pgm.
*T26493 cmykleb 03/22/2002 * Change report to use rpt # from proc.
****************************************************************
*
*---- FILE EQUATES
*
*COPY>CPYLIB>SYSCOM
*COPY>CPYLIB>CHAR
*COPY>CPYLIB>FILE.VARS
*COPY>PMC.CPYLIB>COMPANY
*COPY>JES.CPYLIB>ESTIMATE.GRP
*COPY>PMC.CPYLIB>DEPARTMENT
*
*---- SETUP FOR SYSTEM ERROR MESSAGES
*
   SYS.TYPE=1
   CALL SI_SYSCOM(MAT SYSCOM.REC)
*
*---- OPEN FILES
*
   OPEN '','COMPANY' TO COMPANY ELSE ERRMSG='COMPANY FILE MISSING';GOTO 93000
   OPEN '','CONTROL' TO CONTROL ELSE ERRMSG='CONTROL FILE MISSING';GOTO 93000
   OPEN '','DEPARTMENT' TO DEPARTMENT ELSE ERRMSG='DEPARTMENT FILE MISSING';GOTO 93000
   OPEN '','ESTIMATE.QP.GRP' TO ESTIMATE.GRP ELSE ERRMSG='ESTIMATE.QP.GRP FILE MISSING';GOTO 93000
*
*---- READ FROM PROC
*
   PROCREAD BUFFER ELSE
      ERRMSG = "CANNOT READ FROM PROC"
      GOTO 93000
   END
*
*---- GET COMPANY NUMBER
*
   CONO=""
   CALL GET.CONO(CONO,MAT COMP.REC)
   IF CONO='END' THEN GOTO 99999
*
*---- INITIALIZATION
*
   PG.NO=0
   LINE.CNT=99
   ERRMSG=""
   UNKNOWN=STR("?",30)
   PREV.DEPT=""
   SP = " "
   NODATA=1
*T25901 v
*  K = SPACE(INT((50 - LEN(CO.NAME)) / 2))
*  CONAME = K:CO.NAME:K
*  CONAME = CONAME "L#50"
*  HEAD1 = OCONV(DATE(),"D2/"):SPACE(33):CONAME:SPACE(32):"PAGE  "
*  HEAD2 = SPACE(44):"O P E R A T I O N   G R O U P   L I S T I N G"
*T26493 v
*  REPORT.NAME = "OPERATION GROUP LISTING"
*  REPORT.NUMBER = "XXXX"
   REPORT.NUMBER = BUFFER<2>
   REPORT.NAME = ""
   CONO.NAME = ""
*T26493 ^
   HEAD1 = "" ; HEAD2 = ""
   CALL GET.PROG.HEAD(CONO,CONO.NAME,REPORT.NAME,REPORT.NUMBER,"",HEAD1,HEAD2)
*T25901 ^
   HEAD3 = "DEPT : "
   HEAD4 = SPACE(98):"<- QTY -> <- FCT -> <QTY> <FCT>"
   HEAD5 = "GROUP           DESCRIPTION           TP CTR O/P/V "
   HEAD6 = "------ ------------------------------ -- --- ------"
   HEAD5 = HEAD5:"  OPERATION / MATERIAL          OSP/SH  STD $ "
   HEAD6 = HEAD6:" ------------------------------ ------ -------"
   HEAD5 = HEAD5:" T PARAM O T PARAM O T PID T PID"
   HEAD6 = HEAD6:" - ----- - - ----- - - --- - ---"
   PRINTER ON
*
*---- MAIN PROCESSING
*
10*
   READNEXT ESTG.KEY ELSE 
      IF NODATA THEN GOTO 99999
      GOTO 15
   END
   MATREAD ESTG.REC FROM ESTIMATE.GRP,ESTG.KEY ELSE GOTO 10
   NODATA=0
   DEPT.NO = FIELD(ESTG.KEY,"!",1)[4,99]
   GRP.NO = FIELD(ESTG.KEY,"!",2)
   IF PREV.DEPT # DEPT.NO THEN
      LINE.CNT = 99
      PREV.DEPT=DEPT.NO
   END
   GOSUB 30
   GOTO 10
15*
   PRINTER OFF
   GOTO 99999
*
*---- PRINT THE HEADINGS
*
20*
   PRINT CHAR(12)
   PG.NO=PG.NO + 1
   MATREAD DEPT.REC FROM DEPARTMENT,CONO:DEPT.NO ELSE DEPT.DESC=UNKNOWN
   PRINT HEAD1:PG.NO
   PRINT HEAD2
   PRINT HEAD3:DEPT.NO:SP:DEPT.DESC
   PRINT HEAD4
   PRINT HEAD5
   PRINT HEAD6
   LINE.CNT = 6
   RETURN
*
*---- PRINT THE VALUES
*
30*
   TYP.CNT = DCOUNT(ESTG.TYPE,VM)
   IF (LINE.CNT+TYP.CNT+1) > 55 THEN GOSUB 20
   GRP.NUM = GRP.NO "L#6"
   DESC = ESTG.DESC "L#30"
   TYPE = ESTG.TYPE<1,1> "L#2"
   CCTR = ESTG.CCTR<1,1> "L#3"
   OPER = ESTG.OPER<1,1> "L#6"
   OPER.DESC = ESTG.OPER.DESC<1,1> "L#30"
   OSP.CODE = ESTG.CAT.SP.CODE<1,1> "L#6"
   OSP.COST = OCONV(ESTG.CAT.SP.COST<1,1>,"MD2") "R#7"
   QCALC = ESTG.OPER.QCALC<1,1> "L#1"
   QPARAM = ESTG.OPER.QPARAM<1,1> "L#5"
   QOR = ESTG.OPER.QOR<1,1> "L#1"
   FCALC = ESTG.OPER.FCALC<1,1> "L#1"
   FPARAM = ESTG.OPER.FPARAM<1,1> "L#5"
   F.OR = ESTG.OPER.FOR<1,1> "L#1"
   QPQT = FIELD(ESTG.QPL.QPARAM<1,1>,"-",1) "L#1"
   QPQM = FIELD(ESTG.QPL.QPARAM<1,1>,"-",2) "L#3"
*T21068    QPFT = FIELD(ESTG.QPL.QPARAM<1,1>,"-",1) "L#1"
   QPFT = FIELD(ESTG.QPL.FPARAM<1,1>,"-",1) "L#1"
*T21068    QPFM = FIELD(ESTG.QPL.QPARAM<1,1>,"-",2) "L#3"
   QPFM = FIELD(ESTG.QPL.FPARAM<1,1>,"-",2) "L#3"
   PLINE = GRP.NUM:SP:DESC:SP:TYPE:SP:CCTR:SP:OPER
   PLINE = PLINE:SP:OPER.DESC:SP:OSP.CODE:SP:OSP.COST
   PLINE = PLINE:SP:QCALC:SP:QPARAM:SP:QOR:SP:FCALC:SP:FPARAM:SP:F.OR
   PLINE = PLINE:SP:QPQT:SP:QPQM:SP:QPFT:SP:QPFM
   PRINT
   PRINT PLINE
   LINE.CNT = LINE.CNT + 2
   FOR QQ = 2 TO TYP.CNT
      IF LINE.CNT > 55 THEN GOSUB 20
      GRP.NUM = "" "L#6"
      DESC = "" "L#30"
      TYPE = ESTG.TYPE<1,QQ> "L#2"
      CCTR = ESTG.CCTR<1,QQ> "L#3"
      OPER = ESTG.OPER<1,QQ> "L#6"
      OPER.DESC = ESTG.OPER.DESC<1,QQ> "L#30"
      OSP.CODE = ESTG.CAT.SP.CODE<1,QQ> "L#6"
      OSP.COST = OCONV(ESTG.CAT.SP.COST<1,QQ>,"MD2") "R#7"
      QCALC = ESTG.OPER.QCALC<1,QQ> "L#1"
      QPARAM = ESTG.OPER.QPARAM<1,QQ> "L#5"
      QOR = ESTG.OPER.QOR<1,QQ> "L#1"
      FCALC = ESTG.OPER.FCALC<1,QQ> "L#1"
      FPARAM = ESTG.OPER.FPARAM<1,QQ> "L#5"
      F.OR = ESTG.OPER.FOR<1,QQ> "L#1"
      QPQT = FIELD(ESTG.QPL.QPARAM<1,QQ>,"-",1) "L#1"
      QPQM = FIELD(ESTG.QPL.QPARAM<1,QQ>,"-",2) "L#3"
*T21068       QPFT = FIELD(ESTG.QPL.QPARAM<1,QQ>,"-",1) "L#1"
      QPFT = FIELD(ESTG.QPL.FPARAM<1,QQ>,"-",1) "L#1"
*T21068       QPFM = FIELD(ESTG.QPL.QPARAM<1,QQ>,"-",2) "L#3"
      QPFM = FIELD(ESTG.QPL.FPARAM<1,QQ>,"-",2) "L#3"
      PLINE = GRP.NUM:SP:DESC:SP:TYPE:SP:CCTR:SP:OPER
      PLINE = PLINE:SP:OPER.DESC:SP:OSP.CODE:SP:OSP.COST
      PLINE = PLINE:SP:QCALC:SP:QPARAM:SP:QOR:SP:FCALC:SP:FPARAM:SP:F.OR
      PLINE = PLINE:SP:QPQT:SP:QPQM:SP:QPFT:SP:QPFM
      PRINT PLINE
      LINE.CNT = LINE.CNT + 1
   NEXT QQ
   RETURN
*
*---- CALLS FOR SYSCOM
*
93000*
   PRINTER OFF
   ERR.TYPE=3
   CALL SI_SYSCOM(MAT SYSCOM.REC)
99999*
END
