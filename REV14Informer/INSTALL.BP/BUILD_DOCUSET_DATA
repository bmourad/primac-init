   SUBROUTINE BUILD_DOCUSET_DATA(RTN_CODE,TKT_ID,DOCUSET_ID)
*COPY>CPYLIB>COM1
*********************************************************************
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* Revision      - [11.B]
* Revision Date - 09/11/98
* System        - PRIMAC
* Library       - JISBP/BUILD_DOCUSET_DATA
* Author        - Ziad Yamout, VERCOM Software, Inc.
*********************************************************************
*
*---- Data Structure Libraries
*
*COPY>JIS.CPYLIB>DOCUSET_SFIS_DATA
*COPY>JIS.CPYLIB>SYS_SCN_DEF
*COPY>JIS.CPYLIB>SYS_TKT_DEF
*COPY>JIS.CPYLIB>SYS_FIELDS
*COPY>CPYLIB>FILE.VARS
*COPY>CPYLIB>SYSCOM
*COPY>CPYLIB>CHAR
*
*
*  SYS.TYPE = 1; CALL SYSCOM(MAT SYSCOM.REC)
   RTN_CODE = 0
*
   OPEN "","DOCUSET_SFIS_DATA" TO DOCUSET_SFIS_DATA ELSE
      RTN_CODE = "Cannot locate the DOCUSET_SFIS_DATA file"
      GOTO 99999
   END
   OPEN "","SYS_TKT_DEF" TO SYS_TKT_DEF ELSE
      RTN_CODE = "Cannot locate the SYS_TKT_DEF file"
      GOTO 99999
   END
   OPEN "","SYS_SCN_DEF" TO SYS_SCN_DEF ELSE
      RTN_CODE = "Cannot locate the SYS_SCN_DEF file"
      GOTO 99999
   END
   OPEN "","SYS_FIELDS" TO SYS_FIELDS ELSE
      RTN_CODE = "Cannot locate the SYS_FIELDS file"
      GOTO 99999
   END
*  OPEN "","DOCUSET_CONTROL" TO DOCUSET_CONTROL ELSE
*     RTN_CODE = "Cannot locate the DOCUSET_CONTROL file"
*     GOTO 99999
*  END
*
*---- Get Passed Parameters
*
   MATREAD STKD.REC FROM SYS_TKT_DEF, DOCUSET_ID ELSE
      RTN_CODE = "Cannot locate Docuset # ":DOCUSET_ID
      GOTO 99999
   END
   READ FLD_NAMES FROM SYS_TKT_DEF, DOCUSET_ID:"*FLD" ELSE
      RTN_CODE = "Cannot locate Docuset # ":DOCUSET_ID
      GOTO 99999
   END
*  TRN_FILENAME = DOCUSET_ID:"_TRN"
   TRN_FILENAME = "JOB_JKT_IMG"
   OPEN "", TRN_FILENAME TO TRN_FILE ELSE
      RTN_CODE = "Cannot locate the ":TRN_FILENAME:" file"
      GOTO 99999
   END
   ITEM = ""
   IF TKT_ID # "" THEN
*     READ LOGIN_NAME FROM TRN_FILE, TKT_ID:"!":DOCUSET_ID ELSE LOGIN_NAME = ""
*     IF LOGIN_NAME # "" THEN
*        READ USER_NAME FROM DOCUSET_CONTROL, TKT_ID THEN
*           IF USER_NAME # LOGIN_NAME THEN
*              RTN_CODE = "Ticket is currently being maintained by ":USER_NAME
*              GOTO 99999
*           END
*        END ELSE
*           WRITE LOGIN_NAME ON DOCUSET_CONTROL, TKT_ID
      CALL CLEAR_DOCUSET_DATA(RTN_CODE,TKT_ID,DOCUSET_ID)
      READ ITEM FROM TRN_FILE, TKT_ID ELSE ITEM = ""
*        END
*     END
   END
*
   FLD_TYPE = ""; FLD_PAGE = ""; FLD_MVNO = ""; FLD_SMVNO = ""; FLD_WIDTH = ""
   FCNT = DCOUNT(STKD_SCN,VM)
   FOR FNO = 1 TO FCNT
      FORM_NAME = STKD_SCN<1,FNO>
      MATREAD SSD.REC FROM SYS_SCN_DEF, FORM_NAME THEN
         VCNT = DCOUNT(SSD_FIELDS,VM)
         FOR VNO = 1 TO VCNT
            LOCATE SSD_FIELDS<1,VNO> IN FLD_NAMES, 1 SETTING FLDNO THEN
               MATREAD DFD.REC FROM SYS_FIELDS, FLD_NAMES<FLDNO> THEN
                  FLD_TYPE<FLDNO> = DFD_TYPE
               END ELSE
                  FLD_TYPE<FLDNO> = ""
               END
               FLD_WIDTH<FLDNO> = FIELD(SSD_FLD_FMT<1,VNO>,'#',2)
               LOCATE FNO IN FLD_PAGE<FLDNO>,1 SETTING PNO ELSE
                  FLD_PAGE<FLDNO,PNO> = FNO
                  FLD_MVNO<FLDNO,PNO> = SSD_FLD_MVNO<1,VNO>
                  FLD_SMVNO<FLDNO,PNO> = SSD_FLD_SMVNO<1,VNO>
               END
            END
         NEXT VNO
      END
   NEXT FNO
*
*---- Build DOCUSET_SFIS_DATA
*
   MAT DSD.REC = ""
   DSD_DOCUSET = DOCUSET_ID
   DSD_SMVNO = 1;* Do not handle Sub Multi Value
   DSD_IDNO = TKT_ID[4,999]
   FLDCNT = DCOUNT(FLD_NAMES,AM)
   FOR FLDNO = 1 TO FLDCNT
      PCNT = DCOUNT(FLD_PAGE<FLDNO>,VM)
      DSD_NAME = FLD_NAMES<FLDNO>
      FOR PNO = 1 TO PCNT
         DSD_PAGE = FLD_PAGE<FLDNO,PNO>
         DSD_FORM = STKD_SCN<1,DSD_PAGE>
         MVNO = FLD_MVNO<FLDNO,PNO>
         SMVNO = FLD_SMVNO<FLDNO,PNO>
*
*----- Temporary logic
*
         IF NOT(NUM(MVNO)) THEN MVNO = 0
         IF NOT(NUM(SMVNO)) THEN SMVNO = 0
*
         BEGIN CASE
         CASE MVNO > 0
            IF SMVNO > 0 THEN
               DSD_MVNO = MVNO
               DSD_SMVNO = SMVNO
               VALUE = ITEM<FLDNO,MVNO,SMVNO>
               VALUE = ITEM<FLDNO,1,1>
               GOSUB 3000
            END ELSE
               MVCNT = DCOUNT(ITEM<FLDNO,MVNO>,SVM)
               IF MVCNT = 0 THEN MVCNT = 1
               FOR DSD_MVNO = 1 TO MVCNT
                  DSD_SMVNO = DSD_MVNO
                  VALUE = ITEM<FLDNO,MVNO,DSD_MVNO>
                  GOSUB 3000
               NEXT DSD_MVNO
            END
         CASE SMVNO > 0
            DSD_SMVNO = SMVNO
            MVCNT = DCOUNT(ITEM<FLDNO>,VM)
            IF MVCNT = 0 THEN MVCNT = 1
            FOR DSD_MVNO = 1 TO MVCNT
               VALUE = ITEM<FLDNO,DSD_MVNO,SMVNO>
               GOSUB 3000
            NEXT DSD_MVNO
         CASE 1
            MVCNT = DCOUNT(ITEM<FLDNO>,VM)
            IF MVCNT = 1 THEN
               MVCNT = DCOUNT(ITEM<FLDNO,1>,SVM)
               IF MVCNT = 0 THEN MVCNT = 1
               FOR DSD_MVNO = 1 TO MVCNT
                  DSD_SMVNO = DSD_MVNO
                  VALUE = ITEM<FLDNO,1,DSD_MVNO>
                  GOSUB 3000
               NEXT DSD_MVNO
            END ELSE
               IF MVCNT = 0 THEN MVCNT = 1
               DSD_SMVNO = 1
               FOR DSD_MVNO = 1 TO MVCNT
                  VALUE = ITEM<FLDNO,DSD_MVNO,1>
                  GOSUB 3000
               NEXT DSD_MVNO
            END
         END CASE
      NEXT PNO
   NEXT FLDNO
   GOTO 99999
*
*
*---- Update DOCUSET_SFIS_DATA
3000*
   DSD_STRING = ""
   DSD_INTEGER = ""
   DSD_LONG = ""
   DSD_DECIMAL = ""
   DSD_DATE = ""
   DSD_TIME = ""
   DSD_BOOLEAN = ""
   BEGIN CASE
   CASE FLD_TYPE<FLDNO> = "A"
      DSD_STRING = VALUE
   CASE FLD_TYPE<FLDNO> = "N"
      IF NOT(NUM(VALUE)) THEN VALUE = 0
      IF FLD_WIDTH<FLDNO> < 4 THEN
         DSD_INTEGER = VALUE + 0
      END ELSE
         DSD_LONG = VALUE + 0
      END
   CASE FLD_TYPE<FLDNO> = "D"
      IF NOT(NUM(ICONV(VALUE,"D2/"))) THEN VALUE = 0
      DSD_DATE = VALUE
   CASE FLD_TYPE<FLDNO> = "C"
      IF NOT(NUM(VALUE)) THEN VALUE = 0
      DSD_DECIMAL = VALUE + 0
   CASE FLD_TYPE<FLDNO> = "L"
      BEGIN CASE
      CASE VALUE = "1" OR VALUE = "Y"
         DSD_BOOLEAN = 1
      CASE VALUE = "N" OR VALUE = "0"
         DSD_BOOLEAN = 0
      CASE 1
         DSD_BOOLEAN = 0
      END CASE
   CASE 1
      DSD_STRING = VALUE
   END CASE
   DSD_ID = TKT_ID:"x":DSD_PAGE "R%2":FLDNO "R%3":DSD_MVNO "R%3"
   MATWRITE DSD.REC ON DOCUSET_SFIS_DATA, DSD_ID
3099*
   RETURN
*
*---- END OF PROGRAM
*
99999*
END
