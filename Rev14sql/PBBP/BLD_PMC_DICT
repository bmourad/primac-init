*COPY>JIS.CPYLIB>SYS_FILES
*COPY>JIS.CPYLIB>SYS_FIELDS
*COPY>CPYLIB>CHAR
*
      DIM FVARS(300)
      DIM DREC(100)
      DIM OLD_DREC(100)
      DIM SAVE_DFD.REC(DFD.REC.SIZE)
*
      PROCREAD BUFFER ELSE
         GOTO 99999
      END
      IF BUFFER<1> # "BDICT" THEN
         GOTO 99999
      END
      PROMPT ""
      BUFFER = DELETE(BUFFER,1,0,0)
      OPEN "","SYS_FILES" TO SYS_FILES ELSE
         ERRMSG = "Cannot locate the SYS_FILES file"
         GOTO 93000
      END
      OPEN "","SYS_FIELDS" TO SYS_FIELDS ELSE
         ERRMSG = "Cannot locate the SYS_FIELDS file"
         GOTO 93000
      END
      LOCATE "OVERWRITE" IN BUFFER,1 SETTING LOC THEN
         UPD_FLG = 1
         BUFFER = DELETE(BUFFER,LOC,0,0)
      END ELSE
         UPD_FLG = 0
      END
      LOCATE "CLEARING" IN BUFFER,1 SETTING LOC THEN
         CLR_FLG = 1
         BUFFER = DELETE(BUFFER,LOC,0,0)
      END ELSE
         CLR_FLG = 0
      END
      LOCATE "PROMPT" IN BUFFER,1 SETTING LOC THEN
         PROMPT_FLG = 1
         DISPLAY_FLG = 1
         BUFFER = DELETE(BUFFER,LOC,0,0)
      END ELSE
         PROMPT_FLG = 0
         LOCATE "DISPLAY" IN BUFFER,1 SETTING LOC THEN
            DISPLAY_FLG = 1
            BUFFER = DELETE(BUFFER,LOC,0,0)
         END ELSE
            DISPLAY_FLG = 0
         END
      END
      LOCATE "TESTING" IN BUFFER,1 SETTING LOC THEN
         WRITE_FLG = 0
         BUFFER = DELETE(BUFFER,LOC,0,0)
      END ELSE
         WRITE_FLG = 1
      END
      MATCH_FNAME = BUFFER<1>
*
      FNAME = ""
      BAD_FNAME = ""
      CO_FLG = ""
      SPC = SPACE(1)
      SLOC = 0
      MAT OLD_DREC = ""
*
      DATA = 1
      READNEXT FLD_ID THEN
         GOSUB 1000
      END ELSE
         SELECT SYS_FIELDS
         READNEXT FLD_ID ELSE GOTO 99999
         GOSUB 1000
      END
      LOOP
         READNEXT FLD_ID ELSE DATA = 0
      WHILE DATA DO
         GOSUB 1000
      REPEAT
      GOTO 99999
*
1000*
      IF DISPLAY_FLG THEN
         CRT DATA "L#7":FLD_ID
         DATA = DATA + 1
      END
      MATREAD DFD.REC FROM SYS_FIELDS, FLD_ID ELSE
         ERRMSG = "Cannot locate SYS_FIELDS, ":FLD_ID
         GOSUB 91000; GOTO 1099
      END
      IF MATCH_FNAME # "" AND MATCH_FNAME # DFD_TABLE THEN
         GOTO 1099
      END
      LOCATE DFD_TABLE IN FNAME,1 SETTING FLOC ELSE
         LOCATE DFD_TABLE IN BAD_FNAME,1 SETTING BAD_FLOC THEN
            GOTO 1099
         END
         OPEN "DICT", DFD_TABLE TO FVARS(FLOC) THEN
            FNAME<FLOC> = DFD_TABLE
         END ELSE
            BAD_FNAME<BAD_FLOC> = DFD_TABLE
            ERRMSG = "Cannot locate table - ":DFD_TABLE
            GOSUB 91000; GOTO 1099
         END
         MATREAD SFR.REC FROM SYS_FILES, DFD_TABLE ELSE
            BAD_FNAME<BAD_FLOC> = DFD_TABLE
            ERRMSG = "Cannot locate SYS_FILES table - ":DFD_TABLE
            GOSUB 91000; GOTO 1099
         END
         IF CLR_FLG AND WRITE_FLG THEN
            CLEARFILE FVARS(FLOC)
         END
         SAVE_FLD_ID = FLD_ID
         LOCATE "CO" IN SFR.ID<1>,1 SETTING CLOC THEN
            IF SFR.ID.TYPE<1,CLOC> = "D" THEN
               CO_FLG<FLOC> = 1
               FLD_ID = "CONO"
               SLOC = SLOC + 1
               READU OLD_DREC(SLOC) FROM FVARS(FLOC), FLD_ID THEN
                  IF UPD_FLG THEN
                     UPDREC = 1
                  END ELSE
                     UPDREC = 0
                  END
               END ELSE
                  UPDREC = 1
               END
               IF UPDREC THEN
                  DREC(SLOC) = "I"
                  DREC(SLOC)<2> = SFR.PFX:"_ID[1,3]"
                  DREC(SLOC)<4> = FLD_ID
                  DREC(SLOC)<5> = "3L"
                  DREC(SLOC)<6> = "S"
                  GOSUB 1700
               END ELSE
                  RELEASE FVARS(FLOC), FLD_ID
                  SLOC = SLOC - 1
               END
            END
         END
         FLD_ID = SFR.PFX:"_ID"
         SLOC = SLOC + 1
         READU OLD_DREC(SLOC) FROM FVARS(FLOC), FLD_ID THEN
            IF UPD_FLG THEN
               UPDREC = 1
            END ELSE
               UPDREC = 0
            END
         END ELSE
            UPDREC = 1
         END
         IF UPDREC THEN
            MAT SAVE_DFD.REC = MAT DFD.REC
            MATREAD DFD.REC FROM SYS_FIELDS, SFR.PFX ELSE
               MAT DFD.REC = ""
               DFD_LEN = 10; DFD_JUSTIFY = "L"
            END
            DREC(SLOC) = "D"
            DREC(SLOC)<2> = 0
            DREC(SLOC)<4> = FLD_ID
            IF CO_FLG<FLOC> THEN
               DREC(SLOC)<5> = (DFD_LEN+3):DFD_JUSTIFY
            END ELSE
               DREC(SLOC)<5> = DFD_LEN:DFD_JUSTIFY
            END
            DREC(SLOC)<6> = "S"
            MAT DFD.REC = MAT SAVE_DFD.REC
            GOSUB 1700
         END ELSE
            RELEASE FVARS(FLOC), FLD_ID
            SLOC = SLOC - 1
         END
         FLD_ID = SAVE_FLD_ID
      END
1010*
      SLOC = SLOC + 1
      FLD_PFX = FIELD(FLD_ID,"_",1)
      IF FLD_PFX = FLD_ID THEN
         GOTO 1090
      END
      READU OLD_DREC(SLOC) FROM FVARS(FLOC), FLD_ID THEN
         IF NOT(UPD_FLG) THEN
            GOTO 1090
         END
      END ELSE
         OLD_DREC(SLOC) = ""
      END
      DREC(SLOC) = "D"
      DREC(SLOC)<2> = DFD_ATTNO
      BEGIN CASE
      CASE DFD_TYPE = "D"
         DREC(SLOC)<3> = "D2/"
      CASE DFD_TYPE = "C"
         DREC(SLOC)<3> = "MD":DFD_DEC
      CASE DFD_TYPE = "N"
         BEGIN CASE
         CASE DFD_LNK # ""
         CASE 1
            DREC(SLOC)<3> = "MD0"
         END CASE
      END CASE
      DREC(SLOC)<4> = FLD_ID
      DREC(SLOC)<5> = DFD_LEN:DFD_JUSTIFY
      BEGIN CASE
      CASE DFD_LVL = "S"
         DREC(SLOC)<6> = "S"
      CASE DFD_M_LNK = ""
         ERRMSG = "No master MV link for DICT (":DFD_TABLE:",":FLD_ID:")"
         GOSUB 91000; GOTO 1090
      CASE DFD_LVL = "M"
         FLD_M_LNK = FLD_PFX : "_" : DFD_M_LNK
         FLD_LNK_ID = FLD_M_LNK:"_MV"
         FLD_CNTR_ID = FLD_M_LNK:"_MC"
         IF FLD_M_LNK = FLD_ID THEN
            READU CNTR_ITEM FROM FVARS(FLOC), FLD_CNTR_ID THEN
               RELEASE FVARS(FLOC), FLD_CNTR_ID
            END ELSE
               CNTR_ITEM = "I"
               CNTR_ITEM<2> = FLD_M_LNK:";@NV"
               CNTR_ITEM<3> = "MD0"
               CNTR_ITEM<4> = FLD_CNTR_ID
               CNTR_ITEM<5> = "4R"
               CNTR_ITEM<6> = "MV"
               CNTR_ITEM<7> = FLD_LNK_ID
CRT "Counter = ":FLD_CNTR_ID
               IF WRITE_FLG THEN
                  WRITE CNTR_ITEM ON FVARS(FLOC), FLD_CNTR_ID
               END ELSE
                  RELEASE FVARS(FLOC), FLD_CNTR_ID
               END
            END
            READU LNK_ITEM FROM FVARS(FLOC), FLD_LNK_ID THEN
               RELEASE FVARS(FLOC), FLD_LNK_ID
            END ELSE
               LNK_ITEM = "PH"
               LNK_ITEM<2> = FLD_CNTR_ID:" ":FLD_M_LNK
               CNT = DCOUNT(DFD_M_ASOC,VM)
               MAT SAVE_DFD.REC = MAT DFD.REC
               M_LNK = DFD_M_LNK; M_ASOC = DFD_M_ASOC
               FOR I = 1 TO CNT
                  M_ASOC_ID = FLD_PFX:"_":M_ASOC<1,I>
                  MATREAD DFD.REC FROM SYS_FIELDS, M_ASOC_ID THEN
                     IF DFD_LVL = "M" AND DFD_M_LNK = M_LNK THEN
                        LNK_ITEM<2> = LNK_ITEM<2>:SPC:M_ASOC_ID
                     END
                  END
               NEXT I
               MAT DFD.REC = MAT SAVE_DFD.REC
CRT "MK Link = ":FLD_LNK_ID
               IF WRITE_FLG THEN
                  WRITE LNK_ITEM ON FVARS(FLOC), FLD_LNK_ID
               END ELSE
                  RELEASE FVARS(FLOC), FLD_LNK_ID
               END
            END
            DREC(SLOC)<7> = FLD_LNK_ID
         END ELSE
            MAT SAVE_DFD.REC = MAT DFD.REC
            M_LNK = DFD_M_LNK
            MATREAD DFD.REC FROM SYS_FIELDS, FLD_M_LNK THEN
               IF DFD_LVL = "M" AND DFD_M_LNK = M_LNK THEN
                  M_ID = FIELD(FLD_ID,"_",2,99)
                  LOCATE M_ID IN DFD_M_ASOC<1>,1 SETTING LOC THEN
                     DREC(SLOC)<7> = FLD_LNK_ID
                  END
               END
            END
            MAT DFD.REC = MAT SAVE_DFD.REC
         END
         DREC(SLOC)<6> = "MV"
      CASE DFD_V_LNK = ""
         ERRMSG = "No master Sub MV link for DICT (":DFD_TABLE:",":FLD_ID:")"
         GOSUB 91000; GOTO 1090
      CASE DFD_LVL = "V"
* No SQL procedure yet for SMV
* Update after developing the VIEW procedure
GOTO 1090
         DREC(SLOC)<6> = "MS"
      CASE 1
         ERRMSG = "Unknown level for DICT (":DFD_TABLE:",":FLD_ID:")"
         GOSUB 91000; GOTO 1090
      END CASE
      GOSUB 1700
      IF DFD_LNK # "" THEN
*        GOSUB 2000
      END
      GOTO 1099
1090*
      SLOC = SLOC - 1
      RELEASE FVARS(FLOC), FLD_ID
1099*
      RETURN
1700*
      IF DISPLAY_FLG THEN
         CRT SLOC "L#7":FLD_ID
         FOR I = 1 TO 9
            CRT DREC(SLOC)<I> "L#30" : " <> " : OLD_DREC(SLOC)<I>
         NEXT I
         IF PROMPT_FLG THEN
            INPUT REPLY
            BEGIN CASE
            CASE REPLY = "N"
               PROMPT_FLG = 0
            CASE REPLY = "Q" OR REPLY = "QUIT" OR REPLY = "END"
               PROMPT_FLG = 0; DISPLAY_FLG = 0
            END CASE
         END
      END
      IF WRITE_FLG THEN
         WRITE DREC(SLOC) ON FVARS(FLOC), FLD_ID
      END ELSE
         RELEASE FVARS(FLOC), FLD_ID
      END
      SLOC = SLOC - 1
      RETURN
2000*
      LNK_ID = DFD_LNK
      LNK_PFX = FIELD(LNK_ID,"_",1)
      IF LNK_PFX # LNK_ID THEN
         GOTO 2099
      END
      LNK_ID = LNK_ID:"_ID"
      SLOC = SLOC + 1
      READU OLD_DREC(SLOC) FROM FVARS(FLOC), LNK_ID THEN
*        RELEASE FVARS(FLOC), LNK_ID
*        GOTO 2090
      END
      DREC(SLOC)<4> = LNK_ID
      IF CO_FLG<FLOC> THEN
         DREC(SLOC)<1> = "I"
         BEGIN CASE
         CASE DFD_LVL = "S"
            FLD_EXP = "IF ":FLD_ID:" THEN CONO:":FLD_ID:' ELSE ""'
         CASE DFD_LVL = "M"
            FLD_EXP = 'SUBR("-CATS",REUSE(CONO),':FLD_ID:')'
         CASE DFD_LVL = "V"
            FLD_EXP = 'SUBR("-CATS",REUSE(CONO),':FLD_ID:')'
         CASE 1
            FLD_EXP = "IF ":FLD_ID:" THEN CONO:":FLD_ID:' ELSE ""'
         END CASE
         DREC(SLOC)<2> = FLD_EXP
         DREC(SLOC)<5> = (DFD_LEN+3):DFD_JUSTIFY
CRT "Link ID - ":LNK_ID
FOR I = 1 TO 9
CRT DREC(SLOC)<I>
NEXT I
INPUT XOXO
      END
      GOSUB 1700
      GOTO 2099
2090*
      SLOC = SLOC - 1
2099*
      RETURN
*
91000*
      CRT @(0,23):ERRMSG:CL:
      INPUT REPLY:
      CRT @(0,23):CL:
      RETURN
93000*
      CRT @(0,23):ERRMSG:CL:
      INPUT REPLY:
99999*
      END
