SUBROUTINE PHYIM_VALD_REVISED_DIAM
********************************************************************************
*   Program name :- PHYIM_VALD_REVISED_DIAM
*   Created:- 12/3/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
* CONO, TEMP.DIA, PROD.NUM, TEMP.ONHAND, PHYSI.SERIAL, TEMP.CURR.QTY
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB PHY.INV
$INCLUDE ICS.CPYLIB INV.CNV
$INCLUDE ICS.CPYLIB INV_SERIAL
$INCLUDE ICS.CPYLIB CATEGORY
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE ICS.CPYLIB INV_RECP_WHSE
$INCLUDE ICS.CPYLIB INV_RECEIPTS
* Insert method code here
ERRMSG = ""
ALERTMSG = ""

OPEN "","INVENTORY" TO INVENTORY ELSE
	ERRMSG = "INVENTORY FILE IS MISSING"
      	GOTO 99999
END
OPEN "","CATEGORY" TO CATEGORY ELSE
      ERRMSG = "CATEGORY FILE IS MISSING"
      GOTO 99999
END
OPEN "","INV.WHSE" TO INV.WHSE ELSE
      ERRMSG = "INV.WHSE FILE IS MISSING"
      GOTO 99999
END
OPEN "","INV_RECP_WHSE" TO INV_RECP_WHSE ELSE
      ERRMSG = "INV_RECP_WHSE FILE IS MISSING"
      GOTO 99999
END
OPEN "","INV_RECEIPTS" TO INV_RECEIPTS ELSE
      ERRMSG = "INV_RECEIPTS FILE IS MISSING"
      GOTO 99999
END

OPEN "","PHY.INV" TO PHY.INV ELSE
	ERRMSG = "PHY.INV FILE IS MISSING"
      	GOTO 99999
END

OPEN "","INV_SERIAL" TO INV_SERIAL ELSE
	ERRMSG = "INV_SERIAL FILE IS MISSING"
      	GOTO 99999
END

DEFFUN CALC.STK.QTY(COST.QTY,MAT INV.CNV.REC,ROND,LN)
DEFFUN CALC.COST.QTY(STK.QTY,MAT INV.CNV.REC,ROND,LN)

ERRMSG = RBO.getProperty('','ID',ID)
ERRMSG = RBO.getProperty('','PHYSI_TEMP_INPUT',PHYSI_TEMP_INPUT)

CONO = ID[1,3]
PROD.NUM = PHYSI_TEMP_INPUT<1,2>

MATREAD PHYSI.REC FROM PHY.INV,ID ELSE
	ERRMSG = "CAN'T LOCATE RECORD"
	GOTO 99999
END

MATREAD INV.REC FROM INVENTORY,CONO:PROD.NUM ELSE
	ERRMSG = "CAN'T LOCATE RECORD" 
	GOTO 99999
END

$INCLUDE ICSBP INV.UM.CNV

EQU INV.UOM.STK TO INV.UNIT<1,2>
EQU INV.UOM.CST TO INV.UNIT<1,3>

MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE ELSE
	MAT CATG.REC = ''
END

TEMP.DIA = PHYSI_TEMP_INPUT<1,1>;* CURR. REVISED DIAMETER
SERIAL.NO = PHYSI_TEMP_INPUT<1,3>
TEMP.ONHAND = PHYSI_TEMP_INPUT<1,4> ;* REVISED QTY
TEMP.CURR.QTY = PHYSI_TEMP_INPUT<1,5> ;* PREVIOUS REVISED QTY
PHYSI.CURR.DIA = PHYSI_TEMP_INPUT<1,8>
LN = PHYSI_TEMP_INPUT<1,6>
REC_SER_FLG = PHYSI_TEMP_INPUT<1,7>

IF REC_SER_FLG = "R" THEN 
	TEMP.RECEIPT = SERIAL.NO
END ELSE 
	TEMP.RECEIPT = ""
END


IF TEMP.CURR.QTY < 0 THEN ROND="-.5" ELSE ROND=".5"
TEMP.CURR.QTY = CALC.STK.QTY(PHYSI.CURR.QTY,MAT INV.CNV.REC,ROND,'')

ALERTMSG=""
ERRMSG = ""
TEMP.DIA = TEMP.DIA * 100
IF (TEMP.ONHAND + 0) = 0 THEN
*T25936 ^
	BEGIN CASE
       	CASE INV.PAP.TYPE = "ROLL"
              	TEMP.ONHAND = (((TEMP.DIA/100*TEMP.DIA/100)-(INV.CORE.DIA/100*INV.CORE.DIA/100))*100)
                  	TEMP.ONHAND = INT((TEMP.ONHAND/100)*(INV.PAP.WIDTH/10000)*(INV.FACTOR/10000)/10*100+0.5)
            	CASE INV.PAP.TYPE = "LROLL" OR INV.PAP.TYPE = "PCOAT"
              	TEMP.ONHAND = (((TEMP.DIA/100*TEMP.DIA/100)-(INV.CORE.DIA/100*INV.CORE.DIA/100))*100)
                  	BEGIN CASE
                     	CASE INV.UOM.STK = "FT"
                        		TEMP.ONHAND = INT((TEMP.ONHAND/100)*3.1416/4*(100000/INV.FACTOR)/12+0.5)
                     	CASE INV.UOM.STK = "PC"
                        		TEMP.ONHAND = INT((TEMP.ONHAND/100)*3.1416/4*(100000/INV.FACTOR)/10+0.5)
                  	END CASE
	END CASE
       IF TEMP.ONHAND < 0 THEN TEMP.ONHAND = 0
*C40414 v
      	ISTK.ID = CONO:SERIAL.NO
	MATREAD ISTK.REC FROM INV_SERIAL,ISTK.ID ELSE MAT ISTK.REC=''
       TMP = CALC.COST.QTY(TEMP.ONHAND,MAT INV.CNV.REC,'.5','')
       IF TMP < (ISTK.CUR.QTY-ISTK.RSVB.QTY) THEN
       	ALERTMSG = 'Cannot adjust serial below reserved qty. '
              ALERTMSG := CALC.STK.QTY(ISTK.RSVB.QTY,MAT INV.CNV.REC,'.5','')
              TEMP.ONHAND = TEMP.CURR.QTY
              TEMP.DIA = PHYSI.CURR.DIA
              OLD.START = 0
	END
*C40414 ^
END

VAL = RBO.setProperty('','PHYSI_CURR_QTY',OCONV(TEMP.ONHAND,ICR.CNV)) ;* This is Revised Qty
VAL = RBO.setProperty('','PHYSI_CURR_DIA',OCONV(TEMP.DIA,'MD2')) ;* Revised Diameter

IF ALERTMSG <> "" THEN
	VAL = RBO.setProperty('','PHYSI_TEMP_OUTPUT','A')
	VAL = RBO.setProperty('','PHYSI_TEMP_RECEIPT',ALERTMSG)
END

99999
IF ERRMSG <> "" THEN
	VAL = RBO.setProperty('','ServerStatus','1')
	VAL = RBO.setProperty('','ServerMessage',ERRMSG)
END
RETURN

