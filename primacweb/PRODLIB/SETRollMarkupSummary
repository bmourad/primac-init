SUBROUTINE SETRollMarkupSummary
********************************************************************************
*   Program name :- SETRollMarkupSummary

*   Created:- 9/16/2003

*   AUTHOR :- B.krishna
*
*  
********************************************************************************
*
*---- FILE COPY STATEMENTS
*
   $INCLUDE JES.CPYLIB SCOMMON.ESTIMATE
   $INCLUDE WWINSERT RBO.H
   $DEFINE  ESTIMATETEMP
   $INCLUDE JES.CPYLIB ESTIMATE.TEMP
   $INCLUDE JES.CPYLIB ESTIMATE.PAPER.GROUP
   $DEFINE EQUIPMENT
   $INCLUDE JES.CPYLIB EQUIPMENT
   $DEFINE JESFILEVARS
   $INCLUDE JES.CPYLIB JES.FILE.VARS
   $DEFINE FILEVARS
   $INCLUDE CPYLIB FILE.VARS
   $DEFINE ESTIMATE
   $INCLUDE JES.CPYLIB ESTIMATE
   $DEFINE ESTIMATEDEPT
   $INCLUDE JES.CPYLIB ESTIMATE.DEPT
   $INCLUDE JES.CPYLIB EST.COST.TYPE.SUM
   $INCLUDE CPYLIB CHAR


  STATUS = RBO.getProperty('','ID',ESTIMATE.ID)
  STATUS = RBO.getProperty('','PRICE_M',PRICE_M)
  STATUS = RBO.getProperty('','QTYNO',QPTR)
 STATUS = RBO.getProperty('','TOTAL_SALE',TOTALSALE)


*
*---- OPEN ALL FILES
*
   IN_PARAM = "" ; OUT_PARAM = ""
   ERRMSG = "CALL openEstimateFiles PROBLEM"
   CALL openEstimateFiles(ERRMSG,IN_PARAM,OUT_PARAM,MAT FILE.VARS, MAT JES.FILE.VARS)
   IF ERRMSG # "" THEN GOTO 93000

   CONO = ESTIMATE.ID[1,3]
   EST.ID = TRIM(ESTIMATE.ID[4,99])

   MATREAD EST.REC FROM ESTIMATE,ESTIMATE.ID ELSE
      ERRMSG = 'Estimate not on file. Try again!'
      GOTO 93000
   END
* COPYING THE FINAL PRICE TO TOTAL_SALE VARIABLE BASED ON QTY INDEX
*  TOTAL_SALE = EST.FINAL.PRICE<1,QPTR>
   TOTAL_SALE = TOTALSALE 
  PRICE_M = PRICE_M

   BEGIN CASE
      CASE MOD(QPTR + 3,"3") = 1
         EST_FINAL_PRICE = INT(PRICE_M * EST.QTY<1,QPTR> / 1000)
       IF TOTAL_SALE+0 # 0 THEN
         EST_OM_PCT = INT((((EST_FINAL_PRICE*100) - TOTAL_SALE) / TOTAL_SALE) * 1000000 + .5)
         END ELSE
            EST_OM_PCT = 0
         END

*STATUS = RBO.setProperty('','OpMarkupSum',"PRICE_M->" : PRICE_M : VM : " EST_OM_PCT-->" : EST_OM_PCT : VM : "EST_FINAL_PRICE-->": EST_FINAL_PRICE :  VM : "TOTAL_SALE-->" :TOTAL_SALE)

         MARKPSTR = EST_OM_PCT
         FINALPRICE = EST_FINAL_PRICE
         GOSUB 20400
      CASE MOD(QPTR + 3,"3") = 2
        EST_FINAL_PRICE = PRICE_M * EST.QTY<1,QPTR> / 1000
	 IF TOTAL_SALE+0 # 0 THEN
            EST_OM_PCT = INT((((EST_FINAL_PRICE*100) - TOTAL_SALE) / TOTAL_SALE) * 1000000 + .5)
         END ELSE
            EST_OM_PCT = 0
         END
	    MARKPSTR = EST_OM_PCT
	    FINALPRICE = EST_FINAL_PRICE
           GOSUB 20400
      CASE MOD(QPTR + 3,"3") = 0
         EST_FINAL_PRICE = PRICE_M * EST.QTY<1,QPTR> / 1000
         IF TOTAL_SALE+0 # 0 THEN
            EST_OM_PCT = INT((((EST_FINAL_PRICE*100) - TOTAL_SALE) / TOTAL_SALE) * 1000000 + .5)
         END ELSE
            EST_OM_PCT = 0
         END
	    MARKPSTR = EST_OM_PCT
	    FINALPRICE = EST_FINAL_PRICE
           GOSUB 20400
   END CASE

***** *---- Calculate Additional Price per Thousand

20400 *
 TOTAL.VSALE=""
   TOTAL.VCOST=""
   DC=COUNT(EST.DEPT.COMP,VM)+(EST.DEPT.COMP#"")

   FOR DP=1 TO DC
      ESTD.ID=EST.DEPT.COMP<1,DP>
      QTY=FIELD(ESTD.ID,"!",3)
      LOCATE QTY IN EST.QTY<1>,1 SETTING P ELSE P=0
      IF P > 0 THEN
         TOTAL.VSALE<1,P>=TOTAL.VSALE<1,P>+EST.DEPT.COMP.VSALE<1,DP>
         TOTAL.VCOST<1,P>=TOTAL.VCOST<1,P>+EST.DEPT.COMP.VCOST<1,DP>
      END
   NEXT DP
   EST.COST.THOU<1,QPTR> = ''
   EST.PRICE.THOU<1,QPTR> = ''
   EP = QPTR
   PRICE.THOU.MKUP = TOTAL.VSALE<1,EP> + (INT(OCONV(TOTAL.VSALE<1,EP>,'MD2') * OCONV(EST_OM_PCT,'MD4') + .005 / 100))
   EST.PRICE.THOU=INT(PRICE.THOU.MKUP/(EST.QTY<1,EP>/1000)+0.5)
   EST.COST.THOU=INT(TOTAL.VCOST<1,EP>/(EST.QTY<1,EP>/1000)+0.5)

STATUS = RBO.setProperty('','OpMarkupSum',MARKPSTR : VM : FINALPRICE : VM : EST.PRICE.THOU)

RETURN


93000 *
   STATUS = RBO.setProperty('','ServerStatus',1)
   STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
   RETURN



