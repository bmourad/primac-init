SUBROUTINE JCSME_CHK_CRD_NEW
********************************************************************************
*   Program name :- JCSME_CHK_CRD_NEW
*   Created:- 8/7/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JCS.CPYLIB JOB
$INCLUDE PMC.CPYLIB COUNTRY.CODE
$INCLUDE PMC.CPYLIB CUSTOMER
$INCLUDE PMC.CPYLIB TAX
$INCLUDE PMC.CPYLIB TERMS

OPEN "","JOB" TO JOB ELSE ERRMSG="JOB FILE IS MISSING"; GOTO 99999
OPEN "","COUNTRY.CODE" TO COUNTRY.CODE ELSE ERRMSG="COUNTRY.CODE FILE IS MISSING"; GOTO 99999
OPEN "","CUSTOMER" TO CUSTOMER ELSE ERRMSG="CUSTOMER FILE IS MISSING"; GOTO 99999
OPEN "","TERMS" TO TERMS ELSE ERRMSG="TERMS FILE IS MISSING"; GOTO 99999

DIM SAVE.CUST(75)
CUST.ACCT = ''
IVC.PROC.DATE = ''
IVC.PRT.DATE = ''
UNKNOWN = ""
MAT CUST.REC = ""
MAT SAVE.CUST = ""
IVC.DATE= ''
IVC.PO.NO = ''
IVC.JOB.NO = ''
JOB.NO = ''

STATUS=RBO.getProperty('','PMCProperty',PMCProperty)
CONO = PMCProperty<1,4>
*STATUS = RBO.getProperty('','CRD_NO',CRD.NO)
STATUS = RBO.getProperty('','JOB_NO',JOB.NO)

MATREAD JOB.REC FROM JOB, CONO:JOB.NO ELSE
    ERRMSG = "Cannot locate Job record - ":JOB.NO
    GOTO 99999
END

* Insert method code here
  IVC.JOB.NO = JOB.NO
  IVC.DATE = DATE()
  IF CUST.ACCT = "" THEN
    IVC.CUST.NO = JOB.CUST
    MATREAD CUST.REC FROM CUSTOMER, CONO:JOB.CUST ELSE
      CUST.NAME = UNKNOWN
      CUST.ACCT = ''
    END
  END ELSE
    MAT SAVE.CUST = MAT CUST.REC
    MAST.CUST = CUST.ACCT
    MATREAD CUST.REC FROM CUSTOMER, CONO:MAST.CUST ELSE
      MAT CUST.REC = MAT SAVE.CUST
      IVC.CUST.NO = JOB.CUST
      GOTO 1100
    END
    IVC.CUST.NO = MAST.CUST
  END

1100*
  IVC.CUST.NAME = CUST.NAME
  IVC.ADDR1 = CUST.ADDR1

  IVC.ADDR2 = CUST.ADDR2
  IVC.ADDR3 = CUST.ADDR3
  IVC.TERMS = JOB.TERMS
  IF IVC.TERMS = "" THEN IVC.TERMS = CUST.TERMS
  SHIP.TO.CNTY = CUST.ADDL.OPS<1,4>
  MATREAD CTY.REC FROM COUNTRY.CODE, CONO:SHIP.TO.CNTY ELSE MAT CTY.REC = ''
  SHIP.TO.CNTY = CTY.DESC
  IVC.ADDR4 = CUST.ADDR4:"  ":CUST.ZIP:"  ":SHIP.TO.CNTY
  IVC.ATTENTION = CUST.ATTENTION


*PURCHASE ORDER NO
IF IVC.PO.NO = "" THEN IVC.PO.NO = JOB.CUST.PO
IVC_PO_NO=IVC.PO.NO

* MEMO STATUS AND STATUS DATE
IF IVC.PROC.DATE="" THEN
      IF IVC.PRT.DATE # "" THEN
         IVC.MEMO.STATUS1="PRINTED"
         IVC.STATUS.DATE1=IVC.PRT.DATE
      END
END ELSE
      IVC.MEMO.STATUS1="PROCESSED"
      IVC.STATUS.DATE1=IVC.PROC.DATE
END

* Term Code,Term Description, Term DUE DATE
MATREAD TERMS.REC FROM TERMS,CONO:IVC.TERMS ELSE
      MAT TERMS.REC = ""
END

IVC_TERMS = IVC.TERMS
IVC_TERMS_DESC = TERMS.DESC
IVC.DUE.DATE = IVC.DATE + TERMS.DUE.DAYS
IVC_DUE_DATE=IVC.DUE.DATE

STATUS =  RBO.setProperty('','BILL_TO',IVC.CUST.NO)
STATUS = RBO.setProperty('','IVC_NO',IVC.NO)
STATUS = RBO.setProperty('','IVC_CUST_NAME',IVC.CUST.NAME)
STATUS = RBO.setProperty('','IVC_ADDR1',IVC.ADDR1)
STATUS = RBO.setProperty('','IVC_ADDR2',IVC.ADDR2)
STATUS = RBO.setProperty('','IVC_ADDR3',IVC.ADDR3)
STATUS = RBO.setProperty('','IVC_ADDR4',IVC.ADDR4)

STATUS = RBO.setProperty('','IVC_TERMS',IVC.TERMS)
STATUS = RBO.setProperty('','IVC_TERMS_DESC',IVC_TERMS_DESC)
STATUS = RBO.setProperty('','SHIP_TO_CNTY',SHIP.TO.CNTY)
STATUS = RBO.setProperty('','IVC_ATTENTION',IVC.ATTENTION)
STATUS = RBO.setProperty('','IVC_PO_NO',IVC.PO.NO)
STATUS = RBO.setProperty('','IVC_DATE',OCONV(IVC.DATE,"D2/"))
STATUS = RBO.setProperty('','IVC_MEMO_STATUS1',IVC.MEMO.STATUS1)
STATUS = RBO.setProperty('','IVC_STATUS_DATE1',IVC.STATUS.DATE1)
STATUS = RBO.setProperty('','IVC_DUE_DATE',OCONV(IVC_DUE_DATE,"D2/"))
RETURN


99999*
STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN

