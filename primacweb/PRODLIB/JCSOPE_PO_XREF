SUBROUTINE JCSOPE_PO_XREF
********************************************************************************
*   Program name :- 
*   Created:- 11/10/2004
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE POS.CPYLIB OUTSIDE.PO
$INCLUDE CPYLIB FILE.VARS
$INCLUDE CPYLIB EDIT.COM
$INCLUDE CPYLIB EDIT.COM.DRIVER
$INCLUDE CPYLIB CHAR
$INCLUDE CPYLIB SYSCOM
$INCLUDE JCS.CPYLIB JOB.STATS
$INCLUDE JCS.CPYLIB JOB
$INCLUDE APS.CPYLIB VEND.PROD.STATS
STATUS=RBO.getProperty('','PMCProperty',PMCProperty)
CONO    = PMCProperty<1,4>
DOS_JOB = PMCProperty<1,5>
  PONUM = '';  VENDNUM = '';  QTY = '';  CATG = '';  ESTCOST = '';  DATEREC = '';  LINENO = '';  REF = '';  TEMP="";OPERCODE= ''
  PODESC = '';DEPTCODE= '';COSTCENTERS = '';VPDS.KEY = '';VPDS_REC_DATE = '';VPDS.REC.DATE = '';ID.LIST = ''
  OPEN "OUTSIDE.PO" TO OUTSIDE.PO ELSE 
    ERRMSG = "CANNOT OPEN OUTSIDE.PO FILE"
    GOSUB 91000
  END
  OPEN '','JOB.STATS' TO JOB.STATS ELSE ERRMSG='JOB.STATS FILE IS MISSING';GOTO 91000
*
  OPEN '','VEND.PROD.STATS' TO VEND.PROD.STATS ELSE
         ERRMSG = 'VEND.PROD.STATS FILE IS MISSING'
         GOSUB 91000
  END
   MATREAD JSTAT.REC FROM JOB.STATS,CONO:DOS_JOB ELSE MAT JSTAT.REC = ''
      PCNT = DCOUNT(JSTAT.OPO.NO,VM)
      IF PCNT THEN
         GXR.IDLIST=''
         FOR P = 1 TO PCNT
            LOCATE JSTAT.OPO.NO<1,P> IN GXR.IDLIST<1>,1 SETTING PFND ELSE
               GXR.IDLIST<1,PFND> = JSTAT.OPO.NO<1,P>
            END
         NEXT P
	  ID.LIST = GXR.IDLIST
    END	
  VAL.CAT = ''
  REF = DCOUNT(ID.LIST,VM)
  PTR = 0
  FOR X = 1 TO DCOUNT(ID.LIST,VM)
   MATREAD OPO.REC FROM OUTSIDE.PO,CONO:ID.LIST<1,X> THEN
   FOR Z = 1 TO DCOUNT(OPO.JOB.NO,VM)
        IF OPO.JOB.NO<1,Z> = DOS_JOB THEN
          PTR += 1
          PONUM<1,PTR> = ID.LIST<1,X>
          VENDNUM<1,PTR> = OPO.VEND.NO
          QTY<1,PTR> = OCONV(OPO.QTY<1,Z> ,"MD2,")
          CATG<1,PTR> = OPO.PROD.LINE<1,Z>
          ESTCOST<1,PTR> = OCONV(OPO.EST.COST<1,Z> ,"MD2,")
          DATEREC<1,PTR> = OCONV(OPO.DATE.RECVD<1,Z>,"D4/")
          LINENO<1,PTR> = Z
	   VAL.CAT<1,PTR> = OPO.PROD.LINE<1,Z>
          REF<1,PTR> = PTR
	   IF DEPTCODE = "" THEN 
		DEPTCODE = OPO.DEPT<1,1,Z>:VM:OPO.DEPT<1,2,Z>:VM:OPO.DEPT<1,3,Z>
		OPERCODE = OPO.OPER.CODE<1,Z>
		PODESC = OPO.ITEM.COMM<1,Z,1>
          END ELSE
		DEPTCODE = DEPTCODE:"~":OPO.DEPT<1,1,Z>:VM:OPO.DEPT<1,2,Z>:VM:OPO.DEPT<1,3,Z>
		PODESC = PODESC :"~": OPO.ITEM.COMM<1,Z,1>
	   END
             VPDS.KEY<1,PTR> = CONO:VENDNUM<1,PTR>:'!O!':PONUM<1,PTR>:'!':DOS_JOB:"!":CATG<1,PTR>:"@":LINENO<1,PTR>
	      MATREAD VPDS.REC FROM VEND.PROD.STATS,VPDS.KEY<1,PTR> THEN
	      VPDS_REC_DATE<1,PTR> = OCONV(VPDS.REC.DATE<1,Z>,"D4/")
	      END ELSE
       	  MAT VPDS.REC = ""
	      END
        END
      NEXT Z
    END
  NEXT X
STATUS = RBO.setProperty('','REF',REF)
STATUS = RBO.setProperty('','PONUM',PONUM)
STATUS = RBO.setProperty('','VENDNUM',VENDNUM)
STATUS = RBO.setProperty('','QTY',QTY)
STATUS = RBO.setProperty('','CATG',CATG)
STATUS = RBO.setProperty('','ESTCOST',ESTCOST)
STATUS = RBO.setProperty('','DATEREC',DATEREC)
STATUS = RBO.setProperty('','OPERCODE',OPERCODE)
STATUS = RBO.setProperty('','DEPTCODE',DEPTCODE)
STATUS = RBO.setProperty('','VPDS_REC_DATE',VPDS_REC_DATE)
STATUS = RBO.setProperty('','PODESC',PODESC)

RETURN

91000
STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN


