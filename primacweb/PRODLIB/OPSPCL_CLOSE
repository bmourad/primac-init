SUBROUTINE OPSPCL_CLOSE
$INCLUDE CPYLIB COMMON1
$INCLUDE JCS.CPYLIB COM.JCS.LINK  
$INCLUDE ICS.CPYLIB COM.INV.MAIN  
$INCLUDE ICS.CPYLIB COM.INV.SERIAL
$INCLUDE JCS.CPYLIB COM.INV.STATS 
$INCLUDE PMC.CPYLIB COM.CUST
$INCLUDE OPS.CPYLIB COM.ORDER
$INCLUDE ICS.CPYLIB COM.INV.CNV
********************************************************************************
*   Program name :- OPSPCL_CLOSE
*   BY          - JAWEED,S.A
*   Created:- 8/16/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$DEFINE COMPANY
$INCLUDE PMC.CPYLIB COMPANY
$DEFINE COMPOPS
$INCLUDE PMC.CPYLIB COMP.OPS
$DEFINE CUSTOMER
$INCLUDE PMC.CPYLIB CUSTOMER
$DEFINE SALESMAN
$INCLUDE PMC.CPYLIB SALESMAN
$DEFINE CSRCODE
$INCLUDE PMC.CPYLIB CSR.CODE
$DEFINE ORDER
$INCLUDE OPS.CPYLIB ORDER
$INCLUDE OPS.CPYLIB ORDER.DETAIL
$DEFINE ORDERDETAILINQ
$INCLUDE OPS.CPYLIB ORDER.DETAIL.INQ
$INCLUDE OPS.CPYLIB ORDER.RELEASE

$INCLUDE OPS.CPYLIB BOL
$DEFINE FNGDSTATS
$INCLUDE ICS.CPYLIB FNGD.STATS
$DEFINE FNGDORDERSTATS
$INCLUDE ICS.CPYLIB FNGD.ORDER.STATS
$INCLUDE PMC.CPYLIB COUNTRY.CODE        ;*T25159
$INCLUDE CPYLIB GEN.XREF.SUB
$INCLUDE CPYLIB PORT.CONTROL
$DEFINE FILEVARS
$INCLUDE CPYLIB FILE.VARS
$INCLUDE CPYLIB CHAR

OPEN "","CONTROL" TO CONTROL ELSE
   ERRMSG = "Cannot locate the CONTROL file"
   GOTO 93000
END
OPEN "","COMPANY" TO COMPANY ELSE
   ERRMSG = "Cannot locate the COMPANY file"
   GOTO 93000
END
OPEN "","CUSTOMER" TO CUSTOMER ELSE
   ERRMSG = "Cannot locate the CUSTOMER file"
   GOTO 93000
END
OPEN "","SHIP.TO" TO SHIP.TO ELSE
   ERRMSG = "Cannot locate the SHIP.TO file"
   GOTO 93000
END
OPEN "","ORDER.RELEASE" TO ORDER.RELEASE ELSE
   ERRMSG = "Cannot locate the ORDER.RELEASE file"
   GOTO 93000
END

OPEN "","BOL" TO BOL ELSE
   ERRMSG = "Cannot locate the BOL file"
   GOTO 93000
END
OPEN "","CSR.CODE" TO CSR.CODE ELSE
   ERRMSG = "Cannot locate the CSR.CODE file"
   GOTO 93000
END
OPEN "","COUNTRY.CODE" TO COUNTRY.CODE ELSE
   ERRMSG = "Cannot locate the COUNTRY.CODE file"
   GOTO 93000
END
OPEN "","ORDER" TO ORDER ELSE
   ERRMSG = "Cannot locate the ORDER file"
   GOTO 93000
END
OPEN "","ORDER.DETAIL" TO ORDER.DETAIL ELSE
   ERRMSG = "Cannot locate the ORDER.DETAIL file"
   GOTO 93000
END
OPEN "","FNGD.ORDER.STATS" TO FNGD.ORDER.STATS ELSE
   ERRMSG = "Cannot locate the FNGD.ORDER.STATS file"
   GOTO 93000
END
OPEN "","FNGD.STATS" TO FNGD.STATS ELSE
   ERRMSG = "Cannot locate the FNGD.STATS file"
   GOTO 93000
END

STATUS=RBO.getProperty('','ID',ID)
ORDNO=ID[4,99]
CONO=ID[1,3]
MATREADU ORD.REC FROM ORDER, CONO:ORDNO LOCKED
      ERRMSG = 'ORDER record is locked by user - ':GETUSERNAME(STATUS())
END ELSE
  * T26126 ^
RELEASE ORDER, CONO:ORDNO
END
STATUS = "L"; SHPNO = "ALL"
MORE = 1
ERRMSG = ""
   BEGIN CASE
          CASE ORD.STATUS<1,1> = "CLOSED"
            ERRMSG = "Order has already been closed"
          CASE ORD.STATUS<1,1> = "CANCEL"
            ERRMSG = "Order has already been cancelled"
          CASE SUM(ODQ.A.QTY) # 0
            ERRMSG = "Order cannot be closed because of allocated quantity"
          CASE SUM(ODQ.R.QTY) # 0
            ERRMSG = "Order cannot be closed because of reserved quantity"
          CASE DCOUNT(ORD.REL.NO,VM) > 0
            RCNT = DCOUNT(ORD.REL.NO,VM)
            FOR R = 1 TO RCNT UNTIL ERRMSG # ""
              MATREAD ORR.REC FROM ORDER.RELEASE, CONO:ORD.REL.NO<1,R> THEN
                IF ORR.STATUS<1,1> # "COMPLETED" THEN
                  ERRMSG = "Order cannot be closed because of open Release ":ORD.REL.NO<1,R>
                END
              END
            NEXT R
          CASE DCOUNT(ORD.BOL,VM) > 0
            BCNT = DCOUNT(ORD.BOL,VM)
            FOR B = 1 TO BCNT UNTIL ERRMSG # ""
              MATREAD BOL.REC FROM BOL, CONO:ORD.BOL<1,B> THEN
                IF BOL.STATUS # "CANCEL" AND BOL.INVOICE = "" THEN
                  ERRMSG = "Order cannot be closed because of uninvoiced Bill of Lading ":ORD.BOL<1,B>
                END
              END
            NEXT B
        END CASE            
   IF ERRMSG = "" THEN
         * IF ECD.RET.VALUE = "Y" THEN
            ORD.STATUS = INSERT(ORD.STATUS,1,1,0,"CLOSED")
            ORD.STAT.DATE = INSERT(ORD.STAT.DATE,1,1,0,DATE())
            STATUS = "U"; SHPNO = ""
            CALL ORDER_LINE_UPD(CONO,ORDNO,SHPNO,STATUS)
            PCNT = DCOUNT(ODQ.PROD,VM)
            FOR P = 1 TO PCNT
              IWH.ID = CONO:ODQ.PROD<1,P>:"!":ODQ.WHSE<1,P>
*T18606 v
              PROD.SEQ = ODQ.PROD.SEQ<1,P>
              KIT.TYPE = ODQ.KIT<1,P>
              MATREADU FGS.REC FROM FNGD.STATS, IWH.ID THEN
                PTR = 1
                LOOP
                  LOCATE ORDNO IN FGS.ORDER<1>,PTR SETTING OLOC THEN
                    FGS.ORDER = DELETE(FGS.ORDER,1,OLOC,0)
                    FGS.O.QTY = DELETE(FGS.O.QTY,1,OLOC,0)
                    FGS.B.QTY = DELETE(FGS.B.QTY,1,OLOC,0)
                    FGS.SEQ = DELETE(FGS.SEQ,1,OLOC,0)
                    FGS.KIT = DELETE(FGS.KIT,1,OLOC,0)
                  END ELSE
                    PTR = 0
                  END
                UNTIL PTR = 0 DO
                  PTR = 1
                REPEAT
*T18606 ^
                IF FGS.ORDER # "" OR FGS.JOB # "" THEN
                  MATWRITE FGS.REC ON FNGD.STATS, IWH.ID
                END ELSE
                  DELETE FNGD.STATS, IWH.ID
                END
              END
*T18606 v
              RELEASE FNGD.STATS, IWH.ID
              MATREADU FOS.REC FROM FNGD.ORDER.STATS, IWH.ID:"!":ORDNO:"!":PROD.SEQ:"!":KIT.TYPE THEN
                DELETE FNGD.ORDER.STATS, IWH.ID:"!":ORDNO:"!":PROD.SEQ:"!":KIT.TYPE
              END ELSE
                RELEASE FNGD.ORDER.STATS, IWH.ID:"!":ORDNO:"!":PROD.SEQ:"!":KIT.TYPE
                MATREADU FOS.REC FROM FNGD.ORDER.STATS, IWH.ID:"!":ORDNO THEN
                  DELETE FNGD.ORDER.STATS, IWH.ID:"!":ORDNO
                END
                RELEASE FNGD.ORDER.STATS, IWH.ID:"!":ORDNO
              END
              RELEASE FNGD.ORDER.STATS, IWH.ID:"!":ORDNO:"!":PROD.SEQ:"!":KIT.TYPE
*T18606 ^
            NEXT P
            MORE = 0
*T23284 v
            LOCATE ORDNO IN CUST.ORD.NUM<1>,1 SETTING OFND THEN
              CUST.ORD.BAL<1,OFND> = 0
              IF CUST.NAME # "Unknown" THEN
                MATWRITE CUST.REC ON CUSTOMER, CONO:ORD.CUST
              END
            END
            RELEASE CUSTOMER, CONO:ORD.CUST
*T23284 ^
          *END
        *END ELSE
         * GOSUB 91000
        END
RELEASE

93000
STATUS = RBO.setProperty('','ServerStatus','E')
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN

