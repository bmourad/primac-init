SUBROUTINE JOBINVR_POSTREAD
********************************************************************************
*   Program name :- JOBINVR_POSTREAD
*   Created:- 8/13/2003
*------------------------------------------------------------------------------*
*
*  
* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JCS.CPYLIB JOB
$INCLUDE PMC.CPYLIB CUSTOMER
$INCLUDE JCS.CPYLIB INVOICE
$INCLUDE JCS.CPYLIB DAILY.INVOICE
$INCLUDE JCS.CPYLIB MASTER.TOT.REC
$INCLUDE CPYLIB CHAR
* Insert method code here

 

IVC.CNT=''
J.CNT=''
ADD.SUBS = 0
IVC.PRT.DATE=''
BILL.AMT=''
TAX.AMT=''
INV.AMT=''
PAID.AMT=''
IVC.PROC.MON=''
PRE_PAID=''
INV_PAID=''
PAID_AMT=''
IVC_PRT_DT=''
TMP_IVC_PRT_DATE = ''
ERRMSG=''
PNCN = "";*T28991

OPEN "","JOB" TO JOB ELSE ERRMSG = "JOB FILE IS MISSING"; GOTO 1000
OPEN "","INVOICE" TO INVOICE ELSE
    ERRMSG = "INVOICE FILE IS MISSING" 
    GOTO 1000
END

OPEN "","DAILY.INVOICE" TO DAILY.INVOICE ELSE
    ERRMSG = "DAILY.INVOICE FILE IS MISSING" 
    GOTO 1000
END

ID = ''
JOB_SUBS=''

STATUS = RBO.getProperty('','ID',ID)
STATUS = RBO.getProperty('','JOB_SUBS',JOB_SUBS)

CONO = ID[1,3]
ID = ID[4,99]
NCNT=''
IV_DATE=''
IVC_PERIOD=''
IVC_PROC_DATE=''
IVC_DATE=''

MATREAD JOB.REC FROM JOB,CONO:ID ELSE
	ERRMSG = 'CANNOT READ JOBFILE'
	GOTO 1000
END

*DIM MASTER.REC(JOB.REC.SIZE)    
****ERR MAT MASTER.REC = MAT JOB.REC
*--- LOAD SUB JOBS TO MASTER.TOT.REC
*IF JOB_SUBS # "" THEN
     	* SCNT = COUNT(MASTER.SUBS,VM) + (MASTER.SUBS # "")
    	 *FOR S = 1 TO SCNT
       *	 MATREAD JOB.REC FROM JOB, CONO:MASTER.SUBS<1,S> ELSE GOTO 1999

*1999 NEXT S
*

*END

IVC_DUE_DATE = ""

NCNT=DCOUNT(JOB.INV.NO,@VM)
FOR I= 1 TO NCNT
	MATREAD IVC.REC FROM INVOICE, CONO:JOB.INV.NO<1,I> THEN
		IV_DATE<1,I>=OCONV(IVC.DATE,"D2/")
		IVC_PERIOD<1,I>=IVC.PROC.MON
		IVC_PROC_DATE<1,I>=OCONV(IVC.PROC.DATE,"D2/")
		IVC_PRT_DT<1,I>=OCONV(IVC.PRT.DATE,"D2/")
		IVC_DUE_DATE<1,I> = OCONV(IVC.CURR.CODE,"D2/")
	END ELSE
		IVC_DATE<1,I>		= ""	
		IVC_PERIOD<1,I>	= ""	
		IVC_PROC_DATE<1,I>	= ""
		IVC_PRT_DT<1,I>	= ""
	END
NEXT I

*************************************************
IVC.CNT = DCOUNT(JOB.INV.NO,@VM)
TAX_AMT = ""
TAX_AMT_NEW = ""
BILL_AMT=""
INV_AMT=""
IVC_PRT_DATE2 = ""

  PRE.PAID = 0
  FOR I = 1 TO IVC.CNT
    TMP_IVC_PRT_DATE<1,I> = "";*ADDED 
    MAT IVC.REC = ""
    IF JOB.INV.CAT<1,I,1> = "PP" THEN
      BILL.AMT = ""
      TAX.AMT = ""
      INV.AMT = ""
      PAID.AMT = INV.AMT - JOB.INV.BAL<1,I>
      PRE.PAID = PRE.PAID + JOB.INV.BAL<1,I>
      GOTO 30005
    END

    IVC.ID=CONO:JOB.INV.NO<1,I>
    IF JOB.INV.DATE<1,I> = "" THEN
      MATREAD IVC.REC FROM DAILY.INVOICE,IVC.ID ELSE NULL
       PNCN		= PNCN:IVC.PERIOD.POST:"~";*T28991	
	IVC_PRT_DATE2<1,I> 	= OCONV(IVC.PRT.DATE,"D2/")
	IVC_PRT_DT<1,I>	= OCONV(IVC.PRT.DATE,"D2/")
	IVC_DUE_DATE<1,I> 	= OCONV(IVC.CURR.CODE,"D2/")
	IVC_PROC_DATE<1,I>	= OCONV(IVC.PROC.DATE,"D2/")
		
	      BILL.AMT = ""
  	      TAX.AMT = ""
	      INV.AMT = ""
             PAID.AMT = ""
	      PRT.DATE = ""
	      
		CODE.CNT = COUNT(IVC.CHG.CODE,@VM) + (IVC.CHG.CODE # "")

		FOR PTR = 1 TO CODE.CNT
			
    			IF IVC.CHG.CODE<1,PTR> = "TOT" OR IVC.CHG.CODE<1,PTR> = "SUB" OR IVC.CHG.CODE<1,PTR> = "SUBT" OR IVC.CHG.CAT<1,PTR> = "CMT" THEN GOTO 49999
			IF ADD.SUBS = 0 AND ID # IVC.CHG.JOB<1,PTR> THEN GOTO 49999
    			
			IF JOB.INV.DATE<1,I> = "" AND JOB.INV.NO<1,I>[7,2] = "CM" THEN
      				IVC.AMOUNT<1,PTR> = IVC.AMOUNT<1,PTR> * (-1)
    			END

    			IF IVC.CHG.CAT<1,PTR> = "TAX" THEN
      				TAX.AMT = TAX.AMT + IVC.AMOUNT<1,PTR>
    			END ELSE
      				BILL.AMT = BILL.AMT + IVC.AMOUNT<1,PTR>
			*	IVC_PRT_DATE2<1,PTR> = OCONV(DI.PRT.DATE<1,I>,"D2/") 
    			END
			
		49999*
  		NEXT PTR
  		INV.AMT = TAX.AMT + BILL.AMT 
    END ELSE
        MATREAD IVC.REC FROM INVOICE,IVC.ID THEN
            PNCN = PNCN:IVC.PERIOD.POST:"~";*T28991	
        BAD.IVC = 1
        IF IVC.JOB.NO = ID THEN
          BAD.IVC = 0
        END ELSE
          LOCATE ID IN IVC.CHG.JOB<1>,1 SETTING JUNK THEN
            BAD.IVC = 0
          END ELSE
            J.CNT = DCOUNT(JOB.SUBS<1>, @VM)
            FOR JJ = 1 TO J.CNT UNTIL BAD.IVC = 0
              TMP.JOB = JOB.SUBS<1,JJ>
              IF IVC.JOB.NO = TMP.JOB THEN
                BAD.IVC = 0
              END ELSE
                LOCATE TMP.JOB IN IVC.CHG.JOB<1>,1 SETTING JUNK THEN
                  BAD.IVC = 0
                END
              END
            NEXT JJ
          END
        END
        IF BAD.IVC = 1 THEN
          MAT IVC.REC=''
          IVC.PRT.DATE="PURGED"
          TMP_IVC_PRT_DATE<1,I>="PURGED"
        END
      END ELSE
        IVC.PRT.DATE = "PURGED"
        TMP_IVC_PRT_DATE<1,I>="PURGED"
      END
*      GOSUB 50000 
	  BILL.AMT = ""
  	  TAX.AMT = ""
  	  INV.AMT = ""
  	  PAID.AMT = ""
  	  CODE.CNT = COUNT(JOB.INV.CAT<1,I>,SVM) + (JOB.INV.CAT<1,I> # "")
  	  FOR PTR = 1 TO CODE.CNT
    		IF JOB.INV.CAT<1,I,PTR> = "TOT" OR JOB.INV.CAT<1,I,PTR> = "SUB" OR JOB.INV.CAT<1,I,PTR> = "CMT" THEN GOTO 59999
    		IF JOB.INV.CAT<1,I,PTR> = "TAX" THEN
       		TAX.AMT = TAX.AMT + JOB.INV.AMT<1,I,PTR>
    		END ELSE
      			BILL.AMT = BILL.AMT + JOB.INV.AMT<1,I,PTR>
    		END
	  59999*
	  NEXT PTR
  	  INV.AMT = TAX.AMT + BILL.AMT
  	  PAID.AMT= INV.AMT - JOB.INV.BAL<1,I>
    END
****
30005*
   * SCV.REC<1,I> = I
    JOB.INV.NO<1,I> 	 	= JOB.INV.NO<1,I>
    JOB.INV.DATE<1,I>	= OCONV(JOB.INV.DATE<1,I>,"D2/")
    IVC.PRT.DATE<1,I> 	= IVC.PRT.DATE<1,I>
    BILL_AMT<1,-1> 		= OCONV(BILL.AMT,"MD2")
    TAX_AMT<1,-1> 		= OCONV(TAX.AMT,"MD2")
    TAX_AMT_NEW<1,I> 	= OCONV(TAX.AMT,"MD2") 
    INV_AMT<1,I> 		= OCONV(INV.AMT,"MD2")
    PAID_AMT<1,I>		= OCONV(PAID.AMT,"MD2")
    JOB.INV.BAL<1,I>		= OCONV(JOB.INV.BAL<1,I>,"MD2")
    IVC.PROC.MON<1,I> 	= IVC.PROC.MON
*    PRT.DATE<1,I>		= OCONV(PRT.DATE<1,I>,"D2/")
  NEXT I

*STATUS = RBO.setProperty('','TEST',IVC_PRT_DATE2)
*RETURN

 * STATUS = RBO.setProperty('','TEST',PAID_AMT:">>>>**")

  PRE_PAID= PRE.PAID * (-1)
  INV_PAID= JOB.TOT.INV - JOB.TOT.BAL + PRE.PAID

  GOSUB SET.VALUES
	STATUS = RBO.setProperty('','IVC_PNCN',PNCN);*T28991 BY YAKUB
	STATUS = RBO.setProperty('','IVC_DATE',IV_DATE)
	STATUS = RBO.setProperty('','IVC_PERIOD',IVC_PERIOD)
	STATUS = RBO.setProperty('','IVC_PROC_DATE',IVC_PROC_DATE)
	STATUS = RBO.setProperty('','IVC_DATE',IV_DATE)
	STATUS = RBO.setProperty('','IVC_PRT_DT',IVC_PRT_DT)
	STATUS = RBO.setProperty('','JOB_INV_NO',JOB.INV.NO)
	STATUS = RBO.setProperty('','JOB_INV_DATE',JOB.INV.DATE)
*	STATUS = RBO.setProperty('','IVC_PRT_DATE',IVC_PRT_DATE2)
	STATUS = RBO.setProperty('','IVC_DUE_DATE_MV',IVC_DUE_DATE)
*DI_PRT_DATE1
**	STATUS = RBO.setProperty('','IVC_PRT_DATE',CODE.CNT)
	STATUS = RBO.setProperty('','IVC_PRT_DATE_TMP',IVC_PRT_DATE2)

	STATUS = RBO.setProperty('','BILL_AMT',BILL_AMT)
*	STATUS = RBO.setProperty('','TAX_AMT',TAX_AMT)
	STATUS = RBO.setProperty('','TAX_AMT',TAX_AMT_NEW)
	STATUS = RBO.setProperty('','INV_AMT',INV_AMT)
	STATUS = RBO.setProperty('','PAID_AMT',PAID_AMT)
	STATUS = RBO.setProperty('','JOB_INV_BALANCE',JOB.INV.BAL)
	STATUS = RBO.setProperty('','IVC_PROC_MON',IVC.PROC.MON)
	STATUS = RBO.setProperty('','PRE_PAID',OCONV(PRE_PAID,"MD2"))
	STATUS = RBO.setProperty('','INV_PAID',OCONV(INV_PAID,"MD2"))
       
*************************************************
1000*
   IF ERRMSG # "" THEN
      STATUS = RBO.setProperty('','ServerStatus', 1)
      STATUS = RBO.setProperty('','ServerMessage', ERRMSG)            
   END

* End of method code
RETURN

SET.VALUES:
   PRT.CNT = ''
   PRT.CNT = DCOUNT(IVC_PRT_DT,@VM)
   FOR SS = 1 TO PRT.CNT
      IF TMP_IVC_PRT_DATE<1,SS> # "" THEN
         IVC_PRT_DT<1,SS> = TMP_IVC_PRT_DATE<1,SS> 
      END
      IF IVC.PROC.MON<1,SS> # "" THEN
        IVC_PERIOD<1,SS> = IVC.PROC.MON<1,SS> 
      END
      IF JOB.INV.DATE<1,SS> # "" THEN
         IV_DATE<1,SS> = JOB.INV.DATE<1,SS>
      END
   NEXT SS
RETURN

