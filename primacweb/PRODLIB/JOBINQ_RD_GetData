SUBROUTINE JOBINQ_RD_GetData
********************************************************************************
*   Program name :- JOBINQ_RD_GetData
*   Created:- 12/09/2002
*   Author:- L. Ross
*   Gets info for Job Inquiry 'RD' option.
*------------------------------------------------------------------------------*
*
*  

* In Properties:
* --------------
*  
IN_PARAM=''
*
* Out Properties:
* ---------------
*  
OUT_PARAM=''
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB INV.CNV
$INCLUDE ICS.CPYLIB INV.JOB.STATS
$INCLUDE CPYLIB CHAR
$INCLUDE JCS.CPYLIB JOB
DEFFUN CalcStkQty(COST.QTY,MAT INV.CNV.REC,ROND,LN)

;* open files

ERRMSG=''
IF FILEINFO(INVENTORY,0)=0 THEN
  OPEN '','INVENTORY' TO INVENTORY ELSE
    ERRMSG<1,-1>='INVENTORY FILE IS MISSING'
   END
END
IF FILEINFO(INV.JOB.STATS,0)=0 THEN
  OPEN '','INV.JOB.STATS' TO INV.JOB.STATS ELSE
    ERRMSG<1,-1>='INV.JOB.STATS FILE IS MISSING'
   END
END
IF FILEINFO(JOB,0)=0 THEN
  OPEN '','JOB' TO JOB ELSE
    ERRMSG<1,-1>='JOB FILE IS MISSING'
  END
END
IF ERRMSG#'' THEN GOTO 93000

;* initialize

SAVE.INV.JS.REC = ''
RQD.DATE.MV=1
RQD.AMT.MV=2
RQD.QTY.MV=3

;* get ID

STATUS=RBO.getProperty('','ID',ID)
CONO=ID[1,3]
JOB_NO=ID[4,8]
STATUS=RBO.getProperty('','MAST_SUB_FLAG',MAST.SUB.FLAG)

;* get database values
MAINPROD='';MAINWHSE=''
PRODDESCS1=''; UMS1=''
ALLOCATED1=''; RESERVED1=''; USED1=''
REQD.DATE1=''; REQD.PRICE1=''; REQD.QTY1=''; BALANCE1=''

MATREAD JOB.REC FROM JOB,ID ELSE
  ERRMSG='Cannot read JOB record ':ID
  GOTO 93000
END
MAINPROD=JOB.RESV.MATL
MAINWHSE=JOB.RESV.WHSE

PCNT=DCOUNT(JOB.RESV.MATL,VM)
FOR P = 1 TO PCNT
  MATREAD INV.REC FROM INVENTORY,CONO:JOB.RESV.MATL<1,P> ELSE
    INV.FULL.DESC = 'Unknown'
  END
  $INCLUDE ICSBP INV.UM.CNV
  ROND=''; LN=''
  PRODDESCS1<1,P> = INV.FULL.DESC
  UMS1<1,P> = INV.UNIT<1,2>
  ALLOCATED1<1,P> = CalcStkQty(JOB.ALOC.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
  ALLOCATED1<1,P> = OCONV(ALLOCATED1<1,P>,ICR.CNV1)
  RESERVED1<1,P> = CalcStkQty(JOB.RESV.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
  RESERVED1<1,P> = OCONV(RESERVED1<1,P>,ICR.CNV1)
  USED1<1,P> = CalcStkQty(JOB.USED.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
  USED1<1,P> = OCONV(USED1<1,P>,ICR.CNV1)
  IF SAVE.INV.JS.REC<P> = '' THEN
    JSTAT.ID = JOB.RESV.MATL<1,P>:"!":JOB.RESV.WHSE<1,P>:"!":JOB_NO
    MATREAD INV.JS.REC FROM INV.JOB.STATS,CONO:JSTAT.ID ELSE
      MAT INV.JS.REC = ''
    END
    SAVE.INV.JS.REC<P,RQD.DATE.MV> = IJS.REQ.DATE
    SAVE.INV.JS.REC<P,RQD.AMT.MV> = IJS.REQ.AMT
    SAVE.INV.JS.REC<P,RQD.QTY.MV> = IJS.REQ.QTY
  END
  REQD.DATE1<1,P> = OCONV(SAVE.INV.JS.REC<P,RQD.DATE.MV>,'D2/')
  REQD.PRICE1<1,P> = OCONV(SAVE.INV.JS.REC<P,RQD.AMT.MV>,'MD4,')
  REQD.QTY1<1,P> = CalcStkQty(SAVE.INV.JS.REC<P,RQD.QTY.MV>,MAT INV.CNV.REC,ROND,LN)
  REQD.QTY1<1,P> = OCONV(REQD.QTY1<1,P>,ICR.CNV1)
  BALANCE1<1,P> = SAVE.INV.JS.REC<P,RQD.QTY.MV> - JOB.ALOC.QTY<1,P> - JOB.RESV.QTY<1,P> - JOB.USED.QTY<1,P>
  IF BALANCE1<1,P> < 0 THEN BALANCE1<1,P> = 0
  BALANCE1<1,P> = CalcStkQty(BALANCE1<1,P>,MAT INV.CNV.REC,ROND,LN)
  BALANCE1<1,P> = OCONV(BALANCE1<1,P>,ICR.CNV1)
NEXT P



IF MAST.SUB.FLAG=1 THEN
  ITYPE='RD'
  CALL MasterSummarySub(CONO,JOB_NO,SAVE.INV.JS.REC,MAT JOB.REC,ITYPE)
 
  STATUS = RBO.getProperty('','ERRMSG',ERRMSG) 
  IF ERRMSG # "" THEN GOTO 93000

  PCNT=DCOUNT(JOB.RESV.MATL,VM)
  PRODDESCS=''; UMS=''=''
  ALLOCATED=''; RESERVED=''; USED=''
  REQD.DATE=''; REQD.PRICE=''; REQD.QTY=''; BALANCE=''
  FOR P = 1 TO PCNT
      MATREAD INV.REC FROM INVENTORY,CONO:JOB.RESV.MATL<1,P> ELSE
        INV.FULL.DESC = 'Unknown'
      END
      $INCLUDE ICSBP INV.UM.CNV
      ROND=''; LN=''
      PRODDESCS<1,P> = INV.FULL.DESC
      UMS<1,P> = INV.UNIT<1,2>
      ALLOCATED<1,P> = CalcStkQty(JOB.ALOC.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
      ALLOCATED<1,P> = OCONV(ALLOCATED<1,P>,ICR.CNV1)
      RESERVED<1,P> = CalcStkQty(JOB.RESV.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
      RESERVED<1,P> = OCONV(RESERVED<1,P>,ICR.CNV1)
      USED<1,P> = CalcStkQty(JOB.USED.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
      USED<1,P> = OCONV(USED<1,P>,ICR.CNV1)
      IF SAVE.INV.JS.REC<P> = '' THEN
         JSTAT.ID = JOB.RESV.MATL<1,P>:"!":JOB.RESV.WHSE<1,P>:"!":JOB_NO
         MATREAD INV.JS.REC FROM INV.JOB.STATS,CONO:JSTAT.ID ELSE
           MAT INV.JS.REC = ''
         END
         SAVE.INV.JS.REC<P,RQD.DATE.MV> = IJS.REQ.DATE
         SAVE.INV.JS.REC<P,RQD.AMT.MV> = IJS.REQ.AMT
         SAVE.INV.JS.REC<P,RQD.QTY.MV> = IJS.REQ.QTY
      END
      REQD.DATE<1,P> = OCONV(SAVE.INV.JS.REC<P,RQD.DATE.MV>,'D2/')
      REQD.PRICE<1,P> = OCONV(SAVE.INV.JS.REC<P,RQD.AMT.MV>,'MD4,')
      REQD.QTY<1,P> = CalcStkQty(SAVE.INV.JS.REC<P,RQD.QTY.MV>,MAT INV.CNV.REC,ROND,LN)
      REQD.QTY<1,P> = OCONV(REQD.QTY<1,P>,ICR.CNV1)
      BALANCE<1,P> = SAVE.INV.JS.REC<P,RQD.QTY.MV> - JOB.ALOC.QTY<1,P> - JOB.RESV.QTY<1,P> - JOB.USED.QTY<1,P>
      IF BALANCE<1,P> < 0 THEN BALANCE<1,P> = 0
      BALANCE<1,P> = CalcStkQty(BALANCE<1,P>,MAT INV.CNV.REC,ROND,LN)
      BALANCE<1,P> = OCONV(BALANCE<1,P>,ICR.CNV1)
  NEXT P
  IF JOB.RESV.MATL <> "" THEN
	MAINPROD=MAINPROD:VM:JOB.RESV.MATL
	MAINWHSE=MAINWHSE:VM:JOB.RESV.WHSE
	PRODDESCS1=PRODDESCS1:VM:PRODDESCS
	UMS1=UMS1:VM:UMS
       ALLOCATED1=ALLOCATED1:VM:ALLOCATED
	RESERVED1=RESERVED1:VM:RESERVED
	USED1=USED1:VM:USED
	REQD.QTY1=REQD.QTY1:VM:REQD.QTY	
       REQD.PRICE1=REQD.PRICE1:VM:REQD.PRICE 
       REQD.DATE1=REQD.DATE1:VM:REQD.DATE
	BALANCE1=BALANCE1:VM:BALANCE
  END

END


STATUS=RBO.setProperty('','JOB_RESV_MATL',MAINPROD)
STATUS=RBO.setProperty('','JOB_RESV_WHSE',MAINWHSE)
STATUS=RBO.setProperty('','ProdDescs',PRODDESCS1)
STATUS=RBO.setProperty('','Ums',UMS)
STATUS=RBO.setProperty('','JOB_ALOC_QTY',ALLOCATED1)
STATUS=RBO.setProperty('','JOB_RESV_QTY',RESERVED1)
STATUS=RBO.setProperty('','JOB_USED_QTY',USED1)
STATUS=RBO.setProperty('','REQD_QTY',REQD.QTY1)
STATUS=RBO.setProperty('','REQD_PRICE',REQD.PRICE1)
STATUS=RBO.setProperty('','REQD_DATE',REQD.DATE1)
STATUS=RBO.setProperty('','REQD_BALANCE',BALANCE1)
GOTO 99999

93000 
STATUS = RBO.setProperty('','ServerStatus',1)        
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)  

99999
RETURN

