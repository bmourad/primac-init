SUBROUTINE RELM_DELETE_REC
********************************************************************************
*   Program name :- RELM_DELETE_REC
*   Created:- 9/2/2003 RAZI MOHIUDDIN
*------------------------------------------------------------------------------*
* In Properties:
* --------------
*  
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE CPYLIB COMMON1
$INCLUDE OPS.CPYLIB COM.ORDER
$DEFINE ORDER
$INCLUDE OPS.CPYLIB ORDER
$INCLUDE OPS.CPYLIB ORDER.RELEASE
$INCLUDE OPS.CPYLIB ORDER.DETAIL
$INCLUDE OPS.CPYLIB PICK.TICKET 
$INCLUDE PMC.CPYLIB COM.CUST
$INCLUDE CPYLIB CHAR

****
DEFFUN ORDER_LINE_UPD(CONO,ORDNO,SHPNO,STATUS)
****

* Insert method code here
ERRMSG = ''
OPEN 'ORDER' TO ORDER ELSE
      ERRMSG='CANNOT OPEN ORDER FILE'
      GOTO 1000
END

OPEN 'ORDER.RELEASE' TO ORDER.RELEASE ELSE
      ERRMSG='CANNOT OPEN ORDER.RELEASE FILE'
      GOTO 1000
END

OPEN 'ORDER.DETAIL' TO ORDER.DETAIL ELSE
      ERRMSG='CANNOT OPEN ORDER.DETAIL FILE'
      GOTO 1000
END

OPEN "","PICK.TICKET" TO PICK.TICKET ELSE
         ERRMSG = "Cannot locate the PICK.TICKET file"
	  GOTO 1000
END
OPEN "","PICK.TICKET.PRT" TO PICK.TICKET.PRT ELSE
         ERRMSG = "Cannot locate the PICK.TICKET.PRT file"
	  GOTO 1000
END

ID = ''
CONO=''
ISFOUND =''

STATUS = RBO.getProperty('','ID',ID)
STATUS = RBO.getProperty('','ORR_ORD',ORR_ORD)
STATUS = RBO.getProperty('','ORR_SHIP_TO',ORR_SHIP_TO)
STATUS = RBO.getProperty('','GRIDCNT',GRIDCNT)


CONO = ID[1,3]
RELNO = ID[4,99]
ORDNO=ORR_ORD
SHPNO = ORR_SHIP_TO
LINES = GRIDCNT

RCNT=''
RPTR =0
SPTR =0


	MATREAD ORD.REC FROM ORDER,CONO:ORR_ORD THEN
		ORD_CUST=ORD.CUST		
		ORD_REL_NO=ORD.REL.NO
		ORD_SHIP_TO=ORD.SHIP.TO
	END ELSE
		ERRMSG='CANNOT READ ORDER FILE'
		GOTO 1000
	END

	MATREAD ORD.DET.REC FROM ORDER.DETAIL,CONO:ORR_ORD:"!":ORR_SHIP_TO THEN
		OSD_REL_NO=OSD.REL.NO
	END ELSE
		ERRMSG='CANNOT READ ORDER Detail FILE'
		GOTO 1000
	END
	
	RCNT = DCOUNT(ORD.REL.NO,VM)
	LOCATE RELNO IN ORD.REL.NO<1>,1 SETTING RPTR THEN
          IF RPTR = RCNT THEN
          	RPTR = 1
          END ELSE
              RPTR = RPTR + 1
          END
       END ELSE
          	RPTR = 1
       END

	LOCATE RELNO IN ORD.REL.NO<1>, 1 SETTING RPTR THEN
	   FOR PLN = 1 TO LINES WHILE ERRMSG = ""
	     LOCATE RELNO IN OSD.REL.NO<1,PLN>,1 SETTING RLOC THEN
                *ERRMSG = "All quantities must be unreserved from this release before deleting"
                *GOTO 1000 
            END
         NEXT PLN
	END
	
	SCNT = DCOUNT(ORD.SHIP.TO,VM)
	LOCATE SHPNO IN ORD.SHIP.TO<1>,1 SETTING SPTR ELSE
            ERRMSG = "Cannot locate the current ship to # ":SHPNO
           GOTO 1000
       END
	***IF SPTR = SCNT THEN
      ***      SPTR = 1
      *** END ELSE
      ***      SPTR = SPTR + 1
      *** END
       ***SHPNO = ORD.SHIP.TO<1,SPTR>
*******************************
      
              ORD.REL.NO = DELETE(ORD.REL.NO,1,RPTR,0)
              FOR P = 1 TO ORD.DET.REC.SIZE
                ORD.DET.SUM(P,SPTR) = ORD.DET.REC(P)
              NEXT P
              STATUS = "L"
		**CALL ORDER_LINE_UPD(CONO,ORDNO,SHPNO,STATUS)
              STATUS = "U"; SHPNO = ""
              **CALL ORDER_LINE_UPD(CONO,ORDNO,SHPNO,STATUS)
              DELETE ORDER.RELEASE, CONO:RELNO
              PCNT = DCOUNT(ORD.PICK.NO,@VM) ; PKT.FOUND = 0
              FOR P = 1 TO PCNT UNTIL (PKT.FOUND)   
                MATREADU PKT.REC FROM PICK.TICKET, CONO:ORD.PICK.NO<1,P> THEN
                  IF PKT.REL.NO = RELNO THEN 
                    PKT.REL.NO = '' ; PKT.FOUND = 1 
                    MATWRITE PKT.REC ON PICK.TICKET, CONO:ORD.PICK.NO<1,P>
                  END
                END
                RELEASE PICK.TICKET, CONO:ORD.PICK.NO<1,P> 
              NEXT P
              SHPWHS = ""
		LINES = DCOUNT(OSD.PROD,VM)
              FOR P = 1 TO LINES
                SHPWH = ORR.SHIP.TO:"!":OSD.WHSE<1,P>
                LOCATE SHPWH IN SHPWHS,1 SETTING FND ELSE
                  PKT.ID = CONO:ORDNO:"!":SHPWH
                  READU REC FROM PICK.TICKET.PRT, PKT.ID THEN
                    LOCATE RELNO IN REC,1 SETTING PTR THEN
                      REC = DELETE(REC,PTR,0,0)
                      IF REC = "" THEN
                        DELETE PICK.TICKET.PRT, PKT.ID
                      END ELSE
                        WRITE REC ON PICK.TICKET.PRT, PKT.ID
                      END
                      SHPWHS<FND> = SHPWH
                    END
                  END ELSE
                    RELEASE PICK.TICKET.PRT, PKT.ID
                  END
                END
              NEXT P
              IF ORR_ORD # "" THEN
                FOR P = 1 TO ORD.DET.REC.SIZE
                  ORD.DET.SUM(P,SPTR) = ORD.DET.REC(P)
                NEXT P
                STATUS = "L"; SHPNO = "ALL"
                **CALL ORDER_LINE_UPD(CONO,ORDNO,SHPNO,STATUS)
                MORE = 0
              END ELSE
                MAT ORD.REC = ""; MAT CUST.REC = ""
                ORDNO = ""; SHPNO = ""; JOBNO = ""
                RELNO = ""
                MORE = 0 - 1
              END
           
 
**********************************	
1000*
   IF ERRMSG # "" THEN
      STATUS = RBO.setProperty('','ServerStatus', 1)
      STATUS = RBO.setProperty('','ServerMessage', ERRMSG)            
   END

* End of method code
RETURN

