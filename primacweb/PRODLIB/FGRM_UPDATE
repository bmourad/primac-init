SUBROUTINE FGRM_UPDATE
*********************************************************************
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - EPRIMAC
* PROGRAM     - FGRM_UPDATE
* BY          - KHAJA ZIAUDDIN
* DATE        - 09/10/2003  (mm/dd/yyyy)
* DESCRIPTION   This program is called when the user choses the Post Receipt option from Finished Goods Receipts 
*		   
*ENDDOC
*************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE CPYLIB COMMON1
$INCLUDE JCS.CPYLIB COM.JCS.LINK  
$INCLUDE ICS.CPYLIB COM.INV.MAIN  
$INCLUDE ICS.CPYLIB COM.INV.SERIAL
$INCLUDE JCS.CPYLIB COM.INV.STATS 
$INCLUDE PMC.CPYLIB COM.CUST      
$INCLUDE OPS.CPYLIB COM.ORDER     
$INCLUDE ICS.CPYLIB COM.INV.CNV   
$INCLUDE OPS.CPYLIB COM.OPS.LINK  

$INCLUDE PMC.CPYLIB COMPANY
$DEFINE COMPOPS
$INCLUDE PMC.CPYLIB COMP.OPS
$DEFINE CUSTOMER
$INCLUDE PMC.CPYLIB CUSTOMER
$INCLUDE PMC.CPYLIB SHIP.TO
$INCLUDE PMC.CPYLIB FISCAL
$INCLUDE PMC.CPYLIB SALESDATES
$DEFINE JOB
$INCLUDE JCS.CPYLIB JOB
$DEFINE INVENTORY
$INCLUDE ICS.CPYLIB INVENTORY
$DEFINE CATEGORY
$INCLUDE ICS.CPYLIB CATEGORY
$DEFINE INVWHSE
$INCLUDE ICS.CPYLIB INV.WHSE
$DEFINE INVWHSELOC
$INCLUDE ICS.CPYLIB INV.WHSE.LOC
$INCLUDE ICS.CPYLIB WAREHOUSE
$DEFINE INVCNV
$INCLUDE ICS.CPYLIB INV.CNV
$DEFINE DAILYFNGDRECEIPT
$INCLUDE OPS.CPYLIB DAILY_FNGD_RECEIPT
$DEFINE JOBFNGDSTATS
$INCLUDE OPS.CPYLIB JOB.FNGD.STATS
$INCLUDE OPS.CPYLIB FNGD.WIP.HIST
$DEFINE ORDER
$INCLUDE OPS.CPYLIB ORDER
$INCLUDE OPS.CPYLIB ORDER.DETAIL
$INCLUDE OPS.CPYLIB ORDER.RELEASE
$DEFINE FILEVARS
$INCLUDE CPYLIB FILE.VARS

*
   DEFFUN CALC_STK_QTY(COST.QTY,MAT INV.CNV.REC,ROND,LN)
   DEFFUN CALC_COST_QTY(STK.QTY,MAT INV.CNV.REC,ROND,LN)
   DEFFUN GET_RECP_ID(CONO,CONTROL.FILE,DATE)

STATUS = RBO.getProperty('','ID',ID)
CONO = ID[1,3]
RCPTNO = ID[4,99]

GOSUB OPEN.FILES

   MATREAD OPCO.REC FROM CONTROL, CONO:"OPS" ELSE
      MAT OPCO.REC=""
   END
   MATREAD FISCAL.REC FROM CONTROL, CONO:"ICFISCAL" ELSE
      ERRMSG="Cannot locate Inventory Control Fiscal Period !!"
      GOTO 93000
   END
   MATREAD SALESDATES.REC FROM CONTROL, CONO:"SALESDATES" ELSE
      ERRMSG="Cannot locate the Sales period ending dates !!"
      GOTO 93000
   END
   READ DIVISION.REC FROM CONTROL, CONO:"DIVISIONS" ELSE
      ERRMSG="DIVISIONS CONTROL RECORD IS MISSING"
      GOTO 93000
   END
   READ SECURITY.REC FROM CONTROL, CONO:"DIV.SECURITY" ELSE
      ERRMSG="DIV.SECURITY CONTROL RECORD IS MISSING"; GOTO 93000
   END
   READ PERIOD.REC FROM CONTROL, CONO:"ACCT.PERIODS" ELSE
      PERIOD.REC = ""
      PERIOD.REC<1> = 12
   END
   NUM.PERIODS = PERIOD.REC<1>

DFR.ID = ID
MATREAD DFR.REC FROM DAILY_FNGD_RECEIPT, ID ELSE MAT DFR.REC = ''

READU DUMMY FROM INV_RECEIPTS, DFR.ID THEN
   DFR.STATUS="Receipt already posted"
   RELEASE INV_RECEIPTS, DFR.ID
   MATWRITEU DFR.REC ON DAILY_FNGD_RECEIPT, DFR.ID
   ERRMSG=DFR.STATUS; GOTO 93000
END ELSE
   DFR.STATUS=""
   CALL FNGD_RECP_UPDATE(DFR.ID,OPCO.COST.SALE)
   IF DFR.STATUS="" THEN
      MATREADU FWH.REC FROM FNGD.WIP.HIST, CONO:DFR.JOB ELSE MAT FWH.REC=""
      PPTR=1
      LOOP
         LOCATE DFR.PROD IN FWH.PROD<1>,PPTR SETTING FND THEN
            IF DFR.WHSE=FWH.WHSE<1,FND> THEN PPTR=0
         END ELSE
            FWH.PROD<1,FND>=DFR.PROD
            FWH.WHSE<1,FND>=DFR.WHSE
            PPTR=0
         END
      WHILE PPTR DO
         PPTR=FND + 1
      REPEAT
      PPTR=FND
      LOCATE DFR.PERIOD IN FWH.PERIOD<1,PPTR>,1 SETTING MPTR THEN
         FWH.RECP<1,PPTR,MPTR>=FWH.RECP<1,PPTR,MPTR>:"!":RCPTNO
      END ELSE
         FWH.PERIOD<1,PPTR,MPTR>=DFR.PERIOD
         FWH.RECP<1,PPTR,MPTR>=RCPTNO
      END
      MATWRITE FWH.REC ON FNGD.WIP.HIST, CONO:DFR.JOB
      WRITE "" ON FNGD_WIP_HIST_TAG, CONO:DFR.JOB
      DELETE DAILY_FNGD_RECEIPT, DFR.ID
      MATREADU JOB.REC FROM JOB, CONO:DFR.JOB ELSE
         MAT JOB.REC=""
      END
      MATREAD JFS.REC FROM JOB.FNGD.STATS,CONO:DFR.JOB ELSE
         MAT JFS.REC=""
      END
      JOB.QTY<1,2>=SUM(JFS.F.QTY)  / 1000
      MATWRITE JOB.REC ON JOB, CONO:DFR.JOB
      MORE=0
   END ELSE
      RELEASE INV_RECEIPTS, DFR.ID
      MATWRITEU DFR.REC ON DAILY_FNGD_RECEIPT, DFR.ID
      ERRMSG=DFR.STATUS; GOTO 93000
   END
END
RELEASE
RETURN
*




*****************
OPEN.FILES: 
*****************
*
   OPEN "","DAILY_FNGD_RECEIPT" TO DAILY_FNGD_RECEIPT ELSE
      ERRMSG="DAILY_FNGD_RECEIPT"; GOTO 93000
   END
   OPEN "","INV_RECEIPTS" TO INV_RECEIPTS ELSE
      ERRMSG="INV_RECEIPTS"; GOTO 93000
   END
   OPEN "","OPS.SCREENS" TO M.SCREENS ELSE
      ERRMSG="OPS.SCREENS"; GOTO 93000
   END
   OPEN "","COMPANY" TO COMPANY ELSE
      ERRMSG="COMPANY"; GOTO 93000
   END
   OPEN "","CONTROL" TO CONTROL ELSE
      ERRMSG="CONTROL"; GOTO 93000
   END
   OPEN "","CUSTOMER" TO CUSTOMER ELSE
      ERRMSG="CUSTOMER"; GOTO 93000
   END
   OPEN "","SHIP.TO" TO SHIP.TO ELSE
      ERRMSG="SHIP.TO"; GOTO 93000
   END
   OPEN "","CUSTOMER.XREF" TO CUSTOMER.XREF ELSE
      ERRMSG="CUSTOMER.XREF"; GOTO 93000
   END
   OPEN "","CURR.CODE" TO CURR.CODE ELSE
      ERRMSG="CURR.CODE"; GOTO 93000
   END
   OPEN "","PREFIX" TO PREFIX ELSE
      ERRMSG="PREFIX"; GOTO 93000
   END
   OPEN "","XREF.DATA" TO XREF.DATA ELSE
      ERRMSG="XREF.DATA"; GOTO 93000
   END
   OPEN "","INVENTORY" TO INVENTORY ELSE
      ERRMSG="INVENTORY"; GOTO 93000
   END
   OPEN "","INV.FNGD" TO INV.FNGD ELSE
      ERRMSG="INV.FNGD"; GOTO 93000
   END
   OPEN "","CATEGORY" TO CATEGORY ELSE
      ERRMSG="CATEGORY"; GOTO 93000
   END
   OPEN "","INV.WHSE" TO INV.WHSE ELSE
      ERRMSG="INV.WHSE"; GOTO 93000
   END
   OPEN "","INV.WHSE.LOC" TO INV.WHSE.LOC ELSE
      ERRMSG="INV.WHSE.LOC"; GOTO 93000
   END
   OPEN "","WAREHOUSE" TO WAREHOUSE ELSE
      ERRMSG="WAREHOUSE"; GOTO 93000
   END
   OPEN "","INV_AUDIT_HIST" TO INV_AUDIT_HIST ELSE
      ERRMSG="INV_AUDIT_HIST"; GOTO 93000
   END
   OPEN "","JOB" TO JOB ELSE
      ERRMSG="JOB"; GOTO 93000
   END
   OPEN "","ORDER" TO ORDER ELSE
      ERRMSG="ORDER"; GOTO 93000
   END
   OPEN "","ORDER.DETAIL" TO ORDER.DETAIL ELSE
      ERRMSG="ORDER.DETAIL"; GOTO 93000
   END
   OPEN "","ORDER.RELEASE" TO ORDER.RELEASE ELSE
      ERRMSG="ORDER.RELEASE"; GOTO 93000
   END
   OPEN "","FNGD.STATS" TO FNGD.STATS ELSE
      ERRMSG="FNGD.STATS"; GOTO 93000
   END
   OPEN "","JOB.FNGD.STATS" TO JOB.FNGD.STATS ELSE
      ERRMSG="JOB.FNGD.STATS"; GOTO 93000
   END
   OPEN "","FNGD.JOB.STATS" TO FNGD.JOB.STATS ELSE
      ERRMSG="FNGD.JOB.STATS"; GOTO 93000
   END
   OPEN "","FNGD.WIP.HIST" TO FNGD.WIP.HIST ELSE
      ERRMSG="FNGD.WIP.HIST"; GOTO 93000
   END
   OPEN "","FNGD_WIP_HIST_TAG" TO FNGD_WIP_HIST_TAG ELSE
      ERRMSG="FNGD_WIP_HIST_TAG"; GOTO 93000
   END
   OPEN "","FNGD.ORDER.STATS" TO FNGD.ORDER.STATS ELSE
      ERRMSG="FNGD.ORDER.STATS"; GOTO 93000
   END
   OPEN "","PICK.TICKET.PRT" TO PICK.TICKET.PRT ELSE
      ERRMSG="PICK.TICKET.PRT"; GOTO 93000
   END
   RETURN


93000
RELEASE
STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN 





