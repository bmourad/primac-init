SUBROUTINE ICSSRE_Write
*********************************************************************
* Copyright 1998 by Primac Systems India
* SYSTEM       - EPRIMAC
* PROGRAM      - ICSSRE_Write
* BY           - KHAJA ZIAUDDIN
* DATE         - 06/13/2003 (mm/dd/yyyy)
* DESCRIPTION  - THIS PROGRAM will build the required parameters and then make a call to STOCK.REC.UPDATE
*                
*                
*                
*                
*ENDDOC
*********************************************************************
DEFFUN DIVISION_POSITION(CONO,CONTROL,DIV.CODE)
DEFFUN CURRENT_PERIOD(CONO,CONTROL,DIV.POS,X)
$INCLUDE WWINSERT RBO.H
$INCLUDE CPYLIB COMMON1
$INCLUDE ICS.CPYLIB COM.INV.MAIN  
$INCLUDE ICS.CPYLIB COM.INV.SERIAL
$INCLUDE ICS.CPYLIB COM.INV.LINK  
$INCLUDE POS.CPYLIB COM.PO.INTRF
$INCLUDE CPYLIB CHAR

$DEFINE PO
$INCLUDE PMC.CPYLIB PO
$DEFINE SSTK
$INCLUDE ICS.CPYLIB SAVE.STOCK.REC
$INCLUDE PMC.CPYLIB COMPANY
$DEFINE INVENTORY
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB WAREHOUSE
$INCLUDE ICS.CPYLIB INV.STATS
$INCLUDE ICS.CPYLIB INV.JOB.STATS
$INCLUDE JCS.CPYLIB JOB
$DEFINE INVWHSE
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE ICS.CPYLIB INV.HIST
$DEFINE APSFILEVARS
$INCLUDE APS.CPYLIB APS.FILE.VARS
$DEFINE FILEVARS
$INCLUDE CPYLIB FILE.VARS
$INCLUDE APS.CPYLIB VEND.STATS
$INCLUDE APS.CPYLIB VEND.PO.STATS
$INCLUDE APS.CPYLIB VEND.PROD.STATS
$INCLUDE POS.CPYLIB ACCRUED.LIAB.HIST
$DEFINE ICSID
$INCLUDE ICS.CPYLIB ICS.ID
$DEFINE INVWHSELOC
$INCLUDE ICS.CPYLIB INV.WHSE.LOC
$DEFINE CATEGORY
$INCLUDE ICS.CPYLIB CATEGORY
$DEFINE INVRECEIPTS
$INCLUDE ICS.CPYLIB INV_RECEIPTS
$DEFINE INVRECPWHSE
$INCLUDE ICS.CPYLIB INV_RECP_WHSE
$DEFINE INVAUDITHIST
$INCLUDE ICS.CPYLIB INV_AUDIT_HIST
$DEFINE INVSERIAL
$INCLUDE ICS.CPYLIB INV_SERIAL
  
$INCLUDE ICS.CPYLIB INV.CNV

STATUS = RBO.getProperty('','ID',PO.CODE)
STATUS = RBO.getProperty('','PMCProperty',PMCPROPERTY)
CONO = PMCPROPERTY<1,4>
MAT COMP.REC = ''

*STATUS = RBO.setProperty('','ServerMessage',' ID - ' : PO.CODE)
*RETURN

;**** OPEN FILES
;*
OPEN '','INVENTORY' TO INVENTORY ELSE
  ERRMSG = 'INVENTORY FILE IS MISSING'; GOTO 93000
END
OPEN '','WAREHOUSE' TO WAREHOUSE ELSE
  ERRMSG = 'WAREHOUSE FILE IS MISSING'; GOTO 93000
END
OPEN '','INVENTORY.XREF' TO INVENTORY.XREF ELSE
  ERRMSG = 'INVENTORY.XREF FILE IS MISSING'; GOTO 93000
END
OPEN '','CATEGORY' TO CATEGORY ELSE
  ERRMSG = 'CATEGORY FILE IS MISSING'; GOTO 93000
END
OPEN '','INV.STATS' TO INV.STATS ELSE
  ERRMSG = 'INV.STATS FILE IS MISSING'; GOTO 93000
END
OPEN '','INV.JOB.STATS' TO INV.JOB.STATS ELSE
  ERRMSG = 'INV.JOB.STATS FILE IS MISSING' ; GOTO 93000
END
OPEN '','INV.WHSE.LOC' TO INV.WHSE.LOC ELSE
  ERRMSG = 'INV.WHSE.LOC IS MISSING'; GOTO 93000
END
OPEN '','INV.WHSE' TO INV.WHSE ELSE
  ERRMSG = 'INV.WHSE IS MISSING'; GOTO 93000
END
OPEN '','INV.HIST' TO INV.HIST ELSE
  ERRMSG = 'INV.HIST IS MISSING'; GOTO 93000
END
OPEN '','JOB' TO JOB ELSE
  ERRMSG = 'JOB IS MISSING'; GOTO 93000
END
OPEN '','COMPANY' TO COMPANY ELSE
  ERRMSG = 'COMPANY FILE IS MISSING'; GOTO 93000
END
OPEN '','VEND' TO VEND ELSE
  ERRMSG = 'VENDOR FILE IS MISSING'; GOTO 93000
END
OPEN '','ICS.SCREENS' TO M.SCREENS ELSE
  ERRMSG = 'ICS.SCREENS FILE IS MISSING'; GOTO 93000
END
OPEN '','CONTROL' TO CONTROL ELSE
  ERRMSG = 'CONTROL FILE IS MISSING'; GOTO 93000
END
OPEN '','VENDOR.XREF' TO VENDOR.XREF ELSE
  ERRMSG = 'VENDOR.XREF FILE IS MISSING'; GOTO 93000
END
OPEN '','PREFIX' TO PREFIX ELSE
  ERRMSG = 'PREFIX FILE IS MISSING'; GOTO 93000
END
OPEN '','ACCRUED.LIAB.HIST' TO ACCRUED.LIAB.HIST ELSE
  ERRMSG = 'ACCRUED.LIAB.HIST FILE IS MISSING'; GOTO 93000
END
OPEN "SLIT.TRANS" TO SLIT.TRANS ELSE 
  ERRMSG = "SLIT.TRANS FILE IS MISSING" ; GOTO 93000
END
OPEN "DIVISION" TO DIVISION ELSE 
  ERRMSG = "DIVISION FILE IS MISSING" ; GOTO 93000
END
OPEN '','INV_RECEIPTS' TO INV_RECEIPTS ELSE
  ERRMSG = 'INV_RECEIPTS IS MISSING'; GOTO 93000
END
OPEN '','INV_RECP_WHSE' TO INV_RECP_WHSE ELSE
  ERRMSG = 'INV_RECP_WHSE IS MISSING'; GOTO 93000
END
OPEN '','INV_SERIAL' TO INV_SERIAL ELSE
  ERRMSG = 'INV_SERIAL IS MISSING'; GOTO 93000
END
OPEN '','INV_AUDIT_HIST' TO INV_AUDIT_HIST ELSE
  ERRMSG = 'INV_AUDIT_HIST IS MISSING'; GOTO 93000
END
OPEN '','INV_AUDIT_TAG' TO INV_AUDIT_TAG ELSE
  ERRMSG = 'INV_AUDIT_TAG IS MISSING';GOTO 93000
END
* ADDED BY ZUBAIR SINCE GOT ERROR MESSAGE - Can not access unopened file - FATA ERROR
OPEN '','PO' TO PO ELSE ERRMSG = 'PO FILE IS MISSING'; GOTO 93000
MAT PO.REC = ''
* END OF ADDITION 

;*
;***** GET COMPANY NAME
;*
MATREAD COMP.REC FROM COMPANY,CONO ELSE
	MAT COMP.REC = ""
END	
IF CO.POS = 'Y' THEN
  OPEN '','PO' TO PO ELSE
    ERRMSG = 'PO FILE IS MISSING'; GOTO 93000
  END
END
IF CO.APS.R.INTRF > 1 THEN
  OPEN '','VEND.STATS' TO VEND.STATS ELSE 
    ERRMSG = "VEND.STATS FILE IS MISSING" ; GOTO 93000
  END
  OPEN '','VEND.PO.STATS' TO VEND.PO.STATS ELSE
    ERRMSG = 'VEND.PO.STATS FILE IS MISSING' ; GOTO 93000
  END
  OPEN '','VEND.PROD.STATS' TO VEND.PROD.STATS ELSE
    ERRMSG = 'VEND.PROD.STATS FILE IS MISSING' ; GOTO 93000
  END
END
*

STATUS = RBO.getProperty('','Period',Period)
STATUS = RBO.getProperty('','JobNo',JobNo)
STATUS = RBO.getProperty('','JBOnOrd',JBOnOrd)
STATUS = RBO.getProperty('','JBReceved',JBReceved)
STATUS = RBO.getProperty('','JBOpen',JBOpen)
STATUS = RBO.getProperty('','ReceiptsDate',ReceiptsDate)
STATUS = RBO.getProperty('','Loc',Loc)
STATUS= RBO.getProperty('','TEMP',TEMP)
STATUS = RBO.getProperty('','RecQtyStk',RecQtyStk)
STATUS = RBO.getProperty('','RollSkid',RollSkid)
STATUS = RBO.getProperty('','Diameter',Diameter)
STATUS = RBO.getProperty('','PDT_QtyOnHand',PDT_QtyOnHand)

*FOR JOB DATAS
*STATUS = RBO.getProperty('','JobNo',JobNo)
*STATUS = RBO.getProperty('','JBOnOrd',JBOnOrd)
*STATUS = RBO.getProperty('','JBReceved',JBReceved)

*STATUS = RBO.setProperty('','ServerMessage','PERIOD--' : Period :  'ReceiptsDate-' : ReceiptsDate : '-LOC -' : Loc : '--RecQtyStk --' : RecQtyStk : '--RollSkid--' : RollSkid : '--Diameter--' : Diameter)
*RETURN
POORDQTY=""
POJBOPEN=""
MATREAD PO.REC FROM PO,PO.CODE THEN 
	FIND.PO = 1
END ELSE 
	MAT PO.REC = ''
       FIND.PO = 0
END

POJBOPEN=PO.JB.OPEN
*WRITE POORDQTY ON CONTROL,"PMCC"
STATUS = RBO.setProperty('','TotOnOrd',PO.TOT.ONORD)
STATUS = RBO.setProperty('','TotCancel',PO.TOT.CANCEL)
STATUS=  RBO.setProperty('','JBUnits',PO.JB.UNITS)
STATUS=  RBO.setProperty('','ProdType',PO.PROD.TYPE)
STATUS = RBO.setProperty('','PrevReceved',PO.PREV.RECEVED)
*STATUS = RBO.getProperty('','QtyOpen',PO.QTY.OPEN)
*STATUS = RBO.getProperty('','TotReceived',PO.TOT.RECEVED)
STATUS = RBO.getProperty('','PO_COMPLETE',POCOMPLETE)

ReceiptsDate = ICONV(ReceiptsDate,"D2/")

MAT SAVE.STK.REC = ''
SSTK.VEND = PO.VEND.NO
SSTK.DATE = ReceiptsDate
SSTK.PERIOD = Period     
*SSTK.SHIP.NO =    
*SSTK.SHIP.TOT =   
*SSTK.OPER.ID  = 
*SSTK.PO.LINE = 
*SSTK.STATUS  = 
SSTK.COMPLETE=POCOMPLETE
SSTK.PROD = PO.PROD.NUM
SSTK.WHSE = PO.WHSE
SSTK.UNIT.PRICE = PO.GROS.PRICE
SSTK.DISCOUNT = PO.DISCOUNT
SSTK.UNIT.FLG = PO.UNIT.FLG
SSTK.JB.UNITS=PO.JB.UNITS
*SSTK.COMPLETE = 
SSTK.TOT.ONORD = PO.TOT.ONORD
SSTK.TOT.RECEVED = PO.TOT.RECEVED
SSTK.PREV.RECEVED = PO.PREV.RECEVED
SSTK.QTY.OPEN = PO.QTY.OPEN
SSTK.TOT.CANCEL = PO.TOT.CANCEL
*SSTK.TOT.REC = PO.TOT.RECEVED
SSTK.TOT.REC=RecQtyStk
SSTK.PROD.TYPE = PO.PROD.TYPE
SSTK.DEL.DATE = PO.DEL.DATE
SSTK.LOC = Loc
*SSTK.SERIAL = 
SSTK.QTY = TEMP 

SSTK.DIAM = Diameter
SSTK.SHEET = RollSkid
*SSTK.MILL.ID = 
*SSTK.LOC.STATUS = 
*SSTK.NO.PIECES = 
*SSTK.LOC.DEL = 
SSTK.JOB=JobNo

*SSTK.JOB = PO.JOB.NO 
POORDQTY=TEMP
SSTK.JB.ONORD =JBOnOrd
SSTK.JB.RECEVED=JBReceved
SSTK.JB.OPEN=JBOpen
*****************
*the below line is commented and changed -- by zubair
*SSTK.JOB.QTY = PO.JB.ONORD


*SSTK.JOB.QTY=JBReceved
*SSTK.JOB.QTY=TEMP
*SSTK.JOB.QTY = PO.JB.RECEVED
*WRITE SSTK.JOB.QTY:"&&":JBOnOrd ON CONTROL,"JT"

*SSTK.JOB.QTY=JBReceved
*PO.JB.ONORD (job on ordered qty which is updated at only thro regular purchase entry which qty allocated to particular job;
*if not that field will be 0; in stock receipts if it is 0 this stock rec update method wont updated 
*(IF SSTK.JOB.QTY<1,S,J> <= 0 THEN GOTO 3088) the file INV.JOB.STATS which is to be updated so that it is reflected in job maintenance
************

*SSTK.JOB.ALC = 
*SSTK.JOB.STATUS = 
*SSTK.JOB.REC = PO.JB.RECEVED
*SSTK.JOB.DEL = 
*SSTK.ORD.QTY = 
*SSTK.C.P = 
*SSTK.LBS.P.C = 
*SSTK.WT.E.S = 
*SSTK.REF.FI = 
SSTK.KQTY = PDT_QtyOnHand 

*SSTK.ROLL.RECV = 
*SSTK.REC.CMPL = 
*SSTK.CMS.LOC = 
*SSTK.LOT = 
*SSTK.PRT.LABELS = 
*SSTK.NO.COPIES = 
*SSTK.CUST.PO = 
SSTK.CUST = PO.CUST.NO

*JOB GRID VALUES
*STATUS = RBO.setProperty('','ServerMessage','JOB DATAS --' : PO.JOB.NO : "~~~" : PO.JB.ONORD : "~~~" : PO.JB.RECEVED : "~~~" : PO.CUST.NO)
*RETURN

DIV.CODE = PO.DIV.OWNER
DIV.POS = DIVISION_POSITION(CONO,CONTROL,DIV.CODE)
BEGIN CASE                                              
  CASE DIV.POS<1,1>=''                                  
    DIV.POS=DIV.POS<1,2>                                
    CUR.PERIOD=CURRENT_PERIOD(CONO,CONTROL,DIV.POS,"IC")
    IF CUR.PERIOD<1,1>='' THEN                          
      CUR.PERIOD=CUR.PERIOD<1,2>                        
    END ELSE                                            
      IF CUR.PERIOD<1,2>='-2' THEN                      
        ERRMSG=CUR.PERIOD<1,2>                          
        GOSUB 93000                                     
      END                                               
    END                                                 
  CASE DIV.POS<1,1>='-1'                                
    ERRMSG=DIV.POS<1,2>                                 
    GOSUB 93000                                         
    RELEASE PO, CONO:PO.CODE                            
  CASE DIV.POS<1,1>='-2'                                
    ERRMSG=DIV.POS<1,2>                                 
    GOSUB 93000                                         
END CASE 
         
*STATUS = RBO.setProperty('','ServerMessage','PO.PROD.NUM IN ICSSRE WRITE - ' : PO.PROD.NUM)
*RETURN

CALL Stock_Rec_Update(CONO,PO.CODE,FIND.PO,MAT COMP.REC,CUR.PERIOD,POORDQTY,POJBOPEN)
*STATUS=RBO.setProperty('','QtyOpen',PO.QTY.OPEN)
RELEASE


STATUS = RBO.setProperty('','ServerStatus',0)
*STATUS = RBO.setProperty('','ServerMessage',RecQtyStk)
* End of method code
RETURN


*****
93000
*****

STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN

