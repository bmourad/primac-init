SUBROUTINE GET_ORDM_CREDIT
********************************************************************************
*   Program name :- GET_ORDM_CREDIT
*   Created:- 3/11/2005
*   By :- Suhail
*   Doc :- This method returns values which are used for getting Credit Authorization 
*          codes at the client side
*------------------------------------------------------------------------------*
$INCLUDE WWINSERT RBO.H
$INCLUDE CPYLIB COMMON1
$INCLUDE PMC.CPYLIB COM.CUST
$INCLUDE OPS.CPYLIB COM.ORDER
$DEFINE CUSTOMER
$INCLUDE PMC.CPYLIB CUSTOMER
$DEFINE ORDER
$INCLUDE OPS.CPYLIB ORDER
$DEFINE ORDERDETAILINQ
$INCLUDE OPS.CPYLIB ORDER.DETAIL.INQ
$DEFINE COMPOPS
$INCLUDE PMC.CPYLIB COMP.OPS
$INCLUDE OPS.CPYLIB ORDER.DETAIL
* Insert method code here

DEFFUN ORD_LINE_UPD(CONO,ORDNO,SHPNO,STAT,ERR,MAT ORD.DET.INQ)

OPEN '','CUSTOMER' TO CUSTOMER ELSE 
	ERRMESG = 'CANNOT OPEN CUSTOMER FILE' 
	GOTO 93000
END
*OPEN '','ORDER' TO ORDER ELSE 
*	ERRMESG = 'CANNOT OPEN ORDER FILE' 
*	GOTO 93000
*END
OPEN '','CONTROL' TO CONTROL ELSE
	ERRMESG = 'CANNOT OPEN CONTROL FILE'
END
OPEN "","PICK.TICKET.PRT" TO PICK.TICKET.PRT ELSE
	ERRMSG = "Cannot locate the PICK.TICKET.PRT file";GOTO 93000
	GOTO 93000
END
OPEN '','ORDER' TO ORDER ELSE
	ERRMSG = 'CANNOT OPEN ORDER FILE'
	GOTO 93000
END
OPEN '','ORDER_DETAIL' TO ORDER.DETAIL ELSE
	ERRMSG = 'CANNOT OPEN ORDER_DETAIL FILE'
	GOTO 93000
END

PORT.NO = "TTY"; CALL SYSVARS.SUB(PORT.NO)
JOB.BALANCE = ''
ORD.BALANCE = ''
OLD.TOT.AMT = ''
RETARR = ''
UPDCRED = ''
SHPWHSCNT = 0
B.QTY  = ""
MAT ORD.DET.INQ = ''

STATUS = RBO.getProperty('', 'PMCProperty', PMCProperty)
STATUS = RBO.getProperty('', 'ORDER_CUST', ORD_CUST)
STATUS = RBO.getProperty('', 'ORDER_PRINT', ORD_PRINT)
STATUS = RBO.getProperty('','ORDER_NUM',ORDNO)
CONO = PMCProperty<1,4>

UPDCRED = 0

   MATREAD CUST.REC FROM CUSTOMER, CONO:ORD_CUST ELSE
	ERRMESG = 'UNABLE TO READ CUST.REC FROM CUTOMER ON ' : CONO:ORD_CUST
	GOTO 93000
   END
*   MATREAD ORD.REC FROM ORDER, CONO:ORDNO ELSE
*	ERRMESG = 'UNABLE TO READ ORDER FILE ON ' : ORDNO
*	GOTO 93000
*   END
** v
   MATREAD OPCO.REC FROM CONTROL, CONO:"OPS" ELSE
      ERRMSG = "Cannot locate Order Processing company setup"
      GOTO 93000
   END
   IF ORDNO # 'N' THEN
     NEWREC = 0
     MATREAD ORD.REC FROM ORDER, CONO:ORDNO ELSE
	 ERRMESG = 'UNABLE TO READ ORDER FILE ON ' : ORDNO
	 GOTO 93000
     END
     STATUS = "U"
     CALL ORD_LINE_UPD(CONO,ORDNO,SHPNO,STATUS,ERR,MAT ORD.DET.INQ)
     GOSUB 6100
   END ELSE
     NEWREC = 1
   END
     
   CMD = "SSELECT CREDIT.AUTH.CODE WITH CONO = " : CONO
   UDTEXECUTE CMD
   DATA = 1
   CRDTCODES = ''
   I = 1
   LOOP
      READNEXT CODE ELSE DATA = 0
   WHILE DATA DO
	CRDTCODES<1,I> = CODE[4,99]
	I = I + 1
   REPEAT

   IF NEWREC THEN
      B.QTY = 0
      NUM.PRODS = DCOUNT(ODQ.PROD,@VM)
      FOR P = 1 TO NUM.PRODS
         IF ODQ.KIT<1,P> = "N" THEN
            B.QTY = B.QTY + ODQ.O.QTY<1,P> - ODQ.R.QTY<1,P> - ODQ.A.QTY<1,P> - ODQ.S.QTY<1,P>
         END
      NEXT P
   END
** ^
   JOB.BALANCE = ""
   ORD.BALANCE = ""
   OLD.TOT.AMT = ""
   JOB.BALANCE = SUM(CUST.JOB.BAL)
   ORD.BALANCE = SUM(CUST.ORD.BAL)
   OLD.TOT.AMT = SUM(ODQ.AMT)

 RETARR = ''
 RETARR = CUST.CREDIT
 RETARR = RETARR : '!' : CUST.CR.LIMIT
 RETARR = RETARR : '!' : CUST.AR.BAL
 RETARR = RETARR : '!' : CUST.ORD.NUM
 RETARR = RETARR : '!' : JOB.BALANCE 
 RETARR = RETARR : '!' : ORD.BALANCE
 RETARR = RETARR : '!' : UPDCRED
 RETARR = RETARR : '!' : SUM(ODQ.AMT)
 RETARR = RETARR : '!' : OLD.TOT.AMT
 RETARR = RETARR : '!' : CUST.ORD.BAL
 RETARR = RETARR : '!' : ORD.BALANCE
 RETARR = RETARR : '!' : ORD.TOT.INV
 RETARR = RETARR : '!' : B.QTY
 RETARR = RETARR : '!' : OPCO.JOB.BLD
 RETARR = RETARR : '!' : OPCO.EST.BLD
 RETARR = RETARR : '!' : SHPWHSCNT
 RETARR = RETARR : '!' : CRDTCODES
 RETARR = RETARR : '!' : PORT.NO
 GOTO 93000

6100*
   IF ORD_PRINT # "N" AND OPCO.SHP.FRM # "R" THEN
      SHPWHS = ""
      FOR X = 1 TO DCOUNT(ORD.SHIP.TO,@VM)
         SHPNO = ORD.SHIP.TO<1,X>
         IF SHPNO # "000" THEN
            MATREAD ORD.DET.REC FROM ORDER.DETAIL, CONO:ORDNO:"!":SHPNO ELSE
               MAT ORD.DET.REC = ""
            END
            PCNT = DCOUNT(OSD.PROD,@VM)
            FOR P = 1 TO PCNT
               PICK.QTY = 0
               SCNT = DCOUNT(OSD.FI.QTY<1,P>,@SVM)
               FOR S = 1 TO SCNT
                  PICK.QTY = PICK.QTY + (OSD.FI.QTY<1,P,S> - OSD.P.QTY<1,P,S>)
               NEXT S
               IF PICK.QTY > 0 THEN
                  SHPWH = SHPNO:"!":OSD.WHSE<1,P>
                  LOCATE SHPWH IN SHPWHS,1 SETTING FND ELSE
                     PKT.ID = CONO:ORDNO:"!":SHPWH
                     READ REC FROM PICK.TICKET.PRT, PKT.ID ELSE
                        SHPWHS<FND> = SHPWH
                     END
                  END
               END
            NEXT P
         END
      NEXT X
      SHPWHSCNT = DCOUNT(SHPWHS,@AM)
   END	
RETURN

* End of method code
93000*
*   WRITE 'SUHAIL ': RETARR ON CONTROL,'HLL'
   STATUS = RBO.setProperty('', 'ServerMessage', ERRMESG)
   STATUS = RBO.setProperty('','RETARR',RETARR)
RETURN
