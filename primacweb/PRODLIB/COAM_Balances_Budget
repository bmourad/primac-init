SUBROUTINE COAM_Balances_Budget
********************************************************************************
*   Program name :- COAM_Balances_Budget
*   Created:- 1/17/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H

STATUS = RBO.getProperty('','Cono',CONO)
STATUS = RBO.getProperty('','ID',ID)
STATUS = RBO.getProperty('','TEMP_INPUT',SOURCE)
MAT CB.REC = ''
IF SOURCE = "RADIO" THEN
*call the COAM_READ_COA_BAL method over here
	STATUS = RBO.callMethod('','COAM_READ_COA_BAL')
	STATUS = RBO.getProperty('','DUMMY_REC',DUMMY_REC)
*end
END
STATUS = RBO.setProperty('','ID',CONO:ID)

* Insert method code here
$INCLUDE PMC.CPYLIB COA
$INCLUDE GLS.CPYLIB COA.BAL
$INCLUDE PMC.CPYLIB DIVISION
$INCLUDE PMC.CPYLIB DEPARTMENT
$INCLUDE PMC.CPYLIB COST.CNTR
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE CPYLIB CHAR

* Open files
ERRMSG = ''
OPEN 'COMPANY' TO COMPANY ELSE ERRMSG = 'CANNOT OPEN COMPANY FILE'
OPEN 'CONTROL' TO CONTROL ELSE ERRMSG = 'CANNOT OPEN CONTROL FILE'
OPEN 'COA' TO COA ELSE ERRMSG = 'CANNOT OPEN COA FILE'
IF ERRMSG THEN
  CALL RBO_ERROR_SUB(ERRMSG)
  RETURN
END

* Get properties
STATUS = RBO.getProperty('','Account',ACCT.NO)
STATUS = RBO.getProperty('','CCtr',CCTR.CODE)
STATUS = RBO.getProperty('','StartingPeriod',StartingPeriod)
STATUS = RBO.getProperty('','AnnualBudget',AnnualBudget)
STATUS = RBO.getProperty('','BudgetMethod',BudgetMethod)
STATUS = RBO.getProperty('','ThisYearOpenBal',ThisYearOpenBal)
STATUS = RBO.getProperty('','COAM_Balances_Rec',COAM_Balances_Rec)
IF SOURCE = "RADIO" THEN
	IF DUMMY_REC # "" THEN
		FOR I = 1 TO 161
			*IF DUMMY_REC<1,I>[1,1] = "-" THEN DUMMY_REC<1,I> = DUMMY_REC<1,I>[2,999]
			DUMMY_REC<1,I> = ICONV(DUMMY_REC<1,I>,"MD2")
			CB.REC(I) = DUMMY_REC<1,I>
		NEXT I
	END
END ELSE
*	SWAP "," WITH VM IN COAM_Balances_Rec
NEW_COAM_Balances_Rec =''
	FOR J= 1 TO 161
		IF COAM_Balances_Rec<1,J> = "0" THEN COAM_Balances_Rec<1,J> = ""
		NEW_COAM_Balances_Rec<1,J> = ICONV(COAM_Balances_Rec<1,J>,"MD2")
		
	NEXT J
	MATPARSE CB.REC FROM NEW_COAM_Balances_Rec, VM
END

* Get CONO
*CONO = ID[1,3]
MATREAD COMP.REC FROM COMPANY, CONO ELSE
  ERRMSG = 'Invalid Company ID (':CONO:').'
  CALL RBO_ERROR_SUB(ERRMSG); RETURN
END

* Get Acct
MATREAD COA.REC FROM COA, CONO : ACCT.NO ELSE
  ERRMSG = 'Cannot locate account - ' : ACCT.NO CO.ACCT.MASK
  CALL RBO_ERROR_SUB(ERRMSG); RETURN
END

READ REC FROM CONTROL, CONO:"FISCAL" ELSE
  ERRMSG = "CONTROL FISCAL IS NOT ON FILE"
  CALL RBO_ERROR_SUB(ERRMSG); RETURN
END
YEAR = REC<1>[1,4]
CURR = REC<1>[5,2]
TAPE.FLG = "Y"
BudgetOpenBal = ""
READ REC FROM CONTROL, CONO:(YEAR-1):"GLS.TAPE" ELSE TAPE.FLG = "N"

* Initialize and read values
DIM OLD.CB(300)
DIM NEW.CB(300)
DIM OCOA.REC(20)
ERRMSG = ""
READ PER.DATES FROM CONTROL, CONO:"OPENDATES" ELSE
  ERRMSG = "CONTROL RECORD OPENDATES IS MISSING"
  CALL RBO_ERROR_SUB(ERRMSG); RETURN
END
READ PERIOD.REC FROM CONTROL, CONO:"ACCT.PERIODS" ELSE
  PERIOD.REC = 12
END
NUM.PERIODS = PERIOD.REC<1>

IN.ACCT.LEN = LEN(CO.ACCT.PIC)
GEN.DIV = "00"
GEN.DEPT = "00"
GEN.CCTR = "000"
ACCT.NUM = ACCT.NO
MAT OCOA.REC = MAT COA.REC
READV ALL.DIV FROM CONTROL, CONO:"DIVISIONS", 1 ELSE ALL.DIV = "01"
DIV.CNT = DCOUNT(ALL.DIV,VM)
DIVSN.CODE = ''
NUM.PERIODS = PERIOD.REC<1> + 1

* Check starting period
BEGIN CASE
  CASE StartingPeriod = "YE"
    PR = NUM.PERIODS
  CASE NUM(StartingPeriod) AND StartingPeriod > 0 AND StartingPeriod < NUM.PERIODS + 1
    PR = StartingPeriod
  CASE 1
    PR = 0
END CASE

* Set output values
IF CCTR.CODE = "" THEN
  ERRMSG = "No action taken."
  CALL RBO_ERROR_SUB(ERRMSG); RETURN
END

IF BudgetMethod = "P" THEN
  FOR PR = 1 TO PERIOD.REC<1>
    IF PR = PERIOD.REC<1> THEN
      TEMP = CB.REC(161) - CB.REC(CB.BUD+PR)
    END ELSE
      TEMP = CB.REC(CB.BUD+PR+1) - CB.REC(CB.BUD+PR)
    END
    IF TEMP <> 0 THEN
      IF COA.NORM = "CR" THEN TEMP = TEMP * (-1)
    END ELSE
      TEMP = ""
    END
    BudgetOpenBal<1,PR> = OCONV(TEMP,"MD2")
  NEXT PR
*ADDED FOR RADIO BUTTON INPUT FROM THE ASP
  IF SOURCE = "RADIO" THEN
	STATUS = RBO.setProperty('','BudgetOpenBal',BudgetOpenBal)
	RETURN
  END
*END
  BudgetOpenBal<1,PR> = ""
  IF AnnualBudget = 0 OR AnnualBudget = "" THEN
    IF PR THEN
      FOR PR.LN = PR TO PERIOD.REC<1>+1
        GOSUB GET.MONTHLY.BUDGET.BAL
      NEXT PR.LN
    END
  END ELSE
    IF COA.NORM = "CR" THEN AnnualBudget = AnnualBudget * (-1)
    TEMP = INT(AnnualBudget/PERIOD.REC<1>)
    FOR PR = 1 TO NUM.PERIODS
      IF PR = 1 THEN
        CB.REC(CB.BUD+1) = 0
      END ELSE
        IF PR = NUM.PERIODS THEN
          CB.REC(161) = CB.REC(CB.BUD+PR-1) + TEMP
          CB.REC(CB.BUD+PR) = CB.REC(161)
        END ELSE
          CB.REC(CB.BUD+PR) = CB.REC(CB.BUD+PR-1) + TEMP
        END
      END
    NEXT PR
    IF CB.REC(161) # AnnualBudget THEN
      TEMP = AnnualBudget - CB.REC(161)
      ST.PR = ABS(TEMP)
      IF ST.PR < PERIOD.REC<1> THEN
        PR.PTR = NUM.PERIODS - ST.PR
        FOR PR = ST.PR TO 1 STEP -1 UNTIL TEMP = 0
          IF PR = ST.PR THEN
            CB.REC(161) = CB.REC(161) + TEMP
          END ELSE
            CB.REC(CB.BUD+PR+PR.PTR) = CB.REC(CB.BUD+PR+PR.PTR) + TEMP
          END
          IF TEMP < 0 THEN
            TEMP = TEMP + 1
          END ELSE
            TEMP = TEMP - 1
          END
        NEXT PR
      END ELSE
        CB.REC(161) = AnnualBudget
      END
    END
    FOR PR = 1 TO PERIOD.REC<1>
      TEMP = CB.REC(CB.BUD+PR+1) - CB.REC(CB.BUD+PR)
      IF TEMP <> 0 THEN
        IF COA.NORM = "CR" THEN TEMP = TEMP * (-1)
      END ELSE
        TEMP = ""
      END
      BudgetOpenBal<1,PR> = OCONV(TEMP,"MD2")
    NEXT PR
    BudgetOpenBal<1,PR> = ""
  END
END ELSE
  FOR PR.LN = 1 TO NUM.PERIODS
    TEMP = CB.REC(CB.BUD+PR.LN) + 0
    IF PR.LN = (PERIOD.REC<1> + 1) THEN
      TEMP = CB.REC(161) + 0
    END
    IF TEMP <> 0 THEN
      IF COA.NORM = "CR" THEN TEMP = TEMP * (-1)
      BudgetOpenBal<1,PR.LN> = OCONV(TEMP,"MD2")
    END ELSE
      BudgetOpenBal<1,PR.LN> = ""
      CB.REC(CB.BUD+PR.LN) = ""
    END
  NEXT PR.LN
*ADDED FOR RADIO BUTTON INPUT FROM THE ASP
  IF SOURCE = "RADIO" THEN 
	STATUS = RBO.setProperty('','BudgetOpenBal',BudgetOpenBal)
	RETURN
  END
*END
  IF AnnualBudget = 0 OR AnnualBudget = "" THEN
    IF PR THEN
      LN.NO  = PR
      FOR PR.LN = PR TO NUM.PERIODS
        GOSUB GET.BUDGET.BAL
      NEXT PR.LN
    END
  END ELSE
    IF COA.NORM = "CR" THEN AnnualBudget = AnnualBudget * (-1)
    TEMP = INT(AnnualBudget/PERIOD.REC<1>)
    FOR PR = 1 TO NUM.PERIODS
      IF PR = 1 THEN
        CB.REC(CB.BUD+1) = 0
      END ELSE
        IF PR = NUM.PERIODS THEN
          CB.REC(161) = CB.REC(CB.BUD+PR-1) + TEMP
        END ELSE
          CB.REC(CB.BUD+PR) = CB.REC(CB.BUD+PR-1) + TEMP
        END
      END
    NEXT PR
    IF CB.REC(161) # AnnualBudget THEN
      TEMP = AnnualBudget - CB.REC(161)
      ST.PR = ABS(TEMP)
      IF ST.PR < PERIOD.REC<1> THEN
        PR.PTR = NUM.PERIODS - ST.PR
        FOR PR = ST.PR TO 1 STEP -1 UNTIL TEMP = 0
          IF PR = ST.PR THEN
            CB.REC(161) = CB.REC(161) + TEMP
          END ELSE
            CB.REC(CB.BUD+PR+PR.PTR) = CB.REC(CB.BUD+PR+PR.PTR) + TEMP
          END
          IF TEMP < 0 THEN
            TEMP = TEMP + 1
          END ELSE
            TEMP = TEMP - 1
          END
        NEXT PR
      END ELSE
        CB.REC(161) = AnnualBudget
      END
    END
    FOR PR.LN = 1 TO NUM.PERIODS

      TEMP = CB.REC(CB.BUD+PR.LN) + 0
      IF PR.LN = (PERIOD.REC<1> + 1) THEN
        TEMP = CB.REC(161) + 0
      END
      IF TEMP <> 0 THEN
        IF COA.NORM = "CR" THEN TEMP = TEMP * (-1)
        BudgetOpenBal<1,PR.LN> = OCONV(TEMP,"MD2")
      END ELSE
        BudgetOpenBal<1,PR.LN> = ""
        CB.REC(CB.BUD+PR.LN) = ""
      END
    NEXT PR.LN
  END
END
FOR K=1 TO 161
	CB.REC(K) = OCONV(CB.REC(K),"MD2")
NEXT K
MATBUILD COAM_Balances_Rec FROM CB.REC
COAM_Balances_Rec = LOWER(COAM_Balances_Rec)
* Set output properties
STATUS = RBO.setProperty('','BudgetOpenBal',BudgetOpenBal)
STATUS = RBO.setProperty('','COAM_Balances_Rec',COAM_Balances_Rec)

* End of method code
RETURN

GET.BUDGET.BAL: 
IF BudgetOpenBal<1,PR.LN> + 0 <> 0 THEN
  IF COA.NORM = "CR" THEN BudgetOpenBal<1,PR.LN> = BudgetOpenBal<1,PR.LN> * (-1)
END ELSE
  BudgetOpenBal<1,PR.LN> = ""
END
IF PR.LN = NUM.PERIODS THEN
  CB.REC(161) = BudgetOpenBal<1,PR.LN>
END ELSE
  CB.REC(CB.BUD+PR.LN) = BudgetOpenBal<1,PR.LN>
END
RETURN

GET.MONTHLY.BUDGET.BAL: 
IF BudgetOpenBal<1,PR.LN> + 0 <> 0 THEN
  IF COA.NORM = "CR" THEN BudgetOpenBal<1,PR.LN> = BudgetOpenBal<1,PR.LN> * (-1)
END ELSE
  BudgetOpenBal<1,PR.LN> = ""
END
IF PR.LN = 1 THEN
  CB.REC(CB.BUD+PR.LN) = ""
END
IF PR.LN = PERIOD.REC<1> THEN
  CB.REC(161) = BudgetOpenBal<1,PR.LN> + CB.REC(CB.BUD+PR.LN)
END ELSE
  CB.REC(CB.BUD+PR.LN+1) = BudgetOpenBal<1,PR.LN> + CB.REC(CB.BUD+PR.LN)
END
RETURN

