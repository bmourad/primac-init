SUBROUTINE JCSJME_PREWRITE
********************************************************************************
*   Program name :- JCSJME_PREWRITE
*   Programmer :- Syed Suhail Hussain
*   Created:- 6/28/2005
*------------------------------------------------------------------------------*
*
*  Server event triggered after the database image has been updated, but prio- *
*  r to the physical update occurring. Any changes to the database image at t- *
*  his point must be made via the API functions RBO.setDBVals() and RBO.getDB- *
*  Vals().
*  
*       - *

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB INV.CNV
* Insert method code here

ERRMSG = ''
OPEN "","INVENTORY" TO INVENTORY ELSE ERRMSG="INVENTORY FILE IS MISSING";GOTO 99999
OPEN '','CONTROL' TO CONTROL ELSE GOTO 99999


DEFFUN CALC_STK_QTY(COST.QTY,MAT INV.CNV.REC,ROND,LN)
DEFFUN CALC_COST_QTY(STK.QTY,MAT INV.CNV.REC,ROND,LN)


STATUS = RBO.getProperty('','DMT_RS_QTYPE',DMTRSQTYPE)
STATUS = RBO.getProperty('','DMT_SHEET',DMTSHEET)
STATUS = RBO.getProperty('','DMT_PROD',DMTPROD)
STATUS=RBO.getProperty('','PMCProperty',PMCProperty)

DMT_QTY = ""
DMT.STK.QTY = ""

CONO   = PMCProperty<1,4>
INVID  = CONO : DMTPROD

MATREAD INV.REC FROM INVENTORY,INVID ELSE ERRMSG = "CANNOT READ INVENTORY FILE!";GOTO 99999
$INCLUDE ICSBP INV.UM.CNV
BEGIN CASE
  CASE DMTRSQTYPE="DR"
    DMT_QTY = DMTSHEET*10
    DMT.STK.QTY=""
    DMTSHEET = OCONV(DMTSHEET,"MD2")
  CASE DMTRSQTYPE[2,1]="R"
    DMT_QTY=CALC_COST_QTY(DMTSHEET,MAT INV.CNV.REC,'.99','')
    DMT.STK.QTY=CALC_STK_QTY(DMT_QTY,MAT INV.CNV.REC,'.99','')
    DMTSHEET = OCONV(DMT.STK.QTY,ICR.CNV)
  CASE 1
    DMT_QTY=CALC_COST_QTY(DMTSHEET,MAT INV.CNV.REC,'.5','')
    DMT.STK.QTY=CALC_STK_QTY(DMT_QTY,MAT INV.CNV.REC,'.5','')
    DMTSHEET = OCONV(DMT.STK.QTY,ICR.CNV)
END CASE

STATUS = RBO.setProperty('','DMT_QTY',DMT_QTY)
STATUS = RBO.setProperty('','DMT_SHEET',DMTSHEET)
RETURN
* End of method code
99999:
      STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
      STATUS = RBO.setProperty('','ServerStatus',1)
RETURN

