SUBROUTINE ESTRLM_DEPT_PURGE
********************************************************************************
*   Program name :- ESTRLM_DEPT_PURGE
*   Created:- 7/5/2006
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H

* Insert method code here
$INCLUDE JES.CPYLIB SCOMMON.ESTIMATE
$DEFINE ESTIMATE
$INCLUDE JES.CPYLIB ESTIMATE
$DEFINE ESTIMATEDEPT
$INCLUDE JES.CPYLIB ESTIMATE.DEPT
$INCLUDE CPYLIB CHAR

STATUS = RBO.getProperty('','DREFCREF',VALUECONTENT)
STATUS = RBO.getProperty('','PMCProperty',PMCProperty)


CONO           = PMCProperty<1,4>
ACTION	        = FIELD(VALUECONTENT,"^",1)
DPTR           = FIELD(VALUECONTENT,"^",2)
COMP           = FIELD(VALUECONTENT,"^",3)
EQTY           = FIELD(VALUECONTENT,"^",4)
LPTR	        = FIELD(VALUECONTENT,"^",5)

EST.NO         = FIELD(VALUECONTENT,"^",6)
DEPT	       = FIELD(VALUECONTENT,"^",7)
TEMP.TYPE      = FIELD(VALUECONTENT,"^",8)	
TEMP.OPV       = FIELD(VALUECONTENT,"^",9)
TEMP.CODE      = FIELD(VALUECONTENT,"^",10)
TEMP.QTY       = FIELD(VALUECONTENT,"^",11)
TEMP.STD       = FIELD(VALUECONTENT,"^",12)
ERRMSG		 = ""

*KEY = CONO:EST#!DEPT#!COMP!QTY

DEPTID=CONO:EST.NO:"!":DPTR:"!":COMP:"!":EQTY

OPEN '','ESTIMATE' TO ESTIMATE ELSE RETURN
MATREAD EST.REC FROM ESTIMATE,CONO:EST.NO ELSE
     MAT EST.REC = ""
     ERRMSG="No ESTIMATE defined for this type. Try again! "
     GOTO 99999
END
OPEN '','ESTIMATE.DEPT' TO ESTIMATE.DEPT ELSE RETURN
MATREAD ESTD.REC FROM ESTIMATE.DEPT,DEPTID ELSE
     MAT ESTD.REC = ""
     ERRMSG = "CANNOT Locate ESTIMATE.DEPT"
     GOTO 99999
END

IF EQTY=EST.QTY<1,1> THEN
    EST.COMP.FLAG<1,DPTR,COMP>=""
END
DC=DCOUNT(EST.DEPT.COMP,VM)
 FOR DP=DC TO 1 STEP -1
    ESTD.ID=EST.DEPT.COMP<1,DP>
    IF FIELD(ESTD.ID,"!",1)=DPTR THEN
       IF FIELD(ESTD.ID,"!",2)=COMP THEN
	  THIS.QTY=FIELD(ESTD.ID,"!",3)
	  IF EQTY=EST.QTY<1,1> OR THIS.QTY=EQTY THEN
	     DELETE ESTIMATE.DEPT,CONO:EST.NO:"!":ESTD.ID
	     EST.DEPT.COMP=DELETE(EST.DEPT.COMP,1,DP,0)
	     EST.DEPT.COMP.HRS=DELETE(EST.DEPT.COMP.HRS,1,DP,0)
	     EST.DEPT.COMP.DCOST=DELETE(EST.DEPT.COMP.DCOST,1,DP,0)
	     EST.DEPT.COMP.COST=DELETE(EST.DEPT.COMP.COST,1,DP,0)
	     EST.DEPT.COMP.SALE=DELETE(EST.DEPT.COMP.SALE,1,DP,0)
	     EST.DEPT.COMP.TSALE=DELETE(EST.DEPT.COMP.TSALE,1,DP,0)
	     EST.DEPT.COMP.VSALE=DELETE(EST.DEPT.COMP.VSALE,1,DP,0)
	     EST.DEPT.COMP.VCOST=DELETE(EST.DEPT.COMP.VCOST,1,DP,0)
*	     CALL EST.OSP.UPD(CONO,"P",DPTR,COMP,EQTY,"")
	     REF.NO = LPTR
		VALUECONTENT = "P":"^":DPTR:"^":COMP:"^":EQTY:"^":REF.NO:"^":EST.NO:"^":DPTR:"^":TEMP.TYPE:"^":TEMP.OPV:"^":TEMP.CODE:"^":TEMP.QTY:"^":TEMP.STD
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
*		CALL EST.OSP.UPD (CONO,"R",DEPT,COMP,EQTY,TPTR)
		CALL ESTCEM_OSP_UPD
		STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
	  END
       END
    END
 NEXT DP


EST.DEPT.OSP=FIELD(FIELD(RESULT_OF_FORMULA,"~",1),"=",2)
EST.DEPT.OSP.ID=FIELD(FIELD(RESULT_OF_FORMULA,"~",2),"=",2)
EST.DEPT.OSP.UM=FIELD(FIELD(RESULT_OF_FORMULA,"~",3),"=",2)
EST.DEPT.OSP.QTY=FIELD(FIELD(RESULT_OF_FORMULA,"~",4),"=",2)
EST.DEPT.OSP.PRICE=FIELD(FIELD(RESULT_OF_FORMULA,"~",5),"=",2)

ESTDEPTINFO = EST.DEPT.COMP:"^":EST.DEPT.COMP.HRS:"^":EST.DEPT.COMP.DCOST:"^":EST.DEPT.COMP.COST:"^":EST.DEPT.COMP.SALE:"^":EST.DEPT.COMP.TSALE:"^":EST.DEPT.COMP.VSALE:"^":EST.DEPT.COMP.VCOST:"^":EST.DEPT.OSP:"^":EST.DEPT.OSP.ID:"^":EST.DEPT.OSP.UM:"^":EST.DEPT.OSP.QTY:"^":EST.DEPT.OSP.PRICE
STATUS = RBO.setProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
RETURN
*
*---- END OF PROGRAM
*
99999*
STATUS = RBO.setProperty('', 'ServerMessage', ERRMSG)
RETURN

* End of method code

