SUBROUTINE VALIDATE_PHONE_WITH_CNTY_PHONE_MASK
********************************************************************************
*   Program name :- VALIDATE_PHONE_WITH_CNTY_PHONE_MASK
*   Created:- 12/1/2006
*   Programmer :- Suhail Hussain S
*   Parameters to be passed:- 
*                 PMCProperty
*                 Option [country_code UM phone/fax/zip_number UM "phone/fax/zip string" UM "Z/P"]
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE PMC.CPYLIB COUNTRY.CODE

   OPEN '','COUNTRY.CODE' TO COUNTRY.CODE ELSE ERRMSG='COUNTRY.CODE';GOTO 91000

   STATUS = RBO.getProperty('','PMCProperty',PMCProperty)
   STATUS = RBO.getProperty('','Option',IN_VALS)

   CONO = PMCProperty<1,4>
   CTRY.CODE = IN_VALS<1,1,1>
   IP_VAL = IN_VALS<1,1,2>
   PHONE_OR_FAX = IN_VALS<1,1,3>
   IP_TYPE = IN_VALS<1,1,4>

   IF IP_TYPE = "P" THEN
      PHONE_NUM = IP_VAL
   END ELSE
      ZIP = IP_VAL
   END

   PHONE.MASK = "###-###-####"
   ZIP.MASK = "#####-####"
   PHONE.PATTRN = '3N-3N-4N'
   ZIP.PATTRN = '5N-4N'
   
   DEF.PHONE.MASK=''
   DEF.ZIP.MASK=''
   DEF.PHONE.PATTRN=''
   DEF.ZIP.PATTRN=''

   RET_PHONE = ''
   IN.PHONE.LEN = ''
   MAT CTY.REC = ""

* Insert method code here
   IF CTRY.CODE # "" THEN
      MATREAD CTY.REC FROM COUNTRY.CODE, CONO:CTRY.CODE ELSE MAT CTY.REC = ""
   END

   IF CTY.PHONE.MASK<1,1> # "" THEN
     DEF.PHONE.MASK=CTY.PHONE.MASK<1,1>
   END ELSE DEF.PHONE.MASK = PHONE.MASK
   IF CTY.PHONE.MASK<1,2> # "" THEN
     DEF.PHONE.PATTRN = CTY.PHONE.MASK<1,2>
   END ELSE DEF.PHONE.PATTRN = PHONE.PATTRN

   IF CTY.ZIP.MASK<1,1> # "" THEN
     DEF.ZIP.MASK=CTY.ZIP.MASK<1,1>
   END ELSE DEF.ZIP.MASK=ZIP.MASK
   IF CTY.ZIP.MASK<1,2> # "" THEN
     DEF.ZIP.PATTRN = CTY.ZIP.MASK<1,2>
   END ELSE DEF.ZIP.PATTRN = ZIP.PATTRN
   IF IP_TYPE = "Z" THEN
      IF DEF.ZIP.MASK # "" THEN
       IN.ZIP.LEN = LEN(DEF.ZIP.MASK) - COUNT(DEF.ZIP.MASK,'-')
         IN.ZIP.LEN1 = LEN(FIELD(DEF.ZIP.MASK,'-',1))
         IF LEN(ZIP) # IN.ZIP.LEN AND LEN(ZIP) # IN.ZIP.LEN1 AND NOT(ZIP MATCH DEF.ZIP.PATTRN) THEN
            ERRMSG = "BAD POSTAL CODE"; GOTO 91000
         END ELSE
            IF LEN(ZIP) = IN.ZIP.LEN THEN
            *  VEND.ZIP = ZIP DEF.ZIP.MASK
		 RET_PHONE = ZIP DEF.ZIP.MASK
           END ELSE
               RET_PHONE = ZIP
            END
         END
      END ELSE
         RET_PHONE = ZIP
      END
  END ELSE
      IF IP_TYPE = "P" THEN
         IF DEF.PHONE.MASK # "" THEN
           IN.PHONE.LEN = LEN(DEF.PHONE.MASK) - COUNT(DEF.PHONE.MASK,'-')
         END ELSE IN.PHONE.LEN = 10

         IF PHONE_NUM # '' THEN
            IF LEN(PHONE_NUM) # IN.PHONE.LEN AND NOT(PHONE_NUM MATCH DEF.PHONE.PATTRN) THEN
               ERRMSG = "BAD " : PHONE_OR_FAX : " NUMBER"; GOTO 91000
            END ELSE
               IF LEN(PHONE_NUM) = IN.PHONE.LEN AND NOT(INDEX(PHONE_NUM,'-',1)) THEN
                  RET_PHONE = PHONE_NUM DEF.PHONE.MASK
               END ELSE
                  IF INDEX(PHONE_NUM,'-',1) THEN
                     IF NOT(PHONE_NUM MATCH DEF.PHONE.PATTRN) THEN
                        ERRMSG = "BAD " : PHONE_OR_FAX : " NUMBER" ; GOTO 91000
                     END ELSE RET_PHONE = PHONE_NUM
                  END ELSE
                     RET_PHONE = PHONE_NUM
                  END
               END
            END
         END
      END
   END

   STATUS = RBO.setProperty('','FILE_NAME',RET_PHONE)
RETURN

* End of method code
91000:
   STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
   STATUS = RBO.setProperty('','ServerStatus',1)
RETURN


