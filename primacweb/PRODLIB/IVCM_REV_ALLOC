SUBROUTINE IVCM_REV_ALLOC
********************************************************************************
*   Program name :- IVCM_REV_ALLOC
*   Created:- 8/29/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H

$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE JCS.CPYLIB INVOICE
$INCLUDE PMC.CPYLIB SHIP.VIA
$INCLUDE JCS.CPYLIB JOB
$INCLUDE PMC.CPYLIB COA
$INCLUDE CPYLIB CHAR
$INCLUDE JES.CPYLIB ESTIMATE.JOB
$INCLUDE PMC.CPYLIB INVOICE.CODE
$INCLUDE PMC.CPYLIB GLTABLE
$INCLUDE PMC.CPYLIB DIVISION
$INCLUDE PMC.CPYLIB DEPARTMENT
$INCLUDE PMC.CPYLIB COST.CNTR
$INCLUDE PMC.CPYLIB SALES.CODE
* Insert method code here
ERRMSG = ''

OPEN 'CONTROL' TO CONTROL ELSE
      ERRMSG='CANNOT OPEN CONTROL FILE'
      GOTO 99999
END
OPEN 'COMPANY' TO COMPANY ELSE
      ERRMSG='CANNOT OPEN COMPANY FILE'
      GOTO 99999
END
OPEN 'ESTIMATE.JOB' TO ESTIMATE.JOB ELSE
      ERRMSG='CANNOT OPEN ESTIMATE.JOB FILE'
      GOTO 99999
END
OPEN 'COA' TO COA ELSE
      ERRMSG='CANNOT OPEN COA FILE'
      GOTO 99999
END
OPEN 'JOB' TO JOB ELSE
      ERRMSG='CANNOT OPEN JOB FILE'
      GOTO 99999
END
OPEN 'INVOICE' TO INVOICE ELSE
      ERRMSG='CANNOT OPEN INVOICE FILE'
      GOTO 99999
END

OPEN 'INVOICE.CODE' TO INVOICE.CODE ELSE
      ERRMSG='CANNOT OPEN INVOICE.CODE FILE'
      GOTO 99999
END

OPEN 'ESTIMATE.JOB' TO ESTIMATE.JOB ELSE
      ERRMSG='CANNOT OPEN ESTIMATE.JOB FILE'
      GOTO 99999
END

OPEN 'DIVISION' TO DIVISION ELSE
      ERRMSG='CANNOT OPEN DIVISION FILE'
      GOTO 99999
END
OPEN 'DEPARTMENT' TO DEPARTMENT ELSE
      ERRMSG='CANNOT OPEN DEPARTMENT FILE'
      GOTO 99999
END

OPEN 'COST.CNTR' TO COST.CNTR ELSE
      ERRMSG='CANNOT OPEN COST.CNTR FILE'
      GOTO 99999
END

OPEN "","SALES.CODE" TO SALES.CODE ELSE ERRMSG="SALES.CODE FILE IS MISSING"; GOTO 99999

DIM ALLOC.REC(7)
EQU ALL.SEQ TO ALLOC.REC(1)
EQU ALL.DIV TO ALLOC.REC(2)
EQU ALL.DEP TO ALLOC.REC(3)
EQU ALL.CCT TO ALLOC.REC(4)
EQU ALL.EST TO ALLOC.REC(5)
EQU ALL.DIS TO ALLOC.REC(6)
EQU ALL.PER TO ALLOC.REC(7)

MAT ALLOC.REC = ""
GCCT = "000"
GDEP = "00"
GDIV = "00"

*VAL = RBO.getProperty('','Cono',CONO)

STATUS=RBO.getProperty('','PMCProperty',PMCProperty)
CONO = PMCProperty<1,4>

MATREAD GLTABLE.REC FROM CONTROL, CONO:'GLTABLE' ELSE MAT GLTABLE.REC = ''
VAL = RBO.getProperty('','JOB_EST',JOB.EST) ; * has to get JOB.ESTIMATE
VAL = RBO.getProperty('','JOB_NO',JOB.NO) ; * job no
VAL = RBO.getProperty('','REF_NO',REF.NO) ; * is the row no
VAL = RBO.getProperty('','JOB_INV_BAL',LINE.AMT); * amount
VAL = RBO.getProperty('','IVC_NO',IVC.NO); * invoice no
VAL = RBO.getProperty('','DI_ALLOC_DIV_MV',DI_IVC.ALLOC.DIV); * 
VAL = RBO.getProperty('','DI_ALLOC_AMT_MV',DI_IVC.ALLOC.AMT); * 

MATREAD IVC.REC FROM INVOICE,CONO:IVC.NO ELSE
	MAT IVC.REC = ''
END

MATREAD COMP.REC FROM COMPANY, CONO ELSE
	ERRMSG='CANNOT READ COMPANY FILE'
      	GOTO 99999
END

	VAL = RBO.getProperty('','DI_CHG_CODE',IVC.CHG.CODE); * GRID CODE (FROM 2ND GRID)
	MATREAD INC.REC FROM INVOICE.CODE,CONO:IVC.CHG.CODE ELSE MAT INC.REC = ''

	VAL = RBO.getProperty('','DI_CHG_JOB',IVC.CHG.JOB); * JOB NO (in some cases the Grid code asks for Job No)

* IVC.CHG.CODE AND IVC.CHG.CAT ARE SAME ; SO 
*VAL = RBO.getProperty('','CRD_MODE',IVC.CHG.CAT); * invoice no category (GRID C0DE CATEGORY)
IVC.CHG.CAT = IVC.CHG.CODE
***************

MATREAD SLC.REC FROM SALES.CODE, CONO:IVC.CHG.CODE ELSE
	MAT SLC.REC = ""
END

COA.LEVEL = 0

IF IVC.ALLOC.DIV<1,REF.NO> # "" THEN
	COA.LEVEL = 2
END ELSE
	COA.LEVEL = 0
END

BEGIN CASE
      	CASE IVC.CHG.CODE = "JOB" OR IVC.CHG.CODE = "JOB1" OR IVC.CHG.CAT = "OTH"
      		IF SLC.GL.ACCT = "" OR SLC.GL.ACCT = 0 THEN
              	MATREAD COA.REC FROM COA, CONO:GLTB.SALES ELSE COA.LEVEL = 0
            	END ELSE
             		MATREAD COA.REC FROM COA, CONO:SLC.GL.ACCT ELSE COA.LEVEL = 0
            	END
      	CASE IVC.CHG.CODE = "DSC" OR INC.CATEGORY = "DSC"
* T20298
            IF SLC.DS.ACCT = "" OR SLC.DS.ACCT = 0 THEN
               MATREAD COA.REC FROM COA, CONO:GLTB.TRADE.DISC ELSE COA.LEVEL = 0
            END ELSE
               MATREAD COA.REC FROM COA, CONO:SLC.DS.ACCT ELSE COA.LEVEL = 0
            END
      	CASE IVC.CHG.CAT = "MSC"
            MATREAD SLC.REC FROM SALES.CODE, CONO:IVC.TAX.JURS ELSE
               MAT SLC.REC = ""
            END
            BEGIN CASE
               CASE SLC.GL.ACCT # ""
                  MATREAD COA.REC FROM COA, CONO : SLC.GL.ACCT ELSE COA.LEVEL = 0
               CASE 1
                  MATREAD COA.REC FROM COA, CONO:GLTB.SALES ELSE COA.LEVEL = 0
            END CASE
       CASE 1
            IF SLC.GL.ACCT # "" THEN
               MATREAD COA.REC FROM COA, CONO:SLC.GL.ACCT  ELSE COA.LEVEL = 0
            END ELSE
               MATREAD COA.REC FROM COA, CONO:GLTB.SALES ELSE COA.LEVEL = 0
            END
END CASE

* 22870
IF IVC.CHG.JOB # "" THEN
	JOBNO = IVC.CHG.JOB
END

IF CO.REV.DIST # "" THEN
	BEGIN CASE
      		CASE CO.REV.DIST = "E" 
        		IF JOB.EST # "" THEN
          			GOTO 4000
        		END ELSE
          			IF JOB.NO # "" THEN
					GOTO 5000
          			END ELSE
            				GOTO 6000
					GOTO 6050
          			END
        		END
      		CASE CO.REV.DIST = "J" 
        		IF JOB.NO # "" THEN
          			GOTO 5000
        		END ELSE
          			GOTO 6000
        		END
      		CASE 1
        		GOTO 6000
    	END CASE
END ELSE
	BEGIN CASE
      		CASE COA.LEVEL = 0 ;* IF IVC.ALLOC.DIV<1,REF.NO> = ""
        		BEGIN CASE 
          			CASE JOB.EST # ""
            				GOTO 4000
          			CASE JOB.NO # ""
            				GOTO 5000
        		END CASE
      		CASE 1
        		GOTO 6000
    	END CASE
END


4000 * GET ESTIMATE
MATREAD ESTJ.REC FROM ESTIMATE.JOB, CONO:JOB.NO ELSE
	ERRMSG = "No estimate for this job"
	GOTO 99999
END

LB.CNT = DCOUNT(ESTJ.LB.DEPT,VM)
MT.CNT = DCOUNT(ESTJ.MT.DEPT,VM)
OS.CNT = DCOUNT(ESTJ.OS.DEPT,VM)
SP.CNT = DCOUNT(ESTJ.SP.DEPT,VM)
MS.CNT = DCOUNT(ESTJ.MS.DEPT,VM)
*
DIM EST.TOT(2)
MAT EST.TOT = ""
IF COA.LEVEL = 0 THEN 
	HOLD.DIV = GDIV
END ELSE
	HOLD.DIV = JOB.DIV
END

4200 *
IF LB.CNT = 0 THEN GOTO 4210
FOR X = 1 TO LB.CNT
	BEGIN CASE
		CASE COA.LEVEL = 3
       		DEPT.CCST = ESTJ.LB.DEPT<1,X>:ESTJ.LB.CCTR<1,X>
      		CASE COA.LEVEL = 2
        		DEPT.CCST = ESTJ.LB.DEPT<1,X>:GCCT
      		CASE COA.LEVEL < 2
        		DEPT.CCST = GDEP:GCCT
    	END CASE
    	DEPT.CCST.SALE = ESTJ.LB.SALE<1,X>
    	GOSUB 4500
NEXT X

4210 *
IF MT.CNT = 0 THEN GO 4220
FOR Y = 1 TO MT.CNT
	BEGIN CASE
      		CASE COA.LEVEL = 3
        		DEPT.CCST = ESTJ.MT.DEPT<1,Y>:ESTJ.MT.CCTR<1,Y>
      		CASE COA.LEVEL = 2
        		DEPT.CCST = ESTJ.MT.DEPT<1,Y>:GCCT
      		CASE COA.LEVEL < 2
        		DEPT.CCST = GDEP:GCCT
    	END CASE
    	DEPT.CCST.SALE = ESTJ.MT.SALE<1,Y>
    	GOSUB 4500
NEXT Y

4220 *
IF OS.CNT = 0 THEN GOTO 4230
FOR Z = 1 TO OS.CNT
	BEGIN CASE
      		CASE COA.LEVEL = 3
        		DEPT.CCST = ESTJ.OS.DEPT<1,Z>:ESTJ.OS.CCTR<1,Z>
      		CASE COA.LEVEL = 2
        		DEPT.CCST = ESTJ.OS.DEPT<1,Z>:GCCT
      		CASE COA.LEVEL < 2
        		DEPT.CCST = GDEP:GCCT
    	END CASE
    	DEPT.CCST.SALE = ESTJ.OS.SALE<1,Z>
    	GOSUB 4500
NEXT Z

4230 *
IF SP.CNT = 0 THEN GOTO 4240
FOR R = 1 TO SP.CNT
	BEGIN CASE
      		CASE COA.LEVEL = 3
        		DEPT.CCST = ESTJ.SP.DEPT<1,R>:ESTJ.SP.CCTR<1,R>
      		CASE COA.LEVEL = 2
        		DEPT.CCST = ESTJ.SP.DEPT<1,R>:GCCT
      		CASE COA.LEVEL < 2
        		DEPT.CCST = GDEP:GCCT
    	END CASE
    	DEPT.CCST.SALE = ESTJ.SP.SALE<1,R>
    	GOSUB 4500
NEXT R

4240 *
IF MS.CNT = 0 THEN GOTO 4250
FOR S = 1 TO MS.CNT
	BEGIN CASE
		CASE COA.LEVEL = 3
       		DEPT.CCST = ESTJ.MS.DEPT<1,S>:ESTJ.MS.CCTR<1,S>
	      	CASE COA.LEVEL = 2
       		DEPT.CCST = ESTJ.MS.DEPT<1,S>:GCCT
	      	CASE COA.LEVEL < 2
       		DEPT.CCST = GDEP:GCCT
	END CASE
	DEPT.CCST.SALE = ESTJ.MS.SALE<1,S>
	GOSUB 4500
NEXT S

4250 *
GOTO 4520
*

4500 * LOAD EST IN ARRAY
LOCATE HOLD.DIV:DEPT.CCST IN EST.TOT(1)  SETTING DCP ELSE GOTO 4510
*EST.TOT(2)<DCP> = EST.TOT(2)<DCP> + DEPT.CCST.SALE
GOTO 4515
*

4510 * INSERT NEW DEPT.CSST
*  EST.TOT(1)<DCP> = HOLD.DIV:DEPT.CCST
*  EST.TOT(2)<DCP> = DEPT.CCST.SALE

4515 *
GOTO 99999
*RETURN

4520 *
IF EST.TOT(1) = "" THEN GOTO 4599
DONE = 0
E = 0
LOOP
	WHILE DONE = 0
	E = E + 1
	IF EST.TOT(1)<E> = "" THEN DONE = 1
	ALL.SEQ<1,E> = E
	ALL.DIV<1,E> = EST.TOT(1)<E>[1,2]
	ALL.DEP<1,E> = EST.TOT(1)<E>[3,2]
	ALL.CCT<1,E> = EST.TOT(1)<E>[5,3]
	ALL.EST<1,E> = OCONV(EST.TOT(2)<E>,'MD2')
	EST.PER = EST.TOT(2)<E> / ESTJ.TOT.SALE
*	T25874 ALL.DIS<1,E> = INT(LINE.AMT * EST.PER)	
	*ALL.DIS<1,E> = OCONV((LINE.AMT * EST.PER),'MD0')
	ALL.DIS<1,E> = OCONV((LINE.AMT * EST.PER),'MD2')
	ALL.PER<1,E> = OCONV(EST.PER * 1000000,'MD4')

REPEAT
TOT.DIS = SUM(ALL.DIS)
AMT.REM = LINE.AMT - TOT.DIS
IF AMT.REM # 0 THEN
	ALL.DIS<1,1> = ALL.DIS<1,1> + AMT.REM
END
ALL.SEQ = DELETE(ALL.SEQ,1,E,0)
LINES = E - 1
LN = 1
4599 *
GOTO 99999
*RETURN
*

5000 * GET JOB ACTUAL
MATREAD JOB.REC FROM JOB, CONO:JOB.NO ELSE
	ERRMSG = "No record for this job"
    	GOTO 99999
END
HOLD.DIV = 0

IF COA.LEVEL = 0 THEN 
	HOLD.DIV = GDIV
END ELSE
	HOLD.DIV = JOB.DIV
END

LB.CNT = DCOUNT(JOB.LB.DEPT,VM)
MT.CNT = DCOUNT(JOB.MT.DEPT,VM)
OS.CNT = DCOUNT(JOB.OS.DEPT,VM)
SP.CNT = DCOUNT(JOB.SP.DEPT,VM)
MS.CNT = DCOUNT(JOB.MS.DEPT,VM)
*

DIM JOB.TOT(2)
MAT JOB.TOT = ""
5200 *
IF LB.CNT = 0 THEN GOTO 5210
FOR X = 1 TO LB.CNT
	BEGIN CASE
		CASE COA.LEVEL = 3
			DEPT.CCST = JOB.LB.DEPT<1,X>:JOB.LB.CCTR<1,X>
		CASE COA.LEVEL = 2
       		DEPT.CCST = JOB.LB.DEPT<1,X>:GCCT
      		CASE COA.LEVEL < 2
       		DEPT.CCST = GDEP:GCCT
    	END CASE
    	DEPT.CCST.SALE = JOB.LB.SALE<1,X>
    	GOSUB 5500
NEXT X

5210 *
IF MT.CNT = 0 THEN GO 5220
FOR Y = 1 TO MT.CNT
	BEGIN CASE
      		CASE COA.LEVEL = 3
        		DEPT.CCST = JOB.MT.DEPT<1,Y>:JOB.MT.CCTR<1,Y>
      		CASE COA.LEVEL = 2
        		DEPT.CCST = JOB.MT.DEPT<1,Y>:GCCT
      		CASE COA.LEVEL < 2
        		DEPT.CCST = GDEP:GCCT
    	END CASE
    	DEPT.CCST.SALE = JOB.MT.SALE<1,Y>
	GOSUB 5500
NEXT Y

5220 *
IF OS.CNT = 0 THEN GOTO 5230
FOR Z = 1 TO OS.CNT
	BEGIN CASE
		CASE COA.LEVEL = 3
			DEPT.CCST = JOB.OS.DEPT<1,Z>:JOB.OS.CCTR<1,Z>
		CASE COA.LEVEL = 2
       		DEPT.CCST = JOB.OS.DEPT<1,Z>:GCCT
      		CASE COA.LEVEL < 2
        		DEPT.CCST = GDEP:GCCT
    	END CASE
	DEPT.CCST.SALE = JOB.OS.SALE<1,Z>
    	GOSUB 5500
NEXT Z

5230 *
IF SP.CNT = 0 THEN GOTO 5240
FOR R = 1 TO SP.CNT
	BEGIN CASE
		CASE COA.LEVEL = 3
			DEPT.CCST = JOB.SP.DEPT<1,R>:JOB.SP.CCTR<1,R>
      		CASE COA.LEVEL = 2
       		DEPT.CCST = JOB.SP.DEPT<1,R>:GCCT
      		CASE COA.LEVEL < 2
       		DEPT.CCST = GDEP:GCCT
    	END CASE
	DEPT.CCST.SALE = JOB.SP.SALE<1,R>
	GOSUB 5500
NEXT R

5240 *
IF MS.CNT = 0 THEN GOTO 5250
FOR S = 1 TO MS.CNT
	BEGIN CASE
		CASE COA.LEVEL = 3
			DEPT.CCST = JOB.MS.DEPT<1,S>:JOB.MS.CCTR<1,S>
      		CASE COA.LEVEL = 2
       		DEPT.CCST = JOB.MS.DEPT<1,S>:GCCT
      		CASE COA.LEVEL < 2
       		DEPT.CCST = GDEP:GCCT
    	END CASE
    	DEPT.CCST.SALE = JOB.MS.SALE<1,S>
    	GOSUB 5500
NEXT S

5250 *
GOTO 5520
*

5500 * LOAD EST IN ARRAY
LOCATE HOLD.DIV:DEPT.CCST IN JOB.TOT(1)  SETTING DCP ELSE GOTO 5510
JOB.TOT(2)<DCP> = JOB.TOT(2)<DCP> + DEPT.CCST.SALE

GOTO 5515
*

5510 * INSERT NEW DEPT.CSST
JOB.TOT(1)<DCP> = HOLD.DIV:DEPT.CCST
JOB.TOT(2)<DCP> = DEPT.CCST.SALE

5515*
GOTO 99999
*RETURN

5520 *
IF SUM(JOB.TOT(2)) = 0 THEN GOTO 5599
DONE = 0
E = 0
LOOP
	WHILE DONE = 0
		E = E + 1
		IF JOB.TOT(1)<E> = "" THEN DONE = 1
		ALL.SEQ<1,E> = E
		ALL.DIV<1,E> = JOB.TOT(1)<E>[1,2]
		ALL.DEP<1,E> = JOB.TOT(1)<E>[3,2]
		ALL.CCT<1,E> = JOB.TOT(1)<E>[5,3]
		ALL.EST<1,E> = OCONV(JOB.TOT(2)<E>,'MD2')

		IF JOB.TOT.SALE+0 # 0 THEN
			JOB.PER = JOB.TOT(2)<E> / JOB.TOT.SALE
		END ELSE
			JOB.PER = 1
		END
		*T25874 ALL.DIS<1,E> = INT(LINE.AMT * JOB.PER) here
		ALL.DIS<1,E> = LINE.AMT * JOB.PER ; * COMMENTED AND ADDED NEXT LINE TO ADD OCONV WITH MD2
		
		*ALL.DIS<1,E> = OCONV(ALL.DIS<1,E>,'MD2')

		ALL.PER<1,E> = OCONV(JOB.PER * 1000000,'MD4')
	**********************************
		READV DIV.DESC FROM DIVISION,CONO:ALL.DIV<1,E>,1 THEN
			DIV_DESC<1,E>=DIV.DESC
		END
		READV DEPT.DESC FROM DEPARTMENT,CONO:ALL.DEP<1,E>,2 THEN
			DEPT_DESC<1,E>=DEPT.DESC
		END
		READV CCTR.DESC FROM COST.CNTR,CONO:ALL.CCT<1,E>,1 THEN
			CCT_DESC<1,E>=CCTR.DESC
		END

		IF ALL.DIV<1,E>='00' THEN 	DIV_DESC<1,E>='GEN DIV'
		
		IF ALL.DEP<1,E>='00' THEN	DEPT_DESC<1,E>='GEN DEPT'
		
		IF ALL.CCT<1,E>='000' THEN	CCT_DESC<1,E>='GEN CCTRS'
		
	******************************************************************
REPEAT

TOT.DIS = SUM(ALL.DIS)
AMT.REM = LINE.AMT - TOT.DIS
IF AMT.REM # 0 THEN
	ALL.DIS<1,1> = ALL.DIS<1,1> + AMT.REM
END
ALL.SEQ = DELETE(ALL.SEQ,1,E,0)
LINES = E - 1
LN = 1

5599 *
GOTO 99999

6000 * GET INVOICE ALLOCATION

ICNT = DCOUNT(DI_IVC.ALLOC.DIV<1,REF.NO>,SVM)
T.ALL = SUM(DI_IVC.ALLOC.AMT<1,REF.NO>)

IF JOB.EST # '' AND IVC.NO # 'N' THEN
	
	FOR I = 1 TO ICNT
		ALL.SEQ<1,I> = I
	      	ALL.DIV<1,I> = DI_IVC.ALLOC.DIV<1,REF.NO,I>[1,2]
	      	ALL.DEP<1,I> = DI_IVC.ALLOC.DIV<1,REF.NO,I>[3,2]	
	      	ALL.CCT<1,I> = DI_IVC.ALLOC.DIV<1,REF.NO,I>[5,3]
	      	ALL.EST<1,I> = '0.00'
	 	*READV NAME FROM INVENTORY ,ID,1 ELSE NAME = ID
	      	T.PER = DI_IVC.ALLOC.AMT<1,REF.NO,I>/ T.ALL
	      	DI_IVC.ALLOC.AMT<1,REF.NO,I> = OCONV((LINE.AMT * T.PER),'MD0')
	 	ALL.DIS<1,I> = OCONV(DI_IVC.ALLOC.AMT<1,REF.NO,I>,'MD2')
	      ALL.PER<1,I> = (DI_IVC.ALLOC.AMT<1,REF.NO,I> / LINE.AMT) * 100.00
	      ALL.PER<1,I> = OCONV(ALL.PER<1,I> * 10000,'MD4')
	NEXT I
	LINES = ICNT
	LN = 1
*
GOTO 99999
END


IF JOB.EST # '' AND IVC.NO = 'N' THEN
	MATREAD ESTJ.REC FROM ESTIMATE.JOB,CONO:JOB.NO ELSE 
	*		ESTJ_LB_DEPT = ESTJ.LB.DEPT
	END 
GOTO 8000

END

6050 * PROCESSING WHEN EST.JOB IS NULL

IF JOB.EST = '' THEN
	MATREAD JOB.REC FROM JOB,CONO:JOB.NO ELSE 
	*		ESTJ_LB_DEPT = ESTJ.LB.DEPT
	END 
	TMP_JOB.LB.CNT 	= DCOUNT(JOB.LB.DEPT,VM)
	TMP_JOB.MT.CNT 	= DCOUNT(JOB.MT.DEPT,VM)
	TMP_JOB.OS.CNT 	= DCOUNT(JOB.OS.DEPT,VM)
	TMP_JOB.SP.CNT 	= DCOUNT(JOB.SP.DEPT,VM)
	TMP_JOB.MS.CNT 	= DCOUNT(JOB.MS.DEPT,VM)
	TMP_JOB.TOT.SALE 	= JOB.TOT.SALE
	COMB_CNT = ''

	IF TMP_JOB.LB.CNT # 0 THEN
		FOR I = 1 TO TMP_JOB.LB.CNT
			ALL.DEP<1,I> 	= JOB.LB.DEPT<1,I>
			ALL.CCT<1,I> 	= JOB.LB.CCTR<1,I>
			ALL.EST<1,I>	= OCONV(JOB.LB.SALE<1,I>,'MD2')
			ALL.PER<1,I> = (JOB.LB.SALE<1,I> / JOB.TOT.SALE) * 100.00
			ALL.DIS<1,I> = OCONV(ALL.PER<1,I> * OCONV(LINE.AMT,'MD2'),'MD2')
			ALL.DIV<1,I>	= JOB.DIV
		NEXT I
	COMB_CNT = I	
	END
	IF TMP_JOB.MT.CNT # 0 THEN
		FOR I = 1 TO TMP_JOB.MT.CNT
			ALL.DEP<1,COMB_CNT> = JOB.MT.DEPT<1,I>
			ALL.CCT<1,COMB_CNT> = JOB.MT.CCTR<1,I>
			ALL.EST<1,COMB_CNT>	= OCONV(JOB.MT.SALE<1,I>,'MD2')
			ALL.PER<1,COMB_CNT> = (JOB.MT.SALE<1,I> / JOB.TOT.SALE) * 100.00
			ALL.DIS<1,COMB_CNT> = OCONV(ALL.PER<1,COMB_CNT> * OCONV(LINE.AMT,'MD2'),'MD2')
			ALL.DIV<1,COMB_CNT>	= JOB.DIV
		COMB_CNT = COMB_CNT + 1
		NEXT I
	END
	IF TMP_JOB.OS.CNT # 0 THEN
		FOR I = 1 TO TMP_JOB.OS.CNT
			ALL.DEP<1,COMB_CNT> = JOB.OS.DEPT<1,I>
			ALL.CCT<1,COMB_CNT> = JOB.OS.CCTR<1,I>
			ALL.EST<1,COMB_CNT>	= OCONV(JOB.OS.SALE<1,I>,'MD2')
			ALL.PER<1,COMB_CNT> = (JOB.OS.SALE<1,I> / JOB.TOT.SALE) * 100.00
			ALL.DIS<1,COMB_CNT> = OCONV(ALL.PER<1,COMB_CNT> * OCONV(LINE.AMT,'MD2'),'MD2')
			ALL.DIV<1,COMB_CNT>	= JOB.DIV
		COMB_CNT = COMB_CNT + 1
		NEXT I
	END
	IF TMP_JOB.SP.CNT # 0 THEN
		FOR I = 1 TO TMP_JOB.SP.CNT
			ALL.DEP<1,COMB_CNT> = JOB.SP.DEPT<1,I>
			ALL.CCT<1,COMB_CNT> = JOB.SP.CCTR<1,I>
			ALL.EST<1,COMB_CNT>	= OCONV(JOB.SP.SALE<1,I>,'MD2')
			ALL.PER<1,COMB_CNT> = (JOB.SP.SALE<1,I> / JOB.TOT.SALE) * 100.00
			ALL.DIS<1,COMB_CNT> = OCONV(ALL.PER<1,COMB_CNT> * OCONV(LINE.AMT,'MD2'),'MD2')
			ALL.DIV<1,COMB_CNT>	= JOB.DIV
		COMB_CNT = COMB_CNT + 1
		NEXT I
	END
	IF TMP_JOB.MS.CNT # 0 THEN
		FOR I = 1 TO TMP_JOB.MS.CNT
			ALL.DEP<1,COMB_CNT> = JOB.MS.DEPT<1,I>
			ALL.CCT<1,COMB_CNT> = JOB.MS.CCTR<1,I>
			ALL.EST<1,COMB_CNT>	= OCONV(JOB.MS.SALE<1,I>,'MD2')
			ALL.PER<1,COMB_CNT> = (JOB.MS.SALE<1,I> / JOB.TOT.SALE) * 100.00
			ALL.DIS<1,COMB_CNT> = OCONV(ALL.PER<1,COMB_CNT> * OCONV(LINE.AMT,'MD2'),'MD2')
			ALL.DIV<1,COMB_CNT>	= JOB.DIV
		COMB_CNT = COMB_CNT + 1
		NEXT I
	END

TEMP_ALL.EST = ''
TEMP_ALL.DIS = ''
TEMP_ALL.PER = ''
TEMP_ALL.DIV = ''
TEMP_ALL.DEP = ''
TEMP_ALL.CCT = ''

TEMP_ALL_EST_TOT = ''
TEMP_ALL_DIS_TOT = ''
TEMP_ALL_PER_TOT = ''

TEMP_ARR = '0'
FIRSTIME = ''
ISEXISTED = ''
ALL.DEP.OTH = ALL.DEP
*******************************

***********************************
TMP_CNT = 0
K = ''
X=1
	FOR J = 1 TO COMB_CNT-1
		IF ALL.DEP<1,J> # "" THEN
			FOR ZZ = J+1 TO COMB_CNT	
				IF ALL.DEP<1,ZZ> # "" THEN
					IF ALL.DEP<1,J> = ALL.DEP<1,ZZ> AND ALL.CCT<1,J> = ALL.CCT<1,ZZ> THEN
							IF TEMP_ALL.EST<1,X> = ""	THEN					 
								FIRSTIME= ALL.EST<1,J> + ALL.EST<1,ZZ>
							END ELSE
								FIRSTIME = ALL.EST<1,ZZ>
							END
	
						*TEMP_ALL.EST<1,X> 	=  TEMP_ALL.EST<1,X> + ALL.EST<1,J> + ALL.EST<1,ZZ>
						TEMP_ALL.EST<1,X> 	=  TEMP_ALL.EST<1,X> + FIRSTIME

						TEMP_ALL.DIS<1,X>	=  TEMP_ALL.DIS<1,X> + ALL.DIS<1,J> + ALL.DIS<1,ZZ>
				 		TEMP_ALL.PER<1,X> 	=  TEMP_ALL.PER<1,X> + ALL.PER<1,J> + ALL.PER<1,ZZ> 
						TEMP_ALL.DIV<1,X>	=  ALL.DIV<1,J>
						TEMP_ALL.DEP<1,X>	=  ALL.DEP<1,J>
						TEMP_ALL.CCT<1,X> 	=  ALL.CCT<1,J>
								K = FIRSTIME
								ALL.EST = DELETE(ALL.EST,1,ZZ,0)
								
	*							ALL.DIS = DELETE(ALL.DIS,1,ZZ,0)
	*							ALL.PER = DELETE(ALL.PER,1,ZZ,0)
	*							ALL.DIV = DELETE(ALL.DIV,1,ZZ,0)
	*							ALL.DEP = DELETE(ALL.DEP,1,ZZ,0)
	*							ALL.CCT = DELETE(ALL.CCT,1,ZZ,0)
	*					TMP_CNT = TMP_CNT + 1
	*				TEMP_ARR = TEMP_ARR + 1
					END ELSE
						*IF ALL.DEP<1,J> # "" THEN
							TEMP_ALL.EST<1,X> 	= ALL.EST<1,J>
							TEMP_ALL.DIS<1,X> 	= ALL.DIS<1,J>
							TEMP_ALL.PER<1,X> 	= ALL.PER<1,J>
							TEMP_ALL.DIV<1,X> 	= ALL.DIV<1,J>
							TEMP_ALL.DEP<1,X> 	= ALL.DEP<1,J>
							TEMP_ALL.CCT<1,X> 	= ALL.CCT<1,J>
							ALL.EST = DELETE(ALL.EST,1,J,0)

						*END 
						*J = J - 1
					END
				END
			NEXT ZZ
			X = X+1
		END
	NEXT J
***************************************

VAL = RBO.setProperty('','ALL_DIV',TEMP_ALL.DIV<1>)
VAL = RBO.setProperty('','ALL_DEP',TEMP_ALL.DEP<1>)
VAL = RBO.setProperty('','ALL_DIS',TEMP_ALL.DIS<1>)
VAL = RBO.setProperty('','ALL_CCT',TEMP_ALL.CCT<1>)
VAL = RBO.setProperty('','ALL_EST',TEMP_ALL.EST<1>)
VAL = RBO.setProperty('','GRID_TOT_AMT',TMP_JOB.TOT.SALE)
*VAL = RBO.setProperty('','ALL_DIS',ALL.DIS<1>)
VAL = RBO.setProperty('','ALL_PER',TEMP_ALL.PER<1>)
END

	
7000 * TOTAL ALLOC
TOT.EST = SUM(ALL.EST)
TOT.DIS = SUM(ALL.DIS)
TOT.PER = SUM(ALL.PER)
AMT.REM = LINE.AMT - TOT.DIS

ESTJ_LB_DEPT = ''

8000 * IF INVOICE NO IS NEW 'N'

*		IF IVC.NO = 'N' THEN
*			MATREAD ESTJ.REC FROM ESTIMATE.JOB,CONO:JOB.NO ELSE 
*		*		ESTJ_LB_DEPT = ESTJ.LB.DEPT
*			END 
*		END

LB.CNT = DCOUNT(ESTJ.LB.DEPT,VM)

FOR I = 1 TO LB.CNT
	ALL.PER<1,I> = (ESTJ.LB.SALE<1,I> / ESTJ.TOT.SALE) * 100.00
	ALL.DIS<1,I> = OCONV(ALL.PER<1,I> * OCONV(LINE.AMT,'MD2'),'MD2')
	ALL.EST<1,I> = OCONV(ESTJ.LB.SALE<1,I>,'MD2')
	ALL.DIV<1,I> = ESTJ.DIV
	ALL.DEP<1,I> = ESTJ.LB.DEPT<1,I>
	ALL.CCT<1,I> = ESTJ.LB.CCTR<1,I>
NEXT I

TEMP_CNT = DCOUNT(ALL.DEP,VM)
X=1

TEMP_ALL.EST = ''
TEMP_ALL.DIS = ''
TEMP_ALL.PER = ''
TEMP_ALL.DIV = ''
TEMP_ALL.DEP = ''
TEMP_ALL.CCT = ''


FOR J = 1 TO TEMP_CNT
	IF ALL.DEP<1,J> = ALL.DEP<1,J+1> AND ALL.CCT<1,J> = ALL.CCT<1,J+1> THEN
		TEMP_ALL.EST<1,X> 	= ALL.EST<1,J> + ALL.EST<1,J+1>
		TEMP_ALL.DIS<1,X>	= ALL.DIS<1,J> + ALL.DIS<1,J+1>
 		TEMP_ALL.PER<1,X> 	= ALL.PER<1,J> + ALL.PER<1,J+1>
		TEMP_ALL.DIV<1,X>	= ALL.DIV<1,J+1>
		TEMP_ALL.DEP<1,X>	= ALL.DEP<1,J+1>
		TEMP_ALL.CCT<1,X> 	= ALL.CCT<1,J+1>	
	END ELSE
		TEMP_ALL.EST<1,X> 	= ALL.EST<1,J>
		TEMP_ALL.DIS<1,X> 	= ALL.DIS<1,J>
		TEMP_ALL.PER<1,X> 	= ALL.PER<1,J>
		TEMP_ALL.DIV<1,X> 	= ALL.DIV<1,J>
		TEMP_ALL.DEP<1,X> 	= ALL.DEP<1,J>
		TEMP_ALL.CCT<1,X> 	= ALL.CCT<1,J>
	END
X = X+1
NEXT J

*VAL = RBO.setProperty('','ALL_DIV',TEMP_ALL.DIV<1>)

VAL = RBO.setProperty('','ALL_DIV',TEMP_ALL.DIV<1>)
VAL = RBO.setProperty('','ALL_DEP',TEMP_ALL.DEP<1>)
VAL = RBO.setProperty('','ALL_DIS',TEMP_ALL.DIS<1>)
VAL = RBO.setProperty('','ALL_CCT',TEMP_ALL.CCT<1>)
VAL = RBO.setProperty('','ALL_EST',TEMP_ALL.EST<1>)
VAL = RBO.setProperty('','GRID_TOT_AMT',ESTJ.TOT.SALE<1>)
*VAL = RBO.setProperty('','ALL_DIS',ALL.DIS<1>)
VAL = RBO.setProperty('','ALL_PER',TEMP_ALL.PER<1>)
RETURN


99999 *
VAL = RBO.setProperty('','ALL_DIV',ALL.DIV<1>)
VAL = RBO.setProperty('','ALL_DEP',ALL.DEP<1>)
VAL = RBO.setProperty('','ALL_CCT',ALL.CCT<1>)
VAL = RBO.setProperty('','ALL_EST',ALL.EST<1>)
VAL = RBO.setProperty('','GRID_TOT_AMT','0.00')
FOR I  =  1 TO DCOUNT(ALL.DIS,@VM)
	ALL_DIS<1,I> = OCONV(ALL_DIS<1,I>,'MD2')
NEXT I

VAL = RBO.setProperty('','ALL_DIS',ALL.DIS<1>)
VAL = RBO.setProperty('','ALL_PER',ALL.PER<1>)
VAL = RBO.setProperty('','DIV_DESC',DIV_DESC<1>)
VAL = RBO.setProperty('','DEPT_DESC',DEPT_DESC<1>)
VAL = RBO.setProperty('','CCT_DESC',CCT_DESC<1>)

IF ERRMSG # '' THEN
	VAL = RBO.setProperty('','ServerStatus','E')
	VAL = RBO.setProperty('','ServerMessage',ERRMSG)
END ELSE
	VAL = RBO.setProperty('','ServerStatus','')
	VAL = RBO.setProperty('','ServerMessage','')
END

* End of method code
RETURN
END
