SUBROUTINE GLARVJEM_PreWrite
********************************************************************************
*   Program name :- GLARVJEM_PreWrite
*   Created:- 1/8/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE GLS.CPYLIB JE
$INCLUDE GLS.CPYLIB STATUS.JE

IF FILEINFO(CONTROL,0)=0 THEN
  OPEN '','CONTROL' TO CONTROL ELSE
    ERRMSG='CONTROL FILE IS MISSING'
    GOTO 93000
  END
END

STATUS=RBO.getProperty('','DivCode',DivCode) 
STATUS=RBO.setProperty('','JE_HEAD_DIV',DivCode) 
STATUS=RBO.getProperty('','DivPos',DivPos)       
STATUS=RBO.getProperty('','ID',ID)
STATUS=RBO.getProperty('','data_file',JE.REVERSE)
STATUS=RBO.getProperty('','JE_UDATE',JE.UDATE)
IF JE.UDATE#'' THEN 
  ERRMSG ='Cannot Update.'
  GOTO 93000
END
JE.NO=ID[4,1]
STATUS=RBO.getProperty('','JE_ACCT',JE.ACCT)
IF JE.ACCT = "" THEN                                          
  IF JE.NO = "N" THEN
    ERRMSG='No Detail Lines Present, Cannot Update.'
    GOTO 93000
  END 
  STATUS=RBO.getProperty('','new_item',NEW)
  IF NOT(NEW) THEN                                                                                 
    DELETE JE.REVERSE, CONO:JE.NO                                   
    STATUS=RBO.getProperty('','OldPeriod',OLD.PERIOD)
    CONO=ID[1,3]
    CTL.KEY = CONO : "JE.REVERSE" : OLD.PERIOD                      
    MATREADU SJE.REC FROM CONTROL, CTL.KEY ELSE MAT SJE.REC = ""             
    STATUS=RBO.getProperty('','JE_PDATE',JE.PDATE)
    IF JE.PDATE = '' THEN SJE.PRT.NO<1,DivPos> -= 1 
    SJE.POST.NO<1,DivPos> -=1                                                                           
    GOSUB UpdSjeControl                                                    
  END
  RELEASE JE.REVERSE, CONO:JE.NO
END                                                                                                                                                                                             
STATUS=RBO.getProperty('','TotDebit',TOT.DEBIT)
STATUS=RBO.getProperty('','TotCredit',TOT.CREDIT)
IF TOT.DEBIT = TOT.CREDIT THEN                                     
  IF JE.NO = "N" THEN                                              
    STATUS = RBO.callMethod('',GetNewID) 
  END                                       
  STATUS=RBO.getProperty('','PMCProperty',PMCProperty)
  USER.ID=PMCProperty<1,3>    
  STATUS=RBO.setProperty('','JE_OPER',USER.ID)   
  STATUS=RBO.getProperty('','JE_PERIOD',JE.PERIOD)                                          
  JE.CUR.PER = JE.PERIOD                                             
  IF NEW THEN                                                        
    CTL.KEY = CONO : "JE.REVERSE" : JE.PERIOD                        
    MATREADU SJE.REC FROM CONTROL, CTL.KEY ELSE MAT SJE.REC = ""                              
    SJE.PRT.NO<1,DivPos> +=1                        
    SJE.POST.NO<1,DivPos> +=1                                                                                  
    GOSUB UpdSjeControl                                                      
  END ELSE                                                           
    IF OLD.PERIOD # JE.PERIOD THEN                                   
      CTL.KEY = CONO : "JE.REVERSE" : OLD.PERIOD                     
      MATREADU SJE.REC FROM CONTROL, CTL.KEY ELSE MAT SJE.REC = ""  
      STATUS=RBO.getProperty('','JE_PDATE',JE.PDATE)                      
      IF JE.PDATE = "" THEN SJE.PRT.NO<1,DivPos> -=1                                                                   
      SJE.POST.NO<1,DivPos> -=1                                                                              
      GOSUB UpdSjeControl                                                    
      CTL.KEY = CONO : "JE.REVERSE" : JE.PERIOD                      
      MATREADU SJE.REC FROM CONTROL, CTL.KEY ELSE MAT SJE.REC = ""                       
      IF JE.PDATE = "" THEN SJE.PRT.NO<1,DivPos> +=1                                                                           
      SJE.POST.NO<1,DivPos> +=1                                                                          
      GOSUB UpdSjeControl                                                    
    END                                                              
  END                                                                                                   
END ELSE                                                             
  ERRMSG = "Cannot File When Record is OUT OF BALANCE"
  GOTO 93000 
END                                                                  

  GOTO 99999

***********************************************************
                              
*
*******************
UpdSjeControl:                                   
*******************
*
SJE.DATE<1,DivPos> = DATE() 
BEGIN CASE                        
  CASE SJE.POST.NO<1,DivPos> < 1     
    SJE.PRT.NO<1,DivPos> = 0         
    SJE.POST.NO<1,DivPos> = 0        
    SJE.STATUS<1,DivPos> = 'CLOSED'  
  CASE SJE.PRT.NO<1,DivPos> < 1      
    SJE.PRT.NO<1,DivPos> = 0         
    SJE.STATUS<1,DivPos> = 'PRINTED' 
   CASE 1                                  
     SJE.STATUS<1,DivPos> = 'ENTERED'                                      
END CASE                                  
MATWRITE SJE.REC ON CONTROL, CTL.KEY      
RETURN                                    

93000 
  STATUS = RBO.setProperty('','ServerStatus',1)        
  STATUS = RBO.setProperty('','ServerMessage',ERRMSG) 

99999 
  RETURN


