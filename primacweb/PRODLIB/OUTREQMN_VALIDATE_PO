SUBROUTINE OUTREQMN_VALIDATE_PO
********************************************************************************
*   Program name :- OUTREQMN_VALIDATE_PO
*   Created:- 10/21/2005
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H

* Insert method code here
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE POS.CPYLIB OUTSIDE.PO
$INCLUDE POS.CPYLIB APP.REQ

*DEFFUN CHECK.ACTIVE.STATUS (CONO,USER,DIV.OWNER,RET.FLAG,MAT APP.REQ.REC,APP.REQ.ID,YYY)
  SERV.STATUS = 0
  ERRMSG = ""
  
  OPEN "","COMPANY" TO COMPANY ELSE ERRMSG = "COMPANY FILE IS MISSING";SERV.STATUS = 1;GOTO 91000
  OPEN "","OUTSIDE.PO" TO OUTSIDE.PO ELSE ERRMSG = "OUTSIDE.PO FILE IS MISSING";SERV.STATUS = 1;GOTO 91000
  OPEN "","OUT.REQ" TO OUT.REQ ELSE ERRMSG = "OUT.REQ FILE IS MISSING";SERV.STATUS = 1;GOTO 91000
  OPEN "","APP.REQ" TO APP.REQ ELSE ERRMSG = "APP.REQ FILE IS MISSING";SERV.STATUS = 1;GOTO 91000

  STATUS = RBO.getProperty("","PMCProperty",PMCProperty)
  STATUS = RBO.getProperty("","ID",OPO.CODE)

  CONO = PMCProperty<1,4>
  USER_ID = PMCProperty<1,3>
  REQ = 0
  PORDER = 0
  NEW = 0
  ERR = ''
  SET.FCS = 0
  
  MATREAD COMP.REC FROM COMPANY,CONO ELSE ERRMSG = "CANNOT READ COMPANY FILE ON " : CONO; SERV.STATUS = 1;GOTO 91000
  MATREAD OPO.REC FROM OUTSIDE.PO, CONO:OPO.CODE THEN
    ERRMSG = "PO with number ":OPO.CODE: " already exists"
    PORDER = 1;SERV.STATUS = 1;SET.FCS = 2
    GOTO 91000
  END ELSE
    IF CO.PO.REQ.FLAG = "Y" THEN
      MATREAD OPO.REC FROM OUT.REQ, CONO:OPO.CODE THEN
        REQ = 1
      END 
    END
** vadded by suhail
    IF REQ = 0 THEN MAT OPO.REC = ""
** ^
  END
  IF OPO.APP.LEVEL = "C" THEN
    IF (REQ) THEN
      ERR = "Requisition: ":OPO.CODE:" was cancelled. Cannot make any changes."
      SERV.STATUS = 1;SET.FCS = 4
      *GOTO 91000
    END ELSE
      ERR = "PO ":OPO.CODE:" was cancelled. You cannot make any changes."
      SERV.STATUS = 1;SET.FCS = 4
      *GOTO 91000
    END
  END
  IF NOT(PORDER) AND NOT (REQ) THEN
    SERV.STATUS = 0
    SET.FCS = 3
    ERRMSG = OPO.CODE:" IS NOT ON FILE. DO YOU WANT TO ADD (Y/N)"
    GOTO 91000
  END
  IF NOT(NEW) THEN
    DIV.CODE = OPO.DIV.OWNER
    *USER.ID = UPCASE(@LOGNAME)
    USER.ID = UPCASE(USER_ID)
    ERRMSG = ''
    CALL CK_DIV_SEC_SUB(CONO,DIV.CODE,USER.ID,ERRMSG)
    IF ERRMSG # '' THEN
       SERV.STATUS = 1;SET.FCS = 1
       GOTO 91000
    END
    USER= USER.ID; DIV.OWNER = OPO.DIV.OWNER; APP.REQ.ID = ""
    CALL CHECK_ACTIVE_STATUS (CONO,USER,DIV.OWNER,RET.FLAG,MAT APP.REQ.REC,APP.REQ.ID,YYY)
    *CALL CHECK.ACTIVE.STATUS (CONO,USER,DIV.OWNER,RET.FLAG,MAT APP.REQ.REC,APP.REQ.ID,YYY)
    VALID = RET.FLAG
    IF NOT(VALID) THEN
      ERRMSG = "Profile for user ":USER.ID:" is either missing or is inactive" 
      SERV.STATUS  = 1
      SET.FCS  = 1
      GOTO 91000
    END
  END

  STATUS = RBO.setProperty("","ServerStatus",SERV.STATUS)
  STATUS = RBO.setProperty("","SET_FOCUS",SET.FCS)
  STATUS = RBO.setProperty("","ServerMessage",ERR)

  RETURN
* End of method code
91000*
  STATUS = RBO.setProperty("","SET_FOCUS",SET.FCS)
  STATUS = RBO.setProperty("","ServerStatus",SERV.STATUS)
  IF ERR # "" THEN
     STATUS = RBO.setProperty("","ServerMessage",ERR : "#" : ERRMSG)
  END ELSE
     STATUS = RBO.setProperty("","ServerMessage",ERRMSG)
  END
RETURN

