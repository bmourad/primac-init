SUBROUTINE GetOutSidePurchaseInfo_INQUIRY
********************************************************************************
*   Program name :- GetOutSidePurchaseInfo
*   Created:- 7/28/2003
*   Author  : IRFAN
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JES.CPYLIB ESTIMATE
$INCLUDE PMC.CPYLIB VEND
$INCLUDE JCS.CPYLIB CATEGORY.OSP
$INCLUDE CPYLIB SCREEN.COM
$INCLUDE CPYLIB FILE.VARS
$INCLUDE JES.CPYLIB JES.FILE.VARS
$INCLUDE CPYLIB CHAR


	OPEN "","ESTIMATE" TO ESTIMATE ELSE
		ERRMSG="CAN NOT OPEN ESTIMATE FILE"
	END

	OPEN "","VEND" TO VEND ELSE
		ERRMSG="CAN NOT OPEN VEND FILE"
	END

	OPEN "","CATEGORY.OSP" TO CATEGORY.OSP ELSE
		ERRMSG="CAN NOT OPEN CATEGORY.OSP FILE"
	END

STRFINAL=""
DO.ROLL.LABEL=0
QTYSTR ="";PRICESTR ="";VENDSTR = "";CATDESCSTR ="";UMSTR  = "";DEPT="";DEPTSTR="";PRCE=""
EST.DEPT.OSP = ""; EST.DEPT.OSP.ID = ""; 	EST.DEPT.OSP.UM = ""; EST.DEPT.OSP.QTY = "";EST.DEPT.OSP.PRICE = ""; ACTION=""

*STATUS = RBO.getProperty('','ID',ID)
   STATUS = RBO.getProperty('','PMCProperty',PMCProperty)
   STATUS = RBO.getProperty('','ID',INPUTVALUE)
   EST.KEY = INPUTVALUE[4,99]

    CONO=INPUTVALUE[1,3]
    COMP=1
    MATREAD EST.REC FROM ESTIMATE,CONO:EST.KEY THEN
	STRFINAL<1,-1> = EST.KEY
	STRFINAL<1,-1> = EST.CUST.NAME  	    
	ECNT = COUNT(EST.QTY,VM) + (EST.QTY # "")
      	IF EST.PDEF.TYPE = "RL" THEN 
      	  DO.ROLL.LABEL = 1
	END
    END
    ECNT = COUNT(EST.QTY,VM) + (EST.QTY # "")
*
*---- LOAD SCREEN DATA (MULTI-LINE)
*
      VXREF = ""
      SXREF = ""
      LINE.CNT = 0
      DCCNT = DCOUNT(EST.DEPT.OSP,VM)
      FOR P1 = 1 TO DCCNT
         C2 = DCOUNT(EST.DEPT.OSP.ID<1,P1>,SM)
         FOR P2 = 1 TO C2
            LINE.CNT = LINE.CNT + 1
            VXREF<1,LINE.CNT> = P1
            SXREF<1,LINE.CNT> = P2
            VND = FIELD(EST.DEPT.OSP.ID<1,P1,P2>,"!",1)
            MATREAD VEND.REC FROM VEND, CONO:VND ELSE MAT VEND.REC = ""
            VENDSTR<1,-1> = VEND.DESC
            CTG = FIELD(EST.DEPT.OSP.ID<1,P1,P2>,"!",2)
            MATREAD CAOS.REC FROM CATEGORY.OSP, CONO:CTG ELSE MAT CAOS.REC = ""
            CATDESCSTR<1,-1> = CAOS.DESC
            UMSTR<1,-1> = EST.DEPT.OSP.UM<1,P1,P2>
	     QTYSTR<1,-1>  =  "^"
 	     PRICESTR<1,-1> =  "^"

            FOR EPTR = 1 TO ECNT
               QTY = FIELD(EST.DEPT.OSP.QTY<1,P1,P2>,"!",EPTR)
               IF QTY = "" THEN
                  DEPT = FIELD(EST.DEPT.OSP<1,P1>,"!",1)
                  COMP = FIELD(EST.DEPT.OSP<1,P1>,"!",2)
                  IF DO.ROLL.LABEL THEN
                    *CALL EST.RL.QTY.CALC (CONO,"E",EST.KEY,DEPT,COMP,EST.QTY<1,EPTR>)
		       VALUECONTENT= CONO :"^E^": EST.KEY :"^": DEPT:"^": COMP:"^":EST.QTY<1,EPTR>
			VALUECONTENT=VALUECONTENT:"^":EST.DEPT.OSP :"^": EST.DEPT.OSP.ID :"^": EST.DEPT.OSP.UM :"^": EST.DEPT.OSP.QTY :"^": EST.DEPT.OSP.PRICE :"^": EST.BASE.QTY :"^": EST.QTY	
			STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
	    	       CALL EST_RL_QTY_CALC ;* (CONO,"E",EST.KEY,DEPT,COMP,EST.QTY<1,EPTR>)	
		    	STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
			STATUS = RBO.getProperty('', 'Answer',LOCALSTR)
			IF LOCALSTR # '' THEN
				EST.DEPT.OSP = FIELD(LOCALSTR,"^",1)
				EST.DEPT.OSP.ID = FIELD(LOCALSTR,"^",2)
				EST.DEPT.OSP.UM = FIELD(LOCALSTR,"^",3)
				EST.DEPT.OSP.QTY = FIELD(LOCALSTR,"^",4)
				EST.DEPT.OSP.PRICE = FIELD(LOCALSTR,"^",5)
			END	
                  END ELSE
                  *  CALL EST.QTY.CALC (CONO,"E",EST.KEY,DEPT,COMP,EST.QTY<1,EPTR>)
                  END
                  QTY = FIELD(EST.DEPT.OSP.QTY<1,P1,P2>,"!",EPTR)
               END
               IF MOD(QTY,100)=0 THEN QTY=INT(QTY/100) ELSE QTY=QTY/100
		    QTYSTR<1,-1> =  QTY 
		    PRICESTR<1,-1>   =  OCONV(FIELD(EST.DEPT.OSP.PRICE<1,P1,P2>,"!",EPTR),"MD2")	
            NEXT EPTR
         NEXT P2
      NEXT P1

STRFINAL = STRFINAL : "!" :  VENDSTR : "!" : CATDESCSTR: "!" : UMSTR : "!" : QTYSTR : "!" : PRICESTR : "!" : VXREF : "!" : SXREF
*STRFINAL = STRFINAL : "!" :  VENDSTR : "!" : CATDESCSTR: "!" : UMSTR : "!" : EST.DEPT.OSP.QTY : "!" : EST.DEPT.OSP.PRICE 

ERRMSG= RBO.setProperty('','OutPurchaseInfo',STRFINAL)
*ERRMSG= RBO.setProperty('','OutPurchaseInfo',DEPTSTR)
RETURN
