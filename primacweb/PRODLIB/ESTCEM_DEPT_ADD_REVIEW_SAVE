SUBROUTINE ESTCEM_DEPT_ADD_REVIEW_SAVE
********************************************************************************
*   Program name :- ESTCEM_DEPT_ADD_REVIEW_SAVE
*   Created	   :- 7/29/2005
*   Written by   :- Ramakrishna Pusuluri
*------------------------------------------------------------------------------*
*
* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H

* Insert method code here
$INCLUDE JES.CPYLIB ESTIMATE
$INCLUDE JES.CPYLIB ESTIMATE.DEPT

ERRMSG = ""
OUTPUT_VALUES = ""
OPEN "ESTIMATE" TO ESTIMATE ELSE ERRMSG="CANNOT OPEN ESTIMATE FILE";GOTO 90000
OPEN "ESTIMATE.DEPT" TO ESTIMATE.DEPT ELSE ERRMSG = "CANNOT LOCATE ESTIMATE.DEPT FILE";GOTO 90000
OPEN "CONTROL" TO CONTROL ELSE ERRMSG="CANNOT OPEN CONTROL FILE";GOTO 90000
CONO = ""
EST.KEY=""
ESTD.ID=""
STATUS = RBO.getProperty('','ESTDEPTINFO',FIRSTTIME)
STATUS = RBO.getProperty('','DREFCREF',CONOANDKEY)

VALUECONTENT = FIRSTTIME
ALLVALUES = ""
PREORPOST = ""
IF FIRSTTIME <> "" THEN
	PREORPOST 		= FIELD(VALUECONTENT,"^",1)
END

IF PREORPOST = "PRE" THEN
	WRITE VALUECONTENT ON CONTROL,"DEPTADDREVIEW"
	RETURN
END 
IF PREORPOST = "POST" THEN
	WRITE FIRSTTIME ON CONTROL,"DEPTADDREVIEW_NEXT"
	RETURN
END
IF CONOANDKEY <> "" THEN
	READ VALUECONTENT FROM CONTROL,"DEPTADDREVIEW" ELSE ERRMSG = "CANNOT READ DEPTADDREVIEW CONTROL FILE"
	READ FIRSTTIME FROM CONTROL,"DEPTADDREVIEW_NEXT" ELSE ERRMSG = "CANNOT READ DEPTADDREVIEW_NEXT CONTROL FILE"
	ALLVALUES = VALUECONTENT:"^":FIRSTTIME

	CONO 		= FIELD(CONOANDKEY,"^",1)
	PROMPT		= FIELD(CONOANDKEY,"^",2)
	EST.KEY	= FIELD(CONOANDKEY,"^",3)
	EST_COMP_FLAG = FIELD(CONOANDKEY,"^",4)
	DPTR		= FIELD(CONOANDKEY,"^",5)
	COMP 		= FIELD(CONOANDKEY,"^",6)
	EQTY		= FIELD(CONOANDKEY,"^",7)
	EST_DEPT_COMP = FIELD(CONOANDKEY,"^",8)
	NEW.REC	= FIELD(CONOANDKEY,"^",9)
	TOTAL.HRS 	= FIELD(CONOANDKEY,"^",10)
	TOTAL.DCOST 	= FIELD(CONOANDKEY,"^",11)
	TOTAL.COST 	= FIELD(CONOANDKEY,"^",12)
	TOTAL.SALE 	= FIELD(CONOANDKEY,"^",13)
	TOTAL.TSALE 	= FIELD(CONOANDKEY,"^",14)
	TOTAL.VSALE 	= FIELD(CONOANDKEY,"^",15)
	TOTAL.VCOST 	= FIELD(CONOANDKEY,"^",16)
	IF ALLVALUES <> "" THEN
		DELETE CONTROL,"DEPTADDREVIEW"
		DELETE CONTROL,"DEPTADDREVIEW_NEXT"
*		PRE			= FIELD(ALLVALUES,"^",1)
		ESTD.TYPE 		= FIELD(ALLVALUES,"^",2)
		ESTD.CCTR		= FIELD(ALLVALUES,"^",3)
		ESTD.OPV		= FIELD(ALLVALUES,"^",4)
		ESTD.CODE		= FIELD(ALLVALUES,"^",5)
		ESTD.QTY		= FIELD(ALLVALUES,"^",6)
		ESTD.FCTR		= FIELD(ALLVALUES,"^",7)
		ESTD.STD		= FIELD(ALLVALUES,"^",8)
		ESTD.STD.TYPE		= FIELD(ALLVALUES,"^",9)
		ESTD.TSALE		= FIELD(ALLVALUES,"^",10)
		ESTD.DESC		= FIELD(ALLVALUES,"^",11)
		ESTD.GRP.QTY		= FIELD(ALLVALUES,"^",12)
		ESTD.GRP.FCTR		= FIELD(ALLVALUES,"^",13)
		ESTD.GRP.QCALC	= FIELD(ALLVALUES,"^",14)
		ESTD.GRP.QPARAM	= FIELD(ALLVALUES,"^",15)
		ESTD.GRP.QOR		= FIELD(ALLVALUES,"^",16)
		ESTD.GRP.FCALC	= FIELD(ALLVALUES,"^",17)
		ESTD.GRP.FPARAM	= FIELD(ALLVALUES,"^",18)
		ESTD.GRP.FOR		= FIELD(ALLVALUES,"^",19)
		ESTD.GRP.ID		= FIELD(ALLVALUES,"^",20)
*		POST			= FIELD(ALLVALUES,"^",21)
		ESTD.UM		= FIELD(ALLVALUES,"^",22)
		ESTD.HRS		= FIELD(ALLVALUES,"^",23)
		ESTD.RATE		= FIELD(ALLVALUES,"^",24)
		ESTD.DCOST		= FIELD(ALLVALUES,"^",25)
		ESTD.IND.1		= FIELD(ALLVALUES,"^",26)
		ESTD.IND.2		= FIELD(ALLVALUES,"^",27)
		ESTD.IND.3		= FIELD(ALLVALUES,"^",28)
		ESTD.IND.4		= FIELD(ALLVALUES,"^",29)
		ESTD.COST		= FIELD(ALLVALUES,"^",30)
		ESTD.MARKUP		= FIELD(ALLVALUES,"^",31)
		ESTD.SALE		= FIELD(ALLVALUES,"^",32)
		ESTD.GRP.CCTR		= FIELD(ALLVALUES,"^",33)
		ESTD.VSALE		= FIELD(ALLVALUES,"^",34)
		ESTD.OPV.TYPE		= FIELD(ALLVALUES,"^",35)
		ESTD.DESC		= FIELD(ALLVALUES,"^",36)
	END
END
*SECONDTIME = VALUECONTENT:" \n":FIRSTTIME

	MATREAD EST.REC FROM ESTIMATE, CONO:EST.KEY ELSE
*	       ERRMSG = "Cannot Read ESTIMATE ":CONO:EST.KEY	
*		GOTO 90000
		MAT EST.REC = ""
	END

	IF PROMPT = "E" THEN
		IF NEW.REC THEN
*			EST.COMP.FLAG<1,DPTR,COMP>=""
			EST_COMP_FLAG<1,DPTR,COMP>=""
		END
		STATUS = RBO.setProperty('','DREFCREF',EST_COMP_FLAG)
		RETURN
	END ELSE
*		 EST.COMP.FLAG<1,DPTR,COMP>="Y"
		 EST_COMP_FLAG<1,DPTR,COMP>="Y"
		 ESTD.DEPT=EST.DEPT<1,DPTR>
		 ESTD.DEPT.TYPE=EST.DEPT.TYPE<1,DPTR>
		 ESTD.ID=DPTR:"!":COMP:"!":EQTY

		 MATWRITE ESTD.REC ON ESTIMATE.DEPT,CONO:EST.KEY:"!":ESTD.ID
		 
*		 IF EST.DEPT.COMP="" THEN EST.BASE.QTY=EQTY
		 IF EST_DEPT_COMP="" THEN EST.BASE.QTY=EQTY

*		 LOCATE ESTD.ID IN EST.DEPT.COMP<1>,1 SETTING P ELSE
		 LOCATE ESTD.ID IN EST_DEPT_COMP<1>,1 SETTING P ELSE
		    EST_DEPT_COMP<1,P>=ESTD.ID
		 END
		 EST.DEPT.COMP.HRS<1,P>=TOTAL.HRS
		 EST.DEPT.COMP.DCOST<1,P>=TOTAL.DCOST
		 EST.DEPT.COMP.COST<1,P>=TOTAL.COST
		 EST.DEPT.COMP.SALE<1,P>=TOTAL.SALE
		 EST.DEPT.COMP.TSALE<1,P>=TOTAL.TSALE
		 EST.DEPT.COMP.VSALE<1,P>=TOTAL.VSALE
		 EST.DEPT.COMP.VCOST<1,P>=TOTAL.VCOST
	 END

	OUTPUT_VALUES = EST_COMP_FLAG:"^^":EST.BASE.QTY:"^^":EST_DEPT_COMP:"^^":EST.DEPT.COMP.HRS:"^^":EST.DEPT.COMP.DCOST:"^^":EST.DEPT.COMP.COST:"^^":EST.DEPT.COMP.SALE:"^^":EST.DEPT.COMP.TSALE:"^^":EST.DEPT.COMP.VSALE:"^^":EST.DEPT.COMP.VCOST
	STATUS = RBO.setProperty('','DREFCREF',OUTPUT_VALUES)
RETURN

90000*
STATUS = RBO.setProperty('', 'ServerMessage', ERRMSG)
RETURN
