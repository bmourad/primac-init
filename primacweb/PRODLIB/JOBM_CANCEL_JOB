SUBROUTINE JOBM_CANCEL_JOB
$INCLUDE CPYLIB COMMON1
$INCLUDE JCS.CPYLIB COM.JCS.LINK
$INCLUDE ICS.CPYLIB COM.INV.MAIN  
$INCLUDE ICS.CPYLIB COM.INV.SERIAL
$INCLUDE JCS.CPYLIB COM.INV.STATS 
$INCLUDE PMC.CPYLIB COM.CUST
$INCLUDE OPS.CPYLIB COM.ORDER
********************************************************************************
*   Program name :- JOBM_CANCEL_JOB
*   Created:- 8/11/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
* Doc
* T416 TestTrack
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE PMC.CPYLIB FISCAL
$DEFINE CUSTOMER
$INCLUDE PMC.CPYLIB CUSTOMER
$DEFINE JOB
$INCLUDE JCS.CPYLIB JOB
$DEFINE JOBSTATS
$INCLUDE JCS.CPYLIB JOB.STATS
$DEFINE JOBCREDITSTATS
$INCLUDE JCS.CPYLIB JOB.CREDIT.STATS
$INCLUDE JCS.CPYLIB GANG.JOB
$INCLUDE JES.CPYLIB ESTIMATE
$DEFINE ORDER
$INCLUDE OPS.CPYLIB ORDER
$DEFINE ORDERDETAILINQ
$INCLUDE OPS.CPYLIB ORDER.DETAIL.INQ
$DEFINE SERIALRESV
$INCLUDE JCS.CPYLIB SERIAL.RESV
$DEFINE JOBFNGDSTATS
$INCLUDE OPS.CPYLIB JOB.FNGD.STATS
$DEFINE INVJOBSTATS
$INCLUDE ICS.CPYLIB INV.JOB.STATS
$DEFINE FNGDSTATS
$INCLUDE ICS.CPYLIB FNGD.STATS
$DEFINE INVENTORY
$INCLUDE ICS.CPYLIB INVENTORY
$DEFINE CATEGORY
$INCLUDE ICS.CPYLIB CATEGORY
$DEFINE INVWHSE
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE ICS.CPYLIB FNGD.JOB.STATS
$INCLUDE PSS.CPYLIB JOB.SCHED
$INCLUDE CPYLIB CHAR
$INCLUDE ICS.CPYLIB INV.CNV
$DEFINE FILEVARS
$INCLUDE CPYLIB FILE.VARS
FSCAL.PER = '';*T416
ERRMSG = ''
OPEN '','CONTROL' TO CONTROL ELSE
	ERRMSG = "UNABLE TO OPEN CONTROL FILE"
    	GOTO 99999
END
OPEN "","CUSTOMER" TO CUSTOMER ELSE
      	ERRMSG = "UNABLE TO OPEN CUSTOMER FILE"
    	GOTO 99999
END
OPEN "","JOB" TO JOB ELSE
     	ERRMSG = "UNABLE TO OPEN JOB FILE"
    	GOTO 99999
END
OPEN "","JOB.TIME" TO JOB.TIME ELSE
       ERRMSG = "JOB.TIME"; GOTO 99999
END
OPEN "","JOB.OSP" TO JOB.OSP ELSE
	ERRMSG = "JOB.OSP FILE IS MISSING"
	GOTO 99999
END
OPEN "","JOB.MISC" TO JOB.MISC ELSE
         ERRMSG = "JOB.MISC"; GOTO 99999
END
OPEN "","JOB.MATL" TO JOB.MATL ELSE
	ERRMSG = "JOB.MATL"; GOTO 99999
END
OPEN "","COST.CNTR.WIP" TO COST.CNTR.WIP ELSE
	ERRMSG = "COST.CNTR.WIP"
	GOTO 99999
END
OPEN "","INV.WHSE.LOC" TO INV.WHSE.LOC ELSE
	ERRMSG = "INV.WHSE.LOC"; GOTO 99999
END
OPEN "","INV_RECEIPTS" TO INV_RECEIPTS ELSE
	ERRMSG = "INV_RECEIPTS"; GOTO 99999
END
OPEN "","SECURITY" TO SECURITY ELSE
	ERRMSG = "SECURITY"; GOTO 99999
END
OPEN "","GANG.ALLOC" TO GANG.ALLOC ELSE
	ERRMSG = "GANG.ALLOC"; GOTO 99999
END
OPEN "","ORDER.RELEASE" TO ORDER.RELEASE ELSE
	ERRMSG = "ORDER.RELEASE"; GOTO 99999
END
OPEN "","FNGD.ORDER.STATS" TO FNGD.ORDER.STATS ELSE
	ERRMSG = "FNGD.ORDER.STATS"; GOTO 99999
END
OPEN "","SYS_TKT_DEF" TO SYS_TKT_DEF ELSE
	ERRMSG = "SYS_TKT_DEF"; GOTO 99999
END
OPEN "","SYS_SCN_DEF" TO SYS_SCN_DEF ELSE
	ERRMSG = "SYS_SCN_DEF"; GOTO 99999
END
OPEN "","SYS_FILES" TO SYS_FILES ELSE
	ERRMSG = "SYS_FILES"; GOTO 99999
END
OPEN "","PFX_FILES" TO PFX_FILES ELSE
	ERRMSG = "PFX_FILES"; GOTO 99999
END
OPEN "","SYS_FIELDS" TO SYS_FIELDS ELSE
	ERRMSG = "SYS_FIELDS"; GOTO 99999
END
OPEN "","SYS_FLD_HMSG" TO SYS_FLD_HMSG ELSE
	ERRMSG = "SYS_FLD_HMSG"; GOTO 99999
END
OPEN "","FNGD.BOM" TO FNGD.BOM ELSE
	ERRMSG = "FNGD.BOM"; GOTO 99999
END
OPEN "","INV.FNGD" TO INV.FNGD ELSE
         ERRMSG = "INV.FNGD"; GOTO 99999
END
OPEN "","JOB.STATS" TO JOB.STATS ELSE
     	ERRMSG = "UNABLE TO OPEN JOB.STATS FILE"
    	GOTO 99999
END
OPEN "","JOB.CREDIT.STATS" TO JOB.CREDIT.STATS ELSE
     	ERRMSG = "UNABLE TO OPEN JOB.CREDIT.STATS FILE"
    	GOTO 99999
END
OPEN "","GANG.JOB" TO GANG.JOB ELSE
   	ERRMSG = "UNABLE TO OPEN GANG.JOB FILE"
    	GOTO 99999
END
OPEN "","ESTIMATE" TO ESTIMATE ELSE
   	ERRMSG = "UNABLE TO OPEN ESTIMATE FILE"
    	GOTO 99999
END
OPEN "","ORDER" TO ORDER ELSE
	ERRMSG = "UNABLE TO OPEN ORDER FILE"
    	GOTO 99999
END
OPEN "","ORDER.DETAIL" TO ORDER.DETAIL ELSE
	ERRMSG = "UNABLE TO OPEN ORDER.DETAIL FILE"
    	GOTO 99999
END
OPEN "","JOB.FNGD.STATS" TO JOB.FNGD.STATS ELSE
	ERRMSG = "UNABLE TO OPEN JOB.FNGD.STATS FILE"
    	GOTO 99999
END
OPEN "","INV.JOB.STATS" TO INV.JOB.STATS ELSE
	ERRMSG = "UNABLE TO OPEN INV.JOB.STATS FILE"
    	GOTO 99999
END
OPEN "","FNGD.STATS" TO FNGD.STATS ELSE
	ERRMSG = "UNABLE TO OPEN FNGD.STATS FILE"
    	GOTO 99999
END
OPEN "","FNGD.JOB.STATS" TO FNGD.JOB.STATS ELSE
	ERRMSG = "UNABLE TO FNGD.JOB.STATS FILE"
    	GOTO 99999
END
OPEN '','JOB.SCHED' TO JOB.SCHED ELSE ;* THIS IS OPEND AT THE MIDDLE OF THE PROGRAM
	ERRMSG = "UNABLE TO JOB.SCHED FILE"
    	GOTO 99999
END

OPEN "","INV.WHSE" TO INV.WHSE ELSE
      	ERRMSG = "UNABLE TO OPEN INV.WHSE"
	GOTO 99999
END
OPEN "","INV.STATS" TO INV.STATS ELSE
   	ERRMSG = "UNABLE TO OPEN INV.STATS"
	GOTO 99999
END
OPEN "","OUTSIDE.PO" TO OUTSIDE.PO ELSE
	ERRMSG = "UNABLE TO OPEN OUTSIDE.PO"
	GOTO 99999
END
OPEN "","INVENTORY" TO INVENTORY ELSE
	ERRMSG = "UNABLE TO OPEN OUTSIDE.PO"
	GOTO 99999
END

OPEN "","CATEGORY" TO CATEGORY ELSE
	ERRMSG = "UNABLE TO OPEN OUTSIDE.PO"
	GOTO 99999
END
OPEN "","JKT_NOTIFY" TO JKT_NOTIFY ELSE
	ERRMSG = "JKT_NOTIFY"; GOTO 99999
END
DIM EST.PAR(10)
EQU EST.PAR.QTY    TO EST.PAR(1)
EQU EST.PAR.COMP   TO EST.PAR(2)
EQU EST.PAR.DEPT   TO EST.PAR(3)
EQU EST.PAR.UPDM   TO EST.PAR(4)
EQU EST.PAR.MATL   TO EST.PAR(5)
DIM OLD.EST.PAR(10)
MAT OLD.EST.PAR = ''
DIM NEW.EST.PAR(10)
MAT NEW.EST.PAR = ''

DIM TEMP.INV.REC(INV.REC.SIZE)
DEFFUN CALC_STK_QTY(BALANCE,MAT INV.CNV.REC,ROND,LN)
*DEFFUN JOBM_STATUS_SUB(STATUS)

* Insert method code here
VAL = RBO.getProperty('','ID',ID)
CONO = ID[1,3]
JOBNO = ID[4,99]

JOB_NO = ID[4,99]
VAL = RBO.getProperty('','VISITED_FLG',VISITED.MOD.FLG) ;* THIS FLAG INDICATES WHICH MODULES ARE VISITED -- 1-RS,RS 2-FG 3-GANG

MATREAD JOB.REC FROM JOB,ID ELSE
	MAT JOB.REC = ''
END

VAL = RBO.getProperty('','SAVE_INV_JS_REC',SAVE.INV.JS.REC)
SAVE.INV.JS.REC = RAISE(SAVE.INV.JS.REC)

IF VISITED.MOD.FLG<1,1> = 0 THEN ;* EXTRACT RS AND RD DATA
	PCNT=DCOUNT(JOB.RESV.MATL,VM)
	UMS=''; MATL.TYPE='';ALLOCATED=''; RESERVED=''; USED='';RSV.SERIAL=''
	CONV.FRMT = "";REQD.DATE = ""
	REQD.PRICE = "";REQD.QTY = "";BALANCE = "";RESERVED = "";USED = "";PROD_DESC = ""
	MVSTR = ""
	FOR P = 1 TO PCNT
		MVSTR<1,P> = ""
		MATREAD INV.REC FROM INVENTORY,CONO:JOB.RESV.MATL<1,P> ELSE
    			INV.FULL.DESC = 'Unknown'
		END
		PROD_DESC<1,P> = INV.FULL.DESC
	  	$INCLUDE ICSBP INV.UM.CNV
  		ROND=''; LN=''
	  	UMS<1,P> = INV.UNIT<1,2>
  		MATL.TYPE<1,P> = INV.PAP.TYPE
	  	*IF MATL.TYPE<1,P> = 'REGULAR' THEN MATL.TYPE<1,P> = 'REGULR'
  		ALLOCATED<1,P> = CALC_STK_QTY(JOB.ALOC.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
	
		ALLOCATED<1,P> = OCONV(ALLOCATED<1,P>,ICR.CNV)
  		RESERVED<1,P> = CALC_STK_QTY(JOB.RESV.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
	  	RESERVED<1,P> = OCONV(RESERVED<1,P>,ICR.CNV)
  		USED<1,P> = CALC_STK_QTY(JOB.USED.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
	  	USED<1,P> = OCONV(USED<1,P>,ICR.CNV)

		IF JOB.RESV.QTY<1,P>+0 > 0 THEN
    			MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE THEN
      				IF CATG.RSV.SERIAL = 'Y' THEN
        				RSV.SERIAL<1,P>='Y'
	      			END
    			END
	  	END

	  	IF RSV.SERIAL<1,P> # 'Y' THEN RSV.SERIAL<1,P> = 'N'
  		JSTAT.ID = JOB.RESV.MATL<1,P>:"!":JOB.RESV.WHSE<1,P>:"!":JOB_NO
		MATREAD INV.JS.REC FROM INV.JOB.STATS,CONO:JSTAT.ID ELSE
  			MAT INV.JS.REC = ''
		END
*T416 v
 RQD.DATE.MV=1
 RQD.AMT.MV=2
 RQD.QTY.MV=3
*T416 ^
              IF SAVE.INV.JS.REC<P> = '' THEN
			SAVE.INV.JS.REC<P,RQD.DATE.MV> = IJS.REQ.DATE
			SAVE.INV.JS.REC<P,RQD.AMT.MV> = IJS.REQ.AMT
			SAVE.INV.JS.REC<P,RQD.QTY.MV> = IJS.REQ.QTY
		END

		REQD.DATE<1,P> = OCONV(SAVE.INV.JS.REC<P,RQD.DATE.MV>,'D2/')
  		REQD.PRICE<1,P> = OCONV(SAVE.INV.JS.REC<P,RQD.AMT.MV>,'MD4')
	  	REQD.QTY<1,P> = CALC_STK_QTY(SAVE.INV.JS.REC<P,RQD.QTY.MV>,MAT INV.CNV.REC,ROND,LN)
  		REQD.QTY<1,P> = OCONV(REQD.QTY<1,P>,ICR.CNV)
	  	*BALANCE<1,P> = SAVE.INV.JS.REC<P,RQD.QTY.MV> - JOB.ALOC.QTY<1,P> - JOB.RESV.QTY<1,P> - JOB.USED.QTY<1,P>
  		BALANCE<1,P> = REQD.QTY<1,P> - ALLOCATED<1,P> - RESERVED<1,P> - USED<1,P>
		IF BALANCE<1,P> < 0 THEN BALANCE<1,P> = 0
		IF (INDEX(BALANCE<1,P>:" ",".",1) = 0) AND ICR.CNV = 'MD2' THEN ;*T416
	  		BALANCE<1,P> = BALANCE<1,P> : ".00"
		END
		*BALANCE<1,P> = CALC_STK_QTY(BALANCE<1,P>,MAT INV.CNV.REC,ROND,LN)
	 	*BALANCE<1,P> = BALANCE<1,P>
		CONV.FRMT<1,P> = ICR.CNV
	NEXT P
	STATUS=RBO.setProperty('','JOB_RESV_MATL',JOB.RESV.MATL)
	STATUS=RBO.setProperty('','JOB_RESV_WHSE',JOB.RESV.WHSE)
	STATUS=RBO.setProperty('','RESV_MATL_TYPE',MATL.TYPE)
	STATUS=RBO.setProperty('','JOB_RESV_DATE',JOB.RESV.DATE)
	STATUS=RBO.setProperty('','RESV_MATL_UM',UMS)
	STATUS=RBO.setProperty('','JOB_ALOC_QTY',ALLOCATED)
	STATUS=RBO.setProperty('','JOB_RESV_QTY',RESERVED)
	STATUS=RBO.setProperty('','JOB_USED_QTY',USED)
	STATUS=RBO.setProperty('','REQD_DATE',REQD.DATE);* THIS IS FOR REQUIRED PROCESSING
	STATUS=RBO.setProperty('','REQD_PRICE',REQD.PRICE);* unit price THIS IS FOR REQUIRED PROCESSING
	STATUS=RBO.setProperty('','RSV_REQD_QTY',REQD.QTY);* THIS IS FOR REQUIRED PROCESSING
	STATUS=RBO.setProperty('','RSV_BALANCE',BALANCE);* THIS IS FOR REQUIRED PROCESSING

	VAL = RBO.setProperty('','RESV_USED_QTY',MVSTR)
	VAL = RBO.setProperty('','RSV_SERIAL',MVSTR)
	VAL = RBO.setProperty('','SRESV_SERIAL',MVSTR)
	VAL = RBO.setProperty('','SUB_FLAG',MVSTR)
	VAL = RBO.setProperty('','USER_ID',MVSTR)
	VAL = RBO.setProperty('','USER_WHSE_CODE',MVSTR)
	VAL = RBO.setProperty('','DEPT_CODES',MVSTR)
	VAL = RBO.setProperty('','DEPT_DESCS',MVSTR)
END

IF VISITED.MOD.FLG<1,2> = 0 THEN ;* EXTRACT FNGD DATA
	MATREAD JFS.REC FROM JOB.FNGD.STATS, ID ELSE MAT JFS.REC = ""
	PCNT=DCOUNT(JFS.PROD,@VM) ;* LIST OF FININSHED GOODS PRODUCTS
	PRODDESCS=''; UMS=''
	BALANCE=''
	F.QTY = JFS.F.QTY 
	S.QTY = JFS.S.QTY 
	FOR P = 1 TO PCNT
		MATREAD INV.REC FROM INVENTORY,CONO:JFS.PROD<1,P> ELSE
    			INV.FULL.DESC = 'Unknown'
	  	END
		$INCLUDE ICSBP INV.UM.CNV
  		ROND=''; LN=''
	  	UMS<1,P> = INV.UNIT<1,2>
		JFS.U.PRICE<1,P> = OCONV(JFS.U.PRICE<1,P>,"MD4")
		JFS.DATE<1,P> = OCONV(JFS.DATE<1,P>,"D2/")
  		*IF BALANCE<1,P> < 0 THEN BALANCE<1,P> = 0
	  	*BALANCE<1,P> = CalcStkQty(BALANCE<1,P>,MAT INV.CNV.REC,ROND,P)
  		JFS.M.QTY<1,P> = OCONV(INT(((JFS.M.QTY<1,P>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		JFS.A.QTY<1,P> = OCONV(INT(((JFS.A.QTY<1,P>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		JFS.F.QTY<1,P> = OCONV(INT(((JFS.F.QTY<1,P>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		JFS.S.QTY<1,P> = OCONV(INT(((JFS.S.QTY<1,P>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		CNT1 = DCOUNT(JFS.ORD.QTY<1,P>,SM)
		FOR I = 1 TO CNT1
			JFS.ORD.QTY<1,P,I> = OCONV(INT(((JFS.ORD.QTY<1,P,I>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		NEXT I
		IF JOB.STATUS<1,1> = 4 OR JOB.STATUS<1,1> > 5 THEN
    			BALANCE<1,P> = 0
	  	END ELSE
    			BALANCE<1,P> = JFS.M.QTY<1,P> - JFS.F.QTY<1,P> - JFS.S.QTY<1,P>
	  	END
		IF BALANCE<1,P> < 0  THEN BALANCE<1,P> = 0
		
	NEXT P

	STATUS=RBO.setProperty('','RET_PROD_LIST',JFS.PROD)
	STATUS=RBO.setProperty('','RET_WHSE_LIST',JFS.WHSE)
	STATUS=RBO.setProperty('','JFS_UMS',UMS)
	STATUS=RBO.setProperty('','JFS_U_PRICE',JFS.U.PRICE)
	STATUS=RBO.setProperty('','JFS_M_QTY',JFS.M.QTY)
	STATUS=RBO.setProperty('','JFS_DATE',JFS.DATE)
	
	STATUS=RBO.setProperty('','JFS_A_QTY',JFS.A.QTY)
	STATUS=RBO.setProperty('','JFS_O_QTY',JFS.ORD.QTY)
	STATUS=RBO.setProperty('','JFS_F_QTY',JFS.F.QTY)
	STATUS=RBO.setProperty('','JFS_S_QTY',JFS.S.QTY)
	STATUS=RBO.setProperty('','JFS_ORDER',JFS.ORDER)
	STATUS=RBO.setProperty('','JFS_BAL',BALANCE)

	*STATUS=RBO.setProperty('','CustomerCodes',JFS.PROD)
	*STATUS=RBO.setProperty('','CustomerDescs',JFS.WHSE)
	*STATUS=RBO.setProperty('','WarehouseCodes',JFS.ORDER)
	*STATUS=RBO.setProperty('','WarehouseDescs',JFS.ORD.QTY)
END

IF VISITED.MOD.FLG<1,3> = 0 THEN ;* EXTRACT GANG DATA
	MATREAD GJOB.REC FROM GANG.JOB,ID ELSE MAT GJOB.REC = ''
	LINES = DCOUNT(GJOB.JOB,VM)
	TOT.AREA = INT(GJOB.IW / 10 * GJOB.IL / 10 + 0.5)
	CALC.AREA = 0
	FOR CREF = 1 TO LINES
		CALC.AREA = CALC.AREA + INT(GJOB.WIDTH<1,CREF> / 1000 * GJOB.LENGTH<1,CREF> / 1000 * GJOB.SPOTS<1,CREF> + 0.5)
		GJOB.WIDTH<1,CREF> = OCONV(GJOB.WIDTH<1,CREF>,"MD4")
		GJOB.LENGTH<1,CREF> = OCONV(GJOB.LENGTH<1,CREF>,"MD4")
	NEXT CREF
	CALC.AREA = INT(CALC.AREA/100+0.5)
	TOTAL = SUM(GJOB.SPOTS)
	IF TOT.AREA = 0 THEN
		TOT.AREA = ""
	END ELSE
		TOT.AREA = INT((1-(CALC.AREA/TOT.AREA))*10000+0.5)
	END
	INV_PAP_WIDTH = ""
	INV_PAP_LEN = ""
	STAT.DESC = ""
	CNT = DCOUNT(GJOB.PROD,VM)
	PROD_DESCS = ""
	FOR I = 1 TO CNT
		MATREAD INV.REC FROM INVENTORY,CONO:GJOB.PROD<1,I> ELSE
			MAT INV.REC = ''
		END
		PROD_DESCS<1,I> = INV.DESC
		INV_PAP_WIDTH<1,I> = OCONV(INV.PAP.WIDTH+0,"MD4")
		INV_PAP_LEN<1,I> = OCONV(INV.PAP.LEN+0,"MD4")
       	MATREAD JOB.REC FROM JOB,CONO:GJOB.JOB<1,I> ELSE
			MAT JOB.REC = ''
		END
	       *CALL JOB.STATUS.SUB(JOB.STATUS<1,1>,JOB.TRACK.DATE,STATUS)
		*STAT.DESC<1,I> = JOBM_STATUS_SUB(JOB.STATUS<1,1>)
	NEXT I

	STATUS=RBO.setProperty('','ShipViaDescs',GJOB.JOB)
	STATUS=RBO.setProperty('','ShipViaCodes',GJOB.PROD)
	STATUS=RBO.setProperty('','SalesPersonDescs',GJOB.WIDTH)
	STATUS=RBO.setProperty('','SalesPersonCodes',GJOB.LENGTH)
	STATUS=RBO.setProperty('','SalesDescs',GJOB.SPOTS)
	STATUS=RBO.setProperty('','SalesCodes',GJOB.PCT)

	STATUS=RBO.setProperty('','Ums',OCONV(GJOB.IW,"MD2"))
	STATUS=RBO.setProperty('','STATUS',OCONV(GJOB.IL,"MD2"))

	STATUS=RBO.setProperty('','JobCodes',GJOB.ALLOC)
	STATUS=RBO.setProperty('','JobDescs',GJOB.DESC)
	*STATUS=RBO.setProperty('','ORIG_CUST',GJOB.ID)
END

MATREAD JOB.REC FROM JOB,ID ELSE MAT JOB.REC = ''
CONO = ID[1,3]
JOBNO = ID[4,99]

MATREAD GJOB.REC FROM GANG.JOB,ID ELSE MAT GJOB.REC = ''


OJFS.PROD = ""
OJFS.WHSE = ""
OJFS.ORDER = ""
OJFS.ORD.QTY = ""
MATREAD JFS.REC FROM JOB.FNGD.STATS, CONO:JOBNO THEN
	OJFS.PROD = JFS.PROD; OJFS.WHSE = JFS.WHSE
	OJFS.ORDER = JFS.ORDER; OJFS.ORD.QTY = JFS.ORD.QTY  
END ELSE 
  	MAT JFS.REC = ''
END

MATREAD CUST.REC FROM CUSTOMER , CONO : JOB.CUST ELSE MAT CUST.REC = ''

VAL = RBO.getProperty('','CUST_NAME',OLD.CUST) ;* OLD.CUST
IF OLD.CUST = 0 THEN OLD.CUST = ""
VAL = RBO.getProperty('','JOB_SALS_NAME',OLD.MASTER) ;* OLD.JOB.MASTER
IF OLD.MASTER = 0 THEN OLD.MASTER = ""
VAL = RBO.getProperty('','JOB_MASTER',JOB.MASTER) ;* OLD.JOB.MASTER
IF JOB.MASTER = 0 THEN JOB.MASTER = ""
VAL = RBO.getProperty('','STAT',JOB.STATUS) ;* MULTIVALUED
VAL = RBO.getProperty('','FLG',FLG)

VAL = RBO.getProperty('','JOB_WIP',JOB.WIP)
VAL = RBO.getProperty('','EST_PAR',EST.PAR.TEMP)


EST.PAR(1) = EST.PAR.TEMP<1,1>
EST.PAR(2) = EST.PAR.TEMP<1,2>
EST.PAR(3) = EST.PAR.TEMP<1,3>
EST.PAR(4) = EST.PAR.TEMP<1,4>
EST.PAR(5) = EST.PAR.TEMP<1,5>

CNT = DCOUNT(JOB.WIP<1,2>,@SVM)
FOR I = 1 TO CNT
	JOB.WIP<1,2,I> = ICONV(JOB.WIP<1,2,I>,"MD2")
NEXT I

CNT = DCOUNT(JOB.WIP<1,3>,@SVM)
FOR I = 1 TO CNT
	JOB.WIP<1,3,I> = ICONV(JOB.WIP<1,3,I>,"MD2")
NEXT I

VAL = RBO.getProperty('','JOB_RESV_MATL',JOB.RESV.MATL) ;* LIST OF PRODUCTS RESERVED
VAL = RBO.getProperty('','JOB_RESV_WHSE',JOB.RESV.WHSE) 
VAL = RBO.getProperty('','RESV_MATL_TYPE',RESV.MATL.TYPE)
VAL = RBO.getProperty('','JOB_RESV_DATE',JOB.RESV.DATE)
VAL = RBO.getProperty('','RESV_MATL_UM',RESV.MATL.UM)
VAL = RBO.getProperty('','JOB_ALOC_QTY',JOB.ALOC.QTY)
VAL = RBO.getProperty('','JOB_RESV_QTY',JOB.RESV.QTY)
VAL = RBO.getProperty('','JOB_USED_QTY',JOB.USED.QTY)
VAL = RBO.getProperty('','JOB_ALOC_AMT',JOB.ALOC.AMT)
VAL = RBO.getProperty('','JOB_RESV_AMT',JOB.RESV.AMT)
VAL = RBO.getProperty('','JOB_USED_AMT',JOB.USED.AMT)
VAL = RBO.getProperty('','JOB_STAT_DATE',JOB.STAT.DATE)
VAL = RBO.getProperty('','JOB_CUST',JOB.CUST)
IF JOB.CUST = 0 THEN JOB.CUST = ""
VAL = RBO.getProperty('','JOB_SUBS',JOB.SUBS)
VAL = RBO.getProperty('','JOB_CREDIT',JOB.CREDIT)

VAL = RBO.getProperty('','REQD_DATE',IJS.REQ.DATE)
VAL = RBO.getProperty('','REQD_PRICE',IJS.REQ.AMT);*UNIT PRICE
VAL = RBO.getProperty('','RSV_REQD_QTY',IJS.REQ.QTY)
VAL = RBO.getProperty('','RSV_BALANCE',REQD.BALANCE)
VAL = RBO.getProperty('','JOB_PRICE_PER_THOU',JOB.PRICE.PER.THOU)

JOB.PRICE.PER.THOU = ICONV(JOB.PRICE.PER.THOU,'MD2')

*T416 RQD.DATE.MV=1
*T416 RQD.AMT.MV=2
*T416 RQD.QTY.MV=3
VAL = RBO.getProperty('','REQD_DATE',IJS.REQ.DATE)
VAL = RBO.getProperty('','REQD_PRICE',IJS.REQ.AMT);*UNIT PRICE
VAL = RBO.getProperty('','RSV_REQD_QTY',IJS.REQ.QTY)
VAL = RBO.getProperty('','RSV_BALANCE',REQD.BALANCE)

VAL = RBO.getProperty('','RESV_USED_QTY',SRESV.PRWHSE)
VAL = RBO.getProperty('','RSV_SERIAL',SRESV.RECP)
VAL = RBO.getProperty('','SAVE_INV_JS_REC',SRESV.SERIAL)
VAL = RBO.getProperty('','SUB_FLAG',SRESV.QTY)
VAL = RBO.getProperty('','USER_ID',SRESV.UN.COST)
VAL = RBO.getProperty('','USER_WHSE_CODE',SRESV.RECP.DATE)
VAL = RBO.getProperty('','DEPT_CODES',SRESV.AVAIL)
VAL = RBO.getProperty('','DEPT_DESCS',SRESV.OLD.QTY)

COUNT = DCOUNT(JOB.RESV.MATL,VM)
FOR M = 1 TO COUNT
	MATREAD TEMP.INV.REC FROM INVENTORY,CONO:JOB.RESV.MATL<1,M> ELSE
		MAT TEMP.INV.REC = ''
	END
	INV.M.LINE = TEMP.INV.REC(4)
	INV.UNIT = TEMP.INV.REC(21)
	INV.M.WT = TEMP.INV.REC(23)
       INV.PAP.WIDTH = TEMP.INV.REC(33)
	INV.COST.WT	= TEMP.INV.REC(22)
	$INCLUDE ICSBP INV.UM.CNV
	SAVE.INV.JS.REC<M,RQD.DATE.MV> = ICONV(IJS.REQ.DATE<1,M>,'D2/')
	SAVE.INV.JS.REC<M,RQD.AMT.MV> = ICONV(IJS.REQ.AMT<1,M>,'D4')
	SAVE.INV.JS.REC<M,RQD.QTY.MV> = ICONV((((IJS.REQ.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JOB.ALOC.QTY<1,M> = ICONV((((JOB.ALOC.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JOB.RESV.QTY<1,M> = ICONV((((JOB.RESV.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JOB.USED.QTY<1,M> = ICONV((((JOB.USED.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
* T416 v Replacing all L's with M's
	CNT = DCOUNT(SRESV.RECP.DATE<1,M>,SVM)
	FOR I = 1 TO CNT
		IF SRESV.RECP.DATE<1,M,I> # "" THEN SRESV.RECP.DATE<1,M,I> = ICONV(SRESV.RECP.DATE<1,M,I>,'D2/')
		IF SRESV.QTY<1,M,I> # "" THEN SRESV.QTY<1,M,I> = ICONV((((SRESV.QTY<1,M,I>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
		IF SRESV.UN.COST<1,M,I> # "" THEN SRESV.UN.COST<1,M,I> = ICONV(SRESV.UN.COST<1,M,I>,"MD4")
		IF SRESV.AVAIL<1,M,I> # "" THEN SRESV.AVAIL<1,M,I> = ICONV((((SRESV.AVAIL<1,M,I>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
		IF SRESV.OLD.QTY<1,M,I> # "" THEN SRESV.OLD.QTY<1,M,I> = ICONV((((SRESV.OLD.QTY<1,M,I>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	NEXT I
* T416 ^

NEXT M

VAL = RBO.getProperty('','RET_PROD_LIST',JFS.PROD) ;* LIST OF FNGD PRODUCTS
VAL = RBO.getProperty('','RET_WHSE_LIST',JFS.WHSE)
VAL = RBO.getProperty('','JFS_UMS',JFS.UMS)
VAL = RBO.getProperty('','JFS_U_PRICE',JFS.U.PRICE)
VAL = RBO.getProperty('','JFS_M_QTY',JFS.M.QTY)
VAL = RBO.getProperty('','JFS_DATE',JFS.DATE)
VAL = RBO.getProperty('','JFS_A_QTY',JFS.A.QTY)
VAL = RBO.getProperty('','JFS_O_QTY',JFS.ORD.QTY)
VAL = RBO.getProperty('','JFS_F_QTY',JFS.F.QTY)
VAL = RBO.getProperty('','JFS_S_QTY',JFS.S.QTY)
VAL = RBO.getProperty('','JFS_ORDER',JFS.ORDER)
VAL = RBO.getProperty('','JFS_BAL',JFS.BAL)


COUNT = DCOUNT(JFS.PROD,VM)
FOR M = 1 TO COUNT
	MATREAD TEMP.INV.REC FROM INVENTORY,CONO:JFS.PROD<1,M> ELSE
		MAT TEMP.INV.REC = ''
	END
	INV.M.LINE = TEMP.INV.REC(4)
	INV.UNIT = TEMP.INV.REC(21)
	INV.M.WT = TEMP.INV.REC(23)
       INV.PAP.WIDTH = TEMP.INV.REC(33)
	INV.COST.WT	= TEMP.INV.REC(22)
	$INCLUDE ICSBP INV.UM.CNV

	JFS.M.QTY<1,M> = ICONV((((JFS.M.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JFS.A.QTY<1,M> = ICONV((((JFS.A.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JFS.F.QTY<1,M> = ICONV((((JFS.F.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JFS.S.QTY<1,M> = ICONV((((JFS.S.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JFS.ORD.QTY<1,M> = ICONV((((JFS.ORD.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JFS.U.PRICE<1,M> = ICONV(JFS.U.PRICE<1,M>,'MD4')
NEXT M

*VAL = RBO.getProperty('','CustomerCodes',OJFS.PROD)
*VAL = RBO.getProperty('','CustomerDescs',OJFS.WHSE)
*VAL = RBO.getProperty('','WarehouseCodes',OJFS.ORDER)
*VAL = RBO.getProperty('','WarehouseDescs',OJFS.ORD.QTY)
VAL = RBO.getProperty('','JOB_TOT_INV',JOB.TOT.INV)
VAL = RBO.getProperty('','JOB_CONF_AMT',JOB.CONF.AMT)
JOB.CONF.AMT = ICONV(JOB.CONF.AMT,'MD2')

VAL = RBO.getProperty('','JOB_TOT_INV',JOB.TOT.INV)
VAL = RBO.getProperty('','CNV_FORMAT',PREV.CRED.AUTH)
VAL = RBO.getProperty('','ACTION',CUR.ORD.BAL)
VAL = RBO.getProperty('','CO_POS',CUR.JOB.BAL)
VAL = RBO.getProperty('','JOB_TRACK_DATE',JOB.TRACK.DATE)

VAL = RBO.getProperty('','JOB_DIV',JOB.DIV)
VAL = RBO.getProperty('','JOB_SLSMN',JOB.SLSMN)
IF JOB.SLSMN = 0 THEN JOB.SLSMN = ""
VAL = RBO.getProperty('','JOB_CSR',JOB.CSR)
IF JOB.CSR = 0 THEN JOB.CSR = ""
VAL = RBO.getProperty('','JOB_TYPE',JOB.TYPE)
IF JOB.TYPE = 0 THEN JOB.TYPE = ""
VAL = RBO.getProperty('','JOB_SALES_CODE',JOB.SALES.CODE)
IF JOB.SALES.CODE = 0 THEN JOB.SALES.CODE = ""
VAL = RBO.getProperty('','JOB_CATG',JOB.CATG)
IF JOB.CATG = 0 THEN JOB.CATG = ""
VAL = RBO.getProperty('','JOB_SHIP_VIA',JOB.SHIP.VIA)
IF JOB.SHIP.VIA = 0 THEN JOB.SHIP.VIA = ""
VAL = RBO.getProperty('','JOB_CUST_PO',JOB.CUST.PO)
VAL = RBO.getProperty('','JOB_EST_COST',JOB.EST.COST)
JOB.EST.COST = ICONV(JOB.EST.COST,"MD2")
VAL = RBO.getProperty('','JOB_EST_SALE',JOB.EST.SALE)
JOB.EST.SALE = ICONV(JOB.EST.SALE,'MD2')
VAL = RBO.getProperty('','JOB_MARKUP',JOB.MARKUP)
JOB.MARKUP = ICONV(JOB.MARKUP,'MD2')
VAL = RBO.getProperty('','JOB_COLORS',JOB.COLORS)
VAL = RBO.getProperty('','JOB_ORD_QTY',JOB.ORD.QTY)
*T416 VAL = RBO.getProperty('','JOB_FIN_QTY',JOB.FIN.QTY)
*T416 VAL = RBO.getProperty('','JOB_SHP_QTY',JOB.SHP.QTY)
JOB.QTY = ""
JOB.QTY<1,1> = JOB.ORD.QTY
JOB.QTY<1,2> = JOB.FIN.QTY
JOB.QTY<1,3> = JOB.SHP.QTY

VAL = RBO.getProperty('','JOB_DUE_DATE',JOB.DUE.DATE)
*JOB.DUE.DATE = ICONV(JOB.DUE.DATE,'D4')
*JOB.DUE.DATE = OCONV(JOB.DUE.DATE,'D2')
*T416 VAL = RBO.getProperty('','JOB_PRIOR_JOB',JOB.PRIOR.JOB)
VAL = RBO.getProperty('','JOB_FIN_QTY',JOB.FIN.QTY)
VAL = RBO.getProperty('','JOB_SHP_QTY',JOB.SHP.QTY)
VAL = RBO.getProperty('','JOB_PRIOR_JOB',JOB.PRIOR.JOB)
VAL = RBO.getProperty('','JOB_COMMENTS',JOB.COMMENTS)
VAL = RBO.getProperty('','JOB_DESC',JOB.DESC)
VAL = RBO.getProperty('','CO_JIS',OLD.EST)
VAL = RBO.getProperty('','JOB_OP_NUM',NEW.EST)
VAL = RBO.getProperty('','JOB_EST',JOB.EST)
IF JOB.EST = 0 THEN JOB.EST = ""
VAL = RBO.getProperty('','CREDIT_FLAG',EST.MATL)

VAL = RBO.getProperty('','ShipViaDescs',GJOB.JOB)
VAL = RBO.getProperty('','ShipViaCodes',GJOB.PROD)
VAL = RBO.getProperty('','SalesPersonDescs',GJOB.WIDTH)
VAL = RBO.getProperty('','SalesPersonCodes',GJOB.LENGTH)
VAL = RBO.getProperty('','SalesDescs',GJOB.SPOTS)
VAL = RBO.getProperty('','SalesCodes',GJOB.PCT)
VAL = RBO.getProperty('','Ums',GJOB.IW)
VAL = RBO.getProperty('','STATUS',GJOB.IL)
VAL = RBO.getProperty('','JobCodes',GJOB.ALLOC)
VAL = RBO.getProperty('','JobDescs',GJOB.DESC)
VAL = RBO.getProperty('','JobCategoryDescs',GJOB.DEPT)
VAL = RBO.getProperty('','JobCategoryCodes',GJOB.CCTR)
VAL = RBO.getProperty('','JOB_OP_VEND',GJOB.TYPE)
*VAL = RBO.getProperty('','CUST_CREDIT',OPTVAL);* THIS IS MULTI-VALUED FOR JOB.BOOK.SUB INPUT PARAMETERS

*VAL = RBO.getProperty('','CUST_CREDIT',OPTVAL);* THIS IS MULTI-VALUED FOR JOB.BOOK.SUB INPUT PARAMETERS

GJOB.IW = ICONV(GJOB.IW,"MD2")
GJOB.IL = ICONV(GJOB.IL,"MD2")

LINES = DCOUNT(GJOB.JOB,VM)
FOR CREF = 1 TO LINES
	GJOB.WIDTH<1,CREF> = ICONV(GJOB.WIDTH<1,CREF>,"MD4")
	GJOB.LENGTH<1,CREF> = ICONV(GJOB.LENGTH<1,CREF>,"MD4")
NEXT CREF

RESV.ACTION = ""
IF ((OLD.CUST = "") OR (OLD.CUST = 0)) THEN OLD.CUST = JOB.CUST

JOB.CUST = OLD.CUST

IF OLD.MASTER = "" OR OLD.MASTER = "N" OR OLD.MASTER = 0 THEN
	JOB.MASTER=JOBNO
END ELSE
	JOB.MASTER=OLD.MASTER
END

IF SUM(JOB.ALOC.QTY) # 0 THEN
	CALL CLEAR_JOB_ALLOC(CONO,JOBNO)
END

IF SUM(JOB.WIP<1,2>) > 0 THEN
      	IF FSCAL.PER = "" THEN
      		MATREAD FISCAL.REC FROM CONTROL, CONO : "JCFISCAL" ELSE
      			ERRMSG<1,-1> = "Cannot locate CONTROL, JCFISCAL"
      			GOTO 501
      		END	
		READ DIVISION.REC FROM CONTROL, CONO:"DIVISIONS" ELSE
      			ERRMSG<1,-1> = "Cannot locate CONTROL, DIVISIONS"
      			GOTO 501
     		END
      		READ SECURITY.REC FROM CONTROL, CONO:"DIV.SECURITY" ELSE
      			ERRMSG<1,-1> = "Cannot locate CONTROL, DIV.SECURITY"
      		END
		DIV.CODE = JOB.DIV
		IF SECURITY.REC<1> = "Y" AND SECURITY.REC<2> = "Y" THEN
			IF DIV.CODE = "00" OR DIV.CODE = "ALL" THEN
				ERRMSG<1,-1> = " 'ALL' OR '00' INVALID WHEN DIVISION-LEVEL POSTING & CLOSING IS SELECTED"
				GOTO 501
			END
            		LOCATE DIV.CODE IN DIVISION.REC<1>,1 SETTING POS ELSE
              		ERRMSG<1,-1> = "Cannot locate ":DIV.CODE:" in Control File DIVISIONS Record"
              		GOTO 501
            		END
          	END ELSE
            		POS = 1
          	END
		FSCAL.PER = FR.CURR.PER<1,POS>
	END
       WIP.TYPE = "ALL"
       WIP.PERCENT = 10000
       WIP.DATE = "ALL"
       WIP.PER = "ALL"
       CALL REVERSE_JOB_WIP(CONO,JOBNO,WIP.TYPE,WIP.PERCENT,WIP.DATE,WIP.PER,FR.CURR.PER<1,POS>);* T23278
END

RESV.ACTION = "D"
GOSUB 600

IF SUM(JOB.ALOC.QTY) + 0 # 0 THEN
      	ERRMSG<1,-1> = "Product quantity still allocated for Job"
END

JOB.STATUS = INSERT(JOB.STATUS,1,1,0,"9")
JOB.STAT.DATE = INSERT(JOB.STAT.DATE,1,1,0,DATE())
LOCATE JOBNO IN CUST.JOB<1>,1 SETTING JFND ELSE
	CUST.JOB<1,JFND> = JOBNO
END

CUST.JOB.BAL<1,JFND> = 0
MATWRITE CUST.REC ON CUSTOMER , CONO : JOB.CUST
IF FILEINFO(JOB,0)=0 THEN
	OPEN '','JOB' TO JOB ELSE 
       	ERRMSG="JOB FILE IS MISSING";GOTO 99999
      	END
END

*CALL JKT_NOTIFY_SUB ("1",CONO,"JOB",JOBNO,"",JOB.REC.SIZE,MAT JOB.REC,JOB,JSTATUS)
MATWRITE JOB.REC ON JOB , CONO : JOBNO

IF OJFS.PROD # "" THEN
	GOSUB 650
END
501   	
GOTO 99999


600*
RESV.LOC = 0
INV.M.LINE = ''
INV.UNIT = ''
CALL JOBM_RESV_SUB(CONO,RESV.ACTION,RESV.LOC,JOBNO)

MCNT = COUNT(JOB.RESV.MATL,VM) + (JOB.RESV.MATL # "")
FOR M = MCNT TO 1 STEP -1
	IF JOB.RESV.QTY<1,M> + JOB.ALOC.QTY<1,M> + JOB.USED.QTY<1,M> = 0 THEN
      		JSTAT.ID = JOB.RESV.MATL<1,M>:"!":JOB.RESV.WHSE<1,M>:"!":JOBNO
      		MATREAD INV.JS.REC FROM INV.JOB.STATS, CONO : JSTAT.ID ELSE
        		JOB.RESV.MATL = DELETE(JOB.RESV.MATL,1,M,0)
        		JOB.RESV.WHSE = DELETE(JOB.RESV.WHSE,1,M,0)
        		JOB.RESV.DATE = DELETE(JOB.RESV.DATE,1,M,0)
        		JOB.ALOC.QTY = DELETE(JOB.ALOC.QTY,1,M,0)
       		JOB.RESV.QTY = DELETE(JOB.RESV.QTY,1,M,0)
        		JOB.USED.QTY = DELETE(JOB.USED.QTY,1,M,0)
        		JOB.ALOC.AMT = DELETE(JOB.ALOC.AMT,1,M,0)
        		JOB.RESV.AMT = DELETE(JOB.RESV.AMT,1,M,0)
        		JOB.USED.AMT = DELETE(JOB.USED.AMT,1,M,0)
      		END
    	END
NEXT M
RETURN


*---- ORD, JFS, FJS, FOS, & FGS update
650*
*
*---- Clear all allocated quantity
*
MCNT = DCOUNT(JFS.PROD,VM)
FOR M = 1 TO MCNT
	JFS.M.QTY<1,M> = JFS.F.QTY<1,M>
    	OCNT = DCOUNT(JFS.ORDER<1,M>,SVM)
    	FOR O = 1 TO OCNT
      		JFS.ORD.QTY<1,M,O> = 0
    	NEXT O
	JFS.A.QTY<1,M> = 0
NEXT M
*
*---- Load old allocated quantities
670*
NJFS.PROD = JFS.PROD
NJFS.WHSE = JFS.WHSE
NJFS.ORDER = JFS.ORDER
NJFS.ORD.QTY = JFS.ORD.QTY
MCNT = DCOUNT(JFS.PROD,VM)
FOR M = 1 TO MCNT
	JFS.ORDER<1,M> = ""
    	JFS.ORD.QTY<1,M> = ""
NEXT M

FOR M = 1 TO MCNT
	PDNO = JFS.PROD<1,M>; WHNO = JFS.WHSE<1,M>
    	PTR = 1
    	LOOP
      		LOCATE PDNO IN OJFS.PROD<1>,PTR SETTING PLOC THEN
        		IF WHNO = OJFS.WHSE<1,PLOC> THEN
          			JFS.ORDER<1,M> = OJFS.ORDER<1,PLOC>
          			JFS.ORD.QTY<1,M> = OJFS.ORD.QTY<1,PLOC>
          			OJFS.PROD = DELETE(OJFS.PROD,1,PLOC,0)
          			OJFS.WHSE = DELETE(OJFS.WHSE,1,PLOC,0)
          			OJFS.ORDER = DELETE(OJFS.ORDER,1,PLOC,0)
         			OJFS.ORD.QTY = DELETE(OJFS.ORD.QTY,1,PLOC,0)
          			PTR = 0
        		END
      		END ELSE
        		PTR = 0
      		END
    	   WHILE PTR DO
      		PTR = PLOC + 1
    	REPEAT
    		JFS.A.QTY<1,M> = SUM(JFS.ORD.QTY<1,M>)
NEXT M
MATWRITE JFS.REC ON JOB.FNGD.STATS, CONO:JOBNO
*
*---- Update FJS &  FGS with the manufacture quantity
*
FOR M = 1 TO MCNT
	PDNO = JFS.PROD<1,M>; WHNO = JFS.WHSE<1,M>
    	FGS.ID = CONO:PDNO:"!":WHNO
    	MATREADU FGS.REC FROM FNGD.STATS, FGS.ID ELSE
     		MAT FGS.REC = ""
    	END
    	LOCATE JOBNO IN FGS.JOB<1>,1 SETTING L ELSE
      		FGS.JOB<1,L> = JOBNO
      		FGS.A.QTY<1,L> = 0
    	END
	FGS.M.QTY<1,L> = JFS.M.QTY<1,M> - JFS.F.QTY<1,M>
    	IF FGS.M.QTY<1,L> < 0 THEN FGS.M.QTY<1,L> = 0
    	MATWRITE FGS.REC ON FNGD.STATS, FGS.ID
    	FJS.ID = FGS.ID:"!":JOBNO
    	MATREADU FJS.REC FROM FNGD.JOB.STATS, FJS.ID ELSE
      		MAT FJS.REC = ""
      		FJS.CUST = JOB.CUST
    	END
    	FJS.DATE = ICONV(JFS.DATE<1,M>,"D2/")
    	FJS.M.QTY = JFS.M.QTY<1,M>
    	FJS.F.QTY = JFS.F.QTY<1,M>
    	FJS.S.QTY = JFS.S.QTY<1,M>
    	MATWRITE FJS.REC ON FNGD.JOB.STATS, FJS.ID
NEXT M
*
*---- Load all the orders for all the products
*
ORDNOS = ""; PRDPTR = ""; ORDPTR = ""
GEN.SHPNO = "000"
FOR M = 1 TO MCNT
	OCNT = DCOUNT(NJFS.ORDER<1,M>,SVM)
	FOR O = 1 TO OCNT
		LOCATE NJFS.ORDER<1,M,O> IN ORDNOS,1 SETTING OLOC THEN
     			OPTR = DCOUNT(PRDPTR<OLOC>,VM) + 1
     			PRDPTR<OLOC,OPTR> = M
      			ORDPTR<OLOC,OPTR> = O
		END ELSE
     			ORDNOS<OLOC> = NJFS.ORDER<1,M,O>
      			PRDPTR<OLOC> = M
      			ORDPTR<OLOC> = O
		END
	NEXT O
NEXT M
*
*---- Update orders with the new allocated quantity
*
OCNT = DCOUNT(ORDNOS,AM)
FOR OP = 1 TO OCNT
	ORDNUM = ORDNOS<OP>
    	PCNT = DCOUNT(ORDPTR<OP>,VM)
    	MATREADU ORD.REC FROM ORDER, CONO:ORDNUM ELSE
      		RELEASE ORDER, CONO:ORDNUM
      		FOR PP = 1 TO PCNT
        		M = PRDPTR<OP,PP>; O = ORDPTR<OP,PP>
        		PDNO = NJFS.PROD<1,M>; WHNO = NJFS.WHSE<1,M>
        		NJFS.ORD.QTY<1,M,O> = 0
        		GOSUB 680
      		NEXT PP
      		GOTO 674
    	END
	STATUS = "L"; SHPNO = "ALL"
    	CALL ORDER_LINE_UPD(CONO,ORDNUM,SHPNO,STATUS)
    	SHPNO = GEN.SHPNO
    	PCNT = DCOUNT(ORDPTR<OP>,VM)
    	FOR PP = 1 TO PCNT
      		M = PRDPTR<OP,PP>; O = ORDPTR<OP,PP>
      		PDNO = NJFS.PROD<1,M>; WHNO = NJFS.WHSE<1,M>
      		PTR = 1
      		LOOP
        		LOCATE PDNO IN ODQ.PROD<1>,PTR SETTING PLOC THEN
          			IF WHNO = ODQ.WHSE<1,PLOC> AND ODQ.KIT<1,PLOC> = "N" THEN
            				PTR = 0
          			END
        		END ELSE
          			PLOC = 0; PTR = 0
        		END
      		  WHILE PTR DO
        		PTR = PLOC + 1
      		REPEAT
      		IF PLOC = 0 THEN
        		RELEASE ORDER, CONO:ORDNUM
        		NJFS.ORD.QTY<1,M,O> = 0
        		GOSUB 680; GOTO 672
      		END
		TOT.A.QTY = NJFS.ORD.QTY<1,M,O>; JPTR = 1
      		LOOP
        		LOCATE JOBNO IN ODQ.JOB<1,PLOC>,JPTR SETTING JL THEN
          			BEGIN CASE
            				CASE TOT.A.QTY >= ODQ.JOB.QTY<1,PLOC,JL>
              				TOT.A.QTY = TOT.A.QTY - ODQ.JOB.QTY<1,PLOC,JL>
              				JPTR = JL + 1
            				CASE TOT.A.QTY > 0
              				ODQ.JOB.QTY<1,PLOC,JL> = TOT.A.QTY
              				TOT.A.QTY = 0
             					JPTR = JL + 1
            				CASE 1
              				ODQ.JOB.QTY<1,PLOC,JL> = 0
          			END CASE
        		END ELSE
          			JL = 0
        		END
      		WHILE JL DO REPEAT
		IF TOT.A.QTY < 1 THEN GOTO 672
      		JPTR = 1
      		LOOP
        		LOCATE JOBNO IN ODQ.JOB<1,PLOC>,JPTR SETTING JL THEN
          			IF ODQ.JOB.SHPNO<1,PLOC,JL> = SHPNO THEN
           				ODQ.JOB.QTY<1,PLOC,JL> = ODQ.JOB.QTY<1,PLOC,JL> + TOT.A.QTY
            				JL = 0
          			END
        		END ELSE
          			INS JOBNO BEFORE ODQ.JOB<1,PLOC,1>
          			INS TOT.A.QTY BEFORE ODQ.JOB.QTY<1,PLOC,1>
          			INS GEN.SHPNO BEFORE ODQ.JOB.SHPNO<1,PLOC,1>
          			JL = 0
        		END
      		  WHILE JL DO
        		JPTR = JL + 1
      		REPEAT
      		ODQ.A.QTY<1,PLOC> = SUM(ODQ.JOB.QTY<1,PLOC>)
672*
    	NEXT PP
    	STATUS = "U"; SHPNO = ""
    	CALL ORDER_LINE_UPD(CONO,ORDNUM,SHPNO,STATUS)
674*
NEXT OP	
*
*---- Update orders with zero out allocated quantity
*
ORDNOS = ""; PRDPTR = ""; ORDPTR = ""
MCNT = DCOUNT(OJFS.PROD,VM)
FOR M = 1 TO MCNT
	OCNT = DCOUNT(OJFS.ORDER<1,M>,SVM)
    	FOR O = 1 TO OCNT
      		LOCATE OJFS.ORDER<1,M,O> IN ORDNOS,1 SETTING OLOC THEN
        		OPTR = DCOUNT(PRDPTR<OLOC>,VM) + 1
        		PRDPTR<OLOC,OPTR> = M
        		ORDPTR<OLOC,OPTR> = O
      		END ELSE
        		ORDNOS<OLOC> = OJFS.ORDER<1,M,O>
        		PRDPTR<OLOC> = M
        		ORDPTR<OLOC> = O
      		END
    	NEXT O
NEXT M
OCNT = DCOUNT(ORDNOS,AM)
FOR OP = 1 TO OCNT
	ORDNUM = ORDNOS<OP>
    	PCNT = DCOUNT(ORDPTR<OP>,VM)
    	MATREADU ORD.REC FROM ORDER, CONO:ORDNUM ELSE
      		RELEASE ORDER, CONO:ORDNUM
      		FOR PP = 1 TO PCNT
        		M = PRDPTR<OP,PP>; O = ORDPTR<OP,PP>
        		PDNO = OJFS.PROD<1,M>; WHNO = OJFS.WHSE<1,M>
        		GOSUB 680
      		NEXT PP
      		GOTO 678
    	END 
	STATUS = "L"; SHPNO = "ALL"
    	CALL ORDER_LINE_UPD(CONO,ORDNUM,SHPNO,STATUS)
    	SHPNO = GEN.SHPNO
    	PCNT = DCOUNT(ORDPTR<OP>,VM)
    	FOR PP = 1 TO PCNT
      		M = PRDPTR<OP,PP>; O = ORDPTR<OP,PP>
      		PDNO = OJFS.PROD<1,M>; WHNO = OJFS.WHSE<1,M>
      		PTR = 1
      		LOOP
        		LOCATE PDNO IN ODQ.PROD<1>,PTR SETTING PLOC THEN
          			IF WHNO = ODQ.WHSE<1,PLOC> THEN
            				PTR = 0
          			END
        		END ELSE
          			PLOC = 0; PTR = 0
        		END
      		  WHILE PTR DO
        		PTR = PLOC + 1
      		REPEAT
      		IF PLOC = 0 THEN
        		RELEASE ORDER, CONO:ORDNUM
        		GOSUB 680; GOTO 676
      		END
      		TOT.A.QTY = 0; JPTR = 1
      		LOOP
        		LOCATE JOBNO IN ODQ.JOB<1,PLOC>,JPTR SETTING JL THEN
          			ODQ.JOB.QTY<1,PLOC,JL> = 0
          			JPTR = JL + 1
        		END ELSE
          			JL = 0
        		END
      		WHILE JL DO REPEAT
676*
	NEXT PP
	STATUS = "U"; SHPNO = ""
    	CALL ORDER_LINE_UPD(CONO,ORDNUM,SHPNO,STATUS)
678*
NEXT OP

MATREADU JFS.REC FROM JOB.FNGD.STATS, CONO:JOBNO ELSE MAT JFS.REC = ""
MCNT = DCOUNT(OJFS.PROD,VM)
FOR M = 1 TO MCNT
	PDNO = OJFS.PROD<1,M>; WHNO = OJFS.WHSE<1,M>
    	FGS.ID = CONO:PDNO:"!":WHNO
    	FJS.ID = FGS.ID:"!":JOBNO
    	MATREADU FJS.REC FROM FNGD.JOB.STATS, FJS.ID THEN
      		DELETE FNGD.JOB.STATS, FJS.ID
    	END ELSE
      		RELEASE FNGD.JOB.STATS, FJS.ID
    	END
    	MATREADU FGS.REC FROM FNGD.STATS, FGS.ID THEN
      		LOCATE JOBNO IN FGS.JOB<1>,1 SETTING L THEN
        		FGS.JOB = DELETE(FGS.JOB,1,L,0)
        		FGS.M.QTY = DELETE(FGS.M.QTY,1,L,0)
        		FGS.A.QTY = DELETE(FGS.A.QTY,1,L,0)
      		END
      		IF FGS.JOB = "" AND FGS.ORDER = "" THEN
        		DELETE FNGD.STATS, FGS.ID
      		END ELSE
        		MATWRITE FGS.REC ON FNGD.STATS, FGS.ID
      		END
    	END ELSE
      		RELEASE FNGD.STATS, FGS.ID
    	END
    	PTR = 1
    	LOOP
      		LOCATE PDNO IN JFS.PROD<1>,PTR SETTING PLOC THEN
        		IF WHNO = JFS.WHSE<1,PLOC> THEN
          			JFS.PROD = DELETE(JFS.PROD,1,PLOC,0)
          			JFS.WHSE = DELETE(JFS.WHSE,1,PLOC,0)
          			JFS.DATE = DELETE(JFS.DATE,1,PLOC,0)
          			JFS.M.QTY = DELETE(JFS.M.QTY,1,PLOC,0)
          			JFS.A.QTY = DELETE(JFS.A.QTY,1,PLOC,0)
         			JFS.F.QTY = DELETE(JFS.F.QTY,1,PLOC,0)
          			JFS.S.QTY = DELETE(JFS.S.QTY,1,PLOC,0)
         			JFS.ORDER = DELETE(JFS.ORDER,1,PLOC,0)
          			JFS.ORD.QTY = DELETE(JFS.ORD.QTY,1,PLOC,0)
          			PTR = 0
        		END
      		END ELSE
        		PTR = 0
      		END
    	  WHILE PTR DO
      		PTR = PLOC + 1
    	REPEAT
NEXT M
IF JFS.PROD # "" THEN
	MATWRITE JFS.REC ON JOB.FNGD.STATS, CONO:JOBNO
END ELSE
	DELETE JOB.FNGD.STATS, CONO:JOBNO
END
RETURN
*
*---- Zero out allocated for the FJS
680*
FJS.ID = CONO:PDNO:"!":WHNO:"!":JOBNO
MATREADU FJS.REC FROM FNGD.JOB.STATS, FJS.ID THEN
	LOCATE ORDNUM IN FJS.ORD<1>,1 SETTING FND THEN
      		FJS.ORD = DELETE(FJS.ORD,1,FND,0)
      		FJS.ORD.QTY = DELETE(FJS.ORD.QTY,1,FND,0)
      		FJS.A.QTY = SUM(FJS.ORD.QTY)
      		MATWRITE FJS.REC ON FNGD.JOB.STATS, FJS.ID
    	END ELSE
      		RELEASE FNGD.JOB.STATS, FJS.ID
    	END
END ELSE
	RELEASE FNGD.JOB.STATS, FJS.ID
END
RETURN

99999
IF ERRMSG # '' THEN
*T416 v STATUS = RBO.setProperty('','ServerStatus','E')        
	STATUS = RBO.setProperty('','ServerStatus','1')        
	STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
END ELSE
	STATUS = RBO.setProperty('','ServerStatus','')        
	STATUS = RBO.setProperty('','ServerMessage','')
END
RETURN
