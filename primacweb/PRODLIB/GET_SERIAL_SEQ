FUNCTION GET_SERIAL_SEQ
*********************************************************************
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - EPRIMAC
* SOURCE      - FUNBP
* PROGRAM     - GET_SERIAL_SEQ
* BY          - KHAJA ZIAUDDIN
* DATE        - 06/19/2003  (mm/dd/yyyy)
* DESCRIPTION - This program gets the next available Serial number from Control File
*		   
*ENDDOC
*************************************************************
$INCLUDE WWINSERT RBO.H

STATUS = RBO.getProperty('','PMCProperty',PMCPROPERTY)
CONO = PMCPROPERTY<1,4>

OPEN '','CONTROL' TO CONTROL ELSE
	ERRMSG = 'CONTROL FILE IS MISSING'
	GOTO 93000
END
OPEN '','INV_SERIAL' TO INV_SERIAL ELSE
	ERRMSG = 'INV_SERIAL FILE IS MISSING'
	GOTO 93000
END

* Insert method code here
IF FILEINFO(INV_SERIAL_TEMP,0)=0 THEN 
	OPEN '','INV_SERIAL_TEMP' TO INV_SERIAL_TEMP ELSE STOP "INV_SERIAL_TEMP FILE IS MISSING"
END

READU SERIAL.SEQ FROM CONTROL, CONO:"ISTK.SEQ" ELSE
	SERIAL.SEQ = 0
END

FND=0
SERIAL.NO=0
LOOP
	SERIAL.SEQ += 1
  	IF SERIAL.SEQ > 9999999 THEN SERIAL.SEQ = 1
  	SERIAL.SEQ =  SERIAL.SEQ"R%7"
  	CALL CHECK_DIGIT("C",SERIAL.SEQ,"10RL",CKDIG,VALID)
  	SERIAL.NO=SERIAL.SEQ:CKDIG
  	ISTK.ID = CONO:SERIAL.NO
  	IF VALID THEN
    		IF RECORDLOCKED(INV_SERIAL_TEMP,ISTK.ID) = 0 THEN
      			DELETE INV_SERIAL_TEMP,ISTK.ID
    		END
    		READU CHECKREC FROM INV_SERIAL_TEMP,ISTK.ID LOCKED
      		NULL
    	END ELSE
      		READU CHECKREC FROM INV_SERIAL,ISTK.ID THEN
        		RELEASE INV_SERIAL, ISTK.ID
        		RELEASE INV_SERIAL_TEMP,ISTK.ID
      		END ELSE
        		FND = 1
      		END
    	END
END
UNTIL FND DO
	RELEASE INV_SERIAL,ISTK.ID
REPEAT

WRITE SERIAL.SEQ ON CONTROL,CONO:"ISTK.SEQ"
*RETURN SERIAL.NO
STATUS = RBO.setProperty('','NewSerial',SERIAL.NO)

* End of method code
RETURN SERIAL.NO


93000
   STATUS = RBO.setProperty('','ServerStatus',1)
   STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN
