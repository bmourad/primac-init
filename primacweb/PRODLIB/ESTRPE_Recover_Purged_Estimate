SUBROUTINE ESTRPE_Recover_Purged_Estimate
********************************************************************************
*   Program name :- ESTRPE_Recover_Purged_Estimate
*   Created:- 4/13/2005
*------------------------------------------------------------------------------*
*
* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE CPYLIB SCOMMON1
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE JES.CPYLIB ESTIMATE
$INCLUDE JES.CPYLIB ESTIMATE.DEPT
*T25237 v
$INCLUDE JES.CPYLIB ESTIMATE.RES
*T25237 ^
$INCLUDE CPYLIB CHAR
$INCLUDE CPYLIB SYSCOM

*
*---- OPEN ALL FIILES
*
  OPEN "","COMPANY" TO COMPANY ELSE
      ERRMSG="CANNOT OPEN COMPANY FILE"
      ServerStatus = 1
      GOTO 90000
      STOP
  END
  OPEN "","CONTROL" TO CONTROL ELSE
      ERRMSG="CANNOT OPEN CONTROL FILE"
      ServerStatus = 1
      GOTO 90000
      STOP
  END
  OPEN "","PREFIX" TO PREFIX ELSE
      ERRMSG="CANNOT OPEN PREFIX FILE"
      ServerStatus = 1
      GOTO 90000
      STOP
  END
  OPEN "","ESTIMATE" TO ESTIMATE ELSE
      ERRMSG="CANNOT OPEN ESTIMATE FILE"
      ServerStatus = 1
      GOTO 90000
      STOP
  END
*  OPEN "","JES.SCREENS" TO M.SCREENS ELSE
*      ERRMSG="CANNOT OPEN JES.SCREENS FILE"
*      GOTO 90000
*      STOP
*  END
  OPEN "","ESTIMATE.DEPT" TO ESTIMATE.DEPT ELSE
      ERRMSG="CANNOT OPEN ESTIMATE.DEPT FILE"
      ServerStatus = 1
      GOTO 90000
      STOP
  END
  OPEN "","ESTIMATE.PURGE.BU" TO ESTIMATE.PURGE.BU ELSE
      ERRMSG="CANNOT OPEN ESTIMATE.PURGE.BU FILE"
      ServerStatus = 1
      GOTO 90000
      STOP
  END
  OPEN "","CUST.EST.XREF" TO CUST.EST.XREF ELSE
      ERRMSG="CANNOT OPEN CUST.EST.XREF FILE"
      ServerStatus = 1
      GOTO 90000
      STOP
  END
  OPEN "","PROSPECT.EST.XREF" TO PROSPECT.EST.XREF ELSE
      ERRMSG="CANNOT OPEN PROSPECT.EST.XREF FILE"
      ServerStatus = 1
      GOTO 90000
      STOP
  END
*T25237 v
  OPEN "","ESTIMATE.RES" TO ESTIMATE.RES ELSE
     ERRMSG="CANNOT OPEN ESTIMATE.RES FILE"
     ServerStatus = 1
     GOTO 90000
     STOP
  END
  OPEN "","ESTIMATE.RL" TO ESTIMATE.RL ELSE
     ERRMSG="CANNOT OPEN ESTIMATE.RL FILE"
     ServerStatus = 1
     GOTO 90000
     STOP
  END
*T25237 ^
*
*---- INITIALIZATION
*
  CONO=""
  ServerStatus = 0
*
*---- MAIN PROCESSING
*
100*
RELEASE

STATUS=RBO.getProperty('','Cono',CONO)
STATUS=RBO.getProperty('','EstimateID',EST.KEY)
 
  MATREADU EST.REC FROM ESTIMATE.PURGE.BU, CONO:EST.KEY ELSE
      ERRMSG = "Estimate number ":EST.KEY:" cannot be recovered."
      ServerStatus = 1
      GOTO 90000
  END
*T23278 v
  DIV.CODE = EST.DIV; USER.ID = UPCASE(@LOGNAME); ERRMSG = ''
  CALL SI.CK.DIV.SEC.SUB(CONO,DIV.CODE,USER.ID,ERRMSG)
  IF ERRMSG # '' THEN
      GOTO 90000
  END
*T23278 ^
    GOTO 2000	
*
*---- RECOVER ESTIMATE
*
2000*
**  P_X  = 3 ; P_Y = 23 ; P_VALUE = "Processing Estimate - ":EST.KEY ; P_OPT = "CL"
**  CALL VSI_SI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
  RCV.KEY = EST.KEY
  RCV.DEPT.COMP = EST.DEPT.COMP
  RCV.SUBS = EST.SUBS
  IF RCV.SUBS # "" THEN
      SAVE.KEY = RCV.KEY
      SAVE.DEPT.COMP = RCV.DEPT.COMP
      SC = COUNT(RCV.SUBS,@VM) + (RCV.SUBS # "")
      FOR SP = 1 TO SC
          RCV.KEY = RCV.SUBS<1,SP>
          MATREADU EST.REC FROM ESTIMATE.PURGE.BU, CONO:RCV.KEY ELSE GOTO 2090
          RCV.DEPT.COMP = EST.DEPT.COMP
          GOSUB 3000
2090  NEXT SP
      RCV.KEY = SAVE.KEY
      RCV.DEPT.COMP = SAVE.DEPT.COMP
      MATREADU EST.REC FROM ESTIMATE.PURGE.BU, CONO:RCV.KEY ELSE
          MAT EST.REC = ""
      END
  END
  GOSUB 3000
  ERRMSG = "** Recovery Complete **"
  ServerStatus = 1
STATUS=RBO.setProperty('','ServerStatus',ServerStatus)
STATUS=RBO.setProperty('','ServerMessage',ERRMSG)
	
  RETURN
*
*---- RESTORE ESTIMATE RECORDS
*
3000*
  DC = COUNT(RCV.DEPT.COMP,@VM) + (RCV.DEPT.COMP # "")
  FOR DP = 1 TO DC
      DDKEY = RCV.KEY:"!":RCV.DEPT.COMP<1,DP>
      READU REC FROM ESTIMATE.PURGE.BU, CONO:DDKEY ELSE
          RELEASE ESTIMATE.PURGE.BU, CONO:DDKEY
          GOTO 3090
      END
      WRITE REC ON ESTIMATE.DEPT, CONO:DDKEY
      DELETE ESTIMATE.PURGE.BU, CONO:DDKEY
3090 NEXT DP
  MATWRITE EST.REC ON ESTIMATE, CONO:RCV.KEY
  BEGIN CASE
      CASE EST.CUST = "P"
          CALL GEN.XREF.MAINT(CONO,EST.KEY,"",EST.CUST.NAME,PROSPECT.EST.XREF,PREFIX)
      CASE 1
          CALL GEN.XREF.MAINT(CONO,EST.KEY,"",EST.CUST,CUST.EST.XREF,PREFIX)
  END CASE
  DELETE ESTIMATE.PURGE.BU, CONO:RCV.KEY
*T25237 v
  MATREAD EST.RL.REC FROM ESTIMATE.PURGE.BU, CONO:RCV.KEY:'!RES' THEN
     MATWRITE EST.RL.REC ON ESTIMATE.RES, CONO:RCV.KEY
     DELETE ESTIMATE.PURGE.BU, CONO:RCV.KEY:'!RES'
  END
  READ OLD.REC FROM ESTIMATE.PURGE.BU, CONO:RCV.KEY:'!RL' THEN
     WRITE OLD.REC ON ESTIMATE.RL, CONO:RCV.KEY
     DELETE ESTIMATE.PURGE.BU, CONO:RCV.KEY:'!RL'
  END
*T25237 ^
  RETURN
*
*---- ERROR ROUTINE
*
90000*
STATUS=RBO.setProperty('','ServerStatus',ServerStatus)
STATUS=RBO.setProperty('','ServerMessage',ERRMSG)
RETURN

