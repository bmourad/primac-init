SUBROUTINE RELM_RESV_QTY
********************************************************************************
*   Program name :- RELM_RESV_QTY
*   Created:- 12/16/2005
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H

$INCLUDE OPS.CPYLIB ORDER.DETAIL
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE OPS.CPYLIB ORDER

$INCLUDE ICS.CPYLIB INV.CNV
$INCLUDE CPYLIB CHAR


* Insert method code here
OPEN '','ORDER.DETAIL' TO ORDER.DETAIL ELSE
      ERRMSG='CANNOT OPEN ORDER.DETAIL FILE'
      GOTO 1000
END

OPEN '',"INV.WHSE" TO INV.WHSE ELSE
         ERRMSG = "Cannot locate the INV.WHSE file"
	  GOTO 1000
      END

OPEN '','INVENTORY' TO INVENTORY ELSE
      ERRMSG='CANNOT OPEN INVENTORY FILE'
      GOTO 1000
END

OPEN '',"ORDER" TO ORDER ELSE
         ERRMSG = "Cannot locate the ORDER file"
	GOTO 1000
END

OPEN '','CONTROL' TO CONTROL ELSE
      ERRMSG='CANNOT OPEN CONTROL FILE'
      GOTO 1000
END


*ID = ''
CONO=''
ORR_ORD =''
ORR_SHIP_TO=''
ERRMSG = ''
RELNO =''
DEFAULT_RSV_QTY = ''
OSD_R_QTY =''
ITEM = ''
WHSE_NO=''
ORDNO=''
PDNO = ''
WHNO=''
SHPNO = ''
PROD.SEQ = ''
KIT.TYPE=''
RESRV_VALUE = ''
ORD.CUST = ''
*STATUS = RBO.getProperty('','CONO',CONO)	
STATUS = RBO.getProperty('','ORR_ORD',ORR_ORD)		;*ORDER NO
STATUS = RBO.getProperty('','ORR_SHIP_TO',ORR_SHIP_TO);*SHIP TO

STATUS = RBO.getProperty('','OSD_ITEM',OSD_ITEM)	;*ITEM
STATUS = RBO.getProperty('','WHSE_NO',WHSE_NO)		;*WHSE NO.
STATUS = RBO.getProperty('','RELEASE_NO',RELNO)	;*RELEASE NO.
STATUS = RBO.getProperty('','RESV_QTY',RESV_QTY)	;*ORDER RESERVED QTY
*STATUS = RBO.getProperty('','ORDER_QTY',ORDER_QTY)	;*ORDER QTY

STATUS = RBO.getProperty('','INDEX',LN)			;*INDEX
STATUS = RBO.getProperty('','OSD_R_VAL',VALUE)		;*INPUT FOR RESRV QTY


*"00110095!001!4567!01!10095-05!0!1!0"
CONO = ORR_ORD[1,3]

ORR_ORD = ORR_ORD[4,99]
MATREAD INV.REC FROM INVENTORY,CONO:OSD_ITEM ELSE
	ERRMSG='CANNOT READ INVENTORY FILE':"    ":CONO:OSD_ITEM
	GOTO 1000
END

$INCLUDE ICSBP INV.UM.CNV

MATREAD ORD.REC FROM ORDER, CONO:ORR_ORD ELSE
      ERRMSG = "Cannot locate order # ":ORR_ORD
	GOTO 1000
END

*MATREAD ORD.DET.REC FROM ORDER.DETAIL,"00110095!001" ELSE
MATREAD ORD.DET.REC FROM ORDER.DETAIL,CONO:ORR_ORD:"!":ORR_SHIP_TO ELSE
 ERRMSG='CANNOT READ ORDER.DETAIL FILE ' 
 GOTO 1000
END 

*WRITE 'ORR_ORD':ORR_ORD ON CONTROL,"01YAKUB"
MINV = 0; MAXV = RESV_QTY
 			 RELQTY = 0; PTR = 1
  			LOOP
    				LOCATE RELNO IN OSD.REL.NO<1,LN>,PTR SETTING FND THEN
     				 RELQTY = RELQTY + OSD.REL.QTY<1,LN,FND>
    				END ELSE
     				 PTR = 0
    				END
  			WHILE PTR DO
    				PTR = FND + 1
  			REPEAT
  				O.R = "O"
  			IF RELQTY > 0 THEN
   			 	DEFAULT_RSV_QTY = OCONV(INT(((RELQTY / ICR.DV1) * ICR.MT1) / ICR.DV2 + .5),ICR.CNV)
  			END ELSE
    			 	DQTY = OSD.R.QTY<1,LN> - SUM(OSD.REL.QTY<1,LN>)
   				 DEFAULT_RSV_QTY = OCONV(INT(((DQTY / ICR.DV1) * ICR.MT1) / ICR.DV2 + .5),ICR.CNV)
  			END

				RTYPE = "B"
      				ORDNO = ORR_ORD
      				PDNO = OSD_ITEM
     				 WHNO = WHSE_NO
     			 PROD.SEQ = OSD.PROD.SEQ<1,LN> ; KIT.TYPE = OSD.KIT<1,LN>
     		 	IWH.ID=CONO:PDNO:"!":WHNO


         	MATREAD IWH.REC FROM INV.WHSE,IWH.ID THEN
        		ERR.FLG='';ERRMSG='';PERIOD='';OPEN.FLAG = 1
        		CALL BUILD_IWH_FI(IWH.ID,MAT IWH.REC,PERIOD,ERR.FLG,ERRMSG,OPEN.FLAG)

        	END ELSE
      			MAT IWH.REC = ""
      	 	END
      			RTOT = RESV_QTY   ;*OSD.R.QTY<1,I>
     			RELQTY = INT(((VALUE / ICR.MT1) * ICR.DV1) * ICR.DV2 + .5)
     		 	RQTY = OSD.FI.QTY<1,LN>
     		 	RSV.NO = OSD.RECP.NO<1,LN>
      			REL.NO = OSD.REL.NO<1,LN>
      			REL.QTY = OSD.REL.QTY<1,LN>
			SHPNO = ORR_SHIP_TO




     			*CALL ORDER_RESERVE_SEL(CONO,"S",ORD.CUST,ORDNO,SHPNO,PDNO,WHNO,RTYPE,RTOT,RQTY,RSV.NO,REL.NO,REL.QTY,RELNO,RELQTY,PROD.SEQ,KIT.TYPE,"","")

      			OSD.RECP.NO<1,LN> = RSV.NO
      			OSD.FI.QTY<1,LN> = RQTY
      			OSD.REL.NO<1,LN> = REL.NO
      			OSD.REL.QTY<1,LN> = REL.QTY
      			OSD.R.QTY<1,LN> = RTOT
		RESRV_VALUE = OCONV(INT(((RTOT / ICR.DV1) * ICR.MT1) / ICR.DV2 + .5),ICR.CNV1) 

		*IF RESV_QTY > ORDER_QTY THEN
		IF OSD.R.QTY<1,LN> > OSD.O.QTY<1,LN> THEN
   			ERRMSG = "Reserve is more than required"
    			GOTO 1000
 		END

		STATUS = RBO.setProperty('','DEFAULT_RSV_QTY',DEFAULT_RSV_QTY)
		STATUS = RBO.setProperty('','RESRV_VALUE',RESRV_VALUE)
RETURN

1000*
   IF ERRMSG # "" THEN
      STATUS = RBO.setProperty('','ServerStatus', 1)
      STATUS = RBO.setProperty('','ServerMessage', ERRMSG)            
   END

* End of method code
RETURN
