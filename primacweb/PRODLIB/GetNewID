  SUBROUTINE GetNewID
**************************************************************************
*   Program name :- GetNewID
*   Created:- 11/12/2002
*   Author:- Edvard Pitka
*------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
**************************************************************************
  $INCLUDE WWINSERT RBO.H
*
  IF FILEINFO(CONTROL,0)=0 THEN
    OPEN '','CONTROL' TO CONTROL ELSE
      ERRMSG="FILE IS MISSING"
      GOTO 93000
    END
  END
  STATUS=RBO.getProperty('','ID',ID)
  CONO=ID[1,3]
  STATUS=RBO.getProperty('','new_item',NEW.ITEM)
  IF NEW.ITEM=1 THEN
    STATUS=RBO.getProperty('','data_file',DATA.FILE)
    STATUS=RBO.getProperty('','ID',ID)
    CONO=ID[1,3]
    FILL.WITH.ZERO = 0
    BEGIN CASE
      CASE DATA.FILE="JOB"
      CASE DATA.FILE="PO"
      CASE DATA.FILE="ORDER"
      CASE DATA.FILE="FNGD.BOM"
        NAME="BOM"
        MIN.SEQ=1000
        MAX.SEQ=9999999999
        GOSUB GET.ID
      CASE DATA.FILE='AUTO.VOUCHERS'
        NAME='AUTOVOUCHER'
        MIN.SEQ=1
        MAX.SEQ=999999
        GOSUB GET.ID
      CASE DATA.FILE = "JE.RECUR"
        NAME = DATA.FILE
        MIN.SEQ = 1
        MAX.SEQ = 99999999
        FILL.WITH.ZERO = 1
        GOSUB GET.ID
      CASE DATA.FILE='JE.REVERSE'
        NAME='JE.REVERSE'
        MIN.SEQ=1
        MAX.SEQ=99999999
        FILL.WITH.ZERO=1
        GOSUB GET.ID
    END CASE
    IF DATA.FILE.ID#'' THEN
      STATUS=RBO.setProperty('','ID',DATA.FILE.ID)
    END ELSE
      ERRMSG='Could not retrive new record ID'
      GOTO 93000
    END
  END ELSE
    ERRMSG='This is not a new record'
    GOTO 93000
  END

  GOTO 99999

****************************************************************************
*
*****************
GET.ID: 
*****************
*
  CONTROL.ID=CONO:NAME
  DATA.FILE.ID=""
  READU SEQ FROM CONTROL, CONTROL.ID ELSE    
    SEQ=MIN.SEQ-1                                         
  END                                                         
  DONE =0                                                     
  LOOP                                                        
    SEQ +=1                                             
    IF SEQ > MAX.SEQ THEN SEQ = MIN.SEQ             
    IF FILL.WITH.ZERO THEN
      TMP = LEN(MAX.SEQ)
      DATA.FILE.ID = CONO:SEQ 'R%'TMP
    END ELSE
      DATA.FILE.ID=CONO:SEQ                                
    END
    READU CHECK.REC FROM DATA.FILE, DATA.FILE.ID  THEN   
      RELEASE DATA.FILE, DATA.FILE.ID                   
    END ELSE                                                  
      DONE=1                                                  
    END                                                       
  UNTIL DONE DO  REPEAT                                       
  WRITE SEQ ON CONTROL, CONTROL.ID 
  RETURN

93000 
  STATUS = RBO.setProperty('','ServerStatus',1)        
  STATUS = RBO.setProperty('','ServerMessage',ERRMSG) 

99999 
  RETURN
