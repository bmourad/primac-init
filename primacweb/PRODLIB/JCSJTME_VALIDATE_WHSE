SUBROUTINE JCSJTME_VALIDATE_WHSE
********************************************************************************
*   Program name :- JCSJTME_VALIDATE_WHSE
*   Created:- 9/15/2005
*   By :- S.Zahoor Ahmed
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H

* Insert method code here
$INCLUDE ICS.CPYLIB WAREHOUSE
$INCLUDE JCS.CPYLIB JOB
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE JCS.CPYLIB OPERATION
$INCLUDE PMC.CPYLIB COST.CNTR
$INCLUDE ICS.CPYLIB INV_SERIAL
$INCLUDE ICS.CPYLIB INV.WHSE.LOC
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE ICS.CPYLIB CATEGORY
$INCLUDE CPYLIB CHAR
*
*---- INITIALIZATION
*
   ESTAT=""
*
  OPEN "","INV_SERIAL" TO INV_SERIAL ELSE ERRMSG="INV_SERIAL FILE IS MISSING";GOTO 93000
  OPEN "","CONTROL" TO CONTROL ELSE ERRMSG="INV_SERIAL FILE IS MISSING";GOTO 93000
  OPEN "","INV.WHSE.LOC" TO INV.WHSE.LOC ELSE ERRMSG="INV.WHSE.LOC FILE IS MISSING";GOTO 93000
  OPEN "","INVENTORY" TO INVENTORY ELSE ERRMSG="INVENTORY FILE IS MISSING";GOTO 93000
  OPEN "","INV.WHSE" TO INV.WHSE ELSE ERRMSG="INV.WHSE FILE IS MISSING";GOTO 93000
  OPEN "","JOB" TO JOB ELSE ERRMSG = "CANNOT OPEN JOB FILE"; GOTO 93000
  OPEN "","COMPANY" TO COMPANY ELSE ERRMSG="CANNOT OPEN COMPANY FILE";GOTO 93000
  OPEN "","WAREHOUSE" TO WAREHOUSE ELSE ERRMSG="CANNOT OPEN WAREHOUSE FILE";GOTO 93000
  OPEN "","CATEGORY" TO CATEGORY ELSE ERRMSG="CATEGORY FILE IS MISSING";GOTO 93000
  OPEN "","OPERATION" TO OPERATION ELSE ERRMSG="CANNOT OPEN OPERATION FILE";GOTO 93000
  OPEN '','COST.CNTR' TO COST.CNTR ELSE ERRMSG='COST.CNTR FILE IS MISSING'; GOTO 93000
*Initialisation
   PROD_ID=""
   SERIAL_ID=""
   WHSE_ID = ""
   LOCAT_ID = ""  
   ERR = ""
   LO.CNT = ""
  
  
  STATUS=RBO.getProperty('','PMCProperty',PMCProperty)
  STATUS=RBO.getProperty('','PROD',PROD)
  CONO   = PMCProperty<1,4>
  STATUS=RBO.getProperty('','SERIAL_ID',SERIAL_ID)
  STATUS=RBO.getProperty('','WHSE_ID',WHSE_ID)
  STATUS=RBO.getProperty('','LOC_ID',LOCAT_ID)
  STATUS=RBO.getProperty('','JOB_ID',JOB_ID)


MATREAD COMP.REC FROM COMPANY, CONO ELSE MAT COMP.REC = "" 
MATREAD JOB.REC FROM JOB,CONO:JOB_ID ELSE
     MAT JOB.REC=''
END


	    MATREAD INV.REC FROM INVENTORY,CONO:PROD ELSE
             ERRMSG="Invalid product ID. Try again! "
	      ERR = 1
             GOTO 93000
           END

	    MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE ELSE
             ERRMSG="Cannot locate product line. Try again! "
	      ERR = 1
             GOTO 93000
          END  
	   LOCATE WHSE_ID IN INV.WHSE.CODE<1>,1 SETTING FND ELSE
                     ERRMSG="Invalid Warehouse. Try again! "
	      		ERR = 2
                     GOTO 93000
          END
            IF CO.INTR.WHSE # "" AND CO.INTR.WHSE = WHSE_ID THEN
               ERRMSG = 'Cannot use an Inter-Divisional Warehouse'
	        ERR = 1
               GOTO 93000
            END
            MATREAD WHSE.REC FROM WAREHOUSE,CONO:WHSE_ID ELSE
               MAT WHSE.REC = ""
            END
            IF WHS.DIV # JOB.DIV AND WHS.DIV # "00" THEN
               ERRMSG="Warehouse Div ":WHS.DIV:" does not match Job Div ":JOB.DIV
      	        ERR = 1
               GOTO 93000
            END
         MATREAD IWH.REC FROM INV.WHSE,CONO:PROD:"!":WHSE_ID ELSE
            MAT IWH.REC=""
            ERRMSG="Cannot locate warehouse item. Try again! "
	      ERR = 2
            GOTO 93000
         END
         IF IWH.ON.HAND+0=0 AND CATG.TRACK.QOH="Y" THEN
            ERRMSG="Quantity on-hand is zero. Try again! "
	      ERR = 1
            GOTO 93000
         END
	  
         IF CATG.TRACK.QOH="N" THEN
            IF IWH.LOC="" THEN
               IWH.LOC=WHS.LOC<1,1>
            END
         END
         IF LOCAT_ID="" THEN
            LO.CNT=COUNT(IWH.LOC,VM)+(IWH.LOC # "")
               IF LO.CNT=1 THEN
                  LOCAT_ID=IWH.LOC
		 END ELSE
		    LOCAT_ID	= ""
		 END
	  END	
	
	MATREAD IWLO.REC FROM INV.WHSE.LOC,CONO:PROD:"!":WHSE_ID:"!":LOCAT_ID ELSE
            MAT IWLO.REC=""
       END
	RFND=0
         IF SERIAL_ID="" AND CATG.TRK.LVL='S' THEN
            RS.CNT=DCOUNT(IWLO.SERIAL,VM)
            BEGIN CASE
               CASE RS.CNT=0
                  RFND=0
               CASE RS.CNT=1
                  SERIAL_ID=IWLO.SERIAL
                  RFND=1
               CASE 1
		    RFND=2 
	    END CASE
        END
IF SERIAL_ID# "" THEN
	MATREAD ISTK.REC FROM INV_SERIAL,CONO:SERIAL_ID THEN
               IF ISTK.POST.DATE="" THEN
                  ERRMSG="Serial has not been received"
                  ERR = 1
             	    GOTO 93000 
              END
      * T26497 v
               IF CO.INTR.WHSE # '' AND CO.INTR.WHSE = ISTK.WHSE THEN
                  ERRMSG = 'Cannot use, Serial is in Inter-Divisional Warehouse'
                  ERR = 1
             	    GOTO 93000
               END
      * T26497 ^
               MATREAD WHSE.REC FROM WAREHOUSE,CONO:ISTK.WHSE ELSE MAT WHSE.REC=''
               IF WHS.DIV # JOB.DIV AND WHS.DIV # "00" THEN
                  ERRMSG="Serial Warehouse Div.":WHS.DIV:" does not match Job Div.":JOB.DIV:"--":SERIAL_ID
                  ERR = 1
             	    GOTO 93000
               END
            END
 END
STATUS=RBO.setProperty('','PROD',PROD)
STATUS=RBO.setProperty('','WHSE_ID',WHSE_ID)
STATUS=RBO.setProperty('','LOC_ID',LOCAT_ID)
STATUS=RBO.setProperty('','IWH_LOC',IWH.LOC)
STATUS=RBO.setProperty('','IWLO_SERIAL',IWLO.SERIAL)
STATUS=RBO.setProperty('','SERIAL_ID',SERIAL_ID)
STATUS=RBO.setProperty('','RFOUND',RFND)

STATUS=RBO.setProperty('','INV_PAP_TYPE',INV.PAP.TYPE)
STATUS=RBO.setProperty('','INV_UNIT',INV.UNIT)
STATUS=RBO.setProperty('','JOB_RESV_MATL',JOB.RESV.MATL)
STATUS=RBO.setProperty('','JOB_RESV_QTY',JOB.RESV.QTY)
STATUS=RBO.setProperty('','JOB_RESV_AMT',JOB.RESV.AMT)
STATUS=RBO.setProperty('','JOB_RESV_WHSE',JOB.RESV.WHSE)

STATUS=RBO.setProperty('','CATG_RSV_SERIAL',CATG.RSV.SERIAL)
STATUS=RBO.setProperty('','ISTK_CUR_QTY',ISTK.CUR.QTY)
STATUS=RBO.setProperty('','ISTK_JOB',ISTK.JOB)
STATUS=RBO.setProperty('','IWLO_LOC_ON_HAND',IWLO.LOC.ON.HAND)
STATUS=RBO.setProperty('','ISTK_RSVB_QTY',ISTK.RSVB.QTY)
STATUS=RBO.setProperty('','ISTK_JRSVD_QTY',ISTK.JRSVD.QTY)





RETURN

93000*
STATUS = RBO.setProperty('','ServerStatus',ERR)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)

RETURN 


