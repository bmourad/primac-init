SUBROUTINE JOBM_VALD_CUSTM
********************************************************************************
*   Program name :- JOBM_VALD_CUSTM
*   Created:- 7/22/2003
*------------------------------------------------------------------------------*
*
* In Properties:
* --------------
*  Cono,JOB_NO,JOB_EST,ORDNO
*
* Out Properties:
* ---------------
*  ServerStatus,ServerMessage
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JES.CPYLIB ESTIMATE
$INCLUDE JCS.CPYLIB JOB
$INCLUDE OPS.CPYLIB JOB.FNGD.STATS
$INCLUDE PMC.CPYLIB COMP.OPS
$INCLUDE PMC.CPYLIB CUSTOMER
* Insert method code here
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB INV.CNV


ERRMSG = ""
HMSG = ""
CUR.ORD.BAL=''
CUR.JOB.BAL=''
OPEN "","CONTROL" TO CONTROL ELSE
	ERRMSG = "Cannot locate the CONTROL file"
	GOTO 99999
END
OPEN '','ESTIMATE' TO F.EST ELSE
	ERRMSG = "UNABLE TO OPEN FILE!"
	GOTO 99999
END
OPEN "","JOB" TO JOB ELSE
	ERRMSG = "CANNOT OPEN JOB FILE"
       GOTO 99999
END
OPEN "","JOB.FNGD.STATS" TO JOB.FNGD.STATS ELSE
	ERRMSG = "UNABLE TO OPEN FILE!"
	GOTO 99999
END
OPEN "","CUSTOMER" TO CUSTOMER ELSE
	ERRMSG = "UNABLE TO OPEN FILE!"
	GOTO 99999
END

OPEN '','INVENTORY' TO INVENTORY ELSE
	ERRMSG = 'INVENTORY FILE IS MISSING'
	GOTO 99999
END

VAL = RBO.getProperty('','Cono',CONO)
VAL = RBO.getProperty('','JOB_NO',JOBNO)

MATREAD JOB.REC FROM JOB,CONO:JOBNO ELSE MAT JOB.REC = ""
MATREAD JFS.REC FROM JOB.FNGD.STATS, CONO:JOBNO ELSE MAT JFS.REC = ""

VAL = RBO.getProperty('','JOB_EST',EST.NO)
IF EST.NO = 0 THEN EST.NO = ""

MATREAD EST.REC FROM F.EST,CONO:EST.NO ELSE MAT EST.REC = ""

VAL = RBO.getProperty('','JOB_CUST',CUSTNO)
IF CUSTNO = 0 THEN CUSTNO = ""

VAL = RBO.getProperty('','ORDERNO',ORDNO) ;* IT IS ""

VAL = RBO.getProperty('','ORIG_CUST',ORIG.CUST)
IF ORIG.CUST = 0 THEN ORIG.CUST = ""

VAL = RBO.getProperty('','FLG',FLG) ; * INDICATES JOBNO IS OLD OR NEW
VAL = RBO.getProperty('','VALD_CUST',VALD.CUST)

IF VALD.CUST = 0 THEN VALD.CUST = ""

VAL = RBO.getProperty('','JFS_UMS',JFS.PROD)
VAL = RBO.getProperty('','JFS_F_QTY',JFS.F.QTY)
VAL = RBO.getProperty('','JFS_A_QTY',JFS.A.QTY)

VAL = RBO.getProperty('','CO_JT',CO_JT)
VAL = RBO.getProperty('','JOB_MASTER',JOB.MASTER)
VAL = RBO.getProperty('','JOB_STATUS',JOB.STATUS) ; * MULTIVALUED
VAL = RBO.getProperty('','JOB_CONF_AMT',JOB.CONF.AMT)
VAL = RBO.getProperty('','JOB_TOT_INV',JOB.TOT.INV)
VAL = RBO.getProperty('','JOB_SLSMN',VISITEDFG)

IF VISITEDFG = 0 THEN ;* FETCH FINISHED GOODS ITEMS FROM JOB.FNGD.FILE, AS IT IS NOT VISITED BY END USER AT CLIENT SIDE
	PCNT=DCOUNT(JFS.PROD,@VM) ;* LIST OF FININSHED GOODS PRODUCTS
	PRODDESCS=''; UMS=''
	BALANCE=''
	F.QTY = JFS.F.QTY 
	S.QTY = JFS.S.QTY 
	FOR P = 1 TO PCNT
		MATREAD INV.REC FROM INVENTORY,CONO:JFS.PROD<1,P> ELSE
    			INV.FULL.DESC = 'Unknown'
	  	END
		JFS.F.QTY<1,P> = OCONV(INT(((JFS.F.QTY<1,P>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		JFS.A.QTY<1,P> = OCONV(INT(((JFS.A.QTY<1,P>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
	NEXT P
END

IF JOB.MASTER = 0 THEN JOB.MASTER = ""
IF JFS.PROD = 0 THEN JFS.PROD = ""

IF JOBNO = "N" THEN
	JOB.MASTER = EST.JOB
END

MATREAD OPCO.REC FROM CONTROL, CONO:"OPS" ELSE MAT OPCO.REC = ""
MATREAD CUST.REC FROM CUSTOMER, CONO:CUSTNO ELSE 
	ERRMSG = "INVALID CUSTOMER ID - " : CUSTNO
	GOTO 99999
END


IF VALD.CUST = 1 THEN ;*IF TO VALIDATE CUSTOMER1200*

	BEGIN CASE
		CASE JOB.STATUS # ""
       		ERRMSG = "CAN NOT CHANGE CUSTOMER FOR ACTIVE JOBS:" : JOB.STATUS
			GOTO 99999
      		CASE SUM(JFS.F.QTY) > 0
       		ERRMSG = "Finished Goods quantity already received from this JOB"
		       GOTO 99999
		CASE SUM(JFS.A.QTY) > 0
       		ERRMSG = "There are orders linked to this job"
		  	GOTO 99999
		CASE ORDNO # "" AND OPCO.JOB.BLD # "N"
       		ERRMSG = "Customer Must Match Customer On Order"
		       GOTO 99999
		CASE JOB.SUBS # "" AND JOBNO # ""
       		ERRMSG = "There are Sub Jobs use Change Job Cust to change Cust"
		  	GOTO 99999
		CASE CUST.TYPE = "F"
			ERRMSG = "Customer Type is Frozen - Cannot Enter Job"
			GOTO 99999
		CASE CUST.CREDIT = "DEL"
			ERRMSG = 'This customer has credit code "DEL", cannot enter a Job for this customer.'
			GOTO 99999
		CASE JOB.MASTER # JOBNO AND JOB.MASTER # ""
      			MATREAD JOB.REC FROM JOB, CONO:JOB.MASTER ELSE
				ERRMSG = "CANNOT LOCATE MASTER JOB - ":JOB.MASTER
       			GOTO 99999
	      		END
		      	IF CUSTNO # JOB.CUST THEN ; * MASTER JOB AND ITS SUB JOB SHOULD HAVE SAME CUSTOMER
       			ERRMSG = "MASTER JOB HAVE A DIFFERENT CUSTOMER - ":JOB.CUST
       			GOTO 99999
		      	END
	END CASE
 
	IF CUST.CREDIT = "N" THEN
		ERRMSG = "THERE IS NO CREDIT FOR THIS CUSTOMER"
		GOTO 99999
	END

	*1250*

	*STATUS = RBO.setProperty('','ServerMessage','ORIG.CUST --' : ORIG.CUST : '--CUSTNO--' : CUSTNO)
	*RETURN
	*ORIG.CUST IS PREVIOUS CUSTOMER,CUSTNO IS JOB.CUST(I.E ENTERED IN CUSTOMER)

*** CHANGED BY ZUBAIR

	IF ORIG.CUST = '' THEN 
           STATUS=RBO.setProperty('','TEMPVAL',ORIG.CUST:"AFTER")
		ORIG.CUST = CUSTNO
		GOSUB 3100
	END 


	IF ORIG.CUST # CUSTNO THEN GOSUB 3100
END ELSE
	IF FLG = "O" THEN GOSUB 3100 ;* THIS IS WHEN QUOITED AMT IS CHAGNED
END	

IF VALD.CUST = 2 THEN 


   IF ORIG.CUST = '' THEN 
      ORIG.CUST=CUSTNO
   END
	*RETURN
	GOSUB 3100
END

GOTO 99999

3100*
QUOTED.AMT = 0
IF ORDNO # "" OR JFS.PROD # "" THEN
	GOTO 3149
END

LOCATE "4" IN JOB.STATUS<1>,1 SETTING DUMMY ELSE
	IF JOB.TOT.INV > 0 THEN
     		QUOTED.AMT = JOB.CONF.AMT - JOB.TOT.INV
	END ELSE
     		QUOTED.AMT = JOB.CONF.AMT
	END
	IF QUOTED.AMT < 0 THEN QUOTED.AMT = 0
END	

CUR.ORD.BAL = SUM(CUST.ORD.BAL)
CUR.JOB.BAL = SUM(CUST.JOB.BAL)

IF FLG = "O" AND ORIG.CUST = JOB.CUST THEN
	*GOSUB 1250
	LOCATE JOBNO IN CUST.JOB<1>,1 SETTING JFND THEN
      		CUR.JOB.BAL = CUR.JOB.BAL - CUST.JOB.BAL<1,JFND>
   	END
	
   	IF ORIG.CUST = '' THEN ORIG.CUST = JOB.CUST
END

BEGIN CASE
	CASE CUST.CREDIT = "N"
     		ERRMSG = "THERE IS NO CREDIT FOR THIS CUSTOMER"
    		GOTO 3149
	CASE CUST.CREDIT = "E"
		AVAIL = (CUST.CR.LIMIT * 100) - CUST.AR.BAL - CUR.JOB.BAL - CUR.ORD.BAL - (QUOTED.AMT*100) 	
     		IF AVAIL < 0 THEN
     			HMSG = "A/R=":OCONV(CUST.AR.BAL,"MD2,$")
      			HMSG = HMSG:"& JOB/ORD=":OCONV(CUR.JOB.BAL+CUR.ORD.BAL+(QUOTED.AMT*100),"MD2,$")
      			HMSG = HMSG:"& AVAIL.=":OCONV(AVAIL,"MD2,$<")
     		END ELSE
     			GOTO 3149
     		END
	CASE 1
       	HMSG = "A/R=":OCONV(CUST.AR.BAL,"MD2,$")
       	HMSG = HMSG:"& JOB/ORD=":OCONV(CUR.JOB.BAL+CUR.ORD.BAL+(QUOTED.AMT*100),"MD2,$")
       	HMSG = HMSG:"& TOT BAL= ":OCONV(CUST.AR.BAL+CUR.JOB.BAL+CUR.ORD.BAL+(QUOTED.AMT*100),"MD2,$")
END CASE
VAL = RBO.setProperty('','CREDIT_AUTH','I') ;* REQUIRED I/P FOR CREDIT AUTH
3149 RETURN


*A/R=$95,280.26& JOB/ORD=$808,774.63& AVAIL.=$-903,954.89
99999

IF HMSG = 0 THEN HMSG = ""
STATUS = RBO.setProperty('','CUSTOMER_HMSG',HMSG)
STATUS = RBO.setProperty('','CO_POS',CUR.ORD.BAL)
STATUS = RBO.setProperty('','ACTION',CUR.JOB.BAL)

STATUS = RBO.setProperty('','JOB_SLSMN',CUST.SALESMAN)
STATUS = RBO.setProperty('','JOB_CSR',CUST.CSR.CODE)
STATUS = RBO.setProperty('','JOB_SHIP_VIA',CUST.SHIP.VIA)
STATUS = RBO.setProperty('','CUST_NAME',CUST.NAME)


IF (TRIM(ERRMSG) # "") THEN
	STATUS = RBO.setProperty('','ServerStatus','1')
       STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
END ELSE
       STATUS = RBO.setProperty('','ServerStatus','')
       STATUS = RBO.setProperty('','ServerMessage','')
END 
RETURN
