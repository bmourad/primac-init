*********************************************************************
* REVISION    - [12.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - ICSBP
* PROGRAM     - ICF.EOM.CLOSE
* BY          - ZIAD YAMOUT, C.B.A
* DATE        - 02/28/87
* DESCRIPTION -
*MODIFIED	- (05/17/05) BY ZAHOOR AHMED
*		   FOR printflag and EOD.ERROR flag
*ENDDOC
*********************************************************************
*
***** INSERT FILE EQUATE
*
$INCLUDE WWINSERT RBO.H
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE PMC.CPYLIB SALESDATES
$INCLUDE PMC.CPYLIB FISCAL
$INCLUDE PMC.CPYLIB EOM.TRANS
$INCLUDE PMC.CPYLIB EOM.TRANS.HIST              ; * T25975
$INCLUDE ICS.CPYLIB INV_AUDIT_HIST
$INCLUDE ICS.CPYLIB WAREHOUSE
$INCLUDE GLS.CPYLIB GLA
$INCLUDE PMC.CPYLIB COA
$INCLUDE GLS.CPYLIB COA.SYS
$INCLUDE PMC.CPYLIB POST.REJECTS
$INCLUDE CPYLIB CHAR
*
***** SETUP ERRMSG ROUTINE
*
ERRMSG=''
REJECT.RPT.PRT=''
* ERROR.FLAG is for any error from EOD_CLOSE_PreProcess & Printfalg is view/mail/print/file
ERROR.FLAG = ''
Printfalg = ''
EMAIL_ADDR = ''
*
STATUS = RBO.getProperty('','ID',ID)
STATUS = RBO.getProperty('','PMCProperty',PMCProperty)
STATUS = RBO.getProperty('','PRINT_FLAG',PRINT.FLAG)
STATUS = RBO.getProperty('','ERR_FLAG',ERROR.FLAG)
STATUS = RBO.getProperty('','EmailAddress',EMAIL_ADDR)
CONO = ID[1,3]
STATUS = RBO.getProperty('','DM_Flag',D.M.FLG)
STATUS = RBO.getProperty('','FR_CURR_PER',FR.CURR.PER)
STATUS = RBO.getProperty('','FR_CURR_DATE',FR.CURR.DATE)
STATUS = RBO.getProperty('','FR_NEXT_PER',FR.NEXT.PER)
STATUS = RBO.getProperty('','FR_NEXT_DATE',FR.NEXT.DATE)
STATUS = RBO.getProperty('','FR_PRINT',FR.PRINT)
STATUS = RBO.getProperty('','FR_CLOSE_DATE',FR.CLOSE.DATE)
STATUS = RBO.getProperty('','FR_D_M_FLG',FR.D.M.FLG)
STATUS = RBO.getProperty('','DivPos',POS)
STATUS = RBO.getProperty('','AllDivsCount',ALL.DIVS.COUNT)
FOR P = 1 TO DCOUNT(FR.CURR.PER,VM)
   IF INDEX(FR.CURR.DATE<1,P>,'/',1) > 0 THEN FR.CURR.DATE<1,P> = ICONV(FR.CURR.DATE<1,P>,'D2/')
   IF INDEX(FR.NEXT.DATE<1,P>,'/',1) > 0 THEN FR.NEXT.DATE<1,P> = ICONV(FR.NEXT.DATE<1,P>,'D2/')
   IF INDEX(FR.CLOSE.DATE<1,P>,'/',1) > 0 THEN FR.CLOSE.DATE<1,P> = ICONV(FR.CLOSE.DATE<1,P>,'D2/')
NEXT P
STATUS = RBO.getProperty('','DivCode',DIV.CODE)
IF DIV.CODE = '' THEN DIV.CODE = 'ALL'
IF D.M.FLG = "PERIOD" THEN
   RPT.PER = "PERIOD"
   EOY = 1
   FOR I = 1 TO ALL.DIVS.COUNT UNTIL NOT(EOY)
      IF I # POS THEN
         IF FR.CURR.PER<1,I>[5,2] # '01' THEN EOY = 0
      END ELSE
         IF FR.NEXT.PER<1,I>[5,2] # '01' THEN EOY = 0
      END
      DIV.EOY = 0
      IF FR.NEXT.PER<1,POS>[5,2] = 01 THEN DIV.EOY = 1
   NEXT I
END ELSE
   RPT.PER = "DAY"
   EOY = 0
   DIV.EOY = 0
END
*
*Get the printflag view/Email/File/Print
*
BEGIN CASE
   CASE PRINT.FLAG = 'PrintData'
	Printfalg = 'View'
   CASE PRINT.FLAG = 'EmailData'
	Printfalg = 'Email'
   CASE PRINT.FLAG = 'File'
	Printfalg = 'Print'
   CASE 1
	Printfalg = 'Print'
END CASE
*
**** INTITIALIZATION
*
TODAY = DATE()
UNKNOWN = "NOT ON FILE"
SYS.FISCAL = "ICFISCAL"
PROG.ID = @TTY:"!":CONO:"!ICF.EOM"
NORETURN=0
*
***** OPEN FILES
*
TRANFILE='ICF.EOM.TRANS':CONO:DIV.CODE
REJECTFILE='ICF.POST.REJECTS':CONO:DIV.CODE
OPEN "","CONTROL" TO CONTROL ELSE
   ERRMSG="CONTROL FILE MISSING"
   GOTO 93000
END
OPEN "",TRANFILE TO EOM.TRANS ELSE
   ERRMSG = "YOU NEED TO RUN END OF ":RPT.PER:" POSTING BEFORE YOU CLOSE THE PERIOD"
   GOTO 93000
END
OPEN "",REJECTFILE TO POST.REJECTS ELSE
   ERRMSG = "YOU NEED TO RUN END OF ":RPT.PER:" POSTING BEFORE YOU CLOSE THE PERIOD"
   GOTO 93000
END
OPEN "","COMPANY" TO COMPANY ELSE ERRMSG="COMPANY FILE MISSING";GOTO 93000
OPEN "","SECURITY" TO SECURITY ELSE ERRMSG="SECURITY FILE MISSING";GOTO 93000
OPEN "","INV_AUDIT_HIST" TO INV_AUDIT_HIST ELSE
   ERRMSG="INV_AUDIT_HIST FILE MISSING";GOTO 93000
END
OPEN "","FNGD_AUDIT_TAG" TO FNGD_AUDIT_TAG ELSE
   ERRMSG="FNGD_AUDIT_TAG FILE MISSING";GOTO 93000
END
OPEN "","WAREHOUSE" TO WAREHOUSE ELSE ERRMSG="WAREHOUSE FILE IS MISSING";GOTO 93000
OPEN "","EOD.HIST" TO EOD.HIST ELSE ERRMSG="EOD.HIST FILE IS MISSING";GOTO 93000
OPEN "","ICF.EOM.TRANS.HIST" TO ICF.EOM.TRANS.HIST ELSE ERRMSG="ICF.EOM.TRANS.HIST FILE IS MISSING";GOTO 93000
*
*If ERROR.FLAG = 1 from EOD_CLOSE_PreProcess then call Generatereport_Sub
*
IF ERROR.FLAG = 1 THEN
 GOTO 90000
END
*
MATREAD COMP.REC FROM COMPANY,CONO ELSE
   ERRMSG = "CANNOT LOCATE COMPANY # ":CONO; GOTO 93000
END
IN.ACCT.LEN = LEN(CO.ACCT.PIC)
ACCT.LEN = IN.ACCT.LEN + 10
EQV.FLG=''
IF CO.GLS # "N" THEN
   IF CO.GL.LINK<1,5> = "Y" THEN
      OPEN "","GLA" TO GLA ELSE ERRMSG="GLA FILE IS MISSING";GOTO 93000
   END
   OPEN "","COA" TO COA ELSE ERRMSG="COA FILE IS MISSING";GOTO 93000
   EQV.FLG = 1
   OPEN "","COA.EQUIV" TO COA.EQUIV ELSE EQV.FLG = 0
END
READ PERIOD.REC FROM CONTROL, CONO:"ACCT.PERIODS" ELSE
   PERIOD.REC = 12
END
NUM.PERIODS = PERIOD.REC
READ SECURITY.REC FROM CONTROL, CONO:'DIV.SECURITY' ELSE
   SECURITY.REC = 'N'; SECURITY.REC<2> = 'N'
END
READ FNGD.EOM FROM CONTROL, CONO:"FNGD.EOM" ELSE FNGD.EOM = ""
IF FNGD.EOM<8,POS> # "" THEN
   ERRMSG = "E R R O R !!! END OF ":D.M.FLG:" REPORT IS OUT OF BALANCE.  UNABLE TO CLOSE."
   STATUS = RBO.setProperty('','EOD_ERROR',ERRMSG)
   GOTO 93000
*   GOTO 90000 ;*Ignore Further Process call Generatereport_Sub
END
IF FNGD.EOM<2,POS> = "" THEN
*   ERRMSG = 'YOU NEED TO RUN THE END OF ':D.M.FLG:' REPORT FOR ':DIV.CODE:' DIVISION' ' COMMEDTED BCOZ WE ARE NOT USING FNGD
*   STATUS = RBO.setProperty('','EOD_ERROR',ERRMSG)
*   GOTO 93000
*    GOTO 90000 ;*Ignore Further Process call Generatereport_Sub
END
IF FNGD.EOM<3> = "" THEN FNGD.EOM<3> = FR.CURR.DATE<1,POS>
IF FNGD.EOM<4> = "" THEN FNGD.EOM<4> = FR.CURR.PER<1,POS>
WRITE FNGD.EOM ON CONTROL, CONO:"FNGD.EOM"
CLEARFILE POST.REJECTS
PRR.SEQ = 10000
CMD='SELECT FNGD_AUDIT_TAG WITH TYPE="R"'
UDTEXECUTE CMD CAPTURING MSG
WRITE "INV_AUDIT_HIST" ON CONTROL , PROG.ID
DATA = 1
LOOP
   READNEXT INAH.ID ELSE DATA=0
WHILE DATA DO
   IF INAH.ID[1,3]#CONO THEN GOTO 3999
   MATREADU INAH.REC FROM INV_AUDIT_HIST,INAH.ID THEN
      IF INAH.GLA.DATE = '' OR (INAH.PERIOD <> FR.CURR.PER<1,POS>) THEN
         RELEASE INV_AUDIT_HIST,INAH.ID
         GOTO 3999
      END
      MATREAD WHSE.REC FROM WAREHOUSE, CONO:INAH.WHSE THEN
         IF WHS.DIV # DIV.CODE AND DIV.CODE # "ALL" THEN 
            RELEASE INV_AUDIT_HIST, INAH.ID
            GOTO 3999
         END
      END
      INAH.GLA.DATE = TODAY
      MATWRITE INAH.REC ON INV_AUDIT_HIST, INAH.ID
      DELETE FNGD_AUDIT_TAG,INAH.ID
   END ELSE
      RELEASE INV_AUDIT_HIST, INAH.ID
   END
3999 *
REPEAT
WRITE "INV_AUDIT_HIST" ON CONTROL, PROG.ID
CMD='SELECT FNGD_AUDIT_TAG WITH TYPE="A"'
UDTEXECUTE CMD CAPTURING MSG
DATA = 1
LOOP
   READNEXT INAH.ID ELSE DATA = 0
WHILE DATA DO
   IF CONO # INAH.ID[1,3] THEN GOTO 4999
   MATREADU INAH.REC FROM INV_AUDIT_HIST, INAH.ID THEN
      IF INAH.GLA.DATE = '' OR (INAH.PERIOD <> FR.CURR.PER<1,POS>) THEN
         RELEASE INV_AUDIT_HIST, INAH.ID
         GOTO 4999
      END
      MATREAD WHSE.REC FROM WAREHOUSE, CONO:INAH.WHSE THEN
         IF WHS.DIV # DIV.CODE AND DIV.CODE # "ALL" THEN 
            RELEASE INV_AUDIT_HIST, INAH.ID
            GOTO 4999
         END
      END
      INAH.GLA.DATE = TODAY
      MATWRITE INAH.REC ON INV_AUDIT_HIST, INAH.ID
      DELETE FNGD_AUDIT_TAG,INAH.ID
   END ELSE
      RELEASE INV_AUDIT_HIST, INAH.ID
   END
4999 *
REPEAT
7000 *
IF CO.GLS = "N" THEN GOTO 8000
IF CO.GL.LINK<1,5> # "Y" THEN GOTO 8000
**** EOM.TRANS (1) ****
ACCOUNTS = ""; AMOUNTS = ""
SELECT EOM.TRANS
WRITE "EOM.TRANS (1)" ON CONTROL , PROG.ID
DATA = 1
LOOP
   READNEXT ETR.ID ELSE DATA = 0
WHILE DATA DO
   IF ETR.ID[1,3] # CONO THEN GOTO 7500
   MATREADU ETR.REC FROM EOM.TRANS, ETR.ID ELSE GOTO 7400
   ACCT = ETR.ID[1,ACCT.LEN]
   TYPE = FIELD(FIELD(ETR.ID,"!",3),"*",1)
   LOCATE ACCT IN ACCOUNTS,1 SETTING FND ELSE
      ACCOUNTS<FND> = ACCT
      AMOUNTS<FND> = ""
   END
   IF TYPE = "D" THEN
      AMOUNTS<FND,1> = AMOUNTS<FND,1> + ETR.AMT
   END ELSE
      AMOUNTS<FND,2> = AMOUNTS<FND,2> + ETR.AMT
   END
7400 *
   RELEASE EOM.TRANS, ETR.ID
7500 *
REPEAT
MAT GLA.REC = ""
GLA.DATE = TODAY
GLA.SRC = "IA"
GLA.MON = FR.CURR.PER<1,POS>
ODATE = " " : OCONV(FR.CURR.DATE<1,POS>,"D2/")
ACNT = COUNT(ACCOUNTS,AM) + (ACCOUNTS # "")
READU COUNTER FROM CONTROL, CONO : "GLACOUNTER" ELSE COUNTER = 0
WRITE "GLA ":COUNTER ON CONTROL, PROG.ID
FOR I = 1 TO ACNT
   IF EQV.FLG = 1 THEN
      READ ACCT FROM COA.EQUIV, ACCOUNTS<I> ELSE ACCT = ACCOUNTS<I>
   END ELSE
      ACCT = ACCOUNTS<I>
   END
   COA.ID = CONO : ACCT[11,IN.ACCT.LEN]
   MATREAD COA.REC FROM COA, COA.ID ELSE COA.DESC = UNKNOWN
   GLA.DESC = COA.DESC "L#25" : ODATE
   FOR J = 1 TO 2
      IF AMOUNTS<I,J> = "" THEN GOTO 7900
      LOOP
         COUNTER = COUNTER + 1
         IF COUNTER > 999998 THEN COUNTER = 1
         GLA.ID = ACCT : STR("0",6-LEN(COUNTER)) : COUNTER
         READ DUMMY FROM GLA, GLA.ID ELSE DUMMY = ""
      WHILE DUMMY # "" DO REPEAT
      GLA.AMT = AMOUNTS<I,J>
      MATWRITE GLA.REC ON GLA, GLA.ID
7900 *
   NEXT J
NEXT I
WRITE COUNTER ON CONTROL, CONO : "GLACOUNTER"
**** EOM.TRANS (2) ****
8000 *
SELECT EOM.TRANS
WRITE "EOM.TRANS (2)" ON CONTROL , PROG.ID
DATA = 1
LOOP
   READNEXT ETR.ID ELSE DATA = 0
WHILE DATA DO
   IF ETR.ID[1,3] # CONO THEN GOTO 8999
   MATREADU ETR.REC FROM EOM.TRANS, ETR.ID ELSE
      RELEASE EOM.TRANS, ETR.ID; GOTO 8999
   END
   CURR.PER = FR.CURR.PER<1,POS>
   MAT ETH.REC = MAT ETR.REC
   DONE = 0
   SEQ = 0
   ETH.ID = FIELD(ETR.ID,"*",1):"*":CURR.PER
   LOOP UNTIL DONE = 1 DO
      SEQ = SEQ + 1
      ETH.KEY = ETH.ID:"*":SEQ
      READ CHECKIT FROM ICF.EOM.TRANS.HIST, ETH.KEY ELSE DONE = 1
   REPEAT
   MATWRITE ETH.REC ON ICF.EOM.TRANS.HIST, ETH.KEY
   DELETE EOM.TRANS, ETR.ID
8999 *
REPEAT
WRITE "EOM.TRANS (3)" ON CONTROL, PROG.ID
EOD.HID = ""
IF SECURITY.REC<2> = "Y" THEN EOD.HID = '!':DIV.CODE
READU EOD.HIST.REC FROM EOD.HIST, CONO:'FNGD.EOM':FR.CURR.PER<1,POS>:EOD.HID ELSE 
   EOD.HIST.REC = ""
END
EOD.HIST.REC = INSERT(EOD.HIST.REC,-1,0,0,TODAY)
WRITE EOD.HIST.REC ON EOD.HIST,CONO:'FNGD.EOM':FR.CURR.PER<1,POS>:EOD.HID
SELECT EOM.TRANS
READNEXT ETR.ID ELSE
   IF D.M.FLG = "PERIOD" THEN
      FNGD.EOM = ""
   END
   WRITE FNGD.EOM ON CONTROL, CONO:"FNGD.EOM"
   DELETE CONTROL, PROG.ID
   GOSUB 90000
   CMD='DELETE.FILE ': TRANFILE :' FORCE'
   UDTEXECUTE CMD CAPTURING JUNK
   IF REJECT.RPT.PRT = '' THEN
     CMD='DELETE.FILE ': REJECTFILE : ' FORCE'
     UDTEXECUTE CMD CAPTURING JUNK
   END
   IF ERRMSG # '' THEN GOTO 93000
   GOTO 99999
END
 ERRMSG = "ER R O R !!! CANNOT LOCATE ALL TRANSACTIONS"
*T580 GOTO 93000

FNGD.EOM<5> = "X"
WRITE FNGD.EOM ON CONTROL, CONO:"FNGD.EOM"
*T580 v
	GOTO 93000
*T580 ^
90000 *
READ JUNK FROM POST.REJECTS,'10001' THEN
   UserID = PMCProperty<1,3>
   IF D.M.FLG = 'DAY' THEN RPTID = 'IC308' ELSE RPTID = 'IC312';*RPTID=IC308 & IC312 for D.M.FLG="DAY" & "PERIOD" respectively
*   IN_PARAM = UserID:"!ICFEODC!111!IC308!":CONO:"!Print"
   IN_PARAM = UserID:"!ICFEODC!111!":RPTID:"!":CONO:"!":Printfalg
   IN_PARAM<2> = ''
   IN_PARAM<3> = 'EOD.REJECT.LISTING'
   IN_PARAM<4> = 'P'
   IN_PARAM<5> = 'PMCPROCS'
   IN_PARAM<6> = REJECTFILE
   IN_PARAM<7> = 'REJECTS'
   IN_PARAM<8> = EMAIL_ADDR ;*Email Address as Entered by the user
   OUT_PARAM=''
   UDTEXECUTE 'SSELECT ':REJECTFILE CAPTURING JUNK
   CALL GenerateReport_Sub(ERRMSG,IN_PARAM,OUT_PARAM)
   IF ERRMSG # "" THEN GOTO 93000 ;*to check if any error in GenerateReport_Sub
   REJECT.RPT.PRT='WARNING !!! MAKE SURE TO PICKUP CLOSING REJECTS REPORT FROM PRINTER'
   STATUS=RBO.setProperty('','RejectRptPrinted',REJECT.RPT.PRT)
   STATUS=RBO.setProperty('','ReportImage',OUT_PARAM<2>)
END ELSE
	IF Printfalg # "Print" THEN	ERRMSG  = "There is no data to ":Printfalg
	GOTO 93000
END
IF NOT(NORETURN) THEN RETURN
ERRMSG = "E R R O R !!! CANNOT PROCESS ALL TRANSACTIONS"
93000 WRITEV ERRMSG ON CONTROL, PROG.ID,2
STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
*** END OF JOB ***
99999 
END
