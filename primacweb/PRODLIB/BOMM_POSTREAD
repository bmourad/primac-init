SUBROUTINE BOMM_POSTREAD
********************************************************************************
*   Program name :- BOMM_POSTREAD
*   Created:- 11/12/2002
*   Author:- Edvard Pitka
*------------------------------------------------------------------------------*
*
* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE CPYLIB CHAR
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB INV.CNV
$INCLUDE ICS.CPYLIB FNGD.BOM

;* define functions
DEFFUN CalcStkQty(COST.QTY,MAT INV.CNV.REC,ROND,LN)
ERRMSG=''
bom_q_ratio = ''
IF FILEINFO(INVENTORY,0)=0 THEN
  OPEN '','INVENTORY' TO INVENTORY ELSE
    ERRMSG<1,-1>='INVENTORY FILE IS MISSING'
  END
END

IF ERRMSG THEN GOTO 93000
STATUS=RBO.getProperty('','ID',ID)
CONO=ID[1,3]

;* retrive database values

*NAMES='' ; VALUES=''
*NAMES<1>='BOM_Q_RATIO' 
*NAMES<2>='BOM_Q_TYPE'  
*NAMES<3>='BOM_PROD'    
*STATUS=RBO.getDBVals(NAMES,VALUES)

STATUS=RBO.getDBVals('BOM_Q_RATIO',BOM.Q.RATIO)
STATUS=RBO.getDBVals('BOM_Q_TYPE',BOM.Q.TYPE)
STATUS=RBO.getDBVals('BOM_PROD',BOM.PROD)
STATUS=RBO.getDBVals('BOM_TYPE',BOM.TYPE)
;* convert & set BOM_Q_RATIO to external value
bom_q_ratio=""
LNCNT=DCOUNT(BOM.PROD,VM)
FOR LN=1 TO LNCNT 
  INV.ID=CONO:BOM.PROD<1,LN>
  MATREAD INV.REC FROM INVENTORY,INV.ID ELSE
    MAT INV.REC=''
  END
  GOSUB GetInvUmCnv	
  ;* convert BOM.Q.RATIO to external value       
 * IF BOM.TYPE # "K" THEN
	IF BOM.Q.RATIO<1,LN> # "" THEN
		IF BOM.TYPE # "K" THEN
    			IF BOM.Q.TYPE<1,LN> = "F" THEN
				TMP=BOM.Q.RATIO<1,LN>
		      		TMP=CalcStkQty(TMP,MAT INV.CNV.REC,'','')
      				bom_q_ratio<1,LN>=TMP
	   		END ELSE
      				bom_q_ratio<1,LN> =  BOM.Q.RATIO<1,LN>
			END
		END ELSE
			bom_q_ratio<1,LN> = BOM.Q.RATIO<1,LN>/10000
		END
	END
  *END
******************Extension
*  IF BOM.TYPE<1,LN> = "K" THEN
*    BOM.Q.RATIO<1,LN> = BOM.Q.RATIO<1,LN> * 10000
*  END ELSE
*    IF BOM.Q.TYPE<1,LN> = "P" THEN
*      bom_q_ratio<1,LN> = BOM.Q.RATIO<1,LN> 
*    END ELSE
*      bom_q_ratio<1,LN> = INT(((BOM.Q.RATIO<1,LN>/ ICR.MT1) * ICR.DV1) * ICR.DV2 + .5)
*    END
*  END 

NEXT LN
                        
STATUS=RBO.setProperty('','bom_q_ratio',bom_q_ratio)

RETURN

*******************************************************************************
*
***************
GetInvUmCnv:
***************
*
$INCLUDE ICSBP INV.UM.CNV
RETURN
93000 
STATUS = RBO.setProperty('','ServerStatus',1)        
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)  
RETURN
