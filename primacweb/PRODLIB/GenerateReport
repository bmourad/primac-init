SUBROUTINE GenerateReport
**************************************************************************
*   Program name :- GenerateReport
*   Created:- 07/27/2002
*------------------------------------------------------------------------*
*
* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
**************************************************************************
   $INCLUDE WWINSERT RBO.H
* Insert method code here
*
   $INCLUDE PMC.CPYLIB PMCProcessStatus
   $INCLUDE PMC.CPYLIB PMC_PROCESS
   $INCLUDE PMC.CPYLIB PMC_REPORTS
   $INCLUDE CPYLIB PORT.CONTROL
   $INCLUDE PMC.CPYLIB SECURITY
   $INCLUDE CPYLIB CHAR
* Insert method code here
*
   OPEN '','VOC' TO F.VOC ELSE
      MESG = 'Cannot open VOC file!'
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
   OPEN '','CONTROL' TO CONTROL ELSE
      MESG = 'Cannot open CONTROL file!'
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
   OPEN '','ERROR_LOG' TO D.ERROR_LOG ELSE
      MESG = 'Cannot open ERROR_LOG file!'
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
*WRITE OCONV(DATE(),"D"):"/":OCONV(TIME(),"MTS") ON D.ERROR_LOG, "DRF_GR_CONTROL_OPENED"
   OPEN '','Primac_Security' TO PRIMAC_SECURITY ELSE
      MESG = 'Cannot open Primac_Security file!'
	 WRITE MESG:@AM:OCONV(DATE(),"D"):"/":OCONV(TIME(),"MTS") ON D.ERROR_LOG, "ERROR"
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
   OPEN '','SECURITY' TO SECURITY ELSE
      MESG = 'Cannot open SECURITY file!'
	 WRITE MESG:@AM:OCONV(DATE(),"D"):"/":OCONV(TIME(),"MTS") ON D.ERROR_LOG, "ERROR"
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
   OPEN '','PMCProcessData' TO PMCProcessData ELSE
      MESG = 'Cannot open PMCProcessData file!'
	 WRITE MESG:@AM:OCONV(DATE(),"D"):"/":OCONV(TIME(),"MTS") ON D.ERROR_LOG, "ERROR"
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
   OPEN '','PMCProcessStatus' TO PMCProcessStatus ELSE
      MESG = 'Cannot open PMCProcessStatus file!'
	 WRITE MESG:@AM:OCONV(DATE(),"D"):"/":OCONV(TIME(),"MTS") ON D.ERROR_LOG, "ERROR"
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
   OPEN '','PMC_REPORT_VALUES' TO PMC_REPORT_VALUES ELSE
      MESG = 'Cannot open PMC_REPORT_VALUES file!'
	 WRITE MESG:@AM:OCONV(DATE(),"D"):"/":OCONV(TIME(),"MTS") ON D.ERROR_LOG, "ERROR"
     STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
   OPEN '','PMC_PROCESS' TO PMC_PROCESS ELSE
      MESG = 'Cannot open PMC_PROCESS file!'
	 WRITE MESG:@AM:OCONV(DATE(),"D"):"/":OCONV(TIME(),"MTS") ON D.ERROR_LOG, "ERROR"
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
   OPEN '','PMC_REPORTS' TO PMC_REPORTS ELSE
      MESG = 'Cannot open PMC_REPORTS file!'
	 WRITE MESG:@AM:OCONV(DATE(),"D"):"/":OCONV(TIME(),"MTS") ON D.ERROR_LOG, "ERROR"
     STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
   OPEN '','WIN.PRINTERS' TO WIN.PRINTERS ELSE
      MESG = 'Cannot open WIN.PRINTERS file!'
	 WRITE MESG:@AM:OCONV(DATE(),"D"):"/":OCONV(TIME(),"MTS") ON D.ERROR_LOG, "ERROR"
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
   OPEN '','_HOLD_' TO HOLD.FILE ELSE 
	 MESG = 'CANNOT LOCATE THE _HOLD_ FILE!'
	 WRITE MESG:@AM:OCONV(DATE(),"D"):"/":OCONV(TIME(),"MTS") ON D.ERROR_LOG, "ERROR"
	 STATUS = RBO.setProperty('', 'ServerStatus', 1)
        STATUS = RBO.setProperty('', 'ServerMessage', MESG)
        RETURN
   END
*
* Initialization
   TDString = TIMEDATE ()
   PDFFILENAME = ''
   PPSR_ID_FILE = ''
   PURGEPROC_VALUES = ''
   PurgePrompt = ''
   RB_FLAG = ''
   POST_PROCESS = ''  
   HFNAMES_ID = '' ;*Hold File Names for each reportID
   SEC_GUI_VIEW = ''
   MENU = ''
   OPTION = ''
   SETPTR_QUEUE = ''
*
* Get ID from RBO
* demo!CUSTL!111!PC116!001!Print
   STATUS = RBO.getProperty('','ID',PPSD_ID)
   STATUS = RBO.getProperty('','PROCESS_ID',POST_PROCESS) ; *ADDED FOR SECOND PROCS
   STATUS = RBO.getProperty('','EmailAddress',EMAIL_ADDR)
   STATUS = RBO.getProperty('','PurgePPDField',PurgePrompt)
   STATUS = RBO.getProperty('','SECURITY_TEMP_INPUT',SECURITY_TEMP_INPUT)
   MENU = SECURITY_TEMP_INPUT<1,1>
   OPTION = SECURITY_TEMP_INPUT<1,2>
*
   *ERRMESG = ''
*
   P_DATE = ICONV(TDString[10,11], "D")
   P_TIME = ICONV(FIELD(TDString, " ",1), "MT")
*
WRITE PPSD_ID ON CONTROL,"GFR1222"
   UserID = FIELD(PPSD_ID, "!", 1) ;* User ID
   PPSID = FIELD(PPSD_ID, "!", 2) ;* PMC_PROCESS ID(ASP file name)
   SessionID = FIELD(PPSD_ID, "!", 3) ;* IE Session ID
   PRPT_ID = FIELD(PPSD_ID, "!", 4) ;* PMC_REPORTS ID
   Cono = FIELD(PPSD_ID, "!", 5)
*
 READ COMPANY.SECURITY FROM CONTROL, Cono:"DIV.SECURITY" ELSE
      MESG = 'Cannot Read Div.Security rec from CONTROL File!'
      STATUS = RBO.setProperty('', 'ServerStatus', 'E')
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
*
   MATREAD SEC.REC FROM SECURITY, Cono:UPCASE(UserID) ELSE
      ERRMSG = "USER ":UserID:" NOT ON FILE"
      STATUS = RBO.setProperty('', 'ServerStatus', 'E')
      STATUS = RBO.setProperty('', 'ServerMessage', ERRMSG)
      RETURN
   END
 *
 SETPTR_QUEUE = SEC.DFLT.QUEUE
IF SEC.GUI.VIEW = "RTF" THEN
	SEC_GUI_VIEW = SEC.GUI.VIEW
END ELSE
	SEC_GUI_VIEW = "PDF"
END
*CODE FOR FORM QUEUES
  READ FORM.QUEUE FROM SECURITY, Cono:UPCASE(UserID) THEN
	   FOR A = 1 TO DCOUNT(FORM.QUEUE<33>,VM)
	      IF FORM.QUEUE<33,A> = MENU AND FORM.QUEUE<34,A> = OPTION THEN
		 SETPTR_QUEUE = FORM.QUEUE<35,A>
	      END
	   NEXT A
  END
*END
   REPORT_OPTION = FIELD(PPSD_ID, "!", 6)
*
*
   IF FIELD(PPSD_ID, "!", 6) = "Email" THEN
      Email_Flag = "M"
   END ELSE
      IF FIELD(PPSD_ID, "!", 6) = "Print" THEN
         Email_Flag = ""
      END ELSE
	   IF FIELD(PPSD_ID, "!", 6) = "Save" THEN
              Email_Flag = "F"
          END ELSE
		Email_Flag = "V"
          END
      END
   END
*
  LOG_NAME = @LOGNAME
   PORT_NO = "TTY"
   CALL SYSVARS.SUB(PORT_NO)
   OS_TYPE = UPCASE(SYSTEM(33))
   IF PurgePrompt = "" THEN RB_FLAG = "redback"
WRITE PurgePrompt: " $$ " :" && ":FIELD(PPSD_ID, "!", 6) :" ^ ": Email_Flag: " %% ":RB_FLAG ON CONTROL,"02D"
*
***** This Procedure will fetch valid report id
   IF INDEX(PRPT_ID,",",1) > 0 THEN
      SUB_REPORT = CHANGE(PRPT_ID,",",AM)
      *SUB_REPORT = DELETE(SUB_REPORT,1,0,0)
      SCOUNT = DCOUNT(SUB_REPORT,AM)
      REPORT_ID = FIELD(PRPT_ID,",",1)
   END ELSE
       SCOUNT = 1
	REPORT_ID = PRPT_ID
   END
******
   PRPT_ID = REPORT_ID
   MATREAD PRPT.REC FROM PMC_REPORTS, REPORT_ID ELSE
      MESG = 'Cannot READ PMC_REPORTS record!'
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
*
   PPDREC = ""
   EXTRA_PPDREC = ""
   LAST_LINE = DCOUNT(PRPT.PROMPTS<1>,@VM)
*
   EOD_SECURITY = "N"
   DIV.SEC.FLAG = 0 ;* This will decide whether to add COMPANY.SECURITY<2> Flag in PROCS Variable list
   FOR II = 1 TO LAST_LINE ;* These are the prompt values submitted from ASP
      DUMMY = ""
      TEST = 'PPDField': II "R%2"
      STATUS = RBO.getProperty('', TEST, DUMMY)
      PPDREC<II> = DUMMY
*
*********************CHECK DIVISIONAL LEVEL SECURITY****************
*
      IF PRPT.PROMPTS.GDS<1,II> = "L" THEN
         DIV.SEC.FLAG = 1
         EOD_SECURITY = "Y"
      END
*
***********************************************************************
   NEXT II
*
   IF LAST_LINE > DCOUNT(PPDREC,@AM) THEN
      MESG = 'Cannot getProperty PMCProcessData'
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
*
*ADDDED FOR EXTRA PROMPTS v
    LLL = LAST_LINE+1 
    LOOP 
	PPDFieldNew = 'PPDField': LLL "R%2"
       STATUS = RBO.getProperty('', PPDFieldNew,DUMMYPPD)
	UNTIL DUMMYPPD = ""
		PPDREC<LLL> = DUMMYPPD
       	LLL = LLL + 1
    REPEAT 
 STATUS = RBO.getProperty('','PPDField19',EXTRA_PPDREC);*For Post Entries
*ADDDED FOR EXTRA PROMPTS  ^
 WRITE PPSD_ID ON CONTROL ,"APRPT"
  WRITE PPDREC ON PMCProcessData, PPSD_ID ;* write client i/p data in data file with ID as Report ID
*
   FOR X = 1 TO 1000
   NEXT X
*
   READU PPD_REC FROM PMCProcessData, PPSD_ID ELSE
      RELEASE PMCProcessData, PPSD_ID
      MESG = 'Cannot READ PMCProcessData record!'
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
* Read PMC_PPROCESS
   MATREAD PPS.REC FROM PMC_PROCESS, PPSID ELSE ;* ASP file name
      MESG = 'Cannot READ PMC_PROCESS record!'
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END
* Build PMCProcessStatus Record
   MAT PPSR.REC = ""
   PPSR.PROPERTY = PPSD_ID
   PPSR.USER = UserID
   PPSR.SESSION = SessionID
   PPSR.PPID = PPSID
   PPSR.PRPT = PRPT_ID
   PPSR.LAST = LAST_LINE
   PPSR.PROMPTS = PRPT.PROMPTS
   PPSR.STATUS = "Submit"
   IF LAST_LINE > 0 THEN
      IF DIV.SEC.FLAG = 1 THEN ;* This is REV12 change
         PPSR.PVALUES = CHANGE(PPD_REC,@AM,@VM) : @VM : COMPANY.SECURITY<2> : @VM : Email_Flag
      END ELSE
         PPSR.PVALUES = CHANGE(PPD_REC,@AM,@VM) : @VM : Email_Flag
      END
   END ELSE
      PPSR.PVALUES = Email_Flag
   END
*
   PPSR.STDATE = P_DATE
   PPSR.STTIME = P_TIME
   CALL GetSYSVars (PPSR.STSVAL, TDString)
   READU XXX_REC FROM CONTROL, Cono:"PMCProcessStatus" ELSE XXX_REC = ""
   PPSR_ID = ""
*
   LOOP
*
   UNTIL PPSR_ID # "" DO
*
*
  FOR SS = 1 TO SCOUNT
      IF XXX_REC<1> = "" OR P_DATE > XXX_REC<1> THEN
       XXX_REC<1> = P_DATE
       XXX_REC<2> = 0
      END
      XXX_REC<2> += 1
      PPSR_ID = Cono : P_DATE : "_" : XXX_REC<2>
*
      PPSR_ID_FILE<1,-1> = PPSR_ID ;* Creating PPSR_ID for Multiple reports
      IF SCOUNT > 1 THEN
       HFNAMES_ID<1,-1> = SUB_REPORT<SS>:"!":PPSR_ID
      END ELSE 
      	HFNAMES_ID<1,-1> = REPORT_ID:"!":PPSR_ID
      END	 	
      READU DUMMY FROM PMCProcessStatus, PPSR_ID THEN
       PPSR_ID = ""
      END LOCKED
       PPSR_ID = ""
      END
  NEXT SS
   REPEAT
*
   DUMMY = ""
*
   WRITE XXX_REC ON CONTROL, Cono:"PMCProcessStatus" ;* this contains sequence number with date report run, to generate seq. no with date for file name
   MATWRITE PPSR.REC ON PMCProcessStatus, PPSR_ID
*
* Setup and Process REPORT.SCRN
   DELETE PMCProcessData, PPSD_ID
   HF_NAME = CHANGE(PORT_NO,"*","_"):"_":PRPT_ID
WRITE "HF NAME ":HF_NAME ON CONTROL, "1105HF"
   READU DUMMY FROM CONTROL, HF_NAME ELSE DUMMY = ""
   DELETE CONTROL, HF_NAME
   READU DUMMY FROM PMC_REPORT_VALUES, HF_NAME ELSE DUMMY = ""
*
   PROC_VALUES = Cono
   PROC_VALUES<2> = PRPT_ID
*
   IF DIV.SEC.FLAG = 1 THEN
      PROC_VALUES = PROC_VALUES : @AM : PPD_REC : @AM : COMPANY.SECURITY<2> : @AM : Email_Flag ;* REV12 CHANGE
      PROC_VALUES<85> = MENU : @AM : OPTION; * SENDING MENU AND OPTION (M_JCS_FyIVCP) TO INVOICE'S AND PO'S
      PROC_VALUES<87> = HFNAMES_ID: @AM :EXTRA_PPDREC : @AM : RB_FLAG : @AM : Email_Flag;*ADDED
   END ELSE
      PROC_VALUES = PROC_VALUES : @AM : PPD_REC : @AM : Email_Flag ;* REV12 CHANGE
      PROC_VALUES<85> = MENU : @AM : OPTION; * SENDING MENU AND OPTION (M_JCS_FyIVCP) TO INVOICE'S AND PO'S
      PROC_VALUES<87> = HFNAMES_ID: @AM :EXTRA_PPDREC: @AM : RB_FLAG : @AM : Email_Flag;*ADDED
   END
* For Report Purge & Clear v
   IF PurgePrompt # "" THEN
	ClearPurge = FIELD(PurgePrompt, "!", 1)
       PurgeAction = FIELD(PurgePrompt, "!", 2)
	IF PurgeAction = "E" THEN ClearPurge = "N"
		PURGEPROC_VALUES<1> = Cono
		PURGEPROC_VALUES<2> = SUB_REPORT<2> 
	       PURGEPROC_VALUES<3> = ClearPurge
		PURGEPROC_VALUES<4> = PurgeAction
       IF PurgeAction = 'M' THEN PurgePrompt = '';* To enable mail when PurgeAction=M
	WRITE PURGEPROC_VALUES ON PMC_REPORT_VALUES, CHANGE(PORT_NO,"*","_"):"_":SUB_REPORT<2>
	WRITE PURGEPROC_VALUES:"ASA":CHANGE(PORT_NO,"*","_"):"_":SUB_REPORT<2> ON CONTROL,"2R"
   END   
* For Report Purge & Clear ^
*   
   WRITE PROC_VALUES ON PMC_REPORT_VALUES, HF_NAME
WRITE PROC_VALUES ON CONTROL, "01TEST"
*
   MATREADU USER.REC FROM SECURITY, "R.":PORT_NO ELSE DUMMY = ""
   MAT USER.REC = ""
   USER.CONO = Cono
   USER.ID = OCONV(UserID, 'MCU')
   USER.DIR = "primacweb"
   USER.CORP = 0
   USER.M.CO = 1
   USER.C.CO = Cono
   USER.STAT = "PROC"
   USER.DATE = P_DATE
   USER.TIME = P_TIME
   USER.M.DSP = "XXX"
   USER.VERB = PPSID
   USER.V.DSP = "XXX"
   MATWRITE USER.REC ON SECURITY , "R.":PORT_NO
*
   PREV_USER4 = @USER4
   @USER4 = "redback":PPSR_ID:VM:UserID
*
*--- SET PRINTER
*
****************  
 SETPTR_CMD = ""
***************
*
   PROC_LINE    = "PQN"
   PROC_LINE<2> = 'MV %1 "' : PPSR_ID : '"'
   PROC_LINE<3> = 'MV %2 "' : HF_NAME : '"'
   PROC_LINE<4> = "H exePMCProcess"
   PROC_LINE<5> = "P"
   IF SETPTR_CMD # "" THEN
   	PROC_LINE<6> = "H " : SETPTR_CMD
   	PROC_LINE<7> = "P"
   END ELSE
   	PROC_LINE<6> = "C"
   	PROC_LINE<7> = "C"
   END
   IF POST_PROCESS #  "" THEN
   	PROC_LINE<8> = "[" : PPS.DIR : " " : POST_PROCESS : "]"
   END ELSE
   	PROC_LINE<8> = "[" : PPS.DIR : " " : PPS.PROCESS : "]"
   END
   READU DUMMY FROM F.VOC, HF_NAME ELSE DUMMY = ""
   WRITE PROC_LINE ON F.VOC, HF_NAME
WRITE PurgePrompt:AM:PROC_LINE ON CONTROL, "011TEST"
   UDTEXECUTE HF_NAME CAPTURING MESG
   WRITE "ERR MESG IS ":MESG ON CONTROL,'03HLL'
   *
* RETURN after processing
*
WRITE HF_NAME : " &&&&&&&& " : MESG ON CONTROL,'05HLL'
   READU DUMMY FROM F.VOC, HF_NAME ELSE DUMMY = ""
   DELETE F.VOC, HF_NAME
**********
**********
*
   READ DUMMY FROM PMCProcessData, PPSD_ID THEN ;* This file holds Data supplied by Client to a perticular report
      MESG = 'Report did not execute'
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG)
      RETURN
   END 
   ERRMESG = ''
		* Generating PDF's for Respective HF.NAME for Multiplereport's v
   FOR RR = 1 TO SCOUNT 
	IF SCOUNT > 1 THEN
	*	HF.NAME = PORT_NO : "_" : OCONV(LOG_NAME, 'MCU') : "_":SUB_REPORT<RR>;*eg:SYSTEM_11_SYSTEM_IC436
		MULTI_HF_NAME = CHANGE(PORT_NO,"*","_"):"_":SUB_REPORT<RR>
		HF.NAME = PPSR_ID_FILE<1,RR>
	END ELSE
	*	HF.NAME = PORT_NO : "_" : OCONV(LOG_NAME, 'MCU') : "_":REPORT_ID
		MULTI_HF_NAME = CHANGE(PORT_NO,"*","_"):"_":REPORT_ID
		HF.NAME = PPSR_ID
	END
*      HF.NAME = PORT_NO : "_" : OCONV(LOG_NAME, 'MCU')
*      HF.NAME = CHANGE(HF.NAME,"*","_")      ;*ADDED
WRITE HF.NAME:SCOUNT:PPSR_ID:PPSR_ID_FILE ON CONTROL,"1907T"
*
       READ DUMMY FROM CONTROL, HF.NAME ELSE DUMMY = ""
       READ VIEW_REC FROM CONTROL, USER.CONO:"VIEW_CONTROL" ELSE VIEW_REC = ""
       READ PSEC_REC FROM PRIMAC_SECURITY, UserID ELSE PSEC_REC = ""
*      
	WRITE DUMMY:" 11111 ":HFNAMES_ID:" ~ ":COMPANY.SECURITY<2>:" ~~ ":HF.NAME ON CONTROL,"01PRI"
	READ HOLD.REC FROM HOLD.FILE,HF.NAME ELSE HOLD.REC=''
 *		IF (REPORT_OPTION  = "Email" OR REPORT_OPTION  = "View") AND (HOLD.REC # '') THEN
WRITE "HOLD.REC GENERATED IS ":HOLD.REC ON CONTROL,"123XYZ"
	IF (HOLD.REC # '' AND PurgePrompt = "") THEN 
 			ERRMESG<1,-1> = ""
*		IF DUMMY<1> = ""  THEN
		BEGIN CASE 
		CASE DUMMY<1> = "" OR DUMMY<1> = "F" 
*			BEGIN CASE
*			   CASE OS_TYPE[1,7] = "WINDOWS"
			 IF OS_TYPE[1,7] = "WINDOWS" THEN	
		     	     READ WIN.PRINTERS.REC FROM WIN.PRINTERS,SETPTR_QUEUE THEN
				SETPTR_FORMATSTR = "Orientation=":WIN.PRINTERS.REC<5>
		         	SETPTR_FORMATSTR := ",Font=":WIN.PRINTERS.REC<6>
		         	SETPTR_FORMATSTR := ",FontSize=":WIN.PRINTERS.REC<7>
		         	SETPTR_FORMATSTR := ",TopMargin=":WIN.PRINTERS.REC<8>
		         	SETPTR_FORMATSTR := ",BottomMargin=":WIN.PRINTERS.REC<9>
		*
		         	*SETPTR_CMD = 'SETPTR 0,132,,,,1,AT '
                            SETPTR_CMD = 'SETPTR 0,':WIN.PRINTERS.REC<2>:',,,,1,AT '
*
		         	SETPTR_CMD := WIN.PRINTERS.REC<3>
*		         	SETPTR_CMD := "\\Printer\hpLaserJ"
		         	SETPTR_CMD := ',"':SETPTR_FORMATSTR:'", NHEAD,BRIEF'
		      	     END
			 END
*		   	   CASE OS_TYPE = "UNIX"
			 IF OS_TYPE[1,7] = "UNIX" THEN
		      		SETPTR_CMD = 'SETPTR ,,,,,,NHEAD,BRIEF,DEST '
		      		SETPTR_CMD := SETPTR_QUEUE:',NOMESSAGE'
                      END
*		   	   CASE 1
*			END CASE
			UDTEXECUTE SETPTR_CMD CAPTURING JUNK
WRITE SETPTR_QUEUE : " ^^ " : WIN.PRINTERS.REC<3> : " %%% " : SETPTR_CMD : " #### " : JUNK ON CONTROL,'01HLL'
		       CMD = 'SPOOL _HOLD_ ':HF.NAME:' -O'
	       	UDTEXECUTE CMD CAPTURING JUNK1
*		END 
*     		CASE DUMMY<1> = "M" AND PSEC_REC<8> # ""
      		CASE DUMMY<1> = "M"
         		READ EMAIL_REC FROM CONTROL, USER.CONO:"EMAIL_FORMAT" ELSE EMAIL_REC = ""
         		EMAIL_PARAM = ""
         		EMAIL_PARAM<1> = Cono
         		EMAIL_PARAM<2> = "ePRIMAC Company"
         		EMAIL_PARAM<3> = HF.NAME
         		IF EMAIL_REC<1> = "RTF" THEN
            		    EMAIL_PARAM<4> = 1
         		END ELSE
           		    EMAIL_PARAM<4> = 2
         		END 
         		IF EMAIL_ADDR = "" THEN
			    EMAIL_PARAM<5> = SEC.EMAIL
	  		END ELSE
			    EMAIL_PARAM<5> = EMAIL_ADDR
	 		END
	           IF PRPT.HEADING # "" THEN
		        FRSTPOS = ''
         		 FRSTPOS = FIELD(PPS.DESC," "1,1)
             		 TMP.PPS.DESC = ''
              	 TMP.PPS.DESC = PPS.DESC
              	IF LEN(FRSTPOS) < 4 THEN
               	  FRSTPOS = FRSTPOS : " "
                 	  SWAP FRSTPOS WITH "" IN TMP.PPS.DESC
              	END
*
	              *EMAIL_PARAM<6> = DOWNCASE(TMP.PPS.DESC)
			 EMAIL_PARAM<6> = TMP.PPS.DESC
       	    END ELSE
       	  	EMAIL_PARAM<6> = "Report"
		    END
       	  EMAIL_PARAM<7> = OS_TYPE[1,7]
	         EMAIL_PARAM<8> = PPSR_ID_FILE<1,RR>;*PPSR_ID for each ReportId
	         EMAIL_PARAM<9> = "redback"
	         IF PRPT_ID = "PO433" THEN 
                   STMT = "!blat .\_HOLD_\Message.txt -to ":EMAIL_PARAM<5>:" -s ":QUOTE(EMAIL_PARAM<6>):" -attach _HOLD_\":HF.NAME:" -debug"
                   SWAP HF.NAME WITH PROC_VALUES<3>:".txt" IN STMT
                   UDTEXECUTE STMT CAPTURING CAP RETURNING RET
		     DELETE HOLD.FILE,HF.NAME
		  END ELSE
                   CALL PMC_EMAIL_SUB (EMAIL_PARAM, ERRMSG)
		  END
	         DELETE CONTROL, HF.NAME
*	      CASE DUMMY<1> = "V" AND VIEW_REC<1> # ""
	      CASE DUMMY<1> = "V" AND (SEC_GUI_VIEW = "RTF" OR SEC_GUI_VIEW = "PDF")
*	       CASE VIEW_REC<1> = "PDF" OR VIEW_REC<1> = "RTF"
	         EMAIL_PARAM = ""
	         EMAIL_PARAM<1> = Cono
	         EMAIL_PARAM<2> = "ePRIMAC Company"
	         EMAIL_PARAM<3> = HF.NAME
	        * IF VIEW_REC<1> = "RTF" THEN
		  IF SEC_GUI_VIEW = "RTF" THEN
	            EMAIL_PARAM<4> = 1
	         END ELSE
	            EMAIL_PARAM<4> = 2
	         END
	         EMAIL_PARAM<5> = ""
	         EMAIL_PARAM<6> = "Report"
	         EMAIL_PARAM<7> = OS_TYPE[1,7]
	         EMAIL_PARAM<8> = PPSR_ID_FILE<1,RR>;*PPSR_ID for each ReportId
	         EMAIL_PARAM<9> = "redback"
 WRITE EMAIL_PARAM ON CONTROL,"01AK"
	         CALL PMC_VIEW_SUB (EMAIL_PARAM, ERRMSG)
	         DELETE CONTROL, HF.NAME
WRITE EMAIL_PARAM:@AM:PDFFILENAME ON CONTROL,"02AK"
*	         STMT2 = "COPY FROM _HOLD_ TO LOCAL_REPORTS "
*	         STMT2 := PPSR_ID :".": VIEW_REC<1> : "," : PPSR_ID :".": VIEW_REC<1>
*	         STMT2 := " DELETING"
*	         UDTEXECUTE STMT2 CAPTURING MESG
*       	  PDFFILENAME<1,-1> =  PPSR_ID_FILE<1,RR>:".":VIEW_REC<1>;*PDF Filename Generated eg:(00113781_2.PDFy00113781_3.PDF)
       	  PDFFILENAME<1,-1> =  PPSR_ID_FILE<1,RR>:".":SEC_GUI_VIEW;*PDF Filename Generated eg:(00113781_2.PDFy00113781_3.PDF)
 WRITE EMAIL_PARAM:@AM:PDFFILENAME :" ~~ ": SEC_GUI_VIEW ON CONTROL,"03AK"		  
		  STATUS = RBO.setProperty('','ReportImage', PDFFILENAME)
	      END CASE
	 END ELSE
    	    ERRMESG<1,-1>  = "There is no data to ":REPORT_OPTION
	 END
		  PMCDELETE = "DELETE PMC_REPORT_VALUES ":MULTI_HF_NAME
       	  UDTEXECUTE PMCDELETE CAPTURING PMCMESG
*
*	  	  DELETE HOLD.FILE,HF.NAME 
*
   NEXT RR
*******
	   @USER4 = PREV_USER4
   READU DUMMY FROM SECURITY, "R.":PORT_NO ELSE DUMMY = ""
   DELETE SECURITY, "R.":PORT_NO
   MATREADU PPSR.REC FROM PMCProcessStatus, PPSR_ID ELSE
      MAT PPSR.REC = ""
      PPSR.USER = UserID
      PPSR.SESSION = SessionID
      PPSR.PPID = PPSID
      PPSR.STATUS = "Lost"
      PPSR.STDATE = P_DATE
      PPSR.STTIME = P_TIME
      CALL GetSYSVars (PPSR.STSVAL, TDString)
      PPSR.PVALUES = CHANGE(PPD_REC,@AM,@VM)
   END
*
   TDString = TIMEDATE ()
   P_DATE = ICONV(TDString[10,11], "D")
   P_TIME = ICONV(FIELD(TDString, " ",1), "MT")
   PPSR.ENDATE = P_DATE
   PPSR.ENTIME = P_TIME
   MATWRITE PPSR.REC ON PMCProcessStatus, PPSR_ID
   RELEASE
*
******
*DEMO
      MESG = 'Report Executed'
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ServerMessage', MESG:PurgePrompt:"--")
      STATUS = RBO.setProperty('', 'ERR_MSG',ERRMESG)
    RETURN
* End of method code
99999*
   RETURN
END
