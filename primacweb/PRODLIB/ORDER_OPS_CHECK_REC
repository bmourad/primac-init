SUBROUTINE ORDER_OPS_CHECK_REC
********************************************************************************
*   Program name :- ORDER_OPS_CHECK_REC
*   Created:- 1/2/2006
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H

$INCLUDE CPYLIB COMMON1
$INCLUDE JCS.CPYLIB COM.JCS.LINK
$INCLUDE ICS.CPYLIB COM.INV.MAIN  
$INCLUDE ICS.CPYLIB COM.INV.SERIAL
$INCLUDE JCS.CPYLIB COM.INV.STATS 
$INCLUDE PMC.CPYLIB COM.CUST
$INCLUDE OPS.CPYLIB COM.ORDER
$INCLUDE PMC.CPYLIB FISCAL
$DEFINE CUSTOMER
$INCLUDE PMC.CPYLIB CUSTOMER
$DEFINE JOB
$INCLUDE JCS.CPYLIB JOB
$DEFINE JOBSTATS
$INCLUDE JCS.CPYLIB JOB.STATS
$DEFINE JOBCREDITSTATS
$INCLUDE JCS.CPYLIB JOB.CREDIT.STATS
$INCLUDE JCS.CPYLIB GANG.JOB
$INCLUDE JES.CPYLIB ESTIMATE
$DEFINE ORDER
$INCLUDE OPS.CPYLIB ORDER
$INCLUDE OPS.CPYLIB ORDER.DETAIL
$DEFINE ORDERDETAILINQ
$INCLUDE OPS.CPYLIB ORDER.DETAIL.INQ
$DEFINE SERIALRESV
$INCLUDE JCS.CPYLIB SERIAL.RESV
$DEFINE JOBFNGDSTATS
$INCLUDE OPS.CPYLIB JOB.FNGD.STATS
$DEFINE INVJOBSTATS
$INCLUDE ICS.CPYLIB INV.JOB.STATS
$DEFINE FNGDSTATS
$INCLUDE ICS.CPYLIB FNGD.STATS
$DEFINE INVENTORY
$INCLUDE ICS.CPYLIB INVENTORY
$DEFINE CATEGORY
$INCLUDE ICS.CPYLIB CATEGORY
$DEFINE INVWHSE
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE ICS.CPYLIB FNGD.JOB.STATS
$INCLUDE PSS.CPYLIB JOB.SCHED
$INCLUDE CPYLIB CHAR
$INCLUDE ICS.CPYLIB INV.CNV
$DEFINE FILEVARS
$INCLUDE CPYLIB FILE.VARS
  OPEN "","BOL" TO BOL ELSE
    ERRMSG = "Cannot locate the BOL file"
  END
  OPEN "","ORDER" TO ORDER ELSE
    ERRMSG = "Cannot locate the ORDER file"
  END
  OPEN "","ORDER.RELEASE" TO ORDER.RELEASE ELSE
    ERRMSG = "Cannot locate the ORDER.RELEASE file"
  END
	ORDERCMD="SSELECT ORDER WITH CONO=001"
	UDTEXECUTE ORDERCMD CAPTURING JUNK
	DONE=0
	ORDERIDARR = ''
	RR = 1
	LOOP
	   ERR=0
	   READNEXT ORDERID ELSE DONE=1
	UNTIL (DONE) DO
		ERRMSG = ""
		BEGIN CASE
		  CASE ORD.STATUS<1,1> = "CLOSED"
		    ERRMSG = "Order has already been closed"
		  CASE ORD.STATUS<1,1> = "CANCEL"
		    ERRMSG = "Order has already been cancelled"
		  CASE SUM(ODQ.A.QTY) # 0
		    ERRMSG = "Order cannot be closed because of allocated quantity"
		  CASE SUM(ODQ.R.QTY) # 0
		    ERRMSG = "Order cannot be closed because of reserved quantity"
		  CASE DCOUNT(ORD.REL.NO,VM) > 0
		    RCNT = DCOUNT(ORD.REL.NO,VM)
		    FOR R = 1 TO RCNT UNTIL ERRMSG # ""
		      MATREAD ORR.REC FROM ORDER.RELEASE, "001":ORD.REL.NO<1,R> THEN
			IF ORR.STATUS<1,1> # "COMPLETED" THEN
			  ERRMSG = "Order cannot be closed because of open Release ":ORD.REL.NO<1,R>
			END
		      END
		    NEXT R
		  CASE DCOUNT(ORD.BOL,VM) > 0
		    BCNT = DCOUNT(ORD.BOL,VM)
		    FOR B = 1 TO BCNT UNTIL ERRMSG # ""
		      MATREAD BOL.REC FROM BOL, "001":ORD.BOL<1,B> THEN
			IF BOL.STATUS # "CANCEL" AND BOL.INVOICE = "" THEN
			  ERRMSG = "Order cannot be closed because of uninvoiced Bill of Lading ":ORD.BOL<1,B>
			END
		      END
		    NEXT B
		END CASE
		IF ERRMSG # "" THEN
			ORDERIDARR<1,RR> = ORDERID
			RR = RR+1
		END
		WRITE ORDERIDARR ON CONTROL,"01ORDREC"
	REPEAT
RETURN

