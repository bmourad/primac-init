SUBROUTINE getOutSidePO
********************************************************************************
*   Program name :- getOutSidePO

*   Created:- 8/5/2003

*   Author Irfan M Saleem

* DESCRIPTION
*
* This program gets the data from the ESTIMATE file to load into the
* Estimate Outside Purchases (V)endor screen.
*
*********************************************************************
*
*---- FILE COPY STATEMENTS
*
   $INCLUDE WWINSERT RBO.H
   $INCLUDE JES.CPYLIB JES.FILE.VARS
   $INCLUDE CPYLIB FILE.VARS
   $INCLUDE JES.CPYLIB ESTIMATE
   $INCLUDE JCS.CPYLIB CATEGORY.OSP
   $INCLUDE PMC.CPYLIB VEND
   $INCLUDE CPYLIB CHAR
*
*---- OPEN ALL FILES
  IN_PARAM = "" ; OUT_PARAM = ""
   ERRMSG = "CALL openEstimateFiles PROBLEM"
   CALL openEstimateFiles(ERRMSG,IN_PARAM,OUT_PARAM,MAT FILE.VARS,MAT JES.FILE.VARS)
   IF ERRMSG # "" THEN GOTO 93000
*---- INITIALIZATION
*
   STATUS = RBO.getProperty('','ID',ESTIMATE.ID)
   CONO = ESTIMATE.ID[1,3]
   EST.ID = TRIM(ESTIMATE.ID[4,99])
   MATREAD EST.REC FROM ESTIMATE, ESTIMATE.ID ELSE
      ERRMSG = 'Estimate not on file. Try again!'
      GOTO 93000
   END
   IN_PARAM = ""
   IN_PARAM<1> = CONO
   IN_PARAM<2> = EST.ID
   finalOutside=""
*
*---- INITIALIZATION
*
   ERRMSG = ""
   CONO = IN_PARAM<1>
   EST.ID = IN_PARAM<2>
   ESTIMATE.ID = CONO:EST.ID
   DIM HOLD.REC(5)
   EQU HOLD.VEND  TO HOLD.REC(1)
   EQU HOLD.CAT   TO HOLD.REC(2)
   EQU HOLD.UOM   TO HOLD.REC(3)
   EQU HOLD.QTY   TO HOLD.REC(4)
   EQU HOLD.PRICE TO HOLD.REC(5)
   MAT HOLD.REC = ""
   LCNT = ""
*
*---- PROCESSING
*
   ECNT = DCOUNT(EST.QTY,VM)
   ACNT = DCOUNT(EST.DEPT.OSP,VM)
   FOR P1 = 1 TO ACNT
      BCNT = DCOUNT(EST.DEPT.OSP.ID<1,P1>,SM)
      FOR P2 = 1 TO BCNT
         LCNT = LCNT + 1
         VND = FIELD(EST.DEPT.OSP.ID<1,P1,P2>,"!",1)
         MATREAD VEND.REC FROM VEND,CONO:VND ELSE MAT VEND.REC=""
         CTG = FIELD(EST.DEPT.OSP.ID<1,P1,P2>,"!",2)
         MATREAD CAOS.REC FROM CATEGORY.OSP,CONO:CTG ELSE MAT CAOS.REC=""
         HOLD.VEND<1,LCNT> = VEND.DESC
         HOLD.CAT<1,LCNT> = CAOS.DESC
         HOLD.UOM<1,LCNT> = EST.DEPT.OSP.UM<1,P1,P2>
         FOR E = 1 TO ECNT
            QTY = FIELD(EST.DEPT.OSP.QTY<1,P1,P2>,"!",E)
            IF QTY = "" THEN
               DEPT = FIELD(EST.DEPT.OSP<1,P1>,"!",1)
               COMP = FIELD(EST.DEPT.OSP<1,P1>,"!",2)
               EQTY = EST.QTY<1,E>
             *  IF EST.PDEF.TYPE = "RL" THEN
               *   CALL EST.RL.QTY.CALC (CONO,"E",EST.KEY,DEPT,COMP,EQTY)
              * END ELSE
              *    CALL EST.QTY.CALC (CONO,"E",EST.KEY,DEPT,COMP,EQTY)
              * END
               QTY = FIELD(EST.DEPT.OSP.QTY<1,P1,P2>,"!",E)
            END
            IF MOD(QTY,100)=0 THEN QTY=INT(QTY/100) ELSE QTY=QTY/100
            HOLD.QTY<1,LCNT,E> = QTY
            HOLD.PRICE<1,LCNT,E> = FIELD(EST.DEPT.OSP.PRICE<1,P1,P2>,"!",E)
         NEXT E
      NEXT P2
   NEXT P1

finalOutside=finalOutside :HOLD.VEND:"|":HOLD.CAT:"|":HOLD.UOM:"~":HOLD.QTY:"|":EST.DEPT.OSP.PRICE :"~":EST.CUST.NAME
*STATUS = RBO.setProperty('','EST_OSP_STR',EST.DEPT.OSP.PRICE)
 

*---- BUILD RBO RECORD
*
  STATUS = RBO.setProperty('','EST_OSP_STR',finalOutside)
 
   RETURN

   IF ERRMSG # "" THEN GOTO 93000
   RETURN
93000 *
   STATUS = RBO.setProperty('','ServerStatus',1)
   STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
   RETURN

