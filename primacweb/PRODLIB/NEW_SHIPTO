SUBROUTINE NEW_SHIPTO
********************************************************************************
*   Program name :- NEW_SHIPTO
*   Created:- 9/15/2005
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE PMC.CPYLIB SHIP.TO
$INCLUDE PMC.CPYLIB CUSTOMER
* Insert method code here

OPEN "SHIP.TO" TO SHIP.TO ELSE ERRMSG = "SHIP.TO FILE IS MISSING"
OPEN "CUSTOMER" TO CUSTOMER ELSE ERRMSG = "CUSTOMER FILE IS MISSING"

STATUS = RBO.getProperty('','ID',ID)
STATUS = RBO.getProperty('','TaxJurDescs',CST_VAL)
CONO = ID[1,3]
CUSTNO = FIELD(ID,"!",1)[4,99]
SHPNO = FIELD(ID,"!",2)

ISNEWCUST    = CST_VAL<1,1>
CUST_SHIP_TO = CST_VAL<1,2>

   IF ISNEWCUST # 1 THEN
      MATREAD CUST.REC FROM CUSTOMER,CONO:CUSTNO ELSE
         ERRMSG = "INVALID ":CUSTNO:". TRY AGAIN !" 
         GOTO 91000
      END
   END ELSE
      MAT CUST.REC = ""
      CUST.SHIP.TO = CUST_SHIP_TO
   END

   MATREADU SPT.REC FROM SHIP.TO, CONO:CUSTNO:"!":SHPNO LOCKED
      ERRMSG = 'SHIP TO record is locked by user - ':GETUSERNAME(STATUS())
      GOSUB 91000
   END ELSE
      CUST.SHIP.TO = CUST.SHIP.TO + 1
      SHPNO = CUST.SHIP.TO "R%3"
      ERRMSG = "NOTE NEW SHIP TO NUMBER : ":SHPNO
      GOSUB 91000
      RELEASE SHIP.TO, CONO:CUSTNO:"!":SHPNO
   END
   STATUS = RBO.setProperty('','SHPNO',SHPNO)
   STATUS = RBO.setProperty('','FobDesc',CUST.SHIP.TO)
   MATWRITE SPT.REC ON SHIP.TO, CONO:CUSTNO:"!":SHPNO
   IF ISNEWCUST # 1 THEN
      MATWRITEU CUST.REC ON CUSTOMER, CONO:CUSTNO
   END
RETURN

91000
STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN

* End of method code

