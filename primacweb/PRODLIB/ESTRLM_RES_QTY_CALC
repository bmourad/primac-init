SUBROUTINE ESTRLM_RES_QTY_CALC
********************************************************************************
*   Program name :- ESTRLM_RES_QTY_CALC
*   Created:- 9/24/2005
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************

* Insert method code here
$INCLUDE JES.CPYLIB SCOMMON.ESTIMATE
$INCLUDE WWINSERT RBO.H

*	$INCLUDE CPYLIB COMMON1
*	COM EST.REC(300),ESTD.TEMP(55),ESTD.REC(55),ESTM.REC(50),JES.FILE.VARS(30)

$DEFINE ESTIMATE
$INCLUDE JES.CPYLIB ESTIMATE
$INCLUDE PMC.CPYLIB COST.CNTR
$INCLUDE PMC.CPYLIB VEND
$INCLUDE PMC.CPYLIB SHIP.VIA
$INCLUDE JCS.CPYLIB CATEGORY.OSP
$INCLUDE JES.CPYLIB ESTIMATE.GRP
$DEFINE ESTIMATEMATL
$INCLUDE JES.CPYLIB ESTIMATE.MATL
$DEFINE ESTIMATEDEPT
$INCLUDE JES.CPYLIB ESTIMATE.DEPT
$DEFINE ESTIMATETEMP
$INCLUDE JES.CPYLIB ESTIMATE.TEMP
$INCLUDE JES.CPYLIB ESTIMATE.TEMP2
$DEFINE JESFILEVARS
$INCLUDE JES.CPYLIB JES.FILE.VARS
$INCLUDE CPYLIB CHAR
$DEFINE FILEVARS
$INCLUDE CPYLIB FILE.VARS
$INCLUDE JES.CPYLIB ESTIMATE.TBL
$INCLUDE JCS.CPYLIB OPERATION

OPEN "ESTIMATE" TO ESTIMATE ELSE ERRMSG="CANNOT OPEN ESTIMATE FILE";GOTO 90000
OPEN "ESTIMATE.MATL" TO ESTIMATE.MATL ELSE ERRMSG="CANNOT OPEN ESTIMATE.MATL FILE";GOTO 90000
OPEN "ESTIMATE.DEPT" TO FESTIMATE.DEPT ELSE ERRMSG = "CANNOT LOCATE FESTIMATE.DEPT FILE";GOSUB 90000

OPEN "ESTIMATE.DEPT" TO ESTIMATE.DEPT ELSE ERRMSG = "CANNOT LOCATE ESTIMATE.DEPT FILE";GOSUB 90000
*OPEN "ESTIMATE.TEMP" TO ESTIMATE.TEMP ELSE ERRMSG = "CANNOT LOCATE ESTIMATE.TEMP FILE";GOSUB 90000
*OPEN "ESTIMATE.TEMP2" TO ESTIMATE.TEMP2 ELSE ERRMSG = "CANNOT LOCATE ESTIMATE.TEMP2 FILE";GOSUB 90000

OPEN "CONTROL" TO CONTROL ELSE ERRMSG="CANNOT OPEN CONTROL FILE";GOSUB 90000
OPEN "COST.CNTR" TO COST.CNTR ELSE ERRMSG="CANNOT OPEN COST.CNTR FILE";GOTO 90000
OPEN "OPERATION" TO OPERATION ELSE ERRMSG="CANNOT OPEN OPERATION FILE";GOTO 90000

STATUS = RBO.getProperty('','VALUECONTENT_TOTAL',VALUECONTENT_TOTAL)

*VALUECONTENT_TOTAL = "001!E!2059-01!4!1!40000"
VALUECONTENT = ''

VALUECONTENT = VALUECONTENT_TOTAL

CONO 		= FIELD(VALUECONTENT,"!",1)
ACTION		= FIELD(VALUECONTENT,"!",2)
EST.KEY	= FIELD(VALUECONTENT,"!",3)
DEPT		= FIELD(VALUECONTENT,"!",4)
COMP 		= FIELD(VALUECONTENT,"!",5)
EQTY		= FIELD(VALUECONTENT,"!",6)
DCPTR		= FIELD(VALUECONTENT,"!",7)
EST.DEPT.COMP = FIELD(VALUECONTENT,"!",8)

   MATREAD EST.REC FROM ESTIMATE, CONO:EST.KEY ELSE
      ERRMSG = "Cannot Read ESTIMATE ":CONO:EST.KEY	
      RETURN
   END

*
*---- INITIALIZATION
*
	ERRMSG1 = ''

   BQTY = EST.BASE.QTY
   TEST.FLAG = 0 ;****  T E S T   F L A G  ****

   IF ACTION[2,1] = "" THEN
      PRINT.FLG = 1
   END ELSE
      PRINT.FLG = 0
   END
*
*---- MAIN PROCESSING
*



100*
   ESTD.ID = DEPT:"!":COMP:"!":BQTY
   MATREAD ESTD.REC FROM ESTIMATE.DEPT, CONO:EST.KEY:"!":ESTD.ID ELSE
      ERRMSG = "Cannot Read ESTIMATE.DEPT	 ":CONO:EST.KEY:"!":ESTD.ID
     RETURN
   END
   IF TEST.FLAG THEN
	P_OPT = ""
*      P_X  = 0 ; P_Y = 23 ; P_VALUE = 'ESTD.ID=(':CONO:EST.KEY:"!":ESTD.ID:')' ;P_OPT = ""
*      CALL VSI_SI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
   END
   IF PRINT.FLG THEN
	ERRMSG1 = "Processing Department ":EST.DEPT<1,DEPT>:", Component ":COMP:", Quantity ":EQTY
	P_OPT = "CL"
*      P_X  = 3 ; P_Y = 23 ; P_VALUE = "Processing Department ":EST.DEPT<1,DEPT>:", Component ":COMP:", Quantity ":EQTY ; P_OPT = "CL"
*      CALL VSI_SI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
   END

   IF EQTY = BQTY THEN
      LOCATE "MR" IN ESTD.TYPE<1>,1 SETTING LPTR ELSE
         LOCATE "MS" IN ESTD.TYPE<1>,1 SETTING LPTR ELSE
            LPTR = 0
         END
      END
      IF LPTR > 0 THEN
         GOSUB 50000
         IF TEMP.GRP.CCTR = "PRS" THEN
            TEMP.CCTR = EST.PROD.PRESS.ID<1,COMP>
         END
         TCNT = DCOUNT(ESTD.TYPE,VM)
         FOR TPTR = TCNT TO LPTR STEP -1
            IF ESTD.TYPE<1,TPTR> = "MR" OR ESTD.TYPE<1,TPTR> = "MS" THEN
               FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
                  ESTD.REC(A) = DELETE(ESTD.REC(A),1,TPTR,0)
               NEXT A
            END
         NEXT TPTR
         LPTR = LPTR - 1
         IF TEST.FLAG THEN MSG="INSERT STK";GOSUB 90000

*	 CALL EST.INSERT.STK (CONO, EQTY, DEPT, COMP, LPTR)

	 GOSUB ESTCEM_INSERT_STK

      END
      LOCATE "MI" IN ESTD.TYPE<1>,1 SETTING LPTR ELSE LPTR = 0
      IF LPTR > 0 THEN
         GOSUB 50000
         IF TEMP.GRP.CCTR = "PRS" THEN
            TEMP.CCTR = EST.PROD.PRESS.ID<1,COMP>
         END
         TCNT = DCOUNT(ESTD.TYPE,VM)
         FOR TPTR = TCNT TO 1 STEP -1
            IF ESTD.TYPE<1,TPTR> = "MI" THEN
               FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
                  ESTD.REC(A) = DELETE(ESTD.REC(A),1,TPTR,0)
               NEXT A
            END
         NEXT TPTR
         LPTR = LPTR - 1
         IF TEST.FLAG THEN MSG="INSERT INK";GOSUB 90000
         
*	 CALL EST.INSERT.INK (CONO, EQTY, DEPT, COMP, LPTR)

	 GOSUB ESTCEM_INSERT_INK
      END
      LOCATE "MC" IN ESTD.TYPE<1>,1 SETTING LPTR ELSE LPTR = 0
      IF LPTR > 0 THEN
         GOSUB 50000
         TCNT = DCOUNT(ESTD.TYPE,VM)
         FOR TPTR = TCNT TO 1 STEP -1
            IF ESTD.TYPE<1,TPTR> = "MC" THEN
               SAVE.CCTR = ESTD.CCTR<1,TPTR>
               FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
                  ESTD.REC(A) = DELETE(ESTD.REC(A),1,TPTR,0)
               NEXT A
            END
         NEXT TPTR
         LPTR = LPTR - 1
         IF TEST.FLAG THEN MSG="INSERT CASE";GOSUB 90000
 
*	 CALL EST.INSERT.CASE (CONO, EQTY, DEPT, COMP, LPTR)
	 GOSUB ESTCEM_INSERT_CASE

      END
      SLPTR = 1
      LOOP
         LOCATE "CUT" IN ESTD.GRP.CCTR<1>,SLPTR SETTING LPTR ELSE LPTR = 0
      WHILE LPTR > 0 DO
         OPER = ESTD.OPV<1,LPTR>
         MAT ESTD.TEMP2 = ""
         TDP = 0
         STORE.TEMP = 1
         LOOP
         WHILE ESTD.GRP.CCTR<1,LPTR> = "CUT" DO
            IF STORE.TEMP THEN
               TDP = TDP + 1
               FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
                  ESTD.TEMP2(A)<1,TDP> = ESTD.REC(A)<1,LPTR>
               NEXT A
               TEMP.GRP.QTY = ESTD.GRP.QTY<1,LPTR> / 100
               IF TEMP.GRP.QTY = INT(TEMP.GRP.QTY) THEN TEMP.GRP.QTY = INT(TEMP.GRP.QTY)
               TEMP2.GRP.QTY<1,TDP> = TEMP.GRP.QTY
            END
            FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
               ESTD.REC(A) = DELETE(ESTD.REC(A),1,LPTR,0)
            NEXT A
            IF ESTD.OPV<1,LPTR> = OPER THEN STORE.TEMP = 0
         REPEAT
         LPTR = LPTR - 1
         IF TEST.FLAG THEN MSG="INSERT CUT";GOSUB 90000

*         CALL EST.INSERT.CUT (CONO, EQTY, DEPT, COMP, LPTR, MAT ESTD.TEMP2)
	  
	  GOSUB ESTCEM_INSERT_CUT

         SLPTR = LPTR+1
      REPEAT
      SLPTR = 1
      LOOP
         LOCATE "FLD" IN ESTD.GRP.CCTR<1>,SLPTR SETTING LPTR ELSE LPTR = 0
      WHILE LPTR > 0 DO
         OPER = ESTD.OPV<1,LPTR>
         MAT ESTD.TEMP2 = ""
         TDP = 0
         STORE.TEMP = 1
         LOOP
         WHILE ESTD.GRP.CCTR<1,LPTR> = "FLD" DO
            IF STORE.TEMP THEN
               TDP = TDP + 1
               FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
                  ESTD.TEMP2(A)<1,TDP> = ESTD.REC(A)<1,LPTR>
               NEXT A
               TEMP.GRP.QTY = ESTD.GRP.QTY<1,LPTR> / 100
               IF TEMP.GRP.QTY = INT(TEMP.GRP.QTY) THEN TEMP.GRP.QTY = INT(TEMP.GRP.QTY)
               TEMP2.GRP.QTY<1,TDP> = TEMP.GRP.QTY
            END
            FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
               ESTD.REC(A) = DELETE(ESTD.REC(A),1,LPTR,0)
            NEXT A
            IF ESTD.OPV<1,LPTR> = OPER THEN STORE.TEMP = 0
         REPEAT
         LPTR = LPTR - 1
         IF TEST.FLAG THEN MSG="INSERT FLD";GOSUB 90000

*	 CALL EST.INSERT.FLD (CONO, EQTY, DEPT, COMP, LPTR, MAT ESTD.TEMP2)
	 
	 GOSUB ESTCEM_INSERT_FLD

	 SLPTR = LPTR+1
      REPEAT
   END
   TOTAL.HRS = 0
   TOTAL.DCOST = 0
   TOTAL.COST = 0
   TOTAL.SALE = 0
   TOTAL.TSALE = 0
   TOTAL.VSALE = 0
   TOTAL.VCOST = 0
   TCNT = DCOUNT(ESTD.TYPE,VM)
   FOR TPTR = 1 TO TCNT
150*
      IF ESTD.TYPE<1,TPTR> = "G" THEN GOTO 990
      ACT = ACTION[1,1]
      MAT ESTD.TEMP = ""
      FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
         ESTD.TEMP(A) = ESTD.REC(A)<1,TPTR>
      NEXT A
      IF TEMP.GRP.CCTR = "PRS" THEN
         IF EST.PROD.PRESS.ID<1,COMP> = "" THEN
            FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
               ESTD.REC(A) = DELETE(ESTD.REC(A),1,TPTR,0)
            NEXT A
            IF TPTR = TCNT THEN GOTO 10001000 ELSE GOTO 150
         END
         IF EST.PROD.PRESS.ID<1,COMP> # TEMP.CCTR THEN
            TEMP.CCTR = EST.PROD.PRESS.ID<1,COMP>
            ACT = "C"
         END
      END
      IF TEMP.TYPE[1,1] = "L" AND ACT = "C" THEN
         MATREAD CCTR.REC FROM COST.CNTR, CONO:TEMP.CCTR ELSE
            TEMP.CCTR = ESTD.CCTR<1,TPTR>
            GOTO 200
         END
         LOCATE TEMP.OPV IN CCTR.OPER<1>,1 SETTING OP.PTR ELSE
            TEMP.CCTR = ESTD.CCTR<1,TPTR>
            GOTO 200
         END
         TEMP.OPV.TYPE=CCTR.OPER.TYPE<1,OP.PTR>
         IF CCTR.OPER.STD.IMP<1,OP.PTR>+0=0 THEN TEMP.OPV.TYPE="F"
         IF TEMP.OPV.TYPE="F" THEN
            IF CCTR.OPER.STD.HRS<1,OP.PTR>+0 > 0 THEN
               TEMP.STD=CCTR.OPER.STD.HRS<1,OP.PTR>
               TEMP.STD.TYPE="HR/OP"
            END
         END ELSE
            IF CCTR.OPER.STD.IMP<1,OP.PTR>+0 > 0 THEN
               TEMP.STD=CCTR.OPER.STD.IMP<1,OP.PTR>*100
               TEMP.STD.TYPE="OP/HR"
            END
         END
         IF TEMP.STD+0=0 THEN TEMP.STD=""
         TEMP.RATE=CCTR.OPER.HR.RATE<1,OP.PTR>
         TEMP.IND.1=CCTR.FOH.TYPE<1,1>:CCTR.FOH.PCT<1,1>
         TEMP.IND.2=CCTR.FOH.TYPE<1,2>:CCTR.FOH.PCT<1,2>
         TEMP.IND.3=CCTR.FOH.TYPE<1,3>:CCTR.FOH.PCT<1,3>
         TEMP.IND.4=CCTR.FOH.TYPE<1,4>:CCTR.FOH.PCT<1,4>
         TEMP.MARKUP=CCTR.OPER.MARKUP<1,OP.PTR>
      END
200*
      TEMP.QTY = TEMP.QTY / 100
      IF TEMP.QTY = INT(TEMP.QTY) THEN TEMP.QTY = INT(TEMP.QTY)
      TEMP.STD = TEMP.STD / 100
      IF TEMP.STD = INT(TEMP.STD) THEN TEMP.STD = INT(TEMP.STD)
      TEMP.GRP.QTY = TEMP.GRP.QTY / 100
      IF TEMP.GRP.QTY = INT(TEMP.GRP.QTY) THEN TEMP.GRP.QTY = INT(TEMP.GRP.QTY)
      BEGIN CASE
         CASE TEMP.TYPE[1,1] = "L"
            BEGIN CASE
               CASE TEMP.GRP.CCTR = "CUT" AND EQTY = BQTY
               CASE TEMP.GRP.CCTR = "FLD" AND EQTY = BQTY
               CASE TEMP.GRP.QCALC = "F"
                  TEMP.FPTR = TPTR

                  SUB.NAME = "EST.FORMULA.Q":TEMP.GRP.QPARAM
                  IF TEST.FLAG THEN MSG=SUB.NAME;GOSUB 90000
                  
*		  IF TEMP.GRP.QPARAM = '030' THEN
*                    CALL EST.FORMULA.Q030 (CONO,'R',EQTY,DEPT,COMP)
*                 END ELSE
*                    CALL @SUB.NAME (CONO, "R", EQTY, DEPT, COMP)
*                 END
*********		
		VALUECONTENT = TEMP.GRP.QPARAM :"^": "R" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE  :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_Q
		STATUS = RBO.getProperty('', 'ESTDEPTINFO',ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
		GOSUB ASSIGN_VALUES
********
            END CASE
            BEGIN CASE
               CASE TEMP.GRP.CCTR = "CUT"
               CASE TEMP.GRP.CCTR = "FLD"
               CASE TEMP.GRP.FCALC = "F"
                  TEMP.FPTR = TPTR
	          SUB.NAME = "EST.FORMULA.F":TEMP.GRP.FPARAM
                  IF TEST.FLAG THEN MSG=SUB.NAME;GOSUB 90000
*                  CALL @SUB.NAME (CONO, "R", EQTY, DEPT, COMP)
**********
		 VALUECONTENT = TEMP.GRP.FPARAM :"^": "R" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE :"^": TEMP.STD :"^": TEMP.STD.TYPE :"^ "
		 STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		 CALL ESTCEM_EST_FORMULA_F
		 STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
		 RESULT_OF_FORMULA = ESTDEPTINFO
  	         GOSUB ASSIGN_VALUES
***********
               CASE TEMP.GRP.FCALC = "T"
                  TBL.ID = TEMP.GRP.FPARAM
                  IF TEST.FLAG THEN MSG="EST.TABLE.FCTR";GOSUB 90000
*                  CALL EST.TABLE.FCTR (CONO, TBL.ID, TEMP.GRP.FCTR)
		  CALL EST_TABLE_FCTR (CONO, TEMP.QTY, TBL.ID, TEMP.GRP.FCTR)
		  IF TEMP.FCTR+0 = 0 THEN TEMP.FCTR = 1000
            END CASE
         CASE TEMP.TYPE[1,1] = "M"
            BEGIN CASE
               CASE TEMP.TYPE = "MR" AND EQTY = BQTY
                  GOTO 390
               CASE TEMP.TYPE = "MI" AND EQTY = BQTY
                  GOTO 390
               CASE TEMP.TYPE = "MC" AND EQTY = BQTY
                  GOTO 390
               CASE TEMP.TYPE = "MS" OR TEMP.TYPE = "MR"
                  TEMP.TYPE = "M":EST.PROD.OS.TYPE<1,COMP>
                  MPTR = TEMP.MPTR
                  MATREAD ESTM.REC FROM ESTIMATE.MATL, CONO:EST.PROD.OS.TYPE<1,COMP>:EST.PROD.OS.USAGE<1,COMP,MPTR> ELSE GOTO 390
                  LOCATE EST.PROD.OS.PROD<1,COMP,MPTR> IN ESTM.PROD<1>,1 SETTING MT.PTR ELSE GOTO 390
               CASE 1
                  MATREAD ESTM.REC FROM ESTIMATE.MATL, CONO:TEMP.TYPE[2,1] ELSE GOTO 390
                  LOCATE TEMP.OPV IN ESTM.PROD<1>,1 SETTING MT.PTR ELSE GOTO 390
            END CASE
            IF ACT = "C" AND (TEMP.TYPE = "MP" OR TEMP.TYPE = "MF" OR TEMP.TYPE = "MB" OR TEMP.TYPE = "ML" OR TEMP.TYPE = "MO" OR TEMP.TYPE = "MX") THEN
               TEMP.STD = ESTM.COST <1,MT.PTR>/ 100
            END
            BEGIN CASE
               CASE TEMP.GRP.QCALC = "F"
                  TEMP.FPTR = TPTR

                  SUB.NAME = "EST.FORMULA.Q":TEMP.GRP.QPARAM
                  IF TEST.FLAG THEN MSG=SUB.NAME;GOSUB 90000
                  
*		  CALL @SUB.NAME (CONO, "R", EQTY, DEPT, COMP)
  		  
		  VALUECONTENT = TEMP.GRP.QPARAM :"^": "R" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE  :"^ "
		  STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		  CALL ESTCEM_EST_FORMULA_Q
		  STATUS = RBO.getProperty('', 'ESTDEPTINFO',ESTDEPTINFO)
		  RESULT_OF_FORMULA = ESTDEPTINFO
		  GOSUB ASSIGN_VALUES
            END CASE
            BEGIN CASE
               CASE TEMP.GRP.FCALC = "F"
                  TEMP.FPTR = TPTR
                  SUB.NAME = "EST.FORMULA.F":TEMP.GRP.FPARAM
                  IF TEST.FLAG THEN MSG=SUB.NAME;GOSUB 90000
*		  CALL @SUB.NAME (CONO, "R", EQTY, DEPT, COMP)
**********
		  VALUECONTENT = TEMP.GRP.FPARAM :"^": "R" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE :"^": TEMP.STD :"^": TEMP.STD.TYPE :"^ "
		  STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		  CALL ESTCEM_EST_FORMULA_F
		  STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
		  RESULT_OF_FORMULA = ESTDEPTINFO
  	          GOSUB ASSIGN_VALUES
***********
 
               CASE TEMP.GRP.FCALC = "T"
                  TBL.ID = TEMP.GRP.FPARAM
                  IF TEST.FLAG THEN MSG="EST.TABLE.FCTR";GOSUB 90000
*                 CALL EST.TABLE.FCTR (CONO, TBL.ID, TEMP.GRP.FCTR)
		  CALL EST_TABLE_FCTR (CONO, TEMP.QTY, TBL.ID, TEMP.GRP.FCTR)
                  IF TEMP.FCTR+0 = 0 THEN TEMP.FCTR = 1000
            END CASE
         CASE 1
            BEGIN CASE
               CASE TEMP.GRP.QCALC = "F"
                  TEMP.FPTR = TPTR
                  SUB.NAME = "EST.FORMULA.Q":TEMP.GRP.QPARAM
                  IF TEST.FLAG THEN MSG=SUB.NAME;GOSUB 90000

*		  CALL @SUB.NAME (CONO, "R", EQTY, DEPT, COMP)

		  VALUECONTENT = TEMP.GRP.QPARAM :"^": "R" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE  :"^ "
		  STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		  CALL ESTCEM_EST_FORMULA_Q
		  STATUS = RBO.getProperty('', 'ESTDEPTINFO',ESTDEPTINFO)
		  RESULT_OF_FORMULA = ESTDEPTINFO
		  GOSUB ASSIGN_VALUES

            END CASE
            BEGIN CASE
               CASE TEMP.GRP.FCALC = "F"
                  TEMP.FPTR = TPTR
                  SUB.NAME = "EST.FORMULA.F":TEMP.GRP.FPARAM
                  IF TEST.FLAG THEN MSG=SUB.NAME;GOSUB 90000

*                  CALL @SUB.NAME (CONO, "R", EQTY, DEPT, COMP)
**********
		  VALUECONTENT = TEMP.GRP.FPARAM :"^": "R" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE :"^": TEMP.STD :"^": TEMP.STD.TYPE :"^ "
		  STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		  CALL ESTCEM_EST_FORMULA_F
		  STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
		  RESULT_OF_FORMULA = ESTDEPTINFO
  	          GOSUB ASSIGN_VALUES
***********
               CASE TEMP.GRP.FCALC = "T"
                  TBL.ID = TEMP.GRP.FPARAM
                  IF TEST.FLAG THEN MSG="EST.TABLE.FCTR";GOSUB 90000
*		  CALL EST.TABLE.FCTR (CONO, TBL.ID, TEMP.GRP.FCTR)
		  CALL EST_TABLE_FCTR (CONO, TEMP.QTY, TBL.ID, TEMP.GRP.FCTR)                  
		  IF TEMP.FCTR+0 = 0 THEN TEMP.FCTR = 1000
            END CASE
      END CASE
390*
      IF TEMP.TYPE[1,1] = "P" THEN
         IF ACTION[1,1] # "N" THEN     ;* T21648
            IF TEST.FLAG THEN MSG="OSP.UPD";GOSUB 90000
		REF.NO = TPTR
		VALUECONTENT = "R":"^":DPTR:"^":COMP:"^":EQTY:"^":REF.NO:"^":EST.KEY:"^":DPTR:"^":TEMP.TYPE:"^":TEMP.OPV:"^":TEMP.CODE:"^":TEMP.QTY:"^":TEMP.STD
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
*		CALL EST.OSP.UPD (CONO,"R",DEPT,COMP,EQTY,TPTR)
		CALL ESTCEM_OSP_UPD
		STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
		GOSUB ASSIGN_VALUES
         END
      END
*
*---- CALCULATE HOURS, COST AND SALE AMOUNTS
*
*T27716 v
*     CALL EST.CALC.COST (CONO)
*     CALL EST.CALC.COST (CONO,DEPT)

      CALC_COST_PARAM = DPTR:"^":TEMP.TYPE:"^":TEMP.OPV.TYPE:"^":TEMP.QTY:"^":TEMP.FCTR:"^":TEMP.STD:"^":TEMP.RATE:"^":TEMP.UM:"^":TEMP.IND.1:"^":TEMP.IND.2:"^":TEMP.IND.3:"^":TEMP.IND.4

      STATUS = RBO.setProperty('','DREFCREF',CALC_COST_PARAM)
      CALL EST_CALC_COST
      STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)

	TEMP.TSALE  = FIELD(ESTDEPTINFO,"^",1)
	TEMP.HRS    = FIELD(ESTDEPTINFO,"^",2)
	TEMP.DCOST  = FIELD(ESTDEPTINFO,"^",3)
	TEMP.COST   = FIELD(ESTDEPTINFO,"^",4)
	TEMP.SALE   = FIELD(ESTDEPTINFO,"^",5)
*T27716 ^
      TOTAL.HRS = TOTAL.HRS + TEMP.HRS
      TOTAL.DCOST = TOTAL.DCOST + TEMP.DCOST
      TOTAL.COST = TOTAL.COST + TEMP.COST
      TOTAL.SALE = TOTAL.SALE + TEMP.SALE
      TOTAL.TSALE = TOTAL.TSALE + TEMP.TSALE
      BEGIN CASE
         CASE TEMP.VSALE = "Y"
            TOTAL.VSALE = TOTAL.VSALE + TEMP.TSALE
            TOTAL.VCOST = TOTAL.VCOST + TEMP.COST
         CASE TEMP.VSALE = ""
            NULL
         CASE NUM(TEMP.VSALE)
            PCT = TEMP.VSALE / 100
            TOTAL.VSALE = TOTAL.VSALE + INT(TEMP.TSALE*PCT/100+0.5)
            TOTAL.VCOST = TOTAL.VCOST + INT(TEMP.COST*PCT/100+0.5)
      END CASE
*
*---- RESTORE TEMP DATA
*
      FOR A  =  ESTD.FIRST.MV TO ESTD.LAST.MV
         ESTD.REC(A)<1,TPTR> = ESTD.TEMP(A)
      NEXT A
      ESTD.QTY<1,TPTR> = TEMP.QTY * 100
      ESTD.STD<1,TPTR> = TEMP.STD * 100
      ESTD.GRP.QTY<1,TPTR> = TEMP.GRP.QTY * 100
990 NEXT TPTR
*
*---- WRITE RECORD FOR NEW QUANTITY
*
10001000*
   ESTD.ID = DEPT:"!":COMP:"!":EQTY
   LOCATE ESTD.ID IN EST.DEPT.COMP<1>,1 SETTING PP ELSE
      EST.DEPT.COMP<1,PP> = ESTD.ID
   END
   EST.DEPT.COMP.HRS<1,PP> = TOTAL.HRS
   EST.DEPT.COMP.DCOST<1,PP> = TOTAL.DCOST
   EST.DEPT.COMP.COST<1,PP> = TOTAL.COST
   EST.DEPT.COMP.SALE<1,PP> = TOTAL.SALE
   EST.DEPT.COMP.TSALE<1,PP> = TOTAL.TSALE
   EST.DEPT.COMP.VSALE<1,PP> = TOTAL.VSALE
   EST.DEPT.COMP.VCOST<1,PP> = TOTAL.VCOST

ESTDEPTINFO = "SL.NO. ":DCPTR: " TYPE "ESTD.TYPE:" ID ":ESTD.ID:"~":TOTAL.HRS:"~":TOTAL.DCOST:"~":TOTAL.COST:"~":TOTAL.SALE:"~":TOTAL.TSALE:"~":TOTAL.VSALE:"~":TOTAL.VCOST

   MATWRITE ESTD.REC ON ESTIMATE.DEPT, CONO:EST.KEY:"!":ESTD.ID

  IF PRINT.FLG THEN
	P_OPT = "CL"
*      P_X  = 0 ; P_Y = 23 ; P_VALUE = "" ; P_OPT = "CL"
*      CALL VSI_SI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
   END
	P_OPT = "CL"
*   P_X  = 0 ; P_Y = 23 ; P_VALUE = "" ; P_OPT = "CL"
*   CALL VSI_SI_PLINE(P_X,P_Y,P_VALUE,P_OPT)

STATUS = RBO.setProperty('', 'ESTRLM_Recal_MSG_1', ERRMSG1)
RETURN
RETURN

*
*---- SAVE GROUP VALUES
*
50000*
   MAT ESTD.TEMP = ""
   TEMP.TYPE = ESTD.TYPE<1,LPTR>
   TEMP.CCTR = ESTD.CCTR<1,LPTR>
   TEMP.GRP.ID = ESTD.GRP.ID<1,LPTR>
   TEMP.GRP.CCTR = ESTD.GRP.CCTR<1,LPTR>
   TEMP.GRP.QTY = ESTD.GRP.QTY<1,LPTR>
   TEMP.GRP.FCTR = ESTD.GRP.FCTR<1,LPTR>
   TEMP.GRP.QCALC = ESTD.GRP.QCALC<1,LPTR>
   TEMP.GRP.QPARAM = ESTD.GRP.QPARAM<1,LPTR>
   TEMP.GRP.QOR = ESTD.GRP.QOR<1,LPTR>
   TEMP.GRP.FCALC = ESTD.GRP.FCALC<1,LPTR>
   TEMP.GRP.FPARAM = ESTD.GRP.FPARAM<1,LPTR>
   TEMP.GRP.FOR = ESTD.GRP.FOR<1,LPTR>
   TEMP.GRP.QTY = TEMP.GRP.QTY / 100
   IF TEMP.GRP.QTY = INT(TEMP.GRP.QTY) THEN TEMP.GRP.QTY = INT(TEMP.GRP.QTY)
RETURN

*
*---- DISPLAY ROUTINE
*
90000
STATUS = RBO.setProperty('', 'ServerMessage', ERRMSG)
RETURN

*****************************************************************************************
************************************* SUBROUTINES ***************************************
*****************************************************************************************


*****************************************************************************************
* CALL EST.INSERT.STK
*****************************************************************************************
ESTCEM_INSERT_STK:

   LOCATE EQTY IN EST.QTY<1>,1 SETTING QP ELSE RETURN
*
*---- MAIN PROCESSING
*
   GRP.ID = TEMP.GRP.ID
   GRP.QTY = TEMP.GRP.QTY
   GRP.FCTR = TEMP.GRP.FCTR
   GRP.TYPE = TEMP.TYPE
   GRP.CCTR = TEMP.CCTR
   GRP.QCALC = TEMP.GRP.QCALC
   GRP.QPARAM = TEMP.GRP.QPARAM
   GRP.QOR = TEMP.GRP.QOR
   GRP.FCALC = TEMP.GRP.FCALC
   GRP.FPARAM = TEMP.GRP.FPARAM
   GRP.FOR = TEMP.GRP.FOR
*** CSF TEST DT 5/11/95 NEXT LINE ADDED
   GRP.GRP.CCTR = TEMP.GRP.CCTR
*** CSF TEST DT 5/11/95 END TEST
   WCNT = EST.PROD.WEB.CNT<1,COMP>+1
   IF WCNT = 0 THEN WCNT = 1
   FOR MPTR = 1 TO WCNT
      MATREAD ESTM.REC FROM ESTIMATE.MATL, CONO:EST.PROD.OS.TYPE<1,COMP>:EST.PROD.OS.USAGE<1,COMP,MPTR> ELSE GOTO 490
      MAT ESTD.TEMP = ""
      TEMP.GRP.ID = GRP.ID
      TEMP.GRP.QTY = GRP.QTY
      TEMP.GRP.FCTR = GRP.FCTR
      TEMP.TYPE = "M":EST.PROD.OS.TYPE<1,COMP>
      TEMP.CCTR = GRP.CCTR
      TEMP.GRP.QCALC = GRP.QCALC
      TEMP.GRP.QPARAM = GRP.QPARAM
      TEMP.GRP.QOR = GRP.QOR
      TEMP.GRP.FCALC = GRP.FCALC
      TEMP.GRP.FPARAM = GRP.FPARAM
      TEMP.GRP.FOR = GRP.FOR

*** CSF TEST DT 5/11/95 NEXT LINE ADDED
      TEMP.GRP.CCTR = GRP.GRP.CCTR
*** CSF TEST DT 5/11/95 END TEST
      TEMP.OPV = EST.PROD.OS.PROD<1,COMP,MPTR>
      LOCATE TEMP.OPV IN ESTM.PROD<1>,1 SETTING MT.PTR ELSE GOTO 490
*T25614  IF TEMP.GRP.QCALC = "" THEN
      TEMP.GRP.QCALC = ESTM.QCALC<1,MT.PTR>
      TEMP.GRP.QPARAM = ESTM.QPARAM<1,MT.PTR>
      TEMP.GRP.QOR = ESTM.QOR<1,MT.PTR>
*T25614  END
*T25614  IF TEMP.GRP.FCALC = "" THEN
      TEMP.GRP.FCALC = ESTM.FCALC<1,MT.PTR>
      TEMP.GRP.FPARAM = ESTM.FPARAM<1,MT.PTR>
      TEMP.GRP.FOR = ESTM.FOR<1,MT.PTR>
*T25614  END
      TEMP.MPTR = MPTR
      TEMP.FVAR1 = MT.PTR
      BEGIN CASE
         CASE TEMP.GRP.QCALC = ""
            TEMP.QTY = ""
         CASE TEMP.GRP.QCALC = "C"
            TEMP.QTY = TEMP.GRP.QPARAM
         CASE TEMP.GRP.QCALC = "F"
            TEMP.FPTR = REF.NO + 1
*           SUB.NAME = "EST.FORMULA.Q":TEMP.GRP.QPARAM
*  	     CALL @SUB.NAME (CONO, "", EQTY, DEPT, COMP)
*********
		VALUECONTENT = TEMP.GRP.QPARAM :"^": "A" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE  :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_Q
		STATUS = RBO.getProperty('', 'ESTDEPTINFO',ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
*		ESTDEPTINFO = ""
		PrePost = "PRE"
		FOR DC = 1 TO DCOUNT(RESULT_OF_FORMULA,"~")
			QTY_VALUE = FIELD(RESULT_OF_FORMULA,"~",DC)
			IF FIELD(QTY_VALUE,"=",1) = "TEMP.QTY" OR FIELD(QTY_VALUE,"=",1) = "TEMP." THEN
				PrePost = "POST"			    	
			END
		NEXT
		IF PrePost = "PRE" THEN
		   PROMPT_QUANTITY_FIELD := "Q":REF.NO:"&"
		END ELSE
		   PROMPT_QUANTITY_FIELD := "&"
		   GOSUB ASSIGN_VALUES
		END
*********
            IF TEMP.QTY = "" THEN
               TEMP.GRP.QOR = ""
            END
      END CASE
      BEGIN CASE
         CASE TEMP.GRP.FCALC = ""
            TEMP.FCTR = 1000
         CASE TEMP.GRP.FCALC = "C"
            TEMP.FCTR = INT(TEMP.GRP.FPARAM*1000+0.5)
         CASE TEMP.GRP.FCALC = "M"
            TEMP.FCTR = INT(GRP.FCTR*TEMP.GRP.FPARAM+0.5)
         CASE TEMP.GRP.FCALC = "F"
            TEMP.FPTR = REF.NO + 1
*            SUB.NAME = "EST.FORMULA.F":TEMP.GRP.FPARAM
*            CALL @SUB.NAME (CONO, "", EQTY, DEPT, COMP)
**********
		VALUECONTENT = TEMP.GRP.FPARAM :"^": "A" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE :"^": TEMP.STD :"^": TEMP.STD.TYPE :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_F
		STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
*		ESTDEPTINFO = ""
		PrePost = "PRE"
		FOR DC = 1 TO DCOUNT(RESULT_OF_FORMULA,"~")
			QTY_VALUE = FIELD(RESULT_OF_FORMULA,"~",DC)
			IF FIELD(QTY_VALUE,"=",1) = "TEMP.FCTR" OR FIELD(QTY_VALUE,"=",1) = "TEMP." THEN
				PrePost = "POST"			    	
			END
		NEXT
		IF PrePost = "PRE" THEN
		   PROMPT_FACTOR_FIELD := "F":REF.NO:"&"	
		END ELSE
		   PROMPT_FACTOR_FIELD := "&"	
		   GOSUB ASSIGN_VALUES
		END
**********
            IF TEMP.FCTR = "" THEN TEMP.GRP.FOR = ""
         CASE TEMP.GRP.FCALC = "T"
            TBL.ID = TEMP.GRP.FPARAM
*            CALL EST.TABLE.FCTR (CONO, TBL.ID, TEMP.GRP.FCTR)
	     CALL EST_TABLE_FCTR (CONO, TEMP.QTY, TBL.ID, TEMP.GRP.FCTR)

            IF TEMP.FCTR+0 = 0 THEN TEMP.FCTR = 1000
      END CASE
      TEMP.STD = FIELD(EST.PROD.PCST<1,COMP,MPTR>,"!",QP) / 100
      BEGIN CASE
         CASE TEMP.TYPE = "MS"
            TEMP.STD.TYPE = "$/M"
            TEMP.UM = 1000
         CASE 1
            TEMP.STD.TYPE = "$/CWT"
            TEMP.UM = 100
      END CASE
      TEMP.IND.1 = ESTM.FOH.PCT<1,MT.PTR>
      TEMP.MARKUP = ESTM.MARKUP<1,MT.PTR>
      TEMP.DESC = EST.PROD.OS.DESC<1,COMP,MPTR>
*
*      CALL ESTCEM_EVAL_COST(CONO,DEPT,ERRMG)

	EVAL_COST_PARAM = TEMP.TYPE :"^": TEMP.OPV.TYPE :"^": TEMP.QTY :"^": TEMP.FCTR :"^": TEMP.STD :"^": TEMP.UM :"^": TEMP.IND.1 :"^": TEMP.IND.2 :"^": TEMP.IND.3 :"^": TEMP.IND.4 :"^": TEMP.MARKUP
       STATUS = RBO.setProperty('','DREFCREF',EVAL_COST_PARAM)
       CALL ESTCEM_EVAL_COST(CONO,DPTR,ERRMG)
	STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
	TEMP.TSALE = FIELD(ESTDEPTINFO,"^",1)
	TEMP.HRS   = FIELD(ESTDEPTINFO,"^",2)  
	TEMP.DCOST = FIELD(ESTDEPTINFO,"^",3)
	TEMP.COST  = FIELD(ESTDEPTINFO,"^",4)
	TEMP.SALE  = FIELD(ESTDEPTINFO,"^",5)



*	TEMP.TSALE = ESTDEPTINFO
*	ESTDEPTINFO = ""
*T27716 ^
*
      REF.NO = REF.NO + 1
      FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
         ESTD.REC(A) = INSERT(ESTD.REC(A),1,REF.NO,0,ESTD.TEMP(A))
      NEXT A
      ESTD.QTY<1,REF.NO> = TEMP.QTY * 100
      ESTD.STD<1,REF.NO> = TEMP.STD * 100
      ESTD.GRP.QTY<1,REF.NO> = TEMP.GRP.QTY * 100
490 NEXT MPTR
RETURN

*****************************************************************************************
* ASSIGN_VALUES
*****************************************************************************************

ASSIGN_VALUES:
	FOR DC = 1 TO DCOUNT(RESULT_OF_FORMULA,"~")
		QTY_VALUE = FIELD(RESULT_OF_FORMULA,"~",DC)
		BEGIN CASE
	         CASE FIELD(QTY_VALUE,"=",1) = "TEMP.QTY"
			TEMP.QTY = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.FCTR"
			TEMP.FCTR = FIELD(QTY_VALUE,"=",2)
   		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.STD"
			TEMP.STD = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.CODE"
			TEMP.CODE = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.STD.TYPE"
			TEMP.STD.TYPE = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.TSALE"
			TEMP.TSALE = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.UM"
			TEMP.UM = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.IND.1"
			TEMP.IND.1 = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.IND.2"
			TEMP.IND.2 = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.IND.3"
			TEMP.IND.3 = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.IND.4"
			TEMP.IND.4 = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.MARKUP"
			TEMP.MARKUP = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.DESC"
			TEMP.DESC = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "TEMP.VSALE"
			TEMP.VSALE = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.RL.NO.PER.ROLL"
			EST.RL.NO.PER.ROLL = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.RL.NO.ROLLS"
			EST.RL.NO.ROLLS = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.RL.NO.CTNS"
			EST.RL.NO.CTNS = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.RL.NO.KGS"
			EST.RL.NO.KGS = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.RL.CALC.MAX.OD"
			EST.RL.CALC.MAX.OD = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.RL.CALC.ROLL.QTY"
			EST.RL.CALC.ROLL.QTY = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "PR.SPOIL.PC"
			PR.SPOIL.PC = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.DEPT.OSP"
			EST.DEPT.OSP = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.DEPT.OSP.ID"
			EST.DEPT.OSP.ID = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.DEPT.OSP.UM"
			EST.DEPT.OSP.UM = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.DEPT.OSP.QTY"
			EST.DEPT.OSP.QTY = FIELD(QTY_VALUE,"=",2)
		  CASE FIELD(QTY_VALUE,"=",1) = "EST.DEPT.OSP.PRICE"
			EST.DEPT.OSP.PRICE = FIELD(QTY_VALUE,"=",2)
		END CASE
	NEXT DC
	RESULT_OF_FORMULA = ""
RETURN

*****************************************************************************************
* CALL EST.INSERT.INK
*****************************************************************************************

ESTCEM_INSERT_INK:

   LOCATE EQTY IN EST.QTY<1>,1 SETTING QP ELSE RETURN
   MATREAD ESTM.REC FROM ESTIMATE.MATL, CONO:"I" ELSE RETURN
*
*---- MAIN PROCESSING
*
   GRP.ID = TEMP.GRP.ID
   GRP.QTY = TEMP.GRP.QTY
   GRP.FCTR = TEMP.GRP.FCTR
   GRP.TYPE = TEMP.TYPE
   GRP.CCTR = TEMP.CCTR
   GRP.QCALC = TEMP.GRP.QCALC
   GRP.QPARAM = TEMP.GRP.QPARAM
   GRP.QOR = TEMP.GRP.QOR
   GRP.FCALC = TEMP.GRP.FCALC
   GRP.FPARAM = TEMP.GRP.FPARAM
   GRP.FOR = TEMP.GRP.FOR
   GRP.GRP.CCTR = TEMP.GRP.CCTR
   WCNT = EST.PROD.WEB.CNT<1,COMP>+1
   IF WCNT = 0 THEN WCNT = 1

   PROMPT_QUANTITY_FIELD=""
   PROMPT_FACTOR_FIELD=""
   FOR MPTR = 1 TO WCNT
      ICNT = COUNT(EST.PROD.INK.ID<1,COMP,MPTR>,"!") + (EST.PROD.INK.ID<1,COMP,MPTR> # "")
      FOR IPTR = 1 TO ICNT
         MAT ESTD.TEMP = ""
         TEMP.GRP.ID = GRP.ID
         TEMP.GRP.QTY = GRP.QTY
         TEMP.GRP.FCTR = GRP.FCTR
         TEMP.TYPE = GRP.TYPE
         TEMP.CCTR = GRP.CCTR
         TEMP.GRP.QCALC = GRP.QCALC
         TEMP.GRP.QPARAM = GRP.QPARAM
         TEMP.GRP.QOR = GRP.QOR
         TEMP.GRP.FCALC = GRP.FCALC
         TEMP.GRP.FPARAM = GRP.FPARAM
         TEMP.GRP.FOR = GRP.FOR
         TEMP.GRP.CCTR = GRP.GRP.CCTR
         TEMP.OPV = FIELD(EST.PROD.INK.ID<1,COMP,MPTR>,"!",IPTR)
         LOCATE TEMP.OPV IN ESTM.PROD<1>,1 SETTING MT.PTR ELSE GOTO 3390
         IF TEMP.GRP.QCALC = "" THEN
            TEMP.GRP.QCALC = ESTM.QCALC<1,MT.PTR>
            TEMP.GRP.QPARAM = ESTM.QPARAM<1,MT.PTR>
            TEMP.GRP.QOR = ESTM.QOR<1,MT.PTR>
         END
         IF TEMP.GRP.FCALC = "" THEN
            TEMP.GRP.FCALC = ESTM.FCALC<1,MT.PTR>
            TEMP.GRP.FPARAM = ESTM.FPARAM<1,MT.PTR>
            TEMP.GRP.FOR = ESTM.FOR<1,MT.PTR>
         END
         TEMP.MPTR = MPTR
         TEMP.FVAR1 = IPTR
         TEMP.FVAR2 = MT.PTR
         BEGIN CASE
            CASE TEMP.GRP.QCALC = ""
               TEMP.QTY = ""
            CASE TEMP.GRP.QCALC = "C"
               TEMP.QTY = TEMP.GRP.QPARAM
            CASE TEMP.GRP.QCALC = "F"
               TEMP.FPTR = REF.NO + 1

*               SUB.NAME = "EST.FORMULA.Q":TEMP.GRP.QPARAM
*               CALL @SUB.NAME (CONO, "", EQTY, DEPT, COMP)
***************
* 		VALUECONTENT = SUB.ID :"^": ACTION :"^": EQTY :"^": DEPT :"^": COMP :"^": PreOrPost :"^": MODE1 :"^": ESTID :"^": TYPE	:"^": CCTR :"^": TEMP.OPV :"^":	REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE  :"^": WIDTH_VALUES
		VALUECONTENT = TEMP.GRP.QPARAM :"^": "A" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE  :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_Q
		STATUS = RBO.getProperty('', 'ESTDEPTINFO',ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
*		ESTDEPTINFO = ""
		   GOSUB ASSIGN_VALUES
****************
*              IF TEMP.QTY = 0 THEN GOTO 3390
               IF TEMP.QTY = "" THEN
                  TEMP.GRP.QOR = ""
               END
         END CASE
         BEGIN CASE
            CASE TEMP.GRP.FCALC = ""
               TEMP.FCTR = 1000
            CASE TEMP.GRP.FCALC = "C"
               TEMP.FCTR = INT(TEMP.GRP.FPARAM*1000+0.5)
            CASE TEMP.GRP.FCALC = "M"
               TEMP.FCTR = INT(GRP.FCTR*TEMP.GRP.FPARAM+0.5)
            CASE TEMP.GRP.FCALC = "F"
               TEMP.FPTR = REF.NO + 1
***********
*               SUB.NAME = "EST.FORMULA.F":TEMP.GRP.FPARAM
*               CALL @SUB.NAME (CONO, "", EQTY, DEPT, COMP)
*		SUB.ID :"^": ACTION :"^": EQTY :"^": DEPT :"^": COMP :"^": PreOrPost :"^": MODE1 :"^": ESTID :"^": TYPE	:"^": CCTR :"^": TEMP.OPV :"^":	REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE :"^": TEMP.STD :"^": TEMP.STD.TYPE :"^": WIDTH_VALUES
		VALUECONTENT = TEMP.GRP.FPARAM :"^": "A" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE :"^": TEMP.STD :"^": TEMP.STD.TYPE :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_F
		STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
		   GOSUB ASSIGN_VALUES
***********
*              IF TEMP.FCTR = 0 THEN GOTO 3390
               IF TEMP.FCTR = "" THEN TEMP.GRP.FOR = ""
            CASE TEMP.GRP.FCALC = "T"
               TBL.ID = TEMP.GRP.FPARAM
*               CALL EST.TABLE.FCTR (CONO, TBL.ID, TEMP.GRP.FCTR)
		  CALL EST_TABLE_FCTR (CONO, TEMP.QTY, TBL.ID, TEMP.GRP.FCTR)
               IF TEMP.FCTR+0 = 0 THEN TEMP.FCTR = 1000
         END CASE
*           C25275 v
         INK.COST = FIELD(EST.PROD.INK.UCOST<1,COMP,MPTR>,"!",IPTR)
         IF INK.COST = "" OR INK.COST = 0 THEN
            TEMP.STD = ESTM.COST<1,MT.PTR> / 100
         END ELSE
            TEMP.STD = INK.COST
         END
*           C25275
         TEMP.STD.TYPE = "$/":ESTM.UM<1,MT.PTR>
         TEMP.UM = ESTM.COST.UNIT<1,MT.PTR>
         TEMP.IND.1 = ESTM.FOH.PCT<1,MT.PTR>
         TEMP.MARKUP = ESTM.MARKUP<1,MT.PTR>
         TEMP.DESC = ESTM.FULL.DESC<1,MT.PTR>
	  SWAP '"' WITH "" IN TEMP.DESC
  	  SWAP "'" WITH "" IN TEMP.DESC
*
*        CALL ESTCEM_EVAL_COST(CONO,DEPT,ERRMG)
*	  EVAL_COST_PARAM = TEMP.TYPE :"^": TEMP.OPV.TYPE :"^": TEMP.QTY :"^": TEMP.FCTR :"^": TEMP.STD :"^": TEMP.UM :"^": TEMP.IND.1 :"^": TEMP.IND.2 :"^": TEMP.IND.3 :"^": TEMP.IND.4 :"^": TEMP.MARKUP

	  EVAL_COST_PARAM = TEMP.TYPE :"^": TEMP.OPV.TYPE :"^": TEMP.QTY :"^": TEMP.FCTR :"^": TEMP.STD :"^": TEMP.UM :"^": TEMP.IND.1 :"^": TEMP.IND.2 :"^": TEMP.IND.3 :"^": TEMP.IND.4 :"^": TEMP.MARKUP
         STATUS = RBO.setProperty('','DREFCREF',EVAL_COST_PARAM)
         CALL ESTCEM_EVAL_COST(CONO,DPTR,ERRMG)
	  STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
	  TEMP.TSALE = FIELD(ESTDEPTINFO,"^",1)
	  TEMP.HRS   = FIELD(ESTDEPTINFO,"^",2)  
	  TEMP.DCOST = FIELD(ESTDEPTINFO,"^",3)
	  TEMP.COST  = FIELD(ESTDEPTINFO,"^",4)
	  TEMP.SALE  = FIELD(ESTDEPTINFO,"^",5)

*	  TEMP.TSALE = ESTDEPTINFO
*	  ESTDEPTINFO = ""
*T27716 ^
*
         REF.NO = REF.NO + 1
         FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
            ESTD.REC(A) = INSERT(ESTD.REC(A),1,REF.NO,0,ESTD.TEMP(A))
         NEXT A
         ESTD.QTY<1,REF.NO> = TEMP.QTY * 100
         IF ESTD.STD # "" THEN
            ESTD.STD<1,REF.NO> = TEMP.STD * 100
         END
         ESTD.GRP.QTY<1,REF.NO> = TEMP.GRP.QTY * 100
3390   NEXT IPTR
   NEXT MPTR

RETURN
*****************************************************************************************
* CALL EST.INSERT.CASE
*****************************************************************************************

ESTCEM_INSERT_CASE:
   
   GRP.QTY = TEMP.GRP.QTY
   GRP.FCTR = TEMP.GRP.FCTR
   GRP.TYPE = TEMP.TYPE
   GRP.CCTR = TEMP.CCTR
   GRP.QCALC = TEMP.GRP.QCALC
   GRP.QPARAM = TEMP.GRP.QPARAM
   GRP.QOR = TEMP.GRP.QOR
   GRP.FCALC = TEMP.GRP.FCALC
   GRP.FPARAM = TEMP.GRP.FPARAM
   GRP.FOR = TEMP.GRP.FOR
   LOCATE EQTY IN EST.QTY<1>,1 SETTING QPTR ELSE RETURN
*T26306 v
   ECNT = DCOUNT(EST.QTY<1>,VM)
*T26306 ^
   MATREAD ESTM.REC FROM ESTIMATE.MATL, CONO:"C" ELSE RETURN
*
*---- MAIN PROCESSING
*
*
*---- PROCESS ENDLEAF DATA
*
111100*
   IF EST.CASE.ENDLF<1,1> # "" THEN
*T26306 v
      FOR E = 2 TO ECNT
         IF EST.CASE.ENDLF.PRICE<1,1,E> = '' THEN
            EST.CASE.ENDLF.PRICE<1,1,E> = EST.CASE.ENDLF.PRICE<1,1,1>
         END
      NEXT E
*T26306 ^
      MAT ESTD.TEMP = ""
      TEMP.GRP.ID = GRP.ID
      TEMP.GRP.QTY = GRP.QTY
      TEMP.GRP.FCTR = GRP.FCTR
      TEMP.TYPE = GRP.TYPE
      TEMP.CCTR = GRP.CCTR
      TEMP.GRP.QCALC = GRP.QCALC
      TEMP.GRP.QPARAM = GRP.QPARAM
      TEMP.GRP.QOR = GRP.QOR
      TEMP.GRP.FCALC = GRP.FCALC
      TEMP.GRP.FPARAM = GRP.FPARAM
      TEMP.GRP.FOR = GRP.FOR
      TEMP.OPV = EST.CASE.ENDLF<1,1>
      LOCATE TEMP.OPV IN ESTM.PROD<1>,1 SETTING CP ELSE GOTO 120
      TEMP.STD = EST.CASE.ENDLF.PRICE<1,1,QPTR> / 100
      TEMP.STD.TYPE = EST.CASE.ENDLF.PRICE<1,2>
      TEMP.UM = EST.CASE.ENDLF.PRICE<1,3>
      TEMP.DESC = EST.CASE.ENDLF<1,2>
      GOSUB 500
      GOSUB 1000
   END
*
*---- PROCESS BOARD DATA
*
120*
   IF EST.CASE.BOARD<1,1> # "" THEN
*T26306 v
      FOR E = 2 TO ECNT
         IF EST.CASE.BOARD.PRICE<1,1,E> = '' THEN
            EST.CASE.BOARD.PRICE<1,1,E> = EST.CASE.BOARD.PRICE<1,1,1>
         END
      NEXT E
*T26306 ^
      MAT ESTD.TEMP = ""
      TEMP.GRP.ID = GRP.ID
      TEMP.GRP.QTY = GRP.QTY
      TEMP.GRP.FCTR = GRP.FCTR
      TEMP.TYPE = GRP.TYPE
      TEMP.CCTR = GRP.CCTR
      TEMP.OPV = EST.CASE.BOARD<1,1>
      LOCATE TEMP.OPV IN ESTM.PROD<1>,1 SETTING CP ELSE GOTO 140
      TEMP.STD = EST.CASE.BOARD.PRICE<1,1,QPTR> / 100
      TEMP.STD.TYPE = EST.CASE.BOARD.PRICE<1,2>
      TEMP.UM = EST.CASE.BOARD.PRICE<1,3>
      TEMP.DESC = EST.CASE.BOARD<1,2>
      GOSUB 500
      GOSUB 1000
   END
*
*---- PROCESS SIDE CLOTH DATA
*
140*
   IF EST.CASE.SIDE.CL<1,1> # "" THEN
*T26306 v
      FOR E = 2 TO ECNT
         IF EST.CASE.SIDE.CL.PRICE<1,1,E> = '' THEN
            EST.CASE.SIDE.CL.PRICE<1,1,E> = EST.CASE.SIDE.CL.PRICE<1,1,1>
         END
      NEXT E
*T26306 ^
      MAT ESTD.TEMP = ""
      TEMP.GRP.ID = GRP.ID
      TEMP.GRP.QTY = GRP.QTY
      TEMP.GRP.FCTR = GRP.FCTR
      TEMP.TYPE = GRP.TYPE
      TEMP.CCTR = GRP.CCTR
      TEMP.OPV = EST.CASE.SIDE.CL<1,1>
      LOCATE TEMP.OPV IN ESTM.PROD<1>,1 SETTING CP ELSE GOTO 160
      TEMP.STD = EST.CASE.SIDE.CL.PRICE<1,1,QPTR> / 100
      TEMP.STD.TYPE = EST.CASE.SIDE.CL.PRICE<1,2>
      TEMP.UM = EST.CASE.SIDE.CL.PRICE<1,3>
      TEMP.DESC = EST.CASE.SIDE.CL<1,2>
      GOSUB 500
      GOSUB 1000
   END
*
*---- PROCESS SPINE CLOTH DATA
*
160*
   IF EST.CASE.SPINE.CL<1,1> # "" THEN
*T26306 v
      FOR E = 1 TO ECNT
         IF EST.CASE.SPINE.CL.PRICE<1,1,E> = '' THEN
            EST.CASE.SPINE.CL.PRICE<1,1,E> = EST.CASE.SPINE.CL.PRICE<1,1,1>
         END
      NEXT E
*T26306 ^
      MAT ESTD.TEMP = ""
      TEMP.GRP.ID = GRP.ID
      TEMP.GRP.QTY = GRP.QTY
      TEMP.GRP.FCTR = GRP.FCTR
      TEMP.TYPE = GRP.TYPE
      TEMP.CCTR = GRP.CCTR
      TEMP.OPV = EST.CASE.SPINE.CL<1,1>
      LOCATE TEMP.OPV IN ESTM.PROD<1>,1 SETTING CP ELSE GOTO 180
      TEMP.STD = EST.CASE.SPINE.CL.PRICE<1,1,QPTR> / 100
      TEMP.STD.TYPE = EST.CASE.SPINE.CL.PRICE<1,2>
      TEMP.UM = EST.CASE.SPINE.CL.PRICE<1,3>
      TEMP.DESC = EST.CASE.SPINE.CL<1,2>
      GOSUB 500
      GOSUB 1000
   END
*
*---- ALL DONE
*
180*
   GOTO 99999
*
*---- STORE DATA FROM MATERIAL FILE
*
500*
   IF TEMP.GRP.QCALC = "" THEN
      TEMP.GRP.QCALC = ESTM.QCALC<1,CP>
      TEMP.GRP.QPARAM = ESTM.QPARAM<1,CP>
      TEMP.GRP.QOR = ESTM.QOR<1,CP>
   END
   IF TEMP.GRP.FCALC = "" THEN
      TEMP.GRP.FCALC = ESTM.FCALC<1,CP>
      TEMP.GRP.FPARAM = ESTM.FPARAM<1,CP>
      TEMP.GRP.FOR = ESTM.FOR<1,CP>
   END
   BEGIN CASE
      CASE TEMP.GRP.QCALC = ""
         TEMP.QTY = ""
      CASE TEMP.GRP.QCALC = "C"
         TEMP.QTY = TEMP.GRP.QPARAM
      CASE TEMP.GRP.QCALC = "F"
         TEMP.FPTR = REF.NO + 1
*        SUB.NAME = "EST.FORMULA.Q":TEMP.GRP.QPARAM
*        CALL @SUB.NAME (CONO, "", EQTY, DEPT, COMP)
***********
		VALUECONTENT = TEMP.GRP.QPARAM :"^": "A" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE  :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_Q
		STATUS = RBO.getProperty('', 'ESTDEPTINFO',ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
*		ESTDEPTINFO = ""
		   GOSUB ASSIGN_VALUES
***********
        IF TEMP.QTY = "" THEN
            TEMP.GRP.QOR = ""
         END
   END CASE
   BEGIN CASE
      CASE TEMP.GRP.FCALC = ""
         TEMP.FCTR = 1000
      CASE TEMP.GRP.FCALC = "C"
         TEMP.FCTR = INT(TEMP.GRP.FPARAM*1000+0.5)
      CASE TEMP.GRP.FCALC = "M"
         TEMP.FCTR = INT(GRP.FCTR*TEMP.GRP.FPARAM+0.5)
      CASE TEMP.GRP.FCALC = "F"
         TEMP.FPTR = REF.NO + 1
*        SUB.NAME = "EST.FORMULA.F":TEMP.GRP.FPARAM
*        CALL @SUB.NAME (CONO, "", EQTY, DEPT, COMP)
**********
		VALUECONTENT = TEMP.GRP.FPARAM :"^": "A" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE :"^": TEMP.STD :"^": TEMP.STD.TYPE :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_F
		STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
*		ESTDEPTINFO = ""
		   GOSUB ASSIGN_VALUES
**********
         IF TEMP.FCTR = "" THEN TEMP.GRP.FOR = ""
      CASE TEMP.GRP.FCALC = "T"
         TBL.ID = TEMP.GRP.FPARAM
*        CALL EST.TABLE.FCTR (CONO, TBL.ID, TEMP.GRP.FCTR)
	  CALL EST_TABLE_FCTR (CONO, TEMP.QTY, TBL.ID, TEMP.GRP.FCTR)
         IF TEMP.FCTR+0 = 0 THEN TEMP.FCTR = 1000
   END CASE
   TEMP.IND.1 = ESTM.FOH.PCT<1,CP>
   TEMP.MARKUP = ESTM.MARKUP<1,CP>
   RETURN
*
*---- STORE LINE ITEM DATA
*
1000*
*  CALL ESTCEM_EVAL_COST(CONO,DEPT,ERRMG)

   EVAL_COST_PARAM = GRP.TYPE :"^": TEMP.OPV.TYPE :"^": TEMP.QTY :"^": TEMP.FCTR :"^": TEMP.STD :"^": TEMP.UM :"^": TEMP.IND.1 :"^": TEMP.IND.2 :"^": TEMP.IND.3 :"^": TEMP.IND.4 :"^": TEMP.MARKUP
   STATUS = RBO.setProperty('','DREFCREF',EVAL_COST_PARAM)
   CALL ESTCEM_EVAL_COST(CONO,DPTR,ERRMG)
   STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
   TEMP.TSALE = FIELD(ESTDEPTINFO,"^",1)
   TEMP.HRS   = FIELD(ESTDEPTINFO,"^",2)  
   TEMP.DCOST = FIELD(ESTDEPTINFO,"^",3)
   TEMP.COST  = FIELD(ESTDEPTINFO,"^",4)
   TEMP.SALE  = FIELD(ESTDEPTINFO,"^",5)


*   TEMP.TSALE = ESTDEPTINFO
*   ESTDEPTINFO = ""
   REF.NO = REF.NO + 1
   FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
      ESTD.REC(A) = INSERT(ESTD.REC(A),1,REF.NO,0,ESTD.TEMP(A))
   NEXT A
   ESTD.QTY<1,REF.NO>  = TEMP.QTY * 100
   ESTD.STD<1,REF.NO>  = TEMP.STD * 100
   ESTD.GRP.QTY<1,REF.NO> = TEMP.GRP.QTY * 100
   RETURN
*
*---- DISPLAY ROUTINE
*
99999*
RETURN
*****************************************************************************************
* CALL EST.INSERT.CUT
*****************************************************************************************
ESTCEM_INSERT_CUT:
   BCNT = COUNT(EST.BIND.CUT.CCTR,VM) + (EST.BIND.CUT.CCTR # "")
   TCNT = COUNT(TEMP2.TYPE,VM) + (TEMP2.TYPE # "")
*
*---- MAIN PROCESSING
*
*      FOR BPTR = 1 TO BCNT
   BPTR = COMP;* T20853
   CCTR = EST.BIND.CUT.CCTR<1,BPTR>
  MATREAD CCTR.REC FROM COST.CNTR, CONO:CCTR ELSE GOTO 33390
   FOR TDP = 1 TO TCNT
      MAT ESTD.TEMP = ""
      FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
         ESTD.TEMP(A) = ESTD.TEMP2(A)<1,TDP>
      NEXT A
      TEMP.CCTR = CCTR
      TEMP.CCTR.TYPE = CCTR.TYPE
      LOCATE TEMP.OPV IN CCTR.OPER<1>,1 SETTING OP.PTR ELSE GOTO 380
      TEMP.OPV.TYPE = CCTR.OPER.TYPE<1,OP.PTR>
      IF CCTR.OPER.STD.IMP<1,OP.PTR>+0=0 THEN TEMP.OPV.TYPE="F"
      MATREAD OPER.REC FROM OPERATION, CONO:TEMP.OPV ELSE
         MAT OPER.REC = ""
         OPER.DESC = "???????????????"
      END
      TEMP.DESC = OPER.DESC
      TEMP.GRP.CCTR = "CUT"
      IF TEMP.OPV.TYPE = "F" THEN
         TEMP.STD = CCTR.OPER.STD.HRS<1,OP.PTR> / 100
         TEMP.STD.TYPE = "HR/OP"
      END ELSE
         TEMP.STD = CCTR.OPER.STD.IMP<1,OP.PTR>
         TEMP.STD.TYPE = "OP/HR"
      END
      TEMP.HRS = ""
      TEMP.RATE = CCTR.OPER.HR.RATE<1,OP.PTR>
      TEMP.IND.1 = CCTR.FOH.TYPE<1,1>:CCTR.FOH.PCT<1,1>
      TEMP.IND.2 = CCTR.FOH.TYPE<1,2>:CCTR.FOH.PCT<1,2>
      TEMP.IND.3 = CCTR.FOH.TYPE<1,3>:CCTR.FOH.PCT<1,3>
      TEMP.IND.4 = CCTR.FOH.TYPE<1,4>:CCTR.FOH.PCT<1,4>
      TEMP.MARKUP = CCTR.OPER.MARKUP<1,OP.PTR>
      BEGIN CASE
         CASE TEMP.GRP.QCALC = ""
            TEMP.QTY = ""
         CASE TEMP.GRP.QCALC = "C"
            TEMP.QTY = TEMP.GRP.QPARAM
         CASE TEMP.GRP.QCALC = "F"
            TEMP.MPTR = BPTR
            TEMP.FPTR = REF.NO + 1
********************
*	    SUB.NAME = "EST.FORMULA.Q":TEMP.GRP.QPARAM
*            CALL @SUB.NAME (CONO, "", EQTY, DEPT, COMP)
	       VALUECONTENT = TEMP.GRP.QPARAM :"^": "A" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE  :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_Q
		STATUS = RBO.getProperty('', 'ESTDEPTINFO',ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
*		ESTDEPTINFO = ""
		   GOSUB ASSIGN_VALUES
********************
*              IF TEMP.QTY = 0 THEN GOTO 380
            IF TEMP.QTY = "" THEN
               TEMP.GRP.QOR = ""
            END
      END CASE
      BEGIN CASE
         CASE TEMP.GRP.FCALC = ""
            TEMP.FCTR = 1000
         CASE TEMP.GRP.FCALC = "C"
            TEMP.FCTR = INT(TEMP.GRP.FPARAM*1000+0.5)
         CASE TEMP.GRP.FCALC = "M"
            TEMP.FCTR = INT(TEMP.GRP.FCTR*TEMP.GRP.FPARAM+0.5)
         CASE TEMP.GRP.FCALC = "F"
            TEMP.MPTR = BPTR
            TEMP.FPTR = REF.NO + 1
********************
*            SUB.NAME = "EST.FORMULA.F":TEMP.GRP.FPARAM
*            CALL @SUB.NAME (CONO, "", EQTY, DEPT, COMP)

		VALUECONTENT = TEMP.GRP.FPARAM :"^": "A" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE :"^": TEMP.STD :"^": TEMP.STD.TYPE :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_F
		STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
*		ESTDEPTINFO = ""
		   GOSUB ASSIGN_VALUES
********************
*              IF TEMP.FCTR = 0 THEN GOTO 380
            IF TEMP.FCTR = "" THEN TEMP.GRP.FOR = ""
         CASE TEMP.GRP.FCALC = "T"
            TBL.ID = TEMP.GRP.FPARAM
********************
*	    CALL EST.TABLE.FCTR (CONO, TBL.ID, TEMP.GRP.FCTR)
            CALL EST_TABLE_FCTR (CONO, TEMP.QTY, TBL.ID, TEMP.GRP.FCTR)
********************
            IF TEMP.FCTR+0 = 0 THEN TEMP.FCTR = 1000
      END CASE
*
*T27716 v
*     CALL EST.CALC.COST (CONO)
********************    
*       CALL EST.CALC.COST (CONO,DEPT)

	CALC_COST_PARAM = DPTR:"^":TEMP.TYPE:"^":TEMP.OPV.TYPE:"^":TEMP.QTY:"^":TEMP.FCTR:"^":TEMP.STD:"^":TEMP.RATE:"^":TEMP.UM:"^":TEMP.IND.1:"^":TEMP.IND.2:"^":TEMP.IND.3:"^":TEMP.IND.4
        STATUS = RBO.setProperty('','DREFCREF',CALC_COST_PARAM)
        CALL EST_CALC_COST
	STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
	TEMP.TSALE = ESTDEPTINFO
*	ESTDEPTINFO = ""
********************
*T27716 ^
*
      REF.NO = REF.NO + 1
      FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
         ESTD.REC(A) = INSERT(ESTD.REC(A),1,REF.NO,0,ESTD.TEMP(A))
      NEXT A
      ESTD.QTY<1,REF.NO> = TEMP.QTY * 100
      ESTD.STD<1,REF.NO> = TEMP.STD * 100
      ESTD.GRP.QTY<1,REF.NO> = TEMP.GRP.QTY * 100
380 NEXT TDP
33390 *
*   NEXT BPTR
RETURN
*****************************************************************************************
* CALL EST.INSERT.FLD
*****************************************************************************************

ESTCEM_INSERT_FLD:
   BCNT = COUNT(EST.BIND.FOLD.CCTR,VM) + (EST.BIND.FOLD.CCTR # "")
   TCNT = COUNT(TEMP2.TYPE,VM) + (TEMP2.TYPE # "")
*
*---- MAIN PROCESSING
*
*      FOR BPTR = 1 TO BCNT
   BPTR = COMP;* T20853
   CCTR = EST.BIND.FOLD.CCTR<1,BPTR>
   IF CCTR = "WEB" THEN GOTO 333390
   IF CCTR = "PF"  THEN GOTO 333390
   MATREAD CCTR.REC FROM COST.CNTR, CONO:CCTR ELSE GOTO 333390
   FOR TDP = 1 TO TCNT
      MAT ESTD.TEMP = ""
      FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
         ESTD.TEMP(A) = ESTD.TEMP2(A)<1,TDP>
      NEXT A
      TEMP.CCTR = CCTR
      TEMP.CCTR.TYPE = CCTR.TYPE
      LOCATE TEMP.OPV IN CCTR.OPER<1>,1 SETTING OP.PTR ELSE GOTO 33380
      TEMP.OPV.TYPE = CCTR.OPER.TYPE<1,OP.PTR>
      IF CCTR.OPER.STD.IMP<1,OP.PTR>+0=0 THEN TEMP.OPV.TYPE="F"
      MATREAD OPER.REC FROM OPERATION, CONO:TEMP.OPV ELSE
         MAT OPER.REC = ""
         OPER.DESC = "???????????????"
      END
      TEMP.DESC = OPER.DESC
      TEMP.GRP.CCTR = "FLD"
      IF TEMP.OPV.TYPE = "F" THEN
         TEMP.STD = CCTR.OPER.STD.HRS<1,OP.PTR> / 100
         TEMP.STD.TYPE = "HR/OP"
      END ELSE
         TEMP.STD = CCTR.OPER.STD.IMP<1,OP.PTR>
         TEMP.STD.TYPE = "OP/HR"
      END
      TEMP.HRS = ""
      TEMP.RATE = CCTR.OPER.HR.RATE<1,OP.PTR>
      TEMP.IND.1 = CCTR.FOH.TYPE<1,1>:CCTR.FOH.PCT<1,1>
      TEMP.IND.2 = CCTR.FOH.TYPE<1,2>:CCTR.FOH.PCT<1,2>
      TEMP.IND.3 = CCTR.FOH.TYPE<1,3>:CCTR.FOH.PCT<1,3>
      TEMP.IND.4 = CCTR.FOH.TYPE<1,4>:CCTR.FOH.PCT<1,4>
      TEMP.MARKUP = CCTR.OPER.MARKUP<1,OP.PTR>
      BEGIN CASE
         CASE TEMP.GRP.QCALC = ""
            TEMP.QTY = ""
         CASE TEMP.GRP.QCALC = "C"
            TEMP.QTY = TEMP.GRP.QPARAM
         CASE TEMP.GRP.QCALC = "F"
            TEMP.MPTR = BPTR
            TEMP.FPTR = REF.NO + 1
********************            
*	    SUB.NAME = "EST.FORMULA.Q":TEMP.GRP.QPARAM
*            CALL @SUB.NAME (CONO, "", EQTY, DEPT, COMP)

	        VALUECONTENT = TEMP.GRP.QPARAM :"^": "A" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE  :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_Q
		STATUS = RBO.getProperty('', 'ESTDEPTINFO',ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
*		ESTDEPTINFO = ""
		   GOSUB ASSIGN_VALUES
********************

*              IF TEMP.QTY = 0 THEN GOTO 33380
            IF TEMP.QTY = "" THEN
               TEMP.GRP.QOR = ""
            END
      END CASE
      BEGIN CASE
         CASE TEMP.GRP.FCALC = ""
            TEMP.FCTR = 1000
         CASE TEMP.GRP.FCALC = "C"
            TEMP.FCTR = INT(TEMP.GRP.FPARAM*1000+0.5)
         CASE TEMP.GRP.FCALC = "M"
            TEMP.FCTR = INT(TEMP.GRP.FCTR*TEMP.GRP.FPARAM+0.5)
         CASE TEMP.GRP.FCALC = "F"
            TEMP.MPTR = BPTR
            TEMP.FPTR = REF.NO + 1
********************
*            SUB.NAME = "EST.FORMULA.F":TEMP.GRP.FPARAM
*            CALL @SUB.NAME (CONO, "", EQTY, DEPT, COMP)

		VALUECONTENT = TEMP.GRP.FPARAM :"^": "A" :"^": EQTY :"^": DPTR :"^": COMP :"^": "PRE" :"^": "A" :"^": EST.KEY :"^": TEMP.TYPE :"^": TEMP.CCTR :"^": TEMP.OPV :"^":REF.NO :"^": TEMP.QTY :"^": TEMP.GRP.QTY :"^": TEMP.CODE :"^": TEMP.STD :"^": TEMP.STD.TYPE :"^ "
		STATUS = RBO.setProperty('','DREFCREF',VALUECONTENT)
		CALL ESTCEM_EST_FORMULA_F
		STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
		RESULT_OF_FORMULA = ESTDEPTINFO
*		ESTDEPTINFO = ""
		   GOSUB ASSIGN_VALUES
********************
*              IF TEMP.FCTR = 0 THEN GOTO 33380
            IF TEMP.FCTR = "" THEN TEMP.GRP.FOR = ""
         CASE TEMP.GRP.FCALC = "T"
            TBL.ID = TEMP.GRP.FPARAM

*	    CALL EST.TABLE.FCTR (CONO, TBL.ID, TEMP.GRP.FCTR)
            CALL EST_TABLE_FCTR (CONO, TEMP.QTY, TBL.ID, TEMP.GRP.FCTR)
    
	    IF TEMP.FCTR+0 = 0 THEN TEMP.FCTR = 1000
      END CASE
*
*T27716 v
*     CALL EST.CALC.COST (CONO)
********************
*       CALL EST.CALC.COST (CONO,DEPT)
	CALC_COST_PARAM = DPTR:"^":TEMP.TYPE:"^":	TEMP.OPV.TYPE:"^":TEMP.QTY:"^":TEMP.FCTR:"^":TEMP.STD:"^":TEMP.RATE:"^":TEMP.UM:"^":TEMP.IND.1:"^":TEMP.IND.2:"^":TEMP.IND.3:"^":TEMP.IND.4
        STATUS = RBO.setProperty('','DREFCREF',CALC_COST_PARAM)
        CALL EST_CALC_COST
	STATUS = RBO.getProperty('', 'ESTDEPTINFO', ESTDEPTINFO)
	TEMP.TSALE = ESTDEPTINFO
*	ESTDEPTINFO = ""
********************

*T27716 ^
*
      REF.NO = REF.NO + 1
      FOR A = ESTD.FIRST.MV TO ESTD.LAST.MV
         ESTD.REC(A) = INSERT(ESTD.REC(A),1,REF.NO,0,ESTD.TEMP(A))
      NEXT A
      ESTD.QTY<1,REF.NO> = TEMP.QTY * 100
      ESTD.STD<1,REF.NO> = TEMP.STD * 100
      ESTD.GRP.QTY<1,REF.NO> = TEMP.GRP.QTY * 100
33380 NEXT TDP
333390 *
*   NEXT BPTR
* End of method code
RETURN


