SUBROUTINE VOUCHER_CREATION
********************************************************************************
*   Program name :- VOUCHER_CREATION
*   Created:- 2/2/2005
*   Program Written By :- Kauser Jahan 
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  DIV.CODE,CONO
*
* Out Properties:
* ---------------
* TYPE
 
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE APS.CPYLIB AUTO.VOUCHERS
$INCLUDE APS.CPYLIB TEMP.VOUCHERS
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE PMC.CPYLIB FISCAL
$INCLUDE PMC.CPYLIB GLTABLE
* Insert method code here
   DIM VOU.NOS(20)
   MAT VOU.NOS = ''
   DIM L.VOU(5)

   GEN.DIV='00' ;GEN.DEPT='00' ;GEN.CCTR='000'

STATUS = RBO.getProperty('','ID',DIV.CODE)
STATUS = RBO.getProperty('','Cono',CONO)

   OPEN 'COMPANY' TO COMPANY ELSE ERRMSG = 'COMPANY FILE MISSING'; GOTO 93000
   OPEN 'AUTO.VOUCHERS' TO AUTO.VOUCHERS ELSE ERRMSG = "AUTO.VOUCHERS FILE IS MISSING" ; GOTO 93000
   OPEN 'TEMP.VOUCHERS' TO TEMP.VOUCHERS ELSE ERRMSG = "TEMP.VOUCHERS FILE IS MISSING" ; GOTO 93000
   OPEN 'APS.SCREENS' TO M.SCREENS ELSE ERRMSG = "M.SCREENS FILE IS MISSING" ; GOTO 93000
   OPEN 'PREFIX' TO PREFIX ELSE ERRMSG = "PREFIX FILE IS MISSING" ; GOTO 93000
   OPEN 'CONTROL' TO CONTROL ELSE ERRMSG = 'CONTROL FILE MISSING'; GOTO 93000
   OPEN 'INV.XREF' TO INV.XREF ELSE ERRMSG = 'INV.XREF FILE MISSING'; GOTO 93000
   OPEN 'OAP' TO OAP ELSE ERRMSG = 'OAP FILE MISSING'; GOTO 93000
   OPEN 'SQV' TO SQV ELSE ERRMSG = 'SQV FILE MISSING'; GOTO 93000

NEXTST = ""
  IF DIV.CODE <> "ALL" THEN  
   NEXTST =   " AND WITH DIV.OWNER =" : DIV.CODE
  END
 CMD = " SSELECT AUTO.VOUCHERS BY DIV.OWNER WITH N.P.D >" : "0" : " AND WITH CONO = " : CONO : NEXTST
 UDTEXECUTE CMD

   READNEXT ID ELSE GOTO 91000
   CONO = ID[1,3]
   SEQ.ID = ID[4,99]

   MATREAD COMP.REC FROM COMPANY,CONO ELSE GOTO 93000
   READ PERIOD.REC FROM CONTROL, CONO:"ACCT.PERIODS" ELSE
      PERIOD.REC = 12
   END
   NUM.PERIODS = PERIOD.REC<1>

*
*---- ENTER FISCAL MONTH/PERIOD
10 *
   MATREAD FISCAL.REC FROM CONTROL,CONO:"APVFISCAL" ELSE
      ERRMSG = "APVFISCAL CONTROL RECORD IS MISSING"
      GOTO 93000
   END
   MATREAD GLTABLE.REC FROM CONTROL,CONO:"GLTABLE" ELSE
      ERRMSG = "GLTABLE CONTROL RECORD IS MISSING"
      GOTO 93000
   END

   READ DIVISION.REC FROM CONTROL, CONO:"DIVISIONS" ELSE
      ERRMSG = "DIVISIONS CONTROL RECORD IS MISSING"
       GOTO 93000
   END
   READ SECURITY.REC FROM CONTROL, CONO:"DIV.SECURITY" ELSE
      ERRMSG = "DIV.SECURITY CONTROL RECORD IS MISSING"
       GOTO 93000
   END
*
   IF SECURITY.REC<1> = "Y" AND SECURITY.REC<2> = "Y" THEN
      IF DIV.CODE = "00" OR DIV.CODE = "ALL" THEN
         ERRMSG = " 'ALL' OR '00' INVALID WHEN DIVISION-LEVEL POSTING & CLOSING IS SELECTED"
       GOTO 93000
      END
      LOCATE DIV.CODE IN DIVISION.REC<1>,1 SETTING POS ELSE
         ERRMSG = "Division ":DIV.CODE:" not found on Control File DIVISIONS Record"
       GOTO 93000
      END
   END ELSE
      POS = 1
   END
   YEAR = FR.CURR.PER[1,4]<1,POS>
   MON  = FR.CURR.PER[5,2]<1,POS>

   MON = STR("0",2-LEN(MON)):MON
   IF MON < 1 OR MON > NUM.PERIODS THEN
      ERRMSG = "ERROR IN CONTROL RECORD APVFISCAL"
       GOTO 93000 
  END
   READ DATES FROM CONTROL,CONO:"OPENDATES" ELSE
      ERRMSG = "SALESDATES RECORD IS MISSING"
       GOTO 93000 
  END

   READV FIS.YR FROM CONTROL, CONO:"FISCAL",1 ELSE
      ERRMSG="FISCAL CONTROL RECORD IS MISSING"
       GOTO 93000 
  END
   IF YEAR > FIS.YR[1,4] THEN
      YDIF = YEAR - FIS.YR[1,4]
      FOR Y = 1 TO NUM.PERIODS
         TMP = OCONV(DATES<Y>, 'D4/')
         TMP = TMP[1,6] : (TMP[7,4] + YDIF)
         DATES<Y> = ICONV(TMP, 'D')
      NEXT Y
   END

   PER.DATE = DATES<MON>
   PER.DATE = OCONV(PER.DATE,"D4/")
   C.MON = FIELD(PER.DATE,"/",1)
   C.YY = FIELD(PER.DATE,"/",3)
STATUS = RBO.setProperty('','TYPE',MON)
* End of method code
RETURN

91000 * 
ERRMSG = "There is no Data to Display"
GOTO 93000
RETURN

93000 *
STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
END


