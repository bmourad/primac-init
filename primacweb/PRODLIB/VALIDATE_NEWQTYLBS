SUBROUTINE VALIDATE_NEWQTYLBS
********************************************************************************
*   Program name :- VALIDATE_NEWQTYLBS
*   Created:- 6/2/2005
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
* T852  Redback TestTrack  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE ICS.CPYLIB INV.CNV
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB INV.WHSE.LOC

DEFFUN CALC_STK_QTY(COST.QTY,MAT INV.CNV.REC,LN,ROND)
DEFFUN CALC_COST_QTY(STK.QTY,MAT INV.CNV.REC,LN,ROND)

OPEN '','INVENTORY' TO INVENTORY ELSE ERRMSG = 'INVENTORY FILE IS MISSING'; ERR=1;GOTO 91000
OPEN '','INV.WHSE.LOC' TO INV.WHSE.LOC ELSE ERRMSG="INV.WHSE.LOC FILE IS MISSING";ERR=1;GOTO 91000

STATUS=RBO.getProperty('','CONO',CONO)
STATUS=RBO.getProperty('','TEMP',VALUE)
STATUS=RBO.getProperty('','WRK_SER_QTY',WRK_SER_QTY)
STATUS=RBO.getProperty('','IWH_ORG_FI',IWH.ORG.FI)
STATUS=RBO.getProperty('','IWH_RSV_FI',IWH.RSV.FI)
STATUS=RBO.getProperty('','WRK_SER_LOC',WRK_SER_LOC)
STATUS=RBO.getProperty('','RECVQTY',RECVQTY)
STATUS=RBO.getProperty('','ID',PROD)
STATUS=RBO.getProperty('','WHSE_NO',WHSE_NO)
STATUS=RBO.getProperty('','SAJ_QTY',SAJ.QTY)

MATREAD INV.REC FROM INVENTORY,CONO:PROD ELSE ERRMSG ="CANNOT READ INV.REC ON ":PROD ;ERR=1; GOTO 91000

$INCLUDE ICSBP INV.UM.CNV

*T852 WRK_SER_QTY=WRK_SER_QTY * 1000
 WRK_SER_QTY = ICONV(WRK_SER_QTY,ICR.CNV)	
 WRK_SER_QTY = CALC_COST_QTY(WRK_SER_QTY,MAT INV.CNV.REC,'','')
*T852 IWH.ORG.FI= IWH.ORG.FI* 1000
 IWH.ORG.FI = ICONV(IWH.ORG.FI,ICR.CNV)	
 IWH.ORG.FI = CALC_COST_QTY(IWH.ORG.FI,MAT INV.CNV.REC,'','')
*T852 IWH.RSV.FI=IWH.RSV.FI* 1000
 IWH.RSV.FI = ICONV(IWH.RSV.FI,ICR.CNV)	
 IWH.RSV.FI = CALC_COST_QTY(IWH.RSV.FI,MAT INV.CNV.REC,'','')
*T852 RECVQTY=RECVQTY*1000
 RECVQTY = ICONV(RECVQTY,ICR.CNV)	
 RECVQTY = CALC_COST_QTY(RECVQTY,MAT INV.CNV.REC,'','')
*T852 v
 VALUE = ICONV(VALUE,ICR.CNV)	
 VALUE = CALC_COST_QTY(VALUE,MAT INV.CNV.REC,'','')
*T852 ^
LOCONHAND=""
*SAJ.TOT.QTY=""
*STATUS=RBO.setProperty('','TEMPVAL',RECVQTY)

IF RECVQTY <> 0 THEN
 SAJ.TOT.QTY=RECVQTY
END ELSE
 SAJ.TOT.QTY=IWH.ORG.FI
END 

 MATREAD IWLO.REC FROM INV.WHSE.LOC,CONO:PROD:"!":WHSE_NO:"!":WRK_SER_LOC THEN
	LOCONHAND=IWLO.LOC.ON.HAND
 END

 STATUS=RBO.setProperty('','LOCONHAND',LOCONHAND)   

      IF VALUE >= WRK_SER_QTY THEN
        SAJ.QTY=VALUE
        EOI=1
      END ELSE
        IF SAJ.QTY="" THEN
          TEMP.QTY=SAJ.TOT.QTY-WRK_SER_QTY
          TEMP.QTY +=VALUE-IWH.ORG.FI + IWH.RSV.FI
        END ELSE
          TEMP.QTY=SAJ.TOT.QTY-SAJ.QTY
          TEMP.QTY +=(VALUE-IWH.ORG.FI+IWH.RSV.FI)
        END

	STATUS=RBO.setProperty('','TEMPVAL',TEMP.QTY)
     
        IF TEMP.QTY < 0 THEN
          DISP.QTY = IWH.ORG.FI - IWH.RSV.FI
          DISP.QTY=DISP.QTY/1000
          ERRMSG="Cannot adjust below used + reserved qty (":DISP.QTY:".00)"
          ERR=1;GOTO 91000 
        END
      END
       

RETURN

91000 
  STATUS = RBO.setProperty('','ServerStatus',ERR)        
  STATUS = RBO.setProperty('','ServerMessage',ERRMSG) 
RETURN




