SUBROUTINE VOUCHER_CREATION_CONTINUE
********************************************************************************
*   Program name :- VOUCHER_CREATION_CONTINUE
*   Created:- 2/2/2005
*   Written By :- Kauser Jahan
*------------------------------------------------------------------------------*
*
* In Properties:
* --------------
*  DIV.CODE,CONO
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE APS.CPYLIB AUTO.VOUCHERS
$INCLUDE APS.CPYLIB TEMP.VOUCHERS
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE PMC.CPYLIB FISCAL
$INCLUDE PMC.CPYLIB GLTABLE
* Insert method code here
   DIM VOU.NOS(20)
   MAT VOU.NOS = ''
   DIM L.VOU(5)

   GEN.DIV='00' ;GEN.DEPT='00' ;GEN.CCTR='000'

STATUS = RBO.getProperty('','ID',DIV.CODE)
STATUS = RBO.getProperty('','Cono',CONO)

   OPEN 'COMPANY' TO COMPANY ELSE ERRMSG = 'COMPANY FILE MISSING'; GOTO 93000
   OPEN 'AUTO.VOUCHERS' TO AUTO.VOUCHERS ELSE ERRMSG = "AUTO.VOUCHERS FILE IS MISSING" ; GOTO 93000
   OPEN 'TEMP.VOUCHERS' TO TEMP.VOUCHERS ELSE ERRMSG = "TEMP.VOUCHERS FILE IS MISSING" ; GOTO 93000
   OPEN 'APS.SCREENS' TO M.SCREENS ELSE ERRMSG = "M.SCREENS FILE IS MISSING" ; GOTO 93000
   OPEN 'PREFIX' TO PREFIX ELSE ERRMSG = "PREFIX FILE IS MISSING" ; GOTO 93000
   OPEN 'CONTROL' TO CONTROL ELSE ERRMSG = 'CONTROL FILE MISSING'; GOTO 93000
   OPEN 'INV.XREF' TO INV.XREF ELSE ERRMSG = 'INV.XREF FILE MISSING'; GOTO 93000
   OPEN 'OAP' TO OAP ELSE ERRMSG = 'OAP FILE MISSING'; GOTO 93000
   OPEN 'SQV' TO SQV ELSE ERRMSG = 'SQV FILE MISSING'; GOTO 93000

NEXTST = ""
  IF DIV.CODE <> "ALL" THEN  
   NEXTST =   " AND WITH DIV.OWNER =" : DIV.CODE
  END
 CMD = " SSELECT AUTO.VOUCHERS BY DIV.OWNER WITH N.P.D >" : "0" : " AND WITH CONO = " : CONO : NEXTST
 UDTEXECUTE CMD

   READNEXT ID ELSE GOTO 93000
   CONO = ID[1,3]
   SEQ.ID = ID[4,99]

   MATREAD COMP.REC FROM COMPANY,CONO ELSE GOTO 93000
   READ PERIOD.REC FROM CONTROL, CONO:"ACCT.PERIODS" ELSE
      PERIOD.REC = 12
   END
   NUM.PERIODS = PERIOD.REC<1>

*
*---- ENTER FISCAL MONTH/PERIOD
10 *
   MATREAD FISCAL.REC FROM CONTROL,CONO:"APVFISCAL" ELSE
      ERRMSG = "APVFISCAL CONTROL RECORD IS MISSING"
      GOTO 93000
   END
   MATREAD GLTABLE.REC FROM CONTROL,CONO:"GLTABLE" ELSE
      ERRMSG = "GLTABLE CONTROL RECORD IS MISSING"
      GOTO 93000
   END

   READ DIVISION.REC FROM CONTROL, CONO:"DIVISIONS" ELSE
      ERRMSG = "DIVISIONS CONTROL RECORD IS MISSING"
       GOTO 93000
   END
   READ SECURITY.REC FROM CONTROL, CONO:"DIV.SECURITY" ELSE
      ERRMSG = "DIV.SECURITY CONTROL RECORD IS MISSING"
       GOTO 93000
   END
*
   IF SECURITY.REC<1> = "Y" AND SECURITY.REC<2> = "Y" THEN
      IF DIV.CODE = "00" OR DIV.CODE = "ALL" THEN
         ERRMSG = " 'ALL' OR '00' INVALID WHEN DIVISION-LEVEL POSTING & CLOSING IS SELECTED"
       GOTO 93000
      END
      LOCATE DIV.CODE IN DIVISION.REC<1>,1 SETTING POS ELSE
         ERRMSG = "Division ":DIV.CODE:" not found on Control File DIVISIONS Record"
       GOTO 93000
      END
   END ELSE
      POS = 1
   END
   YEAR = FR.CURR.PER[1,4]<1,POS>
   MON  = FR.CURR.PER[5,2]<1,POS>

   MON = STR("0",2-LEN(MON)):MON
   IF MON < 1 OR MON > NUM.PERIODS THEN
      ERRMSG = "ERROR IN CONTROL RECORD APVFISCAL"
       GOTO 93000 
  END
   READ DATES FROM CONTROL,CONO:"OPENDATES" ELSE
      ERRMSG = "SALESDATES RECORD IS MISSING"
       GOTO 93000 
  END

   READV FIS.YR FROM CONTROL, CONO:"FISCAL",1 ELSE
      ERRMSG="FISCAL CONTROL RECORD IS MISSING"
       GOTO 93000 
  END
   IF YEAR > FIS.YR[1,4] THEN
      YDIF = YEAR - FIS.YR[1,4]
      FOR Y = 1 TO NUM.PERIODS
         TMP = OCONV(DATES<Y>, 'D4/')
         TMP = TMP[1,6] : (TMP[7,4] + YDIF)
         DATES<Y> = ICONV(TMP, 'D')
      NEXT Y
   END
STATUS = RBO.setProperty('','Cono',CONO)
   PER.DATE = DATES<MON>
   PER.DATE = OCONV(PER.DATE,"D4/")
   C.MON = FIELD(PER.DATE,"/",1)
   C.YY = FIELD(PER.DATE,"/",3)
********************************************************

   LOOP
      READNEXT ID ELSE DATA = 0
      CONO = ID[1,3]
      SEQ.ID = ID[4,99]
   WHILE DATA DO
      GOSUB 1000
   REPEAT
   GOTO 93000
1000 MATREADU AVO.REC FROM AUTO.VOUCHERS,ID ELSE
      RELEASE AUTO.VOUCHERS,ID ; GOTO 1999
   END
   IF AVO.ST.PER # MON AND AVO.MON = "" THEN GOTO 1999
   IF MON = AVO.MON THEN GOTO 1999
   MAT TVO.REC = ""
   TVO.VEND = AVO.VEND

   TVO.DIV.OWNER = AVO.DIV.OWNER

   TVO.INV = AVO.INV
   INV.DATE = OCONV(AVO.INV.DATE,"D2/")
   MM = C.MON ;DD = INV.DATE[4,2] ;YY = C.YY
   LOOP

      INV.DATE=STR('0',2-LEN(MM)):MM:"/":STR('0',2-LEN(DD)):DD:"/":STR('0',4-LEN(YY)):YY
      TVO.INV.DATE = ICONV(INV.DATE,"D4/")

   WHILE TVO.INV.DATE = "" DO
      DD = DD - 1
      IF DD < 1 THEN
         DD = 31
         MM = MM - 1
         IF MM < 1 THEN
            YY = YY - 1
            MM = 12
         END
      END
   REPEAT

   DATE.INV = OCONV(TVO.INV.DATE,"D4/")
   MM = DATE.INV[1,2] ; DD = DATE.INV[4,2] ; YY = DATE.INV[7,4]

   TRM.DAYS = AVO.TERMS<1,2>
   DISC = AVO.TERMS<1,1>
   IF TRM.DAYS[1,1] = 'P' THEN
      DD = TRM.DAYS[2,2]
      IF DD > CO.PROX.CUTOFF THEN
         NMM = MM + 2
      END ELSE
         NMM = MM + 1
      END
      IF NMM > 12 THEN
         NMM = NMM - 12
         YY = YY + 1
      END
      LOOP

         DUE.DATE=STR('0',2-LEN(NMM)):NMM:"/":STR('0',2-LEN(DD)):DD:"/":STR("0",4-LEN(YY)):YY
         TVO.DUE.DATE = ICONV(DUE.DATE,"D4/")

      WHILE TVO.DUE.DATE = "" DO
         DD = DD - 1
         IF DD < 1 THEN
            DD = 31
            NMM = NMM - 1
            IF NMM < 1 THEN
               YY = YY - 1
               NMM = 12
            END
         END
      REPEAT
   END ELSE
      TVO.DUE.DATE = TVO.INV.DATE + (DISC[5,2]*1)
   END
   TVO.GRS.AMT = AVO.GRS.AMT
   TVO.MER.AMT = AVO.MER.AMT
   TVO.DSC.AMT = AVO.DSC.AMT
   TVO.CTR = AVO.CTR
   TVO.ACCT = AVO.ACCT
   TVO.DIST.AMT = AVO.DIST.AMT
   TVO.ASSET.ID = AVO.ASSET.ID
   TVO.DIV = AVO.DIV
   TVO.DEPT = AVO.DEPT
   TVO.CCTR = AVO.CCTR

   TVO.MON = FR.CURR.PER<1,POS>
   TVO.TERMS = AVO.TERMS
   TVO.PO = AVO.PO
   TVO.REM.COMM = AVO.REM.COMM
   TVO.A.C.FLG = SEQ.ID
   TVO.AP.ACCT = GLTB.AP       
   TVO.AP.AMT = (0 - AVO.GRS.AMT)       

   TVO.AP.DIV = AVO.AP.DIV
   TVO.AP.DEPT = AVO.AP.DEPT
   TVO.AP.CCTR = AVO.AP.CCTR

     
   MATREADU VOU.NOS FROM CONTROL,CONO:"VOUNUMBERS" ELSE
      MAT VOU.NOS = 0
   END
   LOOP
      FND = 1
      TFND = 1
      VOU.NOS(MON) = VOU.NOS(MON) + 1
      IF VOU.NOS(MON) > 9999 THEN VOU.NOS(MON) = 1
      V.CODE = STR('0',2-LEN(MON)):MON:STR('0',4-LEN(VOU.NOS(MON))):VOU.NOS(MON)
      READU O.RECORD FROM TEMP.VOUCHERS, CONO : V.CODE ELSE TFND = 0
      READ O.RECORD FROM OAP, CONO:V.CODE ELSE
         READ O.RECORD FROM SQV, CONO:V.CODE ELSE
            FND = 0
         END
      END
   WHILE FND OR TFND DO
      RELEASE TEMP.VOUCHERS, CONO : V.CODE
   REPEAT

   MATWRITE VOU.NOS ON CONTROL,CONO:"VOUNUMBERS"
   IF AVO.INV # "" THEN
      L.VOU(1) = V.CODE
      MATWRITE L.VOU ON INV.XREF,CONO:STR('0',10-LEN(AVO.INV)):AVO.INV:AVO.VEND
   END
   IF AVO.N.P.P + 1 > AVO.N.O.P THEN
      TVO.STATUS = "AUTOMATIC VOUCHER NUMBER (":ID[4,99]:") HAS BEEN PAID IN FULL"
   END
   IF AVO.N.P.P + 1 = AVO.N.O.P THEN
      TVO.STATUS = "THIS IS THE LAST PAYMENT ON AUTOMATIC VOUCHER (":ID[4,99]:")"
   END
   IF AVO.N.P.P < AVO.N.O.P THEN
      AVO.N.P.P = AVO.N.P.P + 1
   END
   MATWRITE TVO.REC ON TEMP.VOUCHERS,CONO:V.CODE
   AVO.MON = MON
   MATWRITE AVO.REC ON AUTO.VOUCHERS,ID
1999 RETURN
   WRITEV "Y" ON CONTROL,CONO:"VOUCHER.CREATION",1

* End of method code
RETURN

93000 *
STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
END


