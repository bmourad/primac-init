SUBROUTINE JOBM_CHECK_PROD_WHSE
********************************************************************************
*   Program name :- JOBM_CHECK_PROD_WHSE
*   Created:- 7/22/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JES.CPYLIB ESTIMATE
$INCLUDE JES.CPYLIB ESTIMATE.RES
$INCLUDE JES.CPYLIB ESTIMATE.JOB
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB CATEGORY
$INCLUDE JCS.CPYLIB JOB
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE ICS.CPYLIB WAREHOUSE
$INCLUDE ICS.CPYLIB INV_RECP_WHSE
$INCLUDE CPYLIB CHAR
* Insert method code here
ERRMSG = ""
OPEN '','ESTIMATE' TO F.EST ELSE
	ERRMSG = "UNABLE TO OPEN FILE!"
	GOTO 99999
END

OPEN "","ESTIMATE.RES" TO ESTIMATE.RES ELSE
      ERRMSG = "CANNOT OPEN ESTIMATE.RES FILE"
      GOTO 99999
END

OPEN "","ESTIMATE.JOB" TO ESTIMATE.JOB ELSE
      	ERRMSG = "CANNOT OPEN ESTIMATE.JOB FILE"
	GOTO 99999
END

OPEN "","INVENTORY" TO INVENTORY ELSE
	ERRMSG = "INVENTORY"
	GOTO 99999
END

OPEN "","CATEGORY" TO CATEGORY ELSE
	ERRMSG = "CATEGORY"
	GOTO 99999
END
OPEN "","JOB" TO JOB ELSE
	ERRMSG = "CANNOT OPEN JOB FILE"
       GOTO 99999
END
OPEN "","INV.WHSE" TO INV.WHSE ELSE
	ERRMSG = "INV.WHSE"
	GOTO 99999
END
OPEN "","WAREHOUSE" TO WAREHOUSE ELSE
	ERRMSG = "CANNOT OPEN WAREHOUSE FILE"
      	GOTO 99999
END
OPEN "","INV_RECP_WHSE" TO INV_RECP_WHSE ELSE
	ERRMSG = "CANNOT OPEN INV_RECP_WHSE FILE"
      	GOTO 99999
END

VAL = RBO.getProperty('','Cono',CONO)
VAL = RBO.getProperty('','JOB_NO',JOBNO)
VAL = RBO.getProperty('','JOB_EST',EST.NO)
VAL = RBO.getProperty('','EST_PAR',EST.PAR)
VAL = RBO.getProperty('','ESTAT',ESTAT) ;* 0 - VALUE

EST.PAR = RAISE(EST.PAR)
CMATCH = 0

EQU EST.PAR.QTY    TO EST.PAR<1>
EQU EST.PAR.COMP   TO EST.PAR<2>
EQU EST.PAR.DEPT   TO EST.PAR<3>
EQU EST.PAR.UPDM   TO EST.PAR<4>
EQU EST.PAR.MATL   TO EST.PAR<5>

MATREAD EST.REC FROM F.EST,CONO:EST.NO ELSE MAT EST.REC = ""

MATREAD EST.RL.REC FROM ESTIMATE.RES, CONO:EST.NO THEN
	ROLL.LABEL = 'Y'
END ELSE
	ROLL.LABEL = ''
END
MATREAD JOB.REC FROM JOB,CONO:JOBNO ELSE MAT JOB.REC = ""

MATREAD ESTJ.REC FROM ESTIMATE.JOB, CONO:JOBNO THEN
	LOCATE ESTJ.QTY IN EST.QTY<1>,1 SETTING QP ELSE QP = 0
      	GOT.ESTJ = 'Y'
END ELSE
	LOCATE EST.PAR.QTY IN EST.QTY<1>,1 SETTING QP ELSE QP = 0
	GOT.ESTJ = ''
END
IF GOT.ESTJ THEN
	IF ESTJ.COMP = "ALL" THEN
      		COMP.CNT =EST.COMPONENT.CNT
      	END ELSE
      		COMP.CNT = DCOUNT(ESTJ.COMP<1,1>,SVM)
      	END
END ELSE
	IF EST.PAR.COMP = "ALL" THEN
     		COMP.CNT =EST.COMPONENT.CNT
	END ELSE
		COMP.CNT = DCOUNT(EST.PAR.COMP,VM)
	END
END

PROD.LIST = ""
PROD.QTY = ""
FOR CP = 1 TO COMP.CNT
	IF GOT.ESTJ THEN
       	IF ESTJ.COMP = "ALL" THEN COMP = CP ELSE COMP = ESTJ.COMP<1,1,CP>
      	END ELSE
       	IF EST.PAR.COMP = "ALL" THEN COMP = CP ELSE COMP = EST.PAR.COMP<1,CP>
      	END
      	WEB.CNT = COUNT(EST.PROD.OS.PROD<1,COMP>,SM) + 1
      	FOR WB = 1 TO WEB.CNT
       	IF EST.PROD.INV.ID<1,COMP,WB> # "" THEN
       		PROD = EST.PROD.INV.ID<1,COMP,WB>
       		IF ROLL.LABEL THEN
            			QTY = FIELD(EST.RL.PAP.MSI<1,COMP,WB>,"!",QP)
            			WIDTH = EST.PROD.OS.WIDTH<1,COMP,WB>
             			GOSUB 70000
       		END ELSE
            			QTY = FIELD(EST.PROD.PQTY<1,COMP,WB>,"!",QP)
       		END
       		LOCATE PROD IN PROD.LIST<1>,1 SETTING X ELSE NULL
       		PROD.LIST<1,X> = PROD
       	     	PROD.QTY<1,X> = PROD.QTY<1,X> + QTY 
	      	END
      	NEXT WB
NEXT CP

IF ROLL.LABEL THEN
END

PROD.CNT = COUNT(PROD.LIST,VM) + (PROD.LIST # "")

RET.PROD.LIST = ""
RET.WHSE.LIST = ""
RET.DEF.WHSE = ""
CV = 1
FOR I = 1 TO PROD.CNT
	MATREAD INV.REC FROM INVENTORY,CONO:PROD.LIST<1,I> ELSE MAT INV.REC = ''
      	GOSUB 80000
      	IF CASE1.FLAG THEN PROD.QTY<1,I> = PROD.QTY<1,I> * 100
      	MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE ELSE MAT CATG.REC = ''
      	MLOC = 0     ;*C33301
      	IF INDEX(JOB.RESV.MATL,PROD.LIST<1,I>,1) = 1 THEN
       	LOCATE PROD.LIST<1,I> IN JOB.RESV.MATL<1>,1 SETTING MLOC THEN
       		WHSE = JOB.RESV.WHSE<1,MLOC>
         	END ELSE MLOC = 0
      	END
	IF NOT(MLOC) THEN
		WCNT = DCOUNT(INV.WHSE.CODE,VM)
       	DVCNT=0;WPTR=0
       	GNCNT=0;GPTR=0
       	HMSG='Warehouse - '
       	GMSG=''
		VALDAT = ""
		FOR W = 1 TO WCNT
			MATREAD WHSE.REC FROM WAREHOUSE,CONO:INV.WHSE.CODE<1,W> THEN
       			IF WHS.DIV = JOB.DIV THEN
              			DVCNT += 1
               			IF WPTR = 0 THEN WPTR = W
               			HMSG=HMSG:INV.WHSE.CODE<1,W>:', '
	               		VALDAT=VALDAT:INV.WHSE.CODE<1,W>:SVM
       	     		END
            			IF WHS.DIV = '00' THEN
               			GMSG=GMSG:INV.WHSE.CODE<1,W>:', '
               			VALDAT=VALDAT:INV.WHSE.CODE<1,W>:SVM
               			GNCNT += 1
               			IF GPTR = 0 THEN GPTR = W
	            		END
       	  	END
      		NEXT W
         	IF GMSG # '' THEN HMSG=HMSG:GMSG
         	IF HMSG[LEN(HMSG)-1,2]=', ' THEN HMSG=HMSG[1,LEN(HMSG)-2]
         	IF VALDAT[LEN(VALDAT),1]=VM THEN VALDAT=VALDAT[1,LEN(VALDAT)-1]
         	BEGIN CASE
            		CASE DVCNT = 1
              		WHSE = INV.WHSE.CODE<1,WPTR>
            		CASE GNCNT = 1 AND DVCNT = 0
              		WHSE = INV.WHSE.CODE<1,GPTR>
            		CASE 1
				DISP.PROD = PROD.LIST<1,I>
				RET.PROD.LIST<1,CV> = DISP.PROD
				RET.WHSE.LIST<1,CV> = VALDAT
				IF WPTR THEN RET.DEF.WHSE<1,CV> = INV.WHSE.CODE<1,WPTR> ELSE IF GPTR THEN RET.DEF.WHSE<1,CV> = INV.WHSE.CODE<1,GPTR>
				CV += 1
              		*GOSUB 85000
              		*IF ESTAT THEN GOTO 99001
         	END CASE
      	END
NEXT I	


******************SET PROPERTIES HERE***************************
VAL = RBO.setProperty('','RET_PROD_LIST',RET.PROD.LIST)
VAL = RBO.setProperty('','RET_WHSE_LIST',RET.WHSE.LIST)
VAL = RBO.setProperty('','RET_DEF_WHSE',RET.DEF.WHSE)
RETURN
****************************************************************



*---- CONVERT ROLL LABEL MSI TO STOCKING UNIT
*
70000 *
MATREAD INV.REC FROM INVENTORY,CONO:PROD ELSE MAT INV.REC = ''
GOSUB 80000
NQTY = QTY
***************   NEED TO USE EST WIDTH FROM PROD DEF SCREEN   ***************
*
BEGIN CASE
	CASE INV.UNIT<1,2> = "MSI"
      	CASE INV.UNIT<1,2> = "FT"
       	IF WIDTH + 0 # 0 THEN
            		NQTY = (NQTY * 1000) / (12 * OCONV(WIDTH,"MD4"))
         	END ELSE
            		NQTY = 0
         	END
      	CASE INV.UNIT<1,2> = "PC"
       	IF WIDTH + 0 # 0 THEN
            		NQTY = (NQTY * 1000) / (10 * OCONV(WIDTH,"MD4"))
         	END ELSE
            		NQTY = 0
         	END
END CASE
QTY = NQTY
RETURN


80000 *
CASE1.FLAG = ""
	BEGIN CASE
      		CASE INV.UNIT<1,2> = 'SHT' AND INV.UNIT<1,3> = 'LBS'
         		ICR.DV1 = INV.M.WT
         		ICR.MT1 = 1
         		ICR.DV2 = 1
         		ICR.CNV = "MD0"
      		CASE INV.UNIT<1,2> = 'PC' AND INV.UNIT<1,3> = 'MSI'
         		ICR.DV1 = INV.PAP.WIDTH/100
         		ICR.MT1 = 10
         		ICR.DV2 = 1
        		ICR.CNV = "MD0"
      		CASE INV.UNIT<1,2> = 'FT' AND INV.UNIT<1,3> = 'MSI'
         		ICR.DV1 = INV.PAP.WIDTH/100
         		ICR.MT1 = 100
         		ICR.DV2 = 12
         		ICR.CNV = "MD0"
      		CASE 1
         		ICR.DV1 = 10
         		ICR.MT1 = 1
         		ICR.DV2 = 1
         		ICR.CNV = "MD2"
         		CASE1.FLAG = "Y"
   	END CASE
RETURN

*****************
GET.UNIT.PR: 
*****************
*
   MATREAD IWH.REC FROM INV.WHSE,IWH.ID ELSE  MAT IWH.REC=''
   BEGIN CASE
      CASE CO.JES.PARAM<1,11> = 'R'
         DIV.POS='';FISCAL.FLAG='JC';TRAN.PERIOD=''
         ERR.FLG='';ERRMSG=''
         CALL GET.LAST.COST (IWH.ID,MAT IWH.REC,WAREHOUSE,CONTROL,ERR.FLG,ERRMSG,DIV.POS,FISCAL.FLAG,TRAN.PERIOD,LAST.PRICE)
         IF ERR.FLG='' THEN
            UNIT.PR=LAST.PRICE
         END ELSE
            UNIT.PR = 0
         END
      CASE CO.JES.PARAM<1,11> = 'S'
         UNIT.PR = IWH.STD.COST
      CASE CO.JES.PARAM<1,11> = 'A'
         UNIT.PR = IWH.AVG.COST
      CASE CO.JES.PARAM<1,11> = 'L'
         UNIT.PR = IWH.LIST.COST
      CASE 1
         UNIT.PR = 0
   END CASE
   RETURN

99001 *
   ESTAT = 1 ;* RETURN VALUE
   GOTO 99999


99999
  IF (TRIM(ERRMSG) # "") THEN
       STATUS = RBO.setProperty('','ServerStatus','1')
       STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
  END ELSE
       STATUS = RBO.setProperty('','ServerStatus','')
       STATUS = RBO.setProperty('','ServerMessage','')
  END 
END
