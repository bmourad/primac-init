SUBROUTINE PNCN_QUERY
********************************************************************************
*   Program name :- PNCN_QUERY
*   Created:- 6/1/2007
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE ARS.CPYLIB MANUAL.INVOICE
$INCLUDE JCS.CPYLIB DAILY.INVOICE
$INCLUDE CPYLIB CHAR

* Insert method code here
  ERRMSG =""
     OPEN "","CONTROL" TO CONTROL ELSE ERRMSG="ERROR IN OPENING CONTROL FILE" ; GOTO 93000
     OPEN "","DAILY.MANUAL.INVOICE" TO DAILY.MANUAL.INVOICE ELSE
         ERRMSG="DAILY.MANUAL.INVOICE FILE MISSING";GOTO 93000
     END
     OPEN "","DAILY.INVOICE" TO DAILY.INVOICE ELSE
         ERRMSG="INVOICE FILE MISSING"; GOTO 93000
     END

  STATUS = RBO.getProperty('','ID',CMDQRY)
*ADDED BY YAKUB
STR = ""
  CONO=FIELD(CMDQRY,"$",1)
  STRINV=FIELD(CMDQRY,"$",2)
  ENDINV=FIELD(CMDQRY,"$",3)
  DIV = FIELD(CMDQRY,"$",4)
  MODULE = FIELD(CMDQRY,"$",5)
STR<1>="CMDQRY IS ":CMDQRY; WRITE STR ON CONTROL,"145" 
  BEGIN CASE
      CASE MODULE = "JCS" 
	    GOSUB 200
      CASE MODULE = "JCSCM"	   
	    GOSUB 300
      CASE MODULE = "ARS"
	    GOSUB 400
  END CASE 
STR<-1>="QUERY IS ":CMD ; WRITE STR ON CONTROL,"145" 
    UDTEXECUTE CMD CAPTURING MSG

STR<-1>="MSG IS ":MSG ; WRITE STR ON CONTROL,"145"  
       ID.COUNT = 0
	DATA = 1
	IDS.FOUND = 0
	LOOP
	WHILE DATA DO 
	    READNEXT DI.KEY ELSE DATA = 0 
STR<-1>="DI.KEY  ":DI.KEY ; WRITE STR ON CONTROL,"145"  
          IF DI.KEY # "" THEN
            BEGIN CASE
              CASE MODULE = "JCS" OR MODULE = "JCSCM"
        	     MATREAD DI.REC FROM DAILY.INVOICE,DI.KEY ELSE
                       CONTINUE
	            END
                   ID.COUNT = ID.COUNT + 1
	            IF DI.PRT.FLG<1,1> = "Y" THEN
	                IDS.FOUND = 1
 	            END
              CASE MODULE = "ARS"
		     MATREAD MIV.REC FROM DAILY.MANUAL.INVOICE,DI.KEY ELSE
                    CONTINUE
     	            END
                   ID.COUNT = ID.COUNT + 1
		  STR<-1>="DI.PRT.FLG ":DI.PRT.FLG ; WRITE STR ON CONTROL,"145"  
	            IF MIV.PRT.FLG<1,1> = "Y" THEN
	               IDS.FOUND = 1
 	            END
            END CASE
          END
	REPEAT
STR<-1>="IN 555 ID.COUNT ":ID.COUNT ; WRITE STR ON CONTROL,"145" 
STATUS = RBO.setProperty('','MESG',IDS.FOUND)
  IF ID.COUNT = 0 THEN
     ERRMSG = "No data retrieved from current (S)SELECT statement." 
STR<-1>="ERRMSG ":ERRMSG ; WRITE STR ON CONTROL,"145"  
     GOTO 93000 
  END
RETURN
200 *
	CMD = "SSELECT DAILY.INVOICE BY TRANS WITH TRANS.FLG # 'CM' AND WITH TRANS.FLG # 'DM' AND WITH CONO = '":CONO:"' AND WITH DI_LIST_DATE"
	IF DIV # 'ALL' THEN	CMD = CMD :" AND WITH DI.DIV = '":DIV:"'"
       IF STRINV # 'ALL' THEN 
           CMD = CMD:" AND WITH TRANS >= '":STRINV:"'"
           IF ENDINV # 'ALL' THEN CMD = CMD:" AND WITH TRANS <= '":ENDINV:"'"
       END
RETURN
300 *   
       CMD = "SSELECT DAILY.INVOICE BY TRANS WITH TRANS.FLG = 'CM' AND WITH CONO = '":CONO:"' AND WITH DI_LIST_DATE"
	IF DIV # 'ALL' THEN CMD = CMD:" AND WITH DI.DIV = '":DIV:"'"
	IF STRINV # 'ALL' THEN 
          CMD = CMD:" AND WITH TRANS >= '":STRINV:"'"
          IF ENDINV # 'ALL' THEN CMD = CMD:" AND WITH TRANS <= '":ENDINV:"'"	
       END
RETURN
400 * 
       CMD = "SSELECT DAILY.MANUAL.INVOICE BY DM_DIV BY TRANS.0 WITH CONO = '":CONO:"'"
	IF STRINV # 'ALL' THEN 
          CMD = CMD:" AND WITH TRANS.0 >= '":STRINV:"'"
	   IF ENDINV # 'ALL' THEN CMD = CMD:" AND WITH TRANS.0 <= '":ENDINV:"'"	
       END
	IF DIV # 'ALL' THEN	CMD = CMD:" AND WITH DM_DIV = '":DIV:"'"
RETURN


93000 *
    STATUS = RBO.setProperty('','ServerStatus',1)
    STATUS = RBO.setProperty('','ServerMessage',ERRMSG)

