SUBROUTINE ESTRLM_NEW_QUANTITIES
********************************************************************************
*   Program name :- ESTRLM_NEW_QUANTITIES
*   Created:- 6/13/2006
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JES.CPYLIB SCOMMON.ESTIMATE
$DEFINE ESTIMATE
$INCLUDE JES.CPYLIB ESTIMATE
$DEFINE ESTIMATERES
$INCLUDE JES.CPYLIB ESTIMATE.RES
$DEFINE ESTIMATEDEPT
$INCLUDE JES.CPYLIB ESTIMATE.DEPT
$DEFINE ESTIMATETEMP
$INCLUDE JES.CPYLIB ESTIMATE.TEMP
$INCLUDE JES.CPYLIB ESTIMATE.TEMP2
$DEFINE ESTIMATEMATL
$INCLUDE JES.CPYLIB ESTIMATE.MATL
$INCLUDE PMC.CPYLIB COST.CNTR
$INCLUDE CPYLIB CHAR

OPEN "ESTIMATE" TO ESTIMATE ELSE ERRMSG="CANNOT OPEN ESTIMATE FILE";GOTO 90000
OPEN "ESTIMATE.DEPT" TO ESTIMATE.DEPT ELSE ERRMSG="CANNOT OPEN ESTIMATE.DEPT FILE";GOTO 90000
OPEN "ESTIMATE.MATL" TO ESTIMATE.MATL ELSE ERRMSG="CANNOT OPEN ESTIMATE.MATL FILE";GOTO 90000
OPEN "ESTIMATE.BIND.SPOIL" TO ESTIMATE.BIND.SPOIL ELSE ERRMSG="CANNOT OPEN ESTIMATE.BIND.SPOIL FILE";GOTO 90000
OPEN "ESTIMATE.PRESS.SPOIL" TO ESTIMATE.PRESS.SPOIL ELSE ERRMSG="CANNOT OPEN ESTIMATE.PRESS.SPOIL FILE";GOTO 90000
OPEN  'COST.CNTR' TO COST.CNTR ELSE ERRMSG="CANNOT OPEN COST.CNTR FILE";GOTO 90000
OPEN 'CONTROL' TO CONTROL ELSE ERRMSG="CANNOT OPEN CONTROL FILE";GOTO 90000



* Insert method code here
STATUS = RBO.getProperty('','ID',ID)
STATUS = RBO.getProperty('','EST_QTY',EST_QTY)
STATUS = RBO.getProperty('','DEL_NO',DEL.NO)
STATUS = RBO.getProperty('','NEW_REC',NEW.REC)

EST.RECALC.FLAG = 0
ACTION = "A"
CONO = ID[1,3]
EST.KEY = ID[4,99]


      MATREAD EST.REC FROM ESTIMATE,ID ELSE
              MAT EST.REC=""
		ERRMSG = 'Cannot open ESTIMATE file!':ID
      END
EST.QTY = EST_QTY
*IF NEW.REC <> 0 THEN 
*   EST.BASE.QTY = ""
*END ELSE
*   EST.BASE.QTY = EST.QTY<1,1>
*END

*IF EST.QTY#PREV.QTY THEN

      CALL EST_CALC_STK_PRICE(CONO,"")
*     CALL EST.RES.CALC.PAP(CONO,"")
      CALL EST_RES_CALC_PAP(CONO,"",DEL.NO)
      DEL.NO = ""
*T26413 ^
   IF NOT(NEW.REC) THEN EST.RECALC.FLAG=1
*END

   IF EST.BASE.QTY#"" AND EST.QTY<1,1>#EST.BASE.QTY THEN
         GOSUB 24000
   END
   STATUS = RBO.setProperty('','EST_RECALC_FLAG',EST.RECALC.FLAG)
   STATUS = RBO.setProperty('','EST_DEPT_COMP',EST.DEPT.COMP)
* End of method code
   
RETURN

90000*
	STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
	STATUS = RBO.setProperty('','ServerStatus',1)
RETURN


24000*
   EST.RECALC.FLAG=""
   NEW.BASE.QTY=EST.QTY<1,1>
   SAVE.DEPT.COMP=EST.DEPT.COMP
   EST.DEPT.COMP=""
   EST.DEPT.COMP.HRS=""
   EST.DEPT.COMP.DCOST=""
   EST.DEPT.COMP.COST=""
   EST.DEPT.COMP.SALE=""
   EST.DEPT.COMP.TSALE=""
   DC=COUNT(SAVE.DEPT.COMP,VM)+(SAVE.DEPT.COMP#"")
   FOR DP=1 TO DC
      ESTD.ID=SAVE.DEPT.COMP<1,DP>
      EQTY=FIELD(ESTD.ID,"!",3)
      IF EQTY=EST.BASE.QTY THEN
         DPTR=FIELD(ESTD.ID,"!",1)
         CPTR=FIELD(ESTD.ID,"!",2)
*         CALL EST.RES.QTY.CALC (CONO,"E",EST.KEY,DPTR,CPTR,NEW.BASE.QTY)
          CALL EST_RES_QTY_CALC(CONO,"E",EST.KEY,DPTR,CPTR,NEW.BASE.QTY)
      END
   NEXT DP
   EST.BASE.QTY=NEW.BASE.QTY
   FOR DP=1 TO DC
      ESTD.ID=SAVE.DEPT.COMP<1,DP>
      EQTY=FIELD(ESTD.ID,"!",3)
      LOCATE EQTY IN EST.QTY<1>,1 SETTING FOUND ELSE FOUND=0
      BEGIN CASE
         CASE EQTY=EST.BASE.QTY
            NULL
         CASE FOUND  > 0
            DPTR=FIELD(ESTD.ID,"!",1)
            CPTR=FIELD(ESTD.ID,"!",2)
*            CALL EST.RES.QTY.CALC (CONO,"E",EST.KEY,DPTR,CPTR,EQTY)
             CALL EST_RES_QTY_CALC (CONO,"E",EST.KEY,DPTR,CPTR,EQTY)
         CASE FOUND=0
            DELETE ESTIMATE.DEPT,CONO:EST.KEY:"!":ESTD.ID
      END CASE
   NEXT DP
RETURN


