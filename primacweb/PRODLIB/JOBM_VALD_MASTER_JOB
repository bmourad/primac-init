SUBROUTINE JOBM_VALD_MASTER_JOB
********************************************************************************
*   Program name :- JOBM_VALD_MASTER_JOB
*   Created:- 7/23/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  CONO,JOB_NO,JOB_EST,JOB_MASTER
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JCS.CPYLIB JOB
$INCLUDE JES.CPYLIB ESTIMATE
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE CPYLIB CHAR
* Insert method code here

ERRMSG = ""
* Insert method code here
OPEN '','ESTIMATE' TO F.EST ELSE
	ERRMSG = "UNABLE TO OPEN FILE!"
	GOTO 99999
END
OPEN '','COMPANY' TO COMPANY ELSE
	ERRMSG = "UNABLE TO OPEN FILE!"
	GOTO 99999
END

OPEN "","JOB" TO JOB ELSE
	ERRMSG = "CANNOT OPEN JOB FILE"
       GOTO 99999
END

DIM SAVE.JOB(JOB.REC.SIZE)

VAL = RBO.getProperty('','Cono',CONO)
VAL = RBO.getProperty('','JOB_NO',JOBNO)
MATREAD JOB.REC FROM JOB,CONO:JOBNO ELSE MAT JOB.REC = ""

VAL = RBO.getProperty('','JOB_MASTER',JOB_MASTER)

**added by zubair to check the master job with customer , job belongs to the customer
VAL = RBO.getProperty('','JOB_CUSTOMER',JOB.CUSTOMER)
**end
IF JOB_MASTER = 0 THEN JOB_MASTER = ""

JOB.MASTER = JOB_MASTER

DIM OLD.JOB.REC(JOB.REC.SIZE)

MAT OLD.JOB.REC = MAT JOB.REC

MATREAD JOB.REC FROM JOB,CONO:JOB.MASTER ELSE 
	ERRMSG = "INVALID JOBNO."
	GOTO 99999
END

MASTER.CUST = JOB.CUST

* THE BELOW LINE IS COMMENTED BY ZUBAIR . IF NEW ENTRY AND MASTER JOB IT IS NOT ALLOWING
* the below line sets job.rec arrays to "" since OLD.JOB.REC DOESNOT HAVE DATA, SO AGAIN CHECKING WITH JOB.REC . HOW?
*MAT JOB.REC = MAT OLD.JOB.REC


MATREAD COMP.REC FROM COMPANY,CONO ELSE MAT COMP.REC = ""

VAL = RBO.getProperty('','JOB_EST',JOB.EST)
IF JOB.EST = 0 THEN JOB.EST = ""

MATREAD EST.REC FROM F.EST,CONO:JOB.EST ELSE MAT EST.REC = ""

IF JOB_MASTER = JOBNO THEN
	IF JOB.EST # "" AND CO.JES = "Y" THEN
       	EJ.CNT = DCOUNT(EST.BOOK.JOB,VM)
        	OTHER.JOBS = 0
        	FOR J = 1 TO EJ.CNT UNTIL OTHER.JOBS
          		IF JOBNO # EST.BOOK.JOB<1,J> THEN OTHER.JOBS = 1
        	NEXT J
        	IF OTHER.JOBS THEN
          		IF JOB_MASTER # EST.JOB AND EST.JOB # "" THEN
            			ERRMSG = "Estimate belongs to Master Job ":EST.JOB:"."
            			GOTO 99999
          		END
        	END
      END
      JOB.MASTER = JOBNO
END ELSE
	IF JOB.EST # "" AND CO.JES = "Y" THEN
       	IF JOB_MASTER # EST.JOB AND EST.JOB # "" THEN
          		IF EST.JOB # JOBNO THEN
            			ERRMSG = "Estimate has a different Master Job number."
            			GOTO 99999
            		END
        	END
      	END

	IF JOB.MASTER = "" THEN
        	MASTER.JOB = JOB_MASTER
      	END ELSE
        	MASTER.JOB = JOB.MASTER
      	END

*STATUS = RBO.setProperty('','ServerMessage','JOB.CUST - ' : JOB.CUST : '--MASTER.CUST --' : MASTER.CUST)
*RETURN

       IF JOB.CUST # MASTER.CUST THEN
        	ERRMSG = "CUSTOMER MISMATCH, MASTER JOB CUSTOMER - ":MASTER.CUST
        	GOTO 99999
      	END

***ADDED BY ZUBAIR  FOR MASTER JOB, IT HAS CHECK THE CUSTOMER , JOB FOR THE CUSTOMER, IF MISMATCH ERROR
	IF JOB.CUSTOMER # MASTER.CUST THEN
        	ERRMSG = "CUSTOMER MISMATCH, MASTER JOB CUSTOMER - ":MASTER.CUST
        	GOTO 99999
      	END
*****END OF ADDITION


      	IF MASTER.JOB # JOB_MASTER THEN
        	ERRMSG = "MASTER JOB CANNOT BE A SUB JOB"
        	GOTO 99999
      END
      JOB.MASTER = JOB_MASTER
END


*STATUS = RBO.setProperty('','JOB_MASTER',JOB.MASTER)

99999
  IF (TRIM(ERRMSG) # "") THEN
       STATUS = RBO.setProperty('','ServerStatus','1')
       STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
  END ELSE
       STATUS = RBO.setProperty('','ServerStatus','')
       STATUS = RBO.setProperty('','ServerMessage','')
  END 
END
