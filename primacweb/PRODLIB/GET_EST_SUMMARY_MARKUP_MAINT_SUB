   SUBROUTINE GET_EST_SUMMARY_MARKUP_MAINT_SUB(ERRMSG,IN_PARAM,OUT_PARAM,MAT FILE.VARS,MAT JES.FILE.VARS,MAT EST.REC)
*********************************************************************
*
* REVISION - [12.0]
*
* PROGRAM  - GET.EST.COST.TYPE.SUM.SUB
*
* AUTHOR   - CHRIS MYKLEBUST, PRIMAC SYSTEMS
*
* DATE     - 10/02/2002
*
* DESCRIPTION
*
* This program gets the data from the ESTIMATE.DEPT file to load into the
* Estimate Cost/Type Summary screen.
*
*********************************************************************
*
*---- FILE COPY STATEMENTS
*
   $INCLUDE WWINSERT RBO.H
   $INCLUDE JES.CPYLIB JES.FILE.VARS
   $INCLUDE CPYLIB FILE.VARS
   $INCLUDE JES.CPYLIB ESTIMATE
   $INCLUDE JES.CPYLIB ESTIMATE.DEPT
   $INCLUDE JES.CPYLIB EST.COST.TYPE.SUM
   $INCLUDE CPYLIB CHAR
*
   DIM SAVE.CSUM.REC(40)
   EQU SAVE.LB.HRS           TO SAVE.CSUM.REC(2)    ;* Labor hours
   EQU SAVE.LB.DCOST         TO SAVE.CSUM.REC(3)    ;* Labor direct cost
   EQU SAVE.LB.COST          TO SAVE.CSUM.REC(4)    ;* Labor total cost
   EQU SAVE.LB.SALE          TO SAVE.CSUM.REC(5)    ;* Labor sale
   EQU SAVE.MT.DCOST         TO SAVE.CSUM.REC(6)    ;* Material direct cost
   EQU SAVE.MT.COST          TO SAVE.CSUM.REC(7)    ;* Material total cost
   EQU SAVE.MT.SALE          TO SAVE.CSUM.REC(8)    ;* Material sale
   EQU SAVE.OS.DCOST         TO SAVE.CSUM.REC(9)    ;* O/P direct cost
   EQU SAVE.OS.COST          TO SAVE.CSUM.REC(10)   ;* O/P total cost
   EQU SAVE.OS.SALE          TO SAVE.CSUM.REC(11)   ;* O/P sale
   EQU SAVE.SP.DCOST         TO SAVE.CSUM.REC(12)   ;* Shipping direct cost
   EQU SAVE.SP.COST          TO SAVE.CSUM.REC(13)   ;* Shipping total cost
   EQU SAVE.SP.SALE          TO SAVE.CSUM.REC(14)   ;* Shipping sale
   EQU SAVE.MS.DCOST         TO SAVE.CSUM.REC(15)   ;* Misc direct cost
   EQU SAVE.MS.COST          TO SAVE.CSUM.REC(16)   ;* Misc total cost
   EQU SAVE.MS.SALE          TO SAVE.CSUM.REC(17)   ;* Misc sale
   EQU SAVE.TOT.DCOST        TO SAVE.CSUM.REC(18)   ;* Total direct cost
   EQU SAVE.TOT.COST         TO SAVE.CSUM.REC(19)   ;* Total cost
   EQU SAVE.TOT.SALE         TO SAVE.CSUM.REC(20)   ;* Total sale
   EQU SAVE.MT.DCOST.DET     TO SAVE.CSUM.REC(21)   ;* (MV1) Material direct cost detail
*                                                   ;* 1 = paper
*                                                   ;* 2 = ink
*                                                   ;* 3 = film
*                                                   ;* 4 = plates
*                                                   ;* 5 = other
   EQU SAVE.MT.COST.DET      TO SAVE.CSUM.REC(22)   ;* (MV1) Material total cost detail
   EQU SAVE.MT.SALE.DET      TO SAVE.CSUM.REC(23)   ;* (MV1) Material sale detail
*
*---- INITIALIZATION
*
   CONO = IN_PARAM<1>
   EST.ID = IN_PARAM<2>
   DSEL = IN_PARAM<3>
   CSEL = IN_PARAM<4>
   QSEL = IN_PARAM<5>
   ESTIMATE.ID = CONO:EST.ID
   MAT SAVE.CSUM.REC = ""
*
*---- PROCESSING
*
   QCNT = DCOUNT(EST.QTY,VM)
   FOR QPTR = 1 TO QCNT
      QSEL = EST.QTY<1,QPTR>
      MAT CSUM.REC = ""
      CALC.LB.PCT.SALE<1,QPTR> = ''
      CALC.MT.PCT.SALE<1,QPTR> = ''
      CALC.OS.PCT.SALE<1,QPTR> = ''
      CALC.SP.PCT.SALE<1,QPTR> = ''
      CALC.MS.PCT.SALE<1,QPTR> = ''
      CALC.TOT.PCT.SALE<1,QPTR> = ''
      DCNT = DCOUNT(EST.DEPT.COMP,VM)
      FOR DP = 1 TO DCNT
         ESTD.ID = EST.DEPT.COMP<1,DP>
         IF DSEL # "ALL" AND DSEL # EST.DEPT<1,FIELD(ESTD.ID,"!",1)> THEN GOTO 190
         IF CSEL # "ALL" AND CSEL # FIELD(ESTD.ID,"!",2) THEN GOTO 190
         IF QSEL # FIELD(ESTD.ID,"!",3) THEN GOTO 190
         MATREAD ESTD.REC FROM ESTIMATE.DEPT, CONO:EST.ID:"!":ESTD.ID ELSE GOTO 190
         TCNT = DCOUNT(ESTD.TYPE,VM)
         FOR TP = 1 TO TCNT
            TYPE = ESTD.TYPE<1,TP>[1,1]
            IF TYPE = "G" THEN GOTO 180
            TSUB = ESTD.TYPE<1,TP>[2,1]
            HRS = ESTD.HRS<1,TP>
            DCOST = ESTD.DCOST<1,TP>
            COST = ESTD.COST<1,TP>
            SALE = ESTD.TSALE<1,TP>
            BEGIN CASE
               CASE TYPE = "L"
                  CSUM.LB.HRS = CSUM.LB.HRS + HRS
                  CSUM.LB.DCOST = CSUM.LB.DCOST + DCOST
                  CSUM.LB.COST = CSUM.LB.COST + COST
                  CSUM.LB.SALE = CSUM.LB.SALE + SALE
               CASE TYPE = "M" OR TYPE = "I"
                  CSUM.MT.DCOST = CSUM.MT.DCOST + DCOST
                  CSUM.MT.COST = CSUM.MT.COST + COST
                  CSUM.MT.SALE = CSUM.MT.SALE + SALE
                  BEGIN CASE
                     CASE TSUB = "S" OR TSUB = "R" OR TSUB = "L"
                        DET = 1
                     CASE TSUB = "I"
                        DET = 2
                     CASE TSUB = "F"
                        DET = 3
                     CASE TSUB = "P"
                        DET = 4
                     CASE TSUB = "C"
                        DET = 5
                     CASE 1
                        DET = 6
                  END CASE
                  CSUM.MT.DCOST.DET<1,DET> = CSUM.MT.DCOST.DET<1,DET> + DCOST
                  CSUM.MT.COST.DET<1,DET> = CSUM.MT.COST.DET<1,DET> + COST
                  CSUM.MT.SALE.DET<1,DET> = CSUM.MT.SALE.DET<1,DET> + SALE
               CASE TYPE = "P"
                  CSUM.OS.DCOST = CSUM.OS.DCOST + DCOST
                  CSUM.OS.COST = CSUM.OS.COST + COST
                  CSUM.OS.SALE = CSUM.OS.SALE + SALE
               CASE TYPE = "S"
                  CSUM.SP.DCOST = CSUM.SP.DCOST + DCOST
                  CSUM.SP.COST = CSUM.SP.COST + COST
                  CSUM.SP.SALE = CSUM.SP.SALE + SALE
               CASE TYPE = "O"
                  CSUM.MS.DCOST = CSUM.MS.DCOST + DCOST
                  CSUM.MS.COST = CSUM.MS.COST + COST
                  CSUM.MS.SALE = CSUM.MS.SALE + SALE
            END CASE
            CSUM.TOT.DCOST = CSUM.TOT.DCOST + DCOST
            CSUM.TOT.COST = CSUM.TOT.COST + COST
            CSUM.TOT.SALE = CSUM.TOT.SALE + SALE
180      NEXT TP
190   NEXT DP
      IF CSUM.MT.SALE # '' THEN
         CALC.MT.PCT.SALE<1,QPTR> = CSUM.MT.SALE / CSUM.TOT.SALE
      END
      IF CSUM.OS.SALE # '' THEN
         CALC.OS.PCT.SALE<1,QPTR> = CSUM.OS.SALE / CSUM.TOT.SALE
      END
      IF CSUM.SP.SALE # '' THEN
         CALC.SP.PCT.SALE<1,QPTR> = CSUM.SP.SALE / CSUM.TOT.SALE
      END
      IF CSUM.MS.SALE # '' THEN
         CALC.MS.PCT.SALE<1,QPTR> = CSUM.MS.SALE / CSUM.TOT.SALE
      END
      CALC.TOT.PCT.SALE<1,QPTR> = ICONV(CALC.TOT.PCT.SALE<1,QPTR>,"MD4")
      CALC.LB.PCT.SALE<1,QPTR> = ICONV(CALC.LB.PCT.SALE<1,QPTR>,"MD4")
      CALC.MS.PCT.SALE<1,QPTR> = ICONV(CALC.MS.PCT.SALE<1,QPTR>,"MD4")
      CALC.SP.PCT.SALE<1,QPTR> = ICONV(CALC.SP.PCT.SALE<1,QPTR>,"MD4")
      CALC.OS.PCT.SALE<1,QPTR> = ICONV(CALC.OS.PCT.SALE<1,QPTR>,"MD4")
      CALC.MT.PCT.SALE<1,QPTR> = ICONV(CALC.MT.PCT.SALE<1,QPTR>,"MD4")
      SAVE.LB.SALE<1,QPTR> = CSUM.LB.SALE
      SAVE.MT.SALE<1,QPTR> = CSUM.MT.SALE
      SAVE.OS.SALE<1,QPTR> = CSUM.OS.SALE
      SAVE.SP.SALE<1,QPTR> = CSUM.SP.SALE
      SAVE.MS.SALE<1,QPTR> = CSUM.MS.SALE
      TOTAL.SALE<1,QPTR> = CSUM.TOT.SALE
200 NEXT QPTR
*
*---- BUILD RBO RECORD
*
   STATUS = RBO.setProperty('','TARGET_LB_SALE',SAVE.LB.SALE)
   STATUS = RBO.setProperty('','TARGET_MT_SALE',SAVE.MT.SALE)
   STATUS = RBO.setProperty('','TARGET_OS_SALE',SAVE.OS.SALE)
   STATUS = RBO.setProperty('','TARGET_SP_SALE',SAVE.SP.SALE)
   STATUS = RBO.setProperty('','TARGET_MS_SALE',SAVE.MS.SALE)
   STATUS = RBO.setProperty('','TARGET_LB_PER',SAVE.LB.PER)
   STATUS = RBO.setProperty('','TARGET_MT_PER',SAVE.MT.PER)
   STATUS = RBO.setProperty('','TARGET_OS_PER',SAVE.OS.PER)
   STATUS = RBO.setProperty('','TARGET_SP_PER',SAVE.SP.PER)
   STATUS = RBO.setProperty('','TARGET_MS_PER',SAVE.MS.PER)
   STATUS = RBO.setProperty('','TARGET_TOT_SALE',TOTAL.SALE)
   RETURN

