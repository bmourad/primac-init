SUBROUTINE GetCopyDeptDetail
********************************************************************************
*   Program name :- GetCopyDeptDetail
*   Created:- 7/30/2003
*   1800-A. Gafoor, Added for copying the estimate from one estimate to another estimate
*------------------------------------------------------------------------------*
*
*  THIS METHOD IS TO GET THE DEPT DETAILS WHEN COPYING FROM THE ANOTHER DEPAR- *
*  TMENT - *
* Insert method code here
$INCLUDE WWINSERT RBO.H
$INCLUDE PMC.CPYLIB DIVISION
$INCLUDE PMC.CPYLIB DEPARTMENT
$INCLUDE PMC.CPYLIB COST.CNTR
$INCLUDE JES.CPYLIB ESTIMATE
$INCLUDE JES.CPYLIB ESTIMATE.RES
$INCLUDE JES.CPYLIB ESTIMATE.DIV
$INCLUDE JES.CPYLIB ESTIMATE.DEPT
$INCLUDE CPYLIB FILE.VARS
$INCLUDE JES.CPYLIB JES.FILE.VARS
$INCLUDE CPYLIB CHAR

  OPEN '','CONTROL' TO CONTROL ELSE RETURN	

  OPEN "","ESTIMATE" TO ESTIMATE ELSE
      ERRMSG = "CANNOT LOCATE ESTIMATE FILE"
	GOTO 1000
	*RETURN
   END

  OPEN "","ESTIMATE.RES" TO ESTIMATE.RES ELSE
      ERRMSG = "CANNOT LOCATE ESTIMATE.RES FILE"
	GOTO 1000
   END

   OPEN "","COST.CNTR" TO COST.CNTR ELSE
      ERRMSG = "CANNOT LOCATE COST.CNTR FILE"
	GOTO 1000
  END
  OPEN "","ESTIMATE.DEPT" TO FESTIMATE.DEPT ELSE
      ERRMSG = "CANNOT LOCATE ESTIMATE.DEPT FILE"
      GOTO 1000 
  END
   OPEN "","ESTIMATE.DEPT" TO ESTIMATE.DEPT ELSE
      ERRMSG = "CANNOT LOCATE ESTIMATE.DEPT FILE"
      GOTO 1000
   END


S$VALUE=''; DEPTINPUT=''; COMP=''; ACTION=''; DEPT.CNT=''; EQTY=''; EST.KEY=''; NEW.EST.KEY=''
QTY.CNT =""; STRVAL =""; PROD_OS_DESC =""; STR_ACT_WIDTH =""; EST.DIV=''; EST.QTY1=''

* Insert method code here
   STATUS = RBO.getProperty('','PMCProperty',PMCProperty)
   STATUS = RBO.getProperty('','ID',ID)
   CONO=PMCProperty<1,4>
   NEW.EST.KEY=FIELD(ID,"!",1)
   EST.KEY=FIELD(ID,"!",2)
   DEPTINPUT=FIELD(ID,"!",3)
   EST.DIV=FIELD(ID,"!",4)
   EST.QTY1=FIELD(ID,"!",5)

   MATREAD EST.REC FROM ESTIMATE,CONO:NEW.EST.KEY THEN
           STRVAL<1,-1> = EST.DIV
	    *STRVAL = STRVAL : "!" : EST.KEY
 	    *STRVAL = STRVAL : "!" : EST.CUST.NAME
	    *STRVAL = STRVAL : "!" : EST.COMMENTS<1,1>  
	    STRVAL = STRVAL : "!" : EST.DEPT
	    STRVAL = STRVAL : "!" : EST.DEPT.DESC
	    STRVAL = STRVAL : "!" : EST.COMP.FLAG
	    PROD_OS_DESC = EST.PROD.OS.DESC
      	    QTY.CNT = DCOUNT(EST.QTY,VM)
  END ELSE
  END

STRVAL = STRVAL : "!"
MATREAD EST.RL.REC FROM ESTIMATE.RES,CONO:NEW.EST.KEY THEN
    FOR X = 1 TO QTY.CNT
    STRVAL<1,-1>=INT(FIELD(EST.RL.TOTAL.PC<1,1,1>,"!",X)/12+.5)
    NEXT X
STRVAL = STRVAL : "!"
FOR I=1 TO DCOUNT(EST.RL.ACT.WIDTH,SVM)
    STR_ACT_WIDTH<1,1,I> = OCONV(EST.RL.ACT.WIDTH<1,1,I>,'MD4')
NEXT I
READV CCTR.DESC FROM COST.CNTR,CONO:EST.RL.PRESS.CCTR<1,1,1>,1 ELSE CCTR.DESC = ""
   STRVAL<1,-1> = EST.RL.PRESS.CCTR<1,1,1>
   STRVAL<1,-1> = CCTR.DESC
END ELSE
   ERRMSG = 'Checking'
   GOTO 1000
END


STATUS = RBO.setProperty('','CopyDeptInfo',STRVAL : "!" : PROD_OS_DESC : "!" : STR_ACT_WIDTH)
*STATUS = RBO.setProperty('','CopyDeptInfo',"")
*1800
*
*---- COPY COMPONENT FROM ANOTHER ESTIMATE
*
800 *
      DEPTINPUT = "ALL"
      DEPT.CNT= DCOUNT(EST.DEPT,VM)
	
      IF DEPTINPUT = "ALL" THEN
         FIRST.DEPT= 1
         LAST.DEPT = DEPT.CNT
      END ELSE
         FIRST.DEPT = DEPTINPUT
         LAST.DEPT = DEPTINPUT
      END
      FEST = NEW.EST.KEY
      FCOMP = ""
   IF FEST = EST.KEY THEN
      ERRMSG = "Cannot copy from current estimate. Try again! "
      GOTO 1000
   END

  READ EREC FROM ESTIMATE, CONO:FEST ELSE
*   READ EREC FROM ESTIMATE, CONO:EST.KEY ELSE
      ERRMSG = "Cannot locate estimate. Try again! "
      GOTO 1000 
   END
*T21958 v

   IF EREC<15> # EST.DIV THEN
      ERRMSG = 'Copied estimate must have same DIVISION path. Try again! '
      GOTO 1000
   END
*T21958 ^
   READ ELREC FROM ESTIMATE.RES, CONO:FEST ELSE
      ERRMSG = "Must be a roll label estimate. Try again! "
      GOTO 1000 
  END
820 *
   S$VALUE = 1
   FCOMP = S$VALUE

   CCNT = DCOUNT(EST.PROD.DESC,VM)
   TCOMP = 1
   IF EST.RL.PRESS.CCTR = "" THEN
      MODE = "A"
   END ELSE
      MODE = "C"
   END
*
   AC = COUNT(EST.A9A,",") + (EST.A9A # "")
   FOR AP = 1 TO AC
      AA = FIELD(EST.A9A,",",AP)
      AA1 = FIELD(AA,"-",1)
      AA2 = FIELD(AA,"-",2)
      IF AA2="" THEN AA2=AA1
      FOR AAP = AA1 TO AA2
         EST.REC(AAP)<1,TCOMP> = EREC<AAP,FCOMP>
      NEXT AAP
   NEXT AP
   EST.COMPONENT.CNT = DCOUNT(EST.PROD.DESC,VM)
   FOR AP = 1 TO EST.RL.REC.SIZE
      EST.RL.REC(AP) = ELREC<AP>
   NEXT AP
   DPTR = FIRST.DEPT	

   FOR DPTR = FIRST.DEPT TO LAST.DEPT
      FFND = 1
      FESTD.ID = DPTR:"!":FCOMP:"!":EREC<42>
      READ DREC FROM FESTIMATE.DEPT,CONO:FEST:"!":FESTD.ID ELSE FFND = 0
      IF FFND THEN
	  TESTD.ID = DPTR:"!":TCOMP:"!":EST.QTY1<1,1>
         WRITE DREC ON ESTIMATE.DEPT, CONO:EST.KEY:"!":TESTD.ID
         CCOPY.FLAG = 1
         LOCATE TESTD.ID IN EST.DEPT.COMP<1>,1 SETTING P ELSE
	    EST.DEPT.COMP<1,P> = TESTD.ID
            EST.COMP.FLAG<1,DPTR,TCOMP> = "Y"
         END
      END
   NEXT DPTR
*WRITE RK ON CONTROL,"01KRISHNA"

*^^^^^


STATUS = RBO.setProperty('','EST.COMP.FLAG',EST.COMP.FLAG)
STATUS = RBO.setProperty('','EST_DEPT_COMP',EST.DEPT.COMP)
* End of method code
RETURN

1000 *
	IF ERRMSG # '' THEN
	   STATUS = RBO.setProperty('','ServerStatus',1)
	   STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
	END
RETURN

