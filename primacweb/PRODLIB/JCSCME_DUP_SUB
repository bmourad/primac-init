SUBROUTINE JCSCME_DUP_SUB
********************************************************************************
*   Program name :- JCSCME_DUP_SUB
*   Created:- 8/19/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JCS.CPYLIB JOB
$INCLUDE PMC.CPYLIB COUNTRY.CODE
$INCLUDE PMC.CPYLIB CUSTOMER
$INCLUDE PMC.CPYLIB TAX
$INCLUDE PMC.CPYLIB TERMS
$INCLUDE JCS.CPYLIB INVOICE

OPEN "","JOB" TO JOB ELSE ERRMSG="JOB FILE IS MISSING"; GOTO 99999
OPEN "","COUNTRY.CODE" TO COUNTRY.CODE ELSE ERRMSG="COUNTRY.CODE FILE IS MISSING"; GOTO 99999
OPEN "","CUSTOMER" TO CUSTOMER ELSE ERRMSG="CUSTOMER FILE IS MISSING"; GOTO 99999
OPEN "","TERMS" TO TERMS ELSE ERRMSG="TERMS FILE IS MISSING"; GOTO 99999
OPEN '',"DAILY.INVOICE" TO DAILY.INVOICE ELSE ERRMSG = "DAILY.INVOICE FILE IS MISSING"; GOTO 99999
OPEN "","INVOICE" TO INVOICE ELSE ERRMSG="INVOICE FILE IS MISSING"; GOTO 99999
OPEN "","TAX" TO TAX ELSE ERRMSG="TAX FILE IS MISSING"; GOTO 99999

STATUS=RBO.getProperty('','PMCProperty',PMCProperty)
CONO = PMCProperty<1,4>

******* GETTING GRID VALUES
MATREAD IVC.REC FROM INVOICE, CONO:CRD.NO ELSE
END

MATREAD IVC.REC FROM DAILY.INVOICE,CONO:IVC.NO ELSE
END
REF.CNT=COUNT(IVC.CHG.CODE,@VM) + (IVC.CHG.CODE # "")

*STATUS =  RBO.setProperty('','ServerMessage',"REFCNT~" : REF.CNT : "~")
*RETURN

   FOR REF=1 TO REF.CNT	
      GRID_CODE<1,REF> = IVC.CHG.CODE<1,REF>
      GRID_QTY<1,REF> = IVC.QUANTITY<1,REF>
      GRID_UM<1,REF> = IVC.UM<1,REF>
      GRID_DESC<1,REF>=IVC.DESC<1,REF>
      GRID_UNIT_PRICE<1,REF> = IVC.UNIT.PRICE<1,REF>
      GRID_AMOUNT<1,REF>=IVC.AMOUNT<1,REF>
      IF IVC.CHG.CAT<1,REF>="TAX" THEN
         MATREAD TAX.REC FROM TAX, CONO:IVC.TAX.JURS<1,REF> ELSE
            MAT TAX.REC=""
            ERRMSG="CANNOT LOCATE TAX JURISDICTION - ":IVC.TAX.JURS
            GOTO 99999
         END
         TMP.TAX.RATE<1,REF>=TAX.RATE
         TAX.REF=REF
         GOSUB 6400
         IF IVC.AMOUNT<1,REF>=TAMT THEN
            TMP.TAX.CALC<1,REF>="C"
         END ELSE
            TMP.TAX.CALC<1,REF>="E"
         END
      END
* ADDED BY ME FOR TOTAL AMOUNT
	AMT.SUB=AMT.SUB + IVC.AMOUNT<1,REF>	
	AMT.TOT=AMT.TOT + IVC.AMOUNT<1,REF>	
	AMT.SUBT=AMT.SUBT + IVC.AMOUNT<1,REF> 
  NEXT REF
	GRID_TOT_AMT = AMT.TOT

	*INVOICE.TOTAL=AMT.TOT
       *GRID_TOT_AMT=INVOICE.TOTAL
************
* THIS IS FOR TERM DESCRIPTION AND DUE DATE FROM TERMS FILE
MATREAD TERMS.REC FROM TERMS,CONO:IVC.TERMS ELSE
      MAT TERMS.REC = ""
END
IVC_TERMS = IVC.TERMS
IVC_TERMS_DESC = TERMS.DESC
IVC.DUE.DATE = IVC.DATE + TERMS.DUE.DAYS
IVC_DUE_DATE=IVC.DUE.DATE
*************

STATUS = RBO.setProperty('','CRD_NO',CRD.NO)
STATUS = RBO.setProperty('','CRD_MODE',MODE)

STATUS =  RBO.setProperty('','BILL_TO',IVC.CUST.NO)
STATUS = RBO.setProperty('','IVC_NO',IVC.NO)
STATUS = RBO.setProperty('','IVC_CUST_NAME',IVC.CUST.NAME)
STATUS = RBO.setProperty('','IVC_ADDR1',IVC.ADDR1)
STATUS = RBO.setProperty('','IVC_ADDR2',IVC.ADDR2)
STATUS = RBO.setProperty('','IVC_ADDR3',IVC.ADDR3)
STATUS = RBO.setProperty('','IVC_ADDR4',IVC.ADDR4)

STATUS = RBO.setProperty('','IVC_TERMS',IVC.TERMS)
STATUS = RBO.setProperty('','IVC_TERMS_DESC',IVC_TERMS_DESC)

STATUS = RBO.setProperty('','SHIP_TO_CNTY',SHIP.TO.CNTY)
STATUS = RBO.setProperty('','IVC_ATTENTION',IVC.ATTENTION)

STATUS = RBO.setProperty('','IVC_PO_NO',IVC.PO.NO)

STATUS = RBO.setProperty('','IVC_DATE',OCONV(IVC.DATE,"D2/"))
STATUS = RBO.setProperty('','IVC_MEMO_STATUS1',IVC.MEMO.STATUS1)
STATUS = RBO.setProperty('','IVC_STATUS_DATE1',IVC.STATUS.DATE1)
STATUS = RBO.setProperty('','IVC_DUE_DATE',OCONV(IVC_DUE_DATE,"D2/"))

STATUS = RBO.setProperty('','GRID_CODE',GRID_CODE)
STATUS = RBO.setProperty('','GRID_QTY',GRID_QTY)
STATUS = RBO.setProperty('','GRID_UM',GRID_UM)
STATUS = RBO.setProperty('','GRID_DESC',GRID_DESC)
STATUS = RBO.setProperty('','GRID_UNIT_PRICE',GRID_UNIT_PRICE)
STATUS = RBO.setProperty('','GRID_AMOUNT',GRID_AMOUNT)
STATUS = RBO.setProperty('','GRID_TOT_AMT',GRID_TOT_AMT)
RETURN

6400*
   AMT.TAX=0
   TDONE=0
   FOR TREF=TAX.REF-1 TO 1 STEP -1 UNTIL TDONE
      IF IVC.CHG.CAT<1,TREF>="TAX" THEN
         IF AMT.TAX > 0 THEN TDONE=1
      END ELSE
         IF IVC.CHG.CODE<1,TREF> # 'SUBT' THEN
            AMT.TAX=AMT.TAX + IVC.AMOUNT<1,TREF>
            IF IVC.CHG.CODE<1,TREF>="SUB" THEN
               TDONE=1
            END
         END
      END
   NEXT TREF
   TAMT=INT(AMT.TAX*(TMP.TAX.RATE<1,TAX.REF>/1000)/100+0.5)
RETURN

* End of method code
99999*
STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN

