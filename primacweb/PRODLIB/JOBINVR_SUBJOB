SUBROUTINE JOBINVR_SUBJOB
********************************************************************************
*   Program name :- JOBINVR_SUBJOB
*   Created:- 09/17/2003
*------------------------------------------------------------------------------*
*
*  
* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JCS.CPYLIB JOB
$INCLUDE PMC.CPYLIB CUSTOMER
$INCLUDE JCS.CPYLIB INVOICE
$INCLUDE JCS.CPYLIB DAILY.INVOICE
$INCLUDE JCS.CPYLIB MASTER.TOT.REC
$INCLUDE CPYLIB CHAR
* Insert method code here

IVC.CNT=''
J.CNT=''
ADD.SUBS = 1
IVC.PRT.DATE=''
BILL.AMT=''
TAX.AMT=''
INV.AMT=''
PAID.AMT=''
IVC.PROC.MON=''
PRE_PAID=''
INV_PAID=''
PAID_AMT=''
IVC_PRT_DT=''
DI_PRT_DATE1 = ''
JOB_INV_CAT = ''
JSUBINVCAT = ''
J_INV_CAT = ''

OPEN "","JOB" TO JOB ELSE ERRMSG = "JOB FILE IS MISSING"; GOTO 1000

OPEN "","INVOICE" TO INVOICE ELSE
   ERRMSG = "INVOICE FILE IS MISSING" 
   GOTO 1000
END

OPEN "","DAILY.INVOICE" TO DAILY.INVOICE ELSE
   ERRMSG = "DAILY.INVOICE FILE IS MISSING" 
   GOTO 1000
END

ID = ''
JOB_SUBS=''
STATUS = RBO.getProperty('','ID',ID)
STATUS = RBO.getProperty('','JOB_INVNO',JOB.INVNO)
*STATUS = RBO.getProperty('','JOB_SUBS',JOB_SUBS)

CONO = ID[1,3]
ID = ID[4,99]
NCNT=''
IV_DATE=''
IVC_PERIOD=''
IVC_PROC_DATE=''
JSUBINVNO=''
JOB.INV.NO=''
JINVNO=''
IVC_DATE=''
IVC_PRT_DT=''
IVC_DUE_DATE = ""
IVC_DUE_DATE_SJ = ""
JINV_DUE_AMT = ""
JSUBINV_DUE_AMT = ""


MATREAD JOB.REC FROM JOB,CONO:ID THEN
   JOB_SUBS=JOB.SUBS
   JINVNO<1,-1>      = JOB.INV.NO
   JINV_DUE_AMT<1,-1>   = JOB.INV.BAL
   JOB_INV_CAT<1,-1>   = JOB.INV.CAT
END ELSE
   ERRMSG = 'CANNOT READ JOBFILE'
   GOTO 1000
END

*-- LOAD SUB JOBS 
IF JOB_SUBS # "" THEN     
   SCNT = DCOUNT(JOB_SUBS,VM) 
   FOR S = 1 TO SCNT
      MATREAD JOB.REC FROM JOB, CONO:JOB_SUBS<1,S> THEN
         JSUBINVNO<1,-1>      = JOB.INV.NO
         JSUBINV_DUE_AMT<1,-1>   = JOB.INV.BAL
         JSUBINVCAT<1,-1>   = JOB.INV.CAT
      END ELSE 
         ERRMSG = 'CANNOT READ JOBFILE'
         GOTO 1000 
      END
   NEXT S   
END

TEMP_CNT_SUB_INVNO = DCOUNT(JSUBINVNO,VM)
TMP_JOB_INVNO=""
TMP_JOB_INV_DUE_AMT = ""
TMP_INV_CAT = ""

FOR I = 1 TO TEMP_CNT_SUB_INVNO 
   LOCATE JSUBINVNO<1,I> IN JINVNO<1> SETTING POS ELSE
      TMP_JOB_INVNO<1,-1>       = JSUBINVNO<1,I>
      TMP_JOB_INV_DUE_AMT<1,-1>    = JSUBINV_DUE_AMT<1,I>
      TMP_INV_CAT<1,-1>      = JSUBINVCAT<1,I>
   END
NEXT I

*JOB.INV.NO_TOT = JINVNO : VM : JSUBINVNO
JOB.INV.NO = JINVNO : VM : TMP_JOB_INVNO<1>
JOB.INV.NO_TMP = JINVNO : VM : TMP_JOB_INVNO<1>
JOB_INV_DUE_AMT = JINV_DUE_AMT : VM : TMP_JOB_INV_DUE_AMT
J_INV_CAT = JOB_INV_CAT : VM : TMP_INV_CAT


*      NCNT=DCOUNT(JOB.INV.NO,@VM)
*      FOR I= 1 TO NCNT
*         MATREAD IVC.REC FROM INVOICE, CONO:JOB.INV.NO<1,I> THEN
*            IV_DATE<1,I>=OCONV(IVC.DATE,"D2/")
*            IVC_PERIOD<1,I>=IVC.PROC.MON
*            IVC_PROC_DATE<1,I>=OCONV(IVC.PROC.DATE,"D2/")
*            IVC_PRT_DT<1,I>=OCONV(IVC.PRT.DATE,"D2/")   
*      *      IVC_DUE_DATE_SJ<1,I> = OCONV(IVC.DATE,"D2/")
*         END ELSE
*            IVC_DATE<1,I>      = ""   
*            IVC_PERIOD<1,I>   = ""   
*            IVC_PROC_DATE<1,I>   = ""
*            IVC_PRT_DT<1,I>   = ""      
*         END
*      NEXT I
************************************************
INV_CNT = DCOUNT(JOB.INV.NO_TMP,@VM)

*STATUS = RBO.setProperty('','ServerMessage',INV_CNT : 'job inv no - ' : JOB.INV.NO_TMP)
*RETURN

FOR I = 1 TO INV_CNT      
   MATREAD IVC.REC FROM INVOICE, CONO:JOB.INV.NO_TMP<1,I> THEN
      IVC_PERIOD<1,I>   = IVC.PROC.MON
      IF IVC.PROC.MON > "0" THEN            
         IV_DATE<1,I>   = OCONV(IVC.DATE,"D2/")
      END ELSE
         IV_DATE<1,I>   = ""
      END
*      IV_DATE<1,I>         = OCONV(IVC.DATE,"D2/")
      IVC_PROC_DATE<1,I>      = OCONV(IVC.PROC.DATE,"D2/")
      IVC_PRT_DT<1,I>      = OCONV(IVC.PRT.DATE,"D2/")   
      IVC_DUE_DATE_SJ<1,I>    = OCONV(IVC.CURR.CODE,"D2/")
   END ELSE
      MATREAD IVC.REC FROM DAILY.INVOICE, CONO:JOB.INV.NO_TMP<1,I> THEN
         IVC_PERIOD<1,I>      = IVC.PROC.MON
         IF IVC.PROC.MON > "0" THEN
            IV_DATE<1,I>         = OCONV(IVC.DATE,"D2/")
         END ELSE               
            IV_DATE<1,I>         = ""
         END
*         IV_DATE<1,I>         = OCONV(IVC.DATE,"D2/")
         IVC_PROC_DATE<1,I>      = OCONV(IVC.PROC.DATE,"D2/")
         IVC_PRT_DT<1,I>      = OCONV(IVC.PRT.DATE,"D2/")   
         IVC_DUE_DATE_SJ<1,I>    = OCONV(IVC.CURR.CODE,"D2/")
      END ELSE
         IVC_DATE<1,I>      = ""   
         IVC_PERIOD<1,I>   = ""   
         IVC_PROC_DATE<1,I>   = ""
         IVC_PRT_DT<1,I>   = ""
         IVC_DUE_DATE_SJ<1,I> = ""
      END
   END
NEXT I
*************************************************
*IVC.CNT = DCOUNT(JOB.INV.NO,@VM)
INV_CNT = DCOUNT(JOB.INV.NO_TMP,@VM)
TAX_AMT = ""
BILL_AMT=""
INV_AMT=""
BILL_AMT_MV = ""
AMT_DUE_MV = ""
JOB_INV_AMT = ""
JOB_INV_NO = ""
JOB_PAID_AMT = ""


************* CHECK THE BELOW CODE vv ************

PRE.PAID = 0

************************** NEW CODE Added vvvvvvvvvvvvvvvv ******************
MATREAD JOB.REC FROM JOB, CONO:ID THEN
   JOB_INV_NO   = JOB.INV.NO_TMP
   JOB_INV_AMT   = JOB.INV.BAL
END ELSE 
   ERRMSG = 'CANNOT READ JOBFILE'
END

FOR I = 1 TO INV_CNT
   MAT IVC.REC = ""
   *IF JOB.INV.CAT<1,I,1> = "PP" THEN
   IF J_INV_CAT<1,I,1> = "PP" THEN
      BILL.AMT = ""
      TAX.AMT = ""
      INV.AMT = ""
      PAID.AMT = INV.AMT - JOB.INV.BAL<1,I>
      PRE.PAID = PRE.PAID + JOB.INV.BAL<1,I>
      GOTO 30005
   END   
*   IVC.ID=CONO:JOB.INV.NO<1,I>   
   IVC.ID=CONO:JOB.INV.NO_TMP<1,I>   

** Reading the ID from Daily.invoice file.

   MATREAD IVC.REC FROM DAILY.INVOICE,IVC.ID THEN
      ALL_CCT<1,I> = 'Y'
      IVC_DUE_DATE<1,I>    = OCONV(IVC.CURR.CODE,"D2/")
      IVC_PROC_DATE<1,I>   = OCONV(IVC.PROC.DATE,"D2/")

      BILL.AMT = ""
      TAX.AMT = ""
      INV.AMT = ""
      PAID.AMT = ""
      DI_PRT_DATE1 = ""   
      CODE.CNT = COUNT(IVC.CHG.CODE,@VM) + (IVC.CHG.CODE # "")   
      FOR PTR = 1 TO CODE.CNT
         IF IVC.CHG.CODE<1,PTR> = "TOT" OR IVC.CHG.CODE<1,PTR> = "SUB" OR IVC.CHG.CODE<1,PTR> = "SUBT" OR IVC.CHG.CAT<1,PTR> = "CMT" THEN GOTO 49999
         IF ADD.SUBS = 0 AND ID # IVC.CHG.JOB<1,PTR> THEN GOTO 49999
         IF JOB.INV.DATE<1,I> = "" AND JOB.INV.NO<1,I>[7,2] = "CM" THEN
            IVC.AMOUNT<1,PTR> = IVC.AMOUNT<1,PTR> * (-1)
         END
         IF IVC.CHG.CAT<1,PTR> = "TAX" THEN
            TAX.AMT = TAX.AMT + IVC.AMOUNT<1,PTR>
         END ELSE
            BILL.AMT = BILL.AMT + IVC.AMOUNT<1,PTR>            
         END
         DI_PRT_DATE1 = DI_PRT_DATE1 + DI.PRT.DATE<1,PTR>
      49999*
      NEXT PTR
      INV.AMT = TAX.AMT + BILL.AMT 
      GOTO 30005
   END ELSE
** Reading the ID from Invoice file.   
      MATREAD IVC.REC FROM INVOICE,IVC.ID ELSE NULL   
      ALL_CCT<1,I> = 'N'
      IVC_DUE_DATE<1,I>    = OCONV(IVC.CURR.CODE,"D2/")
      IVC_PROC_DATE<1,I>   = OCONV(IVC.PROC.DATE,"D2/")      
      BILL.AMT = ""
      TAX.AMT = ""
      INV.AMT = ""
      PAID.AMT = ""
      DI_PRT_DATE1 = ""   
      CODE.CNT = COUNT(IVC.CHG.CODE,@VM) + (IVC.CHG.CODE # "")   
      FOR PTR = 1 TO CODE.CNT
         IF IVC.CHG.CODE<1,PTR> = "TOT" OR IVC.CHG.CODE<1,PTR> = "SUB" OR IVC.CHG.CODE<1,PTR> = "SUBT" OR IVC.CHG.CAT<1,PTR> = "CMT" THEN GOTO 499991
         IF ADD.SUBS = 0 AND ID # IVC.CHG.JOB<1,PTR> THEN GOTO 499991
         IF JOB.INV.DATE<1,I> = "" AND JOB.INV.NO<1,I>[7,2] = "CM" THEN
            IVC.AMOUNT<1,PTR> = IVC.AMOUNT<1,PTR> * (-1)
         END
         IF IVC.CHG.CAT<1,PTR> = "TAX" THEN
            TAX.AMT = TAX.AMT + IVC.AMOUNT<1,PTR>
         END ELSE
            BILL.AMT = BILL.AMT + IVC.AMOUNT<1,PTR>            
         END
         DI_PRT_DATE1 = DI_PRT_DATE1 + DI.PRT.DATE<1,PTR>
               499991*
      NEXT PTR
      INV.AMT = TAX.AMT + BILL.AMT
      GOTO 30005

   END

   30005*
*   SCV.REC<1,I> = I
   JOB.INV.NO<1,I>    = JOB.INV.NO<1,I>
   BILL_AMT<1,I>    = OCONV(BILL.AMT,"MD2")
   TAX_AMT<1,I>       = OCONV(TAX.AMT,"MD2")
   INV_AMT<1,I>       =  OCONV(INV.AMT,"MD2")
   BILL_AMT_MV<1,I>   = OCONV( (INV.AMT - TAX.AMT),"MD2")
   JOB.INVDATE<1,I>   = OCONV(JOB.INV.DATE<1,I>,"D2/")
   IVC.PRT.DATE<1,I>    = IVC.PRT.DATE<1,I>
   PAID_AMT<1,I>      = OCONV(PAID.AMT,"MD2")
   JOB.INV.BAL<1,I>   = OCONV(JOB.INV.BAL<1,I>,"MD2")
   IVC.PROC.MON<1,I>    = IVC.PROC.MON
   AMT_DUE_MV<1,I>    = OCONV(JOB_INV_DUE_AMT<1,I>,"MD2")
   JOB_PAID_AMT<1,I>    = OCONV((INV_AMT<1,I> - AMT_DUE_MV<1,I>) * 100.00,"MD2")

NEXT I

************************** END OF NEW CODE Added ^^^^^^^^^^ *****************

*STATUS = RBO.setProperty('','ALL_CCT', "--XXXXXXXXX---" :ALL_CCT  )
*RETURN

******************  old Code vvvvvvvv ******************
*      FOR I = 1 TO IVC.CNT
*          MAT IVC.REC = ""
*          IF JOB.INV.CAT<1,I,1> = "PP" THEN
*            BILL.AMT = ""
*            TAX.AMT = ""
*            INV.AMT = ""
*            PAID.AMT = INV.AMT - JOB.INV.BAL<1,I>
*            PRE.PAID = PRE.PAID + JOB.INV.BAL<1,I>
*            GOTO 30005
*          END
*      
*          IVC.ID=CONO:JOB.INV.NO<1,I>
*      
*          IF JOB.INV.DATE<1,I> = "" THEN
*            MATREAD IVC.REC FROM DAILY.INVOICE,IVC.ID ELSE NULL
*      
*            IVC_DUE_DATE<1,I>    = OCONV(IVC.CURR.CODE,"D2/")
*            IVC_PROC_DATE<1,I>   = OCONV(IVC.PROC.DATE,"D2/")
*            
*               BILL.AMT = ""
*                 TAX.AMT = ""
*               INV.AMT = ""
*                   PAID.AMT = ""
*               DI_PRT_DATE1 = ""
*      
*               CODE.CNT = COUNT(IVC.CHG.CODE,@VM) + (IVC.CHG.CODE # "")
*      
*            FOR PTR = 1 TO CODE.CNT
*               
*                   IF IVC.CHG.CODE<1,PTR> = "TOT" OR IVC.CHG.CODE<1,PTR> = "SUB" OR IVC.CHG.CODE<1,PTR> = "SUBT" OR IVC.CHG.CAT<1,PTR> = "CMT" THEN GOTO 49999
*               IF ADD.SUBS = 0 AND ID # IVC.CHG.JOB<1,PTR> THEN GOTO 49999
*                   IF JOB.INV.DATE<1,I> = "" AND JOB.INV.NO<1,I>[7,2] = "CM" THEN
*                        IVC.AMOUNT<1,PTR> = IVC.AMOUNT<1,PTR> * (-1)
*                   END
*      
*                   IF IVC.CHG.CAT<1,PTR> = "TAX" THEN
*                        TAX.AMT = TAX.AMT + IVC.AMOUNT<1,PTR>
*                   END ELSE
*                        BILL.AMT = BILL.AMT + IVC.AMOUNT<1,PTR>            
*                   END
*                  DI_PRT_DATE1 = DI_PRT_DATE1 + DI.PRT.DATE<1,PTR>
*            49999*
*             NEXT PTR
*              INV.AMT = TAX.AMT + BILL.AMT 
*          END ELSE
*              MATREAD IVC.REC FROM INVOICE,IVC.ID THEN
*              BAD.IVC = 1
*              IF IVC.JOB.NO = ID THEN
*                BAD.IVC = 0
*              END ELSE
*                LOCATE ID IN IVC.CHG.JOB<1>,1 SETTING JUNK THEN
*                  BAD.IVC = 0
*                END ELSE
*                  J.CNT = DCOUNT(JOB.SUBS<1>, @VM)
*                  FOR JJ = 1 TO J.CNT UNTIL BAD.IVC = 0
*                    TMP.JOB = JOB.SUBS<1,JJ>
*                    IF IVC.JOB.NO = TMP.JOB THEN
*                      BAD.IVC = 0
*                    END ELSE
*                      LOCATE TMP.JOB IN IVC.CHG.JOB<1>,1 SETTING JUNK THEN
*                        BAD.IVC = 0
*                      END
*                    END
*                  NEXT JJ
*                END
*              END
*              IF BAD.IVC = 1 THEN
*                MAT IVC.REC=''
*                IVC.PRT.DATE="PURGED"
*              END
*            END ELSE
*              IVC.PRT.DATE = "PURGED"
*            END
*      *      GOSUB 50000 
*           BILL.AMT = ""
*             TAX.AMT = ""
*             INV.AMT = ""
*             PAID.AMT = ""
*             CODE.CNT = COUNT(JOB.INV.CAT<1,I>,SVM) + (JOB.INV.CAT<1,I> # "")
*             FOR PTR = 1 TO CODE.CNT
*                IF JOB.INV.CAT<1,I,PTR> = "TOT" OR JOB.INV.CAT<1,I,PTR> = "SUB" OR JOB.INV.CAT<1,I,PTR> = "CMT" THEN GOTO 59999
*                IF JOB.INV.CAT<1,I,PTR> = "TAX" THEN
*                   TAX.AMT = TAX.AMT + JOB.INV.AMT<1,I,PTR>
*                END ELSE
*                     BILL.AMT = BILL.AMT + JOB.INV.AMT<1,I,PTR>
*                END
*           59999*
*           NEXT PTR
*             INV.AMT = TAX.AMT + BILL.AMT
*             PAID.AMT= INV.AMT - JOB.INV.BAL<1,I>
*          END
*      ****
*         30005*
*        *  SCV.REC<1,I> = I
*          JOB.INV.NO<1,I>        = JOB.INV.NO<1,I>
*          JOB.INV.DATE<1,I>   = OCONV(JOB.INV.DATE<1,I>,"D2/")
*          IVC.PRT.DATE<1,I>    = IVC.PRT.DATE<1,I>
*          BILL_AMT<1,I>       = OCONV(BILL.AMT,"MD2")
*          TAX_AMT<1,I>       = OCONV(TAX.AMT,"MD2")
*          INV_AMT<1,I>       = OCONV(INV.AMT,"MD2")
*          PAID_AMT<1,I>      = OCONV(PAID.AMT,"MD2")
*          JOB.INV.BAL<1,I>      = OCONV(JOB.INV.BAL<1,I>,"MD2")
*          IVC.PROC.MON<1,I>    = IVC.PROC.MON    
*      NEXT I
*STATUS = RBO.setProperty('','ALL_CCT',' Checking:---> ' : IVC.AMOUNT )
*RETURN
******************  end of old Code ^^^^^^^^^^^^^ ******************
PRE_PAID= PRE.PAID * (-1)
INV_PAID= JOB.TOT.INV - JOB.TOT.BAL + PRE.PAID
******** CHECK THE ABOVE CODE ^^ ***************************

STATUS = RBO.setProperty('','IVC_DATE',IV_DATE)
STATUS = RBO.setProperty('','IVC_PERIOD',IVC_PERIOD)
STATUS = RBO.setProperty('','IVC_PROC_DATE',IVC_PROC_DATE)
STATUS = RBO.setProperty('','IVC_DATE',IV_DATE)
STATUS = RBO.setProperty('','IVC_PRT_DT',IVC_PRT_DT)
STATUS = RBO.setProperty('','IVC_DUE_DATE_MV',IVC_DUE_DATE)
STATUS = RBO.setProperty('','IVC_DUE_DATE_SJ',IVC_DUE_DATE_SJ<1>)

*IF JOB.INV.NO <> "" THEN
   *JOB.INV.NO = JOB.INVNO : VM : JOB.INV.NO
STATUS = RBO.setProperty('','JOB_INVNO',JOB.INV.NO_TMP)
*END

STATUS = RBO.setProperty('','JOB_INV_DATE',JOB.INV.DATE)
*   STATUS = RBO.setProperty('','IVC_PRT_DATE',IVC.PRT.DATE)
STATUS = RBO.setProperty('','IVC_PRT_DATE',DI_PRT_DATE1)   
STATUS = RBO.setProperty('','IVC_PROC_MON',IVC.PROC.MON)
*   STATUS = RBO.setProperty('','PRE_PAID',OCONV(PRE_PAID,"MD2"))
*   STATUS = RBO.setProperty('','INV_PAID',OCONV(INV_PAID,"MD2"))

STATUS = RBO.setProperty('','BILL_AMT',BILL_AMT)
STATUS = RBO.setProperty('','TAX_AMT',TAX_AMT)
STATUS = RBO.setProperty('','INV_AMT',INV_AMT)
STATUS = RBO.setProperty('','PAID_AMT',AMT_DUE_MV)
STATUS = RBO.setProperty('','JOB_INV_BALANCE',JOB_PAID_AMT)


*************************************************
1000*
IF ERRMSG # "" THEN
   STATUS = RBO.setProperty('','ServerStatus', 1)
   STATUS = RBO.setProperty('','ServerMessage', ERRMSG)            
END

* End of method code
RETURN

