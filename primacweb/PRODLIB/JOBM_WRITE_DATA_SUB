SUBROUTINE JOBM_WRITE_DATA_SUB
$INCLUDE CPYLIB COMMON1
$INCLUDE JCS.CPYLIB COM.JCS.LINK
$INCLUDE ICS.CPYLIB COM.INV.MAIN  
$INCLUDE ICS.CPYLIB COM.INV.SERIAL
$INCLUDE JCS.CPYLIB COM.INV.STATS
$INCLUDE PMC.CPYLIB COM.CUST
$INCLUDE OPS.CPYLIB COM.ORDER
$INCLUDE PMC.CPYLIB COM.COMPANY

********************************************************************************
*   Program name :- JOBM_WRITE_DATA_SUB
*   Created:- 8/11/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$DEFINE COMPOPS
$INCLUDE PMC.CPYLIB COMP.OPS
$INCLUDE PMC.CPYLIB FISCAL

$DEFINE COMPANY
$INCLUDE PMC.CPYLIB COMPANY

$DEFINE CUSTOMER
$INCLUDE PMC.CPYLIB CUSTOMER

$DEFINE JOB
$INCLUDE JCS.CPYLIB JOB

$DEFINE SERIALRESV
$INCLUDE JCS.CPYLIB SERIAL.RESV

$DEFINE JOBSTATS
$INCLUDE JCS.CPYLIB JOB.STATS
$DEFINE JOBCREDITSTATS
$INCLUDE JCS.CPYLIB JOB.CREDIT.STATS
$INCLUDE JCS.CPYLIB GANG.JOB
$INCLUDE JES.CPYLIB ESTIMATE
$DEFINE ORDER
$INCLUDE OPS.CPYLIB ORDER

$DEFINE INVSERIAL
$INCLUDE ICS.CPYLIB INV_SERIAL


$DEFINE ORDERDETAILINQ
$INCLUDE OPS.CPYLIB ORDER.DETAIL.INQ

$DEFINE JOBFNGDSTATS
$INCLUDE OPS.CPYLIB JOB.FNGD.STATS

$DEFINE INVJOBSTATS
$INCLUDE ICS.CPYLIB INV.JOB.STATS

$DEFINE FNGDSTATS
$INCLUDE ICS.CPYLIB FNGD.STATS

$DEFINE OPERATION
$INCLUDE JCS.CPYLIB OPERATION

$INCLUDE PMC.CPYLIB DEPARTMENT
$INCLUDE PMC.CPYLIB COST.CNTR

$INCLUDE ICS.CPYLIB FNGD.JOB.STATS
$INCLUDE PSS.CPYLIB JOB.SCHED

$DEFINE INVENTORY
$INCLUDE ICS.CPYLIB INVENTORY

$DEFINE CATEGORY
$INCLUDE ICS.CPYLIB CATEGORY

$DEFINE INVWHSE
$INCLUDE ICS.CPYLIB INV.WHSE

$INCLUDE JES.CPYLIB ESTIMATE.JOB

$DEFINE ESTIMATERES
$INCLUDE JES.CPYLIB ESTIMATE.RES

*$DEFINE ESTIMATEDEPT
$INCLUDE JES.CPYLIB ESTIMATE.DEPT

*$DEFINE ESTIMATEMATL
$INCLUDE JES.CPYLIB ESTIMATE.MATL

$INCLUDE CPYLIB CHAR
$INCLUDE ICS.CPYLIB INV.CNV

$DEFINE FILEVARS
$INCLUDE CPYLIB FILE.VARS

ERRMSG = ''
OPEN '','CONTROL' TO CONTROL ELSE
	ERRMSG = "UNABLE TO OPEN CONTROL FILE"
    	GOTO 99999
END

OPEN '','OPERATION' TO OPERATION ELSE
	ERRMSG = "UNABLE TO OPEN OPERATION FILE"
    	GOTO 99999
END
OPEN "","INVENTORY" TO INVENTORY ELSE
	ERRMSG = "UNABLE TO OPEN INVENTORY"
	GOTO 99999
END
OPEN "","CUSTOMER" TO CUSTOMER ELSE
      	ERRMSG = "UNABLE TO OPEN CUSTOMER FILE"
    	GOTO 99999
END
OPEN "","JOB" TO JOB ELSE
     	ERRMSG = "UNABLE TO OPEN JOB FILE"
    	GOTO 99999
END

OPEN "","JOB.TIME" TO JOB.TIME ELSE
       ERRMSG = "JOB.TIME"; GOTO 99999
END

OPEN "","JOB.STATS" TO JOB.STATS ELSE
     	ERRMSG = "UNABLE TO OPEN JOB.STATS FILE"
    	GOTO 99999
END
OPEN "","JOB.CREDIT.STATS" TO JOB.CREDIT.STATS ELSE
     	ERRMSG = "UNABLE TO OPEN JOB.CREDIT.STATS FILE"
    	GOTO 99999
END
OPEN "","GANG.JOB" TO GANG.JOB ELSE
   	ERRMSG = "UNABLE TO OPEN GANG.JOB FILE"
    	GOTO 99999
END
OPEN "","ESTIMATE" TO ESTIMATE ELSE
   	ERRMSG = "UNABLE TO OPEN ESTIMATE FILE"
    	GOTO 99999
END
OPEN "","ESTIMATE.JOB" TO ESTIMATE.JOB ELSE
   	ERRMSG = "UNABLE TO OPEN ESTIMATE.JOB FILE"
    	GOTO 99999
END
OPEN "","ESTIMATE.DEPT" TO ESTIMATE.DEPT ELSE
  	ERRMSG = "UNABLE TO OPEN ESTIMATE.DEPT FILE"
    	GOTO 99999
END
OPEN "","ESTIMATE.MATL" TO ESTIMATE.MATL ELSE
	ERRMSG = "UNABLE TO OPEN ESTIMATE.MATL FILE"
    	GOTO 99999
END

OPEN "","ESTIMATE.RES" TO ESTIMATE.RES ELSE
	ERRMSG = "UNABLE TO OPEN ESTIMATE.RED FILE"
    	GOTO 99999
END
OPEN "","ORDER" TO ORDER ELSE
	ERRMSG = "UNABLE TO OPEN ORDER FILE"
    	GOTO 99999
END
OPEN "","ORDER.DETAIL" TO ORDER.DETAIL ELSE
	ERRMSG = "UNABLE TO OPEN ORDER.DETAIL FILE"
    	GOTO 99999
END
OPEN "","ORDER.RELEASE" TO ORDER.RELEASE ELSE
	ERRMSG = "ORDER.RELEASE"; GOTO 99999
END
OPEN "","FNGD.ORDER.STATS" TO FNGD.ORDER.STATS ELSE
	ERRMSG = "FNGD.ORDER.STATS"; GOTO 99999
END
OPEN "","SYS_TKT_DEF" TO SYS_TKT_DEF ELSE
	ERRMSG = "SYS_TKT_DEF"; GOTO 99999
END
OPEN "","SYS_SCN_DEF" TO SYS_SCN_DEF ELSE
	ERRMSG = "SYS_SCN_DEF"; GOTO 99999
END
OPEN "","SYS_FILES" TO SYS_FILES ELSE
	ERRMSG = "SYS_FILES"; GOTO 99999
END
OPEN "","PFX_FILES" TO PFX_FILES ELSE
	ERRMSG = "PFX_FILES"; GOTO 99999
END
OPEN "","SYS_FIELDS" TO SYS_FIELDS ELSE
	ERRMSG = "SYS_FIELDS"; GOTO 99999
END
OPEN "","SYS_FLD_HMSG" TO SYS_FLD_HMSG ELSE
	ERRMSG = "SYS_FLD_HMSG"; GOTO 99999
END
OPEN "","JOB.FNGD.STATS" TO JOB.FNGD.STATS ELSE
	ERRMSG = "UNABLE TO OPEN JOB.FNGD.STATS FILE"
    	GOTO 99999
END
OPEN "","INV.JOB.STATS" TO INV.JOB.STATS ELSE
	ERRMSG = "UNABLE TO OPEN INV.JOB.STATS FILE"
    	GOTO 99999
END
OPEN "","GANG.ALLOC" TO GANG.ALLOC ELSE
	ERRMSG = "GANG.ALLOC"; GOTO 99999
END
OPEN "","USER.MAIL" TO USER.MAIL ELSE
	ERRMSG = "USER.MAIL"; GOTO 99999
END
OPEN "","SECURITY" TO SECURITY ELSE
	ERRMSG = "SECURITY"; GOTO 99999
END
OPEN "","FNGD.BOM" TO FNGD.BOM ELSE
	ERRMSG = "FNGD.BOM"; GOTO 99999
END
OPEN "","FNGD.STATS" TO FNGD.STATS ELSE
	ERRMSG = "UNABLE TO OPEN FNGD.STATS FILE"
    	GOTO 99999
END
OPEN "","INV.WHSE.LOC" TO INV.WHSE.LOC ELSE
	ERRMSG = "INV.WHSE.LOC"; GOTO 99999
END
OPEN "","INV_RECEIPTS" TO INV_RECEIPTS ELSE
	ERRMSG = "INV_RECEIPTS"; GOTO 99999
END

OPEN "","FNGD.JOB.STATS" TO FNGD.JOB.STATS ELSE
	ERRMSG = "UNABLE TO FNGD.JOB.STATS FILE"
    	GOTO 99999
END
OPEN '','JOB.SCHED' TO JOB.SCHED ELSE ;* THIS IS OPEND AT THE MIDDLE OF THE PROGRAM
	ERRMSG = "UNABLE TO JOB.SCHED FILE"
    	GOTO 99999
END
OPEN "","INV.WHSE" TO INV.WHSE ELSE
      	ERRMSG = "UNABLE TO OPEN INV.WHSE"
	GOTO 99999
END
OPEN "","INV.STATS" TO INV.STATS ELSE
   	ERRMSG = "UNABLE TO OPEN INV.STATS"
	GOTO 99999
END
OPEN "","OUTSIDE.PO" TO OUTSIDE.PO ELSE
	ERRMSG = "UNABLE TO OPEN OUTSIDE.PO"
	GOTO 99999
END
OPEN "","DEPARTMENT" TO DEPARTMENT ELSE
	ERRMSG = "DEPARTMENT FILE MISSING"
	GOTO 99999
END

OPEN "","DIVISION" TO DIVISION ELSE
	ERRMSG = "DIVISION FILE IS MISSING"
	GOTO 99999
END
OPEN "","COST.CNTR" TO COST.CNTR ELSE
	ERRMSG = "COST.CNTR FILE IS MISSING"
	GOTO 99999
END

OPEN "","COST.CNTR.WIP" TO COST.CNTR.WIP ELSE
	ERRMSG = "COST.CNTR.WIP"
	GOTO 99999
END
OPEN "","INV.FNGD" TO INV.FNGD ELSE
         ERRMSG = "INV.FNGD"; GOTO 99999
END

OPEN "","JOB.MATL" TO JOB.MATL ELSE
     	ERRMSG = "JOB.MATL FILE IS MISSING"
	GOTO 99999
END
OPEN "","JOB.OSP" TO JOB.OSP ELSE
	ERRMSG = "JOB.OSP FILE IS MISSING"
	GOTO 99999
END
OPEN "","JOB.MISC" TO JOB.MISC ELSE
         ERRMSG = "JOB.MISC"; GOTO 99999
END
OPEN "","CATEGORY" TO CATEGORY ELSE
	ERRMSG = "UNABLE TO OPEN OUTSIDE.PO"
	GOTO 99999
END
OPEN "","COMPANY" TO COMPANY ELSE
	ERRMSG = "UNABLE TO OPEN COMPANY"
	GOTO 99999
END
OPEN "","JKT_NOTIFY" TO JKT_NOTIFY ELSE
	ERRMSG = "JKT_NOTIFY"; GOTO 99999
END


****ADDED
OPEN "","INV_SERIAL" TO INV_SERIAL ELSE
	ERRMSG = "INV_SERIAL NOT FOUND"; GOTO 99999
END
***END

EST.ACT.FLG = 0
OPEN "","EST.JOB.ACT" TO EST.JOB.ACT THEN EST.ACT.FLG = 1

DIM TEMP.INV.REC(INV.REC.SIZE)
DEFFUN CALC_STK_QTY(BALANCE,MAT INV.CNV.REC,ROND,LN)
*DEFFUN JOBM_STATUS_SUB(STATUS)
* Insert method code here
DIM SAVE.JOB(JOB.REC.SIZE)
DIM EST.PAR(10)
EQU EST.PAR.QTY    TO EST.PAR(1)
EQU EST.PAR.COMP   TO EST.PAR(2)
EQU EST.PAR.DEPT   TO EST.PAR(3)
EQU EST.PAR.UPDM   TO EST.PAR(4)
EQU EST.PAR.MATL   TO EST.PAR(5)
DIM OLD.EST.PAR(10)
MAT OLD.EST.PAR = ''
DIM NEW.EST.PAR(10)
MAT NEW.EST.PAR = ''

VAL = RBO.getProperty('','ID',ID) ;* CONO:JOB.NO
VAL = RBO.getProperty('','PMCProperty',PMCProperty) 
USERID=PMCProperty<1,3>
JOB_NO = ID[4,99]

VAL = RBO.getProperty('','VISITED_FLG',VISITED.MOD.FLG) ;* THIS FLAG INDICATES WHICH MODULES ARE VISITED -- 1-RS,RS 2-FG 3-GANG

MATREAD JOB.REC FROM JOB,ID ELSE
  MAT JOB.REC = ''
END

OJFS.PROD = ""
OJFS.WHSE = ""
OJFS.ORDER = ""
OJFS.ORD.QTY = ""

MATREAD JFS.REC FROM JOB.FNGD.STATS, ID THEN
	OJFS.PROD = JFS.PROD; OJFS.WHSE = JFS.WHSE
	OJFS.ORDER = JFS.ORDER; OJFS.ORD.QTY = JFS.ORD.QTY
END ELSE
  	MAT JFS.REC = ''
END

VAL = RBO.getProperty('','SAVE_INV_JS_REC',SAVE.INV.JS.REC)
SAVE.INV.JS.REC = RAISE(SAVE.INV.JS.REC)
IF VISITED.MOD.FLG<1,1> = 0 THEN ;* EXTRACT RS AND RD DATA
	PCNT=DCOUNT(JOB.RESV.MATL,VM)
	UMS=''; MATL.TYPE='';ALLOCATED=''; RESERVED=''; USED='';RSV.SERIAL=''
	CONV.FRMT = "";REQD.DATE = ""
	REQD.PRICE = "";REQD.QTY = "";BALANCE = "";RESERVED = "";USED = "";PROD_DESC = ""
	MVSTR = ""
	FOR P = 1 TO PCNT
		MVSTR<1,P> = ""
		MATREAD INV.REC FROM INVENTORY,CONO:JOB.RESV.MATL<1,P> ELSE
    			INV.FULL.DESC = 'Unknown'
		END
		PROD_DESC<1,P> = INV.FULL.DESC
	  	$INCLUDE ICSBP INV.UM.CNV
  		ROND=''; LN=''
	  	UMS<1,P> = INV.UNIT<1,2>
  		MATL.TYPE<1,P> = INV.PAP.TYPE
	  	*IF MATL.TYPE<1,P> = 'REGULAR' THEN MATL.TYPE<1,P> = 'REGULR'
  		ALLOCATED<1,P> = CALC_STK_QTY(JOB.ALOC.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
	
		ALLOCATED<1,P> = OCONV(ALLOCATED<1,P>,ICR.CNV)
  		RESERVED<1,P> = CALC_STK_QTY(JOB.RESV.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
	  	RESERVED<1,P> = OCONV(RESERVED<1,P>,ICR.CNV)
  		USED<1,P> = CALC_STK_QTY(JOB.USED.QTY<1,P>,MAT INV.CNV.REC,ROND,LN)
	  	USED<1,P> = OCONV(USED<1,P>,ICR.CNV)

		IF JOB.RESV.QTY<1,P>+0 > 0 THEN
    			MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE THEN
      				IF CATG.RSV.SERIAL = 'Y' THEN
        				RSV.SERIAL<1,P>='Y'
	      			END
    			END
	  	END

	  	IF RSV.SERIAL<1,P> # 'Y' THEN RSV.SERIAL<1,P> = 'N'
  		JSTAT.ID = JOB.RESV.MATL<1,P>:"!":JOB.RESV.WHSE<1,P>:"!":JOB_NO
		MATREAD INV.JS.REC FROM INV.JOB.STATS,CONO:JSTAT.ID ELSE
  			MAT INV.JS.REC = ''
		END
              IF SAVE.INV.JS.REC<P> = '' THEN
			SAVE.INV.JS.REC<P,RQD.DATE.MV> = IJS.REQ.DATE
			SAVE.INV.JS.REC<P,RQD.AMT.MV> = IJS.REQ.AMT
			SAVE.INV.JS.REC<P,RQD.QTY.MV> = IJS.REQ.QTY
		END

		REQD.DATE<1,P> = OCONV(SAVE.INV.JS.REC<P,RQD.DATE.MV>,'D2/')
  		REQD.PRICE<1,P> = OCONV(SAVE.INV.JS.REC<P,RQD.AMT.MV>,'MD4')
              
              REQD.QTY<1,P> =INT(((SAVE.INV.JS.REC<P,RQD.QTY.MV>/ICR.MT1<LN>)*ICR.DV1<LN>)*ICR.DV2<LN> + .5)
	  	*REQD.QTY<1,P> = CALC_STK_QTY(SAVE.INV.JS.REC<P,RQD.QTY.MV>,MAT INV.CNV.REC,ROND,LN)
  		*REQD.QTY<1,P> = OCONV(REQD.QTY<1,P>,ICR.CNV)
	  	*BALANCE<1,P> = SAVE.INV.JS.REC<P,RQD.QTY.MV> - JOB.ALOC.QTY<1,P> - JOB.RESV.QTY<1,P> - JOB.USED.QTY<1,P>
  		BALANCE<1,P> = REQD.QTY<1,P> - ALLOCATED<1,P> - RESERVED<1,P> - USED<1,P>
		IF BALANCE<1,P> < 0 THEN BALANCE<1,P> = 0
		*T469 IF (INDEX(BALANCE<1,P>:" ",".",1) = 0) AND ICR.CNV = 'MD2' THEN
			IF (INDEX(BALANCE<1,P>:" ",".",1) = 0 AND ICR.CNV = 'MD2') THEN
	  		BALANCE<1,P> = BALANCE<1,P> : ".00"
		END
		*BALANCE<1,P> = CALC_STK_QTY(BALANCE<1,P>,MAT INV.CNV.REC,ROND,LN)
	 	*BALANCE<1,P> = BALANCE<1,P>
		CONV.FRMT<1,P> = ICR.CNV
	NEXT P
	STATUS=RBO.setProperty('','JOB_RESV_MATL',JOB.RESV.MATL)
	STATUS=RBO.setProperty('','JOB_RESV_WHSE',JOB.RESV.WHSE)
	STATUS=RBO.setProperty('','RESV_MATL_TYPE',MATL.TYPE)
	STATUS=RBO.setProperty('','JOB_RESV_DATE',JOB.RESV.DATE)
	STATUS=RBO.setProperty('','RESV_MATL_UM',UMS)
	STATUS=RBO.setProperty('','JOB_ALOC_QTY',ALLOCATED)
	STATUS=RBO.setProperty('','JOB_RESV_QTY',RESERVED)
	STATUS=RBO.setProperty('','JOB_USED_QTY',USED)
	STATUS=RBO.setProperty('','REQD_DATE',REQD.DATE);* THIS IS FOR REQUIRED PROCESSING
	STATUS=RBO.setProperty('','REQD_PRICE',REQD.PRICE);* unit price THIS IS FOR REQUIRED PROCESSING
	STATUS=RBO.setProperty('','RSV_REQD_QTY',REQD.QTY);* THIS IS FOR REQUIRED PROCESSING
	STATUS=RBO.setProperty('','RSV_BALANCE',BALANCE);* THIS IS FOR REQUIRED PROCESSING

*T469	VAL = RBO.setProperty('','RESV_USED_QTY',MVSTR)
*T469	VAL = RBO.setProperty('','RSV_SERIAL',MVSTR)
*T469	VAL = RBO.setProperty('','SRESV_SERIAL',MVSTR)
*T469	VAL = RBO.setProperty('','SUB_FLAG',MVSTR)
*T469	VAL = RBO.setProperty('','USER_ID',MVSTR)
*T469	VAL = RBO.setProperty('','USER_WHSE_CODE',MVSTR)
*T469	VAL = RBO.setProperty('','DEPT_CODES',MVSTR)
*T469	VAL = RBO.setProperty('','DEPT_DESCS',MVSTR)
END

IF VISITED.MOD.FLG<1,2> = 0 THEN ;* EXTRACT FNGD DATA
	MATREAD JFS.REC FROM JOB.FNGD.STATS, ID ELSE MAT JFS.REC = ""
	PCNT=DCOUNT(JFS.PROD,@VM) ;* LIST OF FININSHED GOODS PRODUCTS
	PRODDESCS=''; UMS=''
	BALANCE=''
	F.QTY = JFS.F.QTY 
	S.QTY = JFS.S.QTY 
	FOR P = 1 TO PCNT
		MATREAD INV.REC FROM INVENTORY,CONO:JFS.PROD<1,P> ELSE
    			INV.FULL.DESC = 'Unknown'
	  	END
		$INCLUDE ICSBP INV.UM.CNV
  		ROND=''; LN=''
	  	UMS<1,P> = INV.UNIT<1,2>
		JFS.U.PRICE<1,P> = OCONV(JFS.U.PRICE<1,P>,"MD4")
		JFS.DATE<1,P> = OCONV(JFS.DATE<1,P>,"D2/")
  		*IF BALANCE<1,P> < 0 THEN BALANCE<1,P> = 0
	  	*BALANCE<1,P> = CalcStkQty(BALANCE<1,P>,MAT INV.CNV.REC,ROND,P)
  		JFS.M.QTY<1,P> = OCONV(INT(((JFS.M.QTY<1,P>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		JFS.A.QTY<1,P> = OCONV(INT(((JFS.A.QTY<1,P>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		JFS.F.QTY<1,P> = OCONV(INT(((JFS.F.QTY<1,P>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		JFS.S.QTY<1,P> = OCONV(INT(((JFS.S.QTY<1,P>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		CNT1 = DCOUNT(JFS.ORD.QTY<1,P>,SM)
		FOR I = 1 TO CNT1
			JFS.ORD.QTY<1,P,I> = OCONV(INT(((JFS.ORD.QTY<1,P,I>/ICR.DV1)*ICR.MT1)/ICR.DV2+.5),ICR.CNV)
		NEXT I
		IF JOB.STATUS<1,1> = 4 OR JOB.STATUS<1,1> > 5 THEN
    			BALANCE<1,P> = 0
	  	END ELSE
    			BALANCE<1,P> = JFS.M.QTY<1,P> - JFS.F.QTY<1,P> - JFS.S.QTY<1,P>
	  	END
		IF BALANCE<1,P> < 0  THEN BALANCE<1,P> = 0
		
	NEXT P

	STATUS=RBO.setProperty('','RET_PROD_LIST',JFS.PROD)
	STATUS=RBO.setProperty('','RET_WHSE_LIST',JFS.WHSE)
	STATUS=RBO.setProperty('','JFS_UMS',UMS)
	STATUS=RBO.setProperty('','JFS_U_PRICE',JFS.U.PRICE)
	STATUS=RBO.setProperty('','JFS_M_QTY',JFS.M.QTY)
	STATUS=RBO.setProperty('','JFS_DATE',JFS.DATE)
	
	STATUS=RBO.setProperty('','JFS_A_QTY',JFS.A.QTY)
	STATUS=RBO.setProperty('','JFS_O_QTY',JFS.ORD.QTY)
	STATUS=RBO.setProperty('','JFS_F_QTY',JFS.F.QTY)
	STATUS=RBO.setProperty('','JFS_S_QTY',JFS.S.QTY)
	STATUS=RBO.setProperty('','JFS_ORDER',JFS.ORDER)
	STATUS=RBO.setProperty('','JFS_BAL',BALANCE)

	*STATUS=RBO.setProperty('','CustomerCodes',JFS.PROD)
	*STATUS=RBO.setProperty('','CustomerDescs',JFS.WHSE)
	*STATUS=RBO.setProperty('','WarehouseCodes',JFS.ORDER)
	*STATUS=RBO.setProperty('','WarehouseDescs',JFS.ORD.QTY)
END

IF VISITED.MOD.FLG<1,3> = 0 THEN ;* EXTRACT GANG DATA
	MATREAD GJOB.REC FROM GANG.JOB,ID ELSE MAT GJOB.REC = ''
	LINES = DCOUNT(GJOB.JOB,VM)
	TOT.AREA = INT(GJOB.IW / 10 * GJOB.IL / 10 + 0.5)
	CALC.AREA = 0
	FOR CREF = 1 TO LINES
		CALC.AREA = CALC.AREA + INT(GJOB.WIDTH<1,CREF> / 1000 * GJOB.LENGTH<1,CREF> / 1000 * GJOB.SPOTS<1,CREF> + 0.5)
		GJOB.WIDTH<1,CREF> = OCONV(GJOB.WIDTH<1,CREF>,"MD4")
		GJOB.LENGTH<1,CREF> = OCONV(GJOB.LENGTH<1,CREF>,"MD4")
	NEXT CREF
	CALC.AREA = INT(CALC.AREA/100+0.5)
	TOTAL = SUM(GJOB.SPOTS)
	IF TOT.AREA = 0 THEN
		TOT.AREA = ""
	END ELSE
		TOT.AREA = INT((1-(CALC.AREA/TOT.AREA))*10000+0.5)
	END
	INV_PAP_WIDTH = ""
	INV_PAP_LEN = ""
	STAT.DESC = ""
	CNT = DCOUNT(GJOB.PROD,VM)
	PROD_DESCS = ""
	FOR I = 1 TO CNT
		MATREAD INV.REC FROM INVENTORY,CONO:GJOB.PROD<1,I> ELSE
			MAT INV.REC = ''
		END
		PROD_DESCS<1,I> = INV.DESC
		INV_PAP_WIDTH<1,I> = OCONV(INV.PAP.WIDTH+0,"MD4")
		INV_PAP_LEN<1,I> = OCONV(INV.PAP.LEN+0,"MD4")
       	MATREAD JOB.REC FROM JOB,CONO:GJOB.JOB<1,I> ELSE
			MAT JOB.REC = ''
		END
	       *CALL JOB.STATUS.SUB(JOB.STATUS<1,1>,JOB.TRACK.DATE,STATUS)
		*STAT.DESC<1,I> = JOBM_STATUS_SUB(JOB.STATUS<1,1>)
	NEXT I

	STATUS=RBO.setProperty('','ShipViaDescs',GJOB.JOB)
	STATUS=RBO.setProperty('','ShipViaCodes',GJOB.PROD)
	STATUS=RBO.setProperty('','SalesPersonDescs',GJOB.WIDTH)
	STATUS=RBO.setProperty('','SalesPersonCodes',GJOB.LENGTH)
	STATUS=RBO.setProperty('','SalesDescs',GJOB.SPOTS)
	STATUS=RBO.setProperty('','SalesCodes',GJOB.PCT)

	STATUS=RBO.setProperty('','Ums',OCONV(GJOB.IW,"MD2"))
	STATUS=RBO.setProperty('','STATUS',OCONV(GJOB.IL,"MD2"))

	STATUS=RBO.setProperty('','JobCodes',GJOB.ALLOC)
	STATUS=RBO.setProperty('','JobDescs',GJOB.DESC)
	*STATUS=RBO.setProperty('','ORIG_CUST',GJOB.ID)
END

*T469 MATREAD JOB.REC FROM JOB,ID ELSE MAT JOB.REC = ''
MATREADU JOB.REC FROM JOB,ID ELSE MAT JOB.REC = ''
CONO = ID[1,3]
JOBNO = ID[4,99]

MATREAD GJOB.REC FROM GANG.JOB,ID ELSE MAT GJOB.REC = ''


VAL = RBO.getProperty('','CUST_NAME',OLD.CUST) ;* OLD.CUST
IF OLD.CUST = 0 THEN OLD.CUST = ""
VAL = RBO.getProperty('','JOB_SALS_NAME',OLD.MASTER) ;* OLD.JOB.MASTER
IF OLD.MASTER = 0 THEN OLD.MASTER = ""
VAL = RBO.getProperty('','JOB_MASTER',JOB.MASTER) ;* OLD.JOB.MASTER
IF JOB.MASTER = 0 THEN JOB.MASTER = ""
VAL = RBO.getProperty('','STAT',JOB.STATUS) ;* MULTIVALUED
VAL = RBO.getProperty('','FLG',FLG) ;* indicated Old Job/New Job
VAL = RBO.getProperty('','JOB_WIP',JOB.WIP)
VAL = RBO.getProperty('','EST_PAR',EST.PAR.TEMP)


EST.PAR(1) = EST.PAR.TEMP<1,1>
EST.PAR(2) = EST.PAR.TEMP<1,2>
EST.PAR(3) = EST.PAR.TEMP<1,3>
EST.PAR(4) = EST.PAR.TEMP<1,4>
EST.PAR(5) = EST.PAR.TEMP<1,5>

CNT = DCOUNT(JOB.WIP<1,2>,@SVM)
FOR I = 1 TO CNT
	JOB.WIP<1,2,I> = ICONV(JOB.WIP<1,2,I>,"MD2")
NEXT I

CNT = DCOUNT(JOB.WIP<1,3>,@SVM)
FOR I = 1 TO CNT
	JOB.WIP<1,3,I> = ICONV(JOB.WIP<1,3,I>,"MD2")
NEXT I

VAL = RBO.getProperty('','JOB_RESV_MATL',JOB.RESV.MATL) ;* LIST OF PRODUCTS RESERVED
VAL = RBO.getProperty('','JOB_RESV_WHSE',JOB.RESV.WHSE) 
VAL = RBO.getProperty('','RESV_MATL_TYPE',RESV.MATL.TYPE)
VAL = RBO.getProperty('','JOB_RESV_DATE',JOB.RESV.DATE)
VAL = RBO.getProperty('','RESV_MATL_UM',RESV.MATL.UM)
VAL = RBO.getProperty('','JOB_ALOC_QTY',JOB.ALOC.QTY)
VAL = RBO.getProperty('','JOB_RESV_QTY',JOB.RESV.QTY)
VAL = RBO.getProperty('','JOB_USED_QTY',JOB.USED.QTY)
VAL = RBO.getProperty('','JOB_ALOC_AMT',JOB.ALOC.AMT)
VAL = RBO.getProperty('','JOB_RESV_AMT',JOB.RESV.AMT)
VAL = RBO.getProperty('','JOB_USED_AMT',JOB.USED.AMT)
VAL = RBO.getProperty('','JOB_STAT_DATE',JOB.STAT.DATE)
VAL = RBO.getProperty('','JOB_CUST',JOB.CUST)
IF JOB.CUST = 0 THEN JOB.CUST = ""
VAL = RBO.getProperty('','JOB_SUBS',JOB.SUBS)
VAL = RBO.getProperty('','JOB_CREDIT',JOB.CREDIT)

VAL = RBO.getProperty('','REQD_DATE',IJS.REQ.DATE)
VAL = RBO.getProperty('','REQD_PRICE',IJS.REQ.AMT);*UNIT PRICE
VAL = RBO.getProperty('','RSV_REQD_QTY',IJS.REQ.QTY)
VAL = RBO.getProperty('','RSV_BALANCE',REQD.BALANCE)
VAL = RBO.getProperty('','JOB_PRICE_PER_THOU',JOB.PRICE.PER.THOU)

JOB.PRICE.PER.THOU = ICONV(JOB.PRICE.PER.THOU,'MD2')

RQD.DATE.MV = 1
RQD.AMT.MV = 2
RQD.QTY.MV = 3

COUNT = DCOUNT(JOB.RESV.MATL,VM)
INV.UNIT = ""
INV.PAP.WIDTH = ""
INV.M.LINE = ""
INV.M.WT = ""
INV.COST.WT = ""

VAL = RBO.getProperty('','RESV_USED_QTY',SRESV.PRWHSE)
VAL = RBO.getProperty('','RSV_SERIAL',SRESV.RECP)
VAL = RBO.getProperty('','SRESV_SERIAL',SRESV.SERIAL)

VAL = RBO.getProperty('','SUB_FLAG',SRESV.QTY)
VAL = RBO.getProperty('','USER_ID',SRESV.UN.COST)
VAL = RBO.getProperty('','USER_WHSE_CODE',SRESV.RECP.DATE)
VAL = RBO.getProperty('','DEPT_CODES',SRESV.AVAIL)
VAL = RBO.getProperty('','DEPT_DESCS',SRESV.OLD.QTY)

*STATUS = RBO.setProperty('','ENTERED_AMT','MY TEXT 1- ' : SRESV.QTY)
PORT.NO = 'TTY'
CALL SYSVARS.SUB(PORT.NO)
OPER.ID = OCONV(PORT.NO,'MCN'):"!":USERID
IF JOB.CREDIT <> "" THEN
    JOB.CREDIT=JOB.CREDIT:"!":OPER.ID
END

FOR L = 1 TO COUNT
	MATREAD TEMP.INV.REC FROM INVENTORY,CONO:JOB.RESV.MATL<1,L> ELSE
		MAT TEMP.INV.REC = ''
	END
	INV.M.LINE 	= TEMP.INV.REC(4)
	INV.UNIT 	= TEMP.INV.REC(21)
	INV.COST.WT	= TEMP.INV.REC(22)
	INV.M.WT 	= TEMP.INV.REC(23)
       INV.PAP.WIDTH	= TEMP.INV.REC(33)
	$INCLUDE ICSBP INV.UM.CNV
	
	JSTAT.ID = JOB.RESV.MATL<1,P>:"!":JOB.RESV.WHSE<1,P>:"!":JOBNO
	MATREAD INV.JS.REC FROM INV.JOB.STATS,CONO:JSTAT.ID ELSE
  		MAT INV.JS.REC = ''
	END
	
	IF SAVE.INV.JS.REC<L> = '' THEN
		SAVE.INV.JS.REC<L,RQD.DATE.MV> 	= ICONV(IJS.REQ.DATE<1,L>,'D2/')
		SAVE.INV.JS.REC<L,RQD.AMT.MV> 	= ICONV(IJS.REQ.AMT<1,L>,'MD4')
		SAVE.INV.JS.REC<L,RQD.QTY.MV> 	= ICONV((((IJS.REQ.QTY<1,L>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
 	END
	JOB.ALOC.QTY<1,L> = ICONV((((JOB.ALOC.QTY<1,L>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JOB.RESV.QTY<1,L> = ICONV((((JOB.RESV.QTY<1,L>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JOB.USED.QTY<1,L> = ICONV((((JOB.USED.QTY<1,L>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)

	CNT = DCOUNT(SRESV.RECP.DATE<1,L>,SVM)
	FOR I = 1 TO CNT
		IF SRESV.RECP.DATE<1,L,I> # "" THEN SRESV.RECP.DATE<1,L,I> = ICONV(SRESV.RECP.DATE<1,L,I>,'D2/')		
		IF SRESV.QTY<1,L,I> # "" THEN SRESV.QTY<1,L,I> = ICONV((((SRESV.QTY<1,L,I>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
		IF SRESV.UN.COST<1,L,I> # "" THEN SRESV.UN.COST<1,L,I> = ICONV(SRESV.UN.COST<1,L,I>,"MD4")
		IF SRESV.AVAIL<1,L,I> # "" THEN SRESV.AVAIL<1,L,I> = ICONV((((SRESV.AVAIL<1,L,I>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
		IF SRESV.OLD.QTY<1,L,I> # "" THEN SRESV.OLD.QTY<1,L,I> = ICONV((((SRESV.OLD.QTY<1,L,I>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	NEXT I
NEXT L
*STATUS = RBO.setProperty('','ServerMessage','MY TEXT 2- ' : SRESV.QTY)
*RETURN


*VAL = RBO.getProperty('','CustomerCodes',OJFS.PROD)
*VAL = RBO.getProperty('','CustomerDescs',OJFS.WHSE)
*VAL = RBO.getProperty('','WarehouseCodes',OJFS.ORDER)
*VAL = RBO.getProperty('','WarehouseDescs',OJFS.ORD.QTY)

VAL = RBO.getProperty('','RET_PROD_LIST',JFS.PROD) ;* LIST OF FNGD PRODUCTS
VAL = RBO.getProperty('','RET_WHSE_LIST',JFS.WHSE)
VAL = RBO.getProperty('','JFS_UMS',JFS.UMS)
VAL = RBO.getProperty('','JFS_U_PRICE',JFS.U.PRICE)
VAL = RBO.getProperty('','JFS_M_QTY',JFS.M.QTY)
VAL = RBO.getProperty('','JFS_DATE',JFS.DATE)
VAL = RBO.getProperty('','JFS_A_QTY',JFS.A.QTY)
VAL = RBO.getProperty('','JFS_O_QTY',JFS.ORD.QTY)
VAL = RBO.getProperty('','JFS_F_QTY',JFS.F.QTY)
VAL = RBO.getProperty('','JFS_S_QTY',JFS.S.QTY)
VAL = RBO.getProperty('','JFS_ORDER',JFS.ORDER)
VAL = RBO.getProperty('','JFS_BAL',JFS.BAL)

COUNT = DCOUNT(JFS.PROD,VM)
FOR M = 1 TO COUNT
	MATREAD TEMP.INV.REC FROM INVENTORY,CONO:JFS.PROD<1,M> ELSE
		MAT TEMP.INV.REC = ''
	END
	INV.M.LINE = TEMP.INV.REC(4)
	INV.UNIT = TEMP.INV.REC(21)
	INV.M.WT = TEMP.INV.REC(23)
       INV.PAP.WIDTH = TEMP.INV.REC(33)
	INV.COST.WT	= TEMP.INV.REC(22)
	$INCLUDE ICSBP INV.UM.CNV

	JFS.M.QTY<1,M> = ICONV((((JFS.M.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JFS.A.QTY<1,M> = ICONV((((JFS.A.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JFS.F.QTY<1,M> = ICONV((((JFS.F.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	JFS.S.QTY<1,M> = ICONV((((JFS.S.QTY<1,M>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	CNT1 = DCOUNT(JFS.ORD.QTY<1,M>,SM)
	FOR I = 1 TO CNT1
		JFS.ORD.QTY<1,M,I> = ICONV((((JFS.ORD.QTY<1,M,I>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	NEXT I
	JFS.U.PRICE<1,M> = ICONV(JFS.U.PRICE<1,M>,'MD4')
NEXT M

VAL = RBO.getProperty('','JOB_TOT_INV',JOB.TOT.INV)
VAL = RBO.getProperty('','JOB_CONF_AMT',JOB.CONF.AMT)

JOB.CONF.AMT = ICONV(JOB.CONF.AMT,'MD2')

VAL = RBO.getProperty('','CNV_FORMAT',PREV.CRED.AUTH)
VAL = RBO.getProperty('','ACTION',CUR.ORD.BAL)
VAL = RBO.getProperty('','CO_POS',CUR.JOB.BAL)
VAL = RBO.getProperty('','JOB_DIV',JOB.DIV)
VAL = RBO.getProperty('','JOB_SLSMN',JOB.SLSMN)
IF JOB.SLSMN = 0 THEN JOB.SLSMN = ""
VAL = RBO.getProperty('','JOB_CSR',JOB.CSR)
IF JOB.CSR = 0 THEN JOB.CSR = ""
VAL = RBO.getProperty('','JOB_TYPE',JOB.TYPE)
IF JOB.TYPE = 0 THEN JOB.TYPE = ""
VAL = RBO.getProperty('','JOB_SALES_CODE',JOB.SALES.CODE)
IF JOB.SALES.CODE = 0 THEN JOB.SALES.CODE = ""
VAL = RBO.getProperty('','JOB_CATG',JOB.CATG)
IF JOB.CATG = 0 THEN JOB.CATG = ""
VAL = RBO.getProperty('','JOB_SHIP_VIA',JOB.SHIP.VIA)
IF JOB.SHIP.VIA = 0 THEN JOB.SHIP.VIA = ""
VAL = RBO.getProperty('','JOB_CUST_PO',JOB.CUST.PO)
VAL = RBO.getProperty('','JOB_EST_COST',JOB.EST.COST)
JOB.EST.COST = ICONV(JOB.EST.COST,'MD2')
VAL = RBO.getProperty('','JOB_EST_SALE',JOB.EST.SALE)
JOB.EST.SALE = ICONV(JOB.EST.SALE,'MD2')


VAL = RBO.getProperty('','JOB_MARKUP',JOB.MARKUP)
JOB.MARKUP = ICONV(JOB.MARKUP,'MD2')
VAL = RBO.getProperty('','JOB_COLORS',JOB.COLORS)
VAL = RBO.getProperty('','JOB_ORD_QTY',JOB.ORD.QTY)
VAL = RBO.getProperty('','JOB_FIN_QTY',JOB.FIN.QTY)
VAL = RBO.getProperty('','JOB_SHP_QTY',JOB.SHP.QTY)
JOB.QTY = ""
JOB.QTY<1,1> = JOB.ORD.QTY
JOB.QTY<1,2> = JOB.FIN.QTY
JOB.QTY<1,3> = JOB.SHP.QTY

VAL = RBO.getProperty('','JOB_DUE_DATE',JOB.DUE.DATE)
JOB.DUE.DATE = ICONV(JOB.DUE.DATE,'D4')
*JOB.DUE.DATE = OCONV(JOB.DUE.DATE,'D2')

VAL = RBO.getProperty('','JOB_TRACK_DATE',JOB.TRACK.DATE)

CNT = DCOUNT(JOB.TRACK.DATE<1>,VM)
FOR I = 1 TO CNT
	JOB.TRACK.DATE<1,I> = ICONV(JOB.TRACK.DATE<1,I>,'D4')
NEXT I

VAL = RBO.getProperty('','JOB_PRIOR_JOB',JOB.PRIOR.JOB)
VAL = RBO.getProperty('','JOB_FIN_QTY',JOB.FIN.QTY)
VAL = RBO.getProperty('','JOB_SHP_QTY',JOB.SHP.QTY)
VAL = RBO.getProperty('','JOB_PRIOR_JOB',JOB.PRIOR.JOB)
VAL = RBO.getProperty('','JOB_COMMENTS',JOB.COMMENTS)
VAL = RBO.getProperty('','JOB_DESC',JOB.DESC)
VAL = RBO.getProperty('','CO_JIS',OLD.EST)
VAL = RBO.getProperty('','JOB_OP_NUM',NEW.EST)
VAL = RBO.getProperty('','JOB_EST',JOB.EST)
IF JOB.EST = 0 THEN JOB.EST = ""
VAL = RBO.getProperty('','CREDIT_FLAG',EST.MATL)

*T469 VAL = RBO.getProperty('','ShipViaDescs',GJOB.JOB)
*VAL = RBO.getProperty('','ShipViaDescs',GJOB.JOB)

VAL = RBO.getProperty('','ShipViaCodes',GJOB.PROD)
VAL = RBO.getProperty('','SalesPersonDescs',GJOB.WIDTH)
VAL = RBO.getProperty('','SalesPersonCodes',GJOB.LENGTH)
VAL = RBO.getProperty('','SalesDescs',GJOB.SPOTS)
VAL = RBO.getProperty('','SalesCodes',GJOB.PCT)
VAL = RBO.getProperty('','Ums',GJOB.IW)
VAL = RBO.getProperty('','STATUS',GJOB.IL)
VAL = RBO.getProperty('','JobCodes',GJOB.ALLOC)
VAL = RBO.getProperty('','JobDescs',GJOB.DESC)
VAL = RBO.getProperty('','JobCategoryDescs',GJOB.DEPT)
VAL = RBO.getProperty('','JobCategoryCodes',GJOB.CCTR)
VAL = RBO.getProperty('','JOB_OP_VEND',GJOB.TYPE)
VAL = RBO.getProperty('','CUST_CREDIT',OPTVAL);* THIS IS MULTI-VALUED FOR JOB.BOOK.SUB INPUT PARAMETERS

GJOB.IW = ICONV(GJOB.IW,"MD2")
GJOB.IL = ICONV(GJOB.IL,"MD2")

LINES = DCOUNT(GJOB.JOB,VM)
FOR CREF = 1 TO LINES
	GJOB.WIDTH<1,CREF> = ICONV(GJOB.WIDTH<1,CREF>,"MD4")
	GJOB.LENGTH<1,CREF> = ICONV(GJOB.LENGTH<1,CREF>,"MD4")
NEXT CREF

MATREAD EST.REC FROM ESTIMATE,CONO:JOB.EST ELSE
	MAT EST.REC = ''
END

MATREAD COMP.REC FROM COMPANY,CONO ELSE
	MAT COMP.REC = ''
END

MATREAD CUST.REC FROM CUSTOMER,CONO:JOB.CUST ELSE
	MAT CUST.REC = ''
END

QUOTED.AMT = 0
IF JOB.STATUS<1,1> < 4 AND JFS.PROD = "" OR JOB.STATUS<1,1> = 5 THEN
	LOCATE "4" IN JOB.STATUS<1>,1 SETTING DUMMY ELSE
       	IF JOB.TOT.INV > 0 THEN
             		QUOTED.AMT = JOB.CONF.AMT - JOB.TOT.INV
           	END ELSE
             		QUOTED.AMT = JOB.CONF.AMT
           	END
           	IF QUOTED.AMT < 0 THEN QUOTED.AMT = 0
	END
END
IF JOB.MASTER = "" OR JOB.MASTER = "N" THEN
	JOB.MASTER = JOBNO
END
IF OLD.MASTER = "" OR OLD.MASTER = "N" THEN
	OLD.MASTER = JOB.MASTER
END

IF OLD.CUST = "" THEN OLD.CUST = JOB.CUST

CUR.CUST = JOB.CUST
CUR.MASTER = JOB.MASTER
MAT SAVE.JOB = MAT JOB.REC

IF OLD.MASTER = CUR.MASTER THEN GOTO 502
MATREADU JOB.REC FROM JOB, CONO : OLD.MASTER ELSE
	GOTO 502
END

LOCATE JOBNO IN JOB.SUBS<1>,1 SETTING JFND ELSE
	RELEASE JOB, CONO : OLD.MASTER
       GOTO 502
END


JOB.SUBS = DELETE(JOB.SUBS,1,JFND,0)
MATWRITE JOB.REC ON JOB, CONO : OLD.MASTER

502

IF OLD.CUST = CUR.CUST THEN GOTO 503
MATREADU CUST.REC FROM CUSTOMER, CONO : OLD.CUST ELSE
     	GOTO 503
END
LOCATE JOBNO IN CUST.JOB<1>,1 SETTING JFND ELSE
      	RELEASE CUSTOMER, CONO : OLD.CUST
      	GOTO 503
END
CUST.JOB = DELETE(CUST.JOB,1,JFND,0)
CUST.JOB.BAL = DELETE(CUST.JOB.BAL,1,JFND,0)
MATWRITE CUST.REC ON CUSTOMER , CONO:OLD.CUST

503
IF CUR.MASTER = JOBNO THEN GOTO 504
MATREADU JOB.REC FROM JOB, CONO : CUR.MASTER ELSE
     	GOTO 505
END

IF JOB.CUST # CUR.CUST THEN
	GOTO 505
END
IF JOB.MASTER = "" OR JOB.MASTER = "N" THEN
	JOB.MASTER = CUR.MASTER
END

IF JOB.MASTER # CUR.MASTER THEN
	RELEASE JOB, CONO : CUR.MASTER
	GOTO 505
END
LOCATE JOBNO IN JOB.SUBS<1>,1 SETTING SFND ELSE
	JOB.SUBS<1,SFND> = JOBNO
END

504
MATREADU CUST.REC FROM CUSTOMER, CONO : CUR.CUST ELSE
	IF CUR.MASTER = JOBNO THEN GOTO 505
       RELEASE JOB, CONO : CUR.MASTER
505    IF OLD.MASTER = CUR.MASTER THEN GOTO 506
       MATREADU JOB.REC FROM JOB, CONO : OLD.MASTER ELSE GOTO 506
       LOCATE JOBNO IN JOB.SUBS<1>,1 SETTING JFND ELSE NULL
       JOB.SUBS<1,JFND> = JOBNO
       MATWRITE JOB.REC ON JOB, CONO : OLD.MASTER
506    MAT JOB.REC = MAT SAVE.JOB
       IF OLD.CUST = CUR.CUST THEN GOTO 519
       MATREADU CUST.REC FROM CUSTOMER, OLD.CUST ELSE GOTO 519
       LOCATE JOBNO IN CUST.JOB<1>,1 SETTING JFND ELSE NULL
       CUST.JOB<1,JFND> = JOBNO
       CUST.JOB.BAL<1,JFND> = QUOTED.AMT
       MATWRITE CUST.REC ON CUSTOMER, CONO : OLD.CUST
       GOTO 519
END

IF CUR.MASTER # JOBNO THEN
	MATWRITE JOB.REC ON JOB, CONO : CUR.MASTER
END

MAT JOB.REC = MAT SAVE.JOB

LOCATE JOBNO IN CUST.JOB<1>,1 SETTING JFND ELSE NULL
CUST.JOB<1,JFND> = JOBNO
CUST.JOB.BAL<1,JFND> = QUOTED.AMT
MATWRITE CUST.REC ON CUSTOMER , CONO : CUR.CUST
MCNT = COUNT(JOB.RESV.MATL,VM) + (JOB.RESV.MATL # "")

IF SAVE.INV.JS.REC = "" THEN GOTO 507

FOR M = 1 TO MCNT
	JSTAT.ID = JOB.RESV.MATL<1,M>:"!":JOB.RESV.WHSE<1,M>:"!":JOBNO
       MATREADU INV.JS.REC FROM INV.JOB.STATS,CONO:JSTAT.ID ELSE
       	MAT INV.JS.REC = ""
	END
       IJS.JOB.CUST = JOB.CUST
       IJS.REQ.DATE = SAVE.INV.JS.REC<M,1>
       IJS.REQ.AMT = SAVE.INV.JS.REC<M,2>
       MATREAD INV.REC FROM INVENTORY,CONO:JOB.RESV.MATL<1,M> THEN
          GOSUB CHKREC
       END
       IJS.REQ.QTY =INT((( SAVE.INV.JS.REC<M,3>/ICR.MT1<LN>)*ICR.DV1<LN>)*ICR.DV2<LN> + .5)
       MATWRITE INV.JS.REC ON INV.JOB.STATS,CONO:JSTAT.ID
NEXT M

507*
RESV.ACTION = "A"

GOSUB 600

MATREADU JOCS.REC FROM JOB.CREDIT.STATS,CONO:JOBNO ELSE MAT JOCS.REC=""
IF PREV.CRED.AUTH = JOB.CREDIT THEN
	RELEASE JOB.CREDIT.STATS,CONO:JOBNO
       GOTO 509
END
AVAIL = ""
BEGIN CASE
	CASE CUST.CREDIT = "E"
       	AVAIL = CUST.CR.LIMIT * 100 - CUST.AR.BAL - CUR.JOB.BAL - QUOTED.AMT
	CASE CUST.CREDIT = "CASH"
       	AVAIL = CUST.AR.BAL + CUR.JOB.BAL + QUOTED.AMT
END CASE
JOCS.CRED.CODE = INSERT(JOCS.CRED.CODE,1,1,0,CUST.CREDIT)
JOCS.CRED.AUTH = INSERT(JOCS.CRED.AUTH,1,1,0,JOB.CREDIT)
JOCS.CUST.NO = INSERT(JOCS.CUST.NO,1,1,0,JOB.CUST)
JOCS.CRED.AVAIL = INSERT(JOCS.CRED.AVAIL,1,1,0,AVAIL)
JOCS.CRED.LIMIT = INSERT(JOCS.CRED.LIMIT,1,1,0,CUST.CR.LIMIT)
JOCS.CHG.DATE = INSERT(JOCS.CHG.DATE,1,1,0,DATE())
MATWRITE JOCS.REC ON JOB.CREDIT.STATS, CONO:JOBNO
509*

*CALL JKT_NOTIFY_SUB("1",CONO,"JOB",JOBNO,"",JOB.REC.SIZE,MAT JOB.REC,JOB,JSTATUS)

MATWRITE JOB.REC ON JOB , CONO : JOBNO
READ SISQUEUE FROM CONTROL, CONO:"SISQUEUE" THEN
	CALL SISQUEUE (CONO, JOBNO, "JOB", SIS_CONTROL, SIS_OUTPUT, SISERRMSG)
END ELSE
	CALL HNP.UPDATE(CONO, CONO:JOBNO, "JOB", JOB, "")
END
IF GJOB.JOB<1,1> = "" THEN
	DELETE GANG.JOB, CONO : JOBNO
END ELSE
	MATWRITE GJOB.REC ON GANG.JOB, CONO : JOBNO
END

IF JFS.PROD # "" OR OJFS.PROD # "" THEN
	GOSUB 670
END
WRITE OPTVAL : " ~~" : JOB.EST ON CONTROL,"DUMM"
IF JOB.EST = 0 THEN JOB.EST = ""
IF OLD.EST = 0 THEN OLD.EST = ""

IF CO.PSS = "Y" THEN
	OPEN '','JOB.SCHED' TO JOB.SCHED THEN
       	IF JOB.EST = "" THEN
*T27363               OPEN '','JOB.SCHED' TO JOB.SCHED THEN
*           MATREAD JBS.REC FROM JOB.SCHED, CONO:JOBNO ELSE;* T25920
*T26551 v
*           FORCE UPDATE TO JOB.SCHED TO HANDLE THEN CHANGES TO JOB FEILDS
*           SALESMAN, CSR, DESCRIPTION ETC...
             		MATREAD JBS.REC FROM JOB.SCHED, CONO:JOBNO THEN
               		IF JBS.DUE.DATE # JOB.TRACK.DATE<1,4> THEN
                 			JBS.DUE.DATE = JOB.TRACK.DATE<1,4>
               		END
               		IF JBS.CUST.NAME # CUST.NAME THEN
                 			JBS.CUST.NAME = CUST.NAME
              		END
               		IF JBS.DIV # JOB.DIV THEN
                 			JBS.DIV = JOB.DIV
               		END
               		IF JBS.CUST.ID # JOB.CUST THEN
                 			JBS.CUST.ID = JOB.CUST
               		END
               		IF JBS.JOB.COMMENT # JOB.COMMENTS<1,1> THEN
                			JBS.JOB.COMMENT = JOB.COMMENTS<1,1>
               		END
               		IF JBS.SCH.FLAG = "S" THEN JBS.SCH.FLAG = "J"
               		CALL GET_JBS_USER_FIELDS(CONO,JOBNO,MAT JOB.REC,MAT JBS.REC,XXX,YYY,ZZZ)
               		MATWRITE JBS.REC ON JOB.SCHED, CONO:JOBNO
			END ELSE
               		IF OPTVAL<1,1> = "Y" THEN
					MAT JBS.REC = ""
                 			JBS.DUE.DATE = JOB.TRACK.DATE<1,4>
                 			JBS.CUST.NAME = CUST.NAME
                 			JBS.DIV = JOB.DIV
                			JBS.SCH.FLAG = "P"
                 			JBS.CUST.ID = JOB.CUST
                 			JBS.JOB.COMMENT = JOB.COMMENTS<1,1>
                 			IF CO.PSS.BACKWARD.FLAG = "Y" THEN
                   				JBS.SCHED.MODE = "D"
                   				JBS.SCHED.DATE = JBS.DUE.DATE
                 			END ELSE
                   				JBS.SCHED.MODE = "S"
                   				JOBS.SCHED.DATE = DATE() + 1
                 			END
                 			MATWRITE JBS.REC ON JOB.SCHED, CONO:JOBNO
*T26551
                 			CALL GET_JBS_USER_FIELDS(CONO,JOBNO,MAT JOB.REC,MAT JBS.REC,XXX,YYY,ZZZ)
                 			MATWRITE JBS.REC ON JOB.SCHED, CONO:JOBNO
               		END
			END
           	END ELSE
             		MATREAD JBS.REC FROM JOB.SCHED, CONO:JOBNO THEN
               		IF JBS.DUE.DATE # JOB.TRACK.DATE<1,4> THEN
                 			JBS.DUE.DATE = JOB.TRACK.DATE<1,4>
		             	END
              		IF JBS.CUST.NAME # CUST.NAME THEN
                 			JBS.CUST.NAME = CUST.NAME
	               	END
       	        	IF JBS.DIV # JOB.DIV THEN
              	   		JBS.DIV = JOB.DIV
               		END
	               	IF JBS.CUST.ID # JOB.CUST THEN
       	          		JBS.CUST.ID = JOB.CUST
              	 	END
               		IF JBS.JOB.COMMENT # JOB.COMMENTS<1,1> THEN
	                 		JBS.JOB.COMMENT = JOB.COMMENTS<1,1>
       	        	END
              	 	IF JBS.SCH.FLAG = "S" THEN JBS.SCH.FLAG = "J"
               		CALL GET_JBS_USER_FIELDS(CONO,JOBNO,MAT JOB.REC,MAT JBS.REC,XXX,YYY,ZZZ)
	               	MATWRITE JBS.REC ON JOB.SCHED, CONO:JOBNO
       	      	END
		END
	END
END

IF CO.JES = "Y" THEN
	ESTAT = 0     ;*T22154
	NEW.EST = JOB.EST
      	EST.NO = NEW.EST
	*CALL JOB.BOOK.SUB(CONO,"3",JOBNO,OLD.EST,JOB.EST,MAT EST.PAR,ESTAT,MAT EST.REC,SAVE.INV.JS.REC,EST.MATL)


       IF OLD.EST # "" AND NEW.EST = "" THEN
      		GOSUB 3000
    	END ELSE
      		ECNT = COUNT(EST.QTY,VM) + (EST.QTY # "")
      		DEPT = ""
      		DPTR = 0
      		GOSUB 3000
    	END
    	IF EST.ACT.FLG THEN CALL EST.ACT.SUB(CONO,JOB.NO);* T21710
* T22896 v
    	*IF @LOGNAME = 'cmykleb' THEN DEBUG
    	IF CO.PSS = 'Y' THEN
      		BEGIN CASE
        		CASE OLD.EST = '' AND NEW.EST # ''
          			JOB.FLAG = 'P'
	          		GOSUB 3500
				RETURN ; * T27914
       	 	CASE OLD.EST # '' AND NEW.EST = ''
          			JOB.FLAG = 'U'
          			GOSUB 3500
	        	CASE OLD.EST # NEW.EST
       	   		JOB.FLAG = 'R'
          			GOSUB 3500
	      	END CASE
    	END
END

*IF JOB.EST = "" THEN
*	MATREAD JBS.REC FROM JOB.SCHED, CONO:JOBNO THEN
*		IF JBS.DUE.DATE # JOB.TRACK.DATE<1,4> THEN
*       		JBS.DUE.DATE = JOB.TRACK.DATE<1,4>
*	       END
*
*		IF JBS.CUST.NAME # CUST.NAME THEN
*	       	JBS.CUST.NAME = CUST.NAME
*       	END
*	       IF JBS.DIV # JOB.DIV THEN
*       		JBS.DIV = JOB.DIV
*	       END
*       	IF JBS.CUST.ID # JOB.CUST THEN
*	       	JBS.CUST.ID = JOB.CUST
*       	END
*	       IF JBS.JOB.COMMENT # JOB.COMMENTS<1,1> THEN
*       		JBS.JOB.COMMENT = JOB.COMMENTS<1,1>
*	       END
*       	IF JBS.SCH.FLAG = "S" THEN JBS.SCH.FLAG = "J"
*
*	      	CALL GET_JBS_USER_FIELDS(CONO,JOBNO,MAT JOB.REC,MAT JBS.REC,XXX,YYY,ZZZ)
*
*       	MATWRITE JBS.REC ON JOB.SCHED, CONO:JOBNO
*	END ELSE
*	      	MAT JBS.REC = ""
*       	JBS.DUE.DATE = JOB.TRACK.DATE<1,4>
*	      	JBS.CUST.NAME = CUST.NAME
*       	JBS.DIV = JOB.DIV
*	      	JBS.SCH.FLAG = "P"
*       	JBS.CUST.ID = JOB.CUST
*	      	JBS.JOB.COMMENT = JOB.COMMENTS<1,1>
*       	JBS.SCHED.MODE = "S"
*	      	JBS.SCHED.DATE = DATE()+1
*       	MATWRITE JBS.REC ON JOB.SCHED, CONO:JOBNO
*	      	CALL GET_JBS_USER_FIELDS(CONO,JOBNO,MAT JOB.REC,MAT JBS.REC,XXX,YYY,ZZZ)
*       	MATWRITE JBS.REC ON JOB.SCHED, CONO:JOBNO
*	END
*END
519*
GOTO 99999

**************************************END OF SUB ROUTINE***************************************************


600*
RESV.LOC = 0


CALL JOB.RESV.SUB(CONO,RESV.ACTION,RESV.LOC,JOBNO)


MCNT = COUNT(JOB.RESV.MATL,VM) + (JOB.RESV.MATL # "")
FOR M = MCNT TO 1 STEP -1
	IF JOB.RESV.QTY<1,M> + JOB.ALOC.QTY<1,M> + JOB.USED.QTY<1,M> = 0 THEN
     		JSTAT.ID = JOB.RESV.MATL<1,M>:"!":JOB.RESV.WHSE<1,M>:"!":JOBNO
     		MATREAD INV.JS.REC FROM INV.JOB.STATS, CONO : JSTAT.ID ELSE
       		JOB.RESV.MATL = DELETE(JOB.RESV.MATL,1,M,0)
       		JOB.RESV.WHSE = DELETE(JOB.RESV.WHSE,1,M,0)
       		JOB.RESV.DATE = DELETE(JOB.RESV.DATE,1,M,0)
			JOB.ALOC.QTY = DELETE(JOB.ALOC.QTY,1,M,0)
			JOB.RESV.QTY = DELETE(JOB.RESV.QTY,1,M,0)
			JOB.USED.QTY = DELETE(JOB.USED.QTY,1,M,0)
			JOB.ALOC.AMT = DELETE(JOB.ALOC.AMT,1,M,0)
			JOB.RESV.AMT = DELETE(JOB.RESV.AMT,1,M,0)
			JOB.USED.AMT = DELETE(JOB.USED.AMT,1,M,0)
		END
	END
NEXT M


********ADDED BY ZUBAIR TO UPDATE THE EACH SERIAL RESERVED FOR THE SERIAL PRODUCT (PARTICULAR JOB)
*SRESV.SERIAL IS SERIAL ID, SRESV.QTY IS QTY

MYSERIALCNT = DCOUNT(SRESV.SERIAL,@VM)
CNTCOUNT = 1
FOR I = 1 TO MYSERIALCNT
	MYSERIAL_SUBCNT = DCOUNT(SRESV.SERIAL<1,I>,SVM)
	FOR J =  1 TO MYSERIAL_SUBCNT
		MATREAD ISTK.REC FROM INV_SERIAL,CONO:SRESV.SERIAL<1,I,J> THEN
			IF SRESV.QTY<1,I,J> # "0" AND SRESV.QTY<1,I,J> # "" THEN

				LOCATE JOB_NO IN ISTK.JOB<1> SETTING JOBPOS THEN
					ISTK.JRSVD.QTY<1,JOBPOS> =  SRESV.QTY<1,I,J> ; * qty reserved for job (35)
				END ELSE
					ISTK.JOB<1,-1> =JOB_NO
					ISTK.JRSVD.QTY<1,-1> =  SRESV.QTY<1,I,J>
				END
	
	*			LOCATE JOB_NO IN ISTK.JOB<1> SETTING JOBPOS ELSE
	*				ISTK.JOB<1,-1> =JOB_NO
	*			END
				
				*getting the total available qty in this serial no for all job (ISTK.CUR.STK.QTY(15))
				*1138²1136 ; 120²48
				TMP_TOT_STK = 0
				CNTJOB = DCOUNT(ISTK.JOB,VM)
				FOR Z = 1 TO CNTJOB
					IF ISTK.JOB<1,Z> <> JOB_NO THEN
						*REQD.QTY<1,P> = CALC_STK_QTY(SAVE.INV.JS.REC<P,RQD.QTY.MV>,MAT INV.CNV.REC,ROND,LN)
					  	*REQD.QTY<1,P> = OCONV(REQD.QTY<1,P>,ICR.CNV)
						*120 CHANGING TO 5	
						OCONV_VALUE = CALC_STK_QTY(ISTK.JRSVD.QTY<1,J>,MAT INV.CNV.REC,ROND,LN)
						OCONV_VALUE = OCONV(OCONV_VALUE,ICR.CNV)
						TMP_TOT_STK = TMP_TOT_STK + OCONV_VALUE
					END
				NEXT Z
				*SUBSTRACT TMP_TOT_STK FROM ISTK.CUR.STK.QTY(15)
				TMP_MYVALUE = CALC_STK_QTY(SRESV.QTY<1,I,J>,MAT INV.CNV.REC,ROND,LN)
		  		TMP_MYVALUE = OCONV(TMP_MYVALUE,ICR.CNV)
	
				*TMP.REC<CNTCOUNT> = "HERE CHECK IT - " :	ISTK.CUR.STK.QTY : "~~" :TMP_TOT_STK : "~~" : TMP_MYVALUE
				*CNTCOUNT = CNTCOUNT + 1
	
				TMP_CUR_STK_QTY = ISTK.CUR.STK.QTY - TMP_TOT_STK - TMP_MYVALUE
	
				*CONVERT WITH OCONV THEN ASSIGN TO ISTK.RSVB.QTY
				*2493 HAS TO BE CHANGED TO 59832
				*TMP.REC<CNTCOUNT> = "B4 CONVERSION TMP_CUR_STK_QTY -  " : 	TMP_CUR_STK_QTY
				*CNTCOUNT = CNTCOUNT + 1
				ISTK.RSVB.QTY = ICONV((((TMP_CUR_STK_QTY<1,J>/ICR.MT1)*ICR.DV1)*ICR.DV2),ICR.CNV)
	
				*TMP.REC<CNTCOUNT> = "AFTER CONVERSION TMP_CUR_STK_QTY -  " : 	ISTK.RSVB.QTY 
				*CNTCOUNT = CNTCOUNT + 1
	
	** check whether to subtract the avail qty
	
				*TMP.REC<CNTCOUNT> = "SERIAL AND QTY RESERVED FOR JOB - " : SRESV.SERIAL<1,I,J> : "!!!" : ISTK.JRSVD.QTY<1,J>
				*CNTCOUNT = CNTCOUNT + 1
				*TMP.REC<CNTCOUNT> = 	"TOTAL STK -- " : TMP_CUR_STK_QTY	: "-TMP_TOT_STK - " : TMP_TOT_STK
				*CNTCOUNT = CNTCOUNT + 1
				*TMP.REC<CNTCOUNT> = "CURQTY REC(15) - " : ISTK.CUR.STK.QTY
				*WRITE TMP.REC ON CONTROL, "001ZUBAIR"
				MATWRITE ISTK.REC TO INV_SERIAL,CONO:SRESV.SERIAL<1,I,J>
			END

		END
	NEXT J
NEXT I
*******END

RETURN

*---- Load old allocated quantities
670*
NJFS.PROD = JFS.PROD
NJFS.WHSE = JFS.WHSE
NJFS.ORDER = JFS.ORDER
NJFS.ORD.QTY = JFS.ORD.QTY
MCNT = DCOUNT(JFS.PROD,VM)
*VAL = RBO.setProperty('','CustomerDescs',JFS.ORD.QTY:":":JFS.ORDER:":":JFS.A.QTY:":DESC")
FOR M = 1 TO MCNT
	JFS.ORDER<1,M> = ""
    	JFS.ORD.QTY<1,M> = ""
NEXT M

FOR M = 1 TO MCNT
	PDNO = JFS.PROD<1,M>; WHNO = JFS.WHSE<1,M>
     	PTR = 1
     	LOOP
       	LOCATE PDNO IN OJFS.PROD<1>,PTR SETTING PLOC THEN
         		IF WHNO = OJFS.WHSE<1,PLOC> THEN
           			JFS.ORDER<1,M> = OJFS.ORDER<1,PLOC>
           			JFS.ORD.QTY<1,M> = OJFS.ORD.QTY<1,PLOC>
           			OJFS.PROD = DELETE(OJFS.PROD,1,PLOC,0)
           			OJFS.WHSE = DELETE(OJFS.WHSE,1,PLOC,0)
          			OJFS.ORDER = DELETE(OJFS.ORDER,1,PLOC,0)
           			OJFS.ORD.QTY = DELETE(OJFS.ORD.QTY,1,PLOC,0)
           			PTR = 0
         		END
       	END ELSE
         		PTR = 0
       	END
     	WHILE PTR DO
       	PTR = PLOC + 1
     	REPEAT
     		JFS.A.QTY<1,M> = SUM(JFS.ORD.QTY<1,M>)
NEXT M
MATWRITE JFS.REC ON JOB.FNGD.STATS, CONO:JOBNO

*
*---- Update FJS &  FGS with the manufacture quantity
*
FOR M = 1 TO MCNT
	PDNO = JFS.PROD<1,M>; WHNO = JFS.WHSE<1,M>
     	FGS.ID = CONO:PDNO:"!":WHNO
     	MATREADU FGS.REC FROM FNGD.STATS, FGS.ID ELSE
       	MAT FGS.REC = ""
     	END
     	LOCATE JOBNO IN FGS.JOB<1>,1 SETTING L ELSE
       	FGS.JOB<1,L> = JOBNO
       	FGS.A.QTY<1,L> = 0
     	END
     	FGS.M.QTY<1,L> = JFS.M.QTY<1,M> - JFS.F.QTY<1,M>
     	IF FGS.M.QTY<1,L> < 0 THEN FGS.M.QTY<1,L> = 0
     	MATWRITE FGS.REC ON FNGD.STATS, FGS.ID
     	FJS.ID = FGS.ID:"!":JOBNO
     	MATREADU FJS.REC FROM FNGD.JOB.STATS, FJS.ID ELSE
       	MAT FJS.REC = ""
       	FJS.CUST = JOB.CUST
     	END
     	FJS.DATE = JFS.DATE<1,M>
     	FJS.M.QTY = JFS.M.QTY<1,M>
     	FJS.F.QTY = JFS.F.QTY<1,M>
     	FJS.S.QTY = JFS.S.QTY<1,M>
     	MATWRITE FJS.REC ON FNGD.JOB.STATS, FJS.ID
NEXT M

*
*---- Load all the orders for all the products
*
ORDNOS = ""; PRDPTR = ""; ORDPTR = ""
GEN.SHPNO = "000"
FOR M = 1 TO MCNT
	OCNT = DCOUNT(NJFS.ORDER<1,M>,SVM)
     	FOR O = 1 TO OCNT
       	LOCATE NJFS.ORDER<1,M,O> IN ORDNOS,1 SETTING OLOC THEN
         		OPTR = DCOUNT(PRDPTR<OLOC>,VM) + 1
         		PRDPTR<OLOC,OPTR> = M
         		ORDPTR<OLOC,OPTR> = O
       	END ELSE
         		ORDNOS<OLOC> = NJFS.ORDER<1,M,O>
         		PRDPTR<OLOC> = M
         		ORDPTR<OLOC> = O
       	END
     	NEXT O
NEXT M

*---- Update orders with the new allocated quantity
*
OCNT = DCOUNT(ORDNOS,AM)
*VAL = RBO.setProperty('','ESTAT',LOWER(ORDNOS))
DATACON = ""
FOR OP = 1 TO OCNT
	ORDNUM = ORDNOS<OP>
     	PCNT = DCOUNT(ORDPTR<OP>,VM)
     	MATREADU ORD.REC FROM ORDER, CONO:ORDNUM ELSE
       	RELEASE ORDER, CONO:ORDNUM
       	FOR PP = 1 TO PCNT
         		M = PRDPTR<OP,PP>; O = ORDPTR<OP,PP>
         		PDNO = NJFS.PROD<1,M>; WHNO = NJFS.WHSE<1,M>
         		NJFS.ORD.QTY<1,M,O> = 0
        		GOSUB 680
       	NEXT PP
       	GOTO 674
     	END
     	STATUS = "L"; SHPNO = "ALL"
     	CALL ORDER_LINE_UPD(CONO,ORDNUM,SHPNO,STATUS)
     	SHPNO = GEN.SHPNO
     	PCNT = DCOUNT(ORDPTR<OP>,VM)
     	FOR PP = 1 TO PCNT
       	M = PRDPTR<OP,PP>; O = ORDPTR<OP,PP>
       	PDNO = NJFS.PROD<1,M>; WHNO = NJFS.WHSE<1,M>
       	PTR = 1
       	LOOP
         		LOCATE PDNO IN ODQ.PROD<1>,PTR SETTING PLOC THEN
           			IF WHNO = ODQ.WHSE<1,PLOC> AND ODQ.KIT<1,PLOC> = "N" THEN
             				PTR = 0
           			END
         		END ELSE
           			PLOC = 0; PTR = 0
         		END
       	WHILE PTR DO
         		PTR = PLOC + 1
       	REPEAT
       	IF PLOC = 0 THEN
         		RELEASE ORDER, CONO:ORDNUM
         		NJFS.ORD.QTY<1,M,O> = 0
         		GOSUB 680; GOTO 672
       	END
       	TOT.A.QTY = NJFS.ORD.QTY<1,M,O>; JPTR = 1
       	LOOP
         		LOCATE JOBNO IN ODQ.JOB<1,PLOC>,JPTR SETTING JL THEN
           			BEGIN CASE
             				CASE TOT.A.QTY >= ODQ.JOB.QTY<1,PLOC,JL>
              				TOT.A.QTY = TOT.A.QTY - ODQ.JOB.QTY<1,PLOC,JL>
              				JPTR = JL + 1
             				CASE TOT.A.QTY > 0
               				ODQ.JOB.QTY<1,PLOC,JL> = TOT.A.QTY
               				TOT.A.QTY = 0
              				JPTR = JL + 1
             				CASE 1
               				ODQ.JOB.QTY<1,PLOC,JL> = 0
           			END CASE
         		END ELSE
           			JL = 0
         		END
       	WHILE JL DO REPEAT
       	IF TOT.A.QTY < 1 THEN GOTO 672
       	JPTR = 1
       	LOOP
         		LOCATE JOBNO IN ODQ.JOB<1,PLOC>,JPTR SETTING JL THEN
           			IF ODQ.JOB.SHPNO<1,PLOC,JL> = SHPNO THEN
             				ODQ.JOB.QTY<1,PLOC,JL> = ODQ.JOB.QTY<1,PLOC,JL> + TOT.A.QTY
             				JL = 0
           			END
         		END ELSE
           			INS JOBNO BEFORE ODQ.JOB<1,PLOC,1>
           			INS TOT.A.QTY BEFORE ODQ.JOB.QTY<1,PLOC,1>
           			INS GEN.SHPNO BEFORE ODQ.JOB.SHPNO<1,PLOC,1>
           			JL = 0
        		END
       	WHILE JL DO
			JPTR = JL + 1
       	REPEAT
       	ODQ.A.QTY<1,PLOC> = SUM(ODQ.JOB.QTY<1,PLOC>)
672*
	NEXT PP
     	STATUS = "U"; SHPNO = ""
	DATACON<1,-1> = JFS.ORDER : ":" : JFS.ORD.QTY : ":" : JFS.A.QTY
     	CALL ORDER_LINE_UPD(CONO,ORDNUM,SHPNO,STATUS)
	DATACON<1,-1> = JFS.ORDER : ":" : JFS.ORD.QTY : ":" : JFS.A.QTY
674*
NEXT OP
*VAl = RBO.setProperty('','CustomerCodes',DATACON)

*
*---- Update orders with zero out allocated quantity
*
ORDNOS = ""; PRDPTR = ""; ORDPTR = ""
MCNT = DCOUNT(OJFS.PROD,VM)
FOR M = 1 TO MCNT
	OCNT = DCOUNT(OJFS.ORDER<1,M>,SVM)
	FOR O = 1 TO OCNT
       	LOCATE OJFS.ORDER<1,M,O> IN ORDNOS,1 SETTING OLOC THEN
         		OPTR = DCOUNT(PRDPTR<OLOC>,VM) + 1
         		PRDPTR<OLOC,OPTR> = M
         		ORDPTR<OLOC,OPTR> = O
       	END ELSE
         		ORDNOS<OLOC> = OJFS.ORDER<1,M,O>
        		PRDPTR<OLOC> = M
         		ORDPTR<OLOC> = O
       	END
     	NEXT O
NEXT M
OCNT = DCOUNT(ORDNOS,AM)
FOR OP = 1 TO OCNT
	ORDNUM = ORDNOS<OP>
     	PCNT = DCOUNT(ORDPTR<OP>,VM)
     	MATREADU ORD.REC FROM ORDER, CONO:ORDNUM ELSE
       	RELEASE ORDER, CONO:ORDNUM
       	FOR PP = 1 TO PCNT
         		M = PRDPTR<OP,PP>; O = ORDPTR<OP,PP>
         		PDNO = OJFS.PROD<1,M>; WHNO = OJFS.WHSE<1,M>
         		GOSUB 680
       	NEXT PP
       	GOTO 678
     	END
     	STATUS = "L"; SHPNO = "ALL"
     	CALL ORDER_LINE_UPD(CONO,ORDNUM,SHPNO,STATUS)
     	SHPNO = GEN.SHPNO
     	PCNT = DCOUNT(ORDPTR<OP>,VM)
     	FOR PP = 1 TO PCNT
       	M = PRDPTR<OP,PP>; O = ORDPTR<OP,PP>
       	PDNO = OJFS.PROD<1,M>; WHNO = OJFS.WHSE<1,M>
       	PTR = 1
       	LOOP
         		LOCATE PDNO IN ODQ.PROD<1>,PTR SETTING PLOC THEN
           			IF WHNO = ODQ.WHSE<1,PLOC> THEN
             				PTR = 0
           			END
         		END ELSE
           			PLOC = 0; PTR = 0
         		END
       	WHILE PTR DO
         		PTR = PLOC + 1
       	REPEAT
       	IF PLOC = 0 THEN
         		RELEASE ORDER, CONO:ORDNUM
         		GOSUB 680; GOTO 676
      		END
       	TOT.A.QTY = 0; JPTR = 1
       	LOOP
         		LOCATE JOBNO IN ODQ.JOB<1,PLOC>,JPTR SETTING JL THEN
           			ODQ.JOB.QTY<1,PLOC,JL> = 0
           			JPTR = JL + 1
         		END ELSE
           			JL = 0
         		END
       	WHILE JL DO REPEAT
676*
     	NEXT PP
     	STATUS = "U"; SHPNO = ""
     	CALL ORDER_LINE_UPD(CONO,ORDNUM,SHPNO,STATUS)
678*
NEXT OP

MATREADU JFS.REC FROM JOB.FNGD.STATS, CONO:JOBNO ELSE MAT JFS.REC = ""
MCNT = DCOUNT(OJFS.PROD,VM)
FOR M = 1 TO MCNT
	PDNO = OJFS.PROD<1,M>; WHNO = OJFS.WHSE<1,M>
     	FGS.ID = CONO:PDNO:"!":WHNO
     	FJS.ID = FGS.ID:"!":JOBNO
    	MATREADU FJS.REC FROM FNGD.JOB.STATS, FJS.ID THEN
       	DELETE FNGD.JOB.STATS, FJS.ID
     	END ELSE
       	RELEASE FNGD.JOB.STATS, FJS.ID
     	END
     	MATREADU FGS.REC FROM FNGD.STATS, FGS.ID THEN
       	LOCATE JOBNO IN FGS.JOB<1>,1 SETTING L THEN
         		FGS.JOB = DELETE(FGS.JOB,1,L,0)
         		FGS.M.QTY = DELETE(FGS.M.QTY,1,L,0)
         		FGS.A.QTY = DELETE(FGS.A.QTY,1,L,0)
      		END
       	IF FGS.JOB = "" AND FGS.ORDER = "" THEN
         		DELETE FNGD.STATS, FGS.ID
       	END ELSE
         		MATWRITE FGS.REC ON FNGD.STATS, FGS.ID
       	END
     	END ELSE
       	RELEASE FNGD.STATS, FGS.ID
     	END
     	PTR = 1
     	LOOP
       	LOCATE PDNO IN JFS.PROD<1>,PTR SETTING PLOC THEN
         		IF WHNO = JFS.WHSE<1,PLOC> THEN
           			JFS.PROD = DELETE(JFS.PROD,1,PLOC,0)
           			JFS.WHSE = DELETE(JFS.WHSE,1,PLOC,0)
           			JFS.DATE = DELETE(JFS.DATE,1,PLOC,0)
           			JFS.M.QTY = DELETE(JFS.M.QTY,1,PLOC,0)
           			JFS.A.QTY = DELETE(JFS.A.QTY,1,PLOC,0)
          			JFS.F.QTY = DELETE(JFS.F.QTY,1,PLOC,0)
           			JFS.S.QTY = DELETE(JFS.S.QTY,1,PLOC,0)
           			JFS.ORDER = DELETE(JFS.ORDER,1,PLOC,0)
           			JFS.ORD.QTY = DELETE(JFS.ORD.QTY,1,PLOC,0)
           			PTR = 0
         		END
       	END ELSE
         		PTR = 0
       	END
     	WHILE PTR DO
       	PTR = PLOC + 1
     	REPEAT
NEXT M
IF JFS.PROD # "" THEN
	MATWRITE JFS.REC ON JOB.FNGD.STATS, CONO:JOBNO
END ELSE
	DELETE JOB.FNGD.STATS, CONO:JOBNO
END
RETURN


*
*---- Zero out allocated for the FJS
680*
FJS.ID = CONO:PDNO:"!":WHNO:"!":JOBNO
MATREADU FJS.REC FROM FNGD.JOB.STATS, FJS.ID THEN
	LOCATE ORDNUM IN FJS.ORD<1>,1 SETTING FND THEN
       	FJS.ORD = DELETE(FJS.ORD,1,FND,0)
       	FJS.ORD.QTY = DELETE(FJS.ORD.QTY,1,FND,0)
       	FJS.A.QTY = SUM(FJS.ORD.QTY)
       	MATWRITE FJS.REC ON FNGD.JOB.STATS, FJS.ID
     	END ELSE
       	RELEASE FNGD.JOB.STATS, FJS.ID
     	END
END ELSE
	RELEASE FNGD.JOB.STATS, FJS.ID
END
RETURN

*
*---- CONSTRUCT ESTIMATE.JOB RECORD
*
3000 *
BEGIN CASE
	CASE OLD.EST # "" AND EST.NO = ""
    		DELETE ESTIMATE.JOB, CONO:JOB.NO
  	CASE EST.NO # ""
    		MATREADU ESTJ.REC FROM ESTIMATE.JOB, CONO:JOB.NO ELSE NULL
    		MAT ESTJ.REC = ""
    		ESTJ.EST.ID = EST.NO
    		ESTJ.COMP = EST.PAR.COMP
    		ESTJ.QTY = EST.PAR.QTY
    		ESTJ.EST.TYPE = EST.TYPE
    		ESTJ.DIV = FIELD(EST.DIV,"-",1)
    		DC.CNT = COUNT(EST.DEPT.COMP,VM) + (EST.DEPT.COMP # "")
    		FOR LN = 1 TO DC.CNT
      			COMP = FIELD(EST.DEPT.COMP<1,LN>,"!",2)
      			LOCATE COMP IN EST.PAR.COMP<1,1>,1 SETTING CMATCH ELSE CMATCH = 0
      			IF EST.PAR.COMP = "ALL" OR CMATCH > 0 THEN
        			IF EST.PAR.QTY = FIELD(EST.DEPT.COMP<1,LN>,"!",3) THEN
          				GOSUB 10000
        			END
      			END
    		NEXT LN
    		MATWRITE ESTJ.REC ON ESTIMATE.JOB, CONO:JOB.NO
END CASE
IF OLD.EST # "" THEN
	FND1 = 1
  	MATREADU EST.REC FROM ESTIMATE, CONO:OLD.EST ELSE FND1 = 0
  	IF FND1 THEN
    		LOCATE JOB.NO IN EST.BOOK.JOB<1>,1 SETTING FND2 ELSE FND2 = 0
    		IF FND2 THEN
      			EST.BOOK.JOB = DELETE(EST.BOOK.JOB,1,FND2,0)
      			EST.BOOK.COMP = DELETE(EST.BOOK.COMP,1,FND2,0)
    		END
    		IF EST.BOOK.JOB = "" THEN
      			EST.JOB = ""
     			EST.BOOK.QTY = ""
      			IF EST.STATUS<1,1> = "BOOKED" THEN
        			EST.STATUS = DELETE(EST.STATUS,1,1,0)
        			EST.STAT.DATE = DELETE(EST.STAT.DATE,1,1,0)
      			END
    		END
    		MATWRITE EST.REC ON ESTIMATE, CONO:OLD.EST
  	END ELSE
    		RELEASE ESTIMATE, CONO:OLD.EST
  	END
END

IF EST.NO # "" THEN
	FND1 = 1
  	MATREADU EST.REC FROM ESTIMATE, CONO:EST.NO ELSE FND1 = 0
  	IF FND1 THEN
    		IF EST.STATUS<1,1> # "BOOKED" THEN
      			EST.STATUS = INSERT(EST.STATUS,1,1,0,"BOOKED")
      			EST.STAT.DATE = INSERT(EST.STAT.DATE,1,1,0,DATE())
    		END
    		LOCATE JOB.NO IN EST.BOOK.JOB<1>,1 SETTING JP ELSE
      			EST.BOOK.JOB<1,JP> = JOB.NO
    		END
    		EST.BOOK.COMP<1,JP> = EST.PAR.COMP
    		IF JOB.NO = JOB.MASTER OR JOB.MASTER = "" THEN
      			EST.JOB = JOB.NO
    		END
    		EST.JOB = JOB.MASTER
    		EST.BOOK.QTY = EST.PAR.QTY
    		MATWRITE EST.REC ON ESTIMATE, CONO:EST.NO
  	END ELSE
    		RELEASE ESTIMATE, CONO:EST.NO
  	END
END
MAT EST.PAR = ""

*
*---- EXTRACT JOB FOR SCHEDULING
*
3500 *
IF EST.NO # "" THEN
	MATREAD COMP.REC FROM COMPANY, CONO ELSE MAT COMP.REC = ""
  	IF CO.PSS = "Y" THEN
    		OPEN "","JOB.SCHED" TO JOB.SCHED THEN
      			MATREAD JBS.REC FROM JOB.SCHED, CONO:JOB.NO ELSE
* T22896
        			BEGIN CASE
          				CASE JOB.FLAG = "P"
            					*TYP=8;X=0;Y=21;MAXL=1;DEFAULT=""
            					*VALDAT = 'Y':VM:'N'   ;*T22332
            					*PMSG="Extract this job for scheduling (Y/N):"
            					*CALL EDIT.SUB
            					*P_X  = 0;P_Y = 21;P_VALUE = "";P_OPT = "CL"
            					*CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
            					*IF VALUE = "Y" THEN
              				*	PARAM = ""
              				*	PARAM<1,1> = CONO
              				*	PARAM<1,2> = JOB.NO
              				*	PARAM<1,4> = JOB.FLAG ;* JOB.SCH.FLAG
              				*	PARAM<1,5> = GUIFORM;* T21177
              				*	CALL PERFORM.PROG("JOB.SCHED.EXTRACT",PARAM)
              				*	P_X  = 0;P_Y = 21;P_VALUE = "";P_OPT = "CL"
              				*	CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
            					*END
          				CASE JOB.FLAG = "R"
            					PARAM = ""
            					PARAM<1,1> = CONO
            					PARAM<1,2> = JOB.NO
				            	PARAM<1,3> = "N"
            					PARAM<1,4> = JOB.FLAG;* JBS.SCH.FLAG
            					PARAM<1,5> = "";*GUIFORM;* T21177
            					CALL PERFORM.PROG("JOB.SCHED.EXTRACT",PARAM)
          				CASE JOB.FLAG = "U"
            					MATREADU JBS.REC FROM JOB.SCHED, CONO:JOB.NO THEN
              					JBS.SCH.FLAG = "U"
              					MATWRITE JBS.REC ON JOB.SCHED, CONO:JOB.NO
           					END ELSE
              					RELEASE JOB.SCHED, CONO:JOB.NO
            					END
        			END CASE
*T22896
      			END
    		END
  	END
END
RETURN


*
*--- LOAD ESTJ.REC FROM ESTD.REC
*
10000 *
MATREAD ESTD.REC FROM ESTIMATE.DEPT, CONO:EST.NO:"!":EST.DEPT.COMP<1,LN> ELSE MAT ESTD.REC = ""
TYPE.CNT = COUNT(ESTD.TYPE,VM) + (ESTD.TYPE # "")
FOR T = 1 TO TYPE.CNT
	ETYPE = ESTD.TYPE<1,T>
  	MATREAD CCTR.REC FROM COST.CNTR, CONO:ESTD.CCTR<1,T> ELSE MAT CCTR.REC = ""
  	BEGIN CASE
    		CASE ETYPE = "G"
    		CASE ETYPE = "L"
      			GOSUB 10100
    		CASE ETYPE[1,1] = "M"
      			MT.TYPE = ETYPE[2,1]
      			OPV = ESTD.OPV<1,T>
      			PROD = ESTD.OPV<1,T>
      			IF MT.TYPE="S" OR MT.TYPE = "R" OR MT.TYPE = "L" THEN
        			WCNT = COUNT(EST.PROD.OS.PROD<1,COMP>,SM) + 1
        			FOR WP = 1 TO WCNT
          				IF ESTD.DESC<1,T> = EST.PROD.OS.DESC<1,COMP,WP> AND EST.PROD.INV.ID<1,COMP,WP> # '' THEN
            					PROD = EST.PROD.INV.ID<1,COMP,WP>
          				END
        			NEXT WP
      			END
      			GOSUB 10200
    		CASE ETYPE = "I"
      			OPV = ""
      			PROD = ESTD.OPV<1,T>
      			GOSUB 10200
    		CASE ETYPE[1,1] = "P"
      			GOSUB 10300
    		CASE ETYPE = "S"
      			GOSUB 10400
    		CASE 1
      			GOSUB 10500
  	END CASE
NEXT T
1999 *
RETURN
*
*--- LABOR
*
10100 *
DFND = 1
MATCHED = 0
DCNT = COUNT(ESTJ.LB.DEPT,VM) + (ESTJ.LB.DEPT # "")
FOR D = 1 TO DCNT UNTIL MATCHED
  	BEGIN CASE
    		CASE CCTR.DEPT = ESTJ.LB.DEPT<1,D>
      			BEGIN CASE
        			CASE ESTD.CCTR<1,T> = ESTJ.LB.CCTR<1,D>
          				BEGIN CASE
            					CASE ESTD.OPV<1,T> = ESTJ.LB.OPER<1,D>
              					DFND = D
              					MATCHED = 1
            					CASE ESTD.OPV<1,T> > ESTJ.LB.OPER<1,D>
              					DFND = D + 1
          				END CASE
        			CASE ESTD.CCTR<1,T> > ESTJ.LB.CCTR<1,D>
          				DFND = D + 1
      			END CASE
    		CASE CCTR.DEPT > ESTJ.LB.DEPT<1,D>
      			DFND = D + 1
  	END CASE
NEXT D

IF MATCHED = 0 THEN
	IF DFND <= DCNT THEN
    		ESTJ.LB.DEPT = INSERT(ESTJ.LB.DEPT,1,DFND,0,"")
    		ESTJ.LB.CCTR = INSERT(ESTJ.LB.CCTR,1,DFND,0,"")
   		ESTJ.LB.OPER = INSERT(ESTJ.LB.OPER,1,DFND,0,"")
    		ESTJ.LB.HRS = INSERT(ESTJ.LB.HRS,1,DFND,0,"")
    		ESTJ.LB.QTY = INSERT(ESTJ.LB.QTY,1,DFND,0,"")
    		ESTJ.LB.DCOST = INSERT(ESTJ.LB.DCOST,1,DFND,0,"")
    		ESTJ.LB.COST = INSERT(ESTJ.LB.COST,1,DFND,0,"")
    		ESTJ.LB.SALE = INSERT(ESTJ.LB.SALE,1,DFND,0,"")
  	END
  	ESTJ.LB.DEPT<1,DFND> = CCTR.DEPT
  	ESTJ.LB.CCTR<1,DFND> = ESTD.CCTR<1,T>
  	ESTJ.LB.OPER<1,DFND> = ESTD.OPV<1,T>
END

ESTJ.LB.HRS<1,DFND> = ESTJ.LB.HRS<1,DFND> + ESTD.HRS<1,T>
IF ESTD.OPV.TYPE<1,T> = "F" THEN
	ESTJ.LB.QTY<1,DFND> = ESTJ.LB.QTY<1,DFND> + 0
END ELSE
  	ESTJ.LB.QTY<1,DFND> = ESTJ.LB.QTY<1,DFND> + ESTD.QTY<1,T>
END

ESTJ.LB.DCOST<1,DFND> = ESTJ.LB.DCOST<1,DFND> + ESTD.DCOST<1,T>
ESTJ.LB.COST<1,DFND> = ESTJ.LB.COST<1,DFND> + ESTD.COST<1,T>
ESTJ.LB.SALE<1,DFND> = ESTJ.LB.SALE<1,DFND> + ESTD.TSALE<1,T>
ESTJ.TOT.DCOST = ESTJ.TOT.DCOST + ESTD.DCOST<1,T>
ESTJ.TOT.COST = ESTJ.TOT.COST + ESTD.COST<1,T>
ESTJ.TOT.SALE = ESTJ.TOT.SALE + ESTD.TSALE<1,T>
RETURN


*--- MATERIAL
*
10200 *
DFND = 1
MATCHED = 0
DCNT = COUNT(ESTJ.MT.DEPT,VM) + (ESTJ.MT.DEPT # "")
FOR D = 1 TO DCNT UNTIL MATCHED
	BEGIN CASE
    		CASE CCTR.DEPT = ESTJ.MT.DEPT<1,D>
      			BEGIN CASE
        			CASE ESTD.CCTR<1,T> = ESTJ.MT.CCTR<1,D>
          				BEGIN CASE
            					CASE PROD = ESTJ.MT.PROD<1,D>
              					BEGIN CASE
                						CASE ESTD.CODE<1,T> = ESTJ.MT.PLINE<1,D>
                  							IF ESTD.UM<1,T> = ESTJ.MT.TYPE<1,D> THEN
                    								DFND = D
                    								MATCHED = 1
                  							END ELSE
                    								DFND = D + 1
                  							END
                						CASE ESTD.CODE<1,T> > ESTJ.MT.PLINE<1,D>
                  							DFND = D + 1
              					END CASE
            					CASE PROD > ESTJ.MT.PROD<1,D>
              					DFND = D + 1
          				END CASE
        			CASE ESTD.CCTR<1,T> > ESTJ.MT.CCTR<1,D>
          				DFND = D + 1
      			END CASE
    		CASE CCTR.DEPT > ESTJ.MT.DEPT<1,D>
      			DFND = D + 1
  	END CASE
NEXT D

IF MATCHED = 0 THEN
	IF DFND <= DCNT THEN
    		ESTJ.MT.DEPT = INSERT(ESTJ.MT.DEPT,1,DFND,0,"")
    		ESTJ.MT.CCTR = INSERT(ESTJ.MT.CCTR,1,DFND,0,"")
    		ESTJ.MT.OPER = INSERT(ESTJ.MT.OPER,1,DFND,0,"")
    		ESTJ.MT.PROD = INSERT(ESTJ.MT.PROD,1,DFND,0,"")
   		ESTJ.MT.DESC = INSERT(ESTJ.MT.DESC,1,DFND,0,"")
    		ESTJ.MT.PLINE = INSERT(ESTJ.MT.PLINE,1,DFND,0,"")
    		ESTJ.MT.MLINE = INSERT(ESTJ.MT.MLINE,1,DFND,0,"")
    		ESTJ.MT.QTY = INSERT(ESTJ.MT.QTY,1,DFND,0,"")
    		ESTJ.MT.TYPE = INSERT(ESTJ.MT.TYPE,1,DFND,0,"")
    		ESTJ.MT.DCOST = INSERT(ESTJ.MT.DCOST,1,DFND,0,"")
    		ESTJ.MT.COST = INSERT(ESTJ.MT.COST,1,DFND,0,"")
    		ESTJ.MT.SALE = INSERT(ESTJ.MT.SALE,1,DFND,0,"")
    		ESTJ.MT.PROD.CLS = INSERT(ESTJ.MT.PROD.CLS,1,DFND,0,"")
  	END
  	ESTJ.MT.DEPT<1,DFND> = CCTR.DEPT
  	ESTJ.MT.CCTR<1,DFND> = ESTD.CCTR<1,T>
	ESTJ.MT.OPER<1,DFND> = OPV
  	ESTJ.MT.PROD<1,DFND> = PROD
  	ESTJ.MT.DESC<1,DFND> = ESTD.DESC<1,T>
  	ESTJ.MT.PLINE<1,DFND> = ESTD.CODE<1,T>
  	ESTJ.MT.PROD.CLS<1,DFND> = ESTD.TYPE<1,T>
  	MATREAD CATG.REC FROM CATEGORY, CONO:ESTD.CODE<1,T> ELSE MAT CATG.REC = ""
  	ESTJ.MT.MLINE<1,DFND> = CATG.MAJ.LINE
  	MATREAD ESTM.REC FROM ESTIMATE.MATL, CONO:MT.TYPE ELSE MAT ESTM.REC = ""
  	LOCATE ESTD.OPV<1,T> IN ESTM.PROD<1>,1 SETTING PF ELSE PF = 0
  	IF PF THEN
    		ESTJ.MT.TYPE<1,DFND> = ESTM.UM<1,PF>
  	END ELSE
    		BEGIN CASE
      			CASE CATG.TYPE = "S" OR MT.TYPE = "S"
        			ESTJ.MT.TYPE<1,DFND> = "SHT"
      			CASE CATG.TYPE = "P" OR CATG.TYPE = "F" OR CATG.TYPE = "O"
        			ESTJ.MT.TYPE<1,DFND> = "EA"
      			CASE MT.TYPE = "P" OR MT.TYPE = "F" OR MT.TYPE = "O"
       			ESTJ.MT.TYPE<1,DFND> = "EA"
      			CASE MT.TYPE = "B" OR MT.TYPE = "X"
        			ESTJ.MT.TYPE<1,DFND> = "EA"
      			CASE CATG.TYPE = "I" OR MT.TYPE = "I"
        			ESTJ.MT.TYPE<1,DFND> = "LBS"
      			CASE CATG.TYPE = "PC"
        			ESTJ.MT.TYPE<1,DFND> = "MSI"
      			CASE CATG.TYPE = "L" OR MT.TYPE = "R"
        			ESTJ.MT.TYPE<1,DFND> = "LBS"
      			CASE CATG.TYPE = "RL"
        			ESTJ.MT.TYPE<1,DFND> = "MSI"
    		END CASE
 	END
END

ESTJ.MT.QTY<1,DFND> = ESTJ.MT.QTY<1,DFND> + ESTD.QTY<1,T>
ESTJ.MT.DCOST<1,DFND> = ESTJ.MT.DCOST<1,DFND> + ESTD.DCOST<1,T>
ESTJ.MT.COST<1,DFND> = ESTJ.MT.COST<1,DFND> + ESTD.COST<1,T>
ESTJ.MT.SALE<1,DFND> = ESTJ.MT.SALE<1,DFND> + ESTD.TSALE<1,T>
ESTJ.TOT.DCOST = ESTJ.TOT.DCOST + ESTD.DCOST<1,T>
ESTJ.TOT.COST = ESTJ.TOT.COST + ESTD.COST<1,T>
ESTJ.TOT.SALE = ESTJ.TOT.SALE + ESTD.TSALE<1,T>
RETURN
*
*--- OUTSIDE PURCHASE
*
10300 *
DFND = 1
MATCHED = 0
DCNT = COUNT(ESTJ.OS.DEPT,VM) + (ESTJ.OS.DEPT # "")
FOR D = 1 TO DCNT UNTIL MATCHED
	BEGIN CASE
    		CASE CCTR.DEPT = ESTJ.OS.DEPT<1,D>
      			BEGIN CASE
        			CASE ESTD.CCTR<1,T> = ESTJ.OS.CCTR<1,D>
          				BEGIN CASE
            					CASE ESTD.OPV<1,T> = ESTJ.OS.OPER<1,D>
              					BEGIN CASE
                						CASE ESTD.CODE<1,T> = ESTJ.OS.PLINE<1,D>
                  							BEGIN CASE
                    								CASE ESTD.VEND<1,T> = ESTJ.OS.VEND<1,D>
                      								DFND = D
                      								MATCHED = 1
                    								CASE ESTD.VEND<1,T> > ESTJ.OS.VEND<1,D>
                      								DFND = D + 1
                  							END CASE
                						CASE ESTD.CODE<1,T> > ESTJ.OS.PLINE<1,D>
                  							DFND = D + 1
              					END CASE
            					CASE ESTD.OPV<1,T> > ESTJ.OS.OPER<1,D>
              					DFND = D + 1
          				END CASE
        			CASE ESTD.CCTR<1,T> > ESTJ.OS.CCTR<1,D>
          				DFND = D + 1
      			END CASE
    		CASE CCTR.DEPT > ESTJ.OS.DEPT<1,D>
      			DFND = D + 1
  	END CASE
NEXT D

IF MATCHED = 0 THEN
	IF DFND <= DCNT THEN
    		ESTJ.OS.DEPT = INSERT(ESTJ.OS.DEPT,1,DFND,0,"")
    		ESTJ.OS.CCTR = INSERT(ESTJ.OS.CCTR,1,DFND,0,"")
    		ESTJ.OS.OPER = INSERT(ESTJ.OS.OPER,1,DFND,0,"")
    		ESTJ.OS.DESC = INSERT(ESTJ.OS.DESC,1,DFND,0,"")
    		ESTJ.OS.PLINE = INSERT(ESTJ.OS.PLINE,1,DFND,0,"")
    		ESTJ.OS.VEND = INSERT(ESTJ.OS.VEND,1,DFND,0,"")
    		ESTJ.OS.QTY = INSERT(ESTJ.OS.QTY,1,DFND,0,"")
    		ESTJ.OS.DCOST = INSERT(ESTJ.OS.DCOST,1,DFND,0,"")
    		ESTJ.OS.COST = INSERT(ESTJ.OS.COST,1,DFND,0,"")
    		ESTJ.OS.SALE = INSERT(ESTJ.OS.SALE,1,DFND,0,"")
  	END
  	ESTJ.OS.DEPT<1,DFND> = CCTR.DEPT
  	ESTJ.OS.CCTR<1,DFND> = ESTD.CCTR<1,T>
  	ESTJ.OS.OPER<1,DFND> = ESTD.OPV<1,T>
  	ESTJ.OS.DESC<1,DFND> = ESTD.DESC<1,T>
  	ESTJ.OS.PLINE<1,DFND> = ESTD.CODE<1,T>
  	ESTJ.OS.VEND<1,DFND> = ESTD.VEND<1,T>
END
ESTJ.OS.QTY<1,DFND> = ESTJ.OS.QTY<1,DFND> + ESTD.QTY<1,T>
ESTJ.OS.DCOST<1,DFND> = ESTJ.OS.DCOST<1,DFND> + ESTD.DCOST<1,T>
ESTJ.OS.COST<1,DFND> = ESTJ.OS.COST<1,DFND> + ESTD.COST<1,T>
ESTJ.OS.SALE<1,DFND> = ESTJ.OS.SALE<1,DFND> + ESTD.TSALE<1,T>
ESTJ.TOT.DCOST = ESTJ.TOT.DCOST + ESTD.DCOST<1,T>
ESTJ.TOT.COST = ESTJ.TOT.COST + ESTD.COST<1,T>
ESTJ.TOT.SALE = ESTJ.TOT.SALE + ESTD.TSALE<1,T>
RETURN
*
*--- SHIPPING
*
10400 *
DFND = 1
MATCHED = 0
DCNT = COUNT(ESTJ.SP.DEPT,VM) + (ESTJ.SP.DEPT # "")
FOR D = 1 TO DCNT UNTIL MATCHED
  	BEGIN CASE
    		CASE CCTR.DEPT = ESTJ.SP.DEPT<1,D>
      			BEGIN CASE
        			CASE ESTD.CCTR<1,T> = ESTJ.SP.CCTR<1,D>
          				BEGIN CASE
            					CASE ESTD.OPV<1,T> = ESTJ.SP.OPER<1,D>
              					BEGIN CASE
                						CASE ESTD.CODE<1,T> = ESTJ.SP.VIA<1,D>
                  							DFND = D
                  							MATCHED = 1
                						CASE ESTD.CODE<1,T> > ESTJ.SP.VIA<1,D>
                  							DFND = D + 1
              					END CASE
            					CASE ESTD.OPV<1,T> > ESTJ.SP.OPER<1,D>
              					DFND = D + 1
         				END CASE
        			CASE ESTD.CCTR<1,T> > ESTJ.SP.CCTR<1,D>
          				DFND = D + 1
      			END CASE
    		CASE CCTR.DEPT > ESTJ.SP.DEPT<1,D>
      			DFND = D + 1
  	END CASE
NEXT D

IF MATCHED = 0 THEN
	IF DFND <= DCNT THEN
    		ESTJ.SP.DEPT = INSERT(ESTJ.SP.DEPT,1,DFND,0,"")
    		ESTJ.SP.CCTR = INSERT(ESTJ.SP.CCTR,1,DFND,0,"")
    		ESTJ.SP.OPER = INSERT(ESTJ.SP.OPER,1,DFND,0,"")
    		ESTJ.SP.DESC = INSERT(ESTJ.SP.DESC,1,DFND,0,"")
    		ESTJ.SP.VIA = INSERT(ESTJ.SP.VIA,1,DFND,0,"")
    		ESTJ.SP.DCOST = INSERT(ESTJ.SP.DCOST,1,DFND,0,"")
    		ESTJ.SP.COST = INSERT(ESTJ.SP.COST,1,DFND,0,"")
    		ESTJ.SP.SALE = INSERT(ESTJ.SP.SALE,1,DFND,0,"")
  	END
  	ESTJ.SP.DEPT<1,DFND> = CCTR.DEPT
  	ESTJ.SP.CCTR<1,DFND> = ESTD.CCTR<1,T>
  	ESTJ.SP.OPER<1,DFND> = ESTD.OPV<1,T>
  	ESTJ.SP.DESC<1,DFND> = ESTD.DESC<1,T>
  	ESTJ.SP.VIA<1,DFND> = ESTD.CODE<1,T>
END

ESTJ.SP.DCOST<1,DFND> = ESTJ.SP.DCOST<1,DFND> + ESTD.DCOST<1,T>
ESTJ.SP.COST<1,DFND> = ESTJ.SP.COST<1,DFND> + ESTD.COST<1,T>
ESTJ.SP.SALE<1,DFND> = ESTJ.SP.SALE<1,DFND> + ESTD.TSALE<1,T>
ESTJ.TOT.DCOST = ESTJ.TOT.DCOST + ESTD.DCOST<1,T>
ESTJ.TOT.COST = ESTJ.TOT.COST + ESTD.COST<1,T>
ESTJ.TOT.SALE = ESTJ.TOT.SALE + ESTD.TSALE<1,T>
RETURN
*
*--- MISCELLANEOUS
*
10500 *
DFND = 1
MATCHED = 0
DCNT = COUNT(ESTJ.MS.DEPT,VM) + (ESTJ.MS.DEPT # "")
FOR D = 1 TO DCNT UNTIL MATCHED
	BEGIN CASE
    		CASE CCTR.DEPT = ESTJ.MS.DEPT<1,D>
      			BEGIN CASE
        			CASE ESTD.CCTR<1,T> = ESTJ.MS.CCTR<1,D>
          				BEGIN CASE
            					CASE ESTD.OPV<1,T> = ESTJ.MS.OPER<1,D>
              					IF ESTD.DESC<1,T> = ESTJ.MS.DESC<1,D> THEN
                						DFND = D
                						MATCHED = 1
              					END ELSE
                						DFND = D + 1
              					END
            					CASE ESTD.OPV<1,T> > ESTJ.MS.OPER<1,D>
             						DFND = D + 1
         				END CASE
        			CASE ESTD.CCTR<1,T> > ESTJ.MS.CCTR<1,D>
          				DFND = D + 1
      			END CASE
    		CASE CCTR.DEPT > ESTJ.MS.DEPT<1,D>
      			DFND = D + 1
  	END CASE
NEXT D

IF MATCHED = 0 THEN
	IF DFND <= DCNT THEN
    		ESTJ.MS.DEPT = INSERT(ESTJ.MS.DEPT,1,DFND,0,"")
    		ESTJ.MS.CCTR = INSERT(ESTJ.MS.CCTR,1,DFND,0,"")
    		ESTJ.MS.OPER = INSERT(ESTJ.MS.OPER,1,DFND,0,"")
    		ESTJ.MS.DESC = INSERT(ESTJ.MS.DESC,1,DFND,0,"")
   		ESTJ.MS.DCOST = INSERT(ESTJ.MS.DCOST,1,DFND,0,"")
    		ESTJ.MS.COST = INSERT(ESTJ.MS.COST,1,DFND,0,"")
    		ESTJ.MS.SALE = INSERT(ESTJ.MS.SALE,1,DFND,0,"")
  	END
  	ESTJ.MS.DEPT<1,DFND> = CCTR.DEPT
  	ESTJ.MS.CCTR<1,DFND> = ESTD.CCTR<1,T>
  	ESTJ.MS.OPER<1,DFND> = ESTD.OPV<1,T>
  	ESTJ.MS.DESC<1,DFND> = ESTD.DESC<1,T>
END
ESTJ.MS.DCOST<1,DFND> = ESTJ.MS.DCOST<1,DFND> + ESTD.DCOST<1,T>
ESTJ.MS.COST<1,DFND> = ESTJ.MS.COST<1,DFND> + ESTD.COST<1,T>
ESTJ.MS.SALE<1,DFND> = ESTJ.MS.SALE<1,DFND> + ESTD.TSALE<1,T>
ESTJ.TOT.DCOST = ESTJ.TOT.DCOST + ESTD.DCOST<1,T>
ESTJ.TOT.COST = ESTJ.TOT.COST + ESTD.COST<1,T>
ESTJ.TOT.SALE = ESTJ.TOT.SALE + ESTD.TSALE<1,T>

CHKREC:
LN=1
 BEGIN CASE
 
    CASE INV.UNIT<1,2> = 'SHT' AND INV.UNIT<1,3> = 'LBS'
       ICR.DV1<LN> = INV.M.WT
       ICR.MT1<LN> = 1
       ICR.DV2<LN> = 1
       ICR.CNV<LN> = "MD0"
    CASE INV.UNIT<1,2> = 'PC' AND INV.UNIT<1,3> = 'MSI'
       ICR.DV1<LN> = INV.PAP.WIDTH/100
       ICR.MT1<LN> = 10
       ICR.DV2<LN> = 1
       ICR.CNV<LN> = "MD0"
    CASE INV.UNIT<1,2> = 'FT' AND INV.UNIT<1,3> = 'MSI'
       ICR.DV1<LN> = INV.PAP.WIDTH/100
       ICR.MT1<LN> = 100
       ICR.DV2<LN> = 12
       ICR.CNV<LN> = "MD0"
    CASE 1
       ICR.DV1<LN> = 10
       ICR.MT1<LN> = 1
       ICR.DV2<LN> = 1
         ICR.CNV<LN> = "MD2"
   END CASE
RETURN
RETURN

99999
IF ERRMSG # '' THEN
	STATUS = RBO.setProperty('','ServerStatus','1')        
	STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
END ELSE
	STATUS = RBO.setProperty('','ServerStatus','')        
	STATUS = RBO.setProperty('','ServerMessage','')
END
RETURN
