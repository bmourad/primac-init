SUBROUTINE ReleaseOutsidePO
********************************************************************************
*   Program name :- ReleaseOutsidePO
*   Created:- 5/20/2003
*------------------------------------------------------------------------------*
*
*PROGRAMMER NAME : G.PURUSHOTHAM RAO
* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE POS.CPYLIB OUTSIDE.PO
$INCLUDE JCS.CPYLIB JOB
$INCLUDE CPYLIB CHAR
$INCLUDE APS.CPYLIB VEND.STATS
$INCLUDE APS.CPYLIB VEND.PO.STATS
$INCLUDE APS.CPYLIB VEND.PROD.STATS
$INCLUDE JCS.CPYLIB JOB.STATS
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE PMC.CPYLIB SECURITY
$INCLUDE POS.CPYLIB APP.REQ

   OPEN '','OUTSIDE.PO' TO OUTSIDE.PO ELSE
      ERRMSG = 'OUTSIDE.PO FILE IS MISSING'
      GOSUB 93000
   END
   OPEN '','JOB' TO JOB ELSE
      ERRMSG = 'JOB FILE IS MISSING'
      GOSUB 93000
   END
   OPEN '','VEND.STATS' TO VEND.STATS ELSE
      ERRMSG = 'VEND.STATS FILE IS MISSING'
      GOSUB 93000
   END
   OPEN '','VEND.PO.STATS' TO VEND.PO.STATS ELSE
      ERRMSG = 'VEND.PO.STATS FILE IS MISSING'
      GOSUB 93000
   END
   OPEN '','VEND.PROD.STATS' TO VEND.PROD.STATS ELSE
      ERRMSG = 'VEND.PROD.STATS FILE IS MISSING'
      GOSUB 93000
   END
   OPEN '','OUT.REQ' TO OUT.REQ ELSE
      ERRMSG = 'OUT.REQ FILE IS MISSING'
      GOSUB 93000
   END
   OPEN "","JOB.STATS" TO JOB.STATS ELSE
      ERRMSG = "JOB.STATS FILE IS MISSING"
      GOTO 93000
   END
   OPEN "","COMPANY" TO COMPANY ELSE
      ERRMSG = "COMPANY FILE IS MISSING"
      GOTO 93000
   END
   OPEN '','APP.REQ' TO APP.REQ ELSE
      ERRMSG = 'APP.REQ FILE IS MISSING'; GOTO 93000
   END
   OPEN '','SECURITY' TO SECURITY ELSE
      ERRMSG = 'SECURITY FILE IS MISSING'; GOTO 93000
   END


* Get properties
REQ_FLAG = ''
STATUS = RBO.getProperty('','ID',ID)
STATUS = RBO.getProperty("","PMCProperty",PMCProperty)
CONO = PMCProperty<1,4>
USER.ID = UPCASE(PMCProperty<1,3>)
STATUS = RBO.getProperty('','REQ_FLAG',REQ_FLAG)
STATUS = RBO.getProperty('','OLD_JOB_NO',OLD.JOB.NO)
*vvv ADDED BY ABDUL GAFOOR ON 08/27/07
TEMP_REQ_FLAG = FIELD(REQ_FLAG,'!',1)
TEMP_OPO_SEQ = FIELD(REQ_FLAG,'!',2)
REQ_FLAG = TEMP_REQ_FLAG
*^^^
IF REQ_FLAG = "" THEN
	MATREAD OPO.REC FROM OUT.REQ, ID THEN
		MATWRITE OPO.REC ON OUTSIDE.PO, ID
	
	       CMD = 'DELETE OUT.REQ ' : '"' : ID : '"'
	       UDTEXECUTE CMD CAPTURING MSG
		
		ERRMSG = "Outside Purchase Order is created with PO# " : ID[4,99]
	END ELSE
	  ERRMSG = 'Outside PO Requistion record not present : ' : ID[4,99]
	  GOTO 93000
	END
END 
OPO.CODE = ID[4,99]

MATREAD COMP.REC FROM COMPANY,CONO ELSE MAT COMP.REC = ""

MATREAD OPO.REC FROM OUTSIDE.PO,ID THEN
*vvv ADDED BY ABDUL GAFOOR ON 08/27/07
   IF OPO.PROD.SEQ = "" THEN
      OPO.PROD.SEQ = TEMP_OPO_SEQ
   END
*^^^

   GOSUB 5000
END 

RETURN

5000 *
   *CASE (OPTION = 'F' OR OPTION = 'H') AND POS.INQ = 0
    GO.BACK = 0
    IF NOT(GO.BACK) THEN
       ;*24231 v
	  WORK.FILE = OUTSIDE.PO
	  UPDATE = "PO"
       ;*24231 ^
       OLD.JOB.CNT = DCOUNT(OLD.JOB.NO<1>,VM)
       FOR J = 1 TO OLD.JOB.CNT
	  THIS.JOB=OLD.JOB.NO<1,J>
	  LOCATE THIS.JOB IN OPO.JOB.NO<1>,1 SETTING VAL ELSE
	     MATREADU JSTAT.REC FROM JOB.STATS,CONO:THIS.JOB ELSE MAT JSTAT.REC = ""
	     PTR = 1
50                   
	     LOCATE OPO.CODE IN JSTAT.OPO.NO<1>,PTR SETTING SS ELSE SS = 0
	     IF SS THEN
		IF JSTAT.PROD.LINE<1,SS> # OPO.PROD.LINE<1,J> THEN
		   PTR = PTR + 1
		   GOTO 50
		END
		JSTAT.OPO.NO = DELETE(JSTAT.OPO.NO,1,SS,0)
		JSTAT.OPO.DATE = DELETE(JSTAT.OPO.DATE,1,SS,0)
		JSTAT.OPO.AMT = DELETE(JSTAT.OPO.AMT,1,SS,0)
		JSTAT.OPO.QTY = DELETE(JSTAT.OPO.QTY,1,SS,0)
		JSTAT.PROD.LINE = DELETE(JSTAT.PROD.LINE,1,SS,0)
		IF JSTAT.OPO.NO = "" AND JSTAT.SHP.TRANS = "" THEN
		   DELETE JOB.STATS, CONO : THIS.JOB
		END ELSE
		   IF UPDATE = "PO" THEN
		      MATWRITE JSTAT.REC ON JOB.STATS,CONO:THIS.JOB
		   END
		END
	     END ELSE
		RELEASE JOB.STATS, CONO : THIS.JOB
	     END
	  END
       NEXT J

       JOB.CNT = DCOUNT(OPO.JOB.NO<1>,VM)
       FOR J = 1 TO JOB.CNT
	  MATREADU JSTAT.REC FROM JOB.STATS,CONO:OPO.JOB.NO<1,J> ELSE
	     MAT JSTAT.REC = ""
	  END
	  PTR = 1
55                
	  LOCATE OPO.CODE IN JSTAT.OPO.NO<1>,PTR SETTING SS THEN
	     IF JSTAT.PROD.LINE<1,SS> # OPO.PROD.LINE<1,J>:"@":OPO.PROD.SEQ<1,J> THEN
		PTR = SS + 1
		GOTO 55
	     END
	  END
	  JSTAT.OPO.NO<1,SS> = OPO.CODE
	  JSTAT.OPO.DATE<1,SS> = OPO.DATE
	  JSTAT.OPO.AMT<1,SS> = OPO.EST.COST<1,J>
	  JSTAT.OPO.QTY<1,SS> = OPO.QTY<1,J>
	  JSTAT.PROD.LINE<1,SS> = OPO.PROD.LINE<1,J>:"@":OPO.PROD.SEQ<1,J>
	  IF UPDATE = "PO" THEN
	     MATWRITE JSTAT.REC ON JOB.STATS,CONO:OPO.JOB.NO<1,J>
	  END
       NEXT J
6 *
*
*--- APS STATISTICS
*
       IF CO.APS.O.INTRF > 2 THEN GOSUB 5001
*       MATWRITE OPO.REC ON WORK.FILE , CONO:OPO.CODE
       MORE = 1
       GOSUB SEND.MAIL
       RELEASE
    END
RETURN

5001 *
*
   GTOT.ORD.AMT = 0
   GTOT.REC.AMT = 0
   PO.CNT = DCOUNT(OPO.JOB.NO,VM) 
   FOR P = 1 TO PO.CNT
      ORD.QTY = OPO.QTY<1,P> - OPO.CANCEL.QTY<1,P>
      IF OPO.UOM<1,P> = 'M' THEN
         ORD.QTY = ORD.QTY / 1000
      END
      IF OPO.DISCOUNT<1,P> > 0 THEN
         DISC.AMT = INT(OPO.U.PRICE<1,P>*(OPO.DISCOUNT<1,P>/10000))
         COST = INT(OPO.U.PRICE<1,P> - DISC.AMT)
      END ELSE
         COST = OPO.U.PRICE<1,P>
      END
      GTOT.ORD.AMT = GTOT.ORD.AMT + (OPO.EST.COST<1,P> - OPO.CANCEL.COST<1,P>)   
   NEXT P
   VSTAT.KEY = CONO:OPO.VEND.NO:"!":"O"
   MATREADU VSTAT.REC FROM VEND.STATS, VSTAT.KEY ELSE
      MAT VSTAT.REC = ""
   END

   VSTAT.CNT = DCOUNT(VSTAT.PO,VM)
   LOCATE OPO.CODE IN VSTAT.PO<1>,1 SETTING POFND ELSE POFND = VSTAT.CNT + 1
   VSTAT.PO<1,POFND> = OPO.CODE
   VSTAT.PO.ORDERD<1,POFND> = GTOT.ORD.AMT
   IF UPDATE = "PO" THEN 
      MATWRITE VSTAT.REC ON VEND.STATS, VSTAT.KEY
   END
   VPS.KEY = VSTAT.KEY:"!":OPO.CODE
   MATREADU VPS.REC FROM VEND.PO.STATS, VPS.KEY ELSE
      MAT VPS.REC = ""
   END
   OPROD.CNT = DCOUNT(VPS.PROD,VM)
   FOR DP = OPROD.CNT TO 1 STEP -1
      JBCNT = DCOUNT(OPO.JOB.NO,VM)
      PTR = 1
      PDFND = 0
      DONE = 0
      LOOP
      UNTIL PTR > JBCNT OR DONE DO
         LOCATE VPS.PROD<1,DP> IN OPO.JOB.NO<1>,PTR SETTING PDFND ELSE DONE = 0
         IF PDFND THEN 
            IF VPS.WHSE<1,DP> = OPO.PROD.LINE<1,PDFND>:'@':OPO.PROD.SEQ<1,PDFND> THEN
               DONE = 1
            END ELSE
               DONE = 0
            END
         END
         PTR = PDFND + 1
      REPEAT
      IF DONE = 0 THEN
         VPDS.KEY = VPS.KEY:"!":VPS.PROD<1,DP>:"!":VPS.WHSE<1,DP>
         DELETE VEND.PROD.STATS, VPDS.KEY
         VPS.PROD = DELETE(VPS.PROD,1,DP,0)
         VPS.SEQ.NO = DELETE(VPS.SEQ.NO,1,DP,0)
         VPS.PROD.DESC = DELETE(VPS.PROD.DESC,1,DP,0)
         VPS.U.M = DELETE(VPS.U.M,1,DP,0)
         VPS.WHSE = DELETE(VPS.WHSE,1,DP,0)
         VPS.ORD.QTY = DELETE(VPS.ORD.QTY,1,DP,0)
         VPS.ORD.AMT = DELETE(VPS.ORD.AMT,1,DP,0)
         VPS.REC.QTY = DELETE(VPS.REC.QTY,1,DP,0)
         VPS.REC.AMT = DELETE(VPS.REC.AMT,1,DP,0)
         VPS.VOU.QTY = DELETE(VPS.VOU.QTY,1,DP,0)
         VPS.VOU.AMT = DELETE(VPS.VOU.AMT,1,DP,0)
         VPS.VOU.NO = DELETE(VPS.VOU.NO,1,DP,0)
      END
   NEXT DP
   APROD.CNT = DCOUNT(OPO.JOB.NO,VM) 
   FOR UAP = 1 TO APROD.CNT
      PTR = 1
      PDFND = 0
      DONE = 0
      LOOP
         VPS.CNT = DCOUNT(VPS.PROD<1>,VM)
      UNTIL PTR > VPS.CNT OR DONE = 1 DO
         LOCATE OPO.JOB.NO<1,UAP> IN VPS.PROD<1>,PTR SETTING PDFND ELSE DONE = 0
         IF PDFND THEN
            IF OPO.PROD.LINE<1,UAP>:'@':OPO.PROD.SEQ<1,UAP> = VPS.WHSE<1,PDFND> THEN DONE = 1 ELSE DONE = 0
         END
         PTR = PDFND + 1
      REPEAT
      IF DONE THEN
         LOC = PDFND
      END ELSE
         LOC = VPS.CNT+1
      END
      ORD.QTY = OPO.QTY<1,UAP> - OPO.CANCEL.QTY<1,UAP>
      IF OPO.UOM<1,UAP> = 'M' THEN
         ORD.QTY = ORD.QTY / 1000
      END
      IF OPO.DISCOUNT<1,UAP> > 0 THEN
         DISC.AMT = INT(OPO.U.PRICE<1,UAP>*(OPO.DISCOUNT<1,UAP>/10000))
         COST = INT(OPO.U.PRICE<1,UAP> - DISC.AMT)
      END ELSE
         COST = OPO.U.PRICE<1,UAP>
      END
      BEGIN CASE                                             
         CASE OPO.UOM<1,UAP> = "M"                            
            ORD.COST = INT(((COST/100) * (ORD.QTY/100)) + .5)  
         CASE OPO.UOM<1,UAP> = "C"                            
            ORD.COST = INT(((COST/100) * (ORD.QTY/10000)) + .5)
         CASE 1                                               
            ORD.COST = INT(((COST/100) * (ORD.QTY/100)) + .5)  
      END CASE                                               
      IF ORD.COST < 0 THEN ORD.COST = 0
      IF OPO.UOM<1,UAP> = 'M' THEN
         ORD.QTY = ORD.QTY * 1000
      END
      VPS.PROD<1,LOC> = OPO.JOB.NO<1,UAP>
      READV JOB.DESCR FROM JOB,CONO:OPO.JOB.NO<1,UAP>,16 ELSE JOB.DESCR = ''
      VPS.PROD.DESC<1,LOC> = JOB.DESCR<1,1>
      VPS.U.M<1,LOC> = OPO.UOM<1,UAP>
      VPS.WHSE<1,LOC> = OPO.PROD.LINE<1,UAP>:'@':OPO.PROD.SEQ<1,UAP>
      VPS.ORD.QTY<1,LOC> = ORD.QTY
      VPS.ORD.AMT<1,LOC> = ORD.COST
      VPDS.KEY = VPS.KEY:"!":OPO.JOB.NO<1,UAP>:"!":OPO.PROD.LINE<1,UAP>:'@':OPO.PROD.SEQ<1,UAP>
      MATREADU VPDS.REC FROM VEND.PROD.STATS, VPDS.KEY ELSE
         MAT VPDS.REC = ""
      END
      VPDS.ORD.DATE = "" ; VPDS.ORD.QTY = "" ; VPDS.ORD.UN.COST = ""
      VPDS.ORD.DATE<1> = OPO.DATE<1>
      VPDS.ORD.QTY<1> = ORD.QTY
      IF OPO.DISCOUNT<1,UAP> > 0 THEN
         DISC.AMT = INT(OPO.U.PRICE<1,UAP>*(OPO.DISCOUNT<1,UAP>/10000))
         VPDS.ORD.UN.COST<1> = INT(OPO.U.PRICE<1,UAP> - DISC.AMT)
      END ELSE
         VPDS.ORD.UN.COST<1> = OPO.U.PRICE<1,UAP>
      END
      VPDS.TAX.FLG<1> = OPO.TAXABLE<1,UAP>
      VPDS.PO.ACCT<1> = OPO.ACCTNO<1,UAP>
      VPDS.PO.DIV<1> = OPO.DVDPCC<1,1,UAP>
      VPDS.PO.DEPT<1> = OPO.DVDPCC<1,2,UAP>
      VPDS.PO.CCTR<1> = OPO.DVDPCC<1,3,UAP>
      VPDS.OPER.PERF<1> = OPO.OPER.CODE<1,1,UAP>
      IF UPDATE = "PO" THEN
         MATWRITE VPDS.REC ON VEND.PROD.STATS, VPDS.KEY
      END
   NEXT UAP
   MATWRITE VPS.REC ON VEND.PO.STATS, VPS.KEY
RETURN

**********
SEND.MAIL:
**********
*
   IF OPO.APP.LEVEL # "C" THEN
      SUBJECT = "Outside PO requisition ":OPO.CODE :" is ready for approval."
   END ELSE
      SUBJECT = "Outside PO requisition " :OPO.CODE:" has been canceled"
   END
   MATREAD SEC.REC FROM SECURITY,CONO:OPO.APPROVER THEN
      IF SEC.EMAIL # "" THEN
         CMD = "!touch ":USER.ID
         UDTEXECUTE CMD CAPTURING MSG
         CMD = '!mail -s ':'"':SUBJECT:'" ':SEC.EMAIL:' < ':USER.ID
         IF APP.PO.LEVEL # 1 THEN
            UDTEXECUTE CMD CAPTURING MSG
         END
      END
   END
   CMD ="!rm ":USER.ID
   UDTEXECUTE CMD CAPTURING MSG
   RETURN
*


* End of method code
93000 
  STATUS = RBO.setProperty('','ServerStatus',1)        
  STATUS = RBO.setProperty('','ServerMessage',ERRMSG) 
  RETURN
99999 
RETURN

