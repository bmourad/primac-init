SUBROUTINE VALIDATE_VOUCHER
********************************************************************************
*   Program name :- VALIDATE_VOUCHER
*   Created:- 2/7/2006
*   Auther:-Sk. zahoor Ahmed
*   Description :-This program Validates the Voucher
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H

$INCLUDE CPYLIB CHAR
$INCLUDE APS.CPYLIB VEND.POP
$INCLUDE APS.CPYLIB VEND.VOUCH.POP
$INCLUDE APS.CPYLIB OAP
$INCLUDE PMC.CPYLIB VEND
$INCLUDE APS.CPYLIB CKP
ERRMSG = ''
  OPEN '','CONTROL' TO CONTROL ELSE ERRMSG ='CONTROL FILE IS MISSING'; GOTO 99999
  OPEN '','COMPANY' TO COMPANY ELSE ERRMSG ='COMPANY FILE IS MISSING'; GOTO 99999
  OPEN '','VEND.POP' TO VEND.POP ELSE ERRMSG ='VEND.POP FILE IS MISSING'; GOTO 99999
  OPEN '','CKP' TO CKP ELSE ERRMSG ='CKP FILE IS MISSING'; GOTO 99999
  OPEN '','OAP' TO OAP ELSE ERRMSG = 'OAP FILE IS MISSING'; GOTO 99999
  OPEN '','VEND' TO VEND ELSE ERRMSG = 'VEND FILE IS MISSING'; GOTO 99999

	STATUS = RBO.getProperty('','Cono',CONO)
	STATUS = RBO.getProperty('','VEND_NO',VEND.NO)
	STATUS = RBO.getProperty('','DIV_CODE',DIV.CODE)
	STATUS = RBO.getProperty('','OAP_VOUCH',OAP_VOUCH)
	STATUS = RBO.getProperty('','LN_NO',LN)
	STATUS = RBO.getProperty('','VendorDesc',VPOP.VEND.DESC) 

 READ VPOP.VEND FROM VEND.POP,CONO:"VENDORS":DIV.CODE ELSE VPOP.VEND = ''
VN = LN + VPOP.START.ATT - 1
VPOP.VEND<VN> = VEND.NO
  MATREAD OAP.REC FROM OAP,CONO:OAP_VOUCH ELSE
    ERRMSG = 'INVALID VOUCHER':CONO:OAP_VOUCH
    GOTO 99999
  END
*T27613
IF DIV.CODE # "ALL" THEN
  IF OAP.DIV.OWNER # DIV.CODE THEN
    ERRMSG = "THIS VOUCHER HAS OWNING DIVISION OF ":OAP.DIV.OWNER
    GOTO 99999
  END
END
*T27613
  IF OAP.VEND<1,1> # VPOP.VEND<VN,1> THEN
    ERRMSG = "VOUCHER HAS A DIFFERENT VENDOR"      ;*T22829
    GOTO 99999
  END
  IF OAP.VEND<1,2> # '' THEN
    IF VPOP.VEND<VN,2> # '' AND OAP.VEND<1,2> # VPOP.VEND<VN,2> THEN
      ERRMSG = 'VOUCHER HAS A DIFFERENT VENDOR'     ;*T22829
      GOTO 99999
    END ELSE
      LOCATE OAP.VEND IN VPOP.VEND,VPOP.START.ATT SETTING MARKER ELSE
        MARKER = 0
      END
      IF MARKER # 0 AND MARKER # VN THEN
        ERRMSG = "VOUCHER HAS A DIFFERENT VENDOR LINE"      ;*T22829
        GOTO 99999
      END ELSE
        VPOP.VEND<VN> = OAP.VEND
        VPOP.VEND.DESC = OAP.VEND<1,2>
      END
    END
  END
*
    DEFAULT = OCONV(OAP.GRS.AMT - OAP.PAID.AMT - OAP.DSC.PAID, "MD2")
    IF DEFAULT < 0 AND OAP.GRS.AMT > 0 THEN DEFAULT = 0
    IF DEFAULT > 0 AND OAP.GRS.AMT < 0 THEN DEFAULT = 0
36000*
	STATUS = RBO.setProperty('','OAP_INV',OAP.INV)
	STATUS = RBO.setProperty('','OAP_PO',OAP.PO)
	STATUS = RBO.setProperty('','OAP_DUE_DATE',OCONV(OAP.DUE.DATE,"D2/"))
	STATUS = RBO.setProperty('','OAP_GRS_AMT',OAP.GRS.AMT)
	STATUS = RBO.setProperty('','OAP_PAID_AMT',OAP.PAID.AMT)
	STATUS = RBO.setProperty('','DEFAULT_AMT',DEFAULT)
	STATUS = RBO.setProperty('','OAP_DSC_AMT',OCONV(OAP.DSC.AMT,"MD2"))
	STATUS = RBO.setProperty('','OAP_DSC_PAID',OAP.DSC.PAID)
	STATUS = RBO.setProperty('','VEND_NO',VPOP.VEND<VN>)
	STATUS = RBO.setProperty('','VendorDesc',VPOP.VEND.DESC)

* End of method code
99999
  IF (TRIM(ERRMSG) # "") THEN
       STATUS = RBO.setProperty('','ServerStatus','E')
       STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
  END ELSE
       STATUS = RBO.setProperty('','ServerStatus','')
       STATUS = RBO.setProperty('','ServerMessage','')
  END 
RETURN
