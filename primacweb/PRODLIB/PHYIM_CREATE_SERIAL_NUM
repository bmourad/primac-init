SUBROUTINE PHYIM_CREATE_SERIAL_NUM
********************************************************************************
*   Program name :- PHYIM_CREATE_SERIAL_NUM
*   Created:- 12/2/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE ICS.CPYLIB INV_SERIAL
* Insert method code here


OPEN '','CONTROL' TO CONTROL ELSE
	ERRMSG = 'CONTROL FILE IS MISSING'
	GOTO 99999
END

OPEN '','INV_SERIAL_TEMP' TO INV_SERIAL_TEMP ELSE 
	ERRMSG = "INV_SERIAL_TEMP FILE IS MISSING"
	GOTO 99999
END
OPEN '','INV_SERIAL' TO INV_SERIAL ELSE
	ERRMSG = 'INV_SERIAL FILE IS MISSING'
	GOTO 99999
END

TEMP.RECEIPT=""

ERRMSG = RBO.getProperty('','ID',ID)
CONO = ID[1,3]

GET.SERIAL:

	READU SERIAL.SEQ FROM CONTROL, CONO:"ISTK.SEQ" ELSE
		SERIAL.SEQ = 0
	END
	FND=0
	LOOP
		SERIAL.SEQ += 1
	  	IF SERIAL.SEQ > 9999999 THEN SERIAL.SEQ = 1
  		SERIAL.SEQ =  SERIAL.SEQ"R%7"
	  	CALL CHECK_DIGIT("C",SERIAL.SEQ,"10RL",CKDIG,VALID)
  		SERIAL.NO=SERIAL.SEQ:CKDIG
	  	ISTK.ID = CONO:SERIAL.NO
  		IF VALID THEN
    			IF RECORDLOCKED(INV_SERIAL_TEMP,ISTK.ID) = 0 THEN
	      			DELETE INV_SERIAL_TEMP,ISTK.ID
    			END
    			READU CHECKREC FROM INV_SERIAL_TEMP,ISTK.ID LOCKED
	      		NULL
    		END ELSE
      			READU CHECKREC FROM INV_SERIAL,ISTK.ID THEN
        			RELEASE INV_SERIAL, ISTK.ID
	        		RELEASE INV_SERIAL_TEMP,ISTK.ID
      			END ELSE
        			FND = 1
	      		END
    		END
	END
	UNTIL FND DO
		RELEASE INV_SERIAL,ISTK.ID
	REPEAT
	WRITE SERIAL.SEQ ON CONTROL,CONO:"ISTK.SEQ"
	TEMP.RECEIPT = ISTK.RECP
	STATUS = RBO.setProperty('','PHYSI_TEMP_OUTPUT',SERIAL.NO : @VM : TEMP.RECEIPT)
RETURN


99999 ;* ERROR CONTROL BLOCK
	IF ERRMSG # "" THEN
		VAL = RBO.setProperty('','ServerStatus','1')
		VAL = RBO.setProperty('','ServerMessage',ERRMSG)
	END ELSE
		VAL = RBO.setProperty('','ServerStatus','')
	END
	RELEASE
RETURN
