SUBROUTINE CHECK_BOLNO
********************************************************************************
*   Program name :- CHECK_BOLNO
*   Created:- 5/2/2006
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE OPS.CPYLIB ORDER
$INCLUDE PMC.CPYLIB COMP.OPS
$INCLUDE PMC.CPYLIB CUSTOMER
$INCLUDE ICS.CPYLIB FNGD.BOM
$INCLUDE PMC.CPYLIB SHIP.TO
$INCLUDE PMC.CPYLIB SHIP.VIA
$INCLUDE PMC.CPYLIB FISCAL
$INCLUDE PMC.CPYLIB SALESDATES
$INCLUDE PMC.CPYLIB FOB
$INCLUDE OPS.CPYLIB ORDER.DETAIL
$INCLUDE OPS.CPYLIB BOL
$INCLUDE OPS.CPYLIB PICK.TICKET
$INCLUDE OPS.CPYLIB ORDER.RELEASE
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE ICS.CPYLIB CATEGORY
$INCLUDE ICS.CPYLIB INV_SERIAL       
$INCLUDE ICS.CPYLIB INV_RECEIPTS     
$INCLUDE ICS.CPYLIB INV_RECP_WHSE    
$INCLUDE ICS.CPYLIB INV.CNV    
$INCLUDE CPYLIB CHAR
MAT BOL.REC = ''
LN = 1;FIRST = 0;TEMP.DESC = "";TEMP.AVAIL = "";TEMP.SID = "";TEMP.LOC.AVAIL = "" ; *used only to pass qty. avail to BOL.LOC.SUB
NUM.ON.SCRN = "";ROND='';OLD.RELNO=''; OLD.PKTKT='';MAT ORR.REC = '';MAT PKT.REC = ''

IF FILEINFO(CONTROL,0)=0 THEN
  OPEN '','CONTROL' TO CONTROL ELSE
    ERRMSG='CONTROL file is missing!'
    GOTO 93000
  END
END
IF FILEINFO(ORDER,0)=0 THEN
  OPEN '','ORDER' TO ORDER ELSE
    ERRMSG='ORDER file is missing!'
    GOTO 93000
  END
END
OPEN "","SHIP.TO" TO SHIP.TO ELSE
  ERRMSG = "Cannot locate the SHIP.TO file"; GOTO 93000
END
OPEN "","DAILY.BOL" TO DAILY.BOL ELSE
  ERRMSG = "Cannot locate the DAILY.BOL file"; GOTO 93000
END
OPEN "","BOL" TO BOL ELSE
  ERRMSG = "Cannot locate the BOL file"; GOTO 93000
END
OPEN "","PICK.TICKET" TO PICK.TICKET ELSE
  ERRMSG = "Cannot locate the PICK.TICKET file"; GOTO 93000
END
OPEN "","FOB" TO FOB ELSE
  ERRMSG = "Cannot locate the FOB file"; GOTO 93000
END
OPEN "","FNGD.BOM" TO FNGD.BOM ELSE
  ERRMSG = "Cannot locate the FNGD.BOM file"; GOTO 93000
END
OPEN "","INV.FNGD" TO INV.FNGD ELSE
  ERRMSG = "Cannot locate the INV.FNGD file"; GOTO 93000
END
OPEN "","ORDER.DETAIL" TO ORDER.DETAIL ELSE
  ERRMSG = "Cannot locate the ORDER.DETAIL file"; GOTO 93000
END
OPEN "","INV.HIST" TO INV.HIST ELSE
  ERRMSG = "Cannot locate the INV.HIST file"; GOTO 93000
END
OPEN "","INVENTORY" TO INVENTORY ELSE
  ERRMSG = "Cannot locate the INVENTORY file"; GOTO 93000
END
OPEN "","INV.WHSE" TO INV.WHSE ELSE
  ERRMSG = "Cannot locate the INV.WHSE file"; GOTO 93000
END
OPEN "","CATEGORY" TO CATEGORY ELSE
  ERRMSG = "Cannot locate the CATEGORY file"; GOTO 93000
END
OPEN "","SECURITY" TO SECURITY ELSE ERRMSG = "SECURITY FILE MISSING"; GOTO 93000
OPEN "","CUSTOMER" TO CUSTOMER ELSE ERRMSG = "CUSTOMER FILE MISSING"; GOTO 93000
OPEN "","ORDER.RELEASE" TO ORDER.RELEASE ELSE ERRMSG = "ORDER.RELEASE FILE MISSING"; GOTO 93000
IF FILEINFO(INV_RECEIPTS,0)=0 THEN                           
  OPEN '','INV_RECEIPTS' TO INV_RECEIPTS ELSE                
    ERRMSG="INV_RECEIPTS FILE IS MISSING";GOTO 93000         
  END                                                        
END                                                          
IF FILEINFO(INV_RECEIPTS_TEMP,0)=0 THEN                      
  OPEN '','INV_RECEIPTS_TEMP' TO INV_RECEIPTS_TEMP ELSE      
    ERRMSG="INV_RECEIPTS_TEMP FILE IS MISSING";GOTO 93000    
  END                                                        
END                                                          
IF FILEINFO(INV_RECP_WHSE,0)=0 THEN                          
  OPEN '','INV_RECP_WHSE' TO INV_RECP_WHSE ELSE              
    ERRMSG="INV_RECP_WHSE FILE IS MISSING";GOTO 93000        
  END                                                        
END                                                          
IF FILEINFO(INV_RECP_WHSE_TEMP,0)=0 THEN                     
  OPEN '','INV_RECP_WHSE_TEMP' TO INV_RECP_WHSE_TEMP ELSE    
    ERRMSG="INV_RECP_WHSE_TEMP FILE IS MISSING";GOTO 93000   
  END                                                        
END                                                          
IF FILEINFO(INV_SERIAL_TEMP,0)=0 THEN                     
  OPEN '','INV_SERIAL_TEMP' TO INV_SERIAL_TEMP ELSE    
    ERRMSG="INV_SERIAL_TEMP FILE IS MISSING";GOTO 93000   
  END                                                        
END                                                          
IF FILEINFO(INV_SERIAL,0)=0 THEN                     
  OPEN '','INV_SERIAL' TO INV_SERIAL ELSE    
    ERRMSG="INV_SERIAL FILE IS MISSING";GOTO 93000   
  END                                                        
END                                                          
*
DEFFUN DIVISION.POSITION(CONO,CONTROL.FILE,DIV.CODE)        
DEFFUN CURRENT.PERIOD(CONO,CONTROL.FILE,DIV.POS,FISCAL.FLAG)
DEFFUN CalcStkQty(COST.QTY,MAT INV.CNV.REC,ROND,LN)
*
   RELEASE
   ORDNO = ""; RELNO = ""; PKTKTNO = ""
   CUSTNO = ""; SHPNO = ""; OLD.RELNO = ""
   OLD.PKTKT = "";* T20852
   
STATUS=RBO.getProperty('','ID',ID)
STATUS=RBO.getProperty('','PMCProperty',PMCProperty)
UserId= PMCProperty<1,3>
CONO=PMCProperty<1,4>
BOLNO=ID
MATREAD FISCAL.REC FROM CONTROL, CONO:"OPFISCAL" ELSE
  ERRMSG = "Cannot locate Order Processing Fiscal Period !!"
  GOTO 93000
END
MATREAD SALESDATES.REC FROM CONTROL, CONO:"SALESDATES" ELSE
  ERRMSG = "Cannot locate the Sales period ending dates !!"
  GOTO 93000
END
READ PERIOD.REC FROM CONTROL, CONO:"ACCT.PERIODS" ELSE
  PERIOD.REC = ""
  PERIOD.REC<1> = 12
END
NUM.PERIODS = PERIOD.REC<1>
READ DIVISION.REC FROM CONTROL, CONO:"DIVISIONS" ELSE
  ERRMSG = "DIVISIONS CONTROL RECORD IS MISSING"
  GOTO 93000
END
*
READ SECURITY.REC FROM CONTROL, CONO:"DIV.SECURITY" ELSE
  ERRMSG = "DIV.SECURITY CONTROL RECORD IS MISSING"; GOTO 93000
END
   MATREAD OPCO.REC FROM CONTROL, CONO:"OPS" ELSE
      MAT OPCO.REC = ""
   END
  BEGIN CASE   
      CASE ID = "O" AND OPCO.SHP.FRM = "R"
         ERRMSG = "Release required for shipment! "
         GOTO 93000
      CASE ID = "N" AND OPCO.SHP.FRM = "R"
         ERRMSG = "Release required for shipment! "
         GOTO 93000
      CASE ID = "R" AND OPCO.SHP.FRM = "O"
         ERRMSG = "Shipment from Release not allowed! "
         GOTO 93000
 END CASE
STATUS = RBO.setProperty('','OPCO_SHP_FRM',OPCO.SHP.FRM)
IF ID="N" OR ID="O"  OR ID="R"  OR ID="P"  OR ID=""  THEN 
	ERRMSG = "NEW"
       GOTO 93000
	RETURN
END
  MATREAD BOL.REC FROM DAILY.BOL, CONO:ID ELSE
      ERRMSG = "Cannot locate Bill Of Lading # ":ID
      GOTO 93000
      RELEASE DAILY.BOL, CONO:ID
   END
   CUSTNO = BOL.CUST
   SHPNO = BOL.SHIP.TO
   BEGIN CASE
      CASE BOL.TYPE<1,1> = "O"
         ORDNO = BOL.ORDER<1,1>
      CASE BOL.TYPE<1,1> = "R"
         ORDNO = BOL.ORDER<1,1>
         RELNO = BOL.RELEASE<1,1>
      CASE BOL.TYPE<1,1> = "T"
         ORDNO = BOL.ORDER<1,1>
         RELNO = BOL.RELEASE<1,1>;* T20852
         PKTKTNO = BOL.PKTKT<1,1>
      CASE 1
         ORDNO = BOL.ORDER<1,1>
         RELNO=""; PKTKTNO=""
   END CASE
   OLD.RELNO = BOL.RELEASE
   OLD.PKTKT = BOL.PKTKT
   GOSUB 4000
   IF ERRMSG # "" THEN
      RELEASE DAILY.BOL, CONO:ID
      GOTO 93000
   END
RETURN
   4000*
   ERRMSG = ""
   BEGIN CASE
      CASE PKTKTNO # ""
         MATREAD PKT.REC FROM PICK.TICKET, CONO:PKTKTNO ELSE
            ERRMSG = "Cannot locate Pick Ticket # ":PKTKTNO
	     GOTO 93000
            RETURN
         END
         BEGIN CASE
            CASE SUM(PKT.SHIP.QTY) > 0
               ERRMSG = "Ticket has already been shipped"
	     GOTO 93000
    	        RETURN
            CASE PKT.BOL # "" AND PKT.BOL # BOLNO
               ERRMSG = "Ticket is on Bill of Lading ":PKT.BOL
	     GOTO 93000
		RETURN
         END CASE
         IF PKT.REL.NO = "" THEN
            DASH.FOUND = 0
            CHARCNT = LEN(PKTKTNO)
            FOR XX = CHARCNT TO 1 STEP (-1) UNTIL DASH.FOUND
               IF PKTKTNO[XX,1] = "-" THEN
                  ORDNO = PKTKTNO[1,XX-1]
                  DASH.FOUND = 1
               END
            NEXT XX
         END ELSE
            MATREAD ORR.REC FROM ORDER.RELEASE, CONO:PKT.REL.NO ELSE
               ERRMSG = "Cannot locate Release # ":PKT.REL.NO
    	       GOTO 93000
              RETURN
            END
            ORDNO = ORR.ORD
            RELNO = PKT.REL.NO
         END
         SHPNO = PKT.SHIP.TO
         GOSUB 4100
	
         IF ERRMSG # "" THEN
	     GOTO 93000
            RETURN
         END
	 IF PKT.REL.NO = "" THEN
            IF ORD.REL.NO # "" THEN
               ERRMSG = "Release required for shipment! "
 	       GOTO 93000      
              RETURN
            END
         END ELSE
            LOCATE PKT.REL.NO IN ORD.REL.NO<1>,1 SETTING FND ELSE
               ERRMSG = "Cannot locate ticket release # on order! "
 		 GOTO 93000
               RETURN
            END
         END
	
         AVL.PROD = ""; AVL.WHSE = ""; AVL.QTY = ""
         FOR PDNO = PDCNT TO 1 STEP -1
            PNO = PDPTR<PDNO>; PPOS = 1
	   
            LOOP
               LOCATE OSD.PROD<1,PNO> IN PKT.PROD<1>,PPOS SETTING PLOC THEN
                  IF (OSD.WHSE<1,PNO> = PKT.WHSE<1,PLOC>) AND (OSD.KIT<1,PNO> = PKT.KIT<1,PLOC>) AND (OSD.PROD.SEQ<1,PNO> = PKT.SEQ<1,PLOC>) THEN
                     PPOS = 0
                     QCNT = DCOUNT(QTYPTR<PDNO>,VM)
                     FOR QNO = QCNT TO 1 STEP -1
                        RNO = QTYPTR<PDNO,QNO>
                        IF OSD.REL.NO<1,PNO,RNO> # RELNO THEN
                           QTYPTR = DELETE(QTYPTR,PDNO,QNO,0)
			
                        END ELSE
                           LOCATE OSD.RECP.NO<1,PNO,RNO> IN PKT.RECP.NO<1,PLOC>,1 SETTING FND ELSE
                              QTYPTR = DELETE(QTYPTR,PDNO,QNO,0)
                           END
			  
                        END
                     NEXT QNO
                     IF QTYPTR<PDNO> = "" THEN
                        PDPTR = DELETE(PDPTR,PDNO,0,0)
                        QTYPTR = DELETE(QTYPTR,PDNO,0,0)
                     END
		     
                  END
               END ELSE
                  PDPTR = DELETE(PDPTR,PDNO,0,0)
                  QTYPTR = DELETE(QTYPTR,PDNO,0,0)
                  PPOS = 0
               END
            WHILE PPOS DO
               PPOS = PLOC + 1
            REPEAT
         NEXT PDNO
	 
         PDCNT = DCOUNT(PDPTR,AM)
         IF PDCNT < 1 THEN
            ERRMSG = "Cannot locate any available quantity for this Pick Ticket":PKTKTNO
	       GOTO 93000
              RETURN
         END

      CASE RELNO # ""
         MATREAD ORR.REC FROM ORDER.RELEASE, CONO:RELNO ELSE
            ERRMSG = "Cannot locate release # ":RELNO
  	       GOTO 93000
              RETURN
         END
         ORDNO = ORR.ORD
         SHPNO = ORR.SHIP.TO
         GOSUB 4100
         IF ERRMSG # "" THEN 
	     GOTO 93000
            RETURN
         END
	 IF ORD.PICK.NO # "" THEN
            ERRMSG = "Picking Ticket # required for this order."
	    GOTO 93000
           RETURN
         END
         FOR PDNO = PDCNT TO 1 STEP -1
            PNO = PDPTR<PDNO>
            QCNT = DCOUNT(QTYPTR<PDNO>,VM)
            FOR QNO = QCNT TO 1 STEP -1
               RNO = QTYPTR<PDNO,QNO>
               IF OSD.REL.NO<1,PNO,RNO> # RELNO THEN
                  QTYPTR = DELETE(QTYPTR,PDNO,QNO,0)
               END
            NEXT QNO
            IF QTYPTR<PDNO> = "" THEN
               PDPTR = DELETE(PDPTR,PDNO,0,0)
               QTYPTR = DELETE(QTYPTR,PDNO,0,0)
            END
         NEXT PDNO
         PDCNT = DCOUNT(PDPTR,AM)
         IF PDCNT < 1 THEN
            ERRMSG = "Cannot locate any available quantity for Release # ":RELNO
              GOTO 93000
              RETURN
         END
      CASE 1
         GOSUB 4100
         IF ERRMSG # "" THEN
	       GOTO 93000
              RETURN
	 END     
   END CASE
4099*
   RETURN
4100*
   MATREAD ORD.REC FROM ORDER, CONO:ORDNO ELSE
      RELEASE ORDER, CONO:ORDNO
      ERRMSG = "Cannot locate Order # ":ORDNO
	GOTO 93000
       RETURN
   END
   DIV.CODE = ORD.DIV; USER.ID = UPCASE(UserId); ERRMSG = ''
   CALL CK.DIV.SEC.SUB(CONO,DIV.CODE,USER.ID,ERRMSG)
   IF ERRMSG # '' THEN 
	GOTO 93000
       RETURN
   END
   GOSUB 6000
   IF ERRMSG # '' THEN GOTO 93000
   IF ORD.STATUS<1,1> = "CLOSED" OR ORD.STATUS<1,1> = "CANCEL" THEN
      RELEASE ORDER, CONO:ORDNO
      ERRMSG = "Order has either been closed or cancelled"
      GOTO 93000
      RETURN
   END
   IF CUSTNO = "" THEN
      CUSTNO = ORD.CUST
   END ELSE
      IF CUSTNO # ORD.CUST THEN
         RELEASE ORDER, CONO:ORDNO
         ERRMSG = "Order (":ORDNO:") belongs to customer # ":ORD.CUST
         GOTO 93000
         RETURN
      END
   END
   MATREAD CUST.REC FROM CUSTOMER, CONO:ORD.CUST ELSE
      RELEASE ORDER, CONO:ORDNO
      ERRMSG = "Cannot locate customer # ":ORD.CUST
      GOTO 93000
      RETURN
   END
   LOCATE SHPNO IN ORD.SHIP.TO<1>,2 SETTING SLOC ELSE
      ERRMSG = "Cannot associate ship to (":SHPNO:") with order # ":ORDNO
      GOTO 93000
      RETURN
   END
   MATREAD SPT.REC FROM SHIP.TO, CONO:CUSTNO:"!":SHPNO ELSE
      ERRMSG = "Cannot locate ship to # ":SHPNO
      GOTO 93000
      RETURN
   END
   MATREAD ORD.DET.REC FROM ORDER.DETAIL, CONO:ORDNO:"!":SHPNO ELSE
      ERRMSG = "Cannot locate Order / Ship to # ":ORDNO:" / ":SHPNO
      GOTO 93000
      RETURN
   END
   PCNT = DCOUNT(OSD.PROD,VM)
   PDPTR = ""; QTYPTR = ""
   PRODPTR = ""
   FOR PNO = 1 TO PCNT
      RCNT = DCOUNT(OSD.FI.QTY<1,PNO>,SVM)
      FOR RNO = 1 TO RCNT
*
         IF OSD.KIT<1,PNO> # "N" THEN
            IF OSD.KIT<1,PNO> = "K" THEN
               IF OSD.FI.QTY<1,PNO,RNO> > 0 THEN
                  LOCATE PNO IN PDPTR,1 SETTING PLOC ELSE
                     PDPTR<PLOC> = PNO
                  END
                  QTYPTR<PLOC,-1> = RNO
               END ELSE
                  LOCATE PNO IN PDPTR,1 SETTING PLOC ELSE
                     PDPTR<PLOC> = PNO
                  END
                  QTYPTR<PLOC,-1> = RNO + 1
               END
            END ELSE
               IF OSD.FI.QTY<1,PNO,RNO> > 0 THEN
                  LOCATE PNO IN PDPTR,1 SETTING PLOC ELSE
                     PDPTR<PLOC> = PNO
                  END
                  QTYPTR<PLOC,-1> = RNO
               END
            END
         END ELSE
            IF OSD.FI.QTY<1,PNO,RNO> > 0 THEN
               LOCATE PNO IN PDPTR,1 SETTING PLOC ELSE
                  PDPTR<PLOC> = PNO
               END
               QTYPTR<PLOC,-1> = RNO
            END
         END
      NEXT RNO
   NEXT PNO
   PDCNT = DCOUNT(PDPTR,AM)
   IF PDCNT < 1 THEN
      ERRMSG = "Cannot locate any available quantity for this Order/Ship to ":ORDNO:" / ":SHPNO
      GOTO 93000
      RETURN
   END
4199*
   RETURN
6000*
   DIV.POS=DIVISION.POSITION(CONO,CONTROL,DIV.CODE)                       
   IF DIV.POS<1,1>='' THEN                                                
      DIV.POS=DIV.POS<1,2>
      CUR.PERIOD=CURRENT.PERIOD(CONO,CONTROL,DIV.POS,'OP')
      IF CUR.PERIOD<1,1>='' THEN
         CUR.PERIOD=CUR.PERIOD<1,2>
         ERR.FLG='' ; ERRMSG='' ; NEXT.PERIOD=''
         CALL GET.NEXT.PERIOD(CONO,DIV.CODE,'OP',NEXT.PERIOD,ERR.FLG,ERRMSG)
         VALDAT_PR=''
         VALDAT_PR<1>=CUR.PERIOD:VM:NEXT.PERIOD
         TODAY=DATE()
         DEFAULT_PR=CUR.PERIOD
	 ERR_FLAG = 5
	 RETURN
      END ELSE
         ERRMSG=CUR.PERIOD<1,2>
        GOTO 93000  
	 RETURN
      END
   END ELSE                                                               
      ERRMSG=DIV.POS<1,2>
      GOTO 93000 
      RETURN
   END    
   HMSG.PR = "Enter BOL period ":VALDAT_PR
6099*
   RETURN
93000
STATUS = RBO.setProperty('','ServerStatus',1)        
STATUS = RBO.setProperty('','ServerMessage',ERRMSG) 
RETURN

