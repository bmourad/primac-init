 SUBROUTINE GET_RELEASE
********************************************************************************
*   Program name :- GET_RELEASE
*   Created:- 12/29/2005
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE OPS.CPYLIB ORDER
$INCLUDE PMC.CPYLIB CUSTOMER
$INCLUDE PMC.CPYLIB SHIP.TO
$INCLUDE PMC.CPYLIB SHIP.VIA
$INCLUDE OPS.CPYLIB ORDER.DETAIL
$INCLUDE OPS.CPYLIB BOL
$INCLUDE OPS.CPYLIB PICK.TICKET
$INCLUDE OPS.CPYLIB ORDER.RELEASE
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE ICS.CPYLIB CATEGORY
$INCLUDE ICS.CPYLIB INV.CNV 
$INCLUDE CPYLIB CHAR

   OPEN "","CONTROL" TO CONTROL ELSE
      ERRMSG = "Cannot locate the CONTROL file"; GOTO 4099
   END
   OPEN "","COMPANY" TO COMPANY ELSE
      ERRMSG = "Cannot locate the COMPANY file"; GOTO 4099
   END
   OPEN "","SHIP.TO" TO SHIP.TO ELSE
      ERRMSG = "Cannot locate the SHIP.TO file"; GOTO 4099
   END
   OPEN "","BOL" TO BOL ELSE
      ERRMSG = "Cannot locate the BOL file"; GOTO 4099
   END
   OPEN "","ORDER.DETAIL" TO ORDER.DETAIL ELSE
      ERRMSG = "Cannot locate the ORDER.DETAIL file"; GOTO 4099
   END
   OPEN "","ORDER" TO ORDER ELSE
      ERRMSG = "Cannot locate the ORDER file"; GOTO 4099
   END
   OPEN "","CUSTOMER" TO CUSTOMER ELSE
      ERRMSG = "Cannot locate the CUSTOMER file"; GOTO 4099
   END
   OPEN "","ORDER.RELEASE" TO ORDER.RELEASE ELSE
      ERRMSG = "Cannot locate the ORDER.RELEASE file"; GOTO 4099
   END
**   
   OPEN "","INVENTORY" TO INVENTORY ELSE
      ERRMSG = "Cannot locate the INVENTORY file"; GOTO 4099
   END

   OPEN "","INV.WHSE" TO INV.WHSE ELSE
      ERRMSG = "Cannot locate the INV.WHSE file"; GOTO 4099
   END

   OPEN "","CATEGORY" TO CATEGORY ELSE
      ERRMSG = "Cannot locate the CATEGORY file"; GOTO 4099
   END

   *OPEN "","INV.CNV" TO INV.CNV ELSE
    *  ERRMSG = "Cannot locate the INV.CNV file"; GOTO 4099
   *END

DEFFUN DIVISION_POSITION(CONO,CONTROL.FILE,DIV.CODE)
DEFFUN CURRENT_PERIOD(CONO,CONTROL.FILE,DIV.POS,FISCAL.FLAG)
DEFFUN CalcStkQty(COST.QTY,MAT INV.CNV.REC,ROND,LN)



* Insert method code here
STATUS=RBO.getProperty('','ID',ID)
STATUS = RBO.getProperty("","PMCProperty",PMCProperty)
STATUS=RBO.getProperty('','BOL_ORDER',BOL.ORDER)
STATUS=RBO.getProperty('','BOL_RELEASE',BOL.RELEASE)
*STATUS=RBO.getProperty('','BOL_SHIP_TO',SHPNO)

CONO = ID[1,3];*PMCProperty<1,4>
NEWREC = 1
RELNO = BOL.RELEASE
ORDNO = BOL.ORDER
DEFAULT.FOB=''
BOL.FOB=''
TEMP.SID=''
*TEMP.AVAIL=''
*PRINT.AVAIL=''
CUSTNO = ""
ERRMSG=''
TEMP=''
TYPE=''
BOLNO=''
PKTKTNO=''
TEMP.TYPE=''
VALUE=''
PRODDESC=''
PDESC=''
PCNT=''
IPTR=''
BOL.PROD=''
BOL.WHSE =''

PDCNT=''
PDNO=''
*SHPNO=''
CUSTNO=''
DIV.CODE=''
DEFLOC=''
FIRST=''
I=''
SID=''
LN=''
UPDCNT=''
WLOC=''
PQTY=''
I2=''

*---- SETUP UNIT MEASURE CONVERSION AND DISPLAY
   ICR.CNV = "MD0"; ICR.CNV1 = "MD0,"
   ICR.DV1 = 1; ICR.MT1 = 1; ICR.DV2 = 1000
   ICR.TYPE = 3; ICR.SCAL = 0
*----



1770 *
    
  IF ORDNO # '' THEN
  	MATREAD ORD.REC FROM ORDER, CONO:ORDNO ELSE
      		ERRMSG = "Cannot locate Order # ":ORDNO
     		GOTO 4099
  	END
  END
    
   IF RELNO # "" THEN
         MATREAD ORR.REC FROM ORDER.RELEASE, CONO:RELNO ELSE
            ERRMSG = "Cannot locate release # ":RELNO
            GOTO 4099
         END
         IF NEWREC AND ORR.STATUS<1,1> # "" THEN
            ERRMSG = "Release ":RELNO:" ":ORR.STATUS<1,1>
            GOTO 4099
         END
         ORDNO = ORR.ORD
         SHPNO = ORR.SHIP.TO
         ERRMSG = ""
	  GOSUB 4100
	  IF ERRMSG # "" THEN GOTO 4099
	  IF ORD.PICK.NO # "" THEN
            ERRMSG = "Picking Ticket # required for this order."
            GOTO 4099
         END
         FOR PDNO = PDCNT TO 1 STEP -1
            PNO = PDPTR<PDNO>
            QCNT = DCOUNT(QTYPTR<PDNO>,VM)
            FOR QNO = QCNT TO 1 STEP -1
               RNO = QTYPTR<PDNO,QNO>
               IF OSD.REL.NO<1,PNO,RNO> # RELNO THEN
                  QTYPTR = DELETE(QTYPTR,PDNO,QNO,0)
               END
            NEXT QNO
            IF QTYPTR<PDNO> = "" THEN
               PDPTR = DELETE(PDPTR,PDNO,0,0)
               QTYPTR = DELETE(QTYPTR,PDNO,0,0)
            END
   		STATUS = RBO.setProperty("","TESTPRODUCT",PDPTR)

         NEXT PDNO
         PDCNT = DCOUNT(PDPTR,AM)
         IF PDCNT < 1 THEN
            ERRMSG = "Cannot locate any available quantity for Release # ":RELNO
            GOSUB 4099      ;*T24815
            ERRMSG = ''      ;*T24815
         END


    		STATUS = RBO.setProperty("","BOL_CUST",CUSTNO)
		STATUS = RBO.setProperty("","BOL_ORDER",ORDNO)
		STATUS = RBO.setProperty("","SPT_NAME",SPT.NAME)
	       STATUS = RBO.setProperty("","SPT_ADDR1",SPT.ADDR1)
      	 	STATUS = RBO.setProperty("","SPT_ADDR2",SPT.ADDR2)
      		STATUS = RBO.setProperty("","SPT_CITY",SPT.CITY)
     		STATUS = RBO.setProperty("","SPT_STATE",SPT.STATE)
	       STATUS = RBO.setProperty("","SPT_ZIP",SPT.ZIP)
	       STATUS = RBO.setProperty("","BOL_SHIP_TO",SHPNO)
 		STATUS = RBO.setProperty("","BOL_PKTKT",ORD.PICK.NO)
		STATUS = RBO.setProperty("","BOL_FOB",DEFAULT.FOB)
  
	
   END
              
    
RETURN

4100*
   MATREADU ORD.REC FROM ORDER, CONO:ORDNO ELSE
      RELEASE ORDER, CONO:ORDNO
      ERRMSG = "Cannot locate Order # ":ORDNO
      GOTO 4199
   END
   DIV.CODE = ORD.DIV; USER.ID = UPCASE(PMCProperty<1,3>); ERRMSG = ''
   CALL CK_DIV_SEC_SUB(CONO,DIV.CODE,USER.ID,ERRMSG)
   IF ERRMSG # '' THEN GOTO 4199
   *GOSUB 6000   
   IF CUSTNO = "" THEN
      CUSTNO = ORD.CUST
   END ELSE
      IF CUSTNO # ORD.CUST THEN
         RELEASE ORDER, CONO:ORDNO
         ERRMSG = "Order (":ORDNO:") belongs to customer # ":ORD.CUST
         GOTO 4199
      END
   END
   MATREAD CUST.REC FROM CUSTOMER, CONO:ORD.CUST ELSE
      RELEASE ORDER, CONO:ORDNO
      ERRMSG = "Cannot locate customer # ":ORD.CUST
      GOTO 4199
   END
   LOCATE SHPNO IN ORD.SHIP.TO<1>,2 SETTING SLOC ELSE
      ERRMSG = "Cannot associate ship to (":SHPNO:") with order # ":ORDNO
      GOTO 4199
   END
   MATREAD SPT.REC FROM SHIP.TO, CONO:CUSTNO:"!":SHPNO ELSE
      ERRMSG = "Cannot locate ship to # ":SHPNO
      GOTO 4199
   END
	BOL.FOB=SPT.FOB
***
   STATUS = RBO.setProperty("","BOL_SHIP_VIA",SPT.SHIP.VIA)
   BEGIN CASE
	  CASE BOL.FOB # ""
		DEFAULT.FOB=""
	  CASE SPT.FOB # ""
         	DEFAULT.FOB = SPT.FOB
      	  CASE 1
              DEFAULT.FOB= CUST.ADDL.OPS<1,2>
   	END CASE

**
   MATREAD ORD.DET.REC FROM ORDER.DETAIL, CONO:ORDNO:"!":SHPNO ELSE
      ERRMSG = "Cannot locate Order / Ship to # ":ORDNO:" / ":SHPNO
      GOTO 4199
   END

   PCNT = DCOUNT(OSD.PROD,VM)
   PDPTR = ""; QTYPTR = ""
   PRODPTR = ""
   FOR PNO = 1 TO PCNT
      RCNT = DCOUNT(OSD.FI.QTY<1,PNO>,SVM)
      FOR RNO = 1 TO RCNT
*
         IF OSD.KIT<1,PNO> # "N" THEN
            IF OSD.KIT<1,PNO> = "K" THEN
               IF OSD.FI.QTY<1,PNO,RNO> > 0 THEN
                  LOCATE PNO IN PDPTR,1 SETTING PLOC ELSE
                     PDPTR<PLOC> = PNO
                  END
                  QTYPTR<PLOC,-1> = RNO
               END ELSE
                  LOCATE PNO IN PDPTR,1 SETTING PLOC ELSE
                     PDPTR<PLOC> = PNO
                  END
                  QTYPTR<PLOC,-1> = RNO + 1
               END
            END ELSE
               IF OSD.FI.QTY<1,PNO,RNO> > 0 THEN
                  LOCATE PNO IN PDPTR,1 SETTING PLOC ELSE
                     PDPTR<PLOC> = PNO
                  END
                  QTYPTR<PLOC,-1> = RNO
               END
            END
         END ELSE
            IF OSD.FI.QTY<1,PNO,RNO> > 0 THEN
               LOCATE PNO IN PDPTR,1 SETTING PLOC ELSE
                  PDPTR<PLOC> = PNO
               END
               QTYPTR<PLOC,-1> = RNO
            END
         END
      NEXT RNO
   NEXT PNO
   *STATUS = RBO.setProperty("","OSD_FI_QTY",OSD.FI.QTY)
   PDCNT = DCOUNT(PDPTR,AM)
   IF PDCNT < 1 THEN
      ERRMSG = "Cannot locate any available quantity for this Order/Ship to ":ORDNO:" / ":SHPNO
      
   END
4199*
  RETURN

6000*
   DIV.POS=DIVISION_POSITION(CONO,CONTROL,DIV.CODE)
   IF DIV.POS<1,1>='' THEN
      DIV.POS=DIV.POS<1,2>
      CUR.PERIOD=CURRENT_PERIOD(CONO,CONTROL,DIV.POS,'OP')
      IF CUR.PERIOD<1,1>='' THEN
         CUR.PERIOD=CUR.PERIOD<1,2>
         ERR.FLG='' ; ERRMSG='' ; NEXT.PERIOD=''
         CALL GET.NEXT.PERIOD(CONO,DIV.CODE,'OP',NEXT.PERIOD,ERR.FLG,ERRMSG)
         VALDAT.PR=''
         VALDAT.PR<1>=CUR.PERIOD:VM:NEXT.PERIOD
         VALDAT.PR=CONVERT(VM,',',VALDAT.PR)
         TODAY=DATE()
         DEFAULT.PR=CUR.PERIOD
      END ELSE
         ERRMSG=CUR.PERIOD<1,2>
      END
   END ELSE
      ERRMSG=DIV.POS<1,2>
   END
6099*
   RETURN


* End of method code
4099 *
*RELEASE
   STATUS = RBO.setProperty("","ServerStatus",1)
   STATUS = RBO.setProperty("","ServerMessage",ERRMSG)
RETURN

