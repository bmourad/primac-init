SUBROUTINE APCPCDM_CASH_DISB_MAINT
********************************************************************************
*   Program name :- APCPCDM_CASH_DISB_MAINT
*   Created:- 1/8/2007
*   BY ABDUL GAFOOR
*------------------------------------------------------------------------------*
$INCLUDE WWINSERT RBO.H
$INCLUDE CPYLIB CHAR
$INCLUDE CPYLIB FILE.VARS
$INCLUDE CPYLIB EDIT.COM.DRIVER
$INCLUDE CPYLIB EDIT.COM
$INCLUDE APS.CPYLIB VEND.POP
$INCLUDE APS.CPYLIB VEND.VOUCH.POP
$INCLUDE APS.CPYLIB OAP
$INCLUDE PMC.CPYLIB VEND
$INCLUDE APS.CPYLIB CKP
$INCLUDE CPYLIB SYSCOM

OPEN '','CONTROL' TO CONTROL ELSE ERRMSG ='CONTROL FILE IS MISSING'; GOTO 91000
READ ERP_TEST FROM CONTROL,"08JAN07" ELSE 
     ERP_TEST=""
END
ERP_TEST = ERP_TEST :AM:"IN NEW METHOD"
WRITE ERP_TEST ON CONTROL,"08JAN07"

*
*--- SETUP SYSTEM ERROR MESSAGES
*
  SYS.TYPE = 1
*  CALL SYSCOM(MAT SYSCOM.REC)
*
*  PROCREAD INBUFF ELSE ERRMSG = ' THIS PROGRAM MUST BE RUN FROM A PROC'; GOSUB 91000; GOTO 99999
   STATUS = RBO.getProperty('','BUFF_VAL',INBUFF)
ERP_TEST = ERP_TEST :AM:"INBUFF ":INBUFF
WRITE ERP_TEST ON CONTROL,"08JAN07"

*----OPEN FILES
*
*  MAT FILE.VARS = ''
*  OPEN '','CONTROL' TO CONTROL ELSE ERRMSG ='CONTROL FILE IS MISSING'; GOTO 93000
  OPEN '','COMPANY' TO COMPANY ELSE ERRMSG ='COMPANY FILE IS MISSING'; GOTO 91000
  OPEN '','VEND.POP' TO VEND.POP ELSE ERRMSG ='VEND.POP FILE IS MISSING'; GOTO 91000
  OPEN '','CKP' TO CKP ELSE ERRMSG ='CKP FILE IS MISSING'; GOTO 93000
  OPEN '','OAP' TO OAP ELSE ERRMSG = 'OAP FILE IS MISSING'; GOTO 93000
*  OPEN '','APS.SCREENS' TO M.SCREENS ELSE ERRMSG = 'M.SCREENS IS MISSING'; GOTO 93000
  OPEN '','VEND' TO VEND ELSE ERRMSG = 'VEND FILE IS MISSING'; GOTO 91000
*
*----INITIALIZATION
*
  LN.NO="";VOUCHER_NO=""
ERP_TEST = ERP_TEST :AM:"IN NEW METHOD AFTER THE READ"
WRITE ERP_TEST ON CONTROL,"08JAN07"
*  CONO = INBUFF<1>
*  COM.NAME = INBUFF<2>
*  DISB.CODE = INBUFF<4>
* TASK 20269
*  DIV.OWNER = INBUFF<6>

  CONO = FIELD(INBUFF,"!",1)
  COM.NAME = FIELD(INBUFF,"!",2)
  DISB.CODE = FIELD(INBUFF,"!",3)
  DIV.OWNER = FIELD(INBUFF,"!",4)
  VOUCHER_NO= FIELD(INBUFF,"!",5)
  VEND_NO  = FIELD(INBUFF,"!",6)
*  MV = FIELD(INBUFF,"!",7) 
  LINE.COUNT = FIELD(INBUFF,"!",7)  

ERP_TEST = ERP_TEST :AM:" DISB.CODE ":DISB.CODE
WRITE ERP_TEST ON CONTROL,"08JAN07"

*      READV DUE.DATE FROM CONTROL, CONO : "PAYDATE",1 ELSE ERRMSG = "PAYMENT DATE IS MISSING"; GOTO 93000
  IF DISB.CODE # "M" THEN
*T22398 READV DUE.DATE FROM CONTROL, CONO : "PAYDATE":DIV.OWNER,1 ELSE ERRMSG = "PAYMENT DATE IS MISSING"; GOTO 93000
    READV DUE.DATE FROM CONTROL, CONO : "PAYDATE":DIV.OWNER,1 ELSE ERRMSG = "PAYMENT DATE IS MISSING"; GOTO 91000 ; *T22398
  END
*
  FILL = '#'
  PAGE.SIZE = 15
  BEGIN.PAGE = 5
*  LN = 1
  LN="" 
  LINE.SPACE = 1
  DESC = ''
*
1000*
*
*  MAT SCV.REC  = ''
  VPOP.VEND = ''
  MAT CKP.REC = ''
  MAT VEND.REC = ''
  LAST.LINE = 0
  LINES = 0
  START.LINE = 0
  OLD.START.LINE = 0
*----MAIN PROCESS
*
ERP_TEST = ERP_TEST :AM:"DISB.CODE MAIN PROCESS = 'M'"
WRITE ERP_TEST ON CONTROL,"08JAN07"

  IF DISB.CODE = 'M' THEN
    READU DUMMY FROM CONTROL, CONO : "PAYDATE":DIV.OWNER ELSE DUMMY = ""
    WRITE "MANUAL" ON CONTROL, CONO : "PAYDATE":DIV.OWNER
ERP_TEST = ERP_TEST :AM:"MANUAL "
WRITE ERP_TEST ON CONTROL,"08JAN07"

*    SCV.REC(ECD.NUM)<1> = "M A N U A L"
    LN = 1
    LOOP
      LN = LINES + 1
      OLD.LINES = LINES
*      LN = 1
      GOSUB 30000
      LINES = LINES + 1
*   WHILE LINES > OLD.LINES DO
ERP_TEST = ERP_TEST :AM:"LINES & LINE.COUNT IN COND ":LINES :"AND":LINE.COUNT
WRITE ERP_TEST ON CONTROL,"08JAN07"

    WHILE LINES < LINE.COUNT
    REPEAT

    OLD.START.LINE = 0
   * GOSUB 20000
  END ELSE
ERP_TEST = ERP_TEST :AM:"IN IF "
WRITE ERP_TEST ON CONTROL,"08JAN07"
*RETURN

*    SCV.REC(ECD.NUM)<1> = "U P D A T E"
    READ VPOP.VEND FROM VEND.POP,CONO:"VENDORS":DIV.OWNER ELSE VPOP.VEND = ''
* TASK 20269
    VCNT = COUNT(VPOP.VEND,AM) + (VPOP.VEND # '')
    VCNT = VCNT - VPOP.START.ATT + 1
    IF VCNT < 1 THEN
      ERRMSG = "THERE ARE NO VENDORS FOR THIS ACCOUNT"
      GOTO 91000 
    END
    DESC = ''
    FOR I = 1 TO VCNT
      L = I + VPOP.START.ATT - 1
      IF VPOP.VEND<L,2> # "" THEN
        MAT VEND.REC = ''
        VEND.DESC = VPOP.VEND<L,2>
      END ELSE
        MATREAD VEND.REC FROM VEND,CONO:VPOP.VEND<L> ELSE
          MAT VEND.REC = ''
        END
      END
      DESC<L> = VEND.DESC
    NEXT I
    LINES = VCNT
    OLD.START.LINE = 0
    *GOSUB 20000
  END

ERP_TEST = ERP_TEST :AM:"LINES ":LINES
WRITE ERP_TEST ON CONTROL,"08JAN07"

  IF LINES < 1 THEN
    ERRMSG = "THERE ARE NO VENDORS FOR THIS ACCOUNT"
    GOTO 91000
  END
ERP_TEST = ERP_TEST :AM:"AFTER THE LINES"
WRITE ERP_TEST ON CONTROL,"08JAN07"
RETURN
*
*----SUBROUTINES
*
10000*
  RETURN
*
20000*
RETURN
*
30000*
35000*
ERP_TEST = ERP_TEST :AM:"VEND_NO IN 30000 ":VEND_NO<1,LN>
WRITE ERP_TEST ON CONTROL,"08JAN07"
  MV = LN + VPOP.START.ATT - 1
  IF VEND_NO<1,LN> = 'END' THEN
    VPOP.VEND = DELETE(VPOP.VEND,MV,0,0)
    VPOP.VEND = DELETE(VPOP.VEND,VPOP.GRS.ATT,MV,0)
    VPOP.VEND = DELETE(VPOP.VEND,VPOP.DSC.ATT,MV,0)
    VPOP.VEND = DELETE(VPOP.VEND,VPOP.NET.ATT,MV,0)
    VPOP.VEND = DELETE(VPOP.VEND,VPOP.SEQ.ATT,MV,0)
    LINES = COUNT(VPOP.VEND,AM) + (VPOP.VEND # '')
    IF LINES > 0 THEN LINES = LINES - VPOP.START.ATT + 1
    RETURN
  END
  FOUND = 0
  LOCATE VEND_NO<1,LN> IN VPOP.VEND,VPOP.START.ATT SETTING FOUND ELSE FOUND = 0
ERP_TEST = ERP_TEST :AM:"VEND_NO FOUND ":VEND_NO :" AND ":FOUND
WRITE ERP_TEST ON CONTROL,"08JAN07"
  IF FOUND THEN
    ERRMSG = 'VENDOR IS ALREADY LISTED'
    GOTO 91000 
  END
  IF VEND_NO<1,LN> MATCHES '1A' THEN
    VEND_NO = "0000":VEND_NO
    VEND.DESC = 'MISCELLANEOUS'
    VPOP.VEND<VPOP.NEXT.SEQ.ATT> = VPOP.VEND<VPOP.NEXT.SEQ.ATT> + 1
    VPOP.VEND<VPOP.SEQ.ATT,MV> = VPOP.VEND<VPOP.NEXT.SEQ.ATT>
    DESC<MV> = VEND.DESC
    VPOP.VEND<MV> = VEND_NO<1,LN>
    VPOP.VEND<MV,2> = ""
  END ELSE
    MATREAD VEND.REC FROM VEND,CONO:VEND_NO<1,LN> ELSE
      ERRMSG = 'INVALID VENDOR'
      GOTO 91000
    END
    DESC<MV> = VEND.DESC
    VPOP.VEND<MV> = VEND_NO<1,LN>
 *   LN = MV
ERP_TEST = ERP_TEST :AM:"READING VEND REC ":VEND_NO<1,LN> 
WRITE ERP_TEST ON CONTROL,"08JAN07"

  END
  V.FLAG = 0

ERP_TEST = ERP_TEST :AM:"STR TO PASS "
WRITE ERP_TEST ON CONTROL,"08JAN07"

*  CALL CASH.DISB.MAINT.SUB(LN,CONO,VPOP.VEND,VEND.POP,CKP,V.FLAG)

  CALL APCPCDM_CASH_DISB_MAINT_SUB(LN,CONO,VPOP.VEND,VEND.POP,CKP,V.FLAG,INBUFF)
   
   STATUS = RBO.getProperty('', 'ERR_MSG',ERRMESG)
   IF ERRMESG # "" THEN
      STATUS = RBO.setProperty('', 'ServerStatus', 1)
      STATUS = RBO.setProperty('', 'ERR_MSG',ERRMESG)
      RETURN
   END 


ERP_TEST = ERP_TEST :AM:"AFTER THE CALL  V.FLAG ":VPOP.VEND<MV,2> :"-&-":V.FLAG
WRITE ERP_TEST ON CONTROL,"08JAN07"

RETURN
  IF VPOP.VEND<MV,2> # "" THEN
    DESC<MV> = VPOP.VEND<MV,2>
  END
  IF V.FLAG = 1 THEN
    GOSUB 50000
    GOTO 30000
  END ELSE
    LINES = COUNT(VPOP.VEND,AM) + (VPOP.VEND # '')
ERP_TEST = ERP_TEST :AM:"LINES & VPOP.START.ATT ":LINES :"-$-": VPOP.START.ATT
WRITE ERP_TEST ON CONTROL,"08JAN07"
    LINES = LINES - VPOP.START.ATT + 1
    OLD.START.LINE = 0
  *  GOSUB 20000
  END
  RETURN
*
50000*
*
  MV = LN + VPOP.START.ATT - 1
ERP_TEST = ERP_TEST :AM:"IN 50000 MV ":MV
WRITE ERP_TEST ON CONTROL,"08JAN07"
  VCNT = COUNT(VPOP.VEND<MV>,VM) + (VPOP.VEND<MV> # "")
ERP_TEST = ERP_TEST :AM:"IN 50000 VCNT ":VCNT
WRITE ERP_TEST ON CONTROL,"08JAN07"

  BEGIN CASE
    CASE VCNT = 1
      READ VPOP.VOUCH FROM VEND.POP, CONO : VPOP.VEND<MV>:"!":DIV.OWNER ELSE VPOP.VOUCH = ""
      VOU.CNT = COUNT(VPOP.VOUCH,AM) + (VPOP.VOUCH # "")
      FOR VOU = 1 TO VOU.CNT
        DELETE CKP, CONO : VPOP.VOUCH<VOU,VPOP.VOUCH.MV>
      NEXT VOU
      DELETE VEND.POP, CONO : VPOP.VEND<MV>:"!":DIV.OWNER
    CASE VCNT > 1
*            READ VPOP.VOUCH FROM VEND.POP, CONO : VPOP.VEND<MV,1> : "!" : VPOP.VEND<VPOP.SEQ.ATT,MV> ELSE VPOP.VOUCH = ""
      VVV.KEY = CONO:VPOP.VEND<MV,1>:"!":VPOP.VEND<VPOP.SEQ.ATT,MV>:"!": DIV.OWNER
      READ VPOP.VOUCH FROM VEND.POP, VVV.KEY ELSE VPOP.VOUCH = ""
      VOU.CNT = COUNT(VPOP.VOUCH,AM) + (VPOP.VOUCH # "")
      FOR VOU = 1 TO VOU.CNT
        DELETE CKP, CONO : VPOP.VOUCH<VOU,VPOP.VOUCH.MV>
      NEXT VOU
*            DELETE VEND.POP, CONO : VPOP.VEND<MV,1> : "!" : VPOP.VEND<VPOP.SEQ.ATT,MV>
      DELETE VEND.POP, VVV.KEY
  END CASE
  VPOP.VEND = DELETE(VPOP.VEND,MV,0,0)
  DESC = DELETE(DESC,MV,0,0)
  VPOP.VEND = DELETE(VPOP.VEND,VPOP.GRS.ATT,MV,0)
  VPOP.VEND = DELETE(VPOP.VEND,VPOP.DSC.ATT,MV,0)
  VPOP.VEND = DELETE(VPOP.VEND,VPOP.NET.ATT,MV,0)
  VPOP.VEND = DELETE(VPOP.VEND,VPOP.SEQ.ATT,MV,0)
*T23678 v
* WRITE VPOP.VEND ON VEND.POP,CONO:"VENDORS":"!":DIV.OWNER

ERP_TEST = ERP_TEST :AM:"IN 50000 WRITING VENDORS "
WRITE ERP_TEST ON CONTROL,"08JAN07"

  WRITE VPOP.VEND ON VEND.POP,CONO:"VENDORS":DIV.OWNER
*T23678 ^
  LINES = COUNT(VPOP.VEND,AM) + (VPOP.VEND # '')
  LINES = LINES - VPOP.START.ATT + 1
  OLD.START.LINE = 0
  *GOSUB 20000
  RETURN
*
*
91000 *
      STATUS = RBO.setProperty('', 'ERR_MSG',ERRMSG)
RETURN
*  ERR.TYPE = 1;CALL SYSCOM(MAT SYSCOM.REC); RETURN
92000 *
*  ERR.TYPE = 2;CALL SYSCOM(MAT SYSCOM.REC); RETURN
93000 *
*  ERR.TYPE = 3;CALL SYSCOM(MAT SYSCOM.REC)
99990 *
*  INBUFF<3> = 'END'
*  PROCWRITE INBUFF
99999*
END


