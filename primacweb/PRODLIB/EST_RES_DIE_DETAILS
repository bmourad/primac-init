SUBROUTINE EST_RES_DIE_DETAILS
********************************************************************************
*   Program name :- EST_RES_DIE_DETAILS
*   Created:- 9/9/2005
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H

* Insert method code here
$INCLUDE JES.CPYLIB EQUIPMENT
$INCLUDE JES.CPYLIB ESTIMATE.RES
$INCLUDE JES.CPYLIB ESTIMATE.RES.DIE
$INCLUDE JES.CPYLIB ESTIMATE.RES.CYLINDER
$INCLUDE JES.CPYLIB ESTIMATE.RES.GEARSET
*$INCLUDE JES.CPYLIB ESTIMATE.RL.DIE
$INCLUDE CPYLIB CHAR

OPEN "", "CONTROL" TO CONTROL ELSE
	ERRMSG="CAN NOT OPEN CONTROL"
END

OPEN "", "EQUIPMENT" TO EQUIPMENT ELSE
	ERRMSG="CAN NOT OPEN EQUIPMENT"
END
OPEN "", "ESTIMATE.RES.DIE" TO ESTIMATE.RES.DIE ELSE
	ERRMSG="CAN NOT OPEN ESTIMATE.RES.DIE"
END
OPEN "", "ESTIMATE.RES.CYLINDER" TO ESTIMATE.RES.CYLINDER ELSE
	ERRMSG="CAN NOT OPEN ESTIMATE.RES.CYLINDER"
END
OPEN "", "ESTIMATE.RES.GEARSET" TO ESTIMATE.RES.GEARSET ELSE
	ERRMSG="CAN NOT OPEN ESTIMATE.RES.GEARSET"
END
OPEN "", "ESTIMATE.RL.DIE" TO ESTIMATE.RL.DIE ELSE
	ERRMSG="CAN NOT OPEN ESTIMATE.RL.DIE"
END
OPEN "", "ESTIMATE.RES" TO ESTIMATE.RES ELSE
	ERRMSG="CAN NOT OPEN ESTIMATE.RES"
END

* 
*---- INITIALIZATION
*
   TEMP.NO.ACROSS=1
   TEMP.NO.AROUND=1
   TEMP.CYLINDER=''
   TEMP.REPEAT=0
   TEMP.DIE.EM=''
   TEMP.PRINTUP=0
   REF.NO = 1

TEMP.PRINTUP_str = ""
TEMP.PRINTGEAR_str =	 ""
TEMP.DIE = ''
TEMP.NO.ACROSS_STR = ""

EST.RL.DIM.AC<1,COMP,1>=""
EST.RL.DIM.AR<1,COMP,1>=""
EST.RL.GAP<1,COMP>=""

**
COMP = "1"

*EST_ID = '0013657-01' ; * INPUT FIELD
*CCTR_NO = '424'	; * INPUT FIELD
CONO = EST_ID[1,3]
*SIZE.ACROSS_STR = '90000' ; * INPUT FIELD
*EST.RL.DIM.AC<1,COMP,1> = '120000'



TEMP.NO.AROUND_STR 	= ""
TEMP.REPEAT_STR	= ""
TEMP.CYLINDER_STR	= ""
NO.TEETH="01"

SAVE.DIETYPE = "R"
TEMP.DIE = ''
*TEMP.DIETYPE = 'R'

STATUS = RBO.getProperty('','ID',EST_ID)
STATUS = RBO.getProperty('','CCTR_str',CCTR_NO)
STATUS = RBO.getProperty('','DieType_str',TEMP.DIETYPE)
STATUS = RBO.getProperty('','SizeAcrocc_str',XYZ)
STATUS = RBO.getProperty('','ESTAR',XYZ1)
STATUS = RBO.getProperty('','ESTMGAP',XYZ2)

EST.RL.DIM.AC<1,COMP,1>=XYZ
EST.RL.DIM.AR<1,COMP,1>=XYZ1
EST.RL.GAP<1,COMP>=XYZ2

MATREAD EQUIPMENT.REC FROM EQUIPMENT,CONO:CCTR_NO ELSE
     MAT EQUIPMENT.REC = ""
END
MATREAD EST.RL.REC FROM ESTIMATE.RES,EST_ID ELSE
     MAT EST.RL.REC = ""
END

 READV PGEAR.REP FROM ESTIMATE.RES.GEARSET,CONO:EQP.RL.PRESS.GSPRINT,4 ELSE
       PGEAR.REP=''
 END
 READV PGEAR.CYL FROM ESTIMATE.RES.GEARSET,CONO:EQP.RL.PRESS.GSPRINT,5 ELSE
       PGEAR.CYL=''
 END
 READV PPITCH FROM ESTIMATE.RES.GEARSET,CONO:EQP.RL.PRESS.GSPRINT,2 ELSE
       PPITCH=1
 END


**
* NEW METHODS
**
*
*--- Calculate New Die Across, Around and Repeat Fields.
*
2150*
   BEGIN CASE
      CASE TEMP.DIETYPE='F'
         DGEARSET=EQP.RL.PRESS.GSFBED
      CASE TEMP.DIETYPE='R'
         DGEARSET=EQP.RL.PRESS.GSROTARY
   END CASE
   MATREAD ESTGS.REC FROM ESTIMATE.RES.GEARSET,CONO:DGEARSET ELSE
      MAT ESTGS.REC=''
   END
   DGEAR.REP=ESTGS.REPEATS ;* T26892
   DGEAR.CYL=ESTGS.CYLIDS ;* T26892
   DPITCH=ESTGS.PITCH
   READV PGEAR.REP FROM ESTIMATE.RES.GEARSET,CONO:EQP.RL.PRESS.GSPRINT,4 ELSE
      PGEAR.REP=''
   END
   READV PGEAR.CYL FROM ESTIMATE.RES.GEARSET,CONO:EQP.RL.PRESS.GSPRINT,5 ELSE
      PGEAR.CYL=''
   END
   BEGIN CASE
      CASE EST.RL.BUTT<1,COMP,REF.NO>='Y'
         EST.RL.GAP<1,COMP>=0
      CASE EST.RL.GAP<1,COMP,1>=''
         EST.RL.GAP<1,COMP>=EQP.RL.DRAW.GAP.MIN
      CASE 1
   END CASE

   LABEL.SIZE = EST.RL.DIM.AR<1,COMP,1> + EST.RL.GAP<1,COMP> ;* Add Minimum Gap
   
   IF DPITCH+0 # 0 THEN
      NO.TEETH = INT(LABEL.SIZE/DPITCH+.5)
   END ELSE
      NO.TEETH = 0
   END

   DG.CNT=DCOUNT(DGEAR.REP,VM)
   PG.CNT=DCOUNT(PGEAR.REP,VM)
  
   TEMP.DG.XREF=''
   IF TEMP.REPEAT='' THEN
      TEMP.REPEAT=LABEL.SIZE
   END
 
   FOR LABEL.AR = 1 TO DG.CNT
      IF MOD(DGEAR.CYL<1,LABEL.AR>[3,3],NO.TEETH-.5)=0 THEN
         IF TEMP.DIE = "" THEN
            TEMP.CYLINDER=DGEAR.CYL<1,LABEL.AR>
            TEMP.REPEAT=DGEAR.REP<1,LABEL.AR>
            TEMP.NO.AROUND=INT(TEMP.REPEAT/LABEL.SIZE)
         END
         INS TEMP.CYLINDER BEFORE TEMP.DG.XREF<1,1>
         INS TEMP.REPEAT BEFORE TEMP.DG.XREF<2,1>
         INS TEMP.NO.AROUND BEFORE TEMP.DG.XREF<3,1>
      END
      IF MOD(DGEAR.CYL<1,LABEL.AR>[3,3],NO.TEETH)=0 THEN
	  IF TEMP.DIE = "" THEN
	   
            TEMP.CYLINDER=DGEAR.CYL<1,LABEL.AR>;*T24213
            TEMP.REPEAT=DGEAR.REP<1,LABEL.AR>;*T24213
            TEMP.NO.AROUND=INT(TEMP.REPEAT/LABEL.SIZE);*T24213
         END
         INS TEMP.CYLINDER BEFORE TEMP.DG.XREF<1,1>
         INS TEMP.REPEAT BEFORE TEMP.DG.XREF<2,1>
         INS TEMP.NO.AROUND BEFORE TEMP.DG.XREF<3,1>
      END
   NEXT LABEL.AR

  STATUS = RBO.setProperty('','ServerStatus',LABEL.SIZE:"-AND-":EST.RL.DIM.AR<1,COMP,1>:"-AND-":EST.RL.GAP<1,COMP>:"-AND-":NO.TEETH:"-ANDfrom if-":TEMP.CYLINDER:"-AND-":TEMP.REPEAT:"-AND-":TEMP.NO.AROUND )
 * RETURN 
	IF EST.RL.DIE.REPEAT<1,COMP,REF.NO>='0.0000' OR SAVE.DIETYPE#TEMP.DIETYPE OR SIZES.CHANGED THEN
		GOSUB 2000
		SIZES.CHANGED=0	
		TEMP.NO.AROUND_STR	= TEMP.NO.AROUND
		TEMP.REPEAT_STR	= TEMP.REPEAT
		TEMP.CYLINDER_STR	= TEMP.CYLINDER
	END
*
*--- Calculate No Across Maximum Web
*

   MAX.WIDTH=EQP.RES.PRESS.WIDTH.MAX
   MAX.WIDTH=MAX.WIDTH - EQP.RL.TRIM.MIN ;* Less Minimum Trim
   IF RLDIE.NO.ACROSS='0' THEN
      TEMP.NO.ACROSS=INT(MAX.WIDTH/EST.RL.DIM.AC<1,COMP,1>)
   END
   IF TEMP.NO.ACROSS+0=0 THEN TEMP.NO.ACROSS=1
2155*
   IF EST.RL.DIE<1,COMP,REF.NO> # 'B' THEN
      GAP=(TEMP.NO.ACROSS-1)*EQP.RL.DRAW.GAP.MIN
   END ELSE
      GAP=0
   END
   CHECK.WIDTH=TEMP.NO.ACROSS*EST.RL.DIM.AC<1,COMP,1>+GAP
   IF CHECK.WIDTH > MAX.WIDTH THEN
      WASTE=GAP+EQP.RL.TRIM.MIN
      TEMP.NO.ACROSS=TEMP.NO.ACROSS-1
	*TEMP.NO.ACROSS=TEMP.NO.ACROSS

      IF TEMP.NO.ACROSS <=0 THEN
         ERRMSG1 = 'Press Width Est: ':OCONV(CHECK.WIDTH,'MD4'):' Max: ':OCONV(MAX.WIDTH,'MD4'):'(less trim)  Waste: ':OCONV(WASTE,'MD4'):' Ok Y/N'
      *  CALL EDIT.SUB1 (MAT EDIT.COM)
      *   IF VALUE # 'Y' THEN
            GO 2150
      *   END
      END
   END
  TEMP.NO.ACROSS_STR = TEMP.NO.ACROSS
STATUS = RBO.setProperty('','DIEDETAILS_STR', TEMP.NO.ACROSS_STR : "^" : TEMP.NO.AROUND_STR : "^" : OCONV(TEMP.REPEAT_STR,'MD4') : "^" : TEMP.CYLINDER_STR )
   RETURN
*
*--- Calculate Print Gears
*
2000*

*	TEMP.PG.XREF=''
*	PG.XR.CNT=1
*	TEMP.PRINTGEAR=''
*	PRINT.REPEAT=0
*	TEMP.PG.XREF=''
*	TEMP.PRINTUP=0

   BEGIN CASE
      CASE PRINT.REPEAT+0=0 AND TEMP.DG.XREF#''
         DG.CNT=DCOUNT(TEMP.DG.XREF<1>,VM)
         PG.CNT=DCOUNT(PGEAR.REP,VM)
         FOR DG=1 TO DG.CNT
            TEMP.PG.XREF<1,PG.XR.CNT>=TEMP.DG.XREF<1,DG>
            TEMP.PG.XREF<2,PG.XR.CNT>=TEMP.DG.XREF<2,DG>
            TEMP.PG.XREF<3,PG.XR.CNT>=TEMP.DG.XREF<3,DG>
            FOR PRINT.CNT = 1 TO PG.CNT
               IF TEMP.DG.XREF<2,DG>+0 # 0 THEN
                  IF MOD(PGEAR.REP<1,PRINT.CNT>,TEMP.DG.XREF<2,DG>)=0 THEN
                     TEMP.PRINTGEAR=PGEAR.CYL<1,PRINT.CNT>
                     TEMP.PRINTUP=TEMP.DG.XREF<3,DG>*INT(PGEAR.REP<1,PRINT.CNT>/TEMP.DG.XREF<2,DG>)
                     PRINT.REPEAT=PGEAR.REP<1,PRINT.CNT>
                     TEMP.PG.XREF<4,PG.XR.CNT>=TEMP.PRINTGEAR
                     TEMP.PG.XREF<5,PG.XR.CNT>=PRINT.REPEAT
                     TEMP.PG.XREF<6,PG.XR.CNT>=TEMP.PRINTUP
                     TEMP.PG.XREF<1,PG.XR.CNT>=TEMP.DG.XREF<1,DG>
                     TEMP.PG.XREF<2,PG.XR.CNT>=TEMP.DG.XREF<2,DG>
                     TEMP.PG.XREF<3,PG.XR.CNT>=TEMP.DG.XREF<3,DG>
                     PG.XR.CNT=PG.XR.CNT+1
                  END
               END
            NEXT PRINT.CNT
         NEXT DG
         PG.DONE=0
         FOR II=1 TO PG.XR.CNT UNTIL PG.DONE
            IF TEMP.PG.XREF<5,II>#'' THEN
               TEMP.PRINTGEAR=TEMP.PG.XREF<4,II>
               PRINT.REPEAT=TEMP.PG.XREF<6,II>
               TEMP.PRINTUP=TEMP.PG.XREF<6,II>
               PG.DONE=1
            END
         NEXT II
      CASE 1
   END CASE
	TEMP.PRINTUP_STR 	= TEMP.PRINTUP
	TEMP.PRINTGEAR_STR 	= TEMP.PRINTGEAR
   RETURN

*	STATUS = RBO.setProperty('','AllEstDivCodes', " Checking 444-- " :TEMP.NO.ACROSS )
*	RETURN



1000 *

IF ERRMSG # "" THEN 
   STATUS = RBO.setProperty('','ServerStatus',1)
   STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
END

* End of method code
RETURN

