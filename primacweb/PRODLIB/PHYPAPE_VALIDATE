SUBROUTINE PHYPAPE_VALIDATE
********************************************************************************
*   Program name :- PHYPAPE_VALIDATE
*   Created:- 4/11/2005  RAZI MOHIUDDIN
*------------------------------------------------------------------------------*
* In Properties:   VALIDATING THE GRID PRODUCT AND GETTING THE REQUIRED QTYS
* --------------
* Out Properties:
* ---------------
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE ICS.CPYLIB INV.WHSE.LOC
$INCLUDE ICS.CPYLIB CATEGORY
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE ICS.CPYLIB WAREHOUSE
$INCLUDE ICS.CPYLIB INV_SERIAL
$INCLUDE CPYLIB CHAR
$INCLUDE ICS.CPYLIB INV.CNV

DEFFUN CALC_STK_QTY(COST.QTY, MAT INV.CNV.REC,ROND,LN)

ERRMSG=''
ERR=''
OPEN '','INVENTORY' TO INVENTORY ELSE ERRMSG='INVENTORY FILE IS MISSING';GOTO 91000
OPEN '','INV.WHSE' TO INV.WHSE ELSE ERRMSG='INV.WHSE FILE IS MISSING';GOTO 91000
OPEN '','INV.WHSE.LOC' TO INV.WHSE.LOC ELSE ERRMSG='INV.WHSE.LOC FILE IS MISSING';GOTO 91000
OPEN '','CATEGORY' TO CATEGORY ELSE ERRMSG='CATEGORY FILE IS MISSING';GOTO 91000
OPEN '','WAREHOUSE' TO WAREHOUSE ELSE ERRMSG='WAREHOUSE FILE IS MISSING';GOTO 91000
OPEN '','COMPANY' TO COMPANY ELSE ERRMSG='COMPANY FILE IS MISSING';GOTO 91000
OPEN '','CONTROL' TO CONTROL ELSE ERRMSG='CONTROL FILE IS MISSING';GOTO 91000
OPEN '','INV_SERIAL' TO INV_SERIAL ELSE ERRMSG='INV_SERIAL FILE IS MISSING';GOTO 91000

J = 1
PROD_CUR_QTY=''
PROD_NEW_QTY=''
PROD_DIFF_QTY=''

STATUS=RBO.getProperty('','PMCProperty',PMCProperty)
CONO = PMCProperty<1,4>
STATUS=RBO.getProperty('','PROD_INV_LINE',PROD.LINE)
STATUS=RBO.getProperty('','PROD_WHSE',WHSE.CODE)
STATUS=RBO.getProperty('','PROD_LOC',LOC.CODE)
STATUS=RBO.getProperty('','PROD_NO',VALUE)

PROD.NUM=VALUE
MATREAD INV.REC FROM INVENTORY, CONO:VALUE THEN
          MATREAD CATG.REC FROM CATEGORY,CONO:INV.LINE THEN
            IF PROD.LINE = INV.LINE THEN
              IF INV.PAP.TYPE="REGULAR" OR INV.PAP.TYPE="REG" OR INV.PAP.TYPE="" THEN
                ERRMSG="THIS PRODUCT IS NOT A PAPER PRODUCT";GOTO 91000
              END ELSE
                LOCATE WHSE.CODE IN INV.WHSE.CODE<1>,1 SETTING WFND THEN
                  WHSE.KEY=CONO:PROD.NUM:'!':WHSE.CODE
                  MATREAD IWH.REC FROM INV.WHSE, WHSE.KEY THEN
                    LOCATE LOC.CODE IN IWH.LOC<1>,1 SETTING LFND THEN
                      EOI=1
                    END ELSE
                      LFND=DCOUNT(IWH.LOC,VM)+1
                      IWH.LOC<1,LFND>=LOC.CODE
                      ERRMSG='THIS PRODUCT IS NOT SETUP FOR LOCATION - ':LOC.CODE
                      GOTO 91000
                    END
*                    IF NOT(SKIP) THEN
                      MATREAD IWLO.REC FROM INV.WHSE.LOC, WHSE.KEY:"!":IWH.LOC<1,LFND> ELSE
                        MAT IWLO.REC=""
                        IWLO.LOC.ON.HAND=0
                      END
                      IF IWLO.SERIAL='' THEN
                        ERR='THERE ARE NO SERIALS FOR THIS LOCATION'
                        GOTO 91000; SKIP=1
                      END
                      IF INV.UNIT<1,3>='MSI' THEN FUDGE=50 ELSE FUDGE=9
*                      END
                  END ELSE
                    ERRMSG='INV.WHSE RECORD NOT ON FILE'
                    GOTO 91000 ; SKIP=1
                  END
                END ELSE
                  ERRMSG='PRODUCT IS NOT SETUP FOR WAREHOUSE # ':WHSE.CODE
                  GOTO 91000 ; SKIP=1
                END
              END
            END ELSE
              ERRMSG='THIS PRODUCT DOES NOT BELONG TO PRODUCT LINE'
              GOTO 91000; SKIP=1
            END
          END ELSE
            ERRMSG="CATEGORY (":INV.LINE:") IS NOT ON FILE"
            GOTO 91000; SKIP=1
          END
        END ELSE
          ERRMSG='INVENTORY (':VALUE:') IS NOT ON FILE.'
          GOTO 91000; SKIP=1
        END

  $INCLUDE ICSBP INV.UM.CNV

  ON.HAND=IWLO.LOC.ON.HAND
  PHS.M.WGHT=INV.M.WT
  PHS.CUR.QTY=ON.HAND
  PHS.NEW.QTY=PHS.CUR.QTY   
  DIFF.QTY=PHS.NEW.QTY - PHS.CUR.QTY
  
 
  PHS.CUR.QTY = CALC_STK_QTY(PHS.CUR.QTY,MAT INV.CNV.REC,'.5','')
  PHS.CUR.QTY = OCONV(PHS.CUR.QTY,ICR.CNV)
  PROD_CUR_QTY<1,J> = PHS.CUR.QTY
  
  PHS.NEW.QTY = CALC_STK_QTY(PHS.NEW.QTY,MAT INV.CNV.REC,'.5','')
  PHS.NEW.QTY = OCONV(PHS.NEW.QTY,ICR.CNV)
  PROD_NEW_QTY<1,J> = PHS.NEW.QTY

  DIFF.QTY = CALC_STK_QTY(DIFF.QTY,MAT INV.CNV.REC,'.5','')
  DIFF.QTY = OCONV(DIFF.QTY,ICR.CNV)
  PROD_DIFF_QTY<1,J> = DIFF.QTY

STATUS = RBO.setProperty("","INV_STR",INV.FULL.DESC:"~":PROD_CUR_QTY:"~":PROD_NEW_QTY:"~":PROD_DIFF_QTY) 

RETURN


91000*
	STATUS = RBO.setProperty("","ServerStatus","1")
	STATUS = RBO.setProperty("","ServerMessage",ERRMSG)
	STATUS = RBO.setProperty("","Message",ERR)
RETURN
