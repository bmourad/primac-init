SUBROUTINE ValidateSystemPwd
********************************************************************************
*   Program name :- ValidateSystemPwd
*   Created:- 11/7/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE PMC.CPYLIB SECURITY
$INCLUDE PMC.CPYLIB PMC_PROCESS
$INCLUDE PMC.CPYLIB PMC_PROCESS_XREF
$INCLUDE CPYLIB EDIT.COM.DRIVER
$INCLUDE CPYLIB FILE.VARS
$INCLUDE CPYLIB CHAR
$INCLUDE CPYLIB SYSCOM

* Insert method code here
*PrimacSecurity_TEMP_INPUT PrimacSecurity_TEMP_OUTPUT
ERRMSG = ''
PrimacSecurity_TEMP_INPUT = ''
PrimacSecurity_TEMP_OUTPUT = ''
CONO = ''
USER.ID = ''
PMCProperty = ''


STATUS=RBO.getProperty('','PrimacSecurity_TEMP_INPUT',PrimacSecurity_TEMP_INPUT)
STATUS=RBO.getProperty('','PMCProperty',PMCProperty)
CONO = PMCProperty<1,4>
USER.ID = PMCProperty<1,3>


DEFFUN ENCODE.SUB (ACTION, KEYWORD, INDATA, OUTDATA)

  OPEN "","COMPANY" TO COMPANY ELSE
    ERRMSG = "CANNOT OPEN COMPANY FILE"
    GOTO 93000
  END
  OPEN "","PMC.SCREENS" TO M.SCREENS ELSE
    ERRMSG = "CANNOT OPEN PMC.SCREENS FILE"
    GOTO 93000
  END
* T23304 v Open USER.MODE file
  OPEN "","USER.MODE" TO USER.MODE ELSE
    ERRMSG = "CANNOT OPEN USER.MODE FILE"
    GOTO 93000
  END
* T23304 ^
  OPEN "","SECURITY" TO SECURITY ELSE
    ERRMSG = "CANNOT OPEN SECURITY FILE"
    GOTO 93000
  END
  OPEN "","CONTROL" TO CONTROL ELSE
    ERRMSG = "CANNOT OPEN CONTROL FILE"
    GOTO 93000
  END
*  OPEN "","EASY.MENUS" TO EASY.MENUS ELSE
*    ERRMSG = "CANNOT OPEN EASY.MENUS FILE"
*    GOTO 93000
*  END
  PROCESS.ONFILE = 1
  OPEN "","PMC_PROCESS" TO PMC_PROCESS ELSE
    PROCESS.ONFILE = 0
    ERRMSG = "CANNOT OPEN PMC_PROCESS FILE"
    GOTO 93000
  END
  OPEN "","PMC_PROCESS_XREF" TO PMC_PROCESS_XREF ELSE
    PROCESS.ONFILE = 0
    ERRMSG = "CANNOT OPEN PMC_PROCESS_XREF FILE"
    GOTO 93000
  END
* T26784 v
*  OPEN "","ACCESS_BY_USER" TO ACCESS_BY_USER ELSE
*    ERRMSG = "CANNOT OPEN ACCESS_BY_USER FILE"
*    GOTO 93000
*  END
* T26784 ^

KW.PW = "VERCOM"
NEW.PW = ""
SEC.KEY = CONO:USER.ID

  READ CURR.PW FROM CONTROL, "SECURITY.PW" ELSE
    NEW.PW = "PW"
    CALL ENCODE.SUB("E",KW.PW,NEW.PW,CURR.PW)
  END
  CALL ENCODE.SUB("D",KW.PW,CURR.PW,SECURITY.PW)
  READV CONO FROM CONTROL, "MASTER",1 THEN
    MULTI.CO = 0
  END ELSE
    MULTI.CO = 1
  END

  CURR.PW = FIELD(PrimacSecurity_TEMP_INPUT,"/",1)
  NEW.PW = FIELD(PrimacSecurity_TEMP_INPUT,"/",2)

  BEGIN CASE
    CASE CURR.PW # SECURITY.PW
      ERRMSG = "** Illegal Password **"
      GOSUB 93000
      GOTO 99999
    CASE CURR.PW = "PW" AND (NEW.PW = "" OR NEW.PW = CURR.PW)
      ERRMSG = "** Please change the current password **"
      GOSUB 93000
      GOTO 99999
  END CASE

MATREADU SEC.REC FROM SECURITY, SEC.KEY LOCKED
	ERRMSG = 'SECURITY record is locked by user - ':GETUSERNAME(STATUS())
	GOSUB 93000
	GOTO 99999
END THEN
    S.PW = SEC.PASSWORD
    TEMP = SEC.PASSWORD; SEC.PASSWORD = ""
    CALL ENCODE.SUB("D",USER.ID,TEMP,SEC.PASSWORD)
    S.M.L = SEC.MENU.LEVEL
    IF SEC.MENU.LEVEL > 3 THEN SEC.MENU.LEVEL = 3
    GOSUB 9000
END

STATUS = RBO.setProperty('','ServerStatus',"")
STATUS = RBO.setProperty('','ServerMessage',"")

* End of method code
RETURN

93000:
	STATUS = RBO.setProperty('','ServerStatus',1)
	STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN

99999:
  RELEASE     ;* T26126
RETURN

9000:
RETURN
