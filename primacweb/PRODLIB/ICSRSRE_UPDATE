SUBROUTINE ICSRSRE_UPDATE

*********************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE CPYLIB CHAR
$INCLUDE PMC.CPYLIB COMPANY
$INCLUDE PMC.CPYLIB SECURITY
$INCLUDE ICS.CPYLIB DAILY_STOCK

ERRMSG = ''

OPEN '','CONTROL' TO CONTROL ELSE
      ERRMSG = 'Cannot open CONTROL file!'
      GOTO 93000
END
OPEN '','DAILY_STOCK' TO DAILY_STOCK ELSE
      ERRMSG = 'Cannot open DAILY_STOCK file!'
      GOTO 93000
END

OPEN '','SECURITY' TO SECURITY ELSE
      ERRMSG = 'Cannot open SECURITY file!'
      GOTO 93000
END
OPEN '','COMPANY' TO COMPANY ELSE
      ERRMSG = 'Cannot open COMPANY file!'
      GOTO 93000
END
OPEN '','WIN.PRINTERS' TO WIN.PRINTERS ELSE
      ERRMSG = 'Cannot open WIN.PRINTERS file!'
      GOTO 93000
END

STATUS=RBO.getProperty('','PMCProperty',PMCProperty)
STATUS=RBO.getProperty('','Complete',DSR.COMPLETE)
STATUS=RBO.getProperty('','PONUM',PO_NO)
STATUS=RBO.getProperty('','Manifest',Manifest)
STATUS = RBO.getProperty('','SECURITY_TEMP_INPUT',SECURITY_TEMP_INPUT)
   MENU = SECURITY_TEMP_INPUT<1,1>
   OPTION = SECURITY_TEMP_INPUT<1,2>

CONO= PMCProperty<1,4>
DSR.ID=CONO:PO_NO:"!":Manifest
ERRMSG = ''
*
*PO_NO=ID
*TO RETURN IF NO DATA
*
IF PO_NO="" THEN
	RETURN
END
USER.ID = PMCProperty<1,3> ;* User ID

      BUFF=CONO
      PROCWRITE BUFF
      CMD='SELECT DAILY_STOCK WITH @ID = "':CONO:PO_NO:"!":Manifest:'"'
      UDTEXECUTE CMD CAPTURING JUNK
      CALL ICSRSRE_UPDATEDATA(CONO,DSR.ID,DSR.COMPLETE)
*CALL RS.POST.DRIVER

       UDTEXECUTE CMD CAPTURING JUNK
      UserID = PMCProperty<1,3> ;* User ID
      MATREAD SEC.REC FROM SECURITY, CONO:UPCASE(UserID) ELSE
         ERRMSG = "USER ":UserID:" NOT ON FILE":PMCProperty
         GOTO 93000
      END
      MATREAD COMP.REC FROM COMPANY, CONO ELSE
         ERRMSG = "USER ":UserID:" NOT ON FILE"
         GOTO 93000
      END
       CALL SYSVARS.SUB(PORT_NO)
       OS.TYPE = UPCASE(SYSTEM(33))

       SETPTR_CMD = ""
*CODE FOR FORM QUEUES
SETPTR_QUEUE = SEC.DFLT.QUEUE
  READ FORM.QUEUE FROM SECURITY, CONO:UPCASE(UserID) THEN
	   FOR A = 1 TO DCOUNT(FORM.QUEUE<33>,VM)
	      IF FORM.QUEUE<33,A> = MENU AND FORM.QUEUE<34,A> = OPTION THEN
		 SETPTR_QUEUE = FORM.QUEUE<35,A>
	      END
	   NEXT A
  END
*END
      *WRITE SETPTR_QUEUE ON CONTROL,"IIII"
     
      BEGIN CASE
        CASE OS.TYPE[1,7] = "WINDOWS"	
  	    READ WIN.PRINTERS.REC FROM WIN.PRINTERS,SETPTR_QUEUE THEN
             SETPTR_FORMATSTR = "Orientation=":WIN.PRINTERS.REC<5>:","
         	SETPTR_FORMATSTR := "Font=":WIN.PRINTERS.REC<6>:","
         	SETPTR_FORMATSTR := "FontSize=":WIN.PRINTERS.REC<7>:","
        	SETPTR_FORMATSTR := "TopMargin=":WIN.PRINTERS.REC<8>:","
         	SETPTR_FORMATSTR := "BottomMargin=":WIN.PRINTERS.REC<9>
*
         	SETPTR_CMD = 'SETPTR 0,132,,,,1,AT '
         	SETPTR_CMD := WIN.PRINTERS.REC<3>
         	SETPTR_CMD := ',"':SETPTR_FORMATSTR:'",NHEAD,BRIEF'
      	   END
       CASE OS.TYPE[1,7] = "UNIX"
      	      SETPTR_CMD = 'SETPTR ,,,,,,NHEAD,BRIEF,DEST '
      	      SETPTR_CMD := SETPTR_QUEUE:',NOMESSAGE'
     END CASE
       UDTEXECUTE SETPTR_CMD CAPTURING JUNK1
SETPTR_CMD=""
    
      READNEXT DID THEN
        BUFF<2>='IC204'
        BUFF<9>='REJECT'
        UDTEXECUTE CMD CAPTURING JUNK
      CALL ICSRSRE_UPDATEDATA1(CONO)
      END
RETURN

93000*
STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN
