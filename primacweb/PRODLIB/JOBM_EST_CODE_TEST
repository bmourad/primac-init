SUBROUTINE JOBM_EST_CODE_TEST
********************************************************************************
*   Program name :- JOBM_EST_CODE_TEST
*   Created:- 7/15/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  EST.CODE, JOB.DIV, JOB.MASTER
*
* Out Properties:
* ---------------
*  ServerStatus,ServerMessage
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JES.CPYLIB ESTIMATE
$INCLUDE JCS.CPYLIB JOB
* Insert method code here

MAT EST.REC = ''
MAT JOB.REC = ''
ERRMSG = ''

OPEN '','ESTIMATE' TO ESTIMATE ELSE
	ERRMSG = "UNABLE TO OPEN FILE!"
	GOTO 99999
END

OPEN "","JOB" TO JOB ELSE
	ERRMSG = "CANNOT OPEN JOB FILE"
       GOTO 99999
END

VAL = RBO.getProperty('','JOB_EST',EST.CODE)
VAL = RBO.getProperty('','JOB_NO',JOBNO)
VAL = RBO.getProperty('','Cono',CONO)
VAL = RBO.getProperty('','JOB_MASTER',JOB.MASTER)
VAL = RBO.getProperty('','JOB_DIV',JOB.DIV)

IF JOB.DIV = 0 THEN JOB.DIV = ""
IF JOB.MASTER = 0 THEN JOB.MASTER = ""
IF EST.CODE = 0 THEN 
	EST.CODE = ""
	MAT EST.REC = ''
END ELSE
	MATREAD EST.REC FROM ESTIMATE, CONO:EST.CODE ELSE 
		ERRMSG = "Invalid Estimate ID. Try again!"
		GOTO 99999
	END
END


*MATREAD JOB.REC FROM JOB,CONO:JOBNO ELSE MAT JOB.REC = ""

IF ((JOB.DIV # "") AND (EST.DIV # "")) THEN
	CHK.EST.DIV = FIELD(EST.DIV,"-",1)
       IF JOB.DIV # CHK.EST.DIV THEN
      		ERRMSG="Est Div of ":CHK.EST.DIV:" does not match Job Div."
             	GOTO 99999
	END
END

IF EST.JOB # "" THEN
	IF JOB.MASTER # "" AND EST.JOB # JOB.MASTER THEN
      		ERRMSG = "Estimate belongs to another Master Job"
		GOTO 99999
       END
END

IF EST.STATUS<1,1> = "LOST" THEN
	ERRMSG = "Estimate was defined as lost on ":OCONV(EST.STAT.DATE<1,1>,"D2/"):". Try again! "
       GOTO 99999
END

99999
  IF (TRIM(ERRMSG) # "") THEN
       STATUS = RBO.setProperty('','ServerStatus','1')
       STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
  END ELSE
       STATUS = RBO.setProperty('','ServerStatus','')
       STATUS = RBO.setProperty('','ServerMessage','')
  END 
RETURN
