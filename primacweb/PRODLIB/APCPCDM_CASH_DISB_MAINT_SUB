SUBROUTINE APCPCDM_CASH_DISB_MAINT_SUB(LN,CONO,VPOP.VEND,VEND.POP,CKP,V.FLAG,INBUFF)
********************************************************************************
*   Program name :- APCPCDM_CASH_DISB_MAINT_SUB
*   Created:- 1/9/2007
*   BY ABDUL GAFOOR
*------------------------------------------------------------------------------*
*
*  SUBROUTINE CASH.DISB.MAINT.SUB (LN,CONO,VPOP.VEND,VEND.POP,CKP,V.FLAG)
$INCLUDE WWINSERT RBO.H
$INCLUDE CPYLIB EDIT.COM.DRIVER
$INCLUDE CPYLIB EDIT.COM
$INCLUDE APS.CPYLIB VEND.POP
$INCLUDE APS.CPYLIB VEND.VOUCH.POP
$INCLUDE APS.CPYLIB OAP
$INCLUDE APS.CPYLIB CKP
$INCLUDE PMC.CPYLIB VEND
$INCLUDE CPYLIB CHAR
$INCLUDE CPYLIB FILE.VARS
$INCLUDE CPYLIB SYSCOM


*
*--- SETUP SYSTEM ERROR MESSAGES
*
OPEN "","CONTROL" TO CONTROL ELSE ERRMSG="ERROR IN CONTROL OPEN "; GOTO 91000
OPEN "","OAP" TO OAP ELSE GOTO 91000

VOUCHER_REC=""
  SYS.TYPE = 1
*  CALL SYSCOM(MAT SYSCOM.REC)
*
*
*---- INITIALIZATION
*
  PAGE.SIZE = 12
  BEGIN.PAGE = 6
  LINE.SPACE = 1
  OLD.LINE = 0
  LNV = 0
  LINES = 0
  OLD.START.LINE = 0
  MAT CKP.REC = ''
  SLN=""
*  PROCREAD XXX ELSE XXX = ""
*  DIV.OWNER = XXX<6>
*  STATUS = RBO.getProperty('','BUFF_VAL',INBUFF)
VOUCHER_REC<1>="INBUFF IS :":INBUFF
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"

   LN.NO=""
   DIV.OWNER=""
  CONO = FIELD(INBUFF,"!",1)
  COM.NAME = FIELD(INBUFF,"!",2)
  DISB.CODE = FIELD(INBUFF,"!",3)
  DIV.OWNER = FIELD(INBUFF,"!",4)
  VOUCHER_NO= FIELD(INBUFF,"!",5)
  VEND_NO  = FIELD(INBUFF,"!",6)
*  VN = FIELD(INBUFF,"!",7)
  GRS_AMT = FIELD(INBUFF,"!",8)
  DSC_AMT = FIELD(INBUFF,"!",9)
  
  TEMP_VOUCHER = FIELD(VOUCHER_NO,VM,LN) 
  VOUCHER_NO = CHANGE(TEMP_VOUCHER,SVM,VM)

VOUCHER_REC<1>="VOUCHER_NO AFTER CONVERSION ":VOUCHER_NO
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"


*
*----MAIN BODY
*
  VN = LN + VPOP.START.ATT - 1
*  VN = LN  
  VCNT = COUNT(VPOP.VEND<VN>,VM) + (VPOP.VEND<VN> # '')
  IF VCNT = 1 THEN
    KEY = VPOP.VEND<VN>:"!":DIV.OWNER
  END ELSE
*        KEY = VPOP.VEND<VN,1>:"!":VPOP.VEND<VPOP.SEQ.ATT,VN>
    KEY = VPOP.VEND<VN,1>:"!":VPOP.VEND<VPOP.SEQ.ATT,VN>:"!":DIV.OWNER
  END
VOUCHER_REC=VOUCHER_REC :AM:"KEY ":KEY
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"
  READ VPOP.VOUCH FROM VEND.POP,CONO:KEY ELSE VPOP.VOUCH =''
*
VOUCHER_REC = VOUCHER_REC :AM:"VPOP.VOUCH IS ":VPOP.VOUCH
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"
  IF VPOP.VOUCH = "" THEN
    REQUEST = 'A'
    LOOP
      LNV = LINES + 1
      OLD.LINES = LINES
      IF LNV LE DCOUNT(VOUCHER_NO,VM) THEN 
          GOSUB 30000
      END ELSE
          RETURN
      END
    WHILE LINES > OLD.LINES DO
    REPEAT
    LNV = LINES
  *  GOSUB 20000
  END ELSE
    LINES = COUNT(VPOP.VOUCH,AM) + (VPOP.VOUCH # '')
    LNV = 1
    GOSUB 20000
    GOSUB 60500
  END
RETURN
*
10000*
  RETURN
*
20000*
  RETURN
*
30000*
35000*
  IF VOUCHER_NO<1,LNV> = 'END' THEN
    VPOP.VOUCH = DELETE(VPOP.VOUCH,LNV,0,0)
    GOTO 37999
  END
  TCNT = COUNT(VPOP.VOUCH,AM) + (VPOP.VOUCH # '')
  BLK = 0
VOUCHER_REC = VOUCHER_REC :AM:"TCNT IN 30000 ":TCNT
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"
 
  FOR I = 1 TO TCNT UNTIL BLK
    IF VOUCHER_NO<1,LNV> = VPOP.VOUCH<I,VPOP.VOUCH.MV> AND I # LNV THEN
      ERRMSG = 'VOUCHER ALREADY LISTED'
      GOTO 91000
      BLK = 1
    END
  NEXT I
  IF BLK THEN GOTO 35000
  MATREAD OAP.REC FROM OAP,CONO:VOUCHER_NO<1,LNV> ELSE
    ERRMSG = 'INVALID VOUCHER'
    GOTO 91000
  END
VOUCHER_REC = VOUCHER_REC :AM:"READ THE OAP REC "
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"

*T27613
IF DIV.OWNER # "ALL" THEN
  IF OAP.DIV.OWNER # DIV.OWNER THEN
    ERRMSG = "THIS VOUCHER HAS OWNING DIVISION OF ":OAP.DIV.OWNER
    GOTO 91000
  END
END
*T27613
VOUCHER_REC = VOUCHER_REC :AM:" VOUCHER CONDITION ":OAP.VEND<1,1> :" # ": VPOP.VEND<VN,1>
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"
  IF OAP.VEND<1,1> # VPOP.VEND<VN,1> THEN
    ERRMSG = "VOUCHER HAS A DIFFERENT VENDOR"      ;*T22829
    GOTO 91000
  END
VOUCHER_REC = VOUCHER_REC :AM:"OAP.VEND<1,2> ":OAP.VEND<1,2>
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"

  IF OAP.VEND<1,2> # '' THEN
    IF VPOP.VEND<VN,2> # '' AND OAP.VEND<1,2> # VPOP.VEND<VN,2> THEN
      ERRMSG = 'VOUCHER HAS A DIFFERENT VENDOR'      ;*T22829
      GOTO 91000
    END ELSE
      LOCATE OAP.VEND IN VPOP.VEND,VPOP.START.ATT SETTING MARKER ELSE
        MARKER = 0
      END
      IF MARKER # 0 AND MARKER # VN THEN
        ERRMSG = "VOUCHER HAS A DIFFERENT VENDOR LINE"      ;*T22829
        GOTO 91000
      END ELSE
        VPOP.VEND<VN> = OAP.VEND
*        SCV.REC(12)<2> = OAP.VEND<1,2>
*        ECD.ACTION = 3; CALL SCRN.EDIT
      END
    END
  END
VOUCHER_REC = VOUCHER_REC :AM:"AFTER IF CONDITION "
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"
  VPOP.VOUCH<LNV,VPOP.VOUCH.MV> = VOUCHER_NO<1,LNV>
  VPOP.VOUCH<LNV,VPOP.INV.MV> = OAP.INV
  VPOP.VOUCH<LNV,VPOP.PO.MV> = OAP.PO
  VPOP.VOUCH<LNV,VPOP.DUE.MV> = OCONV(OAP.DUE.DATE,"D2/")
*
36000*
*  TYP = 4; X = 42; Y = SLN; MAXL = 10
*  SCALER = 2; O.R = 'O'
VOUCHER_REC = VOUCHER_REC :AM:"VPOP.VOUCH<LNV,VPOP.GRS.MV> ":VPOP.VOUCH<LNV,VPOP.GRS.MV>
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"

  IF VPOP.VOUCH<LNV,VPOP.GRS.MV> # '' THEN
    DEFAULT = OCONV(VPOP.VOUCH<LNV,VPOP.GRS.MV>,"MD2")
  END ELSE
    DEFAULT = OCONV(OAP.GRS.AMT - OAP.PAID.AMT - OAP.DSC.PAID, "MD2")
    IF DEFAULT < 0 AND OAP.GRS.AMT > 0 THEN DEFAULT = 0
    IF DEFAULT > 0 AND OAP.GRS.AMT < 0 THEN DEFAULT = 0
  END
  IF DEFAULT = 0 THEN
    ERRMSG = 'This voucher has been paid in full'
    GOTO 91000

VOUCHER_REC = VOUCHER_REC :AM:"ERRMSG ":ERRMSG
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"

    DEFAULT = ""
    GOTO 30000
  END
VOUCHER_REC = VOUCHER_REC :AM:"AT LAST IN 30000 "
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"

*  CALL EDIT.SUB
  IF GRS_AMT<1,LNV> = 'END' THEN
    IF REQUEST = 'A' THEN
*T21560 v
      GOSUB 70000
*           GOTO 35000
      GOTO 30000
*T21560 ^
    END ELSE
    *  P_X  = 42 ; P_Y = SLN ; P_VALUE = OCONV(VPOP.VOUCH<LNV,VPOP.GRS.MV>,"MD2")"R#10" ; P_OPT = ""
    *  CALL VSI_PLINE(P_X,P_Y,P_VALUE,P_OPT)
    *  GOTO 37999
    END
  END
  IF GRS_AMT<1,LNV> = 0 THEN
    ERRMSG = 'Gross Amt must not be zero '
    GOTO 91000
  END
  IF GRS_AMT<1,LNV> > OAP.GRS.AMT - OAP.PAID.AMT - OAP.DSC.PAID THEN
    ERRMSG = 'Gross Amt must be less than ':OCONV(OAP.GRS.AMT,"MD2")
    GOTO 91000
  END
VOUCHER_REC = VOUCHER_REC :AM:"VPOP.VOUCH<LNV,VPOP.GRS.MV> = ":GRS_AMT<1,LNV>
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"
  VPOP.VOUCH<LNV,VPOP.GRS.MV> = GRS_AMT<1,LNV>
*
37000*
*  TYP = 4; X = 53; Y = SLN; MAXL = 10
8  SCALER = 2; O.R = 'O'
  IF VPOP.VOUCH<LNV,VPOP.GRS.MV> = 0 THEN
  END ELSE
    IF VPOP.VOUCH<LNV,VPOP.DSC.MV> # '' THEN
      DEFAULT = OCONV(VPOP.VOUCH<LNV,VPOP.DSC.MV>,"MD2")
    END ELSE
      DEFAULT = OCONV(OAP.DSC.AMT - OAP.DSC.PAID,"MD2")
      IF DEFAULT < 0 AND OAP.GRS.AMT > 0 THEN DEFAULT = 0
      IF DEFAULT > 0 AND OAP.GRS.AMT < 0 THEN DEFAULT = 0
    END
*    CALL EDIT.SUB
    IF DSC_AMT<1,LNV> = 'END' THEN
      IF REQUEST = 'A' THEN
*T21560 v
        GOSUB 70000
        DEL VPOP.VOUCH<LNV,VPOP.GRS.MV>
*              GOTO 35000
VOUCHER_REC = VOUCHER_REC :AM:" AGAIN CALLING THE 30000"
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"

        GOTO 30000
*T21560 ^
      END ELSE
      END
    END
  END
  VPOP.VOUCH<LNV,VPOP.DSC.MV> = DSC_AMT<1,LNV>
  VPOP.VOUCH<LNV,VPOP.NET.MV> = VPOP.VOUCH<LNV,VPOP.GRS.MV> - VPOP.VOUCH<LNV,VPOP.DSC.MV>

VOUCHER_REC = VOUCHER_REC :AM:"VPOP.VOUCH<LNV,VPOP.DSC.MV> = ":DSC_AMT<1,LNV>
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"

  GOSUB 60000
  MAT CKP.REC = ""
  CKP.VEND = OAP.VEND
  CKP.INV = OAP.INV
  CKP.INV.DATE = OAP.INV.DATE
  CKP.DUE.DATE = OAP.DUE.DATE
  CKP.GRS.AMT = VPOP.VOUCH<LNV,VPOP.GRS.MV>
  CKP.MER.AMT = OAP.MER.AMT
  CKP.DSC.AMT = VPOP.VOUCH<LNV,VPOP.DSC.MV>
  CKP.CTR = OAP.CTR
  CKP.ACCT = OAP.ACCT
  CKP.DIST.AMT = OAP.DIST.AMT
  CKP.JOB = OAP.JOB
  CKP.PO = OAP.PO
  CKP.ASSET.ID = OAP.ASSET.ID
  CKP.JCS.TRANS = OAP.JCS.TRANS
  CKP.TERMS = OAP.TERMS
  CKP.DIV = OAP.DIV
  CKP.DEPT = OAP.DEPT
  CKP.CCTR = OAP.CCTR
  CKP.MON = OAP.MON
  CKP.COMMENT = OAP.COMMENT
  CKP.REM.COMM = OAP.REM.COMM ; *T25759
  CKP.MISC.CAT = OAP.MISC.CAT
  CKP.AP.ACCT = OAP.AP.ACCT
  CKP.AP.AMT = OAP.AP.AMT
*T19149 v      
  CKP.AP.DIV = OAP.AP.DIV
  CKP.AP.DEPT = OAP.AP.DEPT
  CKP.AP.CCTR = OAP.AP.CCTR
*T19149 ^      
  MATWRITE CKP.REC ON CKP,CONO : VPOP.VOUCH<LNV,VPOP.VOUCH.MV>
  WRITE VPOP.VOUCH ON VEND.POP, CONO : KEY

VOUCHER_REC = VOUCHER_REC :AM:"VPOP.VOUCH = ":VPOP.VOUCH
WRITE VOUCHER_REC ON CONTROL,"0109VCHR"
  WRITE VPOP.VEND ON VEND.POP,CONO:"VENDORS":DIV.OWNER
* TASK 20269
37999 LINES = COUNT(VPOP.VOUCH,AM) + (VPOP.VOUCH # '')
  RETURN
*
50000*
  DELETE CKP,CONO:VPOP.VOUCH<LNV,VPOP.VOUCH.MV>
  VPOP.VOUCH = DELETE(VPOP.VOUCH,LNV,0,0)
  GOSUB 60000
* TASK 20269
*      WRITE VPOP.VEND ON VEND.POP,CONO:"VENDORS"
  WRITE VPOP.VEND ON VEND.POP,CONO:"VENDORS":DIV.OWNER
* TASK 20269
  WRITE VPOP.VOUCH ON VEND.POP,CONO:KEY
  LINES = COUNT(VPOP.VOUCH,AM) + (VPOP.VOUCH # '')
  OLD.START.LINE = 0
  GOSUB 20000
  RETURN
*
60000*
  VPOP.VEND<VPOP.GRS.ATT,VN>=0;VPOP.VEND<VPOP.DSC.ATT,VN>=0;VPOP.VEND<VPOP.NET.ATT,VN>=0
  TMV = COUNT(VPOP.VOUCH,AM) + (VPOP.VOUCH # '')
  FOR I = 1 TO TMV
    VPOP.VEND<VPOP.GRS.ATT,VN> = VPOP.VEND<VPOP.GRS.ATT,VN> + VPOP.VOUCH<I,VPOP.GRS.MV>
    VPOP.VEND<VPOP.DSC.ATT,VN> = VPOP.VEND<VPOP.DSC.ATT,VN> + VPOP.VOUCH<I,VPOP.DSC.MV>
    VPOP.VEND<VPOP.NET.ATT,VN> = VPOP.VEND<VPOP.NET.ATT,VN> + VPOP.VOUCH<I,VPOP.NET.MV>
  NEXT I
60500 *
  RETURN
*
70000*  T21560 v
  DEL VPOP.VOUCH<LNV,VPOP.VOUCH.MV>
  DEL VPOP.VOUCH<LNV,VPOP.INV.MV>
  DEL VPOP.VOUCH<LNV,VPOP.PO.MV>
  DEL VPOP.VOUCH<LNV,VPOP.DUE.MV>
  RETURN
*
*--- CALLS FOR SYSCOM
91000*
      STATUS = RBO.setProperty('','ERR_MSG',ERRMSG)
RETURN
   	
*  ERR.TYPE = 1;CALL SYSCOM(MAT SYSCOM.REC); RETURN
92000 *
*  ERR.TYPE = 2;CALL SYSCOM(MAT SYSCOM.REC); RETURN
93000 *
*  ERR.TYPE = 3;CALL SYSCOM(MAT SYSCOM.REC)
99999*
*  ECD.ACTION=99;CALL SCRN.EDIT
*  RETURN
END
