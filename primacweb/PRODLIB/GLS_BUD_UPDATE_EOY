SUBROUTINE GLS_BUD_UPDATE_EOY
********************************************************************************
*   Program name :- GLS_BUD_UPDATE_EOY
*   Created:- 9/15/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE PMC.CPYLIB COMPANY   
$INCLUDE PMC.CPYLIB FISCAL
$INCLUDE PMC.CPYLIB GLTABLE
$INCLUDE PMC.CPYLIB COA
$INCLUDE GLS.CPYLIB GLM
$INCLUDE GLS.CPYLIB COA.BAL
$INCLUDE CPYLIB CHAR
* Insert method code here
DIM MCB.REC(300)
ERRMSG = ''
OPEN '','COMPANY' TO COMPANY ELSE ERRMSG = 'COMPANY FILE MISSING' ; GOTO 99999
OPEN '','GLS.SCREENS' TO M.SCREENS ELSE ERRMSG = 'GLS.SCREENS FILE MISSING' ; GOTO 99999
OPEN '','PREFIX' TO PREFIX ELSE ERRMSG = 'PREFIX FILE MISSING' ; GOTO 99999
OPEN '','CONTROL' TO CONTROL ELSE  ERRMSG = 'CONTROL FILE IS MISSING';GOTO 99999
OPEN '','COA' TO COA ELSE  ERRMSG = 'COA FILE IS MISSING';GOTO 99999
OPEN '','GLM' TO GLM ELSE  ERRMSG = 'GLM FILE IS MISSING';GOTO 99999
OPEN '','GLA' TO GLA ELSE  ERRMSG = 'GLA FILE IS MISSING';GOTO 99999
OPEN '','GLX' TO GLX ELSE  ERRMSG = 'GLX FILE IS MISSING';GOTO 99999

VAL = RBO.getProperty('','ID',ID)
VAL = RBO.getProperty('','R_E_LEVEL',R.E.LEVEL)
VAL = RBO.getProperty('','R_E_LEN',R.E.LEN)
VAL = RBO.getProperty('','R_E_SUF',R.E.SUF)

CONO = ID[1,3]
MATREAD COMP.REC FROM COMPANY,CONO ELSE
	ERRMSG = "CANNOT LOCATE COMPANY " : CONO
	GOTO 99999
END

ACCT.LEN = LEN(CO.ACCT.PIC)
IN.ACCT.LEN = LEN(CO.ACCT.PIC)

READ PERIOD.REC FROM CONTROL, CONO : "ACCT.PERIODS" ELSE
  PERIOD.REC = ""
  PERIOD.REC<1> = 12
END
NUM.PERIODS = PERIOD.REC<1>

FOR PER = 1 TO NUM.PERIODS
	OPENDATES<PER> = OCONV(OPENDATES<PER>,"D/")
	NEXT.YEAR = OPENDATES<PER>[7,4] + 1
	OPENDATES<PER> = OPENDATES<PER>[1,6] : NEXT.YEAR
	OPENDATES<PER> = ICONV(OPENDATES<PER>,"D/")
NEXT PER

IF CO.GLS.HIST<1,1> = "Y" THEN
	OPEN '','GLH' TO GLH ELSE
       	ERRMSG = 'GLH FILE IS MISSING'
              GOTO 99999
      	END
      	OPEN '','GLHX' TO GLHX ELSE
         	ERRMSG = 'GLHX FILE IS MISSING'
         	GOTO 99999
      	END
      	OPEN '','CO.COA.BAL' TO CO.COA.BAL ELSE
       	ERRMSG = 'CO.COA.BAL FILE IS MISSING'
         	GOTO 99999
      	END
      	OPEN '','DV.COA.BAL' TO DV.COA.BAL ELSE
       	ERRMSG = 'DV.COA.BAL FILE IS MISSING'
         	GOTO 99999
      	END
      	OPEN '','DP.COA.BAL' TO DP.COA.BAL ELSE
       	ERRMSG = 'DP.COA.BAL FILE IS MISSING'
         	GOTO 99999
      	END
      	OPEN '','CC.COA.BAL' TO CC.COA.BAL ELSE
       	ERRMSG = 'CC.COA.BAL FILE IS MISSING'
            	GOTO 99999
      	END
END

READ OPENDATES FROM CONTROL , CONO : "OPENDATES" ELSE
	ERRMSG = "CANNOT LOCATE CONTROL, OPENDATES"
  	GOTO 99999
END
SELECT CO.COA.BAL
	DATA = 1
LOOP
	READNEXT CO.ID ELSE DATA = 0
WHILE DATA DO
	IF CONO <> CO.ID[1,3] THEN GOTO 199
      	MATREAD CB.REC FROM CO.COA.BAL, CO.ID ELSE
       	RELEASE CO.COA.BAL, CO.ID
          	GOTO 199
      	END
       	DELETE CO.COA.BAL, CO.ID
199
REPEAT

SELECT DV.COA.BAL
	DATA = 1
LOOP
	READNEXT DV.ID ELSE DATA = 0
WHILE DATA DO
	IF CONO <> DV.ID[1,3] THEN GOTO 299
       MATREAD CB.REC FROM DV.COA.BAL, DV.ID ELSE
       	RELEASE DV.COA.BAL, DV.ID
          	GOTO 299
       END
        DELETE DV.COA.BAL, DV.ID
299   
REPEAT
SELECT DP.COA.BAL
	DATA = 1
LOOP
	READNEXT DP.ID ELSE DATA = 0
WHILE DATA DO
	IF CONO <> DP.ID[1,3] THEN GOTO 399
      	MATREAD CB.REC FROM DP.COA.BAL, DP.ID ELSE
      		RELEASE DP.COA.BAL, DP.ID
          	GOTO 399
      	END
      	DELETE DP.COA.BAL, DP.ID
399   
REPEAT

SELECT CC.COA.BAL
	DATA = 1
LOOP
	READNEXT CC.ID ELSE DATA = 0
WHILE DATA DO
	IF CC.ID[1,3] <> CONO THEN GOTO 599
      	DP.ID = CC.ID[1,7] : CC.ID[11,IN.ACCT.LEN]
      	DV.ID = CC.ID[1,5] : CC.ID[11,IN.ACCT.LEN]
      	CO.ID = CC.ID[1,3] : CC.ID[11,IN.ACCT.LEN]
      	MATREAD COA.REC FROM COA, CO.ID ELSE GOTO 599
      	MATREAD CB.REC FROM CC.COA.BAL, CC.ID ELSE
       	RELEASE CC.COA.BAL, CC.ID
          	GOTO 599
      	END
      	CB.REC(1) = ""
       CB.REC(2) = ""
       DEL.FLAG = 1
       FOR PER = 3 TO 55
       	IF CB.REC(PER) + 0 <> 0 THEN DEL.FLAG = 0
          	CB.REC(PER + 53) = CB.REC(PER)
          	CB.REC(PER) = ''
      	NEXT PER
      	IF DEL.FLAG THEN
       	DELETE CC.COA.BAL, CC.ID
          	GOTO 599
      	END
      	IF COA.TYPE = "E" OR COA.TYPE = "I" THEN
       	R.E.ID = CC.ID[1,R.E.LEN] : R.E.SUF
          	LOCATE R.E.ID IN R.E.PREFIX,1 SETTING FND ELSE
            		R.E.PREFIX<FND> = R.E.ID
            		R.E.AMT<FND> = 0
      		END
      		R.E.AMT<FND> = R.E.AMT<FND> + CB.REC(108)
      	END ELSE
       	CB.REC(3) = CB.REC(108)
      	END
       FOR PER = 109 TO CB.REC.SIZE
       	CB.REC(PER) = ''
      	NEXT PER
      	MATREAD MCB.REC FROM DP.COA.BAL, DP.ID ELSE MAT MCB.REC = ""
      	MCB.REC(3) = MCB.REC(3) + CB.REC(3)
      	FOR PER = 56 TO 108
      		MCB.REC(PER) = MCB.REC(PER) + CB.REC(PER)
      	NEXT PER
      	MATWRITE MCB.REC ON DP.COA.BAL, DP.ID
      	MATREAD MCB.REC FROM DV.COA.BAL, DV.ID ELSE MAT MCB.REC = ""
      	MCB.REC(3) = MCB.REC(3) + CB.REC(3)
      	FOR PER = 56 TO 108
      		MCB.REC(PER) = MCB.REC(PER) + CB.REC(PER)
      	NEXT PER
      	MATWRITE MCB.REC ON DV.COA.BAL, DV.ID
      	MATREAD MCB.REC FROM CO.COA.BAL, CO.ID ELSE MAT MCB.REC = ""
      	MCB.REC(3) = MCB.REC(3) + CB.REC(3)
      	FOR PER = 56 TO 108
       	MCB.REC(PER) = MCB.REC(PER) + CB.REC(PER)
      	NEXT PER
      	MATWRITE MCB.REC ON CO.COA.BAL, CO.ID
      	MATWRITE CB.REC ON CC.COA.BAL, CC.ID
599   
REPEAT

RCNT = COUNT(R.E.PREFIX,AM) + (R.E.PREFIX # "")
CO.R.E.AMT = 0
FOR R = 1 TO RCNT
	PREFIX = R.E.PREFIX<R>
      	R.E.ID = PREFIX : GLTB.RET.EARN
      	MATREAD CB.REC FROM CC.COA.BAL, R.E.ID ELSE
       	MAT CB.REC = ""
      	END
      	CB.REC(3) = CB.REC(3) + R.E.AMT<R>
      	MATWRITE CB.REC ON CC.COA.BAL, R.E.ID
       R.E.ID = PREFIX[1,7] : GLTB.RET.EARN
       MATREAD CB.REC FROM DP.COA.BAL, R.E.ID ELSE
       	MAT CB.REC = ""
      	END
       CB.REC(3) = CB.REC(3) + R.E.AMT<R>
       MATWRITE CB.REC ON DP.COA.BAL, R.E.ID
       R.E.ID = PREFIX[1,5] : GLTB.RET.EARN
       MATREAD CB.REC FROM DV.COA.BAL, R.E.ID ELSE
       	MAT CB.REC = ""
       END
       CB.REC(3) = CB.REC(3) + R.E.AMT<R>
       MATWRITE CB.REC ON DV.COA.BAL, R.E.ID
       CO.R.E.AMT = CO.R.E.AMT + R.E.AMT<R>
NEXT R
R.E.ID = CONO : GLTB.RET.EARN
MATREAD CB.REC FROM CO.COA.BAL, R.E.ID ELSE
	MAT CB.REC = ""
END
CB.REC(3) = CB.REC(3) + CO.R.E.AMT
MATWRITE CB.REC ON CO.COA.BAL, R.E.ID
IF CO.GLS.HIST<1,1> # "Y" THEN GOTO 900
DEL.MON = (FR.CURR.PER[1,4] - 3) : "01"
SELECT GLH
	DATA = 1
LOOP
	READNEXT GLH.ID ELSE DATA = 0
WHILE DATA DO
	IF CONO <> GLH.ID[1,3] THEN GOTO 799
       MATREAD GLM.REC FROM GLH, GLH.ID ELSE
       	RELEASE GLH, GLH.ID
          	GOTO 799
      	END
       IF GLM.MON < DEL.MON THEN
       	DELETE GLH, GLH.ID
       END ELSE
       	RELEASE GLH, GLH.ID
       END
799   
REPEAT

SELECT GLHX
	DATA = 1
LOOP
	READNEXT GLHX.ID ELSE DATA = 0
WHILE DATA DO
	IF CONO <> GLHX.ID[1,3] THEN GOTO 899
       READ GLX.REC FROM GLHX, GLHX.ID ELSE
       	RELEASE GLHX, GLHX.ID
          	GOTO 899
      	END
       GLHX.MON = GLHX.ID[LEN(GLHX.ID)-5,6]
       IF GLHX.MON < DEL.MON THEN
       	DELETE GLHX, GLHX.ID
      	END ELSE
       	RELEASE GLHX, GLHX.ID
      	END
899   
REPEAT
*
900 *

WRITE OPENDATES ON CONTROL, CONO : "OPENDATES"
TAPE.PERIOD = ""
WRITE TAPE.PERIOD ON CONTROL, CONO : FR.CURR.PER[1,4] : "GLS.TAPE"
FR.CLOSE.DATE = DATE()
MATWRITE FISCAL.REC ON CONTROL, CONO : "FISCAL"
WRITEV 'OK' ON CONTROL, CONO:'GLS.BUD.CHK',1 ; * T26008
DELETE CONTROL, CONO : "FISCALMON"

99999
IF ERRMSG # '' THEN
	VAL = RBO.setProperty('','ServerStatus','E')
	VAL = RBO.setProperty('','ServerMessage',ERRMSG)
END ELSE
	VAL = RBO.setProperty('','ServerStatus','')
END
* End of method code
RETURN

