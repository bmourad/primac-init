SUBROUTINE PHYIM_VALID_CHANGE_SERIAL
********************************************************************************
*   Program name :- PHYIM_VALID_CHANGE_SERIAL
*   Created:- 12/1/2003
*T27705 zahoor Ahmed 03/03/05* Expand Serial to 15 pos.
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE ICS.CPYLIB INV_SERIAL
$INCLUDE ICS.CPYLIB PHY.INV
$INCLUDE ICS.CPYLIB INV.CNV
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB WAREHOUSE
$INCLUDE ICS.CPYLIB TRANSFER
* Insert method code here
ERRMSG = ""
OPEN '','CONTROL' TO CONTROL ELSE
	ERRMSG = 'CONTROL FILE IS MISSING'
	GOTO 99999
END
OPEN '','INV_SERIAL' TO INV_SERIAL ELSE
	ERRMSG = 'INV_SERIAL FILE IS MISSING'
	GOTO 99999
END

* Insert method code here
OPEN '','INV_SERIAL_TEMP' TO INV_SERIAL_TEMP ELSE 
	ERRMSG = "INV_SERIAL_TEMP FILE IS MISSING"
	GOTO 99999
END	
OPEN '','PHY.INV' TO PHY.INV ELSE 
	ERRMSG = "PHY.INV FILE IS MISSING"
	GOTO 99999
END	
OPEN "","INVENTORY" TO INVENTORY ELSE
	ERRMSG = "INVENTORY FILE IS MISSING"
      	GOTO 99999
END
OPEN "","PHY.XREF" TO PHY.XREF ELSE
	ERRMSG = "PHY.XREF FILE IS MISSING"
      	GOTO 99999
END
OPEN "","WAREHOUSE" TO WAREHOUSE ELSE
	ERRMSG = "WAREHOUSE FILE IS MISSING"
      	GOTO 99999
END


DEFFUN CALC.STK.QTY(COST.QTY,MAT INV.CNV.REC,ROND,LN)

ERRMSG = RBO.getProperty('','ID',ID)
ERRMSG = RBO.getProperty('','PHYSI_TEMP_INPUT',SERIAL)

DIM SAVE.PHYSI.REC(PHYSI.REC.SIZE)

MODE = SERIAL<1,4>
TEMP.PROD = SERIAL<1,2>
PROD.NUM = SERIAL<1,2>
LN = SERIAL<1,3>
TEMP.SERIAL = SERIAL<1,1>
CONO = ID[1,3]
SERIAL.NO = 0
GEN.DIV='00'
INPUT.VAL = ""
MATREAD PHYSI.REC FROM PHY.INV,ID ELSE
	ERRMSG = "RECORD DOESN'T EXIST"
	GOTO 99999
END
MATREAD INV.REC FROM INVENTORY,CONO:TEMP.PROD ELSE
	ERRMSG = "RECORD DOESN'T EXIST"
	GOTO 99999
END

$INCLUDE ICSBP INV.UM.CNV

ALERTMSG = ""
OUT.PARAM = ""

ERRCNT = 1
CHECK.SERIAL: ;* CHECK SERIAL NUMBER
 	*T27705I STK.ID = CONO:TEMP.SERIAL"R%8"
	ISTK.ID = CONO:TEMP.SERIAL 
	*T27705MATREADU ISTK.REC FROM INV_SERIAL, CONO:TEMP.SERIAL"R%8" THEN
  	MATREADU ISTK.REC FROM INV_SERIAL, CONO:TEMP.SERIAL THEN  
    		IF ISTK.PROD = PROD.NUM THEN
         		PHY.TRK.ID=ISTK.ID
         		IF PHYSI.WHSE # ISTK.WHSE OR PHYSI.LOC # ISTK.LOC THEN
            			IF PHYSI.TRAN.TO = '' THEN
               			ERRMSG = 'THIS SERIAL HAS BEEN TRANSFERRED OUT TO WHSE ':ISTK.WHSE:' AND LOC ':ISTK.LOC
               			GOSUB 99999
            			END
            			ALERTMSG<1,ERRCNT> = "THIS SERIAL ID IS CURRENTLY IN WAREHOUSE ":ISTK.WHSE
            			ALERTMSG<1,ERRCNT> := " AND LOCATION ":ISTK.LOC
				ERRCNT += 1
           			ERRMSG = ""
            			MATREAD WHSE.REC FROM WAREHOUSE,CONO:PHYSI.WHSE THEN
               			IF WHS.DIV='' THEN
                  				FROM.DIV=GEN.DIV
               			END ELSE
                  				FROM.DIV=WHS.DIV
              			END
            			END
            			MATREAD WHSE.REC FROM WAREHOUSE,CONO:ISTK.WHSE THEN
               			IF WHS.DIV='' THEN
                  				TO.DIV = GEN.DIV
               			END ELSE
                  				TO.DIV=WHS.DIV
               			END
            			END
				INPUT.VAL = "I" : @VM : FROM.DIV : @VM : TO.DIV
				GOTO 99999
         		END ELSE
            			PHYSI.PREV.QTY = ISTK.CUR.QTY
            			PHYSI.PREV.DIA = ISTK.CUR.DIAM
            			PHYSI.PREV.SQTY = ISTK.CUR.STK.QTY
            			ROND=0.5
            			IF PHYSI.PREV.QTY+0<0 THEN ROND = -(0.5)
            			TEMP.PREV.QTY<1,1> = CALC.STK.QTY(PHYSI.PREV.QTY<1,1>,MAT INV.CNV.REC,ROND,'')
            			TEMP.PREV.QTY<1,1> = OCONV(TEMP.PREV.QTY<1,1>,ICR.CNV)
				OUT.PARAM<1,1> = TEMP.PREV.QTY
				OUT.PARAM<1,2> = PHYSI.PREV.DIA
				OUT.PARAM<1,3> = PHYSI.PREV.SQTY
         		END
      		END ELSE
         		ERRMSG = 'THIS SERIAL BELONGS TO PRODUCT ':ISTK.PROD
			GOTO 99999
      		END
   	END ELSE
      		ERRMSG = 'NOT ON FILE. ENTER "N" FOR NEW'
		GOTO 99999
   	END
	VAL = RBO.setProperty('','PHYSI_TEMP_OUTPUT',OUT.PARAM)
	IF ALERTMSG # "" THEN
		VAL = RBO.setProperty('','ServerStatus','A')
		VAL = RBO.setProperty('','ServerMessage',ALERTMSG)
	END
	RELEASE
RETURN

99999 ;* ERROR CONTROL BLOCK
	VAL = RBO.setProperty('','INV_PRECI',INPUT.VAL)
	IF ERRMSG # "" THEN
		STATUS = RBO.setProperty('','ServerStatus','1')
		STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
	END ELSE
		STATUS = RBO.setProperty('','ServerStatus','')
	END
	RELEASE
RETURN

