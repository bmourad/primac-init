SUBROUTINE OPSCME_CHK_DUPVAL
********************************************************************************
*   Program name :- OPSCME_CHK_DUPVAL
*   Created:- 9/22/2003
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE OPS.CPYLIB ORDER.INVOICE
$INCLUDE PMC.CPYLIB VOID.INVOICES
$INCLUDE OPS.CPYLIB DAILY.ORDER.INVOICE
$INCLUDE PMC.CPYLIB TAX
$INCLUDE PMC.CPYLIB TERMS
$INCLUDE OPS.CPYLIB BOL
$INCLUDE PMC.CPYLIB SHIP.VIA
* Insert method code here

OPEN "","DAILY.ORDER.INVOICE" TO DAILY.ORDER.INVOICE ELSE ERRMSG = "Cannot locate the DAILY.ORDER.INVOICE file"; GOTO 99999
OPEN "","ORDER.INVOICE" TO ORDER.INVOICE ELSE ERRMSG = "Cannot locate the ORDER.INVOICE file"; GOTO 99999
OPEN "","OPEN.RECV" TO OPEN.RECV ELSE ERRMSG="OPEN.RECV FILE IS MISSING"; GOTO 99999
OPEN '',"TERMS" TO TERMS ELSE ERRMSG = "Cannot locate the TERMS file" ; GOTO 99999
OPEN "","TAX" TO TAX ELSE ERRMSG = "Cannot locate the TAX file"; GOTO 99999
OPEN "","VOID.INVOICES" TO VOID.INVOICES ELSE ERRMSG = "Cannot locate the VOID.INVOICES file"; GOTO 99999

OPEN "","BOL" TO BOL ELSE ERRMSG = "Cannot locate the BOL file"; GOTO 99999
OPEN "","SHIP.VIA" TO SHIP.VIA ELSE ERRMSG = "Cannot locate the SHIP-VIA file"; GOTO 99999

STATUS = RBO.getProperty('','PMCProperty',PMCProperty)
CONO = PMCProperty<1,4>


STATUS = RBO.getProperty('','DUP_INVOICE',DUP_INVOICE) ; * VALUE OF THE ID FROM DUPLICATE INVOICE
STATUS = RBO.getProperty('','DUP_INVOICE_II',DUP_INVOICE_II) ; * NEW ID

STATUS = RBO.getProperty('','MENU',MENU)
STATUS = RBO.getProperty('',CO_ARS,CO_ARS)

*STATUS = RBO.setProperty('','ServerMessage','DFJDFJDKJF-' : CONO:DUP_INVOICE)
*RETURN

*MENU = 'CREDIT'
*CO.ARS = 'Y' ;* REMOVE ATLAST

MAT IVC.REC = ''
INVOICE.TOTAL = 0
SHIP_VIA_DESC  = ''
*STATUS = RBO.setProperty('','ServerMessage',CONO:DUP_INVOICE)
*RETURN

MATREAD IVC.REC FROM ORDER.INVOICE, CONO:DUP_INVOICE ELSE
	ERRMSG = "Cannot locate Invoice # ": DUP_INVOICE
	GOTO 99999
END

BEGIN CASE
	CASE LEN(DUP_INVOICE_II) > 0 AND LEN(DUP_INVOICE_II) <= 6
		DUP_INVOICE_II = STR("0",6-LEN(DUP_INVOICE_II)):DUP_INVOICE_II 
              BEGIN CASE
                  CASE MENU = "CREDIT"
                     DUP_INVOICE_II = DUP_INVOICE_II:"CM"
                  CASE MENU = "DEBIT"
                     DUP_INVOICE_II = DUP_INVOICE_II:"DM"
                  *CASE PRE.BILL = "Y"
                  *   DUP_INVOICE_II = DUP_INVOICE_II:"PB"
               END CASE
               IF CO_ARS = "Y" THEN
                  READ REC FROM OPEN.RECV, CONO : DUP_INVOICE_II THEN
                     ERRMSG = "Invoice exists in the OPEN.RECV file"
                     GOTO 99999
                  END
               END
               READ REC FROM ORDER.INVOICE, CONO : DUP_INVOICE_II THEN
                  ERRMSG = "Invoice exists in the ORDER.INVOICE file"
                  GOTO 99999
               END
               READ REC FROM VOID.INVOICES, CONO : DUP_INVOICE_II THEN
                  ERRMSG = "Invoice exists in the VOID.INVOICES file"
                  GOTO 99999                  
               END
          * T26126  v
               READU REC FROM DAILY.ORDER.INVOICE, CONO : DUP_INVOICE_II LOCKED
                  ERRMSG = 'INVOICE record is locked by user - ':GETUSERNAME(STATUS())
                  GOTO 99999                  
               END THEN
          * T26126 ^
                  RELEASE DAILY.ORDER.INVOICE, CONO : DUP_INVOICE_II 
	                 ERRMSG = "Invoice exists in the DAILY.ORDER.INVOICE file"
                        GOTO 99999 
              END
	CASE 1
               ERRMSG = "Invalid format. Try again! "
               GOTO 99999
END CASE

IVC.NO = DUP_INVOICE_II
IVC.DATE = DATE()
IVC.PROC.DATE = ""
IVC.PRT.DATE = ""
IVC.PROC.MON = ""
IVC.STATUS = ""
IVC.LAST = ""
IVC.WIP.DATE = ""
IVC.WIP.PRCNT = ""
IVC.PRE.BILL = ""
IVC.PRE.BILL.MON = ""
IVC.GLA.DATE = ""
MODE = "NEW"
***********

*---- Continue
*
   SAVE.IVC.LAST = IVC.LAST
	
*   IF PRE.BILL = "Y" THEN
*      MTYPE = "PREBILL"
*   END ELSE
*      MTYPE = MENU
*   END
*   IF MODE = "OLD" THEN ACTION = "I" ELSE ACTION = "M"
   
*   * CALL OPS.INVOICE.SUB(ACTION,MTYPE,CONO,IVC.NO,MAT IVC.REC,CO.ARS,VOID.INVOICES)
*   RELEASE DAILY.ORDER.INVOICE, CONO:IVC.NO
*   GOTO 120
*
*---- SET SCREEN VALUES
9000 *
*T25764 v
   MATREAD TERMS.REC FROM TERMS, CONO:IVC.TERMS ELSE
      MAT TERMS.REC = ""
      TERMS.DESC = "??????????"
   END
*T25764 ^
   IVC_CUST_NO=IVC.CUST.NO
   IVC_CUST_NAME=IVC.CUST.NAME
   IVC_ADDR1=IVC.ADDR1
   IVC_ADDR2=IVC.ADDR2
   IVC_ADDR3=IVC.ADDR3
   IVC_ADDR4=IVC.ADDR4
   IVC_BOL_NO=IVC.BOL.NO
   IVC_ATTENTION=IVC.ATTENTION
   IVC_ORDER_NO=IVC.ORDER.NO
   IVC_CRD_NO=IVC.NO
   IVC_DATE=IVC.DATE
   IVC_PO_NO=IVC.PO.NO
   IF IVC.PROC.DATE="" THEN
      IF IVC.PRT.DATE # "" THEN
         IVC_CRD_MEMO_STAT="PRINTED"
         IVC_CRD_MEMO_STAT_DATE=IVC.PRT.DATE
      END
   END ELSE
      IVC_CRD_MEMO_STAT="PROCESSED"
      IVC_CRD_MEMO_STAT_DATE=IVC.PROC.DATE
   END
   IVC_CHG_CODE=IVC.CHG.CODE
   IVC_QUANTITY=IVC.QUANTITY
   IVC_UM=IVC.UM
   IVC_DESC=IVC.DESC
   IVC_UNIT_PRICE=IVC.UNIT.PRICE
   IVC_AMOUNT=IVC.AMOUNT
*T25764 v
   IVC_TERMS=IVC.TERMS
   IVC_TERMS_DESC=TERMS.DESC

   IVC.DUE.DATE = IVC.DATE + TERMS.DUE.DAYS
   IVC_DUE_DATE=IVC.DUE.DATE
*T25764 ^
   REF.CNT=DCOUNT(IVC.CHG.CODE,@VM)
   FOR REF=1 TO REF.CNT
      IF IVC.CHG.CAT<1,REF>="TAX" THEN
         MATREAD TAX.REC FROM TAX, CONO:IVC.TAX.JURS<1,REF> ELSE
            MAT TAX.REC=""
            ERRMSG="Invalid tax jurisdiction - ":IVC.TAX.JURS<1,REF>
            GOTO 99999
         END
         TMP.TAX.RATE<1,REF>=TAX.RATE
         TAX.REF=REF
         GOSUB 6400
         BEGIN CASE
            CASE IVC.AMOUNT<1,REF>=""
               IVC.TAXABLE<1,REF>=AMT.TAX
               IVC.AMOUNT<1,REF>=TAMT
               *SCV.REC(17)<ESN,REF>=TAMT ; * TAX amount
               TMP.TAX.CALC<1,REF>="C"
            CASE TMP.TAX.CALC<1,REF>="C"
               IVC.TAXABLE<1,REF>=AMT.TAX
               IVC.AMOUNT<1,REF>=TAMT
               *SCV.REC(17)<ESN,REF>=TAMT
            CASE IVC.AMOUNT<1,REF>=TAMT
               TMP.TAX.CALC<1,REF>="C"
            CASE 1
               TMP.TAX.CALC<1,REF>="E"
         END CASE
      END
   NEXT REF
   GRID_TOTAL=INVOICE.TOTAL ; * Total

* added to collect the details for product screen
***********
* BELOW TO COLLECT SHIP DATE,FRIEGHT NO, INVOICE AMT, SHIPPER , FROM BOL, SHIP.TO AND SHIP.VIA

MATREAD BOL.REC FROM BOL, CONO:IVC.BOL.NO ELSE
  ERRMSG = "Cannot locate Bill of Lading # ":IVC.BOL.NO
  GOTO 99999
END

* = BOL.SHIP.TO
* = BOL.SHIP.VIA

* = BOL.SHP.DATE
* = BOL.FREIGHT
* = BOL.INV.AMT

IF BOL.SHIP.VIA = "" THEN
    MAT SHIP.VIA.REC = ""
END ELSE
    MATREAD SHIP.VIA.REC FROM SHIP.VIA, CONO:BOL.SHIP.VIA ELSE
      MAT SHIP.VIA.REC = ""
    END
END

SHIP_VIA_DESC   = SHPV.DESC

*OCONV(IVC.AMOUNT<1,I>,'MD2')

STATUS = RBO.setProperty('','BOL_SHP_DATE',OCONV(BOL.SHP.DATE,'D2/')) ; *SHIP DATE
STATUS = RBO.setProperty('','BOL_FREIGHT',BOL.FREIGHT) ; * FRIEGHT NO
STATUS = RBO.setProperty('','BOL_FRIEGHTD',OCONV(BOL.INV.AMT,'MD2')) ; * FRIEGHT INVOICE AMT.
STATUS = RBO.setProperty('','BOL_CUST',SHIP_VIA_DESC) ; * SHIPPER

*********
STATUS = RBO.setProperty('','IVC_CUST_NO',IVC_CUST_NO)
STATUS = RBO.setProperty('','IVC_CUST_NAME',IVC_CUST_NAME)
STATUS = RBO.setProperty('','IVC_ADDR1',IVC_ADDR1)
STATUS = RBO.setProperty('','IVC_ADDR2',IVC_ADDR2)
STATUS = RBO.setProperty('','IVC_ADDR3',IVC_ADDR3)
STATUS = RBO.setProperty('','IVC_ADDR4',IVC_ADDR4)
STATUS = RBO.setProperty('','IVC_BOL_NO',IVC_BOL_NO)
STATUS = RBO.setProperty('','IVC_ATTENTION',IVC_ATTENTION)
STATUS = RBO.setProperty('','IVC_ORDER_NO',IVC_ORDER_NO)
STATUS = RBO.setProperty('','IVC_CRD_NO',IVC_CRD_NO)

STATUS = RBO.setProperty('','IVC_DATE',OCONV(IVC.DATE,"D2/"))
*STATUS = RBO.setProperty('','IVC_DATE',IVC_DATE)

STATUS = RBO.setProperty('','IVC_PO_NO',IVC_PO_NO)
STATUS = RBO.setProperty('','IVC_CRD_MEMO_STAT',IVC_CRD_MEMO_STAT)
STATUS = RBO.setProperty('','IVC_CRD_MEMO_STAT_DATE',IVC_CRD_MEMO_STAT_DATE)
STATUS = RBO.setProperty('','IVC_CHG_CODE',IVC_CHG_CODE)
STATUS = RBO.setProperty('','IVC_QUANTITY',IVC_QUANTITY)
STATUS = RBO.setProperty('','IVC_UM',IVC_UM)
STATUS = RBO.setProperty('','IVC_DESC',IVC_DESC)
STATUS = RBO.setProperty('','IVC_UNIT_PRICE',IVC_UNIT_PRICE)
STATUS = RBO.setProperty('','IVC_AMOUNT',IVC_AMOUNT)


*STATUS = RBO.setProperty('','IVC_TAXABLE',IVC_AMOUNT)

STATUS = RBO.setProperty('','IVC_TERMS',IVC_TERMS)
STATUS = RBO.setProperty('','IVC_TERMS_DESC',IVC_TERMS_DESC)

STATUS = RBO.setProperty('','IVC_DUE_DATE',OCONV(IVC_DUE_DATE,"D2/"))
*STATUS = RBO.setProperty('','IVC_DUE_DATE',IVC_DUE_DATE)

**ADDED
STATUS = RBO.setProperty('','IVC_SHIP_TO',IVC.SHIP.TO)
STATUS = RBO.setProperty('','IVC_PROD',IVC.PROD)
STATUS = RBO.setProperty('','IVC_PALLET',IVC.PALLET)
STATUS = RBO.setProperty('','IVC_SHP_QTY',IVC.SHP.QTY)
***********
RETURN

*---- CALCULATE SALES TAX
6400 *
   AMT.TAX=0
   TDONE=0
   FOR TREF=TAX.REF-1 TO 1 STEP -1 UNTIL TDONE
      IF IVC.CHG.CAT<1,TREF>="TAX" THEN
         IF AMT.TAX > 0 THEN TDONE=1
      END ELSE
         IF IVC.CHG.CODE<1,TREF> # "SUBT" THEN
            AMT.TAX=AMT.TAX + IVC.AMOUNT<1,TREF>
            IF IVC.CHG.CODE<1,TREF>="SUB" THEN
               TDONE=1
            END
         END
      END
   NEXT TREF
   IF IVC.TAX.EXEMPT="Y" THEN
      TAMT=0
   END ELSE
      TAMT=INT(AMT.TAX*(TMP.TAX.RATE<1,TAX.REF>/1000)/100+0.5)
   END
   RETURN
*
* End of method code
99999*
STATUS = RBO.setProperty('','ServerStatus',1)
STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
RETURN

