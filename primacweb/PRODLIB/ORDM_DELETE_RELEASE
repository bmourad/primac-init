SUBROUTINE ORDM_DELETE_RELEASE
********************************************************************************
*   Program name :- ORDM_DELETE_RELEASE
*   Created:- 4/5/2006
*   Programmer :- Suhail Hussain S
********************************************************************************
$INCLUDE WWINSERT RBO.H

$INCLUDE CPYLIB COMMON1
$INCLUDE JCS.CPYLIB COM.JCS.LINK
$INCLUDE ICS.CPYLIB COM.INV.MAIN
$INCLUDE ICS.CPYLIB COM.INV.SERIAL
$INCLUDE JCS.CPYLIB COM.INV.STATS
$INCLUDE PMC.CPYLIB COM.CUST
$INCLUDE OPS.CPYLIB COM.ORDER

$DEFINE INVENTORY
$DEFINE ORDER
$DEFINE ORDERDETAILINQ
$DEFINE CUSTOMER
$DEFINE CATEGORY
$DEFINE INVWHSE
$DEFINE FNGDSTATS
$DEFINE FNGDORDERSTATS
$DEFINE JOB
$DEFINE FILEVARS
$DEFINE COMPOPS

$INCLUDE OPS.CPYLIB PICK.TICKET
$INCLUDE PMC.CPYLIB COMP.OPS
$INCLUDE PMC.CPYLIB CUSTOMER
$INCLUDE OPS.CPYLIB ORDER
$INCLUDE OPS.CPYLIB ORDER.JOB
$INCLUDE OPS.CPYLIB ORDER.DETAIL
$INCLUDE OPS.CPYLIB ORDER.DETAIL.INQ
$INCLUDE OPS.CPYLIB ORDER.RELEASE
$INCLUDE ICS.CPYLIB INVENTORY
$INCLUDE ICS.CPYLIB CATEGORY
$INCLUDE ICS.CPYLIB INV.WHSE
$INCLUDE ICS.CPYLIB INV.FNGD
$INCLUDE ICS.CPYLIB INV.CNV
$INCLUDE ICS.CPYLIB FNGD.BOM
$INCLUDE ICS.CPYLIB FNGD.STATS
$INCLUDE ICS.CPYLIB FNGD.ORDER.STATS
$INCLUDE ICS.CPYLIB FNGD.JOB.STATS
$INCLUDE JCS.CPYLIB JOB
$INCLUDE PMC.CPYLIB SHIP.TO
$INCLUDE CPYLIB FILE.VARS
$INCLUDE CPYLIB CHAR

   OPEN "","CUSTOMER" TO CUSTOMER ELSE ERRMSG = "CANNOT OPEN CUSTOMER FILE";GOTO 91000
   OPEN "","ORDER" TO ORDER ELSE ERRMSG = "CANNOT OPEN ORDER FILE";GOTO 91000
   OPEN "","ORDER.DETAIL" TO ORDER.DETAIL ELSE ERRMSG = "CANNOT OPEN ORDER.DETAIL FILE";GOTO 91000
   OPEN "","ORDER.RELEASE" TO ORDER.RELEASE ELSE ERRMSG = "CANNOT OPEN ORDER.RELEASE FILE";GOTO 91000
   OPEN "","INVENTORY" TO INVENTORY ELSE ERRMSG = "CANNOT OPEN INVENTORY FILE";GOTO 91000
   OPEN "","CATEGORY" TO CATEGORY ELSE ERRMSG = "CANNOT OPEN CATEGORY FILE";GOTO 91000
   OPEN "","INV.WHSE" TO INV.WHSE ELSE ERRMSG = "CANNOT OPEN INV.WHSE FILE";GOTO 91000
   OPEN "","INV.FNGD" TO INV.FNGD ELSE ERRMSG = "CANNOT OPEN INV.FNGD FILE";GOTO 91000
   OPEN "","FNGD.BOM" TO FNGD.BOM ELSE ERRMSG = "CANNOT OPEN FNGD.BOM FILE";GOTO 91000
   OPEN "","FNGD.STATS" TO FNGD.STATS ELSE ERRMSG = "CANNOT OPEN FNGD.STATS FILE";GOTO 91000
   OPEN "","FNGD.ORDER.STATS" TO FNGD.ORDER.STATS ELSE ERRMSG = "CANNOT OPEN  FILE";GOTO 91000
   OPEN "","FNGD.JOB.STATS" TO FNGD.JOB.STATS ELSE ERRMSG = "CANNOT OPEN FNGD.JOB.STATS FILE";GOTO 91000
   OPEN "","PRICE.TABLE" TO PRICE.TABLE ELSE ERRMSG = "CANNOT OPEN PRICE.TABLE FILE";GOTO 91000
   OPEN "","WAREHOUSE" TO WAREHOUSE ELSE ERRMSG = "CANNOT OPEN WAREHOUSE FILE";GOTO 91000
   OPEN "","ESTIMATE" TO ESTIMATE ELSE ERRMSG = "CANNOT OPEN ESTIMATE FILE";GOTO 91000
   OPEN "","JOB" TO JOB ELSE ERRMSG = "CANNOT OPEN JOB FILE";GOTO 91000
   OPEN "","CONTROL" TO CONTROL ELSE ERRMSG = "CANNOT OPEN CONTROL FILE";GOTO 91000
   OPEN "","SHIP.TO" TO SHIP.TO ELSE ERRMSG = "CANNOT OPEN SHIP.TO FILE";GOTO 91000
   OPEN "","PICK.TICKET.PRT" TO PICK.TICKET.PRT ELSE ERRMSG = "Cannot locate the PICK.TICKET.PRT file";GOTO 91000
   OPEN "","PICK.TICKET" TO PICK.TICKET ELSE ERRMSG = "Cannot locate the PICK.TICKET file";GOTO 91000

   STATUS = RBO.getProperty("","PMCProperty",PMCProperty)
   STATUS = RBO.getProperty("","INARR",INARR)
   STATUS = RBO.getProperty("","RETARR",OSDARRAY)
   STATUS = RBO.getProperty("","GRIDARR",OSD_FULL_ARR)

   CONO = PMCProperty<1,4>
   RELNO = INARR<1,1>
   ORDNO = INARR<1,2>
   ORD_SHIP_TO = INARR<1,3>
   ORD_REC = INARR<1,4>
   ORR.SHIP.TO = INARR<1,5>

   MAT ORD.DET.SUM = ""
   MAT ORD.DET.INQ = ""

   SWAP "ð" WITH VM IN ORD_REC
   SWAP "#" WITH VM IN ORD_SHIP_TO

   MATREAD ORD.REC FROM ORDER, CONO : ORDNO ELSE MAT ORD.REC = ""
   ORD.SHIP.TO    = ORD_SHIP_TO
   ORD.STATUS     = ORD_REC<1,1> 
   ORD.PO         = ORD_REC<1,2> 
   ORD.DATE       = ORD_REC<1,3> 
   ORD.RCV.DATE   = ORD_REC<1,4> 
   ORD.REQ.DATE   = ORD_REC<1,5> 
   ORD.DUE        = ORD_REC<1,6> 
   ORD.JOB        = ORD_REC<1,7> 
   ORD.CUST       = ORD_REC<1,8> 
   ORD.DIV        = ORD_REC<1,9> 
   ORD.CSR.CODE   = ORD_REC<1,10>
   ORD.SLSMN      = ORD_REC<1,11>

   FOR X = 1 TO DCOUNT(ORD.SHIP.TO,VM)
     TEMPORD_REC = FIELD(OSD_FULL_ARR,"¥",X,1)
     IF ORD.SHIP.TO<1,X> = ORR.SHIP.TO THEN TEMPORD_REC = OSDARRAY
     MATPARSE ORD.DET.REC FROM TEMPORD_REC,"ð"
     FOR P = 1 TO ORD.DET.REC.SIZE
       ORD.DET.SUM(P,X) = ORD.DET.REC(P)
     NEXT P
   NEXT X

   MATPARSE ORD.DET.REC FROM OSDARRAY,"ð"

   LINES = DCOUNT(OSD.PROD,VM)
   LOCATE ORR.SHIP.TO IN ORD.SHIP.TO<1> SETTING SPTR ELSE SPTR = 0  
   SHPNO = ORR.SHIP.TO
   LOCATE RELNO IN ORD.REL.NO<1>, 1 SETTING RPTR THEN
      ORD.REL.NO = DELETE(ORD.REL.NO,1,RPTR,0)
      FOR P = 1 TO ORD.DET.REC.SIZE
        ORD.DET.SUM(P,SPTR) = ORD.DET.REC(P)
      NEXT P
      STATUS = "L"
      CALL ORDER_LINE_UPD(CONO,ORDNO,SHPNO,STATUS)
      STATUS = "U"; SHPNO = ""
      CALL ORDER_LINE_UPD(CONO,ORDNO,SHPNO,STATUS)
      DELETE ORDER.RELEASE, CONO:RELNO
      PCNT = DCOUNT(ORD.PICK.NO,@VM) ; PKT.FOUND = 0
      FOR P = 1 TO PCNT UNTIL (PKT.FOUND)   
        MATREADU PKT.REC FROM PICK.TICKET, CONO:ORD.PICK.NO<1,P> THEN
          IF PKT.REL.NO = RELNO THEN 
            PKT.REL.NO = '' ; PKT.FOUND = 1 
            MATWRITE PKT.REC ON PICK.TICKET, CONO:ORD.PICK.NO<1,P>
          END
        END
        RELEASE PICK.TICKET, CONO:ORD.PICK.NO<1,P> 
      NEXT P
      SHPWHS = ""
      FOR P = 1 TO LINES
        SHPWH = ORR.SHIP.TO:"!":OSD.WHSE<1,P>
        LOCATE SHPWH IN SHPWHS,1 SETTING FND ELSE
          PKT.ID = CONO:ORDNO:"!":SHPWH
          READU REC FROM PICK.TICKET.PRT, PKT.ID THEN
            LOCATE RELNO IN REC,1 SETTING PTR THEN
              REC = DELETE(REC,PTR,0,0)
              IF REC = "" THEN
                DELETE PICK.TICKET.PRT, PKT.ID
              END ELSE
                WRITE REC ON PICK.TICKET.PRT, PKT.ID
              END
              SHPWHS<FND> = SHPWH
            END
          END ELSE
            RELEASE PICK.TICKET.PRT, PKT.ID
          END
        END
      NEXT P
     FOR P = 1 TO ORD.DET.REC.SIZE
       ORD.DET.SUM(P,SPTR) = ORD.DET.REC(P)
     NEXT P
     STATUS = "L"; SHPNO = "ALL"
     CALL ORDER_LINE_UPD(CONO,ORDNO,SHPNO,STATUS)
     RETARR = ""
     FOR X = 1 TO DCOUNT(ORD.SHIP.TO,VM) 
       FOR P = 1 TO ORD.DET.REC.SIZE
          RETARR := ORD.DET.SUM(P,X) : "ð"
       NEXT P
       IF X # DCOUNT(ORD.SHIP.TO,VM) THEN RETARR := "¥"
     NEXT X
     STATUS = RBO.setProperty("","DISPARR",RETARR)
   END ELSE
     STATUS = RBO.setProperty("","DISPARR","")
   END
   RELEASE
RETURN

91000
   RELEASE
   STATUS = RBO.setProperty("","ServerStatus",1)
   STATUS = RBO.setProperty("","ServerMessage",ERRMSG)
RETURN
