SUBROUTINE ESTCEM_DEPT_MAINT
********************************************************************************
*   Program name :- ESTCEM_DEPT_MAINT
*   Created:- 3/17/2005
*------------------------------------------------------------------------------*
*

* In Properties:
* --------------
*  
*
* Out Properties:
* ---------------
*  
********************************************************************************
$INCLUDE WWINSERT RBO.H
$INCLUDE JES.CPYLIB SCOMMON.ESTIMATE
$INCLUDE PMC.CPYLIB DEPARTMENT
$INCLUDE PMC.CPYLIB COST.CNTR
$INCLUDE JCS.CPYLIB OPERATION

$DEFINE ESTIMATE
$INCLUDE JES.CPYLIB ESTIMATE
$DEFINE ESTIMATETEMP
$INCLUDE JES.CPYLIB ESTIMATE.TEMP
$DEFINE ESTIMATEDEPT
$INCLUDE JES.CPYLIB ESTIMATE.DEPT
$INCLUDE JES.CPYLIB ESTIMATE.GRP
$INCLUDE JES.CPYLIB ESTIMATE.GRP.XREF
$DEFINE ESTIMATEMATL
$INCLUDE JES.CPYLIB ESTIMATE.MATL
$DEFINE EQUIPMENT
$INCLUDE JES.CPYLIB EQUIPMENT
$INCLUDE PMC.CPYLIB VEND
$INCLUDE ICS.CPYLIB CATEGORY
$INCLUDE JCS.CPYLIB CATEGORY.OSP
$INCLUDE PMC.CPYLIB SHIP.VIA

$DEFINE FILEVARS
$INCLUDE CPYLIB FILE.VARS
$INCLUDE CPYLIB GEN.XREF.SUB

$DEFINE JESFILEVARS
$INCLUDE JES.CPYLIB JES.FILE.VARS
$INCLUDE CPYLIB CHAR
$INCLUDE CPYLIB SYSCOM


	OPEN "ESTIMATE.DEPT" TO ESTIMATE.DEPT ELSE ERRMSG="CANNOT OPEN ESTIMATE.DEPT FILE";GOTO 1099
	OPEN "ESTIMATE.GRP" TO ESTIMATE.GRP ELSE ERRMSG="CANNOT OPEN ESTIMATE.GRP FILE";GOTO 1099
	OPEN "ESTIMATE.MATL" TO ESTIMATE.MATL ELSE ERRMSG="CANNOT OPEN ESTIMATE.MATL FILE";GOTO 1099
	OPEN "COST.CNTR" TO COST.CNTR ELSE ERRMSG="CANNOT OPEN COST.CNTR FILE";GOTO 1099
	OPEN "EQUIPMENT" TO EQUIPMENT ELSE ERRMSG="CANNOT OPEN EQUIPMENT FILE";GOTO 1099
	OPEN "OPERATION" TO OPERATION ELSE ERRMSG="CANNOT OPEN OPERATION FILE";GOTO 1099
	OPEN "VEND" TO VEND ELSE ERRMSG="CANNOT OPEN VEND FILE";GOTO 1099
	OPEN "CATEGORY.OSP" TO VEND ELSE ERRMSG="CANNOT OPEN CATEGORY.OSP FILE";GOTO 1099
	OPEN "SHIP.VIA" TO VEND ELSE ERRMSG="CANNOT OPEN SHIP.VIA FILE";GOTO 1099
	OPEN "DEPARTMENT" TO DEPARTMENT ELSE ERRMSG="CANNOT OPEN DEPARTMENT FILE";GOTO 1099

MCCTR=457
ACTION="A"
CONO='001'
COMP=3
DPTR=3
EQTY=25000
EST.KEY=1024-01
REF.NO =1
DEPT=45
S$SCR=''
XCODE=''
XREF.LINE.COUNT=0
S$VALUE=MCCTR
TEMP.TYPE='LL'

 IF DATA.FLAG THEN
    ***  SCREEN CLEAR
      DATA.FLAG=0
 END
   IF DEPT="CON" THEN
      MAT DEPT.REC=""
      DEPT.DESC="CONSOLIDATED"
   END ELSE
      MATREAD DEPT.REC FROM DEPARTMENT,CONO:DEPT ELSE
         ERRMSG="Invalid department - ":DEPT
         GOTO 1099
      END
   END
   *READV ESTGX.GRP FROM ESTIMATE.GRP.XREF,CONO:DEPT,1 ELSE ESTGX.GRP=""
   NEW.REC=0
   ESTD.ID=DPTR:"!":COMP:"!":EQTY
   IF ACTION="A" OR ACTION="M" THEN
      MATREADU ESTD.REC FROM ESTIMATE.DEPT,CONO:EST.KEY:"!":ESTD.ID ELSE
         NEW.REC=1
         MAT ESTD.REC=""
      END
   END ELSE
      MATREAD ESTD.REC FROM ESTIMATE.DEPT,CONO:EST.KEY:"!":ESTD.ID ELSE
         NEW.REC=1
         MAT ESTD.REC=""
      END
   END
   IF (ACTION="A" OR ACTION="M") AND EQTY # EST.QTY<1,1> AND NEW.REC THEN
    ***  CALL EST.QTY.CALC (CONO,"E",EST.KEY,DPTR,COMP,EQTY)
      NEW.REC=0
      MATREADU ESTD.REC FROM ESTIMATE.DEPT,CONO:EST.KEY:"!":ESTD.ID ELSE
         RELEASE ESTIMATE.DEPT,CONO:EST.KEY:"!":ESTD.ID
        *** RETURN
      END
   END

   DDESC=EST.DEPT.DESC<1,DPTR>
   CCTR.CNT=DCOUNT(DEPT.CCTRS,VM)
   DEPT.CCTRS.DESC=""
****************************************   
***1200*
****   IF TEMP.TYPE="G" THEN GOTO 1300
   PREV.CCTR=ESTD.CCTR<1,REF.NO>
   XREF.REF.NO=999
   XREF.CURR.REF.NO=""
   XREF.DESC=DEPT.CCTRS.DESC
   XREF.CNT=CCTR.CNT
   XREF.REF.NO=1


  **** GOSUB 41000
***1210*
  **** S$VAL=REF.NO
  **** S$DATA(10)<S$SCR,REF.NO>=ESTD.CCTR<1,REF.NO>
  **** IF ESTD.CCTR<1,REF.NO>="" AND REF.NO > 1 THEN
  ****    S$DATA(10)<S$SCR,REF.NO>=ESTD.CCTR<1,REF.NO-1>
  **** END ELSE
  ****    S$DATA(10)<S$SCR,REF.NO>=ESTD.CCTR<1,REF.NO>
  **** END
  **** IF S$DATA(10)<S$SCR,REF.NO>="" AND XREF.CNT=1 THEN
  ****    S$DATA(10)<S$SCR,REF.NO>=DEPT.CCTRS
  **** END
   ***SCREEN FIELD;;10
   ***SCREEN INPUT;;10;RETURN
   BEGIN CASE
      CASE S$VALUE="S"
         XREF.REF.NO=XREF.REF.NO+XREF.LINE.COUNT
         IF XREF.REF.NO > XREF.CNT THEN XREF.REF.NO=1
       ***  GOSUB 41000
        *** GOTO 1210
    * T25978 v
      CASE S$VALUE = 'SR'
         XREF.REF.NO -= XREF.LINE.COUNT
         IF XREF.REF.NO < 1 THEN XREF.REF.NO = 1
       ****  GOSUB 41000 ; GOTO 1210
      CASE S$VALUE = 'ST'
         XREF.REF.NO = 1
      ****   GOSUB 41000 ; GOTO 1210
      CASE S$VALUE = 'SB'
         XREF.REF.NO = XREF.CNT
      ****   GOSUB 41000 ; GOTO 1210
      CASE 1
         IF DEPT # "CON" THEN
            LOCATE S$VALUE IN DEPT.CCTRS<1>,1 SETTING CC.PTR ELSE
               ERRMSG="Invalid cost center for this department. Try again! "
		 GOTO 1099
               ****GOSUB 90000
               ***GOTO 1210
            END
         END
	

         MATREAD CCTR.REC FROM COST.CNTR,CONO:S$VALUE ELSE
            ERRMSG="Invalid Cost Center. Try again! "
		GOTO 1099
           **** GOSUB 90000
           *** GOTO 1210
         END
         MATREAD EQUIPMENT.REC FROM EQUIPMENT,CONO:S$VALUE ELSE
            MAT EQUIPMENT.REC=""
         END
   END CASE
   TEMP.CCTR=S$VALUE
   TEMP.CCTR.TYPE=EQP.TYPE

   IF TEMP.CCTR # PREV.CCTR THEN MODE2="A"

********************************************************************
**1300*
   XREF.REF.NO=999
   XREF.CURR.REF.NO=""
   XREF.DESC=""
   BEGIN CASE
      CASE TEMP.TYPE[1,1]="G"
        PREV.OPV=ESTD.OPV<1,REF.NO>
         XREF.REF.NO=999
         XREF.CURR.REF.NO=""
         XREF.DESC=""
         XREF.CNT=DCOUNT(ESTGX.GRP,VM)
         XREF.REF.NO=1
         ****GOSUB 44000
***1302*
         S$VAL=REF.NO
         S$DATA(11)<S$SCR,REF.NO>=ESTD.OPV<1,REF.NO>
         IF S$DATA(11)<S$SCR,REF.NO>="" AND XREF.CNT=1 THEN
            S$DATA(11)<S$SCR,REF.NO>=ESTGX.GRP
         END
       
         BEGIN CASE
            CASE S$VALUE="S"
               XREF.REF.NO=XREF.REF.NO+XREF.LINE.COUNT
               IF XREF.REF.NO > XREF.CNT THEN XREF.REF.NO=1
       ***        GOSUB 44000
       ***        GOTO 1302
    ** T25978 v
            CASE S$VALUE = 'SR'
               XREF.REF.NO -= XREF.LINE.COUNT
               IF XREF.REF.NO < 1 THEN XREF.REF.NO = 1
             ***  GOSUB 44000 ; GOTO 1302
            CASE S$VALUE = 'ST'
               XREF.REF.NO = 1
           ***    GOSUB 44000 ; GOTO 1302
            CASE S$VALUE = 'SB'
               XREF.REF.NO = XREF.CNT
           ***    GOSUB 44000 ; GOTO 1302
    *** T25978 ^
            CASE 1
               LOCATE S$VALUE IN ESTGX.GRP<1>,1 SETTING GPTR ELSE
                  ERRMSG="Invalid group for this department. Try again! "
                  GOTO 1099
               END
	       MATREAD ESTG.REC FROM ESTIMATE.GRP,CONO:DEPT:"!":S$VALUE ELSE
                  ERRMSG="Cannot locate selected group. Try again! "
                  GOTO 1099
               END
               TEMP.OPV=S$VALUE
               TEMP.DESC=ESTG.DESC
         END CASE
      CASE TEMP.TYPE[1,1]="L" OR TEMP.TYPE[1,1]="S" OR TEMP.TYPE[1,1]="O"
         PREV.OPV=ESTD.OPV<1,REF.NO>
         XREF.CNT=DCOUNT(CCTR.OPER,VM)
         XREF.REF.NO=1
***1310*
         S$VAL=REF.NO
         S$DATA(11)<S$SCR,REF.NO>=ESTD.OPV<1,REF.NO>
         IF S$DATA(11)<S$SCR,REF.NO>="" AND XREF.CNT=1 THEN
            S$DATA(11)<S$SCR,REF.NO>=CCTR.OPER
         END
         ***SCREEN FIELD;;11
         ***SCREEN INPUT;;11;RETURN
         BEGIN CASE
            CASE S$VALUE="S"
               XREF.REF.NO=XREF.REF.NO+XREF.LINE.COUNT
               IF XREF.REF.NO > XREF.CNT THEN XREF.REF.NO=1
              *** GOSUB 42000
             ***  GOTO 1310
    * T25978 v
            CASE S$VALUE = 'SR'
               XREF.REF.NO -= XREF.LINE.COUNT
               IF XREF.REF.NO < 1 THEN XREF.REF.NO = 1
             ***  GOSUB 42000 ; GOTO 1310
            CASE S$VALUE = 'ST'
               XREF.REF.NO = 1
            ***   GOSUB 42000 ; GOTO 1310
            CASE S$VALUE = 'SB'
               XREF.REF.NO = XREF.CNT
           ***    GOSUB 42000 ; GOTO 1310
    * T25978 ^
            CASE 1
              MOPER =4002
		S$VALUE =MOPER
		LOCATE S$VALUE IN CCTR.OPER<1>,1 SETTING OP.PTR ELSE
                  ERRMSG="Invalid operation for specified cost center. Try again! "
			GOTO 1099                
		END
	       STATUS = RBO.setProperty('','MTEST',"WW":CCTR.OPER:"*":S$VALUE)
               MATREAD OPER.REC FROM OPERATION,CONO:S$VALUE ELSE
                  ERRMSG="Cannot locate selected operation. Try again! "
			GOTO 1099                
		    ***GOSUB 90000
                  ***GOTO 1310
               END
               TEMP.OPV=S$VALUE
               TEMP.OPV.TYPE=CCTR.OPER.TYPE<1,OP.PTR>

               IF CCTR.OPER.STD.IMP<1,OP.PTR>+0=0 THEN TEMP.OPV.TYPE="F"
               TEMP.FCTR=10000.
              
	       BEGIN CASE
                  CASE TEMP.TYPE[1,1]="L"
                     IF TEMP.OPV.TYPE="F" THEN
                        TEMP.STD=CCTR.OPER.STD.HRS<1,OP.PTR>/100
                        TEMP.STD.TYPE="HR/OP"
                     END ELSE
		        TEMP.STD=CCTR.OPER.STD.IMP<1,OP.PTR>
                        TEMP.STD.TYPE="OP/HR"
		                          
                     END
                  CASE 1
                     TEMP.STD=CCTR.OPER.HR.RATE<1,OP.PTR>/100
                     TEMP.STD.TYPE="$/EA"
               END CASE
               IF TEMP.STD+0=0 THEN TEMP.STD=""
               TEMP.RATE=CCTR.OPER.HR.RATE<1,OP.PTR>
               TEMP.IND.1=CCTR.FOH.TYPE<1,1>:CCTR.FOH.PCT<1,1>
               TEMP.IND.2=CCTR.FOH.TYPE<1,2>:CCTR.FOH.PCT<1,2>
               TEMP.IND.3=CCTR.FOH.TYPE<1,3>:CCTR.FOH.PCT<1,3>
               TEMP.IND.4=CCTR.FOH.TYPE<1,4>:CCTR.FOH.PCT<1,4>
               TEMP.MARKUP=CCTR.OPER.MARKUP<1,OP.PTR>
               TEMP.DESC=OPER.DESC
 		 STATUS = RBO.setProperty('','TEMPSTD',TEMP.STD :"~":TEMP.STD.TYPE :"--":OPER.DESC)
         END CASE
      CASE TEMP.TYPE[1,1]="M"
         PREV.OPV=ESTD.OPV<1,REF.NO>
      
      CASE TEMP.TYPE[1,1]="I"
      CASE TEMP.TYPE[1,1]="P"
***1340*
         S$DATA(11)<S$SCR,REF.NO>=TEMP.OPV
         S$VAL=REF.NO
         ***SCREEN FIELD;;11
* S$O.R="O"
         ***SCREEN INPUT;;11;RETURN
         IF S$VALUE="???" THEN
*               FLD=11;FREF=REF.NO;XTYPE="VENDOR";XFILE=VENDOR;XFLD=1;GOSUB 49000
            FLD=11;FREF=REF.NO;XTYPE="VEND";XFILE=VEND;XFLD=1;***GOSUB 49000
          ***  IF XCODE="" THEN GOTO 1340
         END
         IF S$VALUE="" THEN
            MAT VEND.REC=""
         END ELSE
            MATREAD VEND.REC FROM VEND,CONO:S$VALUE ELSE
               ERRMSG="Invalid Vendor ID. Try again! "
              *** GOSUB 90000
              *** GOTO 1340
            END
         END
         TEMP.OPV=S$VALUE
         TEMP.FCTR=1000
         BEGIN CASE
            CASE TEMP.TYPE="PM"
               TEMP.STD.TYPE="$/M"
               TEMP.UM=1000
            CASE TEMP.TYPE="PC"
               TEMP.STD.TYPE="$/C"
               TEMP.UM=100
            CASE TEMP.TYPE="PT"
               TEMP.STD.TYPE="$/TTL"
               TEMP.UM=1
            CASE 1
               TEMP.STD.TYPE="$/EA"
               TEMP.UM=1
         END CASE
         IF TEMP.DESC="" THEN TEMP.DESC=VEND.DESC
   END CASE
	
***************************************************************************************
1099 *
   STATUS = RBO.setProperty('','ServerStatus',1)
   STATUS = RBO.setProperty('','ServerMessage',ERRMSG)
   RETURN
