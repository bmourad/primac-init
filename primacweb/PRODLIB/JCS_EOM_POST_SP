   SUBROUTINE JCS_EOM_POST_SP(MAT EOM.ACCT.REC,MAT JOB.REC,TRANFILE,REJECTFILE,WIPFILE,ERRMSG)
*********************************************************************
* REVISION    - [12.0]
* Copyright 1982 by Computer Business Associates (Vercom Software, Inc.)
* SYSTEM      - PRIMAC
* SOURCE      - JCSBP
* PROGRAM     - JCS.EOM.POST.SP
* BY          - ZIAD YAMOUT, C.B.A
* DATE        - 02/28/87
* DESCRIPTION -
* TASK
*********************************************************************
$INCLUDE PMC.CPYLIB POST.REJECTS
$INCLUDE JCS.CPYLIB EOM.ACCT
$INCLUDE JCS.CPYLIB JOB
$INCLUDE JCS.CPYLIB JOB.SHIP
$INCLUDE PMC.CPYLIB WIP.SALES.STATS
$INCLUDE PMC.CPYLIB EOM.TRANS
$INCLUDE CPYLIB CHAR
   MAT ETR.REC = ''
OPEN 'JOB' TO JOB ELSE ERRMSG='Cannot open JOB File'; GOTO 9999
OPEN 'JOB.SHIP' TO JOB.SHIP ELSE ERRMSG='Cannot open JOB.SHIP File'; GOTO 9999
OPEN '',TRANFILE TO EOM.TRANS ELSE ERRMSG=TRANFILE:' FILE MISSING';GOTO 9999
OPEN '',REJECTFILE TO POST.REJECTS ELSE ERRMSG=REJECTFILE:' FILE IS MISSING';GOTO 9999
OPEN '',WIPFILE TO WIP.SALES.STATS ELSE ERRMSG=WIPFILE:' FILE IS MISSING';GOTO 9999
   MCNT = COUNT(JOB.SP.SEQ,VM) + (JOB.SP.SEQ # '')
   CHECK.WIP = 0; NEW.REC = 0
   FOR M = 1 TO MCNT
      DPNO = JOB.SP.DEPT<1,M>; CCNO = JOB.SP.CCTR<1,M>
      GLS.DEPT = DPNO[1,2]
      SP.ID = CONO:JOBNO:"!":DPNO:"!":CCNO:"!"
      FOR S = 1 TO JOB.SP.SEQ<1,M>
         MATREADU JSP.REC FROM JOB.SHIP, SP.ID:S ELSE
            MAT PRR.REC = ''
            PRR.JOB = JOBNO
            PRR.FILE = 'JOB.SHIP'
            PRR.ID = SP.ID[4,999]:S
            PRR.ERR = 'CANNOT LOCATE'
            PRR.SEQ = PRR.SEQ + 1
            MATWRITE PRR.REC ON POST.REJECTS, PRR.SEQ
            GOTO 800
         END
         WIP.COST = JSP.WIP
         BEGIN CASE
         CASE JSP.MON = ""
            GOTO 800
         CASE JSP.MON<1,1> # PERIOD OR (JSP.GLA.DATE<1,1> # "" AND JSP.GLA.DATE<1,1> # "P")
            WCNT = COUNT(WIP.COST,VM) + 1
            WPTR = COUNT(WIP.COST<1,1>,SVM) + 1
            FOR W = 1 TO WPTR
               CHECK.WIP = CHECK.WIP + WIP.COST<1,1,W>
            NEXT W
            GOTO 600
         CASE WIP.COST = ""
            WCNT = 0; WPTR = 0
            WIP.CNTR = 0
         CASE JSP.COST < 0
            WCNT = COUNT(WIP.COST,VM) + 1
            WPTR = COUNT(WIP.COST<1,1>,SVM) + 1
            TOT.WIP = 0
            FOR W = 1 TO WPTR
               TOT.WIP = TOT.WIP + WIP.COST<1,1,W>
            NEXT W
            CHECK.WIP = CHECK.WIP + TOT.WIP
            FOR I = 2 TO WCNT
               IF JSP.MON<1,I> = PERIOD  AND (JSP.GLA.DATE<1,I> = "" OR JSP.GLA.DATE<1,I> = "P") THEN
                  FOR W = 1 TO WPTR
                     TOT.WIP = TOT.WIP + WIP.COST<1,I,W>
                  NEXT W
                  JSP.GLA.DATE<1,I> = "P"
               END
            NEXT I
            IF TOT.WIP = 0 THEN
               WIP.CNTR = 2
               WCNT = 0; WPTR = 0
               WIP.COST = ""
            END ELSE
               WIP.CNTR = 1
            END
         CASE 1
            WCNT = COUNT(WIP.COST,VM) + 1
            WPTR = COUNT(WIP.COST<1,1>,SVM) + 1
            WIP.CNTR = 1
            FOR W = 1 TO WPTR
               CHECK.WIP = CHECK.WIP + WIP.COST<1,1,W>
            NEXT W
         END CASE
         COG.COST = JSP.DCOST; COG.COST<2> = JSP.COST - JSP.DCOST
         FOR W = 1 TO 2
            BEGIN CASE
            CASE COG.COST<W> + 0 = 0 AND WIP.COST<1,1,W> + 0 = 0
               GOTO 500
            CASE WIP.COST<1,1,W> + 0 = 0
               BEGIN CASE
               CASE SP.COG.LEVEL<W> < 1
                  DB.ID = GEN.DIV : GEN.DEPT : GEN.CCTR : SP.COG.ACCT<W>
               CASE SP.COG.LEVEL<W> < 2
                  DB.ID = JSP.DIV : GEN.DEPT : GEN.CCTR : SP.COG.ACCT<W>
               CASE SP.COG.LEVEL<W> < 3
                  DB.ID = JSP.DIV : GLS.DEPT : GEN.CCTR : SP.COG.ACCT<W>
               CASE 1
                  DB.ID = JSP.DIV : GLS.DEPT : CCNO : SP.COG.ACCT<W>
               END CASE
               WIP.AMT = COG.COST<W>
            CASE 1
               BEGIN CASE
               CASE SP.WIP.LEVEL<W> < 1
                  DB.ID = GEN.DIV : GEN.DEPT : GEN.CCTR : SP.WIP.ACCT<W>
               CASE SP.WIP.LEVEL<W> < 2
                  DB.ID = JSP.DIV : GEN.DEPT : GEN.CCTR : SP.WIP.ACCT<W>
               CASE SP.WIP.LEVEL<W> < 3
                  DB.ID = JSP.DIV : GLS.DEPT : GEN.CCTR : SP.WIP.ACCT<W>
               CASE 1
                  DB.ID = JSP.DIV : GLS.DEPT : CCNO : SP.WIP.ACCT<W>
               END CASE
               WIP.AMT = WIP.COST<1,1,W>
            END CASE
            BEGIN CASE
            CASE SP.APL.LEVEL<W> < 1
               CR.ID = GEN.DIV : GEN.DEPT : GEN.CCTR : SP.APL.ACCT<W>
            CASE SP.APL.LEVEL<W> < 2
               CR.ID = JSP.DIV : GEN.DEPT : GEN.CCTR : SP.APL.ACCT<W>
            CASE SP.APL.LEVEL<W> < 3
               CR.ID = JSP.DIV : GLS.DEPT : GEN.CCTR : SP.APL.ACCT<W>
            CASE 1
               CR.ID = JSP.DIV : GLS.DEPT : CCNO : SP.APL.ACCT<W>
            END CASE
            GOSUB 1000
            JSP.GLA.DATE<1,1> = "P"
500      NEXT W
         GOSUB 2000       ;* COLLECT WIP FOR SALES STATS
600      FOR I = 2 TO WCNT
            IF JSP.MON<1,I> # PERIOD  OR (JSP.GLA.DATE<1,I> # "" AND JSP.GLA.DATE<1,I> # "P") THEN
               GOTO 700
            END
            WIP.CNTR = 1
            FOR W = 1 TO WPTR
               IF JSP.FNGD<1,I> = "*" THEN
                  BEGIN CASE
                  CASE WIP.CLR.LEVEL < 1
                     DB.ID = GEN.DIV : GEN.DEPT : GEN.CCTR : WIP.CLR.ACCT
                  CASE WIP.CLR.LEVEL < 2
                     DB.ID = JSP.DIV : GEN.DEPT : GEN.CCTR : WIP.CLR.ACCT
                  CASE WIP.CLR.LEVEL < 3
                     DB.ID = JSP.DIV : GLS.DEPT : GEN.CCTR : WIP.CLR.ACCT
                  CASE 1
                     DB.ID = JSP.DIV : GLS.DEPT : CCNO : WIP.CLR.ACCT
                  END CASE
               END ELSE
                  BEGIN CASE
                  CASE SP.COG.LEVEL<W> < 1
                     DB.ID = GEN.DIV : GEN.DEPT : GEN.CCTR : SP.COG.ACCT<W>
                  CASE SP.COG.LEVEL<W> < 2
                     DB.ID = JSP.DIV : GEN.DEPT : GEN.CCTR : SP.COG.ACCT<W>
                  CASE SP.COG.LEVEL<W> < 3
                     DB.ID = JSP.DIV : GLS.DEPT : GEN.CCTR : SP.COG.ACCT<W>
                  CASE 1
                     DB.ID = JSP.DIV : GLS.DEPT : CCNO : SP.COG.ACCT<W>
                  END CASE
               END
               BEGIN CASE
               CASE SP.WIP.LEVEL<W> < 1
                  CR.ID = GEN.DIV : GEN.DEPT : GEN.CCTR : SP.WIP.ACCT<W>
               CASE SP.WIP.LEVEL<W> < 2
                  CR.ID = JSP.DIV : GEN.DEPT : GEN.CCTR : SP.WIP.ACCT<W>
               CASE SP.WIP.LEVEL<W> < 3
                  CR.ID = JSP.DIV : GLS.DEPT : GEN.CCTR : SP.WIP.ACCT<W>
               CASE 1
                  CR.ID = JSP.DIV : GLS.DEPT : CCNO : SP.WIP.ACCT<W>
               END CASE
               WIP.AMT = 0 - WIP.COST<1,I,W>
               GOSUB 1000
               JSP.GLA.DATE<1,I> = "P"
            NEXT W
700      NEXT I
         MATWRITE JSP.REC ON JOB.SHIP, SP.ID:S
800      RELEASE JOB.SHIP, SP.ID:S
      NEXT S
   NEXT M
   CHK.WIP = 0
   FOR W = 1 TO 2
      CHK.WIP = CHK.WIP + JOB.SP.WIP<1,2,W> + JOB.SP.WIP<1,3,W>
   NEXT W
   IF CHECK.WIP <> CHK.WIP THEN
      MAT PRR.REC = ''
      PRR.JOB = JOBNO
      PRR.ERR = 'TOTAL SP = ':CHK.WIP:' AND SEQ SUM = ':CHECK.WIP
      PRR.SEQ = PRR.SEQ + 1
      MATWRITE PRR.REC ON POST.REJECTS, PRR.SEQ
   END
   GOTO 9999
1000 BEGIN CASE
   CASE WIP.AMT > 0
      ETR.DB = CONO : DB.ID : JOBNO : "!SP-D*" : NEW.REC
      ETR.CR = CONO : CR.ID : JOBNO : "!SP-C*" : NEW.REC
   CASE WIP.AMT + 0 < 0
      ETR.DB = CONO : DB.ID : JOBNO : "!SP-C*" : NEW.REC
      ETR.CR = CONO : CR.ID : JOBNO : "!SP-D*" : NEW.REC
   CASE 1
      GOTO 1999
   END CASE
   MATREAD ETR.REC FROM EOM.TRANS, ETR.DB ELSE
      MAT ETR.REC = ''
      ETR.AMT = 0
      ETR.REF = JOB.CUST
   END
   ETR.CNTR = ETR.CNTR + WIP.CNTR
   WIP.CNTR = 0
   ETR.AMT = ETR.AMT + WIP.AMT
   IF NO.DETAIL OR WIP.AMT + 0 = 0 THEN
      MATWRITE ETR.REC ON EOM.TRANS, ETR.DB
      MATREAD ETR.REC FROM EOM.TRANS, ETR.CR ELSE
         MAT ETR.REC = ''
         ETR.AMT = 0
         ETR.REF = JOB.CUST
      END
      ETR.AMT = ETR.AMT - WIP.AMT
      MATWRITE ETR.REC ON EOM.TRANS, ETR.CR
      GOTO 1999
   END
   LOCATE JSP.SEQ IN ETR.TRAN<1>,1 BY "AR" SETTING PTR ELSE NULL
   INS JSP.SEQ BEFORE ETR.TRAN<1,PTR>
   INS JSP.DATE BEFORE ETR.DATE<1,PTR>
   INS WIP.AMT BEFORE ETR.TAMT<1,PTR>
   MATWRITE ETR.REC ON EOM.TRANS, ETR.DB
   MATREAD ETR.REC FROM EOM.TRANS, ETR.CR ELSE
      MAT ETR.REC = ''
      ETR.AMT = 0
      ETR.REF = JOB.CUST
   END
   ETR.AMT = ETR.AMT - WIP.AMT
   LOCATE JSP.SEQ IN ETR.TRAN<1>,1 BY "AR" SETTING PTR ELSE NULL
   INS JSP.SEQ BEFORE ETR.TRAN<1,PTR>
   INS JSP.DATE BEFORE ETR.DATE<1,PTR>
   INS (0 - WIP.AMT) BEFORE ETR.TAMT<1,PTR>
   MATWRITE ETR.REC ON EOM.TRANS, ETR.CR
   IF PTR > 99 THEN NEW.REC = NEW.REC + 1
1999 RETURN
*--------
*
2000  * GET AND UPDATE THE WIP.SALES.STATS RECORD
*
*--------
   WSS.KEY = CONO:"_J_":JOBNO:"_":PERIOD:"XX_0_0"
   MATREADU WSS.REC FROM WIP.SALES.STATS, WSS.KEY ELSE
      MAT WSS.REC=''
   END
   IF JSP.DCOST > JSP.WIP<1,1,1> THEN
      WSS.SHIP.DCOST = WSS.SHIP.DCOST + (JSP.DCOST - JSP.WIP<1,1,1>)
   END
   T.FIXED = JSP.COST - JSP.DCOST
   IF T.FIXED > JSP.WIP<1,1,2> THEN
      WSS.SHIP.FFOH = WSS.SHIP.FFOH + (T.FIXED - JSP.WIP<1,1,2>)
   END
   WSS.INVOICE.DATE = DATE()
   WSS.CUST.ID = JOB.CUST
   WSS.SLSM.ID = JOB.SLSMN
   WSS.SALES.CODE = JOB.SALES.CODE
   WSS.JOB.CAT = JOB.CATG
   WSS.MASTER = JOB.MASTER
   WSS.NO.COLORS = JOB.COLORS
   WSS.POSTING.MONTH = PERIOD
   MATWRITE WSS.REC ON WIP.SALES.STATS, WSS.KEY
9999 RETURN
***************************************************************************
***************************************************************************
***************************** EOP *****************************************
***************************************************************************
***************************************************************************

